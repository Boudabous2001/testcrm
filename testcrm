<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Formation DesClick - Qualiopi</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#2563eb;--primary-dark:#1d4ed8;--primary-light:#dbeafe;--secondary:#7c3aed;--success:#10b981;--success-light:#d1fae5;--warning:#f59e0b;--warning-light:#fef3c7;--danger:#ef4444;--danger-light:#fee2e2;--info:#06b6d4;--info-light:#cffafe;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;--gray-800:#1f2937;--radius:12px;--shadow:0 4px 6px -1px rgba(0,0,0,0.1)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'DM Sans',sans-serif;background:linear-gradient(135deg,#f0f4ff 0%,#fafbff 50%,#f5f3ff 100%);min-height:100vh;color:var(--gray-800)}
    
    .login-page{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}
    .login-box{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:2.5rem;width:100%;max-width:400px}
    .login-logo{text-align:center;margin-bottom:2rem}
    .login-logo h1{font-size:1.4rem;color:var(--primary);margin-top:.5rem}
    .login-logo .subtitle{color:var(--gray-500);font-size:.85rem;margin-top:.25rem}
    .login-logo .icon{font-size:3rem}
    .login-error{background:var(--danger-light);color:#991b1b;padding:.75rem;border-radius:8px;margin-bottom:1rem;font-size:.875rem;display:none}
    .login-error.show{display:block}
    
    .app{display:none}
    .app.active{display:block}
    
    .header{background:linear-gradient(135deg,#1e40af 0%,#7c3aed 100%);color:#fff;padding:.75rem 1.5rem;display:flex;justify-content:space-between;align-items:center}
    .sticky-header{position:sticky;top:0;z-index:1000;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .header h1{font-size:1rem;font-weight:700;display:flex;align-items:center;gap:.5rem}
    .header-user{display:flex;align-items:center;gap:1rem}
    .header-user-info{text-align:right;font-size:.75rem}
    .header-user-name{font-weight:600}
    .header-user-role{opacity:.8;font-size:.65rem}
    .header-actions{display:flex;gap:.4rem}
    
    .nav{background:#fff;border-bottom:1px solid var(--gray-200);padding:0 .5rem;display:flex;overflow-x:auto}
    .nav-item{padding:.65rem .75rem;cursor:pointer;font-weight:700;font-size:.85rem;color:var(--gray-500);border-bottom:3px solid transparent;white-space:nowrap;display:flex;align-items:center;gap:.25rem}
    .nav-item:hover{color:var(--primary);background:var(--gray-50)}
    .nav-item.active{color:var(--primary);border-bottom-color:var(--primary);background:var(--primary-light)}
    .nav-item .badge{background:var(--danger);color:#fff;padding:.1rem .35rem;border-radius:999px;font-size:.55rem;animation:pulse 2s infinite}
    .badge-blue{background:#dbeafe;color:#1e40af}
    .badge-green{background:#dcfce7;color:#166534}
    .badge-yellow{background:#fef3c7;color:#92400e}
    .badge-purple{background:#f3e8ff;color:#7c3aed}
    .badge-red{background:#fee2e2;color:#dc2626}
    .badge-gray{background:#f1f5f9;color:#64748b}
    .post-formation-tab{transition:all 0.3s ease}
    .stats-tab-content{animation:fadeIn 0.3s ease}
    .satisf-tab{animation:fadeIn 0.3s ease}
    .ocr-spinner{display:inline-block;width:20px;height:20px;border:3px solid #e2e8f0;border-top-color:#8b5cf6;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ocr-result-item{display:flex;align-items:center;justify-content:space-between;padding:10px;margin:5px 0;background:#f8fafc;border-radius:6px;border-left:3px solid #8b5cf6}
    .ocr-result-label{font-weight:500;color:#374151}
    .ocr-result-value{display:flex;align-items:center;gap:10px}
    .ocr-confidence{font-size:0.75em;padding:2px 6px;border-radius:4px}
    .ocr-confidence.high{background:#dcfce7;color:#166534}
    .ocr-confidence.medium{background:#fef3c7;color:#92400e}
    .ocr-confidence.low{background:#fee2e2;color:#991b1b}
    .ocr-edit-btn{background:none;border:none;cursor:pointer;font-size:1em;padding:2px}
    .sat-critere{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#fff;border-radius:6px;border:1px solid #e2e8f0}
    .sat-label{flex:1;font-size:0.9em;color:#374151}
    .sat-stars{color:#f59e0b;font-size:1.1em;margin:0 10px}
    .sat-score{font-weight:bold;min-width:50px;text-align:right;color:#1e40af}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .nav-item.disabled{opacity:.4;pointer-events:none}
    .nav-sep{width:1px;background:var(--gray-200);margin:.5rem .1rem}
    
    .sub-nav{background:var(--gray-50);border-bottom:1px solid var(--gray-200);padding:.4rem .75rem;display:none;gap:.4rem;flex-wrap:wrap}
    .sub-nav.active{display:flex}
    .sub-nav-item{padding:.4rem .7rem;cursor:pointer;font-weight:600;font-size:.75rem;color:var(--gray-600);background:#fff;border:1px solid var(--gray-200);border-radius:6px}
    .sub-nav-item:hover{border-color:var(--primary);color:var(--primary)}
    .sub-nav-item.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    
    .main{padding:1.25rem;max-width:1800px;margin:0 auto}
    .page{display:none;animation:fadeIn .3s ease}
    .page.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:1.15rem;margin-bottom:1.15rem}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.875rem;padding-bottom:.65rem;border-bottom:1px solid var(--gray-100);flex-wrap:wrap;gap:.5rem}
    .card-title{font-size:.95rem;font-weight:600;display:flex;align-items:center;gap:.5rem}
    
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.75rem;margin-bottom:1.15rem}
    .kpi-card{background:#fff;border-radius:var(--radius);padding:.9rem;box-shadow:var(--shadow);position:relative;overflow:hidden}
    .kpi-card::before{content:"";position:absolute;top:0;left:0;right:0;height:4px}
    .kpi-card.blue::before{background:var(--primary)}.kpi-card.green::before{background:var(--success)}.kpi-card.yellow::before{background:var(--warning)}.kpi-card.red::before{background:var(--danger)}.kpi-card.purple::before{background:var(--secondary)}.kpi-card.cyan::before{background:var(--info)}
    .kpi-label{font-size:.65rem;color:var(--gray-500);margin-bottom:.2rem;font-weight:500}
    .kpi-value{font-size:1.25rem;font-weight:700;font-family:'Space Mono',monospace}
    .kpi-card.blue .kpi-value{color:var(--primary)}.kpi-card.green .kpi-value{color:var(--success)}.kpi-card.yellow .kpi-value{color:var(--warning)}.kpi-card.red .kpi-value{color:var(--danger)}.kpi-card.purple .kpi-value{color:var(--secondary)}.kpi-card.cyan .kpi-value{color:var(--info)}
    
    .btn{padding:.4rem .8rem;border-radius:8px;font-weight:600;font-size:.7rem;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:.25rem;font-family:inherit;transition:all .2s}
    .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark)}
    .btn-secondary{background:var(--gray-100);color:var(--gray-700)}.btn-secondary:hover{background:var(--gray-200)}
    .btn-success{background:var(--success);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-warning{background:var(--warning);color:#fff}
    .btn-info{background:var(--info);color:#fff}
    .btn-sm{padding:.25rem .45rem;font-size:.6rem}
    .btn-icon{width:26px;height:26px;padding:0;justify-content:center;border-radius:6px}
    
    .table-container{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--gray-200)}
    table{width:100%;border-collapse:collapse;font-size:.7rem}
    thead{background:var(--gray-50)}
    th{padding:.6rem .7rem;text-align:left;font-weight:600;color:var(--gray-600);border-bottom:2px solid var(--gray-200);white-space:nowrap}
    td{padding:.6rem .7rem;border-bottom:1px solid var(--gray-100);vertical-align:middle}
    tr:hover{background:var(--gray-50)}
    
    .status{padding:.15rem .45rem;border-radius:999px;font-size:.6rem;font-weight:600;display:inline-block}
    .status-nouveau,.status-en-attente{background:#dbeafe;color:#1e40af}
    .status-accuse-de-reception{background:#d1fae5;color:#065f46}
    .status-notification-commercial{background:#fef3c7;color:#92400e}
    .status-autre{background:var(--gray-200);color:var(--gray-600)}
    .status-presentiel{background:#dbeafe;color:#1e40af}
    .status-distanciel{background:#f3e8ff;color:#7c3aed}
    .status-mixte{background:#fef3c7;color:#92400e}
    .status-planifiee{background:#e0e7ff;color:#3730a3}
    .status-en-cours{background:#fef3c7;color:#92400e}
    .status-terminee{background:#d1fae5;color:#065f46}
    .status-en-cours,.status-planifiee{background:var(--warning-light);color:#92400e}
    .status-traite,.status-gagne,.status-actif,.status-valide,.status-signe,.status-confirmee,.status-termine,.status-conforme,.status-resolu,.status-converti,.status-gagnee,.status-signee{background:var(--success-light);color:#065f46}
    .status-perdu,.status-inactif,.status-annule,.status-refuse,.status-non-conforme,.status-archive,.status-perdue{background:var(--danger-light);color:#991b1b}
    .status-brouillon{background:var(--gray-200);color:var(--gray-600)}
    .status-envoye,.status-envoyee{background:var(--info-light);color:#0e7490}
    .status-prospect{background:#dbeafe;color:#1e40af}
    .status-qualification{background:#e0e7ff;color:#3730a3}
    .status-analyse{background:#fef3c7;color:#92400e}
    .status-devis{background:#fed7aa;color:#9a3412}
    .status-negociation{background:#fecaca;color:#991b1b}
    .status-convention{background:#bbf7d0;color:#166534}
    .status-formation{background:#a7f3d0;color:#065f46}
    
    /* Suivi Timeline */
    .suivi-card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08);overflow:hidden}
    .suivi-card-header{padding:20px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:flex-start;gap:20px;flex-wrap:wrap}
    .suivi-card-info h3{margin:0 0 8px 0;color:#1e293b;font-size:1.1em}
    .suivi-card-info p{margin:0;color:#64748b;font-size:0.9em}
    .suivi-card-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .suivi-timeline{padding:20px;background:#fff}
    .suivi-timeline-title{font-weight:600;color:#374151;margin-bottom:15px;display:flex;align-items:center;gap:8px}
    .timeline-item{display:flex;gap:15px;padding:12px 0;border-left:2px solid #e5e7eb;margin-left:10px;padding-left:20px;position:relative}
    .timeline-item:before{content:'';position:absolute;left:-6px;top:16px;width:10px;height:10px;border-radius:50%;background:#0066cc;border:2px solid #fff;box-shadow:0 0 0 2px #0066cc}
    .timeline-item.completed:before{background:#10b981;box-shadow:0 0 0 2px #10b981}
    .timeline-item.current:before{background:#f59e0b;box-shadow:0 0 0 2px #f59e0b;animation:pulse 2s infinite}
    .timeline-item-content{flex:1}
    .timeline-item-title{font-weight:600;color:#1e293b;font-size:0.9em}
    .timeline-item-date{color:#64748b;font-size:0.8em;margin-top:3px}
    .timeline-item-note{color:#475569;font-size:0.85em;margin-top:5px;padding:8px 12px;background:#f8fafc;border-radius:6px}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    
    /* Workflow √©tapes */
    .wf-etape{display:flex;flex-direction:column;align-items:center;position:relative}
    .wf-etape-icon{width:32px;height:32px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-size:0.9em;position:relative;z-index:1}
    .wf-etape-line{position:absolute;top:16px;left:32px;width:100%;height:2px;background:#e5e7eb}
    .wf-etape:last-child .wf-etape-line{display:none}
    .wf-etape.complete .wf-etape-icon{background:#10b981;color:#fff}
    .wf-etape.complete .wf-etape-line{background:#10b981}
    .wf-etape.current .wf-etape-icon{background:#f59e0b;color:#fff;animation:pulse 2s infinite}
    
    /* Messagerie */
    .msg-conv-item:hover{background:#f1f5f9}
    
    /* Workflow Horizontal en Fl√®ches */
    .workflow-horizontal{display:flex;align-items:flex-start;justify-content:center;gap:0;overflow-x:auto;padding:10px 0}
    .wf-step{display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:transform 0.2s}
    .wf-step:hover{transform:translateY(-3px)}
    .wf-arrow{position:relative;width:115px;height:55px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.3em;clip-path:polygon(0 0,85% 0,100% 50%,85% 100%,0 100%,15% 50%);margin-left:-12px;box-shadow:2px 4px 10px rgba(0,0,0,0.15);transition:all 0.3s}
    .wf-step:first-child .wf-arrow{clip-path:polygon(0 0,85% 0,100% 50%,85% 100%,0 100%);margin-left:0;border-radius:8px 0 0 8px}
    .wf-arrow-last{clip-path:polygon(0 0,100% 0,100% 100%,0 100%,15% 50%)!important;border-radius:0 8px 8px 0}
    .wf-arrow:hover{filter:brightness(1.1);box-shadow:2px 6px 15px rgba(0,0,0,0.25)}
    .wf-count{font-size:1.4em;text-shadow:1px 1px 3px rgba(0,0,0,0.3)}
    .wf-label{margin-top:10px;font-weight:600;color:#1e293b;font-size:0.8em;text-align:center}
    .wf-desc{font-size:0.65em;color:#64748b;text-align:center;max-width:100px;line-height:1.3;margin-top:3px}
    .wf-step.active .wf-arrow{box-shadow:0 0 0 4px rgba(59,130,246,0.5),2px 6px 15px rgba(0,0,0,0.25)}
    
    @media(max-width:1100px){
      .workflow-horizontal{flex-wrap:wrap;gap:10px;justify-content:center}
      .wf-arrow{width:90px;height:45px;margin-left:-8px;font-size:1.1em}
      .wf-step:first-child .wf-arrow{margin-left:0}
      .wf-label{font-size:0.7em}
      .wf-desc{display:none}
    }
    
    /* Dur√©es workflow */
    .wf-duree{font-size:0.65em;color:#64748b;text-align:center;margin-top:3px;line-height:1.2}
    .wf-duree-moyenne{background:#f1f5f9;padding:3px 6px;border-radius:4px;display:inline-block}
    .wf-dates{font-size:0.6em;color:#64748b;text-align:center;margin-top:3px;line-height:1.3}
    .wf-dates .date-debut{color:#10b981}
    .wf-dates .date-fin{color:#ef4444}
    .wf-step.completed .wf-arrow{opacity:1}
    .wf-step.pending .wf-arrow{opacity:0.5}
    .wf-step.current .wf-arrow{box-shadow:0 0 0 4px rgba(245,158,11,0.4)}
    
    .priority{padding:.15rem .35rem;border-radius:6px;font-size:.6rem;font-weight:600}
    .priority-haute,.priority-urgente{background:#fecaca;color:#991b1b}.priority-moyenne,.priority-normale{background:#fed7aa;color:#9a3412}.priority-basse{background:#bbf7d0;color:#166534}
    
    .etape{padding:.15rem .45rem;border-radius:6px;font-size:.6rem;font-weight:600}
    .etape-prospection{background:#e0e7ff;color:#3730a3}.etape-analyse{background:#fce7f3;color:#9d174d}.etape-evaluation{background:#fef3c7;color:#92400e}.etape-devis{background:#dbeafe;color:#1e40af}.etape-convention{background:#d1fae5;color:#065f46}.etape-action-formation{background:#cffafe;color:#0e7490}.etape-dcp{background:#ede9fe;color:#5b21b6}.etape-conception{background:#fef9c3;color:#854d0e}
    
    .role{padding:.15rem .45rem;border-radius:6px;font-size:.6rem;font-weight:600}
    .role-admin{background:#fecaca;color:#991b1b}.role-gestionnaire{background:#dbeafe;color:#1e40af}.role-commercial{background:#d1fae5;color:#065f46}.role-formateur{background:#fef3c7;color:#92400e}
    
    .form-group{margin-bottom:.75rem}
    .form-label{display:block;font-weight:500;margin-bottom:.25rem;color:var(--gray-700);font-size:.7rem}
    .form-input,.form-select,.form-textarea{width:100%;padding:.5rem .7rem;border:1px solid var(--gray-300);border-radius:8px;font-size:.7rem;font-family:inherit;background:#fff}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
    .form-textarea{min-height:65px;resize:vertical}
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.65rem}
    
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);display:none;justify-content:center;align-items:flex-start;z-index:1000;padding:1.25rem .75rem;overflow-y:auto}
    .modal-overlay.active{display:flex}
    .modal{background:#fff;border-radius:var(--radius);box-shadow:0 20px 25px -5px rgba(0,0,0,.1);width:100%;max-width:620px;max-height:calc(100vh - 2.5rem);overflow:hidden;display:flex;flex-direction:column;animation:modalIn .3s ease}
    @keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(-20px)}to{opacity:1;transform:scale(1) translateY(0)}}
    .modal-header{padding:.75rem 1rem;border-bottom:1px solid var(--gray-200);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:.95rem;font-weight:600}
    .modal-close{width:26px;height:26px;border:none;background:var(--gray-100);border-radius:8px;cursor:pointer;font-size:1rem;color:var(--gray-500)}
    .modal-body{padding:.9rem;overflow-y:auto;flex:1}
    .modal-footer{padding:.65rem .9rem;border-top:1px solid var(--gray-200);display:flex;justify-content:flex-end;gap:.4rem}
    
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem}
    .chart-container{position:relative;height:230px}
    .chart-container-lg{position:relative;height:280px}
    .chart-container-sm{position:relative;height:180px}
    .dashboard-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
    .dashboard-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px}
    .dashboard-section{margin-bottom:25px}
    .dashboard-section-title{font-size:1.1em;font-weight:600;color:#1e293b;margin-bottom:15px;display:flex;align-items:center;gap:10px;padding-bottom:10px;border-bottom:2px solid #e2e8f0}
    .kpi-card-advanced{background:white;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);border:1px solid #e2e8f0;position:relative;overflow:hidden}
    .kpi-card-advanced::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
    .kpi-card-advanced.blue::before{background:linear-gradient(90deg,#3b82f6,#60a5fa)}
    .kpi-card-advanced.green::before{background:linear-gradient(90deg,#22c55e,#4ade80)}
    .kpi-card-advanced.purple::before{background:linear-gradient(90deg,#8b5cf6,#a78bfa)}
    .kpi-card-advanced.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
    .kpi-card-advanced.cyan::before{background:linear-gradient(90deg,#0891b2,#22d3ee)}
    .kpi-card-advanced.red::before{background:linear-gradient(90deg,#ef4444,#f87171)}
    .kpi-card-advanced .kpi-icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5em;margin-bottom:12px}
    .kpi-card-advanced.blue .kpi-icon{background:#dbeafe;color:#2563eb}
    .kpi-card-advanced.green .kpi-icon{background:#dcfce7;color:#16a34a}
    .kpi-card-advanced.purple .kpi-icon{background:#f3e8ff;color:#7c3aed}
    .kpi-card-advanced.orange .kpi-icon{background:#fef3c7;color:#d97706}
    .kpi-card-advanced.cyan .kpi-icon{background:#cffafe;color:#0891b2}
    .kpi-card-advanced.red .kpi-icon{background:#fee2e2;color:#dc2626}
    .kpi-card-advanced .kpi-value-lg{font-size:2em;font-weight:700;color:#1e293b;line-height:1.2}
    .kpi-card-advanced .kpi-label-lg{font-size:0.85em;color:#64748b;margin-top:5px}
    .kpi-card-advanced .kpi-trend{display:flex;align-items:center;gap:5px;font-size:0.8em;margin-top:10px;padding-top:10px;border-top:1px solid #f1f5f9}
    .kpi-trend.up{color:#16a34a}
    .kpi-trend.down{color:#dc2626}
    .kpi-trend.neutral{color:#64748b}
    .quick-actions{display:flex;gap:10px;flex-wrap:wrap}
    .quick-action-btn{display:flex;align-items:center;gap:8px;padding:12px 18px;border-radius:10px;border:1px solid #e2e8f0;background:white;cursor:pointer;transition:all 0.2s;font-size:0.9em}
    .quick-action-btn:hover{background:#f8fafc;border-color:#3b82f6;transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,0.15)}
    .prochaines-sessions{background:white;border-radius:12px;border:1px solid #e2e8f0;overflow:hidden}
    .prochaines-sessions .session-item{display:flex;align-items:center;gap:15px;padding:15px 20px;border-bottom:1px solid #f1f5f9;transition:background 0.2s}
    .prochaines-sessions .session-item:last-child{border-bottom:none}
    .prochaines-sessions .session-item:hover{background:#f8fafc}
    .session-date-badge{background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;padding:8px 12px;border-radius:8px;text-align:center;min-width:60px}
    .session-date-badge .day{font-size:1.4em;font-weight:700;line-height:1}
    .session-date-badge .month{font-size:0.7em;text-transform:uppercase}
    
    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:.65rem;margin-bottom:.9rem;flex-wrap:wrap}
    .search-box{position:relative;flex:1;max-width:280px}
    .search-box input{width:100%;padding:.5rem .65rem .5rem 2rem;border:1px solid var(--gray-300);border-radius:8px;font-size:.7rem}
    .search-box::before{content:"üîç";position:absolute;left:.65rem;top:50%;transform:translateY(-50%);font-size:.7rem}
    .filters{display:flex;gap:.35rem;flex-wrap:wrap;align-items:center}
    .filter-select{padding:.4rem 1.5rem .4rem .55rem;border:1px solid var(--gray-300);border-radius:8px;font-size:.7rem;background:#fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E") no-repeat right .35rem center/.8rem}
    
    .empty-state{text-align:center;padding:2rem 1rem;color:var(--gray-500)}
    .empty-state-icon{font-size:2.25rem;margin-bottom:.4rem;opacity:.5}
    .empty-state h3{font-size:.9rem;color:var(--gray-700);margin-bottom:.2rem}
    
    .toast-container{position:fixed;bottom:1rem;right:1rem;z-index:2000;display:flex;flex-direction:column;gap:.35rem}
    .toast{background:var(--gray-800);color:#fff;padding:.65rem .9rem;border-radius:8px;box-shadow:var(--shadow);display:flex;align-items:center;gap:.35rem;animation:toastIn .3s ease;min-width:230px;font-size:.75rem}
    @keyframes toastIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
    .toast.success{background:var(--success)}.toast.error{background:var(--danger)}.toast.warning{background:var(--warning)}
    
    /* === QUICK WINS MVP STYLES === */
    /* Badge Nouveau */
    .badge-new{display:inline-flex;align-items:center;padding:2px 6px;font-size:0.6em;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;background:linear-gradient(135deg,#ef4444,#f97316);color:white;border-radius:4px;margin-left:6px;animation:badgeNewAppear 0.3s ease-out,badgeNewPulse 2s ease-in-out infinite;vertical-align:middle}
    @keyframes badgeNewAppear{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
    @keyframes badgeNewPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)}50%{box-shadow:0 0 0 4px rgba(239,68,68,0)}}
    
    /* Badge Expiration Devis */
    .badge-expiration{display:inline-flex;align-items:center;padding:3px 8px;font-size:0.75em;font-weight:600;border-radius:12px;white-space:nowrap}
    .badge-expiration.ok{background:#dcfce7;color:#16a34a}
    .badge-expiration.warning{background:#fef3c7;color:#d97706}
    .badge-expiration.urgent{background:#fee2e2;color:#dc2626;animation:urgentPulse 1s infinite}
    .badge-expiration.expire{background:#f1f5f9;color:#64748b;text-decoration:line-through}
    @keyframes urgentPulse{0%,100%{opacity:1}50%{opacity:0.7}}
    
    /* Bouton Favori */
    .btn-favorite{background:transparent;border:none;cursor:pointer;font-size:1.1em;padding:4px;transition:transform 0.2s}
    .btn-favorite:hover{transform:scale(1.2)}
    .btn-favorite.is-favorite{color:#f59e0b}
    .btn-favorite:not(.is-favorite){color:#d1d5db}
    
    /* Recherche Globale Modal */
    .search-modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:10000;justify-content:center;padding-top:12vh}
    .search-modal-overlay.active{display:flex}
    .search-modal-box{background:white;border-radius:16px;width:600px;max-width:90%;max-height:70vh;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);overflow:hidden;animation:searchModalIn 0.2s ease-out}
    @keyframes searchModalIn{from{opacity:0;transform:translateY(-20px) scale(0.95)}to{opacity:1;transform:translateY(0) scale(1)}}
    .search-modal-header{display:flex;align-items:center;padding:16px 20px;border-bottom:1px solid #e2e8f0;gap:12px}
    .search-modal-header input{flex:1;border:none;outline:none;font-size:1.1em;background:transparent}
    .search-modal-header kbd{background:#f1f5f9;padding:4px 8px;border-radius:4px;font-size:0.75em;color:#64748b;font-family:'Space Mono',monospace}
    .search-results{max-height:400px;overflow-y:auto}
    .search-category{padding:8px 16px;font-size:0.7em;font-weight:600;text-transform:uppercase;color:#64748b;background:#f8fafc;position:sticky;top:0}
    .search-result-item{display:flex;align-items:center;gap:12px;padding:12px 20px;cursor:pointer;transition:background 0.15s;border-bottom:1px solid #f1f5f9}
    .search-result-item:hover,.search-result-item.active{background:#f1f5f9}
    .search-result-item .result-icon{font-size:1.3em;width:32px;text-align:center}
    .search-result-item .result-info{flex:1}
    .search-result-item .result-title{font-weight:500;color:#1e293b}
    .search-result-item .result-subtitle{font-size:0.8em;color:#64748b}
    .search-result-item .result-badge{font-size:0.7em;padding:2px 8px;background:#e2e8f0;border-radius:10px;color:#64748b}
    .search-modal-footer{padding:10px 16px;background:#f8fafc;border-top:1px solid #e2e8f0;display:flex;gap:20px;font-size:0.75em;color:#64748b}
    .search-modal-footer kbd{background:#e2e8f0;padding:2px 6px;border-radius:3px;font-size:0.9em;margin-right:4px}
    .search-empty{padding:40px 20px;text-align:center;color:#64748b}
    .search-empty-icon{font-size:2.5em;margin-bottom:10px;opacity:0.5}
    
    /* Raccourcis Trigger dans Header */
    .search-trigger{display:flex;align-items:center;gap:8px;padding:6px 12px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;cursor:pointer;font-size:0.8em;transition:all 0.2s}
    .search-trigger:hover{background:rgba(255,255,255,0.25)}
    .search-trigger kbd{background:rgba(255,255,255,0.2);padding:2px 6px;border-radius:4px;font-size:0.85em}
    
    /* Modal Backup/Import */
    .backup-section{padding:20px;border-bottom:1px solid #e2e8f0}
    .backup-section:last-child{border-bottom:none}
    .backup-section h4{margin-bottom:12px;color:#1e293b;display:flex;align-items:center;gap:8px}
    .backup-info{background:#f8fafc;padding:12px;border-radius:8px;font-size:0.85em;color:#64748b;margin-bottom:12px}
    .backup-actions{display:flex;gap:10px}
    
    /* Shortcuts Help Modal */
    .shortcuts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .shortcuts-section h4{color:#3b82f6;margin-bottom:12px;font-size:0.9em}
    .shortcut-item{display:flex;align-items:center;gap:10px;padding:6px 0;font-size:0.85em}
    .shortcut-item kbd{background:#f1f5f9;padding:4px 8px;border-radius:4px;font-family:'Space Mono',monospace;font-size:0.85em;min-width:60px;text-align:center}
    
    .montant{font-family:'Space Mono',monospace;font-weight:600}
    .action-btns{display:flex;gap:.2rem}
    .ref-section{display:none}.ref-section.active{display:block}
    .qualiopi-section{display:none}.qualiopi-section.active{display:block}
    
    .info-box{background:var(--info-light);border:1px solid #99f6e4;border-radius:8px;padding:.65rem;margin-bottom:.9rem;font-size:.7rem;color:#0e7490}
    .warning-box{background:var(--warning-light);border:1px solid #fcd34d;border-radius:8px;padding:.65rem;margin-bottom:.9rem;font-size:.7rem;color:#92400e}
    .success-box{background:var(--success-light);border:1px solid #6ee7b7;border-radius:8px;padding:.65rem;margin-bottom:.9rem;font-size:.7rem;color:#065f46}
    
    .demande-card{border:1px solid var(--gray-200);border-radius:var(--radius);padding:1rem;margin-bottom:.75rem;background:#fff}
    .demande-card.nouveau{border-left:4px solid var(--primary)}
    .demande-card.en-cours{border-left:4px solid var(--warning)}
    .demande-card.traite{border-left:4px solid var(--success)}
    .demande-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem}
    .demande-title{font-weight:600;font-size:.85rem}
    .demande-date{font-size:.65rem;color:var(--gray-500)}
    .demande-body{font-size:.75rem;color:var(--gray-600)}
    .demande-body p{margin-bottom:.25rem}
    .demande-body strong{color:var(--gray-800)}
    .demande-footer{display:flex;gap:.35rem;margin-top:.75rem;padding-top:.5rem;border-top:1px solid var(--gray-100)}
    
    .qualiopi-badge{background:linear-gradient(135deg,#1e40af 0%,#7c3aed 100%);color:#fff;padding:.35rem .75rem;border-radius:8px;font-weight:600;font-size:.65rem;display:inline-flex;align-items:center;gap:.35rem}
    
    /* Indicateurs Qualiopi par onglet */
    .qualiopi-indicators{background:linear-gradient(135deg,#eff6ff,#f5f3ff);border:1px solid #c7d2fe;border-radius:10px;padding:12px 15px;margin-bottom:15px;display:flex;flex-wrap:wrap;gap:15px;align-items:center}
    .qualiopi-indicators-title{font-size:0.75em;font-weight:700;color:#4338ca;display:flex;align-items:center;gap:5px}
    .qualiopi-indicator{display:flex;align-items:center;gap:8px;padding:6px 12px;background:white;border-radius:8px;border:1px solid #e0e7ff;font-size:0.75em}
    .qualiopi-indicator-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8em}
    .qualiopi-indicator-icon.green{background:#dcfce7;color:#16a34a}
    .qualiopi-indicator-icon.yellow{background:#fef3c7;color:#d97706}
    .qualiopi-indicator-icon.red{background:#fee2e2;color:#dc2626}
    .qualiopi-indicator-icon.blue{background:#dbeafe;color:#2563eb}
    .qualiopi-indicator-label{color:#64748b}
    .qualiopi-indicator-value{font-weight:700;color:#1e293b}
    .qualiopi-indicator-ref{font-size:0.7em;color:#8b5cf6;background:#f3e8ff;padding:2px 5px;border-radius:3px}
    
    /* Widget Qualiopi Dashboard */
    .qualiopi-widget{background:white;border-radius:12px;border:1px solid #e5e7eb;overflow:hidden}
    .qualiopi-widget-header{background:linear-gradient(135deg,#4f46e5,#7c3aed);color:white;padding:12px 15px;display:flex;justify-content:space-between;align-items:center}
    .qualiopi-widget-title{font-weight:600;font-size:0.9em;display:flex;align-items:center;gap:8px}
    .qualiopi-widget-score{background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:20px;font-weight:700}
    .qualiopi-critere-mini{display:flex;align-items:center;gap:10px;padding:10px 15px;border-bottom:1px solid #f1f5f9}
    .qualiopi-critere-mini:last-child{border-bottom:none}
    .qualiopi-critere-mini:hover{background:#f8fafc}
    .qualiopi-critere-num{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75em;color:white}
    .qualiopi-critere-info{flex:1}
    .qualiopi-critere-name{font-size:0.8em;font-weight:500;color:#374151}
    .qualiopi-critere-bar{height:4px;background:#e5e7eb;border-radius:2px;margin-top:4px;overflow:hidden}
    .qualiopi-critere-fill{height:100%;border-radius:2px;transition:width 0.3s}
    .qualiopi-critere-pct{font-size:0.75em;font-weight:600;min-width:35px;text-align:right}
    
    /* Alertes Qualiopi */
    .qualiopi-alert{background:#fef2f2;border:1px solid #fecaca;border-left:4px solid #ef4444;border-radius:8px;padding:10px 15px;margin-bottom:15px;display:flex;align-items:center;gap:10px}
    .qualiopi-alert-icon{font-size:1.2em}
    .qualiopi-alert-content{flex:1}
    .qualiopi-alert-title{font-weight:600;color:#991b1b;font-size:0.85em}
    .qualiopi-alert-text{color:#7f1d1d;font-size:0.75em}
    .qualiopi-alert.warning{background:#fffbeb;border-color:#fcd34d;border-left-color:#f59e0b}
    .qualiopi-alert.warning .qualiopi-alert-title{color:#92400e}
    .qualiopi-alert.warning .qualiopi-alert-text{color:#78350f}
    .qualiopi-alert.success{background:#f0fdf4;border-color:#86efac;border-left-color:#22c55e}
    .qualiopi-alert.success .qualiopi-alert-title{color:#166534}
    .qualiopi-alert.success .qualiopi-alert-text{color:#15803d}
    
    /* Tableau de contr√¥le */
    .ctrl-th{color:white;padding:14px 10px;font-size:0.9em;font-weight:600;text-align:center;white-space:nowrap;border-bottom:2px solid rgba(255,255,255,0.3)}
    .ctrl-th-fixed{position:sticky;z-index:12;color:white;padding:14px 10px;font-size:0.9em;font-weight:600;text-align:center;border-bottom:2px solid rgba(255,255,255,0.3)}
    .ctrl-td{padding:12px 8px;text-align:center;border-bottom:1px solid #e5e7eb;vertical-align:middle}
    .ctrl-td-fixed{position:sticky;background:#fff;z-index:5;padding:12px 10px;border-bottom:1px solid #e5e7eb;vertical-align:middle}
    .ctrl-cell{display:flex;gap:4px;justify-content:center;align-items:center;flex-wrap:wrap}
    .ctrl-badge{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;border-radius:6px;font-size:1em}
    .ctrl-badge.done{background:#dcfce7}
    .ctrl-badge.pending{background:#fef3c7}
    .ctrl-badge.uploaded{background:#dbeafe}
    .ctrl-badge.na{background:#f1f5f9;color:#94a3b8}
    #table-controle tbody tr:hover{background:#f8fafc}
    #table-controle tbody tr:nth-child(even){background:#fafafa}
    #table-controle tbody tr:nth-child(even):hover{background:#f0f9ff}
    
    .critere-card{border:1px solid var(--gray-200);border-radius:8px;padding:.85rem;margin-bottom:.65rem}
    .critere-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}
    .critere-title{font-weight:600;font-size:.8rem}
    .critere-progress{width:90px;height:7px;background:var(--gray-200);border-radius:4px;overflow:hidden}
    .critere-progress-fill{height:100%;background:var(--success);transition:width .3s}
    .indicateur-item{padding:.4rem;border-bottom:1px solid var(--gray-100);font-size:.7rem;display:flex;justify-content:space-between;align-items:center}
    .indicateur-item:last-child{border-bottom:none}
    
    @media(max-width:768px){.header{padding:.5rem;flex-direction:column;gap:.4rem}.nav-item{padding:.5rem .55rem;font-size:.75rem;font-weight:700}.main{padding:.85rem}.kpi-grid{grid-template-columns:repeat(2,1fr)}.charts-grid{grid-template-columns:1fr}.toolbar{flex-direction:column;align-items:stretch}.search-box{max-width:none}.login-box{padding:1.25rem}.sticky-header{position:sticky;top:0}}
    
    /* AGENDA STYLES */
    .agenda-calendar{background:#fff;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden}
    .agenda-header-row{display:grid;grid-template-columns:repeat(7,1fr);background:#f8fafc;border-bottom:1px solid #e5e7eb}
    .agenda-header-day{padding:10px;text-align:center;font-weight:600;font-size:0.75rem;color:#374151;border-right:1px solid #e5e7eb}
    .agenda-header-day:last-child{border-right:none}
    .agenda-week{position:relative;border-bottom:1px solid #e5e7eb}
    .agenda-week:last-child{border-bottom:none}
    .agenda-week-days{display:grid;grid-template-columns:repeat(7,1fr)}
    .agenda-week-events{position:relative;min-height:26px;padding:2px 0}
    .agenda-day{min-height:30px;padding:3px;border-right:1px solid #f1f5f9;position:relative;text-align:center}
    .agenda-day:last-child{border-right:none}
    .agenda-day.other-month{background:#f9fafb}
    .agenda-day.other-month .agenda-day-num{color:#9ca3af}
    .agenda-day.today{background:#dbeafe}
    .agenda-day.today .agenda-day-num{background:#3b82f6;color:#fff;border-radius:50%;width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center}
    .agenda-day-num{font-size:0.8rem;font-weight:600;color:#374151}
    .agenda-event-bar{position:absolute;height:22px;border-radius:4px;cursor:pointer;display:flex;align-items:center;padding:0 6px;font-size:0.65rem;font-weight:500;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;transition:transform 0.1s,box-shadow 0.1s;z-index:1}
    .agenda-event-bar:hover{transform:translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,0.25);z-index:10}
    /* Couleurs par formateur */
    .agenda-event-bar.session{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff}
    .agenda-event-bar.session.formateur-1{background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
    .agenda-event-bar.session.formateur-2{background:linear-gradient(135deg,#8b5cf6,#6d28d9)}
    .agenda-event-bar.session.formateur-3{background:linear-gradient(135deg,#ec4899,#be185d)}
    .agenda-event-bar.session.formateur-4{background:linear-gradient(135deg,#14b8a6,#0d9488)}
    .agenda-event-bar.session.formateur-5{background:linear-gradient(135deg,#f97316,#c2410c)}
    .agenda-event-bar.session.formateur-6{background:linear-gradient(135deg,#06b6d4,#0891b2)}
    .agenda-event-bar.session.formateur-7{background:linear-gradient(135deg,#84cc16,#4d7c0f)}
    .agenda-event-bar.session.formateur-8{background:linear-gradient(135deg,#f43f5e,#be123c)}
    .agenda-event-bar.session.en-cours{opacity:0.9}
    .agenda-event-bar.session.terminee{opacity:0.7}
    .agenda-event-bar.session.annulee{opacity:0.5;text-decoration:line-through}
    .agenda-event-bar.rdv{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff}
    .agenda-event-bar.tache{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
    .agenda-event-bar.rappel{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
    .agenda-event-bar.disponibilite{background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;border:2px dashed #a5b4fc}
    .agenda-event-bar .event-icon{margin-right:4px}
    .agenda-event-bar .event-title{flex:1;overflow:hidden;text-overflow:ellipsis}
    .agenda-event-bar .event-enterprise{font-size:0.55rem;opacity:0.85;margin-left:8px}
    .agenda-event-bar .event-meta{font-size:0.5rem;opacity:0.85;margin-left:6px;white-space:nowrap;overflow:hidden}
    /* Voyant confirmation */
    .agenda-event-bar .voyant{width:8px;height:8px;border-radius:50%;margin-right:4px;flex-shrink:0;box-shadow:0 0 4px currentColor}
    .agenda-event-bar .voyant.vert{background:#10b981;box-shadow:0 0 6px #10b981}
    .agenda-event-bar .voyant.rouge{background:#ef4444;box-shadow:0 0 6px #ef4444}
    .agenda-event-bar.confirme{box-shadow:0 0 0 2px #10b981}
    .agenda-event-bar.non-confirme{box-shadow:0 0 0 2px #ef4444}
    .agenda-more{font-size:0.55rem;color:#6b7280;cursor:pointer;padding:2px;background:#f1f5f9;border-radius:3px;margin:2px;display:inline-block}
    .agenda-more:hover{color:#3b82f6;background:#dbeafe}
    /* L√©gende formateurs */
    .agenda-legend{display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:10px;font-size:0.7rem}
    .agenda-legend-item{display:flex;align-items:center;gap:4px}
    .agenda-legend-color{width:12px;height:12px;border-radius:3px}
    
    .view-toggle{display:flex;gap:2px;background:var(--gray-200);padding:2px;border-radius:8px}
    .view-btn{border-radius:6px!important;background:transparent!important;color:var(--gray-600)!important;border:none!important}
    .view-btn.active{background:#fff!important;color:var(--primary)!important;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .view-btn:hover:not(.active){background:var(--gray-100)!important}
    
    #table-entreprises-full{min-width:2000px}
    #table-entreprises-full th,#table-entreprises-full td{white-space:nowrap;font-size:.65rem;padding:.5rem .4rem}
    #table-stagiaires-full{min-width:1200px}
    #table-stagiaires-full th,#table-stagiaires-full td{white-space:nowrap;font-size:.7rem;padding:.5rem .4rem}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div class="login-page" id="login-page">
    <div class="login-box">
      <div class="login-logo">
        <div class="icon">üéØ</div>
        <h1>Formation DesClick</h1>
        <p class="subtitle">CRM Qualiopi</p>
      </div>
      <div class="login-error" id="login-error">Identifiants incorrects</div>
      <form id="login-form">
        <div class="form-group"><label class="form-label">Identifiant</label><input type="text" class="form-input" id="login-username" required placeholder="Votre identifiant"></div>
        <div class="form-group"><label class="form-label">Mot de passe</label><input type="password" class="form-input" id="login-password" required placeholder="Votre mot de passe"></div>
        <div class="form-group"><label class="form-label">Fonction / R√¥le</label>
          <select class="form-select" id="login-role" required>
            <option value="">-- S√©lectionner --</option>
            <option value="Admin">üëë Administrateur</option>
            <option value="Gestionnaire">üë§ Gestionnaire</option>
            <option value="Commercial">üë®‚Äçüíº Commercial</option>
            <option value="Formateur">üë®‚Äçüè´ Formateur</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:.65rem;margin-top:.4rem">üîê Connexion</button>
      </form>
      <p style="text-align:center;margin-top:1.25rem;font-size:.7rem;color:var(--gray-500)">Comptes d√©mo :</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:8px;font-size:.65rem;color:var(--gray-500)">
        <div>üëë <strong>admin</strong> / admin</div>
        <div>üë§ <strong>gestionnaire</strong> / gest</div>
        <div>üë®‚Äçüíº <strong>commercial</strong> / comm</div>
        <div>üë®‚Äçüè´ <strong>formateur</strong> / form</div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="app" id="app">
    <div class="sticky-header">
      <header class="header">
        <h1>üéØ Formation DesClick <span class="qualiopi-badge">‚úì Qualiopi</span></h1>
        <div class="header-user">
          <div class="search-trigger" onclick="ouvrirRechercheGlobale()" title="Recherche globale (Ctrl+K)">
            <span>üîç</span>
            <span>Rechercher...</span>
            <kbd>Ctrl+K</kbd>
          </div>
          <div class="header-user-info"><div class="header-user-name" id="user-name">-</div><div class="header-user-role" id="user-role">-</div></div>
          <div class="header-actions">
            <button class="btn btn-sm" onclick="ouvrirTutoriel()" title="Tutoriel - Guide complet" style="background:#22c55e;color:white">üìö Tutoriel</button>
            <button class="btn btn-sm" onclick="ouvrirBackupModal()" title="Sauvegarde & Restauration" style="background:#8b5cf6;color:white">‚òÅÔ∏è Backup</button>
            <button class="btn btn-sm" onclick="afficherRaccourcis()" title="Raccourcis clavier (?)" style="background:#64748b;color:white">‚å®Ô∏è</button>
            <button class="btn btn-secondary btn-sm" onclick="reinitialiserBase()" title="R√©initialiser la base de donn√©es">üîÑ</button>
            <button class="btn btn-secondary btn-sm" onclick="logout()" title="D√©connexion">üö™</button>
          </div>
        </div>
      </header>

      <nav class="nav" id="main-nav">
      <div class="nav-item active" data-page="dashboard">üìä Dashboard</div>
      <div class="nav-item" data-page="suivi">üìà Suivi</div>
      <div class="nav-item" data-page="emails">üìß Emails <span class="badge" id="count-emails">0</span></div>
      <div class="nav-item" data-page="messagerie">üí¨ Messagerie</div>
      <div class="nav-sep"></div>
      <div class="nav-item" data-page="demandes">üì© Demandes <span class="badge" id="count-demandes">0</span></div>
      <div class="nav-sep"></div>
      <div class="nav-item" data-page="action-formation">üìÇ Action de formation</div>
      <div class="nav-item" data-page="analyse-eval">üìã Analyse & √âval.</div>
      <div class="nav-item" data-page="sessions">üìÖ Sessions</div>
      <div class="nav-item" data-page="agenda">üóìÔ∏è Agenda</div>
      <div class="nav-item" data-page="documents">üìë Documents</div>
      <div class="nav-item" data-page="dpc">üìÑ Prise en Charge</div>
      <div class="nav-item" data-page="conception">‚úèÔ∏è Conception</div>
      <div class="nav-item" data-page="post-formation">üìã Post Formation</div>
      <div class="nav-sep"></div>
      <div class="nav-item" data-page="qualiopi">üèÜ Qualiopi</div>
      <div class="nav-item" data-page="ged">üìÅ GED</div>
      <div class="nav-item" data-page="referentiels">‚öôÔ∏è R√©f√©rentiels</div>
      <div class="nav-item" data-page="admin" id="nav-admin">üë§ Admin</div>
    </nav>

    <nav class="sub-nav" id="sub-nav-action-formation">
      <div class="sub-nav-item active" data-action="entreprises">üè¢ Entreprises</div>
      <div class="sub-nav-item" data-action="opportunites">üéØ Opportunit√©s</div>
      <div class="sub-nav-item" data-action="stagiaires">üë• Stagiaires</div>
    </nav>

    <nav class="sub-nav" id="sub-nav-analyse-eval">
      <div class="sub-nav-item active" data-section="analyse">üìã Analyse des besoins</div>
      <div class="sub-nav-item" data-section="evaluation">üìù √âvaluation</div>
    </nav>

    <nav class="sub-nav" id="sub-nav-agenda">
      <div class="sub-nav-item active" data-section="agenda-sessions">üóìÔ∏è Agenda Sessions</div>
      <div class="sub-nav-item" data-section="agenda-general">üìÜ Agenda G√©n√©ral</div>
    </nav>

    <nav class="sub-nav" id="sub-nav-documents">
      <div class="sub-nav-item active" data-section="devis">üí∞ Devis</div>
      <div class="sub-nav-item" data-section="conventions">üìë Conventions</div>
    </nav>

    <nav class="sub-nav" id="sub-nav-suivi">
      <div class="sub-nav-item active" data-section="suivi-workflow">üìä Vue Workflow</div>
      <div class="sub-nav-item" data-section="suivi-controle">üìã Tableau de Contr√¥le</div>
    </nav>

    <nav class="sub-nav" id="sub-nav-ged">
      <div class="sub-nav-item active" data-ged="entreprises">üè¢ Par Entreprise</div>
      <div class="sub-nav-item" data-ged="formations">üìö Documents Formation</div>
      <div class="sub-nav-item" data-ged="modeles">üìÅ Mod√®les</div>
    </nav>

    <nav class="sub-nav" id="sub-nav-ref">
      <div class="sub-nav-item active" data-ref="commerciaux">üíº Commerciaux</div>
      <div class="sub-nav-item" data-ref="formations">üìñ Formations</div>
      <div class="sub-nav-item" data-ref="formateurs">üë®‚Äçüè´ Formateurs</div>
      <div class="sub-nav-item" data-ref="lieux">üìç Lieux</div>
      <div class="sub-nav-item" data-ref="materiel">üîß Mat√©riel</div>
      <div class="sub-nav-item" data-ref="idcc">üìã IDCC</div>
    </nav>

    <nav class="sub-nav" id="sub-nav-qualiopi">
      <div class="sub-nav-item active" data-quali="indicateurs">üìä Indicateurs</div>
      <div class="sub-nav-item" data-quali="documents-quali">üìÅ Documents</div>
      <div class="sub-nav-item" data-quali="veille">üîç Veille</div>
      <div class="sub-nav-item" data-quali="aidar">üìã AIDAR</div>
      <div class="sub-nav-item" data-quali="ecarts-competences">üìà √âcarts Comp√©tences</div>
      <div class="sub-nav-item" data-quali="emargements">‚úçÔ∏è √âmargements</div>
      <div class="sub-nav-item" data-quali="evaluations-pre">üìã √âval. Pr√©</div>
      <div class="sub-nav-item" data-quali="evaluations-post">üìù √âval. Post</div>
      <div class="sub-nav-item" data-quali="satisfactions">‚≠ê Satisfaction</div>
      <div class="sub-nav-item" data-quali="reclamations">‚ö†Ô∏è R√©clamations</div>
      <div class="sub-nav-item" data-quali="attestations">üìú Attestations</div>
      <div class="sub-nav-item" data-quali="ameliorations">üîÑ Am√©liorations</div>
    </nav>

    <nav class="sub-nav" id="sub-nav-admin">
      <div class="sub-nav-item active" data-admin="gestionnaires">üë§ Gestionnaires</div>
      <div class="sub-nav-item" data-admin="historique">üìú Historique</div>
      <div class="sub-nav-item" data-admin="parametres">‚öôÔ∏è Param√®tres</div>
    </nav>
    </div><!-- Fin sticky-header -->

    <main class="main">
      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <!-- Section KPIs Principaux -->
        <div class="dashboard-section">
          <div class="dashboard-section-title">üìä Indicateurs Cl√©s</div>
          <div class="dashboard-grid">
            <div class="kpi-card-advanced cyan">
              <div class="kpi-icon">üí∞</div>
              <div class="kpi-value-lg" id="kpi-ca-advanced">0 ‚Ç¨</div>
              <div class="kpi-label-lg">Chiffre d'Affaires</div>
              <div class="kpi-trend neutral" id="kpi-ca-trend">
                <span>‚Äî</span> <span>vs mois pr√©c√©dent</span>
              </div>
            </div>
            <div class="kpi-card-advanced green">
              <div class="kpi-icon">üìà</div>
              <div class="kpi-value-lg" id="kpi-taux-advanced">0%</div>
              <div class="kpi-label-lg">Taux de Conversion</div>
              <div class="kpi-trend neutral" id="kpi-taux-trend">
                <span>‚Äî</span> <span>vs mois pr√©c√©dent</span>
              </div>
            </div>
            <div class="kpi-card-advanced purple">
              <div class="kpi-icon">üë•</div>
              <div class="kpi-value-lg" id="kpi-stag-advanced">0</div>
              <div class="kpi-label-lg">Stagiaires Form√©s</div>
              <div class="kpi-trend neutral" id="kpi-stag-trend">
                <span>‚Äî</span> <span>vs mois pr√©c√©dent</span>
              </div>
            </div>
            <div class="kpi-card-advanced orange">
              <div class="kpi-icon">‚≠ê</div>
              <div class="kpi-value-lg" id="kpi-satisf-advanced">-/5</div>
              <div class="kpi-label-lg">Satisfaction Moyenne</div>
              <div class="kpi-trend neutral" id="kpi-satisf-trend">
                <span>‚Äî</span> <span>vs mois pr√©c√©dent</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Section Compteurs Rapides -->
        <div class="dashboard-section">
          <div class="kpi-grid">
            <div class="kpi-card red"><div class="kpi-label">üì© Nouvelles Demandes</div><div class="kpi-value" id="kpi-demandes">0</div></div>
            <div class="kpi-card purple"><div class="kpi-label">üìß Emails en attente</div><div class="kpi-value" id="kpi-emails">0</div></div>
            <div class="kpi-card blue"><div class="kpi-label">üéØ Opportunit√©s</div><div class="kpi-value" id="kpi-total">0</div></div>
            <div class="kpi-card green"><div class="kpi-label">‚úÖ Gagn√©es</div><div class="kpi-value" id="kpi-gagnees">0</div></div>
            <div class="kpi-card yellow"><div class="kpi-label">‚è≥ En Cours</div><div class="kpi-value" id="kpi-encours">0</div></div>
            <div class="kpi-card cyan"><div class="kpi-label">üè¢ Entreprises</div><div class="kpi-value" id="kpi-ent">0</div></div>
            <div class="kpi-card purple"><div class="kpi-label">üìö Formations</div><div class="kpi-value" id="kpi-form">0</div></div>
            <div class="kpi-card blue"><div class="kpi-label">üìÖ Sessions</div><div class="kpi-value" id="kpi-sess">0</div></div>
            <div class="kpi-card green"><div class="kpi-label">üìë Conventions</div><div class="kpi-value" id="kpi-conv">0</div></div>
          </div>
        </div>

        <!-- Section Graphiques -->
        <div class="dashboard-section">
          <div class="dashboard-section-title">üìà Analyse Graphique</div>
          <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:20px">
            <div class="card" style="margin:0">
              <div class="card-header">
                <h3 class="card-title">üí∞ Chiffre d'Affaires Mensuel</h3>
                <select id="chart-ca-period" class="filter-select" style="width:auto" onchange="updateChartCA()">
                  <option value="6">6 derniers mois</option>
                  <option value="12" selected>12 derniers mois</option>
                  <option value="24">24 derniers mois</option>
                </select>
              </div>
              <div class="chart-container-lg"><canvas id="chart-ca-mensuel"></canvas></div>
            </div>
            <div class="card" style="margin:0">
              <div class="card-header"><h3 class="card-title">üìä R√©partition CA par Formation</h3></div>
              <div class="chart-container-lg"><canvas id="chart-ca-formation"></canvas></div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px">
            <div class="card" style="margin:0">
              <div class="card-header"><h3 class="card-title">üë• √âvolution Stagiaires</h3></div>
              <div class="chart-container"><canvas id="chart-stagiaires"></canvas></div>
            </div>
            <div class="card" style="margin:0">
              <div class="card-header"><h3 class="card-title">üéØ Pipeline Commercial</h3></div>
              <div class="chart-container"><canvas id="chart-pipeline"></canvas></div>
            </div>
            <div class="card" style="margin:0">
              <div class="card-header"><h3 class="card-title">üìà √âtats Opportunit√©s</h3></div>
              <div class="chart-container"><canvas id="chart-etats"></canvas></div>
            </div>
          </div>
        </div>

        <!-- Section Actions Rapides + Prochaines Sessions -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
          <div class="dashboard-section" style="margin:0">
            <div class="dashboard-section-title">‚ö° Actions Rapides</div>
            <div class="quick-actions">
              <button class="quick-action-btn" onclick="openModal('demande')">
                <span style="font-size:1.3em">üì©</span>
                <span>Nouvelle Demande</span>
              </button>
              <button class="quick-action-btn" onclick="openModal('entreprise')">
                <span style="font-size:1.3em">üè¢</span>
                <span>Nouvelle Entreprise</span>
              </button>
              <button class="quick-action-btn" onclick="openModal('opportunite')">
                <span style="font-size:1.3em">üéØ</span>
                <span>Nouvelle Opportunit√©</span>
              </button>
              <button class="quick-action-btn" onclick="openModal('session')">
                <span style="font-size:1.3em">üìÖ</span>
                <span>Nouvelle Session</span>
              </button>
              <button class="quick-action-btn" onclick="naviguerVersSection('analyse-eval','analyse')">
                <span style="font-size:1.3em">üìã</span>
                <span>Cr√©er Analyse</span>
              </button>
              <button class="quick-action-btn" onclick="naviguerVersSection('documents','devis')">
                <span style="font-size:1.3em">üí∞</span>
                <span>Cr√©er Devis</span>
              </button>
            </div>
          </div>
          
          <div class="dashboard-section" style="margin:0">
            <div class="dashboard-section-title">üìÖ Prochaines Sessions</div>
            <div class="prochaines-sessions" id="prochaines-sessions-list">
              <div style="padding:20px;text-align:center;color:#64748b">Chargement...</div>
            </div>
          </div>
        </div>
        
        <!-- WORKFLOW PROCESS DE FORMATION -->
        <div class="card" style="padding:25px;margin-top:20px">
          <h3 style="margin:0 0 20px 0;color:#1e293b;text-align:center;font-size:1.1em">üìä Workflow Process de Formation</h3>
          
          <div class="workflow-horizontal" id="wf-dashboard-container">
            <div class="wf-step" onclick="showPage('demandes')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#3b82f6,#2563eb)">
                <span class="wf-count" id="wf-dash-demande">0</span>
              </div>
              <div class="wf-label">Demandes</div>
              <div class="wf-desc">R√©ception</div>
            </div>
            
            <div class="wf-step" onclick="naviguerVersSection('analyse-eval','analyse')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">
                <span class="wf-count" id="wf-dash-analyse">0</span>
              </div>
              <div class="wf-label">Analyses</div>
              <div class="wf-desc">Besoins</div>
            </div>
            
            <div class="wf-step" onclick="naviguerVersSection('analyse-eval','evaluation')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#ec4899,#db2777)">
                <span class="wf-count" id="wf-dash-evaluation">0</span>
              </div>
              <div class="wf-label">√âvaluations</div>
              <div class="wf-desc">Stagiaires</div>
            </div>
            
            <div class="wf-step" onclick="naviguerVersSection('documents','devis')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#f59e0b,#d97706)">
                <span class="wf-count" id="wf-dash-devis">0</span>
              </div>
              <div class="wf-label">Devis</div>
              <div class="wf-desc">Chiffrage</div>
            </div>
            
            <div class="wf-step" onclick="naviguerVersSection('documents','conventions')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#10b981,#059669)">
                <span class="wf-count" id="wf-dash-convention">0</span>
              </div>
              <div class="wf-label">Conventions</div>
              <div class="wf-desc">Signature</div>
            </div>
            
            <div class="wf-step" onclick="showPage('dpc')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">
                <span class="wf-count" id="wf-dash-pec">0</span>
              </div>
              <div class="wf-label">PEC OPCO</div>
              <div class="wf-desc">Financement</div>
            </div>
            
            <div class="wf-step" onclick="showPage('sessions')">
              <div class="wf-arrow wf-arrow-last" style="background:linear-gradient(135deg,#22c55e,#16a34a)">
                <span class="wf-count" id="wf-dash-session">0</span>
              </div>
              <div class="wf-label">Sessions</div>
              <div class="wf-desc">R√©alis√©es</div>
            </div>
          </div>
        </div>
        
        <!-- WIDGET QUALIOPI -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px">
          <div class="qualiopi-widget">
            <div class="qualiopi-widget-header">
              <div class="qualiopi-widget-title">üèÜ Conformit√© Qualiopi</div>
              <div class="qualiopi-widget-score" id="qualiopi-score-global">--%</div>
            </div>
            <div id="qualiopi-criteres-mini"></div>
          </div>
          
          <div class="card" style="margin:0">
            <div class="card-header" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white">
              <h3 class="card-title">‚ö†Ô∏è Alertes Qualiopi</h3>
            </div>
            <div id="qualiopi-alertes" style="padding:15px;max-height:250px;overflow-y:auto">
              <div style="text-align:center;color:#9ca3af;padding:20px">Chargement...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- DEMANDES (NOUVEAU) -->
      <div class="page" id="page-demandes">
        <div id="qualiopi-demandes" class="qualiopi-indicators" style="display:none"></div>
        <div class="info-box">
          <strong>üì© Demandes du site DesClick</strong> - Copiez-collez les informations re√ßues par email depuis le formulaire de contact du site. Vous pouvez ensuite convertir une demande en Entreprise + Opportunit√©.
        </div>
        <div class="toolbar">
          <div class="search-box"><input type="text" id="search-demandes" placeholder="Rechercher..." oninput="filterDemandes()"></div>
          <div class="filters">
            <div class="view-toggle">
              <button class="btn btn-secondary btn-sm view-btn active" id="btn-view-cards" onclick="setDemandesView('cards')" title="Vue cartes">üóÇÔ∏è Cartes</button>
              <button class="btn btn-secondary btn-sm view-btn" id="btn-view-table" onclick="setDemandesView('table')" title="Vue tableau">üìã Tableau</button>
            </div>
            <select class="filter-select" id="filter-demandes-statut" onchange="filterDemandes()">
              <option value="">Tous statuts</option>
              <option value="Nouveau">Nouveau</option>
              <option value="En cours">En cours</option>
              <option value="Trait√©">Trait√©</option>
              <option value="Converti">Converti</option>
              <option value="Archiv√©">Archiv√©</option>
            </select>
            <button class="btn btn-primary" onclick="openModal('demande')">‚ûï Nouvelle Demande</button>
            <button class="btn btn-info" onclick="openParseModal()">üìã Coller Email</button>
          </div>
        </div>
        <!-- Vue Cartes -->
        <div id="demandes-cards"></div>
        <!-- Vue Tableau -->
        <div id="demandes-table" style="display:none">
          <div class="card">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Entreprise</th>
                    <th>SIREN</th>
                    <th>Contact</th>
                    <th>Email</th>
                    <th>T√©l√©phone</th>
                    <th>Ville</th>
                    <th>Formations</th>
                    <th>Commercial</th>
                    <th>Priorit√©</th>
                    <th>Statut</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="table-demandes"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- EMAILS -->
      <div class="page" id="page-emails">
        <div class="info-box">
          <strong>üìß Bo√Æte d'envoi</strong> - Les emails sont stock√©s ici avant envoi. Cliquez sur "Envoyer" pour ouvrir votre client email avec le message pr√©-rempli, puis envoyez-le manuellement. Une fois envoy√©, marquez-le comme "Envoy√©".
        </div>
        <div class="toolbar">
          <div class="search-box"><input type="text" id="search-emails" placeholder="Rechercher..." oninput="filterEmails()"></div>
          <div class="filters">
            <select class="filter-select" id="filter-emails-statut" onchange="filterEmails()">
              <option value="">Tous statuts</option>
              <option value="En attente">En attente</option>
              <option value="Envoy√©">Envoy√©</option>
              <option value="Erreur">Erreur</option>
            </select>
            <select class="filter-select" id="filter-emails-type" onchange="filterEmails()">
              <option value="">Tous types</option>
              <option value="Accus√© de r√©ception">Accus√© de r√©ception</option>
              <option value="Notification commercial">Notification commercial</option>
              <option value="Autre">Autre</option>
            </select>
            <button class="btn btn-success" onclick="envoyerTousEmails()">üì§ Envoyer tous (en attente)</button>
            <button class="btn btn-primary" onclick="openModal('email')">‚ûï Nouveau Email</button>
          </div>
        </div>
        <div class="card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Destinataire</th>
                  <th>Sujet</th>
                  <th>Aper√ßu</th>
                  <th>Demande</th>
                  <th>Statut</th>
                  <th>Date Envoi</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="table-emails"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ENTREPRISES -->
      <div class="page" id="page-entreprises">
        <div class="toolbar" style="flex-wrap:wrap;gap:10px">
          <div class="search-box"><input type="text" id="search-ent" placeholder="Rechercher..." oninput="filterEntreprises()"></div>
          <div class="filters" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <select class="filter-select" id="filter-ent-statut" onchange="filterEntreprises()">
              <option value="">Tous statuts</option>
              <option value="Actif">Actif</option>
              <option value="Prospect">Prospect</option>
              <option value="Inactif">Inactif</option>
            </select>
            <button class="btn btn-primary" onclick="openModal('entreprise')">‚ûï Entreprise</button>
            <button class="btn" style="background:#8b5cf6;color:#fff" onclick="afficherAideDemandeStag()" title="Aide demande stagiaires">üìß Demander infos stagiaires</button>
          </div>
        </div>
        
        <div class="info-box" id="aide-demande-stag" style="display:none;margin-bottom:15px;background:linear-gradient(135deg,#f3e8ff,#ede9fe);border:1px solid #c4b5fd">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <strong style="color:#7c3aed">üìß Comment demander les informations stagiaires ?</strong><br>
              <small style="color:#6b7280">
                1. Cliquez sur le bouton <strong style="background:#8b5cf6;color:#fff;padding:1px 6px;border-radius:4px;font-size:0.75rem">üìß</strong> dans la colonne Actions de l'entreprise concern√©e<br>
                2. Personnalisez le message avec le template adapt√© √† votre formation<br>
                3. L'email s'ouvre dans votre client mail, pr√™t √† √™tre envoy√©<br>
                4. Les stagiaires transmis pourront ensuite √™tre ajout√©s via l'onglet <strong>üë• Stagiaires</strong>
              </small>
            </div>
            <button onclick="document.getElementById('aide-demande-stag').style.display='none'" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:#6b7280">&times;</button>
          </div>
        </div>
        
        <div class="card"><div class="table-container"><table id="table-entreprises-full">
          <thead>
            <tr>
              <th>ID</th>
              <th>Entreprise</th>
              <th>Enseigne</th>
              <th>Adresse</th>
              <th>CP</th>
              <th>Ville</th>
              <th>Mail Pro</th>
              <th>Contact</th>
              <th>Qualit√©</th>
              <th>Mail Contact</th>
              <th>Mobile</th>
              <th>Date Cr√©ation</th>
              <th>ID Comm.</th>
              <th>Commercial</th>
              <th>IDCC</th>
              <th>Secteur</th>
              <th>SIRET</th>
              <th>OPCO</th>
              <th class="col-code-activation" style="display:none">Code Activ.</th>
              <th>Salari√©s</th>
              <th>üë• Stag.</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="table-entreprises"></tbody>
        </table></div></div>
      </div>

      <!-- OPPORTUNIT√âS -->
      <div class="page" id="page-opportunites">
        <div class="toolbar"><div class="search-box"><input type="text" id="search-opp" placeholder="Rechercher..." oninput="filterOpportunites()"></div>
        <div class="filters">
          <select class="filter-select" id="filter-opp-etape" onchange="filterOpportunites()"><option value="">Toutes √©tapes</option><option>Prospection</option><option>Analyse</option><option>√âvaluation</option><option>Devis</option><option>Convention</option><option>Action Formation</option><option>DCP</option><option>Conception</option></select>
          <select class="filter-select" id="filter-opp-etat" onchange="filterOpportunites()"><option value="">Tous √©tats</option><option>En cours</option><option>Gagn√©</option><option>Perdu</option></select>
          <button class="btn btn-primary" onclick="openModal('opportunite')">‚ûï Opportunit√©</button>
        </div></div>
        <div class="card">
          <div class="table-container">
            <table id="table-opportunites-full" style="min-width:1400px">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nom</th>
                  <th>Entreprise</th>
                  <th>Ville</th>
                  <th>Interlocuteur</th>
                  <th>Mobile</th>
                  <th>√âtape</th>
                  <th>Montant</th>
                  <th>% R√©ussite</th>
                  <th>Priorit√©</th>
                  <th>Source</th>
                  <th>Date Cl√¥ture</th>
                  <th>√âtat</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="table-opportunites"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ANALYSE -->
      <div class="page" id="page-analyse">
        <div id="qualiopi-analyse" class="qualiopi-indicators" style="display:none"></div>
        
        <!-- En-t√™te explicatif -->
        <div class="info-box" style="margin-bottom:15px;background:linear-gradient(135deg,#eff6ff,#dbeafe);border-left:4px solid #3b82f6">
          <strong>üìã Analyse des Besoins</strong> - √âtape 1 du processus : Envoyez un questionnaire au donneur d'ordre pour pr√©ciser ses besoins de formation suite √† sa demande initiale.
        </div>
        
        <div class="toolbar" style="flex-wrap:wrap;gap:10px">
          <div class="search-box"><input type="text" id="search-analyses" placeholder="Rechercher..." oninput="filterAnalyses()"></div>
          <select class="filter-select" id="filter-analyse-statut" onchange="filterAnalyses()">
            <option value="">Tous les statuts</option>
            <option value="√Ä envoyer">üìù √Ä envoyer</option>
            <option value="Envoy√©">üì§ Envoy√©</option>
            <option value="En attente">‚è≥ En attente r√©ponse</option>
            <option value="R√©ponse re√ßue">‚úÖ R√©ponse re√ßue</option>
          </select>
          <button class="btn btn-primary" onclick="ouvrirNouvelleAnalyse()">‚ûï Nouvelle Analyse</button>
        </div>
        
        <!-- Zone de cr√©ation/√©dition Analyse -->
        <div id="zone-analyse-travail" style="display:none;margin:15px 0">
          <div class="card" style="border:2px solid #3b82f6;border-radius:12px;overflow:hidden">
            <div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center">
              <h3 id="titre-analyse-travail" style="margin:0;font-size:1.1em">üìã Nouvelle Analyse des Besoins</h3>
              <button onclick="fermerZoneAnalyse()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.2em">&times;</button>
            </div>
            
            <!-- √âtape 1: S√©lection de la demande -->
            <div style="padding:20px;border-bottom:1px solid #e5e7eb;background:#f8fafc">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px">
                <span style="background:#3b82f6;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold">1</span>
                <h4 style="margin:0;color:#1e40af">S√©lectionner la demande initiale</h4>
              </div>
              
              <div class="form-group">
                <label class="form-label">Demande de formation *</label>
                <select class="form-select" id="analyse-demande" onchange="onAnalyseSelectDemande()" style="font-size:1em;padding:12px">
                  <option value="">-- S√©lectionner une demande --</option>
                </select>
              </div>
              
              <!-- Infos de la demande s√©lectionn√©e -->
              <div id="analyse-infos-demande" style="display:none;background:white;padding:15px;border-radius:8px;margin-top:15px;border:1px solid #e5e7eb">
                <h5 style="margin:0 0 10px 0;color:#374151;font-size:0.9em">üìå Informations de la demande</h5>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;font-size:0.9em">
                  <div><strong style="color:#64748b">Entreprise :</strong> <span id="info-dem-entreprise" style="color:#1e293b">-</span></div>
                  <div><strong style="color:#64748b">Contact :</strong> <span id="info-dem-contact" style="color:#1e293b">-</span></div>
                  <div><strong style="color:#64748b">Email :</strong> <span id="info-dem-email" style="color:#1e293b">-</span></div>
                  <div><strong style="color:#64748b">T√©l√©phone :</strong> <span id="info-dem-tel" style="color:#1e293b">-</span></div>
                  <div><strong style="color:#64748b">Formation souhait√©e :</strong> <span id="info-dem-formation" style="color:#1e293b">-</span></div>
                  <div><strong style="color:#64748b">Date demande :</strong> <span id="info-dem-date" style="color:#1e293b">-</span></div>
                </div>
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid #e5e7eb">
                  <strong style="color:#64748b">Message initial :</strong>
                  <p id="info-dem-message" style="margin:5px 0 0 0;color:#475569;font-style:italic">-</p>
                </div>
              </div>
            </div>
            
            <!-- √âtape 2: Configuration du questionnaire -->
            <div style="padding:20px;border-bottom:1px solid #e5e7eb">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px">
                <span style="background:#8b5cf6;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold">2</span>
                <h4 style="margin:0;color:#6d28d9">Pr√©parer le questionnaire d'analyse</h4>
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div class="form-group">
                  <label class="form-label">Date d'analyse</label>
                  <input type="date" class="form-input" id="analyse-date">
                </div>
                <div class="form-group">
                  <label class="form-label">Commercial assign√©</label>
                  <select class="form-select" id="analyse-commercial">
                    <option value="">-- S√©lectionner --</option>
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">Questions sp√©cifiques √† inclure</label>
                <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px">
                  <label style="display:flex;align-items:center;gap:5px;background:#f1f5f9;padding:8px 12px;border-radius:6px;cursor:pointer">
                    <input type="checkbox" id="q-objectifs" checked> üéØ Objectifs op√©rationnels
                  </label>
                  <label style="display:flex;align-items:center;gap:5px;background:#f1f5f9;padding:8px 12px;border-radius:6px;cursor:pointer">
                    <input type="checkbox" id="q-prerequis" checked> üìö Pr√©requis
                  </label>
                  <label style="display:flex;align-items:center;gap:5px;background:#f1f5f9;padding:8px 12px;border-radius:6px;cursor:pointer">
                    <input type="checkbox" id="q-modalites" checked> üè¢ Modalit√©s souhait√©es
                  </label>
                  <label style="display:flex;align-items:center;gap:5px;background:#f1f5f9;padding:8px 12px;border-radius:6px;cursor:pointer">
                    <input type="checkbox" id="q-dates" checked> üìÖ Dates souhait√©es
                  </label>
                  <label style="display:flex;align-items:center;gap:5px;background:#f1f5f9;padding:8px 12px;border-radius:6px;cursor:pointer">
                    <input type="checkbox" id="q-stagiaires" checked> üë• Nombre de stagiaires
                  </label>
                  <label style="display:flex;align-items:center;gap:5px;background:#f1f5f9;padding:8px 12px;border-radius:6px;cursor:pointer">
                    <input type="checkbox" id="q-handicap" checked> ‚ôø Situation de handicap
                  </label>
                  <label style="display:flex;align-items:center;gap:5px;background:#f1f5f9;padding:8px 12px;border-radius:6px;cursor:pointer">
                    <input type="checkbox" id="q-financement" checked> üí∞ Mode de financement
                  </label>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">Message personnalis√© (optionnel)</label>
                <textarea class="form-textarea" id="analyse-message" rows="3" placeholder="Ajoutez un message personnalis√© qui accompagnera le questionnaire..."></textarea>
              </div>
            </div>
            
            <!-- √âtape 3: Envoi -->
            <div style="padding:20px;background:linear-gradient(135deg,#f0fdf4,#dcfce7)">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px">
                <span style="background:#16a34a;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold">3</span>
                <h4 style="margin:0;color:#15803d">Envoyer le questionnaire</h4>
              </div>
              
              <div style="display:flex;gap:15px;flex-wrap:wrap;align-items:center">
                <button class="btn btn-success" onclick="envoyerQuestionnaireAnalyse()" style="padding:12px 25px;font-size:1em">
                  üìß Envoyer par email
                </button>
                <button class="btn btn-info" onclick="copierLienQuestionnaire()">
                  üîó Copier le lien
                </button>
                <button class="btn btn-secondary" onclick="previsualiserQuestionnaire()">
                  üëÅÔ∏è Pr√©visualiser
                </button>
              </div>
              
              <div class="form-group" style="margin-top:15px">
                <label class="form-label">Statut</label>
                <select class="form-select" id="analyse-statut" style="max-width:250px">
                  <option value="√Ä envoyer">üìù √Ä envoyer</option>
                  <option value="Envoy√©">üì§ Envoy√©</option>
                  <option value="En attente">‚è≥ En attente de r√©ponse</option>
                  <option value="R√©ponse re√ßue">‚úÖ R√©ponse re√ßue</option>
                  <option value="Annul√©">‚ùå Annul√©</option>
                </select>
              </div>
              
              <div style="margin-top:20px;padding-top:15px;border-top:1px solid #bbf7d0;display:flex;gap:10px">
                <button class="btn btn-primary" onclick="enregistrerAnalyse()" style="padding:12px 30px">
                  üíæ Enregistrer l'analyse
                </button>
                <button class="btn btn-secondary" onclick="fermerZoneAnalyse()">Annuler</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- KPIs Analyses -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px">
          <div class="kpi-card blue" style="padding:15px">
            <div class="kpi-label">Total analyses</div>
            <div class="kpi-value" id="kpi-analyses-total">0</div>
          </div>
          <div class="kpi-card yellow" style="padding:15px">
            <div class="kpi-label">En attente r√©ponse</div>
            <div class="kpi-value" id="kpi-analyses-attente">0</div>
          </div>
          <div class="kpi-card green" style="padding:15px">
            <div class="kpi-label">R√©ponses re√ßues</div>
            <div class="kpi-value" id="kpi-analyses-recues">0</div>
          </div>
          <div class="kpi-card purple" style="padding:15px">
            <div class="kpi-label">√Ä √©valuer</div>
            <div class="kpi-value" id="kpi-analyses-evaluer">0</div>
          </div>
        </div>
        
        <!-- Tableau des analyses -->
        <div class="card">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
            <h3 class="card-title">üìã Questionnaires d'analyse envoy√©s</h3>
          </div>
          <div class="table-container">
            <table style="min-width:1000px">
              <thead>
                <tr>
                  <th style="width:80px">ID</th>
                  <th>Demande</th>
                  <th>Entreprise</th>
                  <th>Contact</th>
                  <th>Email</th>
                  <th>Formation</th>
                  <th style="width:100px">Date envoi</th>
                  <th style="width:130px">Statut</th>
                  <th style="width:180px">Actions</th>
                </tr>
              </thead>
              <tbody id="table-analyses"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- EVALUATION - Traitement des r√©ponses et cr√©ation session -->
      <div class="page" id="page-evaluation">
        <div id="qualiopi-evaluation" class="qualiopi-indicators" style="display:none"></div>
        
        <!-- En-t√™te explicatif -->
        <div class="info-box" style="margin-bottom:15px;background:linear-gradient(135deg,#fdf4ff,#f3e8ff);border-left:4px solid #8b5cf6">
          <strong>üìù √âvaluation des Besoins</strong> - √âtape 2 du processus : Analysez les r√©ponses du questionnaire, faites la synth√®se et cr√©ez l'action de formation.
        </div>
        
        <div class="toolbar" style="flex-wrap:wrap;gap:10px">
          <div class="search-box"><input type="text" id="search-evaluations" placeholder="Rechercher..." oninput="filterEvaluations()"></div>
          <select class="filter-select" id="filter-eval-statut" onchange="filterEvaluations()">
            <option value="">Tous les statuts</option>
            <option value="√Ä traiter">üìã √Ä traiter</option>
            <option value="En cours">üîÑ En cours</option>
            <option value="Valid√©">‚úÖ Valid√©</option>
            <option value="Session cr√©√©e">üéì Session cr√©√©e</option>
          </select>
          <button class="btn btn-primary" onclick="ouvrirNouvelleEvaluation()">‚ûï Nouvelle √âvaluation</button>
        </div>
        
        <!-- Zone de travail √âvaluation -->
        <div id="zone-evaluation-travail" style="display:none;margin:15px 0">
          <div class="card" style="border:2px solid #8b5cf6;border-radius:12px;overflow:hidden">
            <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center">
              <h3 id="titre-evaluation-travail" style="margin:0;font-size:1.1em">üìù √âvaluation des Besoins</h3>
              <button onclick="fermerZoneEvaluation()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.2em">&times;</button>
            </div>
            
            <!-- √âtape 1: S√©lection de l'analyse -->
            <div style="padding:20px;border-bottom:1px solid #e5e7eb;background:#f8fafc">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px">
                <span style="background:#8b5cf6;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold">1</span>
                <h4 style="margin:0;color:#6d28d9">S√©lectionner l'analyse (r√©ponse re√ßue)</h4>
              </div>
              
              <div class="form-group">
                <label class="form-label">Analyse avec r√©ponse *</label>
                <select class="form-select" id="eval-analyse" onchange="onEvalSelectAnalyse()" style="font-size:1em;padding:12px">
                  <option value="">-- S√©lectionner une analyse --</option>
                </select>
              </div>
              
              <!-- Infos de l'analyse s√©lectionn√©e -->
              <div id="eval-infos-analyse" style="display:none;background:white;padding:15px;border-radius:8px;margin-top:15px;border:1px solid #e5e7eb">
                <h5 style="margin:0 0 10px 0;color:#374151;font-size:0.9em">üìå Informations de la demande</h5>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;font-size:0.9em">
                  <div><strong style="color:#64748b">Entreprise :</strong> <span id="eval-info-entreprise" style="color:#1e293b">-</span></div>
                  <div><strong style="color:#64748b">Contact :</strong> <span id="eval-info-contact" style="color:#1e293b">-</span></div>
                  <div><strong style="color:#64748b">Email :</strong> <span id="eval-info-email" style="color:#1e293b">-</span></div>
                  <div><strong style="color:#64748b">T√©l√©phone :</strong> <span id="eval-info-tel" style="color:#1e293b">-</span></div>
                  <div><strong style="color:#64748b">Formation demand√©e :</strong> <span id="eval-info-formation" style="color:#1e293b">-</span></div>
                  <div><strong style="color:#64748b">Date questionnaire :</strong> <span id="eval-info-date" style="color:#1e293b">-</span></div>
                </div>
              </div>
            </div>
            
            <!-- √âtape 2: R√©ponses du questionnaire -->
            <div style="padding:20px;border-bottom:1px solid #e5e7eb">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px">
                <span style="background:#f59e0b;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold">2</span>
                <h4 style="margin:0;color:#b45309">R√©ponses du questionnaire</h4>
                <button class="btn btn-sm btn-info" onclick="importerReponsesQuestionnaire()">üì• Importer les r√©ponses</button>
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div class="form-group">
                  <label class="form-label">üéØ Objectifs op√©rationnels souhait√©s</label>
                  <textarea class="form-textarea" id="eval-objectifs" rows="3" placeholder="Quels sont les objectifs concrets du client ?"></textarea>
                </div>
                <div class="form-group">
                  <label class="form-label">üìö Niveau actuel / Pr√©requis</label>
                  <textarea class="form-textarea" id="eval-prerequis" rows="3" placeholder="Quel est le niveau actuel des stagiaires ?"></textarea>
                </div>
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px">
                <div class="form-group">
                  <label class="form-label">üë• Nombre de stagiaires</label>
                  <input type="number" class="form-input" id="eval-nb-stagiaires" min="1" placeholder="Ex: 5">
                </div>
                <div class="form-group">
                  <label class="form-label">üìÖ Dates souhait√©es</label>
                  <input type="text" class="form-input" id="eval-dates-souhaitees" placeholder="Ex: Mars 2025">
                </div>
                <div class="form-group">
                  <label class="form-label">üè¢ Modalit√©s</label>
                  <select class="form-select" id="eval-modalites">
                    <option value="">-- S√©lectionner --</option>
                    <option value="intra">Intra (dans leurs locaux)</option>
                    <option value="inter">Inter (dans nos locaux)</option>
                    <option value="distance">√Ä distance</option>
                    <option value="mixte">Mixte</option>
                  </select>
                </div>
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div class="form-group">
                  <label class="form-label">‚ôø Situation de handicap</label>
                  <select class="form-select" id="eval-handicap">
                    <option value="non">Non</option>
                    <option value="oui">Oui - Adaptation n√©cessaire</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">üí∞ Mode de financement envisag√©</label>
                  <select class="form-select" id="eval-financement">
                    <option value="">-- S√©lectionner --</option>
                    <option value="opco">OPCO</option>
                    <option value="cpf">CPF</option>
                    <option value="entreprise">Fonds propres entreprise</option>
                    <option value="pole-emploi">France Travail</option>
                    <option value="autre">Autre</option>
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">üìù Autres besoins exprim√©s</label>
                <textarea class="form-textarea" id="eval-autres-besoins" rows="2" placeholder="Autres informations ou demandes sp√©cifiques..."></textarea>
              </div>
            </div>
            
            <!-- √âtape 3: Synth√®se et pr√©conisations -->
            <div style="padding:20px;border-bottom:1px solid #e5e7eb;background:linear-gradient(135deg,#f0fdf4,#dcfce7)">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px">
                <span style="background:#16a34a;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold">3</span>
                <h4 style="margin:0;color:#15803d">Synth√®se et pr√©conisations</h4>
              </div>
              
              <div class="form-group">
                <label class="form-label" style="font-weight:600;color:#15803d">üìã SYNTH√àSE DE L'√âVALUATION DES BESOINS *</label>
                <textarea class="form-textarea" id="eval-synthese" rows="5" placeholder="R√©digez votre synth√®se : analyse des besoins, √©carts identifi√©s, points d'attention..." style="border:2px solid #86efac"></textarea>
              </div>
              
              <div class="form-group">
                <label class="form-label" style="font-weight:600;color:#15803d">üéØ PR√âCONISATIONS DE FORMATION</label>
                <textarea class="form-textarea" id="eval-preconisations" rows="4" placeholder="Formation recommand√©e, dur√©e, modalit√©s, programme adapt√©..." style="border:2px solid #86efac"></textarea>
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div class="form-group">
                  <label class="form-label">Formation pr√©conis√©e</label>
                  <select class="form-select" id="eval-formation-preconisee">
                    <option value="">-- S√©lectionner --</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Dur√©e pr√©conis√©e (heures)</label>
                  <input type="number" class="form-input" id="eval-duree-preconisee" min="1" placeholder="Ex: 14">
                </div>
              </div>
            </div>
            
            <!-- √âtape 4: Validation et cr√©ation session -->
            <div style="padding:20px;background:linear-gradient(135deg,#eff6ff,#dbeafe)">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px">
                <span style="background:#2563eb;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold">4</span>
                <h4 style="margin:0;color:#1d4ed8">Validation et cr√©ation de l'action de formation</h4>
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px">
                <div class="form-group">
                  <label class="form-label">Date de l'√©valuation</label>
                  <input type="date" class="form-input" id="eval-date">
                </div>
                <div class="form-group">
                  <label class="form-label">Statut</label>
                  <select class="form-select" id="eval-statut">
                    <option value="√Ä traiter">üìã √Ä traiter</option>
                    <option value="En cours">üîÑ En cours</option>
                    <option value="Valid√©">‚úÖ Valid√©</option>
                    <option value="Session cr√©√©e">üéì Session cr√©√©e</option>
                    <option value="Annul√©">‚ùå Annul√©</option>
                  </select>
                </div>
              </div>
              
              <div style="display:flex;gap:15px;flex-wrap:wrap;padding-top:15px;border-top:1px solid #bfdbfe">
                <button class="btn btn-primary" onclick="enregistrerEvaluation()" style="padding:12px 30px">
                  üíæ Enregistrer l'√©valuation
                </button>
                <button class="btn btn-success" onclick="genererPDFEvaluation()" style="padding:12px 25px">
                  üìÑ G√©n√©rer PDF de synth√®se
                </button>
                <button class="btn" onclick="creerSessionDepuisEvaluation()" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:white;padding:12px 25px">
                  üéì Cr√©er la session de formation
                </button>
                <button class="btn btn-secondary" onclick="fermerZoneEvaluation()">Annuler</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- KPIs √âvaluations -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px">
          <div class="kpi-card purple" style="padding:15px">
            <div class="kpi-label">Total √©valuations</div>
            <div class="kpi-value" id="kpi-eval-total">0</div>
          </div>
          <div class="kpi-card yellow" style="padding:15px">
            <div class="kpi-label">√Ä traiter</div>
            <div class="kpi-value" id="kpi-eval-traiter">0</div>
          </div>
          <div class="kpi-card green" style="padding:15px">
            <div class="kpi-label">Valid√©es</div>
            <div class="kpi-value" id="kpi-eval-validees">0</div>
          </div>
          <div class="kpi-card blue" style="padding:15px">
            <div class="kpi-label">Sessions cr√©√©es</div>
            <div class="kpi-value" id="kpi-eval-sessions">0</div>
          </div>
        </div>
        
        <!-- Tableau des √©valuations -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìù √âvaluations r√©alis√©es</h3>
          </div>
          <div class="table-container">
            <table style="min-width:1100px">
              <thead>
                <tr>
                  <th style="width:80px">ID</th>
                  <th>Entreprise</th>
                  <th>Contact</th>
                  <th>Formation pr√©conis√©e</th>
                  <th style="width:80px">Stagiaires</th>
                  <th>Modalit√©</th>
                  <th style="width:100px">Date</th>
                  <th style="width:130px">Statut</th>
                  <th style="width:200px">Actions</th>
                </tr>
              </thead>
              <tbody id="table-evaluations"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- STAGIAIRES -->
      <div class="page" id="page-stagiaires">
        <div id="qualiopi-stagiaires" class="qualiopi-indicators" style="display:none"></div>
        <div class="toolbar" style="flex-wrap:wrap;gap:10px">
          <div class="search-box"><input type="text" id="search-stagiaires" placeholder="Rechercher..." oninput="filterStagiaires()"></div>
          <div class="filters" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <select class="filter-select" id="filter-stagiaires-entreprise" onchange="filterStagiaires()">
              <option value="">Toutes entreprises</option>
            </select>
            <select class="filter-select" id="filter-stagiaires-psh" onchange="filterStagiaires()">
              <option value="">Tous</option>
              <option value="oui">PSH uniquement</option>
              <option value="non">Non PSH</option>
            </select>
            <button class="btn btn-success" onclick="ouvrirModalImportStagiaires()">üì• Importer (code)</button>
            <button class="btn" style="background:#8b5cf6;color:#fff" onclick="ouvrirSelecteurEntrepriseDemandeStagiaires()">üìß Demander infos</button>
            <button class="btn btn-primary" onclick="openModal('stagiaire')">‚ûï Stagiaire</button>
          </div>
        </div>
        
        <!-- S√©lecteur entreprise pour demande infos -->
        <div id="selecteur-entreprise-demande" style="display:none;background:linear-gradient(135deg,#f3e8ff,#ede9fe);border:1px solid #c4b5fd;border-radius:8px;padding:15px;margin-bottom:15px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <strong style="color:#7c3aed">üìß Demander les informations des stagiaires √† une entreprise</strong>
            <button onclick="fermerSelecteurEntreprise()" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:#6b7280">&times;</button>
          </div>
          <div style="display:flex;gap:10px;align-items:end">
            <div style="flex:1">
              <label class="form-label" style="font-size:0.85rem;color:#374151">S√©lectionner une entreprise</label>
              <select class="form-select" id="select-entreprise-demande" style="width:100%">
                <option value="">-- Choisir une entreprise --</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="ouvrirDemandeStagiairesDepuisSelecteur()">üìß Pr√©parer l'email</button>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table id="table-stagiaires-full">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nom</th>
                  <th>Pr√©nom</th>
                  <th>Entreprise</th>
                  <th>Fonction</th>
                  <th>Email</th>
                  <th>T√©l√©phone</th>
                  <th>PSH</th>
                  <th class="col-confidentiel" style="display:none">Date Naiss.</th>
                  <th class="col-confidentiel" style="display:none">N¬∞ S√©cu</th>
                  <th class="col-confidentiel" style="display:none">Taux H.</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="table-stagiaires-main"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Modal import stagiaires depuis code -->
        <div id="modal-import-stagiaires" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;padding:20px">
          <div style="background:#fff;border-radius:12px;width:600px;max-width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
            <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-radius:12px 12px 0 0">
              <h3 style="margin:0;color:#10b981">üì• Importer des stagiaires</h3>
              <button onclick="fermerModalImportStagiaires()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#64748b">&times;</button>
            </div>
            <div style="padding:20px">
              <p style="color:#64748b;margin-bottom:15px">Collez ici le code re√ßu du contact entreprise (g√©n√©r√© via le formulaire en ligne) :</p>
              <textarea id="import-stagiaires-code" class="form-textarea" rows="6" style="width:100%;font-family:monospace;font-size:0.85em" placeholder="Collez le code ici..."></textarea>
              
              <div id="import-stagiaires-preview" style="display:none;margin-top:20px">
                <h4 style="color:#0066cc;margin-bottom:10px">üìã Aper√ßu des stagiaires √† importer</h4>
                <div id="import-stagiaires-liste" style="max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px"></div>
              </div>
            </div>
            <div style="padding:15px 20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;background:#f8fafc;border-radius:0 0 12px 12px">
              <button class="btn btn-secondary" onclick="fermerModalImportStagiaires()">Annuler</button>
              <button class="btn btn-info" onclick="previsualiserImportStagiaires()">üëÅÔ∏è Pr√©visualiser</button>
              <button class="btn btn-success" id="btn-confirmer-import" onclick="confirmerImportStagiaires()" style="display:none">‚úÖ Importer</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Upload Document Sign√© -->
      <div id="modal-upload-doc-signe" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;padding:20px">
        <div style="background:#fff;border-radius:12px;width:500px;max-width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
          <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#10b981,#059669);border-radius:12px 12px 0 0">
            <h3 id="upload-doc-signe-titre" style="margin:0;color:#fff">üì§ Uploader le document sign√©</h3>
            <button onclick="fermerModalUploadDocSigne()" style="background:rgba(255,255,255,0.2);border:none;font-size:1.5rem;cursor:pointer;color:#fff;width:35px;height:35px;border-radius:50%">&times;</button>
          </div>
          <div style="padding:25px">
            <p style="color:#64748b;margin-bottom:20px">S√©lectionnez le fichier scann√© ou photographi√© du document sign√© (PDF, JPG ou PNG, max 10 Mo).</p>
            
            <div style="border:2px dashed #cbd5e1;border-radius:12px;padding:30px;text-align:center;background:#f8fafc;transition:all 0.2s;cursor:pointer" 
                 onclick="document.getElementById('upload-doc-signe-input').click()"
                 onmouseover="this.style.borderColor='#10b981';this.style.background='#f0fdf4'"
                 onmouseout="this.style.borderColor='#cbd5e1';this.style.background='#f8fafc'">
              <div style="font-size:3rem;margin-bottom:10px">üìé</div>
              <p style="font-weight:600;color:#374151;margin-bottom:5px">Cliquez pour s√©lectionner un fichier</p>
              <p style="font-size:0.85em;color:#64748b">ou glissez-d√©posez ici</p>
              <input type="file" id="upload-doc-signe-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="onUploadDocSigneChange(this)">
            </div>
            
            <div id="upload-doc-signe-preview" style="display:none;margin-top:20px;padding:15px;background:#f1f5f9;border-radius:8px"></div>
          </div>
          <div style="padding:15px 25px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;background:#f8fafc;border-radius:0 0 12px 12px">
            <button class="btn btn-secondary" onclick="fermerModalUploadDocSigne()">Annuler</button>
            <button class="btn btn-success" onclick="confirmerUploadDocSigne()">‚úÖ Confirmer l'upload</button>
          </div>
        </div>
      </div>

      <!-- MODAL DOCUMENT QUALIOPI -->
      <div id="modal-doc-qualiopi" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;padding:20px">
        <div style="background:#fff;border-radius:12px;width:600px;max-width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
          <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#7c3aed,#6d28d9);border-radius:12px 12px 0 0">
            <h3 id="modal-doc-quali-titre" style="margin:0;color:#fff">üìÅ Ajouter un document Qualiopi</h3>
            <button onclick="fermerModalDocQualiopi()" style="background:rgba(255,255,255,0.2);border:none;font-size:1.5rem;cursor:pointer;color:#fff;width:35px;height:35px;border-radius:50%">&times;</button>
          </div>
          <div style="padding:25px">
            <div class="form-group">
              <label class="form-label">Titre du document *</label>
              <input type="text" class="form-input" id="doc-quali-titre" placeholder="Ex: Proc√©dure de traitement des r√©clamations">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
              <div class="form-group">
                <label class="form-label">Crit√®re Qualiopi *</label>
                <select class="form-select" id="doc-quali-critere">
                  <option value="">-- S√©lectionner --</option>
                  <option value="C1">C1 - Information du public</option>
                  <option value="C2">C2 - Objectifs et adaptation</option>
                  <option value="C3">C3 - Accompagnement</option>
                  <option value="C4">C4 - Moyens p√©dagogiques</option>
                  <option value="C5">C5 - Qualification du personnel</option>
                  <option value="C6">C6 - Inscription professionnelle</option>
                  <option value="C7">C7 - Am√©lioration continue</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Type de document *</label>
                <select class="form-select" id="doc-quali-type">
                  <option value="">-- S√©lectionner --</option>
                  <option value="procedure">üìã Proc√©dure</option>
                  <option value="formulaire">üìù Formulaire</option>
                  <option value="modele">üìÑ Mod√®le</option>
                  <option value="preuve">‚úÖ Preuve</option>
                  <option value="rapport">üìä Rapport</option>
                  <option value="autre">üìé Autre</option>
                </select>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
              <div class="form-group">
                <label class="form-label">Num√©ro de version *</label>
                <input type="text" class="form-input" id="doc-quali-version" value="1.0" placeholder="Ex: 1.0, 2.1">
              </div>
              <div class="form-group">
                <label class="form-label">Date de r√©vision</label>
                <input type="date" class="form-input" id="doc-quali-date-revision">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Description / Notes</label>
              <textarea class="form-textarea" id="doc-quali-description" rows="2" placeholder="Description du contenu du document..."></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Fichier *</label>
              <div style="border:2px dashed #cbd5e1;border-radius:12px;padding:25px;text-align:center;background:#f8fafc;cursor:pointer" 
                   onclick="document.getElementById('doc-quali-fichier').click()"
                   id="doc-quali-dropzone">
                <div style="font-size:2.5rem;margin-bottom:10px">üìé</div>
                <p style="font-weight:600;color:#374151;margin-bottom:5px">Cliquez pour s√©lectionner</p>
                <p style="font-size:0.85em;color:#64748b">PDF, Word, Excel, Image (max 20 Mo)</p>
                <input type="file" id="doc-quali-fichier" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" style="display:none" onchange="onDocQualiFileChange(this)">
              </div>
              <div id="doc-quali-fichier-info" style="display:none;margin-top:10px;padding:10px;background:#dcfce7;border-radius:8px;color:#15803d"></div>
            </div>
          </div>
          <div style="padding:15px 25px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;background:#f8fafc;border-radius:0 0 12px 12px">
            <button class="btn btn-secondary" onclick="fermerModalDocQualiopi()">Annuler</button>
            <button class="btn btn-primary" onclick="sauvegarderDocQualiopi()">üíæ Enregistrer</button>
          </div>
        </div>
      </div>

      <!-- MODAL VEILLE -->
      <div id="modal-veille" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;padding:20px">
        <div style="background:#fff;border-radius:12px;width:800px;max-width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
          <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#0891b2,#0e7490);border-radius:12px 12px 0 0">
            <h3 id="modal-veille-titre" style="margin:0;color:#fff">üîç Ajouter un article de veille</h3>
            <button onclick="fermerModalVeille()" style="background:rgba(255,255,255,0.2);border:none;font-size:1.5rem;cursor:pointer;color:#fff;width:35px;height:35px;border-radius:50%">&times;</button>
          </div>
          <div style="padding:25px">
            <input type="hidden" id="veille-id">
            <div class="form-group">
              <label class="form-label">Source *</label>
              <select class="form-select" id="veille-source-select" onchange="onVeilleSourceChange()">
                <option value="">-- S√©lectionner une source --</option>
              </select>
              <input type="url" class="form-input" id="veille-source-url" placeholder="URL de l'article (https://...)" style="margin-top:8px">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
              <div class="form-group">
                <label class="form-label">Type de veille *</label>
                <select class="form-select" id="veille-type">
                  <option value="">-- S√©lectionner --</option>
                  <option value="pedagogique">üìö P√©dagogique</option>
                  <option value="juridique">‚öñÔ∏è Juridique & R√©glementaire</option>
                  <option value="sectorielle">üè≠ Sectorielle</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Date de recueil *</label>
                <input type="date" class="form-input" id="veille-date">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">R√©sum√© de l'information *</label>
              <textarea class="form-textarea" id="veille-resume" rows="3" placeholder="R√©sum√© des points cl√©s de l'article..."></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Principale information *</label>
              <textarea class="form-textarea" id="veille-principale-info" rows="2" placeholder="L'information principale √† retenir..."></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Impact sur notre activit√©</label>
              <select class="form-select" id="veille-impact">
                <option value="faible">üü¢ Faible</option>
                <option value="moyen">üü° Moyen</option>
                <option value="important">üî¥ Important</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Actions d'√©volution de notre organisme *</label>
              <textarea class="form-textarea" id="veille-actions" rows="3" placeholder="Actions correctives ou pr√©ventives √† mettre en place suite √† cette information..."></textarea>
            </div>
            
            <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:15px;margin-top:15px">
              <label class="form-label" style="margin-bottom:12px;font-weight:600">üì§ Diffusion de l'information</label>
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:10px;background:white;border:1px solid #e2e8f0;border-radius:6px">
                  <input type="checkbox" id="veille-diffusion-newsletter" style="width:18px;height:18px">
                  <span>üìß Newsletter</span>
                </label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:10px;background:white;border:1px solid #e2e8f0;border-radius:6px">
                  <input type="checkbox" id="veille-diffusion-site" style="width:18px;height:18px">
                  <span>üåê Site</span>
                </label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:10px;background:white;border:1px solid #e2e8f0;border-radius:6px">
                  <input type="checkbox" id="veille-diffusion-docs" style="width:18px;height:18px">
                  <span>üìÅ Documents</span>
                </label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:10px;background:white;border:1px solid #e2e8f0;border-radius:6px">
                  <input type="checkbox" id="veille-diffusion-outils" style="width:18px;height:18px">
                  <span>üõ†Ô∏è Outils</span>
                </label>
              </div>
            </div>
          </div>
          <div style="padding:15px 25px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;background:#f8fafc;border-radius:0 0 12px 12px">
            <button class="btn btn-secondary" onclick="fermerModalVeille()">Annuler</button>
            <button class="btn btn-primary" onclick="sauvegarderVeille()">üíæ Enregistrer</button>
          </div>
        </div>
      </div>
      
      <!-- MODAL GESTION SOURCES DE VEILLE -->
      <div id="modal-sources-veille" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;padding:20px">
        <div style="background:#fff;border-radius:12px;width:600px;max-width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
          <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:12px 12px 0 0">
            <h3 style="margin:0;color:#fff">üåê G√©rer les sources de veille</h3>
            <button onclick="fermerModalSourcesVeille()" style="background:rgba(255,255,255,0.2);border:none;font-size:1.5rem;cursor:pointer;color:#fff;width:35px;height:35px;border-radius:50%">&times;</button>
          </div>
          <div style="padding:25px">
            <div class="form-group">
              <label class="form-label">Ajouter une nouvelle source</label>
              <div style="display:flex;gap:10px">
                <input type="text" class="form-input" id="nouvelle-source-nom" placeholder="Nom de la source" style="flex:1">
                <input type="url" class="form-input" id="nouvelle-source-url" placeholder="URL (https://...)" style="flex:1.5">
                <select class="form-select" id="nouvelle-source-type" style="width:150px">
                  <option value="pedagogique">üìö P√©dago.</option>
                  <option value="juridique">‚öñÔ∏è Juridique</option>
                  <option value="sectorielle">üè≠ Sectoriel</option>
                </select>
                <button class="btn btn-primary" onclick="ajouterSourceVeille()">‚ûï</button>
              </div>
            </div>
            
            <div style="margin-top:20px">
              <h4 style="margin:0 0 15px 0;color:#374151">Sources configur√©es</h4>
              <div id="liste-sources-veille" style="display:flex;flex-direction:column;gap:10px">
                <!-- G√©n√©r√© dynamiquement -->
              </div>
            </div>
          </div>
          <div style="padding:15px 25px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;background:#f8fafc;border-radius:0 0 12px 12px">
            <button class="btn btn-secondary" onclick="fermerModalSourcesVeille()">Fermer</button>
          </div>
        </div>
      </div>
      
      <!-- MODAL IDCC -->
      <div id="modal-idcc" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;padding:20px">
        <div style="background:#fff;border-radius:12px;width:650px;max-width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
          <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:12px 12px 0 0">
            <h3 id="modal-idcc-titre" style="margin:0;color:#fff">üìã Ajouter un IDCC</h3>
            <button onclick="fermerModalIDCC()" style="background:rgba(255,255,255,0.2);border:none;font-size:1.5rem;cursor:pointer;color:#fff;width:35px;height:35px;border-radius:50%">&times;</button>
          </div>
          <div style="padding:25px">
            <input type="hidden" id="idcc-edit-id">
            
            <div class="form-row" style="gap:15px">
              <div class="form-group" style="flex:1">
                <label class="form-label">Code IDCC *</label>
                <input type="text" class="form-input" id="idcc-code" placeholder="Ex: 0843" maxlength="4" pattern="[0-9]{4}" style="font-size:1.2em;font-weight:bold;text-align:center">
                <small style="color:#64748b">4 chiffres</small>
              </div>
              <div class="form-group" style="flex:2">
                <label class="form-label">Secteur d'activit√©</label>
                <select class="form-select" id="idcc-secteur">
                  <option value="">-- S√©lectionner --</option>
                  <option value="Alimentation">üçΩÔ∏è Alimentation</option>
                  <option value="Commerce">üõí Commerce</option>
                  <option value="Services">üîß Services</option>
                  <option value="H√¥tellerie-Restauration">üè® H√¥tellerie-Restauration</option>
                  <option value="Artisanat">üî® Artisanat</option>
                  <option value="Sant√©">üè• Sant√©</option>
                  <option value="Industrie">üè≠ Industrie</option>
                  <option value="BTP">üèóÔ∏è BTP</option>
                  <option value="Transport">üöö Transport</option>
                  <option value="Autre">üìÅ Autre</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Intitul√© de la Convention Collective *</label>
              <input type="text" class="form-input" id="idcc-intitule" placeholder="Ex: Boulangerie-p√¢tisserie (entreprises artisanales)">
            </div>
            
            <div class="form-row" style="gap:15px">
              <div class="form-group" style="flex:1">
                <label class="form-label">OPCO de rattachement</label>
                <select class="form-select" id="idcc-opco">
                  <option value="">-- S√©lectionner --</option>
                  <option value="AKTO">AKTO</option>
                  <option value="OPCO EP">OPCO EP</option>
                  <option value="OPCO Atlas">OPCO Atlas</option>
                  <option value="OPCO Mobilit√©s">OPCO Mobilit√©s</option>
                  <option value="OPCO Sant√©">OPCO Sant√©</option>
                  <option value="L'Opcommerce">L'Opcommerce</option>
                  <option value="OPCO 2i">OPCO 2i</option>
                  <option value="AFDAS">AFDAS</option>
                  <option value="Ocapiat">Ocapiat</option>
                  <option value="Constructys">Constructys</option>
                  <option value="Uniformation">Uniformation</option>
                </select>
              </div>
              <div class="form-group" style="flex:1">
                <label class="form-label">Statut</label>
                <select class="form-select" id="idcc-statut">
                  <option value="Actif">‚úÖ Actif</option>
                  <option value="Inactif">‚ùå Inactif</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Notes / Commentaires</label>
              <textarea class="form-textarea" id="idcc-notes" rows="2" placeholder="Informations compl√©mentaires..."></textarea>
            </div>
          </div>
          <div style="padding:15px 25px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;background:#f8fafc;border-radius:0 0 12px 12px">
            <button class="btn btn-secondary" onclick="fermerModalIDCC()">Annuler</button>
            <button class="btn btn-primary" onclick="sauvegarderIDCC()">üíæ Enregistrer</button>
          </div>
        </div>
      </div>
      
      <!-- MODAL DEMANDE INFOS STAGIAIRES -->
      <div id="modal-demande-stagiaires" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;padding:20px">
        <div style="background:#fff;border-radius:12px;width:800px;max-width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
          <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:12px 12px 0 0">
            <h3 style="margin:0;color:#fff">üìß Demande d'informations stagiaires</h3>
            <button onclick="fermerModalDemandeStagiaires()" style="background:rgba(255,255,255,0.2);border:none;font-size:1.5rem;cursor:pointer;color:#fff;width:35px;height:35px;border-radius:50%">&times;</button>
          </div>
          <div style="padding:25px">
            <input type="hidden" id="demande-stag-entreprise-id">
            
            <!-- Infos entreprise -->
            <div style="background:#f1f5f9;padding:15px;border-radius:8px;margin-bottom:20px">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <div><strong>üè¢ Entreprise:</strong> <span id="demande-stag-entreprise-nom">-</span></div>
                <div><strong>üë§ Contact:</strong> <span id="demande-stag-contact">-</span></div>
                <div><strong>üìß Email:</strong> <span id="demande-stag-email">-</span></div>
                <div><strong>üë• Nb salari√©s:</strong> <span id="demande-stag-nb-salaries">-</span></div>
              </div>
            </div>
            
            <!-- Stagiaires existants -->
            <div style="margin-bottom:20px">
              <h4 style="margin:0 0 10px 0;color:#374151;font-size:0.9rem">üë• Stagiaires d√©j√† enregistr√©s pour cette entreprise</h4>
              <div id="demande-stag-liste-existants" style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;max-height:150px;overflow-y:auto;padding:10px">
                <p style="color:#64748b;margin:0;text-align:center">Chargement...</p>
              </div>
            </div>
            
            <!-- Email -->
            <div class="form-group">
              <label class="form-label">üìß Destinataire</label>
              <input type="email" class="form-input" id="demande-stag-destinataire" readonly style="background:#f1f5f9">
            </div>
            
            <div class="form-group">
              <label class="form-label">üìù Objet de l'email</label>
              <input type="text" class="form-input" id="demande-stag-objet" value="Demande d'informations sur vos salari√©s pour inscription en formation">
            </div>
            
            <div class="form-group">
              <label class="form-label">‚úâÔ∏è Corps du message</label>
              <textarea class="form-textarea" id="demande-stag-message" rows="12" style="font-family:inherit;line-height:1.6"></textarea>
            </div>
            
            <div class="form-group">
              <label class="form-label"><input type="checkbox" id="demande-stag-copie-bcc" checked> Envoyer une copie (BCC) √† l'organisme de formation</label>
            </div>
            
            <!-- Templates rapides -->
            <div style="margin-top:15px;padding:15px;background:#fef3c7;border-radius:8px">
              <strong style="color:#92400e;font-size:0.85rem">üí° Templates rapides</strong>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
                <button class="btn btn-sm btn-secondary" onclick="appliquerTemplateStagiaires('complet')">üìã Complet (tous champs)</button>
                <button class="btn btn-sm btn-secondary" onclick="appliquerTemplateStagiaires('minimal')">üìù Minimal (nom, email)</button>
                <button class="btn btn-sm btn-secondary" onclick="appliquerTemplateStagiaires('haccp')">üçΩÔ∏è Formation HACCP</button>
                <button class="btn btn-sm btn-secondary" onclick="appliquerTemplateStagiaires('securite')">ü¶∫ S√©curit√© au travail</button>
              </div>
            </div>
          </div>
          <div style="padding:15px 25px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;background:#f8fafc;border-radius:0 0 12px 12px">
            <button class="btn btn-secondary" onclick="fermerModalDemandeStagiaires()">Annuler</button>
            <button class="btn btn-primary" onclick="envoyerDemandeStagiaires()">üì§ Envoyer l'email</button>
          </div>
        </div>
      </div>

      <!-- MODAL TUTORIEL -->
      <div id="modal-tutoriel" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;justify-content:center;align-items:center;padding:20px">
        <div style="background:#fff;border-radius:12px;width:95%;max-width:1100px;height:90vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.4)">
          <div style="padding:15px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:12px 12px 0 0">
            <h3 style="margin:0;color:#fff;display:flex;align-items:center;gap:10px">üìö Tutoriel - Processus complet d'une action de formation</h3>
            <button onclick="fermerTutoriel()" style="background:rgba(255,255,255,0.2);border:none;font-size:1.5rem;cursor:pointer;color:#fff;width:35px;height:35px;border-radius:50%">&times;</button>
          </div>
          
          <!-- Navigation du tutoriel -->
          <div style="background:#f8fafc;padding:15px 20px;border-bottom:1px solid #e5e7eb;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button class="btn btn-sm tuto-nav active" data-tuto="intro" onclick="naviguerTutoriel('intro')" style="background:#1e40af;color:white">üè† Accueil</button>
            <button class="btn btn-sm tuto-nav" data-tuto="etape1" onclick="naviguerTutoriel('etape1')">1Ô∏è‚É£ Demande</button>
            <button class="btn btn-sm tuto-nav" data-tuto="etape2" onclick="naviguerTutoriel('etape2')">2Ô∏è‚É£ Analyse</button>
            <button class="btn btn-sm tuto-nav" data-tuto="etape3" onclick="naviguerTutoriel('etape3')">3Ô∏è‚É£ √âvaluation</button>
            <button class="btn btn-sm tuto-nav" data-tuto="etape4" onclick="naviguerTutoriel('etape4')">4Ô∏è‚É£ Session</button>
            <button class="btn btn-sm tuto-nav" data-tuto="etape5" onclick="naviguerTutoriel('etape5')">5Ô∏è‚É£ Devis</button>
            <button class="btn btn-sm tuto-nav" data-tuto="etape6" onclick="naviguerTutoriel('etape6')">6Ô∏è‚É£ Convention</button>
            <button class="btn btn-sm tuto-nav" data-tuto="etape7" onclick="naviguerTutoriel('etape7')">7Ô∏è‚É£ Conception</button>
            <button class="btn btn-sm tuto-nav" data-tuto="recap" onclick="naviguerTutoriel('recap')">üìä R√©cap</button>
          </div>
          
          <!-- Contenu du tutoriel -->
          <div id="tutoriel-contenu" style="flex:1;overflow-y:auto;padding:25px">
            <!-- Contenu g√©n√©r√© dynamiquement -->
          </div>
          
          <!-- Footer navigation -->
          <div style="padding:15px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-radius:0 0 12px 12px">
            <button class="btn btn-secondary" id="tuto-btn-prec" onclick="tutorielPrecedent()">‚¨ÖÔ∏è Pr√©c√©dent</button>
            <span id="tuto-progression" style="color:#64748b;font-size:0.9em">√âtape 1 / 9</span>
            <button class="btn btn-primary" id="tuto-btn-suiv" onclick="tutorielSuivant()">Suivant ‚û°Ô∏è</button>
          </div>
        </div>
      </div>

      <!-- MODAL VISUALISATION DOCUMENT -->
      <div id="modal-view-doc-quali" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;justify-content:center;align-items:center;padding:20px">
        <div style="background:#fff;border-radius:12px;width:90%;max-width:1000px;height:85vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.4)">
          <div style="padding:15px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#1e40af,#3b82f6);border-radius:12px 12px 0 0">
            <h3 id="view-doc-quali-titre" style="margin:0;color:#fff">üìÑ Visualisation</h3>
            <div style="display:flex;gap:10px;align-items:center">
              <button class="btn btn-sm" onclick="telechargerDocQualiopi()" style="background:rgba(255,255,255,0.2);color:white;border:none">üì• T√©l√©charger</button>
              <button onclick="fermerViewDocQualiopi()" style="background:rgba(255,255,255,0.2);border:none;font-size:1.5rem;cursor:pointer;color:#fff;width:35px;height:35px;border-radius:50%">&times;</button>
            </div>
          </div>
          <div id="view-doc-quali-content" style="flex:1;overflow:auto;background:#f1f5f9;display:flex;justify-content:center;align-items:center">
            <!-- Contenu dynamique -->
          </div>
          <div style="padding:10px 20px;border-top:1px solid #e5e7eb;background:#f8fafc;border-radius:0 0 12px 12px;display:flex;justify-content:space-between;align-items:center">
            <div id="view-doc-quali-info" style="font-size:0.85em;color:#64748b"></div>
            <button class="btn btn-secondary" onclick="fermerViewDocQualiopi()">Fermer</button>
          </div>
        </div>
      </div>

      <!-- SESSIONS -->
      <div class="page" id="page-sessions">
        <div id="qualiopi-sessions" class="qualiopi-indicators" style="display:none"></div>
        <div class="toolbar">
          <div class="search-box"><input type="text" id="search-sessions" placeholder="Rechercher..." oninput="filterSessions()"></div>
          <div class="filters">
            <select class="filter-select" id="filter-sessions-modalite" onchange="filterSessions()">
              <option value="">Toutes modalit√©s</option>
              <option value="Inter">Inter</option>
              <option value="Intra">Intra</option>
            </select>
            <select class="filter-select" id="filter-sessions-statut" onchange="filterSessions()">
              <option value="">Tous statuts</option>
              <option value="Planifi√©e">Planifi√©e</option>
              <option value="En cours">En cours</option>
              <option value="Termin√©e">Termin√©e</option>
              <option value="Annul√©e">Annul√©e</option>
            </select>
            <button class="btn btn-primary" onclick="openModal('session')">‚ûï Session</button>
          </div>
        </div>
        <div class="card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Formation</th>
                  <th>Entreprise</th>
                  <th>Type</th>
                  <th>Modalit√©</th>
                  <th>Lieu</th>
                  <th>Dates Pr√©v.</th>
                  <th>Dates Effect.</th>
                  <th>Stagiaires</th>
                  <th>Chiffrage</th>
                  <th>Montant</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="table-sessions"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- AGENDA SESSIONS -->
      <div class="page" id="page-agenda-sessions">
        <div class="toolbar" style="flex-wrap:wrap;gap:10px">
          <div class="filters" style="display:flex;gap:10px;align-items:center">
            <button class="btn btn-secondary" onclick="agendaSessionsMoisPrec()">‚óÄ Mois pr√©c√©dent</button>
            <span id="agenda-sessions-mois" style="font-weight:600;font-size:1.1em;min-width:180px;text-align:center"></span>
            <button class="btn btn-secondary" onclick="agendaSessionsMoisSuiv()">Mois suivant ‚ñ∂</button>
          </div>
          <div class="filters" style="display:flex;gap:10px">
            <select class="filter-select" id="filter-agenda-sessions-formation" onchange="renderAgendaSessions()">
              <option value="">Toutes les formations</option>
            </select>
            <select class="filter-select" id="filter-agenda-sessions-formateur" onchange="renderAgendaSessions()">
              <option value="">Tous les formateurs</option>
            </select>
            <select class="filter-select" id="filter-agenda-sessions-statut" onchange="renderAgendaSessions()">
              <option value="">Tous les statuts</option>
              <option value="Planifi√©e">Planifi√©e</option>
              <option value="En cours">En cours</option>
              <option value="Termin√©e">Termin√©e</option>
              <option value="Annul√©e">Annul√©e</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="showPage('sessions')">‚ûï Nouvelle Session</button>
        </div>
        
        <div class="info-box" style="margin:15px 0">
          <strong>üóìÔ∏è Agenda des Sessions</strong> - Vue calendrier des sessions de formation. Cliquez sur une session pour voir les d√©tails.
        </div>
        
        <!-- L√©gende -->
        <div style="display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
            <span style="width:12px;height:12px;background:#3b82f6;border-radius:3px"></span> Planifi√©e
          </div>
          <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
            <span style="width:12px;height:12px;background:#f59e0b;border-radius:3px"></span> En cours
          </div>
          <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
            <span style="width:12px;height:12px;background:#10b981;border-radius:3px"></span> Termin√©e
          </div>
          <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
            <span style="width:12px;height:12px;background:#ef4444;border-radius:3px"></span> Annul√©e
          </div>
        </div>
        
        <!-- Calendrier -->
        <div class="card">
          <div class="agenda-calendar" id="agenda-sessions-calendar">
            <!-- G√©n√©r√© dynamiquement -->
          </div>
        </div>
      </div>

      <!-- AGENDA GENERAL -->
      <div class="page" id="page-agenda-general">
        <div class="toolbar" style="flex-wrap:wrap;gap:10px">
          <div class="filters" style="display:flex;gap:10px;align-items:center">
            <button class="btn btn-secondary" onclick="agendaGeneralMoisPrec()">‚óÄ Mois pr√©c√©dent</button>
            <span id="agenda-general-mois" style="font-weight:600;font-size:1.1em;min-width:180px;text-align:center"></span>
            <button class="btn btn-secondary" onclick="agendaGeneralMoisSuiv()">Mois suivant ‚ñ∂</button>
          </div>
          <div class="filters" style="display:flex;gap:10px">
            <select class="filter-select" id="filter-agenda-general-type" onchange="renderAgendaGeneral()">
              <option value="">Tous les types</option>
              <option value="session">üìÖ Sessions</option>
              <option value="rdv">üìç RDV</option>
              <option value="tache">‚úÖ T√¢ches</option>
              <option value="rappel">üîî Rappels</option>
            </select>
            <select class="filter-select" id="filter-agenda-general-formateur" onchange="renderAgendaGeneral()">
              <option value="">Tous les formateurs</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="openModalAgendaEvent()">‚ûï Nouvel √©v√©nement</button>
        </div>
        
        <div class="info-box" style="margin:15px 0">
          <strong>üìÜ Agenda G√©n√©ral</strong> - 
          <span id="agenda-general-role-info"></span>
        </div>
        
        <!-- L√©gende -->
        <div style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:15px">
          <div style="display:flex;gap:15px;flex-wrap:wrap;margin-bottom:10px">
            <div style="font-weight:600;font-size:0.8em;color:#374151">Types :</div>
            <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
              <span style="width:12px;height:12px;background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:3px"></span> Sessions
            </div>
            <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
              <span style="width:12px;height:12px;background:linear-gradient(135deg,#6366f1,#4f46e5);border-radius:3px;border:1px dashed #a5b4fc"></span> Disponibilit√©s
            </div>
            <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
              <span style="width:12px;height:12px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:3px"></span> RDV
            </div>
            <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
              <span style="width:12px;height:12px;background:linear-gradient(135deg,#10b981,#059669);border-radius:3px"></span> T√¢ches
            </div>
            <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
              <span style="width:12px;height:12px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:3px"></span> Rappels
            </div>
          </div>
          <div style="display:flex;gap:15px;flex-wrap:wrap">
            <div style="font-weight:600;font-size:0.8em;color:#374151">Confirmation :</div>
            <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
              <span style="width:8px;height:8px;background:#10b981;border-radius:50%;box-shadow:0 0 4px #10b981"></span> Confirm√©e
            </div>
            <div style="display:flex;align-items:center;gap:5px;font-size:0.8em">
              <span style="width:8px;height:8px;background:#ef4444;border-radius:50%;box-shadow:0 0 4px #ef4444"></span> Non confirm√©e
            </div>
          </div>
        </div>
        
        <!-- L√©gende formateurs dynamique -->
        <div id="agenda-general-formateurs-legende" style="background:#f0f9ff;padding:12px;border-radius:8px;margin-bottom:15px;display:none">
          <div style="font-weight:600;font-size:0.8em;color:#0369a1;margin-bottom:8px">üë®‚Äçüè´ Couleurs par formateur :</div>
          <div id="agenda-general-formateurs-liste" style="display:flex;gap:12px;flex-wrap:wrap"></div>
        </div>
        
        <!-- Calendrier -->
        <div class="card">
          <div class="agenda-calendar" id="agenda-general-calendar">
            <!-- G√©n√©r√© dynamiquement -->
          </div>
        </div>
      </div>

      <!-- DEVIS -->
      <div class="page" id="page-devis">
        <div id="qualiopi-devis" class="qualiopi-indicators" style="display:none"></div>
        <div class="toolbar">
          <div class="search-box"><input type="text" id="search-devis" placeholder="Rechercher..." oninput="filterDevis()"></div>
          <div class="filters" style="gap:0.5rem">
            <button class="btn btn-info" onclick="ouvrirCreerDevisDepuisSession()">üìã Cr√©er depuis Session</button>
            <button class="btn btn-primary" onclick="ouvrirNouveauDevis()">‚ûï Nouveau Devis</button>
          </div>
        </div>
        
        <!-- Zone de cr√©ation de devis -->
        <div id="zone-devis-travail" style="display:none;margin-bottom:1rem">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" id="titre-devis-travail">üìÑ Nouveau Devis</h3>
              <button class="btn btn-secondary btn-sm" onclick="fermerZoneDevis()">‚úï Fermer</button>
            </div>
            
            <!-- S√©lection Session -->
            <div style="padding:1rem;border-bottom:1px solid var(--gray-200);background:var(--blue-50)">
              <h4 style="font-size:.85rem;color:var(--blue-700);margin-bottom:.75rem">üìå Source des donn√©es</h4>
              <div class="form-row">
                <div class="form-group" style="flex:2">
                  <label class="form-label">Session (optionnel)</label>
                  <select class="form-select" id="devis-session" onchange="onDevisSelectSession()">
                    <option value="">-- Cr√©er sans session --</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Date du devis</label>
                  <input class="form-input" id="devis-date" type="date">
                </div>
                <div class="form-group">
                  <label class="form-label">N¬∞ Devis</label>
                  <input class="form-input" id="devis-numero" readonly style="background:var(--gray-100)">
                </div>
              </div>
            </div>
            
            <!-- Informations Client -->
            <div style="padding:1rem;border-bottom:1px solid var(--gray-200)">
              <h4 style="font-size:.85rem;color:var(--primary);margin-bottom:.75rem">üë§ Client</h4>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Entreprise *</label><input class="form-input" id="devis-entreprise" required></div>
                <div class="form-group"><label class="form-label">SIRET</label><input class="form-input" id="devis-siret" maxlength="14"></div>
              </div>
              <div class="form-group"><label class="form-label">Adresse</label><input class="form-input" id="devis-adresse"></div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Code Postal</label><input class="form-input" id="devis-cp" maxlength="5"></div>
                <div class="form-group"><label class="form-label">Ville</label><input class="form-input" id="devis-ville"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Contact</label><input class="form-input" id="devis-contact"></div>
                <div class="form-group"><label class="form-label">T√©l√©phone</label><input class="form-input" id="devis-tel"></div>
                <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="devis-email" type="email"></div>
              </div>
            </div>
            
            <!-- D√©tails Formation -->
            <div style="padding:1rem;border-bottom:1px solid var(--gray-200)">
              <h4 style="font-size:.85rem;color:var(--orange-600);margin-bottom:.75rem">üìö Formation</h4>
              <div class="form-group"><label class="form-label">Intitul√© de la formation *</label><input class="form-input" id="devis-formation" required></div>
              <div class="form-group"><label class="form-label">Lieu</label><input class="form-input" id="devis-lieu" placeholder="Adresse compl√®te du lieu de formation"></div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Date d√©but</label><input class="form-input" id="devis-dateDebut" type="date"></div>
                <div class="form-group"><label class="form-label">Date fin</label><input class="form-input" id="devis-dateFin" type="date"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Horaires matin</label><input class="form-input" id="devis-horairesMatin" placeholder="9:00 √† 12:30"></div>
                <div class="form-group"><label class="form-label">Horaires apr√®s-midi</label><input class="form-input" id="devis-horairesAprem" placeholder="13:30 √† 17:00"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Dur√©e (heures)</label><input class="form-input" id="devis-duree" type="number" min="0"></div>
                <div class="form-group"><label class="form-label">Modalit√©</label><select class="form-select" id="devis-modalite"><option>INTRA</option><option>INTER</option></select></div>
              </div>
            </div>
            
            <!-- Tarification -->
            <div style="padding:1rem;border-bottom:1px solid var(--gray-200);background:var(--green-50)">
              <h4 style="font-size:.85rem;color:var(--green-700);margin-bottom:.75rem">üí∞ Tarification</h4>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Nb Stagiaires</label><input class="form-input" id="devis-nbStagiaires" type="number" min="1" value="1" onchange="calculerMontantDevis()"></div>
                <div class="form-group"><label class="form-label">Tarif horaire (‚Ç¨)</label><input class="form-input" id="devis-tarifHoraire" type="number" step="0.01" min="0" onchange="calculerMontantDevis()"></div>
                <div class="form-group"><label class="form-label">Nb Heures</label><input class="form-input" id="devis-nbHeures" type="number" min="0" onchange="calculerMontantDevis()"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Montant HT (‚Ç¨)</label><input class="form-input" id="devis-montantHT" type="number" step="0.01" min="0" onchange="calculerTTCDevis()"></div>
                <div class="form-group"><label class="form-label">TVA (%)</label><input class="form-input" id="devis-tva" type="number" value="20" onchange="calculerTTCDevis()"></div>
                <div class="form-group"><label class="form-label">Montant TTC (‚Ç¨)</label><input class="form-input" id="devis-montantTTC" type="number" step="0.01" readonly style="background:var(--gray-100);font-weight:bold"></div>
              </div>
              <div style="font-size:.75rem;color:var(--gray-600);margin-top:.5rem" id="devis-formule-calcul"></div>
            </div>
            
            <!-- Options -->
            <div style="padding:1rem;border-bottom:1px solid var(--gray-200)">
              <h4 style="font-size:.85rem;color:var(--gray-600);margin-bottom:.75rem">‚öôÔ∏è Options</h4>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Mode de r√®glement</label><select class="form-select" id="devis-reglement"><option>Ch√®que | Ech: Comptant</option><option>Virement | Ech: 30 jours</option><option>Pr√©l√®vement | Ech: Comptant</option><option>OPCO | Ech: Subrogation</option></select></div>
                <div class="form-group"><label class="form-label">Conseiller</label><select class="form-select" id="devis-conseiller"><option value="">S√©lectionner...</option></select></div>
                <div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="devis-statut"><option>Brouillon</option><option>Envoy√©</option><option>Valid√©</option><option>Refus√©</option></select></div>
              </div>
              <div class="form-group"><label class="form-label">Observations</label><textarea class="form-textarea" id="devis-observations" rows="2" placeholder="Aucune observation"></textarea></div>
              <div class="form-group"><label class="form-label"><input type="checkbox" id="devis-mandat"> Inclure le mandat OPCO/FAF</label></div>
            </div>
            
            <!-- Zone Devis Sign√© -->
            <div style="padding:0 1rem;margin-bottom:1rem">
              <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:1rem">
                <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
                  <div style="flex:1">
                    <label style="font-weight:bold;color:#166534;display:block;margin-bottom:5px">üìé Devis sign√© par le client</label>
                    <div id="devis-signe-info" style="font-size:0.9em;color:#666">Aucun fichier t√©l√©vers√©</div>
                  </div>
                  <div style="display:flex;gap:0.5rem">
                    <input type="file" id="devis-signe-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="onDevisSigneSelect(event)">
                    <button class="btn btn-success" onclick="document.getElementById('devis-signe-input').click()">üì§ T√©l√©verser devis sign√©</button>
                    <button class="btn btn-info" id="btn-voir-devis-signe" style="display:none" onclick="voirDevisSigne()">üëÅÔ∏è Voir</button>
                    <button class="btn btn-danger btn-sm" id="btn-suppr-devis-signe" style="display:none" onclick="supprimerDevisSigne()">üóëÔ∏è</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Actions -->
            <div style="padding:1rem;display:flex;gap:.5rem;flex-wrap:wrap">
              <button class="btn btn-success" onclick="enregistrerDevis()">üíæ Enregistrer</button>
              <button class="btn btn-primary" onclick="genererPDFDevis()">üìÑ G√©n√©rer PDF</button>
              <button class="btn btn-info" onclick="envoyerDevisParEmail()">üìß Envoyer par email</button>
            </div>
          </div>
        </div>
        
        <!-- Tableau des devis -->
        <div class="card">
          <div class="card-header"><h3 class="card-title">üìÑ Liste des devis</h3></div>
          <div class="table-container">
            <table style="min-width:1200px">
              <thead>
                <tr>
                  <th>N¬∞ Devis</th>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Formation</th>
                  <th>Montant HT</th>
                  <th>TTC</th>
                  <th>Statut</th>
                  <th>Sign√©</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="table-devis"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CONVENTIONS -->
      <div class="page" id="page-conventions">
        <div id="qualiopi-conventions" class="qualiopi-indicators" style="display:none"></div>
        <div class="toolbar">
          <div class="search-box"><input type="text" id="search-conventions" placeholder="Rechercher..." oninput="filterConventions()"></div>
          <div class="toolbar-actions">
            <button class="btn btn-info" onclick="ouvrirCreerConventionDepuisDevis()">üìã Cr√©er depuis Devis</button>
            <button class="btn btn-primary" onclick="ouvrirNouvelleConvention()">‚ûï Nouvelle Convention</button>
          </div>
        </div>
        
        <!-- Zone de travail Convention -->
        <div id="zone-convention-travail" style="display:none;margin-bottom:20px">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" id="titre-convention-travail">üìë Nouvelle Convention</h3>
              <button class="btn btn-secondary btn-sm" onclick="fermerZoneConvention()">‚úï Fermer</button>
            </div>
            <div class="form-grid">
              <!-- Ligne 1: Num√©ro, Date, Devis source -->
              <div class="form-group">
                <label>N¬∞ Convention</label>
                <input type="text" class="form-input" id="conv-numero" placeholder="DC-25-XXXX">
              </div>
              <div class="form-group">
                <label>Date</label>
                <input type="date" class="form-input" id="conv-date">
              </div>
              <div class="form-group">
                <label>Depuis Devis</label>
                <select class="form-select" id="conv-devis" onchange="onConvSelectDevis()">
                  <option value="">-- S√©lectionner un devis --</option>
                </select>
              </div>
              
              <!-- Ligne 2: Client -->
              <div class="form-group">
                <label>Entreprise Cliente</label>
                <select class="form-select" id="conv-entreprise-select" onchange="onConvEntrepriseChange()">
                  <option value="">-- S√©lectionner --</option>
                </select>
                <input type="text" class="form-input" id="conv-entreprise" style="margin-top:5px" placeholder="Ou saisir manuellement">
              </div>
              <div class="form-group">
                <label>Adresse</label>
                <input type="text" class="form-input" id="conv-adresse">
              </div>
              <div class="form-group">
                <label>CP / Ville</label>
                <div style="display:flex;gap:10px">
                  <input type="text" class="form-input" id="conv-cp" style="width:80px">
                  <input type="text" class="form-input" id="conv-ville" style="flex:1">
                </div>
              </div>
              
              <!-- Ligne 3: SIRET, Repr√©sentant -->
              <div class="form-group">
                <label>SIRET</label>
                <input type="text" class="form-input" id="conv-siret">
              </div>
              <div class="form-group">
                <label>Repr√©sentant l√©gal</label>
                <input type="text" class="form-input" id="conv-representant">
              </div>
              <div class="form-group">
                <label>Fonction</label>
                <input type="text" class="form-input" id="conv-fonction" value="G√©rant">
              </div>
              
              <!-- Ligne 4: Formation -->
              <div class="form-group" style="grid-column:span 3">
                <label>Intitul√© de la formation</label>
                <input type="text" class="form-input" id="conv-formation">
              </div>
              
              <!-- Ligne 5: Nature, Type, Dur√©e -->
              <div class="form-group">
                <label>Nature de l'action</label>
                <select class="form-select" id="conv-nature">
                  <option>INTRA pr√©sentiel</option>
                  <option>INTER pr√©sentiel</option>
                  <option>INTRA distanciel</option>
                  <option>INTER distanciel</option>
                  <option>Mixte</option>
                </select>
              </div>
              <div class="form-group">
                <label>Type d'action</label>
                <input type="text" class="form-input" id="conv-type" value="Action de formation">
              </div>
              <div class="form-group">
                <label>Dur√©e (heures)</label>
                <input type="number" class="form-input" id="conv-duree">
              </div>
              
              <!-- Ligne 6: Lieu -->
              <div class="form-group" style="grid-column:span 3">
                <label>Lieu de formation</label>
                <input type="text" class="form-input" id="conv-lieu">
              </div>
              
              <!-- Ligne 7: Dates et horaires -->
              <div class="form-group">
                <label>Date d√©but</label>
                <input type="date" class="form-input" id="conv-dateDebut">
              </div>
              <div class="form-group">
                <label>Date fin</label>
                <input type="date" class="form-input" id="conv-dateFin">
              </div>
              <div class="form-group">
                <label>Horaires</label>
                <div style="display:flex;gap:5px;align-items:center">
                  <input type="text" class="form-input" id="conv-horairesMatin" style="width:100px" value="9:00 √† 12:30">
                  <span>et</span>
                  <input type="text" class="form-input" id="conv-horairesAprem" style="width:100px" value="13:30 √† 17:00">
                </div>
              </div>
              
              <!-- Ligne 8: Stagiaires -->
              <div class="form-group" style="grid-column:span 3">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                  <label style="margin:0">üë• Stagiaires de la formation</label>
                  <div style="display:flex;gap:5px">
                    <button type="button" class="btn btn-sm btn-info" onclick="chargerStagiairesEntrepriseConv()">üîÑ Charger stagiaires</button>
                    <button type="button" class="btn btn-sm btn-success" onclick="ouvrirAjoutStagiaireConv()">‚ûï Ajouter</button>
                  </div>
                </div>
                <div id="conv-stagiaires-liste" style="border:1px solid #ddd;border-radius:8px;max-height:200px;overflow-y:auto;background:#f9fafb">
                  <div style="padding:20px;text-align:center;color:#999">
                    <p>S√©lectionnez une entreprise puis cliquez sur "üîÑ Charger stagiaires"</p>
                    <p style="font-size:0.85em">ou ajoutez des stagiaires manuellement</p>
                  </div>
                </div>
                <div style="margin-top:5px;font-size:0.85em;color:#666">
                  <span id="conv-stagiaires-count">0 stagiaire(s) s√©lectionn√©(s)</span>
                </div>
                <!-- Champ cach√© pour stocker les IDs des stagiaires s√©lectionn√©s -->
                <input type="hidden" id="conv-stagiaires-ids" value="">
              </div>
              
              <!-- Modal ajout stagiaire rapide -->
              <div id="modal-ajout-stagiaire-conv" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center">
                <div style="background:#fff;padding:20px;border-radius:10px;width:400px;max-width:90%">
                  <h3 style="margin-bottom:15px">‚ûï Ajouter un stagiaire</h3>
                  <div style="display:grid;gap:10px">
                    <div>
                      <label>Civilit√©</label>
                      <select class="form-select" id="new-stag-civilite">
                        <option>Mr.</option>
                        <option>Mme</option>
                      </select>
                    </div>
                    <div>
                      <label>Nom</label>
                      <input type="text" class="form-input" id="new-stag-nom">
                    </div>
                    <div>
                      <label>Pr√©nom</label>
                      <input type="text" class="form-input" id="new-stag-prenom">
                    </div>
                    <div>
                      <label>Fonction</label>
                      <input type="text" class="form-input" id="new-stag-fonction" value="Employ√©">
                    </div>
                  </div>
                  <div style="display:flex;gap:10px;margin-top:15px;justify-content:flex-end">
                    <button class="btn btn-secondary" onclick="fermerModalStagiaireConv()">Annuler</button>
                    <button class="btn btn-success" onclick="ajouterStagiaireConv()">‚úì Ajouter</button>
                  </div>
                </div>
              </div>
              
              <!-- Ligne 9: Montants -->
              <div class="form-group">
                <label>Prix unitaire HT</label>
                <input type="number" class="form-input" id="conv-prixHT" step="0.01">
              </div>
              <div class="form-group">
                <label>TVA (%)</label>
                <input type="number" class="form-input" id="conv-tva" value="20">
              </div>
              <div class="form-group">
                <label>Quantit√©</label>
                <input type="number" class="form-input" id="conv-quantite" value="1">
              </div>
              
              <!-- Ligne 10: Lieu signature -->
              <div class="form-group">
                <label>Lieu de signature</label>
                <input type="text" class="form-input" id="conv-lieuSignature" value="Le Kremlin Bic√™tre">
              </div>
              <div class="form-group">
                <label>Statut</label>
                <select class="form-select" id="conv-statut">
                  <option>Brouillon</option>
                  <option>Envoy√©e</option>
                  <option>Sign√©e</option>
                  <option>Annul√©e</option>
                </select>
              </div>
              <div class="form-group"></div>
            </div>
            
            <div class="form-actions" style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn btn-success" onclick="sauvegarderConvention()">üíæ Enregistrer</button>
              <button class="btn btn-primary" onclick="genererPDFConvention()">üìÑ G√©n√©rer PDF</button>
              <button class="btn btn-secondary" onclick="fermerZoneConvention()">Annuler</button>
            </div>
          </div>
        </div>
        
        <!-- Liste des conventions -->
        <div class="card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>N¬∞ Convention</th>
                  <th>Date</th>
                  <th>Entreprise</th>
                  <th>Formation</th>
                  <th>Dates</th>
                  <th>Montant TTC</th>
                  <th>Statut</th>
                  <th>Sign√©</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="table-conventions"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- SUIVI WORKFLOW -->
      <div class="page" id="page-suivi-workflow">
        <!-- Barre de filtres -->
        <div class="toolbar" style="flex-wrap:wrap;gap:10px;margin-bottom:15px">
          <div class="search-box"><input type="text" id="search-suivi" placeholder="Rechercher..." oninput="filterSuiviWorkflow()"></div>
          <div class="filters" style="display:flex;gap:10px;flex-wrap:wrap">
            <select class="filter-select" id="filter-suivi-entreprise" onchange="filterSuiviWorkflow()">
              <option value="">üè¢ Toutes les entreprises</option>
            </select>
            <select class="filter-select" id="filter-suivi-demande" onchange="filterSuiviWorkflow()">
              <option value="">üì• Toutes les demandes</option>
            </select>
            <select class="filter-select" id="filter-suivi-opportunite" onchange="filterSuiviWorkflow()">
              <option value="">üéØ Toutes les opportunit√©s</option>
            </select>
            <select class="filter-select" id="filter-suivi-session" onchange="filterSuiviWorkflow()">
              <option value="">üìÖ Toutes les sessions</option>
            </select>
          </div>
        </div>
        
        <!-- WORKFLOW HORIZONTAL EN FLECHES -->
        <div class="card" style="padding:25px;margin-bottom:20px">
          <h3 style="margin:0 0 20px 0;color:#1e293b;text-align:center;font-size:1.1em">üìä Workflow de Formation</h3>
          
          <div class="workflow-horizontal">
            <div class="wf-step" data-etape="Demande" onclick="filtrerParEtape('Demande')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#3b82f6,#2563eb)">
                <span class="wf-count" id="wf-count-demande">0</span>
              </div>
              <div class="wf-label">Demandes</div>
              <div class="wf-desc">R√©ception demandes</div>
            </div>
            
            <div class="wf-step" data-etape="Analyse" onclick="filtrerParEtape('Analyse')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">
                <span class="wf-count" id="wf-count-analyse">0</span>
              </div>
              <div class="wf-label">Analyses</div>
              <div class="wf-desc">Analyse des besoins</div>
            </div>
            
            <div class="wf-step" data-etape="Evaluation" onclick="filtrerParEtape('Evaluation')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#ec4899,#db2777)">
                <span class="wf-count" id="wf-count-evaluation">0</span>
              </div>
              <div class="wf-label">√âvaluations</div>
              <div class="wf-desc">√âvaluation stagiaires</div>
            </div>
            
            <div class="wf-step" data-etape="Devis" onclick="filtrerParEtape('Devis')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#f59e0b,#d97706)">
                <span class="wf-count" id="wf-count-devis">0</span>
              </div>
              <div class="wf-label">Devis</div>
              <div class="wf-desc">Cr√©ation devis</div>
            </div>
            
            <div class="wf-step" data-etape="Convention" onclick="filtrerParEtape('Convention')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#10b981,#059669)">
                <span class="wf-count" id="wf-count-convention">0</span>
              </div>
              <div class="wf-label">Conventions</div>
              <div class="wf-desc">Signature convention</div>
            </div>
            
            <div class="wf-step" data-etape="PriseEnCharge" onclick="filtrerParEtape('PriseEnCharge')">
              <div class="wf-arrow" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">
                <span class="wf-count" id="wf-count-pec">0</span>
              </div>
              <div class="wf-label">Prises en charge</div>
              <div class="wf-desc">Demandes OPCO</div>
            </div>
            
            <div class="wf-step" data-etape="Termine" onclick="filtrerParEtape('Termine')">
              <div class="wf-arrow wf-arrow-last" style="background:linear-gradient(135deg,#22c55e,#16a34a)">
                <span class="wf-count" id="wf-count-termine">0</span>
              </div>
              <div class="wf-label">Termin√©es</div>
              <div class="wf-desc">Formations r√©alis√©es</div>
            </div>
          </div>
          
          <div style="text-align:center;margin-top:15px">
            <button class="btn btn-secondary btn-sm" onclick="filtrerParEtape('')">üîÑ Voir tout</button>
          </div>
        </div>
        
        <!-- Filtre actif -->
        <div id="filtre-etape-actif" style="display:none;margin-bottom:15px;padding:10px 15px;background:#e0f2fe;border-radius:8px;color:#0369a1;display:flex;align-items:center;justify-content:space-between">
          <span id="filtre-etape-label"></span>
          <button class="btn btn-sm" onclick="filtrerParEtape('')" style="background:none;color:#0369a1">‚úï Effacer le filtre</button>
        </div>
        
        <div class="card">
          <div id="suivi-workflow-liste" style="display:flex;flex-direction:column;gap:20px;padding:20px">
            <!-- Les workflows seront g√©n√©r√©s ici -->
          </div>
        </div>
      </div>

      <!-- TABLEAU DE CONTR√îLE -->
      <div class="page" id="page-suivi-controle">
        <div class="toolbar" style="flex-wrap:wrap;gap:10px;margin-bottom:15px">
          <div class="search-box"><input type="text" id="search-controle" placeholder="Rechercher une opportunit√©..." oninput="filterTableauControle()"></div>
          <div class="filters" style="display:flex;gap:10px;flex-wrap:wrap">
            <select class="filter-select" id="filter-controle-entreprise" onchange="filterTableauControle()">
              <option value="">üè¢ Toutes les entreprises</option>
            </select>
            <select class="filter-select" id="filter-controle-statut" onchange="filterTableauControle()">
              <option value="">Tous les statuts</option>
              <option value="complet">‚úÖ Dossier complet</option>
              <option value="en-cours">üîÑ En cours</option>
              <option value="incomplet">‚ö†Ô∏è Incomplet</option>
            </select>
            <button class="btn btn-info" onclick="exporterTableauControle()">üì• Exporter CSV</button>
          </div>
        </div>
        
        <div class="info-box" style="margin-bottom:15px">
          <strong>üìã Tableau de Contr√¥le</strong> - Vue d'ensemble du processus de formation pour chaque opportunit√©.
        </div>
        
        <!-- L√©gende -->
        <div style="display:flex;gap:25px;margin-bottom:15px;padding:15px 20px;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-radius:10px;flex-wrap:wrap;align-items:center;border:1px solid #e2e8f0">
          <strong style="color:#1e293b;font-size:0.95em">L√©gende :</strong>
          <span style="display:flex;align-items:center;gap:8px;font-size:0.9em">
            <span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;background:#dcfce7;border-radius:6px;font-size:1.1em">‚úÖ</span> 
            <span style="color:#15803d;font-weight:500">Fait</span>
          </span>
          <span style="display:flex;align-items:center;gap:8px;font-size:0.9em">
            <span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;background:#fef3c7;border-radius:6px;font-size:1.1em">‚è≥</span> 
            <span style="color:#b45309;font-weight:500">En attente</span>
          </span>
          <span style="display:flex;align-items:center;gap:8px;font-size:0.9em">
            <span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;background:#dbeafe;border-radius:6px;font-size:1.1em">üì§</span> 
            <span style="color:#1d4ed8;font-weight:500">Sign√© & Upload√©</span>
          </span>
          <span style="display:flex;align-items:center;gap:8px;font-size:0.9em">
            <span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;background:#f1f5f9;border-radius:6px;font-size:1.1em;color:#94a3b8">‚Äî</span> 
            <span style="color:#64748b;font-weight:500">Non applicable</span>
          </span>
        </div>
        
        <div class="card" style="overflow:hidden;border-radius:12px">
          <div class="table-container" style="max-height:calc(100vh - 420px);overflow:auto">
            <table id="table-controle" style="width:100%;border-collapse:separate;border-spacing:0">
              <thead>
                <tr>
                  <th class="ctrl-th-fixed" style="left:0;min-width:50px;background:#1e3a5f">ID</th>
                  <th class="ctrl-th-fixed" style="left:50px;min-width:180px;background:#1e3a5f;text-align:left">Entreprise</th>
                  <th class="ctrl-th" style="min-width:150px;background:#1e3a5f;text-align:left">Formation</th>
                  <th class="ctrl-th" style="min-width:100px;background:#1e3a5f">Statut</th>
                  <th class="ctrl-th" style="background:#2563eb">üì© Demande</th>
                  <th class="ctrl-th" style="background:#7c3aed">üìã Analyse</th>
                  <th class="ctrl-th" style="background:#db2777">üìù √âvaluation</th>
                  <th class="ctrl-th" style="background:#ea580c">üí∞ Devis</th>
                  <th class="ctrl-th" style="background:#059669">üìë Convention</th>
                  <th class="ctrl-th" style="background:#0891b2">üìÑ PEC OPCO</th>
                  <th class="ctrl-th" style="background:#4f46e5">üìÖ Session</th>
                  <th class="ctrl-th" style="background:#16a34a">‚úÖ Documents</th>
                  <th class="ctrl-th" style="min-width:120px;background:#1e3a5f">Compl√©tion</th>
                </tr>
              </thead>
              <tbody id="tbody-controle">
                <!-- G√©n√©r√© dynamiquement -->
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Statistiques globales -->
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:15px;margin-top:20px">
          <div class="kpi-card green" style="padding:15px">
            <div class="kpi-label">Dossiers complets</div>
            <div class="kpi-value" id="ctrl-complets">0</div>
          </div>
          <div class="kpi-card yellow" style="padding:15px">
            <div class="kpi-label">En cours</div>
            <div class="kpi-value" id="ctrl-encours">0</div>
          </div>
          <div class="kpi-card red" style="padding:15px">
            <div class="kpi-label">Incomplets</div>
            <div class="kpi-value" id="ctrl-incomplets">0</div>
          </div>
          <div class="kpi-card blue" style="padding:15px">
            <div class="kpi-label">Docs sign√©s upload√©s</div>
            <div class="kpi-value" id="ctrl-uploades">0</div>
          </div>
          <div class="kpi-card purple" style="padding:15px">
            <div class="kpi-label">Taux compl√©tion moyen</div>
            <div class="kpi-value" id="ctrl-taux">0%</div>
          </div>
        </div>
      </div>

      <!-- MESSAGERIE INTERNE -->
      <div class="page" id="page-messagerie">
        <div class="toolbar" style="flex-wrap:wrap;gap:10px">
          <div class="filters" style="display:flex;gap:10px;flex:1">
            <select class="filter-select" id="filter-msg-type" onchange="filterMessages()">
              <option value="">Tous les messages</option>
              <option value="recu">üì• Re√ßus</option>
              <option value="envoye">üì§ Envoy√©s</option>
              <option value="nonlu">üî¥ Non lus</option>
            </select>
            <select class="filter-select" id="filter-msg-dest" onchange="filterMessages()">
              <option value="">Tous les destinataires</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="ouvrirNouveauMessage()">‚úâÔ∏è Nouveau Message</button>
        </div>
        
        <div style="display:grid;grid-template-columns:350px 1fr;gap:20px;height:calc(100vh - 200px)">
          <!-- Liste des conversations -->
          <div class="card" style="overflow:hidden;display:flex;flex-direction:column">
            <div style="padding:15px;border-bottom:1px solid #e5e7eb;font-weight:600;color:#374151">
              üí¨ Conversations
            </div>
            <div id="msg-conversations-liste" style="flex:1;overflow-y:auto">
              <!-- Les conversations seront g√©n√©r√©es ici -->
            </div>
          </div>
          
          <!-- Zone de lecture/√©criture -->
          <div class="card" style="overflow:hidden;display:flex;flex-direction:column">
            <div id="msg-header" style="padding:15px;border-bottom:1px solid #e5e7eb;background:#f8fafc">
              <span style="color:#64748b">S√©lectionnez une conversation</span>
            </div>
            <div id="msg-contenu" style="flex:1;overflow-y:auto;padding:20px;background:#f8fafc">
              <div style="text-align:center;padding:40px;color:#94a3b8">
                <div style="font-size:3rem;margin-bottom:15px">üí¨</div>
                <p>S√©lectionnez une conversation ou cr√©ez un nouveau message</p>
              </div>
            </div>
            <div id="msg-reponse" style="padding:15px;border-top:1px solid #e5e7eb;display:none">
              <div style="display:flex;gap:10px">
                <textarea id="msg-reponse-texte" class="form-textarea" rows="2" style="flex:1;resize:none" placeholder="Votre r√©ponse..."></textarea>
                <button class="btn btn-primary" onclick="envoyerReponseMessage()" style="align-self:flex-end">üì§ Envoyer</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- DEMANDE DE PRISE EN CHARGE -->
      <div class="page" id="page-dpc">
        <div id="qualiopi-dpc" class="qualiopi-indicators" style="display:none"></div>
        <div class="toolbar" style="flex-wrap:wrap;gap:10px">
          <div class="search-box"><input type="text" id="search-dpc" placeholder="Rechercher..." oninput="filterDPC()"></div>
          <div class="filters" style="display:flex;gap:10px;flex-wrap:wrap">
            <select class="filter-select" id="filter-dpc-entreprise" onchange="filterDPC()">
              <option value="">üè¢ Toutes les entreprises</option>
            </select>
            <select class="filter-select" id="filter-dpc-opco" onchange="filterDPC()">
              <option value="">Tous les OPCO</option>
            </select>
            <select class="filter-select" id="filter-dpc-statut" onchange="filterDPC()">
              <option value="">Tous les statuts</option>
              <option value="Transmis">üì§ Transmis</option>
              <option value="Accord√©">‚úÖ Accord√©</option>
              <option value="Demande d'information">‚ùì Demande d'info</option>
              <option value="Refus√©">‚ùå Refus√©</option>
              <option value="Annul√©">üö´ Annul√©</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="openModal('dpc')">‚ûï Nouvelle Prise en Charge</button>
        </div>
        
        <div class="card" style="margin-top:15px">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>N¬∞ PEC</th>
                  <th>ID Ent.</th>
                  <th>Entreprise</th>
                  <th>OPCO</th>
                  <th>Demand√©</th>
                  <th>Accord√©</th>
                  <th>D√©p√¥t</th>
                  <th>R√©sultat</th>
                  <th>Statut</th>
                  <th>Docs Post</th>
                  <th>Encaissement</th>
                  <th>Courrier</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="table-dpc"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CONCEPTION -->
      <div class="page" id="page-conception">
        <div id="qualiopi-conception" class="qualiopi-indicators" style="display:none"></div>
        <div class="toolbar" style="flex-wrap:wrap;gap:10px">
          <div class="search-box"><input type="text" id="search-conception" placeholder="Rechercher..." oninput="filterConception()"></div>
          <select class="filter-select" id="filter-conception-statut" onchange="filterConception()">
            <option value="">Tous les statuts</option>
            <option value="En attente v√©rification">‚è≥ En attente v√©rification</option>
            <option value="Dates √† modifier">‚ö†Ô∏è Dates √† modifier</option>
            <option value="Pr√™t pour g√©n√©ration">‚úÖ Pr√™t pour g√©n√©ration</option>
            <option value="Documents g√©n√©r√©s">üìÑ Documents g√©n√©r√©s</option>
            <option value="Termin√©">‚úîÔ∏è Termin√©</option>
          </select>
          <button class="btn btn-info" onclick="ouvrirGestionModelesGED()">üìÅ G√©rer les mod√®les</button>
        </div>
        
        <div class="info-box" style="margin:15px 0">
          <strong>‚úèÔ∏è Conception p√©dagogique</strong> - V√©rification des dates OPCO et g√©n√©ration des documents de formation
        </div>
        
        <!-- Liste des PEC accord√©es -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white">
            <h3 class="card-title">üìã Prises en charge accord√©es - Pr√©paration des documents</h3>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>PEC</th>
                  <th>Entreprise</th>
                  <th>Formation</th>
                  <th>Session</th>
                  <th>Dates pr√©vues</th>
                  <th>Date limite OPCO</th>
                  <th>V√©rification</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="table-conception-pec"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Zone de travail conception (visible apr√®s s√©lection) -->
        <div id="conception-workspace" style="display:none">
          <!-- R√©sum√© de la PEC s√©lectionn√©e -->
          <div class="card" style="margin-bottom:20px;border:2px solid #3b82f6">
            <div class="card-header" style="background:#eff6ff">
              <h3 class="card-title" style="color:#1d4ed8" id="conception-titre">üìã Pr√©paration - </h3>
            </div>
            <div style="padding:15px">
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;font-size:0.9em" id="conception-resume"></div>
            </div>
          </div>
          
          <!-- √âtape 1: V√©rification des dates -->
          <div class="card" style="margin-bottom:20px" id="conception-etape1">
            <div class="card-header" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white">
              <h3 class="card-title">üìÖ √âtape 1 : V√©rification des dates</h3>
            </div>
            <div style="padding:20px" id="conception-verif-dates"></div>
          </div>
          
          <!-- √âtape 2: G√©n√©ration des documents (visible si dates OK) -->
          <div class="card" style="margin-bottom:20px;display:none" id="conception-etape2">
            <div class="card-header" style="background:linear-gradient(135deg,#10b981,#059669);color:white">
              <h3 class="card-title">üìÑ √âtape 2 : G√©n√©ration des documents</h3>
            </div>
            <div style="padding:20px">
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px">
                <!-- Documents Formateur -->
                <div style="background:#f5f3ff;border-radius:12px;padding:15px;border:1px solid #c4b5fd">
                  <h4 style="color:#7c3aed;margin:0 0 15px 0;display:flex;align-items:center;gap:8px">
                    üë®‚Äçüè´ Documents Formateur
                    <span id="conception-formateur-type" style="font-size:0.7em;background:#7c3aed;color:white;padding:2px 8px;border-radius:4px"></span>
                  </h4>
                  <div id="conception-docs-formateur"></div>
                </div>
                
                <!-- Documents Stagiaires -->
                <div style="background:#ecfdf5;border-radius:12px;padding:15px;border:1px solid #86efac">
                  <h4 style="color:#059669;margin:0 0 15px 0">üë• Documents Stagiaires <span id="conception-nb-stagiaires" style="font-size:0.8em;color:#6b7280"></span></h4>
                  <div id="conception-docs-stagiaires"></div>
                </div>
                
                <!-- Documents Session -->
                <div style="background:#fef3c7;border-radius:12px;padding:15px;border:1px solid #fcd34d">
                  <h4 style="color:#b45309;margin:0 0 15px 0">üìã Documents Session</h4>
                  <div id="conception-docs-session"></div>
                </div>
              </div>
              
              <!-- R√©capitulatif des documents g√©n√©r√©s -->
              <div id="recap-docs-generes" style="display:none;margin-top:20px;padding:15px;background:#ecfdf5;border:1px solid #10b981;border-radius:8px">
                <h4 style="margin:0 0 10px 0;color:#059669">üìÅ Documents g√©n√©r√©s</h4>
                <div id="liste-docs-generes" style="display:flex;flex-wrap:wrap;gap:8px"></div>
              </div>
              
              <!-- Boutons d'action group√©s -->
              <div style="margin-top:20px;padding:15px;background:#f1f5f9;border-radius:8px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
                <button class="btn btn-primary" onclick="genererTousDocumentsConception()" style="padding:12px 24px">
                  üöÄ G√©n√©rer tous les documents
                </button>
                <button class="btn btn-success" onclick="envoyerConvocationsConception()">
                  üìß Envoyer les convocations par email
                </button>
                <button class="btn btn-info" onclick="telechargerArchiveConception()">
                  üì¶ T√©l√©charger tous les documents
                </button>
                <button class="btn btn-secondary" onclick="afficherRecapDocuments()">
                  üìã Voir le r√©capitulatif
                </button>
              </div>
            </div>
          </div>
          
          <!-- Workflow Option 1: Dates √† modifier -->
          <div class="card" style="margin-bottom:20px;display:none;border:2px solid #ef4444" id="conception-option1">
            <div class="card-header" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white">
              <h3 class="card-title">‚ö†Ô∏è Option 1 : Les dates d√©passent l'accord OPCO</h3>
            </div>
            <div style="padding:20px">
              <div class="warning-box" style="margin-bottom:20px">
                <strong>‚ö†Ô∏è Action requise :</strong> Les dates pr√©visionnelles de la session d√©passent la date limite de l'accord OPCO.
                Vous devez modifier les dates et obtenir l'accord du donneur d'ordre.
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
                <div>
                  <h4 style="margin:0 0 15px 0;color:#dc2626">üìÖ √âtapes √† suivre :</h4>
                  <ol style="margin:0;padding-left:20px;line-height:2">
                    <li>Modifier les dates dans l'onglet Sessions</li>
                    <li>Envoyer un email au donneur d'ordre pour accord</li>
                    <li>R√©g√©n√©rer la convention avec les nouvelles dates</li>
                    <li>Renvoyer la convention √† l'OPCO pour approbation</li>
                    <li>√Ä r√©ception de l'approbation, revenir ici</li>
                  </ol>
                </div>
                <div>
                  <h4 style="margin:0 0 15px 0;color:#dc2626">üîß Actions rapides :</h4>
                  <div style="display:flex;flex-direction:column;gap:10px">
                    <button class="btn btn-warning" onclick="ouvrirModificationDatesSession()">
                      üìÖ Modifier les dates de la session
                    </button>
                    <button class="btn btn-info" onclick="envoyerMailAccordNouvelleDates()">
                      üìß Envoyer email au donneur d'ordre
                    </button>
                    <button class="btn btn-secondary" onclick="regenererConventionConception()">
                      üìÑ R√©g√©n√©rer la convention
                    </button>
                    <button class="btn btn-success" onclick="marquerApprobationRecue()">
                      ‚úÖ J'ai re√ßu l'approbation OPCO
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- POST FORMATION -->
      <div class="page" id="page-post-formation">
        <div class="info-box" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:white;margin-bottom:20px">
          <strong>üìã Post Formation</strong> - Gestion des documents de fin de formation, g√©n√©ration des PV, attestations et certificats de r√©alisation
        </div>
        
        <!-- S√©lection de session -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header" style="background:linear-gradient(135deg,#4f46e5,#6366f1)">
            <h3 class="card-title" style="color:white">üéØ S√©lection de la Session</h3>
          </div>
          <div class="card-body">
            <div class="form-row" style="gap:15px;align-items:flex-end">
              <div class="form-group" style="flex:2;margin:0">
                <label class="form-label">Session de formation</label>
                <select class="form-select" id="post-formation-session" onchange="chargerPostFormation()">
                  <option value="">-- S√©lectionner une session --</option>
                </select>
              </div>
              <div class="form-group" style="flex:1;margin:0">
                <label class="form-label">Donneur d'ordre</label>
                <input type="text" class="form-input" id="post-formation-donneur" readonly style="background:#f1f5f9">
              </div>
              <button class="btn btn-primary" onclick="chargerPostFormation()">üîÑ Actualiser</button>
            </div>
          </div>
        </div>
        
        <!-- KPIs Post Formation -->
        <div class="kpi-grid" id="post-formation-kpis" style="margin-bottom:20px">
          <div class="kpi-card purple"><div class="kpi-label">üìÑ Documents upload√©s</div><div class="kpi-value" id="kpi-pf-docs">0</div></div>
          <div class="kpi-card blue"><div class="kpi-label">üë• Stagiaires</div><div class="kpi-value" id="kpi-pf-stagiaires">0</div></div>
          <div class="kpi-card green"><div class="kpi-label">‚úÖ Taux de r√©ussite</div><div class="kpi-value" id="kpi-pf-reussite">-</div></div>
          <div class="kpi-card yellow"><div class="kpi-label">üìà Progression moyenne</div><div class="kpi-value" id="kpi-pf-progression">-</div></div>
          <div class="kpi-card cyan"><div class="kpi-label">üìã PV g√©n√©r√©s</div><div class="kpi-value" id="kpi-pf-pv">0</div></div>
          <div class="kpi-card orange"><div class="kpi-label">üéì Attestations</div><div class="kpi-value" id="kpi-pf-attestations">0</div></div>
          <div class="kpi-card purple"><div class="kpi-label">üìä Satisfaction</div><div class="kpi-value" id="kpi-pf-satisfaction">-</div></div>
        </div>
        
        <!-- Onglets -->
        <div style="display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap">
          <button class="btn btn-primary" id="btn-pf-documents" onclick="showPostFormationTab('documents')" style="flex:1">üìÅ Documents Session</button>
          <button class="btn btn-secondary" id="btn-pf-ecarts" onclick="showPostFormationTab('ecarts')" style="flex:1">üìä √âcarts Comp√©tences</button>
          <button class="btn btn-secondary" id="btn-pf-emargements" onclick="showPostFormationTab('emargements')" style="flex:1">‚úçÔ∏è √âmargements</button>
          <button class="btn btn-secondary" id="btn-pf-satisfaction" onclick="showPostFormationTab('satisfaction')" style="flex:1">üìä Satisfaction</button>
          <button class="btn btn-secondary" id="btn-pf-generation" onclick="showPostFormationTab('generation')" style="flex:1">üìÑ G√©n√©ration Documents</button>
        </div>
        
        <!-- Onglet Documents -->
        <div class="post-formation-tab" id="pf-tab-documents">
          <div class="card">
            <div class="card-header" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)">
              <h3 class="card-title" style="color:white">üìÅ Documents de la Session</h3>
              <div style="display:flex;gap:10px">
                <button class="btn btn-success btn-sm" onclick="ouvrirUploadDocPostFormation()">üì§ Uploader un document</button>
              </div>
            </div>
            <div class="card-body">
              <div class="info-box" style="margin-bottom:15px">
                üìã <strong>Documents requis :</strong> Programme de formation, Support p√©dagogique, QCM/√âvaluations, Feuilles d'√©margement, Attestations de pr√©sence
              </div>
              
              <!-- Cat√©gories de documents -->
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px">
                <div class="doc-category" style="background:#dbeafe;padding:15px;border-radius:10px;border:2px solid #3b82f6">
                  <h4 style="margin:0 0 10px 0;color:#1e40af">üìö Documents P√©dagogiques</h4>
                  <div id="docs-pedagogiques" style="font-size:0.9em">Aucun document</div>
                </div>
                <div class="doc-category" style="background:#dcfce7;padding:15px;border-radius:10px;border:2px solid #22c55e">
                  <h4 style="margin:0 0 10px 0;color:#166534">üìù √âvaluations</h4>
                  <div id="docs-evaluations" style="font-size:0.9em">Aucun document</div>
                </div>
                <div class="doc-category" style="background:#fef3c7;padding:15px;border-radius:10px;border:2px solid #f59e0b">
                  <h4 style="margin:0 0 10px 0;color:#92400e">‚úçÔ∏è Pr√©sence & √âmargement</h4>
                  <div id="docs-presence" style="font-size:0.9em">Aucun document</div>
                </div>
                <div class="doc-category" style="background:#f3e8ff;padding:15px;border-radius:10px;border:2px solid #a855f7">
                  <h4 style="margin:0 0 10px 0;color:#7c3aed">‚≠ê Questionnaires Satisfaction</h4>
                  <div id="docs-satisfaction" style="font-size:0.9em">Aucun document</div>
                </div>
                <div class="doc-category" style="background:#fce7f3;padding:15px;border-radius:10px;border:2px solid #ec4899">
                  <h4 style="margin:0 0 10px 0;color:#be185d">üìÑ Documents Administratifs</h4>
                  <div id="docs-admin" style="font-size:0.9em">Aucun document</div>
                </div>
              </div>
              
              <!-- Liste compl√®te des documents -->
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Nom du document</th>
                    <th>Cat√©gorie</th>
                    <th>Date upload</th>
                    <th>Taille</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="table-post-formation-docs">
                  <tr><td colspan="6" class="empty-state">S√©lectionnez une session pour voir les documents</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Onglet √âcarts de Comp√©tences -->
        <div class="post-formation-tab" id="pf-tab-ecarts" style="display:none">
          <div class="card">
            <div class="card-header" style="background:linear-gradient(135deg,#059669,#10b981)">
              <h3 class="card-title" style="color:white">üìä Bilan des √âcarts de Comp√©tences</h3>
            </div>
            <div class="card-body">
              <div id="pf-ecarts-content">
                <p class="empty-state">S√©lectionnez une session pour voir les √©valuations</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Onglet √âmargements -->
        <div class="post-formation-tab" id="pf-tab-emargements" style="display:none">
          <div class="card">
            <div class="card-header" style="background:linear-gradient(135deg,#f59e0b,#fbbf24)">
              <h3 class="card-title" style="color:white">‚úçÔ∏è R√©capitulatif des √âmargements</h3>
            </div>
            <div class="card-body">
              <div id="pf-emargements-content">
                <p class="empty-state">S√©lectionnez une session pour voir les √©margements</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Onglet Satisfaction Stagiaires -->
        <div class="post-formation-tab" id="pf-tab-satisfaction" style="display:none">
          <div class="card">
            <div class="card-header" style="background:linear-gradient(135deg,#8b5cf6,#a855f7)">
              <h3 class="card-title" style="color:white">üìä Compilation des Questionnaires de Satisfaction</h3>
              <div style="display:flex;gap:8px">
                <button class="btn btn-sm" style="background:#22c55e;color:white" onclick="ouvrirSaisieEvalChaud()">‚ûï Saisie manuelle</button>
                <button class="btn btn-sm" style="background:white;color:#8b5cf6" onclick="ouvrirImportMasseQuestionnaires()">ü§ñ Import OCR</button>
                <button class="btn btn-sm" style="background:rgba(255,255,255,0.2);color:white" onclick="ouvrirImportCSVQuestionnaires()">üì• Import CSV</button>
              </div>
            </div>
            <div class="card-body">
              
              <!-- R√©sum√© global -->
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px">
                <div style="background:linear-gradient(135deg,#dbeafe,#bfdbfe);padding:20px;border-radius:12px;text-align:center">
                  <div style="font-size:2.5em;font-weight:bold;color:#1e40af" id="pf-sat-global">-</div>
                  <div style="color:#3b82f6;font-weight:600">Score Global</div>
                </div>
                <div style="background:linear-gradient(135deg,#dcfce7,#bbf7d0);padding:20px;border-radius:12px;text-align:center">
                  <div style="font-size:2.5em;font-weight:bold;color:#166534" id="pf-sat-appreciation">-</div>
                  <div style="color:#22c55e;font-weight:600">Appr√©ciations G√©n√©rales</div>
                </div>
                <div style="background:linear-gradient(135deg,#fef3c7,#fde68a);padding:20px;border-radius:12px;text-align:center">
                  <div style="font-size:2.5em;font-weight:bold;color:#92400e" id="pf-sat-niveau">-</div>
                  <div style="color:#f59e0b;font-weight:600">Niveau Satisfaction</div>
                </div>
                <div style="background:linear-gradient(135deg,#fce7f3,#fbcfe8);padding:20px;border-radius:12px;text-align:center">
                  <div style="font-size:2.5em;font-weight:bold;color:#be185d" id="pf-sat-recommande">-</div>
                  <div style="color:#ec4899;font-weight:600">Recommandation</div>
                </div>
              </div>
              
              <!-- Graphique √©toiles par crit√®re -->
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px">
                
                <!-- Appr√©ciations g√©n√©rales -->
                <div style="background:#f8fafc;padding:20px;border-radius:12px;border:1px solid #e2e8f0">
                  <h4 style="margin:0 0 15px 0;color:#1e40af;border-bottom:2px solid #3b82f6;padding-bottom:8px">üìã Appr√©ciations G√©n√©rales</h4>
                  <div id="pf-sat-criteres-generaux" style="display:grid;gap:12px">
                    <div class="sat-critere">
                      <span class="sat-label">1. Information avant formation</span>
                      <span class="sat-stars" id="sat-c1">-</span>
                      <span class="sat-score" id="sat-s1">-</span>
                    </div>
                    <div class="sat-critere">
                      <span class="sat-label">2. Dur√©e et rythme</span>
                      <span class="sat-stars" id="sat-c2">-</span>
                      <span class="sat-score" id="sat-s2">-</span>
                    </div>
                    <div class="sat-critere">
                      <span class="sat-label">3. Horaires</span>
                      <span class="sat-stars" id="sat-c3">-</span>
                      <span class="sat-score" id="sat-s3">-</span>
                    </div>
                    <div class="sat-critere">
                      <span class="sat-label">4. Lieu et locaux</span>
                      <span class="sat-stars" id="sat-c4">-</span>
                      <span class="sat-score" id="sat-s4">-</span>
                    </div>
                    <div class="sat-critere">
                      <span class="sat-label">5. Programme et m√©thodes</span>
                      <span class="sat-stars" id="sat-c5">-</span>
                      <span class="sat-score" id="sat-s5">-</span>
                    </div>
                    <div class="sat-critere">
                      <span class="sat-label">6. Mat√©riels et supports</span>
                      <span class="sat-stars" id="sat-c6">-</span>
                      <span class="sat-score" id="sat-s6">-</span>
                    </div>
                  </div>
                  <div style="margin-top:15px;padding-top:12px;border-top:2px solid #3b82f6;display:flex;justify-content:space-between;font-weight:bold">
                    <span>Moyenne Appr√©ciations</span>
                    <span id="pf-sat-moy-gen" style="color:#1e40af">-</span>
                  </div>
                </div>
                
                <!-- Niveau de satisfaction -->
                <div style="background:#f8fafc;padding:20px;border-radius:12px;border:1px solid #e2e8f0">
                  <h4 style="margin:0 0 15px 0;color:#166534;border-bottom:2px solid #22c55e;padding-bottom:8px">‚≠ê Niveau de Satisfaction</h4>
                  <div id="pf-sat-criteres-satisfaction" style="display:grid;gap:12px">
                    <div class="sat-critere">
                      <span class="sat-label">1. Appr√©ciation globale</span>
                      <span class="sat-stars" id="sat-c7">-</span>
                      <span class="sat-score" id="sat-s7">-</span>
                    </div>
                    <div class="sat-critere">
                      <span class="sat-label">2. Recommandation</span>
                      <span class="sat-stars" id="sat-c8">-</span>
                      <span class="sat-score" id="sat-s8">-</span>
                    </div>
                  </div>
                  <div style="margin-top:15px;padding-top:12px;border-top:2px solid #22c55e;display:flex;justify-content:space-between;font-weight:bold">
                    <span>Moyenne Satisfaction</span>
                    <span id="pf-sat-moy-sat" style="color:#166534">-</span>
                  </div>
                  
                  <!-- Jauge NPS style -->
                  <div style="margin-top:20px;background:#fff;padding:15px;border-radius:8px;border:1px solid #e2e8f0">
                    <div style="font-weight:600;margin-bottom:10px;color:#374151">Taux de Recommandation</div>
                    <div style="height:24px;background:#e5e7eb;border-radius:12px;overflow:hidden">
                      <div id="pf-sat-jauge" style="height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#16a34a);transition:width 0.5s ease"></div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:5px;font-size:0.8em;color:#64748b">
                      <span>0%</span>
                      <span id="pf-sat-jauge-val">-</span>
                      <span>100%</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Liste des √©valuations -->
              <div style="margin-top:20px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                  <h4 style="margin:0;color:#374151">üìù √âvaluations Individuelles (${document.getElementById('post-formation-session')?.selectedOptions[0]?.text || 'Session'})</h4>
                  <button class="btn btn-secondary btn-sm" onclick="exporterSatisfactionPDF()">üìÑ Exporter PDF</button>
                </div>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Stagiaire</th>
                      <th>Date</th>
                      <th>C1</th>
                      <th>C2</th>
                      <th>C3</th>
                      <th>C4</th>
                      <th>C5</th>
                      <th>C6</th>
                      <th>Appr.</th>
                      <th>Reco.</th>
                      <th>Moy.</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="table-pf-satisfaction">
                    <tr><td colspan="12" class="empty-state">S√©lectionnez une session pour voir les √©valuations</td></tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Commentaires -->
              <div style="margin-top:20px">
                <h4 style="margin:0 0 15px 0;color:#374151">üí¨ Commentaires des Stagiaires</h4>
                <div id="pf-sat-commentaires" style="display:grid;gap:10px">
                  <p class="empty-state">Aucun commentaire</p>
                </div>
              </div>
              
            </div>
          </div>
        </div>
        
        <!-- Onglet G√©n√©ration Documents -->
        <div class="post-formation-tab" id="pf-tab-generation" style="display:none">
          <div class="card">
            <div class="card-header" style="background:linear-gradient(135deg,#dc2626,#ef4444)">
              <h3 class="card-title" style="color:white">üìÑ G√©n√©ration des Documents Officiels</h3>
            </div>
            <div class="card-body">
              
              <!-- V√©rification pr√©-requis -->
              <div id="pf-prerequis" style="background:#fef3c7;padding:15px;border-radius:10px;margin-bottom:20px">
                <h4 style="margin:0 0 10px 0;color:#92400e">‚úÖ Pr√©-requis pour la g√©n√©ration</h4>
                <div id="pf-check-list" style="display:grid;gap:8px">
                  <div class="check-item"><span id="check-session">‚è≥</span> Session s√©lectionn√©e</div>
                  <div class="check-item"><span id="check-ecarts">‚è≥</span> √âvaluations Entr√©e/Sortie compl√©t√©es</div>
                  <div class="check-item"><span id="check-emargements">‚è≥</span> Feuilles d'√©margement valid√©es</div>
                  <div class="check-item"><span id="check-stagiaires">‚è≥</span> Liste des stagiaires valid√©e</div>
                </div>
              </div>
              
              <!-- G√©n√©ration PV -->
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px">
                
                <!-- Proc√®s Verbal -->
                <div style="background:#dbeafe;padding:20px;border-radius:10px;border:2px solid #3b82f6">
                  <h4 style="margin:0 0 15px 0;color:#1e40af;display:flex;align-items:center;gap:10px">
                    <span style="font-size:1.5em">üìã</span> Proc√®s Verbal de Formation
                  </h4>
                  <p style="color:#64748b;font-size:0.9em;margin-bottom:15px">
                    Document officiel constatant le succ√®s et la progression des stagiaires. Inclut les r√©sultats des √©valuations entr√©e/sortie.
                  </p>
                  <button class="btn btn-primary" style="width:100%" onclick="genererProcesVerbal()">
                    üìÑ G√©n√©rer le PV
                  </button>
                  <div id="pv-liste" style="margin-top:15px;font-size:0.85em"></div>
                </div>
                
                <!-- Attestations de Formation -->
                <div style="background:#dcfce7;padding:20px;border-radius:10px;border:2px solid #22c55e">
                  <h4 style="margin:0 0 15px 0;color:#166534;display:flex;align-items:center;gap:10px">
                    <span style="font-size:1.5em">üéì</span> Attestations de Formation
                  </h4>
                  <p style="color:#64748b;font-size:0.9em;margin-bottom:15px">
                    Attestation individuelle d√©livr√©e √† chaque stagiaire ayant suivi la formation avec succ√®s.
                  </p>
                  <button class="btn btn-success" style="width:100%" onclick="genererAttestations()">
                    üéì G√©n√©rer les Attestations
                  </button>
                  <div id="attestations-liste" style="margin-top:15px;font-size:0.85em"></div>
                </div>
                
                <!-- Certificats de R√©alisation -->
                <div style="background:#fef3c7;padding:20px;border-radius:10px;border:2px solid #f59e0b">
                  <h4 style="margin:0 0 15px 0;color:#92400e;display:flex;align-items:center;gap:10px">
                    <span style="font-size:1.5em">üìú</span> Certificats de R√©alisation
                  </h4>
                  <p style="color:#64748b;font-size:0.9em;margin-bottom:15px">
                    Certificat destin√© au donneur d'ordre/OPCO confirmant la r√©alisation effective de la formation.
                  </p>
                  <button class="btn btn-warning" style="width:100%" onclick="genererCertificats()">
                    üìú G√©n√©rer les Certificats
                  </button>
                  <div id="certificats-liste" style="margin-top:15px;font-size:0.85em"></div>
                </div>
                
              </div>
              
              <!-- Tableau des stagiaires avec r√©sultats -->
              <div style="margin-top:30px">
                <h4 style="margin-bottom:15px;color:#374151">üë• R√©capitulatif par Stagiaire</h4>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Stagiaire</th>
                      <th>Score Entr√©e</th>
                      <th>Score Sortie</th>
                      <th>Progression</th>
                      <th>Pr√©sence</th>
                      <th>R√©sultat</th>
                      <th>Documents</th>
                    </tr>
                  </thead>
                  <tbody id="table-pf-stagiaires">
                    <tr><td colspan="7" class="empty-state">S√©lectionnez une session</td></tr>
                  </tbody>
                </table>
              </div>
              
            </div>
          </div>
        </div>
        
      </div>

      <!-- QUALIOPI -->
      <div class="page" id="page-qualiopi">
        <div class="qualiopi-section active" id="quali-indicateurs">
          <div class="info-box"><strong>üèÜ Certification Qualiopi</strong> - Suivi des 7 crit√®res et 32 indicateurs</div>
          <div class="card"><div class="card-header"><h3 class="card-title">üìä Tableau de bord Qualiopi</h3></div><div id="qualiopi-criteres"></div></div>
        </div>
        
        <!-- DOCUMENTS QUALIOPI -->
        <div class="qualiopi-section" id="quali-documents-quali">
          <div class="toolbar" style="flex-wrap:wrap;gap:10px">
            <div class="search-box"><input type="text" id="search-docs-quali" placeholder="Rechercher un document..." oninput="filterDocsQualiopi()"></div>
            <select class="filter-select" id="filter-docs-critere" onchange="filterDocsQualiopi()">
              <option value="">Tous les crit√®res</option>
              <option value="C1">C1 - Information du public</option>
              <option value="C2">C2 - Objectifs et adaptation</option>
              <option value="C3">C3 - Accompagnement</option>
              <option value="C4">C4 - Moyens p√©dagogiques</option>
              <option value="C5">C5 - Qualification du personnel</option>
              <option value="C6">C6 - Inscription professionnelle</option>
              <option value="C7">C7 - Am√©lioration continue</option>
            </select>
            <select class="filter-select" id="filter-docs-type" onchange="filterDocsQualiopi()">
              <option value="">Tous les types</option>
              <option value="procedure">üìã Proc√©dure</option>
              <option value="formulaire">üìù Formulaire</option>
              <option value="modele">üìÑ Mod√®le</option>
              <option value="preuve">‚úÖ Preuve</option>
              <option value="rapport">üìä Rapport</option>
              <option value="autre">üìé Autre</option>
            </select>
            <button class="btn btn-primary" onclick="ouvrirModalDocQualiopi()">üì§ Ajouter un document</button>
          </div>
          
          <div class="info-box" style="margin:15px 0">
            <strong>üìÅ Documents Qualiopi</strong> - Gestion centralis√©e des documents de certification avec versioning
          </div>
          
          <div class="card">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th style="width:60px">Crit√®re</th>
                    <th>Titre</th>
                    <th style="width:100px">Type</th>
                    <th style="width:80px">Version</th>
                    <th style="width:100px">Date</th>
                    <th style="width:120px">Taille</th>
                    <th style="width:150px">Actions</th>
                  </tr>
                </thead>
                <tbody id="table-docs-qualiopi"></tbody>
              </table>
            </div>
          </div>
          
          <!-- Statistiques documents -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-top:20px">
            <div class="kpi-card blue" style="padding:15px">
              <div class="kpi-label">Total documents</div>
              <div class="kpi-value" id="docs-quali-total">0</div>
            </div>
            <div class="kpi-card green" style="padding:15px">
              <div class="kpi-label">Proc√©dures</div>
              <div class="kpi-value" id="docs-quali-procedures">0</div>
            </div>
            <div class="kpi-card purple" style="padding:15px">
              <div class="kpi-label">Preuves</div>
              <div class="kpi-value" id="docs-quali-preuves">0</div>
            </div>
            <div class="kpi-card yellow" style="padding:15px">
              <div class="kpi-label">√Ä mettre √† jour</div>
              <div class="kpi-value" id="docs-quali-maj">0</div>
            </div>
          </div>
        </div>
        
        <!-- VEILLE QUALIOPI -->
        <div class="qualiopi-section" id="quali-veille">
          <div class="toolbar" style="flex-wrap:wrap;gap:10px">
            <div class="search-box"><input type="text" id="search-veille" placeholder="Rechercher dans la veille..." oninput="filterVeille()"></div>
            <select class="filter-select" id="filter-veille-type" onchange="filterVeille()">
              <option value="">Toutes les veilles</option>
              <option value="pedagogique">üìö P√©dagogique</option>
              <option value="juridique">‚öñÔ∏è Juridique & R√©glementaire</option>
              <option value="sectorielle">üè≠ Sectorielle</option>
            </select>
            <select class="filter-select" id="filter-veille-periode" onchange="filterVeille()">
              <option value="">Toute p√©riode</option>
              <option value="7">7 derniers jours</option>
              <option value="30">30 derniers jours</option>
              <option value="90">3 derniers mois</option>
              <option value="180">6 derniers mois</option>
              <option value="365">12 derniers mois</option>
            </select>
            <button class="btn btn-primary" onclick="ouvrirModalVeille()">‚ûï Ajouter une veille</button>
            <button class="btn btn-success" onclick="exporterVeilleCSV()">üìä Exporter CSV</button>
            <button class="btn btn-secondary" onclick="actualiserVeille()" title="Actualiser la liste">üîÑ Actualiser</button>
          </div>
          
          <div class="info-box" style="margin:15px 0">
            <strong>üîç Veille Qualiopi</strong> - Suivi des actualit√©s p√©dagogiques, juridiques et sectorielles pour l'am√©lioration continue (Crit√®res 5 & 6)
          </div>
          
          <!-- Sources de veille -->
          <div class="card" style="margin-bottom:20px">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
              <h3 class="card-title" style="margin:0">üåê Sources de veille configur√©es</h3>
              <button class="btn btn-sm btn-primary" onclick="gererSourcesVeille()">‚öôÔ∏è G√©rer les sources</button>
            </div>
            <div style="padding:15px;display:flex;flex-wrap:wrap;gap:10px" id="sources-veille-list">
              <!-- G√©n√©r√© dynamiquement -->
            </div>
          </div>
          
          <!-- Onglets de veille -->
          <div style="display:flex;gap:10px;margin-bottom:15px">
            <button class="btn" id="btn-veille-all" onclick="filtrerTypeVeille('')" style="background:#1e40af;color:white">üìã Toutes</button>
            <button class="btn btn-secondary" id="btn-veille-pedagogique" onclick="filtrerTypeVeille('pedagogique')">üìö P√©dagogique</button>
            <button class="btn btn-secondary" id="btn-veille-juridique" onclick="filtrerTypeVeille('juridique')">‚öñÔ∏è Juridique</button>
            <button class="btn btn-secondary" id="btn-veille-sectorielle" onclick="filtrerTypeVeille('sectorielle')">üè≠ Sectorielle</button>
            <span style="border-left:2px solid #e2e8f0;height:30px;margin:0 5px"></span>
            <button class="btn btn-primary" id="btn-veille-tableau" onclick="toggleVueVeille('tableau')" style="background:#0891b2;color:white">üìä Vue Tableau</button>
            <button class="btn btn-secondary" id="btn-veille-cartes" onclick="toggleVueVeille('cartes')">üóÇÔ∏è Vue Cartes</button>
          </div>
          
          <!-- Vue Tableau de synth√®se -->
          <div id="veille-vue-tableau" style="display:block">
            <div class="card">
              <div class="table-container">
                <table>
                  <thead>
                    <tr style="background:linear-gradient(135deg,#0891b2,#0e7490);color:white">
                      <th style="min-width:120px">Sources</th>
                      <th style="min-width:200px">R√©sum√©</th>
                      <th style="min-width:100px">Date recueil</th>
                      <th style="min-width:180px">Principale information</th>
                      <th style="min-width:180px">Actions d'√©volution</th>
                      <th style="width:60px;text-align:center" title="Newsletter">üìß</th>
                      <th style="width:60px;text-align:center" title="Site">üåê</th>
                      <th style="width:60px;text-align:center" title="Documents Entreprise">üìÅ</th>
                      <th style="width:60px;text-align:center" title="Outils">üõ†Ô∏è</th>
                      <th style="width:100px">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="table-veille-synthese">
                    <!-- G√©n√©r√© dynamiquement -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Vue Cartes (ancienne vue) -->
          <div id="veille-vue-cartes" style="display:none">
            <div id="veille-liste" style="display:flex;flex-direction:column;gap:15px">
              <!-- G√©n√©r√© dynamiquement -->
            </div>
          </div>
          
          <!-- Statistiques veille -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-top:20px">
            <div class="kpi-card blue" style="padding:15px">
              <div class="kpi-label">Articles collect√©s</div>
              <div class="kpi-value" id="veille-total">0</div>
            </div>
            <div class="kpi-card purple" style="padding:15px">
              <div class="kpi-label">P√©dagogique</div>
              <div class="kpi-value" id="veille-pedagogique">0</div>
            </div>
            <div class="kpi-card yellow" style="padding:15px">
              <div class="kpi-label">Juridique</div>
              <div class="kpi-value" id="veille-juridique">0</div>
            </div>
            <div class="kpi-card green" style="padding:15px">
              <div class="kpi-label">Sectorielle</div>
              <div class="kpi-value" id="veille-sectorielle">0</div>
            </div>
          </div>
        </div>
        
        <!-- SECTION AIDAR - Al√©as, Incidents, Difficult√©s, Accidents, R√©clamations -->
        <div class="qualiopi-section" id="quali-aidar">
          <!-- En-t√™te AIDAR -->
          <div class="card" style="margin-bottom:20px;background:linear-gradient(135deg,#1e40af,#7c3aed);color:white;padding:20px">
            <h2 style="margin:0 0 10px 0;display:flex;align-items:center;gap:10px">
              üìã AIDAR - Am√©lioration Continue
              <span style="font-size:0.5em;background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:20px">P√¥le Formation</span>
            </h2>
            <p style="margin:0;opacity:0.9;font-size:0.9em">Traitement des Al√©as, Incidents, Difficult√©s, Accidents et R√©clamations</p>
          </div>
          
          <!-- KPIs AIDAR -->
          <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:20px">
            <div style="text-align:center;padding:15px;background:#dbeafe;border-radius:10px;border-left:4px solid #2563eb">
              <div style="font-size:1.8em;font-weight:700;color:#2563eb" id="kpi-aidar-total">0</div>
              <div style="font-size:0.7em;color:#64748b">Total AIDAR</div>
            </div>
            <div style="text-align:center;padding:15px;background:#fef3c7;border-radius:10px;border-left:4px solid #f59e0b">
              <div style="font-size:1.8em;font-weight:700;color:#f59e0b" id="kpi-aidar-mineur">0</div>
              <div style="font-size:0.7em;color:#64748b">NC Mineures</div>
            </div>
            <div style="text-align:center;padding:15px;background:#fee2e2;border-radius:10px;border-left:4px solid #dc2626">
              <div style="font-size:1.8em;font-weight:700;color:#dc2626" id="kpi-aidar-majeur">0</div>
              <div style="font-size:0.7em;color:#64748b">NC Majeures</div>
            </div>
            <div style="text-align:center;padding:15px;background:#dcfce7;border-radius:10px;border-left:4px solid #16a34a">
              <div style="font-size:1.8em;font-weight:700;color:#16a34a" id="kpi-aidar-finalise">0</div>
              <div style="font-size:0.7em;color:#64748b">Finalis√©es</div>
            </div>
            <div style="text-align:center;padding:15px;background:#fae8ff;border-radius:10px;border-left:4px solid #a855f7">
              <div style="font-size:1.8em;font-weight:700;color:#a855f7" id="kpi-aidar-encours">0</div>
              <div style="font-size:0.7em;color:#64748b">En cours</div>
            </div>
            <div style="text-align:center;padding:15px;background:#f1f5f9;border-radius:10px;border-left:4px solid #64748b">
              <div style="font-size:1.8em;font-weight:700;color:#64748b" id="kpi-aidar-delai">0j</div>
              <div style="font-size:0.7em;color:#64748b">D√©lai moyen</div>
            </div>
          </div>
          
          <!-- D√©finitions -->
          <div class="card" style="margin-bottom:20px;padding:15px">
            <h4 style="margin:0 0 15px 0;color:#1e40af;cursor:pointer" onclick="toggleAIdarDefinitions()">
              üìñ D√©finitions <span id="aidar-def-toggle" style="font-size:0.8em">‚ñº</span>
            </h4>
            <div id="aidar-definitions" style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;font-size:0.85em">
              <div style="padding:10px;background:#f0f9ff;border-radius:8px;border-left:3px solid #0ea5e9">
                <strong style="color:#0369a1">1/ Al√©a</strong><br>
                <span style="color:#64748b">Tour impr√©visible et le plus souvent d√©favorable pris par les √©v√©nements et li√© √† une activit√©, une action ; risque.</span>
              </div>
              <div style="padding:10px;background:#fefce8;border-radius:8px;border-left:3px solid #eab308">
                <strong style="color:#a16207">2/ Difficult√©s</strong><br>
                <span style="color:#64748b">Caract√®re difficile de quelque chose, ensemble des points qui posent probl√®me.</span>
              </div>
              <div style="padding:10px;background:#fef2f2;border-radius:8px;border-left:3px solid #ef4444">
                <strong style="color:#dc2626">3/ R√©clamation</strong><br>
                <span style="color:#64748b">Action visant √† faire respecter un droit, ou √† demander une chose due, recueillie par √©crit.</span>
              </div>
              <div style="padding:10px;background:#f0fdf4;border-radius:8px;border-left:3px solid #22c55e">
                <strong style="color:#16a34a">4/ Incident</strong><br>
                <span style="color:#64748b">√âv√©nement de caract√®re secondaire, g√©n√©ralement f√¢cheux, qui survient au cours d'une action.</span>
              </div>
              <div style="padding:10px;background:#faf5ff;border-radius:8px;border-left:3px solid #a855f7">
                <strong style="color:#7c3aed">5/ Accident</strong><br>
                <span style="color:#64748b">√âv√©nement fortuit qui entra√Æne des dommages corporels ou mat√©riels.</span>
              </div>
              <div style="padding:10px;background:#f8fafc;border-radius:8px;border-left:3px solid #64748b">
                <strong style="color:#475569">Cat√©gories</strong><br>
                <span style="color:#64748b">1-Info, 2-Conception, 3-Prestation, 4-Moyens, 5-Comp√©tences, 6-Environnement, 7-Am√©lioration</span>
              </div>
            </div>
          </div>
          
          <!-- Matrice d'√©valuation -->
          <div class="card" style="margin-bottom:20px;padding:15px">
            <h4 style="margin:0 0 15px 0;color:#1e40af;cursor:pointer" onclick="toggleAIdarMatrice()">
              üìä Matrice d'√âvaluation (G x F = NC) <span id="aidar-matrice-toggle" style="font-size:0.8em">‚ñ∂</span>
            </h4>
            <div id="aidar-matrice" style="display:none;overflow-x:auto">
              <table style="width:100%;font-size:0.8em;border-collapse:collapse">
                <thead>
                  <tr style="background:#f1f5f9">
                    <th style="padding:8px;border:1px solid #e2e8f0">G \ F</th>
                    <th style="padding:8px;border:1px solid #e2e8f0;background:#dcfce7">1 - Faible</th>
                    <th style="padding:8px;border:1px solid #e2e8f0;background:#fef9c3">2 - Moyenne</th>
                    <th style="padding:8px;border:1px solid #e2e8f0;background:#fed7aa">3 - √âlev√©e</th>
                    <th style="padding:8px;border:1px solid #e2e8f0;background:#fecaca">4 - Tr√®s √©lev√©e</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:bold">1 - Mineur</td><td style="padding:8px;border:1px solid #e2e8f0;background:#dcfce7;text-align:center">1</td><td style="padding:8px;border:1px solid #e2e8f0;background:#dcfce7;text-align:center">2</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fef9c3;text-align:center">3</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fef9c3;text-align:center">4</td></tr>
                  <tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:bold">2 - Significatif</td><td style="padding:8px;border:1px solid #e2e8f0;background:#dcfce7;text-align:center">2</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fef9c3;text-align:center">4</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fed7aa;text-align:center">6</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fecaca;text-align:center">8</td></tr>
                  <tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:bold">3 - Important</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fef9c3;text-align:center">3</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fed7aa;text-align:center">6</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fecaca;text-align:center">9</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fecaca;text-align:center">12</td></tr>
                  <tr><td style="padding:8px;border:1px solid #e2e8f0;font-weight:bold">4 - Critique</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fef9c3;text-align:center">4</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fecaca;text-align:center">8</td><td style="padding:8px;border:1px solid #e2e8f0;background:#fecaca;text-align:center">12</td><td style="padding:8px;border:1px solid #e2e8f0;background:#ef4444;color:white;text-align:center">16</td></tr>
                </tbody>
              </table>
              <div style="margin-top:10px;display:flex;gap:15px;font-size:0.8em">
                <span><span style="display:inline-block;width:12px;height:12px;background:#dcfce7;border-radius:2px;margin-right:4px"></span> 1-2: Acceptable</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:#fef9c3;border-radius:2px;margin-right:4px"></span> 3-4: √Ä surveiller</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:#fed7aa;border-radius:2px;margin-right:4px"></span> 6-8: Action requise</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:#fecaca;border-radius:2px;margin-right:4px"></span> 9-16: Urgent</span>
              </div>
            </div>
          </div>
          
          <!-- Toolbar et filtres -->
          <div class="toolbar" style="flex-wrap:wrap;gap:10px">
            <div class="search-box"><input type="text" id="search-aidar" placeholder="Rechercher..." oninput="filterAIDAR()"></div>
            <div class="filters">
              <select class="filter-select" id="filter-aidar-type" onchange="filterAIDAR()">
                <option value="">Tous types</option>
                <option value="Mineure">NC Mineure</option>
                <option value="Majeure">NC Majeure</option>
              </select>
              <select class="filter-select" id="filter-aidar-categorie" onchange="filterAIDAR()">
                <option value="">Toutes cat√©gories</option>
                <option value="1 -Information">1 - Information</option>
                <option value="2 - Conception">2 - Conception</option>
                <option value="3 - Prestation">3 - Prestation</option>
                <option value="4 - Moyens">4 - Moyens</option>
                <option value="5 - Comp√©tences">5 - Comp√©tences</option>
                <option value="6 - Environnement">6 - Environnement</option>
                <option value="7 - Am√©lioration">7 - Am√©lioration</option>
              </select>
              <select class="filter-select" id="filter-aidar-statut" onchange="filterAIDAR()">
                <option value="">Tous statuts</option>
                <option value="Action finalis√©e">Finalis√©e</option>
                <option value="En cours">En cours</option>
              </select>
              <select class="filter-select" id="filter-aidar-annee" onchange="filterAIDAR()">
                <option value="">Toutes ann√©es</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="openModalAIDAR()">‚ûï Nouvel AIDAR</button>
            <button class="btn btn-success" onclick="importerDonneesAIDAR()">üì• Importer donn√©es initiales</button>
            <button class="btn btn-info" onclick="exporterAIDAR()">üìä Export Excel</button>
          </div>
          
          <!-- Tableau AIDAR -->
          <div class="card" style="margin-top:15px">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>N¬∞</th>
                    <th>Date</th>
                    <th>Nom / R√©f</th>
                    <th>Qualit√©</th>
                    <th>Type</th>
                    <th>Cat√©gorie</th>
                    <th>Description</th>
                    <th>NC</th>
                    <th>Actions imm√©diates</th>
                    <th>√âval.</th>
                    <th>Plan d'actions</th>
                    <th>Priorit√©</th>
                    <th>Responsable</th>
                    <th>Statut</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="table-aidar"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- SECTION √âCARTS DE COMP√âTENCES -->
        <div class="qualiopi-section" id="quali-ecarts-competences">
          <!-- En-t√™te -->
          <div class="card" style="margin-bottom:20px;background:linear-gradient(135deg,#059669,#10b981);color:white;padding:20px">
            <h2 style="margin:0 0 10px 0;display:flex;align-items:center;gap:10px">
              üìà Mesure des √âcarts de Comp√©tences
              <span style="font-size:0.5em;background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:20px">Qualiopi - Crit√®re 2</span>
            </h2>
            <p style="margin:0;opacity:0.9;font-size:0.9em">√âvaluation Positionnement (Entr√©e) vs Test Final (Sortie) - Analyse de la progression des stagiaires</p>
          </div>
          
          <!-- KPIs √âcarts -->
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px">
            <div style="text-align:center;padding:15px;background:#dcfce7;border-radius:10px;border-left:4px solid #16a34a">
              <div style="font-size:1.8em;font-weight:700;color:#16a34a" id="kpi-ecarts-sessions">0</div>
              <div style="font-size:0.7em;color:#64748b">Sessions √©valu√©es</div>
            </div>
            <div style="text-align:center;padding:15px;background:#dbeafe;border-radius:10px;border-left:4px solid #2563eb">
              <div style="font-size:1.8em;font-weight:700;color:#2563eb" id="kpi-ecarts-stagiaires">0</div>
              <div style="font-size:0.7em;color:#64748b">Stagiaires √©valu√©s</div>
            </div>
            <div style="text-align:center;padding:15px;background:#fef3c7;border-radius:10px;border-left:4px solid #f59e0b">
              <div style="font-size:1.8em;font-weight:700;color:#f59e0b" id="kpi-ecarts-entree">0%</div>
              <div style="font-size:0.7em;color:#64748b">Score moyen Entr√©e</div>
            </div>
            <div style="text-align:center;padding:15px;background:#d1fae5;border-radius:10px;border-left:4px solid #059669">
              <div style="font-size:1.8em;font-weight:700;color:#059669" id="kpi-ecarts-sortie">0%</div>
              <div style="font-size:0.7em;color:#64748b">Score moyen Sortie</div>
            </div>
            <div style="text-align:center;padding:15px;background:#fae8ff;border-radius:10px;border-left:4px solid #a855f7">
              <div style="font-size:1.8em;font-weight:700;color:#a855f7" id="kpi-ecarts-progression">+0%</div>
              <div style="font-size:0.7em;color:#64748b">Progression moyenne</div>
            </div>
          </div>
          
          <!-- Onglets -->
          <div style="display:flex;gap:5px;margin-bottom:15px;border-bottom:2px solid #e2e8f0;padding-bottom:10px">
            <button class="btn" style="background:#059669;color:white" onclick="showEcartsTab('sessions')" id="btn-ecarts-sessions">üìä Par Session</button>
            <button class="btn btn-secondary" onclick="showEcartsTab('questions')" id="btn-ecarts-questions">‚ùì BD Questions</button>
            <button class="btn btn-secondary" onclick="showEcartsTab('bilan')" id="btn-ecarts-bilan">üìà Bilan Global</button>
          </div>
          
          <!-- Tab: Par Session -->
          <div id="tab-ecarts-sessions" class="ecarts-tab">
            <div class="toolbar" style="flex-wrap:wrap;gap:10px">
              <div class="search-box"><input type="text" id="search-ecarts-sessions" placeholder="Rechercher une session..." oninput="filterEcartsSessions()"></div>
              <div class="filters">
                <select class="filter-select" id="filter-ecarts-formation" onchange="filterEcartsSessions()">
                  <option value="">Toutes formations</option>
                </select>
                <select class="filter-select" id="filter-ecarts-annee" onchange="filterEcartsSessions()">
                  <option value="">Toutes ann√©es</option>
                  <option value="2024">2024</option>
                  <option value="2023">2023</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="ouvrirModalNouvelleEvalSession()">‚ûï Nouvelle √âvaluation Session</button>
              <button class="btn btn-success" onclick="importerDonneesEcartsDemo()">üì• Importer donn√©es d√©mo</button>
            </div>
            
            <!-- Liste des sessions avec √©carts -->
            <div class="card" style="margin-top:15px">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>R√©f. Session</th>
                      <th>Entreprise</th>
                      <th>Formation</th>
                      <th>Dates</th>
                      <th>Stagiaires</th>
                      <th>Score Entr√©e</th>
                      <th>Score Sortie</th>
                      <th>Progression</th>
                      <th>Taux R√©ussite</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="table-ecarts-sessions"></tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Tab: BD Questions -->
          <div id="tab-ecarts-questions" class="ecarts-tab" style="display:none">
            <div class="toolbar" style="flex-wrap:wrap;gap:10px">
              <div class="search-box"><input type="text" id="search-ecarts-questions" placeholder="Rechercher une question..." oninput="filterEcartsQuestions()"></div>
              <div class="filters">
                <select class="filter-select" id="filter-questions-formation" onchange="filterEcartsQuestions()">
                  <option value="">Toutes formations</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="ouvrirModalNouvelleQuestion()">‚ûï Ajouter Question</button>
              <button class="btn btn-info" onclick="importerQuestionsDemo()">üì• Importer questions d√©mo</button>
            </div>
            
            <div class="card" style="margin-top:15px">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Formation</th>
                      <th>Question</th>
                      <th>Type</th>
                      <th>Options/R√©ponses</th>
                      <th>Bonne r√©ponse</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="table-ecarts-questions"></tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Tab: Bilan Global -->
          <div id="tab-ecarts-bilan" class="ecarts-tab" style="display:none">
            <div class="card" style="padding:20px">
              <h3 style="margin:0 0 20px 0;color:#059669">üìà Bilan Global des √âcarts de Comp√©tences</h3>
              
              <!-- Graphique progression par formation -->
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
                <div style="background:#f8fafc;padding:20px;border-radius:10px">
                  <h4 style="margin:0 0 15px 0;color:#475569">Progression par Formation</h4>
                  <div id="chart-progression-formation" style="min-height:250px"></div>
                </div>
                <div style="background:#f8fafc;padding:20px;border-radius:10px">
                  <h4 style="margin:0 0 15px 0;color:#475569">R√©partition des Scores</h4>
                  <div id="chart-repartition-scores" style="min-height:250px"></div>
                </div>
              </div>
              
              <!-- Tableau r√©capitulatif -->
              <div style="background:#f0fdf4;padding:15px;border-radius:10px;margin-bottom:20px">
                <h4 style="margin:0 0 10px 0;color:#166534">üìä Synth√®se par Formation</h4>
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Formation</th>
                        <th>Sessions</th>
                        <th>Stagiaires</th>
                        <th>Moy. Entr√©e</th>
                        <th>Moy. Sortie</th>
                        <th>Progression</th>
                        <th>Taux R√©ussite</th>
                      </tr>
                    </thead>
                    <tbody id="table-bilan-formations"></tbody>
                  </table>
                </div>
              </div>
              
              <div style="display:flex;gap:10px">
                <button class="btn btn-success" onclick="exporterBilanEcarts()">üìä Exporter Bilan Excel</button>
                <button class="btn btn-info" onclick="genererRapportEcarts()">üìÑ G√©n√©rer Rapport PDF</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="qualiopi-section" id="quali-emargements">
          <div class="toolbar"><div class="search-box"><input type="text" placeholder="Rechercher..."></div><button class="btn btn-primary" onclick="openModal('emargement')">‚ûï √âmargement</button></div>
          <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Action</th><th>Stagiaire</th><th>Date</th><th>Matin</th><th>Apr√®s-midi</th><th>Sign√©</th><th>Actions</th></tr></thead><tbody id="table-emargements"></tbody></table></div></div>
        </div>
        <div class="qualiopi-section" id="quali-evaluations-pre">
          <div class="toolbar"><div class="search-box"><input type="text" placeholder="Rechercher..."></div><button class="btn btn-primary" onclick="openModal('evalPre')">‚ûï √âval. Pr√©</button></div>
          <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Stagiaire</th><th>Formation</th><th>Date</th><th>Niveau</th><th>Attentes</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="table-eval-pre"></tbody></table></div></div>
        </div>
        <div class="qualiopi-section" id="quali-evaluations-post">
          <div class="toolbar"><div class="search-box"><input type="text" placeholder="Rechercher..."></div><button class="btn btn-primary" onclick="openModal('evalPost')">‚ûï √âval. Post</button></div>
          <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Stagiaire</th><th>Formation</th><th>Date</th><th>Note</th><th>Acquis</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="table-eval-post"></tbody></table></div></div>
        </div>
        <div class="qualiopi-section" id="quali-satisfactions">
          <!-- En-t√™te avec KPIs -->
          <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px">
            <div class="kpi-card" style="text-align:center;padding:15px;background:linear-gradient(135deg,#dbeafe,#e0f2fe);border-radius:10px">
              <div style="font-size:1.8em;font-weight:700;color:#2563eb" id="kpi-satisf-chaud">0</div>
              <div style="font-size:0.75em;color:#64748b">üî• Quest. √† Chaud</div>
            </div>
            <div class="kpi-card" style="text-align:center;padding:15px;background:linear-gradient(135deg,#dcfce7,#d1fae5);border-radius:10px">
              <div style="font-size:1.8em;font-weight:700;color:#16a34a" id="kpi-satisf-froid">0</div>
              <div style="font-size:0.75em;color:#64748b">‚ùÑÔ∏è Quest. √† Froid</div>
            </div>
            <div class="kpi-card" style="text-align:center;padding:15px;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:10px">
              <div style="font-size:1.8em;font-weight:700;color:#d97706" id="kpi-satisf-financeur">0</div>
              <div style="font-size:0.75em;color:#64748b">üí∞ Financeurs</div>
            </div>
            <div class="kpi-card" style="text-align:center;padding:15px;background:linear-gradient(135deg,#f3e8ff,#e9d5ff);border-radius:10px">
              <div style="font-size:1.8em;font-weight:700;color:#7c3aed" id="kpi-satisf-formateur">0</div>
              <div style="font-size:0.75em;color:#64748b">üë®‚Äçüè´ Formateurs</div>
            </div>
            <div class="kpi-card" style="text-align:center;padding:15px;background:linear-gradient(135deg,#fee2e2,#fecaca);border-radius:10px">
              <div style="font-size:1.8em;font-weight:700;color:#dc2626" id="kpi-satisf-donneur">0</div>
              <div style="font-size:0.75em;color:#64748b">üè¢ Donneurs d'ordre</div>
            </div>
          </div>
          
          <!-- Info proc√©dure -->
          <div class="info-box" style="margin-bottom:15px;border-left:4px solid #3b82f6">
            <strong>üìã Modalit√©s de recueil des appr√©ciations (R√©f: DOC VII.30.01 - V1.02)</strong><br>
            <small>La d√©marche d'am√©lioration continue de la qualit√© des actions de formation s'op√®re √† partir de l'analyse des questionnaires de satisfaction, r√©clamations et observations formul√©es par les parties prenantes.</small>
          </div>
          
          <!-- NOUVELLE SECTION : Tableau de bord statistiques -->
          <div class="card" style="margin-bottom:20px;border:2px solid #8b5cf6">
            <div class="card-header" style="background:linear-gradient(135deg,#8b5cf6,#a855f7);padding:15px">
              <h3 class="card-title" style="color:white;margin:0">üìä Tableau de Bord Satisfaction - Statistiques Globales</h3>
              <div style="display:flex;gap:10px;align-items:center">
                <select class="form-select" id="stats-satisf-annee" onchange="chargerStatsSatisfaction()" style="width:120px;padding:5px">
                  <option value="">Toutes ann√©es</option>
                </select>
                <button class="btn btn-sm" style="background:white;color:#8b5cf6" onclick="exporterStatsSatisfactionPDF()">üìÑ Export PDF</button>
                <button class="btn btn-sm" style="background:white;color:#8b5cf6" onclick="exporterStatsSatisfactionCSV()">üì• Export CSV</button>
              </div>
            </div>
            <div style="padding:20px">
              <!-- Moyennes globales -->
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:25px">
                <div style="background:linear-gradient(135deg,#dbeafe,#bfdbfe);padding:20px;border-radius:12px;text-align:center">
                  <div style="font-size:2.2em;font-weight:bold;color:#1e40af" id="stats-moy-globale">-</div>
                  <div style="color:#3b82f6;font-weight:600;font-size:0.9em">Moyenne Globale</div>
                  <div style="color:#64748b;font-size:0.75em" id="stats-nb-eval">0 √©valuations</div>
                </div>
                <div style="background:linear-gradient(135deg,#dcfce7,#bbf7d0);padding:20px;border-radius:12px;text-align:center">
                  <div style="font-size:2.2em;font-weight:bold;color:#166534" id="stats-taux-recomm">-</div>
                  <div style="color:#22c55e;font-weight:600;font-size:0.9em">Taux Recommandation</div>
                </div>
                <div style="background:linear-gradient(135deg,#fef3c7,#fde68a);padding:20px;border-radius:12px;text-align:center">
                  <div style="font-size:2.2em;font-weight:bold;color:#92400e" id="stats-moy-contenu">-</div>
                  <div style="color:#f59e0b;font-weight:600;font-size:0.9em">Contenu & P√©dagogie</div>
                </div>
                <div style="background:linear-gradient(135deg,#fce7f3,#fbcfe8);padding:20px;border-radius:12px;text-align:center">
                  <div style="font-size:2.2em;font-weight:bold;color:#be185d" id="stats-moy-orga">-</div>
                  <div style="color:#ec4899;font-weight:600;font-size:0.9em">Organisation & Conditions</div>
                </div>
              </div>
              
              <!-- Onglets Statistiques -->
              <div style="display:flex;gap:5px;margin-bottom:15px;border-bottom:2px solid #e2e8f0;padding-bottom:10px">
                <button class="btn btn-sm btn-primary" id="btn-stats-session" onclick="showStatsTab('session')">üìÖ Par Session</button>
                <button class="btn btn-sm btn-secondary" id="btn-stats-entreprise" onclick="showStatsTab('entreprise')">üè¢ Par Entreprise</button>
                <button class="btn btn-sm btn-secondary" id="btn-stats-formation" onclick="showStatsTab('formation')">üìö Par Formation</button>
                <button class="btn btn-sm btn-secondary" id="btn-stats-annee" onclick="showStatsTab('annee')">üìÜ Par Ann√©e</button>
                <button class="btn btn-sm btn-secondary" id="btn-stats-evolution" onclick="showStatsTab('evolution')">üìà √âvolution</button>
              </div>
              
              <!-- Contenu des onglets stats -->
              <div id="stats-tab-session" class="stats-tab-content">
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Session</th>
                        <th>Formation</th>
                        <th>Entreprise</th>
                        <th>Nb √âval</th>
                        <th>Moy. Globale</th>
                        <th>Contenu</th>
                        <th>Orga</th>
                        <th>Recomm.</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="stats-table-session"></tbody>
                  </table>
                </div>
              </div>
              
              <div id="stats-tab-entreprise" class="stats-tab-content" style="display:none">
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Entreprise</th>
                        <th>Nb Sessions</th>
                        <th>Nb √âvaluations</th>
                        <th>Moy. Globale</th>
                        <th>Contenu</th>
                        <th>Orga</th>
                        <th>Recomm.</th>
                        <th>Tendance</th>
                      </tr>
                    </thead>
                    <tbody id="stats-table-entreprise"></tbody>
                  </table>
                </div>
              </div>
              
              <div id="stats-tab-formation" class="stats-tab-content" style="display:none">
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Formation</th>
                        <th>Nb Sessions</th>
                        <th>Nb √âvaluations</th>
                        <th>Moy. Globale</th>
                        <th>Contenu</th>
                        <th>Orga</th>
                        <th>Recomm.</th>
                        <th>Tendance</th>
                      </tr>
                    </thead>
                    <tbody id="stats-table-formation"></tbody>
                  </table>
                </div>
              </div>
              
              <div id="stats-tab-annee" class="stats-tab-content" style="display:none">
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Ann√©e</th>
                        <th>Nb Sessions</th>
                        <th>Nb √âvaluations</th>
                        <th>Moy. Globale</th>
                        <th>Contenu</th>
                        <th>Orga</th>
                        <th>Recomm.</th>
                        <th>√âvolution</th>
                      </tr>
                    </thead>
                    <tbody id="stats-table-annee"></tbody>
                  </table>
                </div>
              </div>
              
              <div id="stats-tab-evolution" class="stats-tab-content" style="display:none">
                <div style="height:300px;background:#f8fafc;border-radius:8px;padding:20px">
                  <canvas id="chart-evolution-satisfaction"></canvas>
                </div>
              </div>
              
            </div>
          </div>
          
          <!-- Onglets types de questionnaires -->
          <div style="display:flex;gap:5px;margin-bottom:15px;flex-wrap:wrap">
            <button class="btn btn-sm" style="background:#3b82f6;color:white" onclick="showSatisfactionTab('chaud')">üî• √Ä Chaud (Stagiaires)</button>
            <button class="btn btn-sm btn-secondary" onclick="showSatisfactionTab('froid')">‚ùÑÔ∏è √Ä Froid (J+60)</button>
            <button class="btn btn-sm btn-secondary" onclick="showSatisfactionTab('financeur')">üí∞ OPCO/Financeurs</button>
            <button class="btn btn-sm btn-secondary" onclick="showSatisfactionTab('formateur')">üë®‚Äçüè´ Formateurs</button>
            <button class="btn btn-sm btn-secondary" onclick="showSatisfactionTab('donneur')">üè¢ Donneurs d'ordre</button>
          </div>
          
          <!-- Tab: Questionnaire √† Chaud -->
          <div id="tab-satisf-chaud" class="satisf-tab">
            <div class="card" style="margin-bottom:15px;padding:15px;background:#f0f9ff;border:1px solid #bae6fd">
              <h4 style="margin:0 0 10px 0;color:#0369a1">üî• Questionnaire √† Chaud - Stagiaires</h4>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;font-size:0.85em">
                <div><strong>Qui :</strong> P√¥le formation, Formateur, Stagiaires</div>
                <div><strong>Quand :</strong> √Ä la fin de chaque session de formation</div>
                <div><strong>Objectif :</strong> Recueillir le niveau de satisfaction sur l'ensemble des aspects de l'action</div>
              </div>
              <div style="margin-top:10px;padding:10px;background:white;border-radius:6px;font-size:0.85em">
                <strong>Processus :</strong> Un questionnaire est soumis aux stagiaires par le formateur. Les stagiaires remettent ensuite les questionnaires compl√©t√©s au formateur qui les adresse au p√¥le formation. Les r√©ponses sont compil√©es dans le fichier AIDAR (Google Sheets).
              </div>
              <div style="margin-top:10px">
                <a href="https://docs.google.com/forms/d/e/1FAIpQLScg5CID_BqjS-k3x6GlewfWfn3-5G-aoHE0b865lEp5S2x0EA/viewform" target="_blank" class="btn btn-sm" style="background:#0369a1;color:white">üìù Lien Google Form</a>
              </div>
            </div>
            <div class="toolbar">
              <div class="search-box"><input type="text" id="search-satisf-chaud" placeholder="Rechercher..." oninput="filterSatisfactions('chaud')"></div>
              <button class="btn btn-primary" onclick="openModalSatisfaction('chaud')">‚ûï Nouveau questionnaire √† chaud</button>
            </div>
            <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Stagiaire</th><th>Session</th><th>Date</th><th>Note Globale</th><th>Contenu</th><th>P√©dagogie</th><th>Conditions</th><th>Recommande</th><th>Actions</th></tr></thead><tbody id="table-satisf-chaud"></tbody></table></div></div>
          </div>
          
          <!-- Tab: Questionnaire √† Froid -->
          <div id="tab-satisf-froid" class="satisf-tab" style="display:none">
            <div class="card" style="margin-bottom:15px;padding:15px;background:#f0fdf4;border:1px solid #86efac">
              <h4 style="margin:0 0 10px 0;color:#166534">‚ùÑÔ∏è Questionnaire √† Froid - Appr√©ciation de la mise en pratique</h4>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;font-size:0.85em">
                <div><strong>Qui :</strong> P√¥le formation, Stagiaires</div>
                <div><strong>Quand :</strong> 2 mois apr√®s la fin de la formation</div>
                <div><strong>Objectif :</strong> √âvaluer la mise en pratique et l'atteinte des objectifs de la formation</div>
              </div>
              <div style="margin-top:10px;padding:10px;background:white;border-radius:6px;font-size:0.85em">
                <strong>Processus :</strong> Questionnaire envoy√© par mail. <em>"Bonjour, Le questionnaire a pour objectif d'√©valuer avec vous la formation que vous aviez pass√©e. Votre avis √©tant pr√©cieux, nous vous demandons de bien vouloir nous accorder deux minutes pour r√©pondre √† notre sondage de satisfaction."</em>
                <br><strong>Relances :</strong> 1√®re relance J+10, 2√®me relance J+30
              </div>
              <div style="margin-top:10px">
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSfri_UdiCbGeF7zo1MkPvp-CaGZtoD28eX3S16wWvjcQondeCJ/formResponse" target="_blank" class="btn btn-sm" style="background:#166534;color:white">üìù Lien Google Form</a>
              </div>
            </div>
            <div class="toolbar">
              <div class="search-box"><input type="text" id="search-satisf-froid" placeholder="Rechercher..." oninput="filterSatisfactions('froid')"></div>
              <div class="filters">
                <select class="filter-select" id="filter-satisf-froid-statut" onchange="filterSatisfactions('froid')">
                  <option value="">Tous statuts</option>
                  <option value="√Ä envoyer">√Ä envoyer</option>
                  <option value="Envoy√©">Envoy√©</option>
                  <option value="Relance 1">Relance 1</option>
                  <option value="Relance 2">Relance 2</option>
                  <option value="R√©pondu">R√©pondu</option>
                </select>
              </div>
              <button class="btn btn-primary" onclick="openModalSatisfaction('froid')">‚ûï Nouveau questionnaire √† froid</button>
              <button class="btn btn-warning" onclick="envoyerRelancesSatisfFroid()">üìß Envoyer relances</button>
            </div>
            <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Stagiaire</th><th>Session</th><th>Date Formation</th><th>Date Envoi</th><th>Statut</th><th>Mise en pratique</th><th>Difficult√©s</th><th>Note</th><th>Actions</th></tr></thead><tbody id="table-satisf-froid"></tbody></table></div></div>
          </div>
          
          <!-- Tab: Questionnaire Financeurs/OPCO -->
          <div id="tab-satisf-financeur" class="satisf-tab" style="display:none">
            <div class="card" style="margin-bottom:15px;padding:15px;background:#fffbeb;border:1px solid #fde047">
              <h4 style="margin:0 0 10px 0;color:#a16207">üí∞ Questionnaire OPCO / Financeurs / Intervenants</h4>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;font-size:0.85em">
                <div><strong>Qui :</strong> OPCO, FAF, Autres financeurs (AKTO, AGEFICE, OPCOEP...)</div>
                <div><strong>Quand :</strong> Apr√®s la premi√®re action, puis annuellement</div>
                <div><strong>Objectif :</strong> Recueillir les √©l√©ments de satisfaction et circonscrire les insatisfactions</div>
              </div>
              <div style="margin-top:10px;padding:10px;background:white;border-radius:6px;font-size:0.85em">
                <strong>Mod√®le e-mail :</strong> <em>"Bonjour, Vous avez r√©cemment financ√© une action de formation de la soci√©t√© [X]. Il est important pour nous que vous puissiez vous exprimer sur l'aspect administratif et financier de cette action."</em>
                <br><strong>Contacts :</strong> 1 fois tous les 6 mois (dans le cas o√π les contacts sont multiples)
                <br><strong>Relances :</strong> Mois de Juin (si pas de r√©ponse: Relance J+30), Mois de D√©cembre (si pas de r√©ponse: Relance J+30)
              </div>
              <div style="margin-top:10px">
                <a href="https://docs.google.com/forms/d/1tcLHT10BqzwiZ2CKFMCSQOoL8Whse-7V2WK69IxWu0Q/edit" target="_blank" class="btn btn-sm" style="background:#a16207;color:white">üìù Lien Google Form</a>
              </div>
            </div>
            <div class="toolbar">
              <div class="search-box"><input type="text" id="search-satisf-financeur" placeholder="Rechercher..." oninput="filterSatisfactions('financeur')"></div>
              <button class="btn btn-primary" onclick="openModalSatisfaction('financeur')">‚ûï Nouveau questionnaire financeur</button>
            </div>
            <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Financeur</th><th>Type</th><th>Session</th><th>Date Envoi</th><th>Statut</th><th>Note Qualit√©</th><th>Communication</th><th>R√©activit√©</th><th>Actions</th></tr></thead><tbody id="table-satisf-financeur"></tbody></table></div></div>
          </div>
          
          <!-- Tab: Questionnaire Formateur -->
          <div id="tab-satisf-formateur" class="satisf-tab" style="display:none">
            <div class="card" style="margin-bottom:15px;padding:15px;background:#faf5ff;border:1px solid #d8b4fe">
              <h4 style="margin:0 0 10px 0;color:#7c3aed">üë®‚Äçüè´ Questionnaire de Satisfaction Formateur</h4>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;font-size:0.85em">
                <div><strong>Qui :</strong> P√¥le formation, Formateur</div>
                <div><strong>Quand :</strong> √Ä la fin de chaque formation</div>
                <div><strong>Objectif :</strong> Recueil des r√©ponses, analyse et compilation des r√©sultats</div>
              </div>
              <div style="margin-top:10px;padding:10px;background:white;border-radius:6px;font-size:0.85em">
                <strong>Processus :</strong> Le formateur re√ßoit le questionnaire de satisfaction avec le dossier aff√©rent avant le d√©but de la formation. Le questionnaire est r√©cup√©r√© √† la fin de la formation avec l'ensemble des documents aff√©rents.
              </div>
            </div>
            <div class="toolbar">
              <div class="search-box"><input type="text" id="search-satisf-formateur" placeholder="Rechercher..." oninput="filterSatisfactions('formateur')"></div>
              <button class="btn btn-primary" onclick="openModalSatisfaction('formateur')">‚ûï Nouveau questionnaire formateur</button>
            </div>
            <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Formateur</th><th>Session</th><th>Date</th><th>Organisation</th><th>Supports</th><th>Stagiaires</th><th>Note Globale</th><th>Commentaires</th><th>Actions</th></tr></thead><tbody id="table-satisf-formateur"></tbody></table></div></div>
          </div>
          
          <!-- Tab: Questionnaire Donneurs d'ordre -->
          <div id="tab-satisf-donneur" class="satisf-tab" style="display:none">
            <div class="card" style="margin-bottom:15px;padding:15px;background:#fef2f2;border:1px solid #fca5a5">
              <h4 style="margin:0 0 10px 0;color:#dc2626">üè¢ Questionnaire Satisfaction Donneurs d'Ordre</h4>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;font-size:0.85em">
                <div><strong>Qui :</strong> P√¥le formation, Donneurs d'ordre</div>
                <div><strong>Quand :</strong> 2 mois apr√®s la fin de la formation</div>
                <div><strong>Objectif :</strong> Croiser les informations avec celles des b√©n√©ficiaires et travailler les axes d'am√©lioration</div>
              </div>
              <div style="margin-top:10px;padding:10px;background:white;border-radius:6px;font-size:0.85em">
                <strong>Mod√®le e-mail :</strong> <em>"Bonjour, Nous esp√©rons que notre formation a permis d'am√©liorer la qualit√© et la productivit√© du travail effectu√© par vos salari√©s. De faire progresser et de d√©velopper leurs comp√©tences n√©cessaires √† l'appr√©hension de leur secteur d'activit√© en g√©n√©ral et aux exigences de qualit√© de leur poste de travail en particulier."</em>
                <br><strong>Relances :</strong> 1√®re relance J+10, 2√®me relance J+30
              </div>
              <div style="margin-top:10px">
                <a href="https://docs.google.com/forms/d/1tcLHT10BqzwiZ2CKFMCSQOoL8Whse-7V2WK69IxWu0Q/edit" target="_blank" class="btn btn-sm" style="background:#dc2626;color:white">üìù Lien Google Form</a>
              </div>
            </div>
            <div class="toolbar">
              <div class="search-box"><input type="text" id="search-satisf-donneur" placeholder="Rechercher..." oninput="filterSatisfactions('donneur')"></div>
              <button class="btn btn-primary" onclick="openModalSatisfaction('donneur')">‚ûï Nouveau questionnaire donneur d'ordre</button>
            </div>
            <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Entreprise</th><th>Contact</th><th>Session</th><th>Date Envoi</th><th>Statut</th><th>Impact Formation</th><th>Comp√©tences</th><th>Note</th><th>Actions</th></tr></thead><tbody id="table-satisf-donneur"></tbody></table></div></div>
          </div>
        </div>
        
        <div class="qualiopi-section" id="quali-reclamations">
          <!-- En-t√™te R√©clamations -->
          <div class="warning-box" style="margin-bottom:15px;border-left:4px solid #ef4444">
            <strong>‚ö†Ô∏è Gestion des R√©clamations (R√©f: DOC VII.30.01)</strong><br>
            <small>Le droit √† r√©clamation est une action qui vise √† faire respecter un droit (ex: droit d'acc√®s aux donn√©es personnelles). Les parties prenantes doivent pouvoir obtenir une r√©ponse en retour de leurs r√©clamations.</small>
          </div>
          
          <!-- KPIs R√©clamations -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px">
            <div style="text-align:center;padding:15px;background:#fee2e2;border-radius:10px">
              <div style="font-size:1.8em;font-weight:700;color:#dc2626" id="kpi-reclam-total">0</div>
              <div style="font-size:0.75em;color:#64748b">Total r√©clamations</div>
            </div>
            <div style="text-align:center;padding:15px;background:#fef3c7;border-radius:10px">
              <div style="font-size:1.8em;font-weight:700;color:#d97706" id="kpi-reclam-encours">0</div>
              <div style="font-size:0.75em;color:#64748b">En cours</div>
            </div>
            <div style="text-align:center;padding:15px;background:#dcfce7;border-radius:10px">
              <div style="font-size:1.8em;font-weight:700;color:#16a34a" id="kpi-reclam-resolues">0</div>
              <div style="font-size:0.75em;color:#64748b">R√©solues</div>
            </div>
            <div style="text-align:center;padding:15px;background:#dbeafe;border-radius:10px">
              <div style="font-size:1.8em;font-weight:700;color:#2563eb" id="kpi-reclam-delai">0j</div>
              <div style="font-size:0.75em;color:#64748b">D√©lai moyen</div>
            </div>
          </div>
          
          <!-- Processus de r√©clamation -->
          <div class="card" style="margin-bottom:15px;padding:15px;background:#fef2f2;border:1px solid #fca5a5">
            <h4 style="margin:0 0 10px 0;color:#991b1b">üìã Processus de traitement des r√©clamations</h4>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;font-size:0.8em">
              <div style="background:white;padding:10px;border-radius:8px;border-left:3px solid #f97316">
                <strong style="color:#f97316">1Ô∏è‚É£ R√©ception</strong><br>
                Enregistrement dans le fichier AIDAR<br>
                Contact √©tabli par t√©l√©phone/mail<br>
                <em>D√©lai: 7 jours max</em>
              </div>
              <div style="background:white;padding:10px;border-radius:8px;border-left:3px solid #eab308">
                <strong style="color:#eab308">2Ô∏è‚É£ Accus√© r√©ception</strong><br>
                Envoi dans un d√©lai max de 3 jours<br>
                √Ä d√©faut: r√©ponse sous ce d√©lai<br>
                <em>D√©lai: 72h</em>
              </div>
              <div style="background:white;padding:10px;border-radius:8px;border-left:3px solid #22c55e">
                <strong style="color:#22c55e">3Ô∏è‚É£ Analyse & Traitement</strong><br>
                Analyse des causes<br>
                Reformulation si n√©cessaire<br>
                <em>D√©lai: 5 jours ouvrables</em>
              </div>
              <div style="background:white;padding:10px;border-radius:8px;border-left:3px solid #3b82f6">
                <strong style="color:#3b82f6">4Ô∏è‚É£ R√©ponse & Cl√¥ture</strong><br>
                R√©ponse au demandeur<br>
                Actions correctives si besoin<br>
                <em>D√©lai: 1 mois max</em>
              </div>
            </div>
            <div style="margin-top:15px;padding:10px;background:#fef9c3;border-radius:6px;font-size:0.85em">
              <strong>üìç Canaux de r√©clamation :</strong> Site internet (formation.des-click.com/formulaire-de-reclamation), courrier postal, e-mail, t√©l√©phone
            </div>
          </div>
          
          <div class="toolbar">
            <div class="search-box"><input type="text" id="search-reclamations" placeholder="Rechercher..." oninput="filterReclamations()"></div>
            <div class="filters">
              <select class="filter-select" id="filter-reclam-statut" onchange="filterReclamations()">
                <option value="">Tous statuts</option>
                <option value="Nouvelle">Nouvelle</option>
                <option value="En cours">En cours</option>
                <option value="En attente">En attente</option>
                <option value="R√©solue">R√©solue</option>
                <option value="Cl√¥tur√©e">Cl√¥tur√©e</option>
              </select>
              <select class="filter-select" id="filter-reclam-urgence" onchange="filterReclamations()">
                <option value="">Toutes urgences</option>
                <option value="Haute">üî¥ Haute</option>
                <option value="Moyenne">üü° Moyenne</option>
                <option value="Basse">üü¢ Basse</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="openModalReclamation()">‚ûï Nouvelle R√©clamation</button>
          </div>
          <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Date</th><th>Origine</th><th>Demandeur</th><th>Objet</th><th>Urgence</th><th>Accus√©</th><th>D√©lai restant</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="table-reclamations"></tbody></table></div></div>
        </div>
        <div class="qualiopi-section" id="quali-attestations">
          <div class="toolbar"><div class="search-box"><input type="text" placeholder="Rechercher..."></div><button class="btn btn-primary" onclick="openModal('attestation')">‚ûï Attestation</button></div>
          <div class="card"><div class="table-container"><table><thead><tr><th>N¬∞</th><th>Stagiaire</th><th>Formation</th><th>Date</th><th>Dur√©e</th><th>Acquis</th><th>Actions</th></tr></thead><tbody id="table-attestations"></tbody></table></div></div>
        </div>
        <div class="qualiopi-section" id="quali-ameliorations">
          <div class="toolbar"><div class="search-box"><input type="text" placeholder="Rechercher..."></div><button class="btn btn-primary" onclick="openModal('amelioration')">‚ûï Action</button></div>
          <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Type</th><th>Origine</th><th>Description</th><th>Responsable</th><th>√âch√©ance</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="table-ameliorations"></tbody></table></div></div>
        </div>
      </div>

      <!-- GED - GESTION ELECTRONIQUE DES DOCUMENTS -->
      <div class="page" id="page-ged">
        <!-- Section Par Entreprise -->
        <div class="ged-section active" id="ged-entreprises">
          <div class="toolbar" style="flex-wrap:wrap;gap:10px">
            <div class="search-box"><input type="text" id="search-ged-ent" placeholder="Rechercher une entreprise..." oninput="filterGEDEntreprises()"></div>
            <button class="btn btn-primary" onclick="uploadDocumentGED()">üì§ Uploader un document</button>
          </div>
          
          <div class="info-box" style="margin:15px 0">
            <strong>üìÅ Archivage par entreprise</strong> - S√©lectionnez une entreprise pour acc√©der √† ses documents class√©s en 3 dossiers : Pr√©formation, Formation, Post-formation
          </div>
          
          <div style="display:grid;grid-template-columns:300px 1fr;gap:20px;margin-top:15px">
            <!-- Liste des entreprises -->
            <div class="card" style="max-height:600px;overflow-y:auto">
              <div class="card-header"><h3 class="card-title">üè¢ Entreprises</h3></div>
              <div id="ged-liste-entreprises" style="padding:10px"></div>
            </div>
            
            <!-- Arborescence des documents -->
            <div class="card">
              <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                <h3 class="card-title" id="ged-entreprise-titre">S√©lectionnez une entreprise</h3>
                <span id="ged-entreprise-count" style="font-size:0.85em;color:#64748b"></span>
              </div>
              
              <div id="ged-arborescence" style="padding:15px">
                <!-- Dossier Pr√©formation -->
                <div class="ged-folder" data-folder="preformation">
                  <div class="ged-folder-header" onclick="toggleGEDFolder('preformation')" style="cursor:pointer;padding:12px;background:#e0f2fe;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:10px">
                    <span class="ged-folder-icon">üìÇ</span>
                    <strong>Pr√©formation</strong>
                    <span class="ged-folder-count" id="ged-count-preformation" style="margin-left:auto;background:#3b82f6;color:white;padding:2px 8px;border-radius:10px;font-size:0.8em">0</span>
                  </div>
                  <div class="ged-folder-content" id="ged-content-preformation" style="display:none;margin-left:20px;margin-bottom:15px">
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üìã Fiche d'analyse et d'√©valuation des besoins</div>
                      <div id="ged-docs-analyse-besoins" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üìä √âvaluations des √©carts de comp√©tences</div>
                      <div id="ged-docs-eval-ecarts" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üí∞ Devis</div>
                      <div id="ged-docs-devis" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üìë Conventions</div>
                      <div id="ged-docs-conventions" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üìß Convocations</div>
                      <div id="ged-docs-convocations" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üì¨ Emails √©chang√©s</div>
                      <div id="ged-docs-emails-pre" class="ged-docs-list"></div>
                    </div>
                  </div>
                </div>
                
                <!-- Dossier Formation -->
                <div class="ged-folder" data-folder="formation">
                  <div class="ged-folder-header" onclick="toggleGEDFolder('formation')" style="cursor:pointer;padding:12px;background:#d1fae5;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:10px">
                    <span class="ged-folder-icon">üìÇ</span>
                    <strong>Formation</strong>
                    <span class="ged-folder-count" id="ged-count-formation" style="margin-left:auto;background:#10b981;color:white;padding:2px 8px;border-radius:10px;font-size:0.8em">0</span>
                  </div>
                  <div class="ged-folder-content" id="ged-content-formation" style="display:none;margin-left:20px;margin-bottom:15px">
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">‚úçÔ∏è Feuilles d'√©margement</div>
                      <div id="ged-docs-emargement" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üìù Tests et Quiz</div>
                      <div id="ged-docs-tests" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üë®‚Äçüè´ Documents formateur</div>
                      <div id="ged-docs-formateur" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üì¨ Emails √©chang√©s</div>
                      <div id="ged-docs-emails-form" class="ged-docs-list"></div>
                    </div>
                  </div>
                </div>
                
                <!-- Dossier Post-formation -->
                <div class="ged-folder" data-folder="postformation">
                  <div class="ged-folder-header" onclick="toggleGEDFolder('postformation')" style="cursor:pointer;padding:12px;background:#fef3c7;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:10px">
                    <span class="ged-folder-icon">üìÇ</span>
                    <strong>Post-formation</strong>
                    <span class="ged-folder-count" id="ged-count-postformation" style="margin-left:auto;background:#f59e0b;color:white;padding:2px 8px;border-radius:10px;font-size:0.8em">0</span>
                  </div>
                  <div class="ged-folder-content" id="ged-content-postformation" style="display:none;margin-left:20px;margin-bottom:15px">
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üìú Attestations de formation</div>
                      <div id="ged-docs-attestations" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">‚≠ê Questionnaires de satisfaction</div>
                      <div id="ged-docs-satisfaction" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üìä Synth√®se des satisfactions</div>
                      <div id="ged-docs-synthese" class="ged-docs-list"></div>
                    </div>
                    <div class="ged-subfolder" style="margin:8px 0;padding:8px;background:#f8fafc;border-radius:6px">
                      <div style="font-weight:500;color:#475569;margin-bottom:5px">üì¨ Emails √©chang√©s</div>
                      <div id="ged-docs-emails-post" class="ged-docs-list"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Section Documents Formation -->
        <div class="ged-section" id="ged-formations">
          <div class="toolbar" style="flex-wrap:wrap;gap:10px">
            <div class="search-box"><input type="text" id="search-ged-form" placeholder="Rechercher..." oninput="filterGEDFormations()"></div>
            <button class="btn btn-primary" onclick="uploadDocumentFormation()">üì§ Uploader</button>
          </div>
          
          <div class="info-box" style="margin:15px 0">
            <strong>üìö Documents g√©n√©raux de formation</strong> - CGV, programmes, livrets d'accueil, supports, questionnaires, etc.
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px;margin-top:15px">
            <!-- CGV -->
            <div class="card">
              <div class="card-header" style="background:#f1f5f9"><h3 class="card-title">üìã CGV</h3></div>
              <div id="ged-cgv" class="ged-doc-grid" style="padding:15px;min-height:100px"></div>
              <div style="padding:10px;border-top:1px solid #e5e7eb"><button class="btn btn-sm btn-primary" onclick="uploadDocGED('cgv')">‚ûï Ajouter</button></div>
            </div>
            
            <!-- Programmes de formation -->
            <div class="card">
              <div class="card-header" style="background:#f1f5f9"><h3 class="card-title">üìñ Programmes de formation</h3></div>
              <div id="ged-programmes" class="ged-doc-grid" style="padding:15px;min-height:100px"></div>
              <div style="padding:10px;border-top:1px solid #e5e7eb"><button class="btn btn-sm btn-primary" onclick="uploadDocGED('programmes')">‚ûï Ajouter</button></div>
            </div>
            
            <!-- Livrets d'accueil -->
            <div class="card">
              <div class="card-header" style="background:#f1f5f9"><h3 class="card-title">üìï Livrets d'accueil stagiaires</h3></div>
              <div id="ged-livrets" class="ged-doc-grid" style="padding:15px;min-height:100px"></div>
              <div style="padding:10px;border-top:1px solid #e5e7eb"><button class="btn btn-sm btn-primary" onclick="uploadDocGED('livrets')">‚ûï Ajouter</button></div>
            </div>
            
            <!-- Supports de formation -->
            <div class="card">
              <div class="card-header" style="background:#f1f5f9"><h3 class="card-title">üìö Supports de formation</h3></div>
              <div id="ged-supports" class="ged-doc-grid" style="padding:15px;min-height:100px"></div>
              <div style="padding:10px;border-top:1px solid #e5e7eb"><button class="btn btn-sm btn-primary" onclick="uploadDocGED('supports')">‚ûï Ajouter</button></div>
            </div>
            
            <!-- Questionnaires de positionnement -->
            <div class="card">
              <div class="card-header" style="background:#f1f5f9"><h3 class="card-title">üìù Questionnaires de positionnement</h3></div>
              <div id="ged-positionnement" class="ged-doc-grid" style="padding:15px;min-height:100px"></div>
              <div style="padding:10px;border-top:1px solid #e5e7eb"><button class="btn btn-sm btn-primary" onclick="uploadDocGED('positionnement')">‚ûï Ajouter</button></div>
            </div>
            
            <!-- Tests interm√©diaires -->
            <div class="card">
              <div class="card-header" style="background:#f1f5f9"><h3 class="card-title">üìã Tests interm√©diaires</h3></div>
              <div id="ged-tests-inter" class="ged-doc-grid" style="padding:15px;min-height:100px"></div>
              <div style="padding:10px;border-top:1px solid #e5e7eb"><button class="btn btn-sm btn-primary" onclick="uploadDocGED('tests-inter')">‚ûï Ajouter</button></div>
            </div>
            
            <!-- Tests finaux -->
            <div class="card">
              <div class="card-header" style="background:#f1f5f9"><h3 class="card-title">‚úÖ Tests finaux</h3></div>
              <div id="ged-tests-finaux" class="ged-doc-grid" style="padding:15px;min-height:100px"></div>
              <div style="padding:10px;border-top:1px solid #e5e7eb"><button class="btn btn-sm btn-primary" onclick="uploadDocGED('tests-finaux')">‚ûï Ajouter</button></div>
            </div>
            
            <!-- √âvaluation des √©carts -->
            <div class="card">
              <div class="card-header" style="background:#f1f5f9"><h3 class="card-title">üìä √âvaluation des √©carts de comp√©tences</h3></div>
              <div id="ged-ecarts" class="ged-doc-grid" style="padding:15px;min-height:100px"></div>
              <div style="padding:10px;border-top:1px solid #e5e7eb"><button class="btn btn-sm btn-primary" onclick="uploadDocGED('ecarts')">‚ûï Ajouter</button></div>
            </div>
          </div>
        </div>
        
        <!-- Section Mod√®les de documents -->
        <div class="ged-section" id="ged-modeles">
          <div class="info-box" style="margin:0 0 20px 0;background:#eff6ff;border:1px solid #3b82f6">
            <strong>üìÅ Mod√®les de documents</strong> - Uploadez ici vos mod√®les vierges (Word, PDF) qui seront utilis√©s pour g√©n√©rer automatiquement les documents dans l'onglet Conception.
            <br><small style="color:#6b7280">Les champs entre {accolades} seront remplac√©s par les donn√©es r√©elles (ex: {ENTREPRISE_NOM}, {FORMATEUR_NOM}, etc.)</small>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px">
            <!-- Mod√®les Formateur -->
            <div class="card" style="border:2px solid #8b5cf6">
              <div class="card-header" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white">
                <h3 class="card-title">üë®‚Äçüè´ Mod√®les Formateur</h3>
                <button class="btn btn-sm" style="background:white;color:#8b5cf6" onclick="afficherAideBalisesFormateur()">‚ùì Balises</button>
              </div>
              <div style="padding:15px">
                <div class="info-box" style="margin-bottom:15px;border-left:4px solid #8b5cf6;font-size:0.8em;padding:10px">
                  <strong>üí°</strong> Uploadez vos mod√®les Word (.docx) avec des balises comme <code>{NOM_FORMATEUR}</code> ou <code>[Nom du formateur]</code>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>üìÑ Ordre de mission</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-ordre_mission-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('ordre_mission')">üì§</button>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>üìß Convocation formateur</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-convocation_formateur-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('convocation_formateur')">üì§</button>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>üìë Contrat formateur externe</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-contrat_formateur-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('contrat_formateur')">üì§</button>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>‚≠ê Questionnaire satisfaction formateur</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-questionnaire_satisfaction_formateur-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('questionnaire_satisfaction_formateur')">üì§</button>
                </div>
              </div>
            </div>
            
            <!-- Mod√®les Stagiaires -->
            <div class="card" style="border:2px solid #10b981">
              <div class="card-header" style="background:linear-gradient(135deg,#10b981,#059669);color:white">
                <h3 class="card-title">üë• Mod√®les Stagiaires</h3>
                <button class="btn btn-sm" style="background:white;color:#10b981" onclick="afficherAideBalisesModele()">‚ùì Balises disponibles</button>
              </div>
              <div style="padding:15px">
                <div class="info-box" style="margin-bottom:15px;border-left:4px solid #10b981;font-size:0.85em">
                  <strong>üí° Conseil :</strong> Uploadez un mod√®le Word (.docx) avec des balises comme <code>{NOM_STAGIAIRE}</code>, <code>{NOM_FORMATION}</code>, etc. 
                  Le syst√®me g√©n√®rera automatiquement un document personnalis√© par stagiaire.
                  <button class="btn btn-sm btn-link" onclick="afficherAideBalisesModele()" style="padding:0;color:#10b981">Voir toutes les balises</button>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>üìß Convocation stagiaire</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-convocation_stagiaire-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('convocation_stagiaire')">üì§</button>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>üìã Questionnaire positionnement</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-questionnaire_positionnement-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('questionnaire_positionnement')">üì§</button>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>‚≠ê Questionnaire satisfaction stagiaire</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-questionnaire_satisfaction_stagiaire-status">Non upload√©</div>
                  </div>
                  <div style="display:flex;gap:5px">
                    <button class="btn btn-sm btn-secondary" onclick="telechargerModeleExemple('questionnaire_satisfaction_stagiaire')" title="T√©l√©charger un mod√®le exemple">üì• Exemple</button>
                    <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('questionnaire_satisfaction_stagiaire')">üì§ Uploader</button>
                  </div>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>‚ùì Quiz</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-quiz-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('quiz')">üì§</button>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>üìù Test final</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-test_final-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('test_final')">üì§</button>
                </div>
              </div>
            </div>
            
            <!-- Mod√®les Session -->
            <div class="card" style="border:2px solid #f59e0b">
              <div class="card-header" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white">
                <h3 class="card-title">üìã Mod√®les Session</h3>
              </div>
              <div style="padding:15px">
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>‚úçÔ∏è Feuille d'√©margement</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-feuille_emargement-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('feuille_emargement')">üì§</button>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>üìö Programme de formation</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-programme_formation-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('programme_formation')">üì§</button>
                </div>
                <div class="modele-item" style="padding:10px;background:#f8fafc;border-radius:8px;display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <strong>üìú Attestation de pr√©sence</strong>
                    <div style="font-size:0.75em;color:#6b7280" id="modele-attestation_presence-status">Non upload√©</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="uploadModeleGED('attestation_presence')">üì§</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Liste des champs disponibles -->
          <div class="card" style="margin-top:20px">
            <div class="card-header"><h3 class="card-title">üìù Champs de fusion disponibles</h3></div>
            <div style="padding:15px">
              <p style="margin:0 0 10px 0;color:#6b7280;font-size:0.9em">Utilisez ces champs dans vos mod√®les Word. Ils seront automatiquement remplac√©s par les donn√©es r√©elles lors de la g√©n√©ration.</p>
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;font-size:0.85em">
                <div>
                  <strong style="color:#3b82f6">Entreprise</strong>
                  <ul style="margin:5px 0 0 0;padding-left:20px;color:#6b7280">
                    <li>{ENTREPRISE_NOM}</li>
                    <li>{ENTREPRISE_ADRESSE}</li>
                    <li>{ENTREPRISE_CP}</li>
                    <li>{ENTREPRISE_VILLE}</li>
                    <li>{ENTREPRISE_CONTACT}</li>
                    <li>{ENTREPRISE_EMAIL}</li>
                  </ul>
                </div>
                <div>
                  <strong style="color:#8b5cf6">Formateur</strong>
                  <ul style="margin:5px 0 0 0;padding-left:20px;color:#6b7280">
                    <li>{FORMATEUR_NOM}</li>
                    <li>{FORMATEUR_PRENOM}</li>
                    <li>{FORMATEUR_EMAIL}</li>
                    <li>{FORMATEUR_TYPE}</li>
                  </ul>
                </div>
                <div>
                  <strong style="color:#10b981">Formation/Session</strong>
                  <ul style="margin:5px 0 0 0;padding-left:20px;color:#6b7280">
                    <li>{FORMATION_NOM}</li>
                    <li>{FORMATION_DUREE}</li>
                    <li>{FORMATION_CODE}</li>
                    <li>{SESSION_DATE_DEBUT}</li>
                    <li>{SESSION_DATE_FIN}</li>
                    <li>{SESSION_LIEU}</li>
                  </ul>
                </div>
                <div>
                  <strong style="color:#f59e0b">PEC/Divers</strong>
                  <ul style="margin:5px 0 0 0;padding-left:20px;color:#6b7280">
                    <li>{PEC_NUMERO}</li>
                    <li>{PEC_OPCO}</li>
                    <li>{PEC_MONTANT}</li>
                    <li>{DATE_JOUR}</li>
                    <li>{STAGIAIRE_NOM}</li>
                    <li>{STAGIAIRE_PRENOM}</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- REFERENTIELS -->
      <div class="page" id="page-referentiels">
        <div class="ref-section active" id="ref-commerciaux">
          <div class="toolbar"><div class="search-box"><input type="text" placeholder="Rechercher..."></div><button class="btn btn-primary" onclick="openModal('commercial')">‚ûï Commercial</button></div>
          <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Nom</th><th>Pr√©nom</th><th>Email</th><th>Objectif CA</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="table-commerciaux"></tbody></table></div></div>
        </div>
        <div class="ref-section" id="ref-formations">
          <div id="qualiopi-formations" class="qualiopi-indicators" style="display:none"></div>
          <div class="toolbar"><div class="search-box"><input type="text" placeholder="Rechercher..."></div><button class="btn btn-primary" onclick="openModal('formation')">‚ûï Formation</button></div>
          <div class="card"><div class="table-container"><table><thead><tr><th>Code</th><th>Intitul√©</th><th>Domaine</th><th>Dur√©e</th><th>Prix HT</th><th>Certification</th><th>Actions</th></tr></thead><tbody id="table-formations"></tbody></table></div></div>
        </div>
        <div class="ref-section" id="ref-formateurs">
          <div id="qualiopi-formateurs" class="qualiopi-indicators" style="display:none"></div>
          <div class="toolbar" style="flex-wrap:wrap;gap:10px">
            <div class="search-box"><input type="text" placeholder="Rechercher..."></div>
            <select class="filter-select" id="filter-type-formateur" onchange="showTable('formateurs')">
              <option value="">Tous les types</option>
              <option value="Interne">üè¢ Internes</option>
              <option value="Externe">üåê Externes</option>
            </select>
            <button class="btn btn-info" onclick="ouvrirGestionAbsences()">üìÖ G√©rer les absences</button>
            <button class="btn btn-primary" onclick="openModal('formateur')">‚ûï Formateur</button>
          </div>
          
          <!-- Absences en cours -->
          <div id="absences-en-cours" style="display:none;margin:15px 0">
            <div class="card" style="border-left:4px solid #f59e0b">
              <div class="card-header" style="background:#fffbeb;padding:10px 15px">
                <h4 style="margin:0;color:#b45309;font-size:0.9em">‚ö†Ô∏è Absences en cours ou √† venir</h4>
              </div>
              <div id="liste-absences-en-cours" style="padding:10px"></div>
            </div>
          </div>
          
          <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Nom</th><th>Sp√©cialit√©s</th><th>Tarif J.</th><th>Type</th><th>Statut</th><th>Disponibilit√©</th><th>Actions</th></tr></thead><tbody id="table-formateurs"></tbody></table></div></div>
        </div>
        <div class="ref-section" id="ref-lieux">
          <div class="toolbar"><div class="search-box"><input type="text" placeholder="Rechercher..."></div><button class="btn btn-primary" onclick="openModal('lieu')">‚ûï Lieu</button></div>
          <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>Nom</th><th>Ville</th><th>Capacit√©</th><th>PMR</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="table-lieux"></tbody></table></div></div>
        </div>
        <div class="ref-section" id="ref-materiel">
          <div class="toolbar"><div class="search-box"><input type="text" placeholder="Rechercher..."></div><button class="btn btn-primary" onclick="openModal('materiel')">‚ûï Mat√©riel</button></div>
          <div class="card"><div class="table-container"><table><thead><tr><th>ID</th><th>D√©signation</th><th>Cat√©gorie</th><th>Quantit√©</th><th>√âtat</th><th>Actions</th></tr></thead><tbody id="table-materiel"></tbody></table></div></div>
        </div>
        
        <!-- Section IDCC -->
        <div class="ref-section" id="ref-idcc">
          <div class="toolbar" style="flex-wrap:wrap;gap:10px">
            <div class="search-box"><input type="text" id="search-idcc" placeholder="Rechercher un IDCC..." oninput="filterIDCC()"></div>
            <button class="btn btn-primary" onclick="openModalIDCC()">‚ûï Ajouter un IDCC</button>
            <button class="btn btn-success" onclick="exporterIDCCCSV()">üìä Exporter CSV</button>
            <button class="btn btn-secondary" onclick="initialiserIDCCDefaut()">üîÑ R√©initialiser par d√©faut</button>
          </div>
          
          <div class="info-box" style="margin:15px 0">
            <strong>üìã IDCC - Identifiant des Conventions Collectives</strong><br>
            <small>Liste des conventions collectives utilis√©es pour identifier l'OPCO des entreprises. Code √† 4 chiffres attribu√© par le Minist√®re du Travail.</small>
          </div>
          
          <div class="card">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th style="width:80px">Code IDCC</th>
                    <th>Intitul√© de la Convention Collective</th>
                    <th style="width:150px">OPCO</th>
                    <th style="width:120px">Secteur</th>
                    <th style="width:100px">Statut</th>
                    <th style="width:120px">Actions</th>
                  </tr>
                </thead>
                <tbody id="table-idcc"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ADMIN -->
      <div class="page" id="page-admin">
        <div class="qualiopi-section active" id="admin-gestionnaires">
          <div class="toolbar" style="flex-wrap:wrap;gap:10px">
            <div class="search-box"><input type="text" id="search-gestionnaires" placeholder="Rechercher..." oninput="filterGestionnaires()"></div>
            <select class="filter-select" id="filter-role" onchange="filterGestionnaires()">
              <option value="">Tous les r√¥les</option>
              <option value="Admin">üëë Admin</option>
              <option value="Gestionnaire">üë§ Gestionnaire</option>
              <option value="Commercial">üíº Commercial</option>
              <option value="Formateur">üë®‚Äçüè´ Formateur</option>
            </select>
            <button class="btn btn-primary" onclick="openModal('gestionnaire')">‚ûï Utilisateur</button>
          </div>
          
          <div class="card" style="margin-top:15px">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Identifiant</th>
                    <th>Nom</th>
                    <th>Pr√©nom</th>
                    <th>Email</th>
                    <th>R√¥le</th>
                    <th>Statut</th>
                    <th>Derni√®re Connexion</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="table-gestionnaires"></tbody>
              </table>
            </div>
          </div>
          
          <!-- Section Permissions par r√¥le -->
          <div class="card" style="margin-top:20px">
            <div class="card-header">
              <h3 class="card-title">üîê Gestion des Permissions par R√¥le</h3>
            </div>
            <div style="padding:20px">
              <div style="display:flex;gap:15px;margin-bottom:20px">
                <button class="btn btn-secondary" onclick="showPermissionsRole('Gestionnaire')" id="btn-perm-gestionnaire">üë§ Gestionnaire</button>
                <button class="btn btn-secondary" onclick="showPermissionsRole('Commercial')" id="btn-perm-commercial">üíº Commercial</button>
                <button class="btn btn-secondary" onclick="showPermissionsRole('Formateur')" id="btn-perm-formateur">üë®‚Äçüè´ Formateur</button>
              </div>
              
              <div id="permissions-grid" style="display:none">
                <h4 style="margin-bottom:15px" id="permissions-role-title">Permissions pour : </h4>
                <div class="table-container">
                  <table style="font-size:0.85em">
                    <thead>
                      <tr>
                        <th style="width:200px">Onglet</th>
                        <th style="text-align:center;width:100px">üëÅÔ∏è Afficher</th>
                        <th style="text-align:center;width:100px">üìñ Consulter</th>
                        <th style="text-align:center;width:100px">‚úèÔ∏è √âditer</th>
                      </tr>
                    </thead>
                    <tbody id="permissions-tbody">
                      <tr data-module="dashboard"><td>üìä Tableau de bord</td><td style="text-align:center"><input type="checkbox" class="perm-afficher" checked></td><td style="text-align:center"><input type="checkbox" class="perm-consulter" checked></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="demandes"><td>üì© Demandes</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="entreprises"><td>üè¢ Entreprises</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="contacts"><td>üë• Contacts</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="stagiaires"><td>üéì Stagiaires</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="opportunites"><td>üéØ Opportunit√©s</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="analyse"><td>üìã Analyse</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="evaluation"><td>üìä √âvaluation</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="devis"><td>üí∞ Devis</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="conventions"><td>üìë Conventions</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="sessions"><td>üìÖ Sessions</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="agendaSessions"><td>üóìÔ∏è Agenda Sessions</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="agendaGeneral"><td>üìÜ Agenda G√©n√©ral</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="suivi"><td>üìà Suivi</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="messagerie"><td>üí¨ Messagerie</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="dpc"><td>üìÑ Prise en Charge</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="conception"><td>‚úèÔ∏è Conception</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="qualiopi"><td>üèÜ Qualiopi</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="ged"><td>üìÅ GED</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                      <tr data-module="referentiels"><td>‚öôÔ∏è R√©f√©rentiels</td><td style="text-align:center"><input type="checkbox" class="perm-afficher"></td><td style="text-align:center"><input type="checkbox" class="perm-consulter"></td><td style="text-align:center"><input type="checkbox" class="perm-editer"></td></tr>
                    </tbody>
                  </table>
                </div>
                <div style="margin-top:15px;display:flex;gap:10px">
                  <button class="btn btn-primary" onclick="savePermissions()">üíæ Enregistrer les permissions</button>
                  <button class="btn btn-secondary" onclick="resetPermissions()">üîÑ R√©initialiser</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="qualiopi-section" id="admin-historique">
          <div class="card"><div class="card-header"><h3 class="card-title">üìú Historique</h3><button class="btn btn-secondary btn-sm" onclick="clearHistory()">üóëÔ∏è Vider</button></div><div id="historique-list"></div></div>
        </div>
        <div class="qualiopi-section" id="admin-parametres">
          <div class="card">
            <div class="card-header"><h3 class="card-title">‚öôÔ∏è Param√®tres Organisme</h3></div>
            <div class="form-row"><div class="form-group"><label class="form-label">Nom de l'organisme</label><input class="form-input" id="param-nom" value="Formation DesClick"></div><div class="form-group"><label class="form-label">N¬∞ D√©claration Activit√©</label><input class="form-input" id="param-nda"></div></div>
            <div class="form-row"><div class="form-group"><label class="form-label">SIRET</label><input class="form-input" id="param-siret"></div><div class="form-group"><label class="form-label">N¬∞ Qualiopi</label><input class="form-input" id="param-qualiopi"></div></div>
            <div class="form-row"><div class="form-group"><label class="form-label">Adresse</label><input class="form-input" id="param-adresse"></div><div class="form-group"><label class="form-label">Email</label><input class="form-input" id="param-email" type="email"></div></div>
            <button class="btn btn-primary" onclick="saveParams()">üíæ Enregistrer</button>
          </div>
          <div class="card" style="margin-top:1rem;border:2px solid #3b82f6">
            <div class="card-header" style="background:#eff6ff"><h3 class="card-title" style="color:#1d4ed8">üîÑ Recharger les donn√©es de d√©monstration</h3></div>
            <div style="padding:1rem">
              <p style="margin-bottom:1rem;color:var(--gray-600);font-size:0.8rem">Vider la base de donn√©es et recharger les donn√©es de d√©monstration compl√®tes (20 demandes, formateurs, formations, sessions, disponibilit√©s, etc.).</p>
              <button class="btn btn-primary" onclick="rechargerDemoData()" style="background:#3b82f6">üîÑ Vider le cache et recharger les donn√©es d√©mo</button>
            </div>
          </div>
          <div class="card" style="margin-top:1rem;border:2px solid #f87171">
            <div class="card-header" style="background:#fef2f2"><h3 class="card-title" style="color:#dc2626">üóëÔ∏è R√©initialisation Base de Donn√©es</h3></div>
            <div style="padding:1rem">
              <p style="margin-bottom:1rem;color:var(--gray-600);font-size:0.8rem">Si vous rencontrez des erreurs (notamment avec les emails ou nouveaux stores), vous pouvez r√©initialiser la base de donn√©es. <strong style="color:#dc2626">‚ö†Ô∏è Attention : toutes les donn√©es seront perdues !</strong></p>
              <button class="btn btn-danger" onclick="reinitialiserDB()">üóëÔ∏è R√©initialiser la base de donn√©es</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL PRINCIPAL -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="modal-title">Formulaire</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveModal()">üíæ Enregistrer</button></div>
    </div>
  </div>

  <!-- MODAL COLLER EMAIL -->
  <div class="modal-overlay" id="modal-parse">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">üìã Coller le contenu de l'email</h3><button class="modal-close" onclick="closeParseModal()">√ó</button></div>
      <div class="modal-body">
        <div class="info-box">Copiez-collez le contenu de l'email re√ßu depuis le formulaire de contact du site DesClick. Le syst√®me extraira automatiquement les informations.</div>
        <div class="form-group">
          <label class="form-label">Contenu de l'email</label>
          <textarea class="form-textarea" id="email-content" style="min-height:200px" placeholder="Collez ici le contenu de l'email...

Exemple de format attendu:
Nom : Dupont
Pr√©nom : Marie
Email : marie.dupont@entreprise.fr
T√©l√©phone : 06 12 34 56 78
Raison sociale : Ma Soci√©t√© SAS
Num√©ro de SIREN : 123456789
Adresse : 10 rue de la Formation
Code postal : 75001
Ville : Paris
Nous sommes int√©ress√©s par les formations : Management, Excel, 
Communication, Gestion du temps
Besoins sp√©cifiques : Formation pour 10 collaborateurs
sur 2 jours, si possible en pr√©sentiel
Message : Nous souhaitons former notre √©quipe aux techniques 
de management moderne. Merci de nous recontacter rapidement."></textarea>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeParseModal()">Annuler</button><button class="btn btn-primary" onclick="parseEmail()">üì© Extraire les donn√©es</button></div>
    </div>
  </div>

  <!-- MODAL CONFIRM -->
  <div class="modal-overlay" id="modal-confirm">
    <div class="modal" style="max-width:350px">
      <div class="modal-header"><h3 class="modal-title">‚ö†Ô∏è Confirmation</h3><button class="modal-close" onclick="closeConfirm()">√ó</button></div>
      <div class="modal-body"><p id="confirm-msg">√ätes-vous s√ªr ?</p></div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeConfirm()">Annuler</button><button class="btn btn-danger" id="confirm-btn">üóëÔ∏è Supprimer</button></div>
    </div>
  </div>

  <!-- Modal Email Analyse -->
  <div class="modal-overlay" id="modal-email-analyse">
    <div class="modal" style="max-width:700px">
      <div class="modal-header"><h3 class="modal-title">üìß Email - Questionnaire d'√©valuation des besoins</h3><button class="modal-close" onclick="closeEmailAnalyse()">√ó</button></div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Destinataire</label>
          <input class="form-input" id="email-analyse-dest" type="email" placeholder="email@exemple.com">
        </div>
        <div class="form-group">
          <label class="form-label">Objet</label>
          <input class="form-input" id="email-analyse-sujet" readonly style="background:var(--gray-100)">
        </div>
        <div class="form-group">
          <label class="form-label">Corps du message</label>
          <textarea class="form-textarea" id="email-analyse-corps" rows="15" style="font-family:monospace;font-size:0.8rem"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEmailAnalyse()">Annuler</button>
        <button class="btn btn-info" onclick="copierEmailAnalyse()">üìã Copier</button>
        <button class="btn btn-primary" onclick="envoyerEmailAnalyse()">üì§ Ajouter √† la bo√Æte d'envoi</button>
      </div>
    </div>
  </div>

  <!-- Modal Import Google Sheets -->
  <div class="modal-overlay" id="modal-import-sheets">
    <div class="modal" style="max-width:800px">
      <div class="modal-header"><h3 class="modal-title">üìã Import depuis Google Sheets</h3><button class="modal-close" onclick="closeImportSheets()">√ó</button></div>
      <div class="modal-body">
        <div style="background:var(--blue-50);padding:1rem;border-radius:8px;margin-bottom:1rem">
          <h4 style="font-size:.8rem;color:var(--blue-700);margin-bottom:.5rem">üìå Instructions</h4>
          <ol style="font-size:.75rem;color:var(--gray-600);margin:0;padding-left:1.2rem">
            <li>Ouvrez le Google Sheets des r√©ponses : <a href="https://docs.google.com/spreadsheets/d/1y8G5t4O3CSo9AFg4EarO_hPx6YuJrSBv6KnN-e58zMU/edit?resourcekey=&gid=996057656#gid=996057656" target="_blank" style="color:var(--primary)">Cliquez ici</a></li>
            <li>S√©lectionnez la ligne de la r√©ponse souhait√©e (de A √† la derni√®re colonne)</li>
            <li>Copiez (Ctrl+C)</li>
            <li>Collez ci-dessous (Ctrl+V)</li>
          </ol>
        </div>
        <div class="form-group">
          <label class="form-label">Collez les donn√©es ici (s√©par√©es par tabulations)</label>
          <textarea class="form-textarea" id="import-sheets-data" rows="6" placeholder="Collez ici les donn√©es copi√©es depuis Google Sheets..."></textarea>
        </div>
        <div id="import-preview" style="display:none;background:var(--gray-50);padding:1rem;border-radius:8px;max-height:300px;overflow-y:auto">
          <h4 style="font-size:.75rem;color:var(--gray-600);margin-bottom:.5rem">üëÅÔ∏è Aper√ßu des donn√©es</h4>
          <div id="import-preview-content" style="font-size:.7rem"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeImportSheets()">Annuler</button>
        <button class="btn btn-info" onclick="previsualiserImport()">üëÅÔ∏è Pr√©visualiser</button>
        <button class="btn btn-primary" onclick="appliquerImport()">‚úÖ Appliquer</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toasts"></div>
  <input type="file" id="import-file" accept=".json" style="display:none">

<script>
// ============ CONFIG ============
const STORES=['entreprises','opportunites','analyses','evaluations','devis','conventions','actions','dpc','conceptions','stagiaires','commerciaux','formations','formateurs','lieux','materiel','sessions','gestionnaires','emargements','evalPre','evalPost','satisfactions','satisfactions_chaud','satisfactions_froid','satisfactions_financeur','satisfactions_formateur','satisfactions_donneur','reclamations','aidar','ecarts_questions','ecarts_evaluations','attestations','ameliorations','demandes','emails','historique','parametres','messages','utilisateurs','ged_documents','qualiopi_docs','agenda_events','absences_formateurs','veille','sources_veille','post_formation_docs','proces_verbaux','certificats_realisation','eval_chaud_session','idcc'];
let db,currentUser=null;

// Comptes utilisateurs par d√©faut
const USERS_DEFAULT=[
  {username:'admin',password:'admin',nom:'Administrateur',prenom:'Super',role:'Admin',email:'admin@desclick.fr'},
  {username:'gestionnaire',password:'gest',nom:'Martin',prenom:'Sophie',role:'Gestionnaire',email:'sophie.martin@desclick.fr'},
  {username:'commercial',password:'comm',nom:'Dupont',prenom:'Jean',role:'Commercial',email:'jean.dupont@desclick.fr'},
  {username:'formateur',password:'form',nom:'Bernard',prenom:'Pierre',role:'Formateur',email:'pierre.bernard@desclick.fr'}
];

// ============ AUTH ============
function hashPassword(pwd){let h=0;for(let i=0;i<pwd.length;i++){h=((h<<5)-h)+pwd.charCodeAt(i);h|=0;}return h.toString(16);}

async function login(username,password,role){
  // V√©rifier d'abord les comptes par d√©faut
  const defaultUser=USERS_DEFAULT.find(u=>u.username===username&&u.password===password);
  if(defaultUser){
    // V√©rifier que le r√¥le correspond
    if(role&&role!==defaultUser.role){
      return false;
    }
    currentUser={
      id:0,
      ...defaultUser,
      statut:'Actif',
      lastLogin:new Date().toISOString()
    };
    localStorage.setItem('currentUser',JSON.stringify(currentUser));
    showApp();
    return true;
  }
  
  // Sinon v√©rifier dans la base de donn√©es
  const users=await dbGetAll('gestionnaires');
  const hash=hashPassword(password);
  const user=users.find(u=>u.username===username&&(u.password===hash||u.password===password)&&u.statut==='Actif');
  if(user){
    if(role&&role!==user.role){
      return false;
    }
    currentUser=user;
    user.lastLogin=new Date().toISOString();
    await dbPut('gestionnaires',user);
    localStorage.setItem('currentUser',JSON.stringify({id:user.id}));
    showApp();
    return true;
  }
  return false;
}

function logout(){currentUser=null;localStorage.removeItem('currentUser');document.getElementById('login-page').style.display='flex';document.getElementById('app').classList.remove('active');}

async function checkAuth(){
  const saved=localStorage.getItem('currentUser');
  if(saved){
    const savedUser=JSON.parse(saved);
    // V√©rifier si c'est un compte par d√©faut
    if(savedUser.username){
      const defaultUser=USERS_DEFAULT.find(u=>u.username===savedUser.username);
      if(defaultUser){
        currentUser=savedUser;
        showApp();
        return;
      }
    }
    // Sinon v√©rifier dans la base
    if(savedUser.id){
      const user=await dbGet('gestionnaires',savedUser.id);
      if(user&&user.statut==='Actif'){currentUser=user;showApp();return;}
    }
  }
  document.getElementById('login-page').style.display='flex';
}

function showApp(){
  document.getElementById('login-page').style.display='none';
  document.getElementById('app').classList.add('active');
  document.getElementById('user-name').textContent=`${currentUser.prenom||''} ${currentUser.nom||currentUser.username}`;
  document.getElementById('user-role').textContent=getRoleLabel(currentUser.role);
  
  // G√©rer les acc√®s selon le r√¥le
  const isAdmin=currentUser.role==='Admin';
  const isGestionnaire=currentUser.role==='Gestionnaire';
  const isCommercial=currentUser.role==='Commercial';
  const isFormateur=currentUser.role==='Formateur';
  
  document.getElementById('nav-admin').style.display=isAdmin?'':'none';
  
  // Masquer certains onglets selon le r√¥le
  document.querySelectorAll('.nav-item').forEach(item=>{
    const page=item.dataset.page;
    let visible=true;
    
    if(isFormateur){
      // Formateurs: acc√®s limit√©
      visible=['dashboard','sessions','stagiaires','messagerie','qualiopi','agenda'].includes(page);
    }else if(isCommercial){
      // Commerciaux: acc√®s commercial
      visible=['dashboard','demandes','emails','entreprises','opportunites','analyse-eval','documents','messagerie'].includes(page);
    }
    
    if(!visible) item.style.display='none';
    else item.style.display='';
  });
  
  loadPage('dashboard');
}

function getRoleLabel(role){
  switch(role){
    case 'Admin':return 'üëë Administrateur';
    case 'Gestionnaire':return 'üë§ Gestionnaire';
    case 'Commercial':return 'üë®‚Äçüíº Commercial';
    case 'Formateur':return 'üë®‚Äçüè´ Formateur';
    default:return role||'Utilisateur';
  }
}

// ============ DB ============
async function initDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open('CRMDesClick',17);
    r.onerror=()=>rej(r.error);
    r.onsuccess=()=>{
      db=r.result;
      // V√©rifier que tous les stores existent
      const missingStores=STORES.filter(s=>!db.objectStoreNames.contains(s));
      if(missingStores.length>0){
        console.error('‚ùå Stores manquants:',missingStores);
        db.close();
        // Supprimer et recr√©er la base
        const deleteReq=indexedDB.deleteDatabase('CRMDesClick');
        deleteReq.onsuccess=()=>{
          console.log('Base supprim√©e, rechargement...');
          location.reload();
        };
        deleteReq.onerror=()=>rej(new Error('Impossible de r√©initialiser la base'));
        return;
      }
      res(db);
    };
    r.onupgradeneeded=e=>{
      const d=e.target.result;
      STORES.forEach(s=>{
        if(!d.objectStoreNames.contains(s))d.createObjectStore(s,{keyPath:'id',autoIncrement:true});
      });
    };
  });
}

// R√©initialiser la base de donn√©es
async function reinitialiserDB(){
  if(!confirm('‚ö†Ô∏è Attention: Cette action va supprimer TOUTES les donn√©es du CRM.\n\nVoulez-vous vraiment r√©initialiser la base de donn√©es ?'))return;
  if(!confirm('Derni√®re confirmation: Toutes les demandes, entreprises, emails, etc. seront perdus.\n\nContinuer ?'))return;
  try{
    db.close();
    const deleteReq=indexedDB.deleteDatabase('CRMDesClick');
    deleteReq.onsuccess=()=>{toast('Base supprim√©e. Rechargement...','success');setTimeout(()=>location.reload(),1000);};
    deleteReq.onerror=()=>{toast('Erreur lors de la suppression','error');};
  }catch(err){console.error(err);toast('Erreur: '+err.message,'error');}
}

async function rechargerDemoData(){
  if(!confirm('üîÑ Vider toutes les donn√©es et recharger les donn√©es de d√©monstration compl√®tes ?\n\n(20 demandes, 6 formateurs, 10 formations, 8 sessions, disponibilit√©s, etc.)'))return;
  try{
    toast('Suppression en cours...','info');
    db.close();
    const deleteReq=indexedDB.deleteDatabase('CRMDesClick');
    deleteReq.onsuccess=async()=>{
      toast('Base supprim√©e. Rechargement des donn√©es d√©mo...','success');
      setTimeout(()=>location.reload(),1000);
    };
    deleteReq.onerror=()=>{toast('Erreur lors de la suppression','error');};
  }catch(err){console.error(err);toast('Erreur: '+err.message,'error');}
}


async function dbAdd(s,d){
  return new Promise((res,rej)=>{
    try{
      const t=db.transaction(s,'readwrite');
      d.dateCreation=d.dateCreation||new Date().toISOString();
      const r=t.objectStore(s).add(d);
      r.onsuccess=()=>res(r.result);
      r.onerror=(e)=>{console.error('dbAdd error:',s,e);rej(r.error);}
    }catch(err){
      console.error('dbAdd exception:',s,err);
      rej(err);
    }
  });
}
async function dbPut(s,d){return new Promise((res,rej)=>{const t=db.transaction(s,'readwrite');const r=t.objectStore(s).put(d);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})}
async function dbGet(s,id){return new Promise((res,rej)=>{const t=db.transaction(s,'readonly');const r=t.objectStore(s).get(id);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})}
async function dbGetAll(s){return new Promise((res,rej)=>{const t=db.transaction(s,'readonly');const r=t.objectStore(s).getAll();r.onsuccess=()=>res(r.result||[]);r.onerror=()=>rej(r.error)})}
async function dbDelete(s,id){return new Promise((res,rej)=>{const t=db.transaction(s,'readwrite');const r=t.objectStore(s).delete(id);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})}
async function dbClear(s){
  return new Promise((res,rej)=>{
    try{
      const t=db.transaction(s,'readwrite');
      const r=t.objectStore(s).clear();
      r.onsuccess=()=>res();
      r.onerror=(e)=>{console.error('dbClear error:',s,e);rej(r.error);}
    }catch(err){
      console.error('dbClear exception:',s,err);
      rej(err);
    }
  });
}

// R√©initialiser compl√®tement la base de donn√©es
function reinitialiserBase(){
  if(!confirm('‚ö†Ô∏è R√©initialiser la base de donn√©es ?\n\nToutes les donn√©es seront supprim√©es et l\'application sera recharg√©e.'))return;
  try{
    // Fermer la connexion existante
    if(db){
      db.close();
    }
    // Supprimer la base de donn√©es
    const deleteReq=indexedDB.deleteDatabase('CRMDesClick');
    deleteReq.onsuccess=()=>{
      console.log('‚úÖ Base de donn√©es supprim√©e');
      alert('Base de donn√©es r√©initialis√©e. La page va se recharger.');
      location.reload();
    };
    deleteReq.onerror=(e)=>{
      console.error('Erreur suppression:',e);
      alert('Erreur lors de la suppression. Essayez de vider le cache du navigateur.');
    };
    deleteReq.onblocked=()=>{
      console.warn('Suppression bloqu√©e - fermeture des autres onglets...');
      alert('Fermez tous les autres onglets de cette application puis r√©essayez.');
    };
  }catch(err){
    console.error('Erreur reinitialiserBase:',err);
    alert('Erreur: '+err.message);
  }
}

// ============ NAV ============
let currentPage='dashboard',currentRef='commerciaux',currentQuali='indicateurs',currentAdmin='gestionnaires',currentGed='entreprises',currentAnalyseEval='analyse',currentAgenda='agenda-sessions',currentDocuments='devis',currentSuivi='suivi-workflow',currentAction='entreprises',currentModal=null,editId=null;

function showPage(p){
  document.querySelectorAll('#main-nav .nav-item').forEach(i=>i.classList.remove('active'));
  document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
  
  // G√©rer les onglets parents avec sous-navigation
  let actualPage=p;
  if(p==='action-formation'){
    actualPage=currentAction;
  }else if(p==='analyse-eval'){
    actualPage=currentAnalyseEval;
  }else if(p==='agenda'){
    actualPage=currentAgenda;
  }else if(p==='documents'){
    actualPage=currentDocuments;
  }else if(p==='suivi'){
    actualPage=currentSuivi;
  }
  
  const navItem=document.querySelector('#main-nav .nav-item[data-page="'+p+'"]');
  if(navItem)navItem.classList.add('active');
  const pageEl=document.getElementById('page-'+actualPage);
  if(pageEl)pageEl.classList.add('active');
  
  // Afficher/masquer les sous-navigations
  document.getElementById('sub-nav-action-formation').classList.toggle('active',p==='action-formation');
  document.getElementById('sub-nav-ref').classList.toggle('active',p==='referentiels');
  document.getElementById('sub-nav-qualiopi').classList.toggle('active',p==='qualiopi');
  document.getElementById('sub-nav-admin').classList.toggle('active',p==='admin');
  document.getElementById('sub-nav-ged').classList.toggle('active',p==='ged');
  document.getElementById('sub-nav-analyse-eval').classList.toggle('active',p==='analyse-eval');
  document.getElementById('sub-nav-agenda').classList.toggle('active',p==='agenda');
  document.getElementById('sub-nav-documents').classList.toggle('active',p==='documents');
  document.getElementById('sub-nav-suivi').classList.toggle('active',p==='suivi');
  
  currentPage=p;
  loadPage(actualPage);
}

function setupNav(){
  document.querySelectorAll('#main-nav .nav-item').forEach(item=>{
    item.addEventListener('click',()=>{
      if(item.classList.contains('disabled'))return;
      const p=item.dataset.page;if(!p)return;
      showPage(p);
    });
  });
  
  // Sous-nav Analyse & √âvaluation
  document.querySelectorAll('#sub-nav-analyse-eval .sub-nav-item').forEach(item=>{
    item.addEventListener('click',()=>{
      const section=item.dataset.section;
      document.querySelectorAll('#sub-nav-analyse-eval .sub-nav-item').forEach(i=>i.classList.remove('active'));
      document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
      item.classList.add('active');
      document.getElementById('page-'+section).classList.add('active');
      currentAnalyseEval=section;
      loadPage(section);
    });
  });
  
  // Sous-nav Action de formation
  document.querySelectorAll('#sub-nav-action-formation .sub-nav-item').forEach(item=>{
    item.addEventListener('click',()=>{
      const action=item.dataset.action;
      document.querySelectorAll('#sub-nav-action-formation .sub-nav-item').forEach(i=>i.classList.remove('active'));
      document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
      item.classList.add('active');
      document.getElementById('page-'+action).classList.add('active');
      currentAction=action;
      loadPage(action);
    });
  });
  
  // Sous-nav Agenda
  document.querySelectorAll('#sub-nav-agenda .sub-nav-item').forEach(item=>{
    item.addEventListener('click',()=>{
      const section=item.dataset.section;
      document.querySelectorAll('#sub-nav-agenda .sub-nav-item').forEach(i=>i.classList.remove('active'));
      document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
      item.classList.add('active');
      document.getElementById('page-'+section).classList.add('active');
      currentAgenda=section;
      loadPage(section);
    });
  });
  
  // Sous-nav Documents contractuels
  document.querySelectorAll('#sub-nav-documents .sub-nav-item').forEach(item=>{
    item.addEventListener('click',()=>{
      const section=item.dataset.section;
      document.querySelectorAll('#sub-nav-documents .sub-nav-item').forEach(i=>i.classList.remove('active'));
      document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
      item.classList.add('active');
      document.getElementById('page-'+section).classList.add('active');
      currentDocuments=section;
      loadPage(section);
    });
  });
  
  // Sous-nav Suivi
  document.querySelectorAll('#sub-nav-suivi .sub-nav-item').forEach(item=>{
    item.addEventListener('click',()=>{
      const section=item.dataset.section;
      document.querySelectorAll('#sub-nav-suivi .sub-nav-item').forEach(i=>i.classList.remove('active'));
      document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
      item.classList.add('active');
      document.getElementById('page-'+section).classList.add('active');
      currentSuivi=section;
      loadPage(section);
    });
  });
  
  document.querySelectorAll('#sub-nav-ref .sub-nav-item').forEach(item=>{item.addEventListener('click',()=>{const r=item.dataset.ref;document.querySelectorAll('#sub-nav-ref .sub-nav-item').forEach(i=>i.classList.remove('active'));document.querySelectorAll('.ref-section').forEach(s=>s.classList.remove('active'));item.classList.add('active');document.getElementById('ref-'+r).classList.add('active');currentRef=r;loadRef(r);});});
  document.querySelectorAll('#sub-nav-qualiopi .sub-nav-item').forEach(item=>{item.addEventListener('click',()=>{const q=item.dataset.quali;document.querySelectorAll('#sub-nav-qualiopi .sub-nav-item').forEach(i=>i.classList.remove('active'));document.querySelectorAll('.qualiopi-section').forEach(s=>s.classList.remove('active'));item.classList.add('active');document.getElementById('quali-'+q).classList.add('active');currentQuali=q;loadQuali(q);});});
  document.querySelectorAll('#sub-nav-admin .sub-nav-item').forEach(item=>{item.addEventListener('click',()=>{const a=item.dataset.admin;document.querySelectorAll('#sub-nav-admin .sub-nav-item').forEach(i=>i.classList.remove('active'));document.querySelectorAll('#page-admin .qualiopi-section').forEach(s=>s.classList.remove('active'));item.classList.add('active');document.getElementById('admin-'+a).classList.add('active');currentAdmin=a;loadAdmin(a);});});
  document.querySelectorAll('#sub-nav-ged .sub-nav-item').forEach(item=>{item.addEventListener('click',()=>{const g=item.dataset.ged;document.querySelectorAll('#sub-nav-ged .sub-nav-item').forEach(i=>i.classList.remove('active'));document.querySelectorAll('.ged-section').forEach(s=>s.classList.remove('active'));item.classList.add('active');document.getElementById('ged-'+g).classList.add('active');currentGed=g;loadGed(g);});});
}

// Fonction pour naviguer vers un onglet parent puis une sous-section
function naviguerVersSection(parentPage,section){
  // Mettre √† jour la variable de section courante
  if(parentPage==='analyse-eval'){
    currentAnalyseEval=section;
  }else if(parentPage==='agenda'){
    currentAgenda=section;
  }else if(parentPage==='documents'){
    currentDocuments=section;
  }else if(parentPage==='suivi'){
    currentSuivi=section;
  }
  
  // Naviguer vers l'onglet parent
  showPage(parentPage);
  
  // Mettre √† jour l'affichage de la sous-navigation
  const subNav=document.getElementById('sub-nav-'+parentPage);
  if(subNav){
    subNav.querySelectorAll('.sub-nav-item').forEach(item=>{
      item.classList.toggle('active',item.dataset.section===section);
    });
  }
}

async function loadPage(p){
  // Afficher les indicateurs Qualiopi sur les pages concern√©es
  if(['dashboard','demandes','analyse','evaluation','sessions','stagiaires','referentiels','devis','conventions','dpc','conception','agenda-sessions','agenda-general','suivi-workflow','suivi-controle'].includes(p)){
    afficherIndicateursQualiopi(p);
  }
  
  switch(p){
    case 'dashboard':await updateDashboard();break;
    case 'demandes':await showDemandes();break;
    case 'emails':await showEmails();break;
    case 'entreprises':await showEntreprises();break;
    case 'opportunites':await showOpportunites();break;
    case 'analyse':await showAnalyses();break;
    case 'evaluation':await showEvaluations();break;
    case 'stagiaires':await showStagiaires();break;
    case 'sessions':await showSessions();break;
    case 'agenda-sessions':await showAgendaSessions();break;
    case 'agenda-general':await showAgendaGeneral();break;
    case 'devis':await showDevis();break;
    case 'conventions':await loadConventions();break;
    case 'suivi-workflow':await showSuiviWorkflow();break;
    case 'suivi-controle':await showTableauControle();break;
    case 'messagerie':await showMessagerie();break;
    case 'dpc':await showDPC();break;
    case 'conception':await showConception();break;
    case 'post-formation':await initPostFormation();break;
    case 'qualiopi':await loadQuali(currentQuali);break;
    case 'ged':await showGED();break;
    case 'referentiels':await loadRef(currentRef);break;
    case 'admin':await loadAdmin(currentAdmin);break;
  }
}

async function loadRef(r){
  if(r==='idcc'){
    await loadIDCC();
  } else {
    await showTable(r);
  }
}

// ============ GESTION IDCC ============
let idccData = [];

async function loadIDCC() {
  idccData = await dbGetAll('idcc') || [];
  
  // Si vide, initialiser avec les valeurs par d√©faut
  if (idccData.length === 0) {
    await initialiserIDCCDefaut(true);
    idccData = await dbGetAll('idcc') || [];
  }
  
  renderIDCC();
}

function renderIDCC(filteredData = null) {
  const data = filteredData || idccData;
  const tbody = document.getElementById('table-idcc');
  if (!tbody) return;
  
  if (data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#64748b;padding:40px">Aucun IDCC enregistr√©. <a href="#" onclick="initialiserIDCCDefaut();return false;">Cliquez ici pour initialiser les IDCC par d√©faut</a></td></tr>`;
    return;
  }
  
  tbody.innerHTML = data.map(item => `
    <tr>
      <td><code style="font-size:1.1em;font-weight:bold;background:#fef3c7;padding:4px 8px;border-radius:4px">${esc(item.code)}</code></td>
      <td><strong>${esc(item.intitule)}</strong></td>
      <td><span class="badge" style="background:${getOPCOColor(item.opco)};color:#fff">${esc(item.opco || '-')}</span></td>
      <td>${esc(item.secteur || '-')}</td>
      <td><span class="status status-${item.statut === 'Actif' ? 'actif' : 'inactif'}">${item.statut || 'Actif'}</span></td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="modifierIDCC(${item.id})" title="Modifier">‚úèÔ∏è</button>
        <button class="btn btn-sm" onclick="supprimerIDCC(${item.id})" title="Supprimer" style="background:#ef4444;color:#fff">üóëÔ∏è</button>
      </td>
    </tr>
  `).join('');
}

function getOPCOColor(opco) {
  const colors = {
    'AKTO': '#3b82f6',
    'OPCO EP': '#22c55e',
    'OPCO Atlas': '#8b5cf6',
    'OPCO Mobilit√©s': '#f59e0b',
    'OPCO Sant√©': '#ef4444',
    "L'Opcommerce": '#06b6d4',
    'OPCO 2i': '#6366f1',
    'AFDAS': '#ec4899',
    'Ocapiat': '#84cc16',
    'Constructys': '#f97316',
    'Uniformation': '#14b8a6'
  };
  return colors[opco] || '#64748b';
}

function filterIDCC() {
  const search = document.getElementById('search-idcc')?.value?.toLowerCase() || '';
  if (!search) {
    renderIDCC();
    return;
  }
  
  const filtered = idccData.filter(item => 
    item.code?.toLowerCase().includes(search) ||
    item.intitule?.toLowerCase().includes(search) ||
    item.opco?.toLowerCase().includes(search) ||
    item.secteur?.toLowerCase().includes(search)
  );
  renderIDCC(filtered);
}

function openModalIDCC() {
  document.getElementById('idcc-edit-id').value = '';
  document.getElementById('idcc-code').value = '';
  document.getElementById('idcc-intitule').value = '';
  document.getElementById('idcc-opco').value = '';
  document.getElementById('idcc-secteur').value = '';
  document.getElementById('idcc-statut').value = 'Actif';
  document.getElementById('idcc-notes').value = '';
  document.getElementById('modal-idcc-titre').textContent = 'üìã Ajouter un IDCC';
  document.getElementById('modal-idcc').style.display = 'flex';
}

function fermerModalIDCC() {
  document.getElementById('modal-idcc').style.display = 'none';
}

async function modifierIDCC(id) {
  const item = idccData.find(i => i.id === id);
  if (!item) return;
  
  document.getElementById('idcc-edit-id').value = id;
  document.getElementById('idcc-code').value = item.code || '';
  document.getElementById('idcc-intitule').value = item.intitule || '';
  document.getElementById('idcc-opco').value = item.opco || '';
  document.getElementById('idcc-secteur').value = item.secteur || '';
  document.getElementById('idcc-statut').value = item.statut || 'Actif';
  document.getElementById('idcc-notes').value = item.notes || '';
  document.getElementById('modal-idcc-titre').textContent = '‚úèÔ∏è Modifier l\'IDCC';
  document.getElementById('modal-idcc').style.display = 'flex';
}

async function sauvegarderIDCC() {
  const id = document.getElementById('idcc-edit-id').value;
  const code = document.getElementById('idcc-code').value.trim();
  const intitule = document.getElementById('idcc-intitule').value.trim();
  const opco = document.getElementById('idcc-opco').value;
  const secteur = document.getElementById('idcc-secteur').value;
  const statut = document.getElementById('idcc-statut').value;
  const notes = document.getElementById('idcc-notes').value.trim();
  
  if (!code || !intitule) {
    toast('‚ö†Ô∏è Le code IDCC et l\'intitul√© sont obligatoires', 'warning');
    return;
  }
  
  if (!/^\d{4}$/.test(code)) {
    toast('‚ö†Ô∏è Le code IDCC doit contenir exactement 4 chiffres', 'warning');
    return;
  }
  
  // V√©rifier si le code existe d√©j√† (sauf en modification)
  const existant = idccData.find(i => i.code === code && (!id || i.id !== parseInt(id)));
  if (existant) {
    toast('‚ö†Ô∏è Ce code IDCC existe d√©j√†', 'warning');
    return;
  }
  
  const data = { code, intitule, opco, secteur, statut, notes, dateModif: new Date().toISOString() };
  
  if (id) {
    data.id = parseInt(id);
    await dbPut('idcc', data);
    toast('‚úÖ IDCC modifi√© avec succ√®s', 'success');
  } else {
    data.dateCreation = new Date().toISOString();
    await dbAdd('idcc', data);
    toast('‚úÖ IDCC ajout√© avec succ√®s', 'success');
  }
  
  fermerModalIDCC();
  await loadIDCC();
}

async function supprimerIDCC(id) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet IDCC ?')) return;
  
  await dbDelete('idcc', id);
  toast('üóëÔ∏è IDCC supprim√©', 'success');
  await loadIDCC();
}

async function initialiserIDCCDefaut(silent = false) {
  if (!silent && !confirm('Cette action va r√©initialiser la liste des IDCC avec les valeurs par d√©faut. Continuer ?')) return;
  
  // Supprimer tous les IDCC existants
  const existants = await dbGetAll('idcc') || [];
  for (const item of existants) {
    await dbDelete('idcc', item.id);
  }
  
  // Liste des IDCC par d√©faut
  const idccDefaut = [
    { code: '0843', intitule: 'Boulangerie-p√¢tisserie (entreprises artisanales)', opco: 'OPCO EP', secteur: 'Alimentation' },
    { code: '1747', intitule: 'P√¢tisserie', opco: 'OPCO EP', secteur: 'Alimentation' },
    { code: '0992', intitule: 'Boucherie, boucherie-charcuterie, triperie', opco: 'OPCO EP', secteur: 'Alimentation' },
    { code: '1501', intitule: 'Restauration rapide', opco: 'AKTO', secteur: 'H√¥tellerie-Restauration' },
    { code: '1979', intitule: 'H√¥tels, caf√©s, restaurants (HCR)', opco: 'AKTO', secteur: 'H√¥tellerie-Restauration' },
    { code: '2596', intitule: 'Coiffure et professions connexes', opco: 'OPCO EP', secteur: 'Services' },
    { code: '3127', intitule: 'Esth√©tique-cosm√©tique et enseignement', opco: 'OPCO EP', secteur: 'Services' },
    { code: '0573', intitule: 'Commerce de gros', opco: "L'Opcommerce", secteur: 'Commerce' },
    { code: '2216', intitule: 'Commerce de d√©tail et de gros √† pr√©dominance alimentaire', opco: "L'Opcommerce", secteur: 'Commerce' },
    { code: '1405', intitule: 'Commerce de d√©tail des fruits et l√©gumes, √©picerie, produits laitiers (Primeurs)', opco: "L'Opcommerce", secteur: 'Commerce' },
    { code: '1504', intitule: 'Poissonnerie', opco: "L'Opcommerce", secteur: 'Alimentation' },
    { code: '1486', intitule: 'Bureaux d\'√©tudes techniques, cabinets d\'ing√©nieurs-conseils (SYNTEC)', opco: 'OPCO Atlas', secteur: 'Services' },
    { code: '1090', intitule: 'Automobile (services)', opco: 'OPCO Mobilit√©s', secteur: 'Services' },
    { code: '0016', intitule: 'Transport routier et activit√©s auxiliaires', opco: 'OPCO Mobilit√©s', secteur: 'Transport' },
    { code: '1518', intitule: 'Animation', opco: 'Uniformation', secteur: 'Services' },
    { code: '2609', intitule: 'B√¢timent (ouvriers jusqu\'√† 10 salari√©s)', opco: 'Constructys', secteur: 'BTP' },
    { code: '3043', intitule: 'Entreprises de propret√© et services associ√©s', opco: 'AKTO', secteur: 'Services' },
    { code: '1996', intitule: 'Pharmacie d\'officine', opco: 'OPCO Sant√©', secteur: 'Sant√©' },
    { code: '2098', intitule: 'Personnel des prestataires de services dans le secteur tertiaire', opco: 'AKTO', secteur: 'Services' }
  ];
  
  // Ajouter les IDCC par d√©faut
  for (const idcc of idccDefaut) {
    await dbAdd('idcc', {
      ...idcc,
      statut: 'Actif',
      dateCreation: new Date().toISOString()
    });
  }
  
  if (!silent) {
    toast('‚úÖ Liste des IDCC r√©initialis√©e avec ' + idccDefaut.length + ' entr√©es', 'success');
    await loadIDCC();
  }
}

function exporterIDCCCSV() {
  if (idccData.length === 0) {
    toast('‚ö†Ô∏è Aucun IDCC √† exporter', 'warning');
    return;
  }
  
  const headers = ['Code IDCC', 'Intitul√©', 'OPCO', 'Secteur', 'Statut', 'Notes'];
  const rows = idccData.map(item => [
    item.code,
    item.intitule,
    item.opco || '',
    item.secteur || '',
    item.statut || 'Actif',
    item.notes || ''
  ]);
  
  const csv = [headers, ...rows].map(r => r.map(c => `"${(c || '').replace(/"/g, '""')}"`).join(';')).join('\n');
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `idcc_export_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  toast('üìä Export CSV t√©l√©charg√©', 'success');
}

// ============ IDCC - AUTO-COMPLETION FORMULAIRES ============

// Charger les IDCC dans tous les selects des formulaires
async function chargerIDCCDansSelects() {
  // Charger les donn√©es IDCC si pas encore charg√©es
  let listeIDCC = idccData;
  if (!listeIDCC || listeIDCC.length === 0) {
    listeIDCC = await dbGetAll('idcc') || [];
  }
  
  // Filtrer uniquement les IDCC actifs
  const idccActifs = listeIDCC.filter(i => i.statut === 'Actif' || !i.statut);
  
  // Trier par code
  idccActifs.sort((a, b) => (a.code || '').localeCompare(b.code || ''));
  
  // G√©n√©rer les options HTML
  const optionsHTML = idccActifs.map(item => 
    `<option value="${item.code}" data-opco="${esc(item.opco || '')}" data-secteur="${esc(item.secteur || '')}" data-intitule="${esc(item.intitule || '')}">
      ${item.code} - ${esc(item.intitule || '')}${item.opco ? ' (' + esc(item.opco) + ')' : ''}
    </option>`
  ).join('');
  
  // Remplir les selects IDCC
  const selectsIDCC = [
    'f-idcc',           // Formulaire entreprise
    'f-idcc-demande',   // Formulaire demande
    'f-idcc-dpc'        // Formulaire DPC (prise en charge)
  ];
  
  selectsIDCC.forEach(selectId => {
    const el = document.getElementById(selectId);
    if (el) {
      el.innerHTML = '<option value="">-- S√©lectionner un IDCC --</option>' + optionsHTML;
    }
  });
}

// Fonction g√©n√©rique pour appliquer l'IDCC sur un formulaire
function appliquerIDCCSelection(idccSelectId, opcoSelectId, secteurFieldId) {
  const idccSelect = document.getElementById(idccSelectId);
  if (!idccSelect) return;
  
  const selectedOption = idccSelect.options[idccSelect.selectedIndex];
  if (!selectedOption || !selectedOption.value) return;
  
  const opco = selectedOption.dataset.opco;
  const secteur = selectedOption.dataset.secteur;
  
  // Auto-remplir l'OPCO
  if (opco && opcoSelectId) {
    const opcoSelect = document.getElementById(opcoSelectId);
    if (opcoSelect) {
      let found = false;
      for (let i = 0; i < opcoSelect.options.length; i++) {
        if (opcoSelect.options[i].value === opco || opcoSelect.options[i].text === opco) {
          opcoSelect.selectedIndex = i;
          found = true;
          break;
        }
      }
      if (!found) {
        for (let i = 0; i < opcoSelect.options.length; i++) {
          if (opcoSelect.options[i].text.toLowerCase().includes(opco.toLowerCase()) ||
              opco.toLowerCase().includes(opcoSelect.options[i].text.toLowerCase())) {
            opcoSelect.selectedIndex = i;
            break;
          }
        }
      }
    }
  }
  
  // Auto-remplir le secteur d'activit√©
  if (secteur && secteurFieldId) {
    const secteurField = document.getElementById(secteurFieldId);
    if (secteurField) {
      secteurField.value = secteur;
    }
  }
  
  toast('‚úÖ OPCO et secteur auto-remplis', 'success');
}

// Quand on s√©lectionne un IDCC dans le formulaire entreprise
function onIDCCChange() {
  appliquerIDCCSelection('f-idcc', 'f-opco', 'f-secteurActivite');
}

// Quand on s√©lectionne un IDCC dans le formulaire demande
function onIDCCChangeDemande() {
  appliquerIDCCSelection('f-idcc-demande', 'f-opco', 'f-secteurActivite-demande');
}

// Quand on s√©lectionne un IDCC dans le formulaire DPC
function onIDCCChangeDPC() {
  appliquerIDCCSelection('f-idcc-dpc', 'f-opco', 'f-secteurActivite-dpc');
}

// Trouver l'IDCC correspondant √† un code
function getIDCCByCode(code) {
  if (!code || !idccData) return null;
  return idccData.find(i => i.code === code);
}

// Remplir automatiquement l'IDCC depuis les r√©sultats de recherche SIREN
function appliquerIDCCDepuisRecherche(idccCode) {
  if (!idccCode) return;
  
  const idccSelect = document.getElementById('f-idcc');
  if (idccSelect) {
    // S√©lectionner l'option correspondante
    for (let i = 0; i < idccSelect.options.length; i++) {
      if (idccSelect.options[i].value === idccCode) {
        idccSelect.selectedIndex = i;
        onIDCCChange(); // D√©clencher l'auto-compl√©tion
        break;
      }
    }
  }
}

// ============ DEMANDE INFORMATIONS STAGIAIRES ============
let demandeStaEntrepriseData = null;

function afficherAideDemandeStag() {
  const aideBox = document.getElementById('aide-demande-stag');
  if (aideBox) {
    aideBox.style.display = aideBox.style.display === 'none' ? 'block' : 'none';
  }
}

// Ouvrir le s√©lecteur d'entreprise dans l'onglet Stagiaires
async function ouvrirSelecteurEntrepriseDemandeStagiaires() {
  const selecteur = document.getElementById('selecteur-entreprise-demande');
  const select = document.getElementById('select-entreprise-demande');
  
  if (!selecteur || !select) return;
  
  // Charger les entreprises avec email
  const entreprises = await dbGetAll('entreprises');
  const entreprisesAvecEmail = entreprises.filter(e => e.emailContact || e.emailPro);
  
  select.innerHTML = '<option value="">-- Choisir une entreprise --</option>' +
    entreprisesAvecEmail.map(e => 
      `<option value="${e.id}">${esc(e.nom)}${e.ville ? ' - ' + esc(e.ville) : ''} (${esc(e.emailContact || e.emailPro)})</option>`
    ).join('');
  
  selecteur.style.display = 'block';
}

function fermerSelecteurEntreprise() {
  const selecteur = document.getElementById('selecteur-entreprise-demande');
  if (selecteur) selecteur.style.display = 'none';
}

async function ouvrirDemandeStagiairesDepuisSelecteur() {
  const select = document.getElementById('select-entreprise-demande');
  if (!select || !select.value) {
    toast('‚ö†Ô∏è Veuillez s√©lectionner une entreprise', 'warning');
    return;
  }
  
  fermerSelecteurEntreprise();
  await ouvrirDemandeInfosStagiaires(parseInt(select.value));
}

async function ouvrirDemandeInfosStagiaires(entrepriseId) {
  try {
    // Charger les donn√©es de l'entreprise
    const entreprise = await dbGet('entreprises', entrepriseId);
    if (!entreprise) {
      toast('‚ö†Ô∏è Entreprise non trouv√©e', 'error');
      return;
    }
    
    demandeStaEntrepriseData = entreprise;
    
    // V√©rifier qu'il y a un email
    const emailDest = entreprise.emailContact || entreprise.emailPro;
    if (!emailDest) {
      toast('‚ö†Ô∏è Aucun email disponible pour cette entreprise', 'warning');
      return;
    }
    
    // Remplir les infos entreprise
    document.getElementById('demande-stag-entreprise-id').value = entrepriseId;
    document.getElementById('demande-stag-entreprise-nom').textContent = entreprise.nom || '-';
    document.getElementById('demande-stag-contact').textContent = entreprise.contact || '-';
    document.getElementById('demande-stag-email').textContent = emailDest;
    document.getElementById('demande-stag-nb-salaries').textContent = entreprise.nbSalaries || '-';
    document.getElementById('demande-stag-destinataire').value = emailDest;
    
    // Charger les stagiaires existants
    const stagiaires = await dbGetAll('stagiaires');
    const stagEntreprise = stagiaires.filter(s => s.entreprise == entrepriseId);
    
    const listeContainer = document.getElementById('demande-stag-liste-existants');
    if (stagEntreprise.length === 0) {
      listeContainer.innerHTML = '<p style="color:#64748b;margin:0;text-align:center;font-style:italic">Aucun stagiaire enregistr√© pour cette entreprise</p>';
    } else {
      listeContainer.innerHTML = `
        <table style="width:100%;font-size:0.8rem">
          <thead style="background:#e2e8f0">
            <tr><th style="padding:5px">Nom</th><th style="padding:5px">Pr√©nom</th><th style="padding:5px">Email</th><th style="padding:5px">Fonction</th></tr>
          </thead>
          <tbody>
            ${stagEntreprise.map(s => `
              <tr>
                <td style="padding:5px">${esc(s.nom || '-')}</td>
                <td style="padding:5px">${esc(s.prenom || '-')}</td>
                <td style="padding:5px">${esc(s.email || '-')}</td>
                <td style="padding:5px">${esc(s.fonction || '-')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <p style="color:#10b981;margin:10px 0 0;font-size:0.75rem;text-align:center"><strong>${stagEntreprise.length}</strong> stagiaire(s) enregistr√©(s)</p>
      `;
    }
    
    // G√©n√©rer le template par d√©faut
    appliquerTemplateStagiaires('complet');
    
    // Afficher la modal
    document.getElementById('modal-demande-stagiaires').style.display = 'flex';
    
  } catch (err) {
    console.error('Erreur ouvrirDemandeInfosStagiaires:', err);
    toast('‚ùå Erreur lors du chargement', 'error');
  }
}

function fermerModalDemandeStagiaires() {
  document.getElementById('modal-demande-stagiaires').style.display = 'none';
  demandeStaEntrepriseData = null;
}

function appliquerTemplateStagiaires(template) {
  const entreprise = demandeStaEntrepriseData;
  if (!entreprise) return;
  
  const contactPrenom = (entreprise.contact || '').split(' ')[0] || 'Madame, Monsieur';
  const nomEntreprise = entreprise.nom || 'votre entreprise';
  
  let objet = '';
  let message = '';
  
  switch (template) {
    case 'complet':
      objet = 'Demande d\'informations sur vos salari√©s pour inscription en formation';
      message = `Bonjour ${contactPrenom},

Dans le cadre de la pr√©paration de votre prochaine action de formation, nous avons besoin de recueillir les informations concernant les salari√©s de ${nomEntreprise} qui participeront √† cette formation.

Pourriez-vous nous transmettre les informations suivantes pour chaque stagiaire :

üìã INFORMATIONS REQUISES :
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Nom et Pr√©nom
‚Ä¢ Date de naissance
‚Ä¢ Email professionnel
‚Ä¢ Num√©ro de t√©l√©phone
‚Ä¢ Fonction dans l'entreprise
‚Ä¢ Num√©ro de S√©curit√© Sociale (pour la prise en charge OPCO)
‚Ä¢ Personne en situation de handicap (Oui/Non) - pour adapter l'accueil si n√©cessaire

Vous pouvez nous r√©pondre directement √† cet email ou nous transmettre un tableau avec ces informations.

Ces donn√©es sont n√©cessaires pour :
‚úì L'√©tablissement de la convention de formation
‚úì La demande de prise en charge aupr√®s de votre OPCO (${entreprise.opco || '√† pr√©ciser'})
‚úì L'√©dition des documents administratifs (feuilles de pr√©sence, attestations...)

Nous restons √† votre disposition pour tout compl√©ment d'information.

Cordialement,

L'√©quipe Formation DesClick
üìß contact@formationdesclick.fr
üìû 01 XX XX XX XX`;
      break;
      
    case 'minimal':
      objet = 'Informations stagiaires - Formation √† venir';
      message = `Bonjour ${contactPrenom},

Pour finaliser l'inscription √† votre prochaine formation, merci de nous communiquer pour chaque participant :

‚Ä¢ Nom et Pr√©nom
‚Ä¢ Email

Vous pouvez simplement r√©pondre √† cet email avec ces informations.

Bien cordialement,

L'√©quipe Formation DesClick`;
      break;
      
    case 'haccp':
      objet = 'Formation Hygi√®ne Alimentaire (HACCP) - Informations stagiaires';
      message = `Bonjour ${contactPrenom},

Suite √† notre √©change concernant la formation Hygi√®ne Alimentaire (HACCP) pour ${nomEntreprise}, nous avons besoin des informations suivantes pour chaque participant :

üìã INFORMATIONS STAGIAIRES :
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Nom et Pr√©nom
‚Ä¢ Date de naissance
‚Ä¢ Email
‚Ä¢ Fonction (Cuisinier, Commis, Serveur, Manager...)
‚Ä¢ Num√©ro de S√©curit√© Sociale

‚ö†Ô∏è RAPPEL R√âGLEMENTAIRE :
La formation HACCP de 14 heures est obligatoire pour tous les √©tablissements de restauration commerciale (arr√™t√© du 5 octobre 2011). √Ä l'issue de la formation, vos salari√©s recevront une attestation de formation valable √† vie.

${entreprise.opco ? `Votre OPCO ${entreprise.opco} peut prendre en charge tout ou partie de cette formation.` : ''}

Merci de nous retourner ces informations dans les meilleurs d√©lais.

Cordialement,

L'√©quipe Formation DesClick`;
      break;
      
    case 'securite':
      objet = 'Formation S√©curit√© au Travail - Informations participants';
      message = `Bonjour ${contactPrenom},

Dans le cadre de la formation S√©curit√© au Travail pr√©vue pour ${nomEntreprise}, merci de nous communiquer les informations suivantes pour chaque stagiaire :

üìã INFORMATIONS REQUISES :
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Nom et Pr√©nom
‚Ä¢ Date de naissance
‚Ä¢ Email professionnel
‚Ä¢ T√©l√©phone
‚Ä¢ Poste occup√©
‚Ä¢ Num√©ro de S√©curit√© Sociale
‚Ä¢ PSH (Personne en Situation de Handicap) : Oui/Non

ü¶∫ Ces informations sont essentielles pour :
‚úì Adapter les exercices pratiques au poste de travail
‚úì D√©livrer les attestations de formation
‚úì Constituer le dossier de prise en charge OPCO

Restant √† votre disposition,

L'√©quipe Formation DesClick`;
      break;
  }
  
  document.getElementById('demande-stag-objet').value = objet;
  document.getElementById('demande-stag-message').value = message;
}

async function envoyerDemandeStagiaires() {
  const entrepriseId = document.getElementById('demande-stag-entreprise-id').value;
  const destinataire = document.getElementById('demande-stag-destinataire').value;
  const objet = document.getElementById('demande-stag-objet').value;
  const message = document.getElementById('demande-stag-message').value;
  const copieBcc = document.getElementById('demande-stag-copie-bcc').checked;
  
  if (!destinataire || !objet || !message) {
    toast('‚ö†Ô∏è Veuillez remplir tous les champs', 'warning');
    return;
  }
  
  try {
    // Charger les param√®tres pour l'email de l'organisme
    const params = await dbGet('parametres', 'general');
    const emailOrganisme = params?.emailOrganisme || params?.email || '';
    
    // Enregistrer l'email dans l'historique
    const emailRecord = {
      type: 'Demande infos stagiaires',
      destinataire: destinataire,
      objet: objet,
      message: message,
      entrepriseId: parseInt(entrepriseId),
      entrepriseNom: demandeStaEntrepriseData?.nom || '',
      dateEnvoi: new Date().toISOString(),
      statut: 'Envoy√©',
      copieBcc: copieBcc ? emailOrganisme : null
    };
    
    await dbAdd('emails', emailRecord);
    
    // Construire le lien mailto
    let mailtoUrl = `mailto:${destinataire}?subject=${encodeURIComponent(objet)}&body=${encodeURIComponent(message)}`;
    if (copieBcc && emailOrganisme) {
      mailtoUrl += `&bcc=${encodeURIComponent(emailOrganisme)}`;
    }
    
    // Ouvrir le client mail
    window.open(mailtoUrl, '_blank');
    
    // Enregistrer l'historique sur l'entreprise
    const entreprise = await dbGet('entreprises', parseInt(entrepriseId));
    if (entreprise) {
      const historique = entreprise.historiqueEmails || [];
      historique.push({
        date: new Date().toISOString(),
        type: 'Demande infos stagiaires',
        objet: objet
      });
      entreprise.historiqueEmails = historique;
      entreprise.dernierContactEmail = new Date().toISOString();
      await dbPut('entreprises', entreprise);
    }
    
    toast('‚úÖ Email pr√©par√© - Votre client mail s\'ouvre', 'success');
    fermerModalDemandeStagiaires();
    
    // Rafra√Æchir la liste si on est sur la page entreprises
    if (typeof showEntreprises === 'function') {
      await showEntreprises();
    }
    
  } catch (err) {
    console.error('Erreur envoyerDemandeStagiaires:', err);
    toast('‚ùå Erreur lors de l\'envoi', 'error');
  }
}

async function loadAdmin(a){if(a==='historique')showHistorique();else if(a==='parametres')loadParams();else await showTable('gestionnaires');}

// ============ UTILS ============
const esc=s=>s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])):'';
const slug=s=>s?s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,''):'';
const fmt=v=>v?new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(v):'-';
const fmtMoney=fmt;
const fmtShort=v=>{if(!v)return'0‚Ç¨';if(v>=1e6)return(v/1e6).toFixed(1)+'M‚Ç¨';if(v>=1e3)return(v/1e3).toFixed(0)+'K‚Ç¨';return v+'‚Ç¨'};
const fmtDate=d=>d?new Date(d).toLocaleDateString('fr-FR'):'-';
const trunc=(s,l)=>s?(s.length>l?s.slice(0,l)+'...':s):'-';
const toast=(m,t='info')=>{const c=document.getElementById('toasts');const e=document.createElement('div');e.className='toast '+t;e.textContent=m;c.appendChild(e);setTimeout(()=>e.remove(),t==='error'?8000:3000)};

// ============ DASHBOARD AVANC√â ============
let chartPipeline,chartEtats,chartCAMensuel,chartCAFormation,chartStagiaires;
let dashboardData={};

async function updateDashboard(){
  // Charger toutes les donn√©es n√©cessaires
  const [demandes,emails,opps,ent,stag,form,sess,conv,satisf,analyses,evaluations,devisList,dpcList]=await Promise.all([
    dbGetAll('demandes'),
    dbGetAll('emails'),
    dbGetAll('opportunites'),
    dbGetAll('entreprises'),
    dbGetAll('stagiaires'),
    dbGetAll('formations'),
    dbGetAll('sessions'),
    dbGetAll('conventions'),
    dbGetAll('satisfactions'),
    dbGetAll('analyses'),
    dbGetAll('evaluations'),
    dbGetAll('devis'),
    dbGetAll('dpc')
  ]);
  
  // Stocker pour r√©utilisation
  dashboardData={demandes,emails,opps,ent,stag,form,sess,conv,satisf,analyses,evaluations,devisList,dpcList};
  
  // Calculs de base
  const newDemandes=demandes.filter(d=>d.statut==='Nouveau').length;
  const emailsEnAttente=emails.filter(e=>e.statut==='En attente').length;
  const total=opps.length;
  const gagnees=opps.filter(o=>o.etat==='Gagn√©').length;
  const encours=opps.filter(o=>o.etat==='En cours').length;
  const taux=total>0?((gagnees/total)*100).toFixed(0):0;
  const ca=opps.filter(o=>o.etat==='Gagn√©').reduce((s,o)=>s+(o.montant||0),0);
  const avgSatisf=satisf.length>0?(satisf.reduce((s,x)=>s+(x.noteGlobale||0),0)/satisf.length).toFixed(1):'-';
  
  // Calculs comparatifs (mois en cours vs mois pr√©c√©dent)
  const now=new Date();
  const debutMoisActuel=new Date(now.getFullYear(),now.getMonth(),1);
  const debutMoisPrecedent=new Date(now.getFullYear(),now.getMonth()-1,1);
  const finMoisPrecedent=new Date(now.getFullYear(),now.getMonth(),0);
  
  // CA mois actuel vs pr√©c√©dent
  const caMoisActuel=opps.filter(o=>o.etat==='Gagn√©'&&new Date(o.dateModification||o.dateCreation)>=debutMoisActuel).reduce((s,o)=>s+(o.montant||0),0);
  const caMoisPrecedent=opps.filter(o=>{
    const d=new Date(o.dateModification||o.dateCreation);
    return o.etat==='Gagn√©'&&d>=debutMoisPrecedent&&d<=finMoisPrecedent;
  }).reduce((s,o)=>s+(o.montant||0),0);
  
  // Stagiaires mois actuel vs pr√©c√©dent
  const stagMoisActuel=stag.filter(s=>new Date(s.dateCreation)>=debutMoisActuel).length;
  const stagMoisPrecedent=stag.filter(s=>{
    const d=new Date(s.dateCreation);
    return d>=debutMoisPrecedent&&d<=finMoisPrecedent;
  }).length;
  
  // Taux conversion mois actuel vs pr√©c√©dent
  const oppsMoisActuel=opps.filter(o=>new Date(o.dateCreation)>=debutMoisActuel);
  const tauxMoisActuel=oppsMoisActuel.length>0?(oppsMoisActuel.filter(o=>o.etat==='Gagn√©').length/oppsMoisActuel.length*100).toFixed(0):0;
  const oppsMoisPrecedent=opps.filter(o=>{
    const d=new Date(o.dateCreation);
    return d>=debutMoisPrecedent&&d<=finMoisPrecedent;
  });
  const tauxMoisPrecedent=oppsMoisPrecedent.length>0?(oppsMoisPrecedent.filter(o=>o.etat==='Gagn√©').length/oppsMoisPrecedent.length*100).toFixed(0):0;
  
  // Mise √† jour KPIs avanc√©s
  document.getElementById('kpi-ca-advanced').textContent=fmtMontant(ca);
  document.getElementById('kpi-taux-advanced').textContent=taux+'%';
  document.getElementById('kpi-stag-advanced').textContent=stag.length;
  document.getElementById('kpi-satisf-advanced').textContent=avgSatisf!='-'?avgSatisf+'/5':'-/5';
  
  // Tendances
  updateTrend('kpi-ca-trend',caMoisActuel,caMoisPrecedent,true);
  updateTrend('kpi-taux-trend',parseFloat(tauxMoisActuel),parseFloat(tauxMoisPrecedent));
  updateTrend('kpi-stag-trend',stagMoisActuel,stagMoisPrecedent);
  
  // Tendance satisfaction (bas√©e sur les 30 derniers jours vs 30 jours avant)
  const satisfRecent=satisf.filter(s=>new Date(s.dateCreation)>=debutMoisActuel);
  const satisfPrecedent=satisf.filter(s=>{
    const d=new Date(s.dateCreation);
    return d>=debutMoisPrecedent&&d<=finMoisPrecedent;
  });
  const avgSatisfRecent=satisfRecent.length>0?(satisfRecent.reduce((s,x)=>s+(x.noteGlobale||0),0)/satisfRecent.length):0;
  const avgSatisfPrecedent=satisfPrecedent.length>0?(satisfPrecedent.reduce((s,x)=>s+(x.noteGlobale||0),0)/satisfPrecedent.length):0;
  updateTrend('kpi-satisf-trend',avgSatisfRecent,avgSatisfPrecedent);
  
  // Mise √† jour des compteurs rapides
  document.getElementById('kpi-demandes').textContent=newDemandes;
  document.getElementById('kpi-emails').textContent=emailsEnAttente;
  document.getElementById('count-demandes').textContent=newDemandes;
  document.getElementById('count-demandes').style.display=newDemandes>0?'inline':'none';
  document.getElementById('count-emails').textContent=emailsEnAttente;
  document.getElementById('count-emails').style.display=emailsEnAttente>0?'inline':'none';
  document.getElementById('kpi-total').textContent=total;
  document.getElementById('kpi-gagnees').textContent=gagnees;
  document.getElementById('kpi-encours').textContent=encours;
  document.getElementById('kpi-ent').textContent=ent.length;
  document.getElementById('kpi-form').textContent=form.length;
  document.getElementById('kpi-sess').textContent=sess.length;
  document.getElementById('kpi-conv').textContent=conv.filter(c=>c.statut==='Sign√©e').length;

  // Graphiques
  updateChartCA();
  updateChartCAFormation();
  updateChartStagiaires();
  updateChartPipeline();
  updateChartEtats();
  
  // Prochaines sessions
  updateProchainesSessions();
  
  // Mise √† jour des compteurs du workflow
  if(document.getElementById('wf-dash-demande')) document.getElementById('wf-dash-demande').textContent=demandes.length;
  if(document.getElementById('wf-dash-analyse')) document.getElementById('wf-dash-analyse').textContent=analyses.length;
  if(document.getElementById('wf-dash-evaluation')) document.getElementById('wf-dash-evaluation').textContent=evaluations.length;
  if(document.getElementById('wf-dash-devis')) document.getElementById('wf-dash-devis').textContent=devisList.length;
  if(document.getElementById('wf-dash-convention')) document.getElementById('wf-dash-convention').textContent=conv.length;
  if(document.getElementById('wf-dash-pec')) document.getElementById('wf-dash-pec').textContent=dpcList.length;
  if(document.getElementById('wf-dash-session')) document.getElementById('wf-dash-session').textContent=sess.length;
}

function updateTrend(elementId,current,previous,isCurrency=false){
  const el=document.getElementById(elementId);
  if(!el)return;
  
  let diff=0;
  let percent=0;
  
  if(previous>0){
    diff=current-previous;
    percent=((diff/previous)*100).toFixed(0);
  }else if(current>0){
    percent=100;
    diff=current;
  }
  
  if(diff>0){
    el.className='kpi-trend up';
    el.innerHTML=`<span>‚Üë +${percent}%</span> <span>vs mois pr√©c√©dent</span>`;
  }else if(diff<0){
    el.className='kpi-trend down';
    el.innerHTML=`<span>‚Üì ${percent}%</span> <span>vs mois pr√©c√©dent</span>`;
  }else{
    el.className='kpi-trend neutral';
    el.innerHTML=`<span>‚Äî stable</span> <span>vs mois pr√©c√©dent</span>`;
  }
}

function updateChartCA(){
  const canvas=document.getElementById('chart-ca-mensuel');
  if(!canvas)return;
  
  const ctx=canvas.getContext('2d');
  const period=parseInt(document.getElementById('chart-ca-period')?.value||12);
  const opps=dashboardData.opps||[];
  
  // G√©n√©rer les labels pour les X derniers mois
  const labels=[];
  const data=[];
  const now=new Date();
  
  for(let i=period-1;i>=0;i--){
    const d=new Date(now.getFullYear(),now.getMonth()-i,1);
    const mois=d.toLocaleDateString('fr-FR',{month:'short',year:'2-digit'});
    labels.push(mois);
    
    // Calculer le CA du mois
    const debutMois=new Date(d.getFullYear(),d.getMonth(),1);
    const finMois=new Date(d.getFullYear(),d.getMonth()+1,0);
    const caMois=opps.filter(o=>{
      const dateOpp=new Date(o.dateModification||o.dateCreation);
      return o.etat==='Gagn√©'&&dateOpp>=debutMois&&dateOpp<=finMois;
    }).reduce((s,o)=>s+(o.montant||0),0);
    data.push(caMois);
  }
  
  if(chartCAMensuel)chartCAMensuel.destroy();
  chartCAMensuel=new Chart(ctx,{
    type:'bar',
    data:{
      labels:labels,
      datasets:[{
        label:'CA (‚Ç¨)',
        data:data,
        backgroundColor:'rgba(59,130,246,0.7)',
        borderColor:'#3b82f6',
        borderWidth:1,
        borderRadius:6
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            label:function(ctx){return fmtMontant(ctx.raw);}
          }
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          ticks:{
            callback:function(val){return fmtShort(val);}
          }
        }
      }
    }
  });
}

function updateChartCAFormation(){
  const canvas=document.getElementById('chart-ca-formation');
  if(!canvas)return;
  
  const ctx=canvas.getContext('2d');
  const opps=dashboardData.opps||[];
  const formations=dashboardData.form||[];
  
  // Grouper le CA par formation
  const caParFormation={};
  opps.filter(o=>o.etat==='Gagn√©').forEach(o=>{
    const formId=o.formation;
    const form=formations.find(f=>f.id===formId);
    const nomForm=form?form.nom:'Autre';
    caParFormation[nomForm]=(caParFormation[nomForm]||0)+(o.montant||0);
  });
  
  // Trier et prendre le top 6
  const sorted=Object.entries(caParFormation).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const labels=sorted.map(e=>e[0].length>15?e[0].substring(0,15)+'...':e[0]);
  const data=sorted.map(e=>e[1]);
  
  const colors=['#3b82f6','#8b5cf6','#22c55e','#f59e0b','#ef4444','#0891b2'];
  
  if(chartCAFormation)chartCAFormation.destroy();
  chartCAFormation=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:labels,
      datasets:[{
        data:data,
        backgroundColor:colors,
        borderWidth:2,
        borderColor:'#fff'
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:'right',
          labels:{
            boxWidth:12,
            padding:8,
            font:{size:10}
          }
        },
        tooltip:{
          callbacks:{
            label:function(ctx){
              return ctx.label+': '+fmtMontant(ctx.raw);
            }
          }
        }
      }
    }
  });
}

function updateChartStagiaires(){
  const canvas=document.getElementById('chart-stagiaires');
  if(!canvas)return;
  
  const ctx=canvas.getContext('2d');
  const stag=dashboardData.stag||[];
  
  // √âvolution sur 6 mois
  const labels=[];
  const data=[];
  const now=new Date();
  
  for(let i=5;i>=0;i--){
    const d=new Date(now.getFullYear(),now.getMonth()-i,1);
    const mois=d.toLocaleDateString('fr-FR',{month:'short'});
    labels.push(mois);
    
    // Compter les stagiaires cr√©√©s jusqu'√† la fin de ce mois
    const finMois=new Date(d.getFullYear(),d.getMonth()+1,0);
    const count=stag.filter(s=>new Date(s.dateCreation)<=finMois).length;
    data.push(count);
  }
  
  if(chartStagiaires)chartStagiaires.destroy();
  chartStagiaires=new Chart(ctx,{
    type:'line',
    data:{
      labels:labels,
      datasets:[{
        label:'Stagiaires',
        data:data,
        borderColor:'#8b5cf6',
        backgroundColor:'rgba(139,92,246,0.1)',
        fill:true,
        tension:0.4,
        pointBackgroundColor:'#8b5cf6',
        pointRadius:4
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        y:{beginAtZero:true}
      }
    }
  });
}

function updateChartPipeline(){
  const canvas=document.getElementById('chart-pipeline');
  if(!canvas)return;
  
  const ctx=canvas.getContext('2d');
  const opps=dashboardData.opps||[];
  
  const etapes=['Prospection','Analyse','√âvaluation','Devis','Convention','Action Formation','DCP','Conception'];
  const pData=etapes.map(e=>opps.filter(o=>o.etape===e).length);
  
  if(chartPipeline)chartPipeline.destroy();
  chartPipeline=new Chart(ctx,{
    type:'bar',
    data:{
      labels:etapes.map(e=>e.length>10?e.substring(0,10)+'...':e),
      datasets:[{
        data:pData,
        backgroundColor:['#818cf8','#f472b6','#fbbf24','#60a5fa','#34d399','#22d3ee','#a78bfa','#fcd34d'],
        borderRadius:4
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        y:{beginAtZero:true,ticks:{stepSize:1}}
      }
    }
  });
}

function updateChartEtats(){
  const canvas=document.getElementById('chart-etats');
  if(!canvas)return;
  
  const ctx=canvas.getContext('2d');
  const opps=dashboardData.opps||[];
  
  const encours=opps.filter(o=>o.etat==='En cours').length;
  const gagnees=opps.filter(o=>o.etat==='Gagn√©').length;
  const perdues=opps.filter(o=>o.etat==='Perdu').length;
  
  if(chartEtats)chartEtats.destroy();
  chartEtats=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['En cours','Gagn√©','Perdu'],
      datasets:[{
        data:[encours,gagnees,perdues],
        backgroundColor:['#fbbf24','#10b981','#ef4444'],
        borderWidth:2,
        borderColor:'#fff'
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:'bottom',
          labels:{boxWidth:12,padding:10}
        }
      }
    }
  });
}

function updateProchainesSessions(){
  const container=document.getElementById('prochaines-sessions-list');
  if(!container)return;
  
  const sess=dashboardData.sess||[];
  const form=dashboardData.form||[];
  const formMap=Object.fromEntries(form.map(f=>[f.id,f]));
  
  const now=new Date();
  now.setHours(0,0,0,0);
  
  // Filtrer les sessions √† venir et les trier
  const prochaines=sess
    .filter(s=>new Date(s.dateDebut)>=now&&s.statut!=='Annul√©e')
    .sort((a,b)=>new Date(a.dateDebut)-new Date(b.dateDebut))
    .slice(0,5);
  
  if(!prochaines.length){
    container.innerHTML='<div style="padding:30px;text-align:center;color:#64748b"><div style="font-size:2em;margin-bottom:10px">üìÖ</div>Aucune session planifi√©e</div>';
    return;
  }
  
  container.innerHTML=prochaines.map(s=>{
    const dateDebut=new Date(s.dateDebut);
    const day=dateDebut.getDate();
    const month=dateDebut.toLocaleDateString('fr-FR',{month:'short'});
    const formation=formMap[s.formation];
    const nomFormation=formation?formation.nom:'Formation';
    
    // Calculer le nombre de jours avant
    const diffDays=Math.ceil((dateDebut-now)/(1000*60*60*24));
    let badgeText='';
    let badgeColor='';
    if(diffDays===0){badgeText='Aujourd\'hui';badgeColor='#22c55e';}
    else if(diffDays===1){badgeText='Demain';badgeColor='#f59e0b';}
    else if(diffDays<=7){badgeText='Dans '+diffDays+' jours';badgeColor='#3b82f6';}
    else{badgeText='Dans '+diffDays+' jours';badgeColor='#64748b';}
    
    return`
    <div class="session-item" onclick="showPage('sessions')">
      <div class="session-date-badge">
        <div class="day">${day}</div>
        <div class="month">${month}</div>
      </div>
      <div style="flex:1">
        <div style="font-weight:600;color:#1e293b;margin-bottom:3px">${esc(nomFormation.length>30?nomFormation.substring(0,30)+'...':nomFormation)}</div>
        <div style="font-size:0.85em;color:#64748b">${s.nbStagiaires||0} stagiaire(s) ‚Ä¢ ${s.duree||0}h</div>
      </div>
      <span style="background:${badgeColor}20;color:${badgeColor};padding:4px 10px;border-radius:12px;font-size:0.75em;font-weight:500">${badgeText}</span>
    </div>`;
  }).join('');
}

function fmtMontant(val){
  return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(val||0);
}

// ============ DEMANDES ============
// Variable pour stocker la vue actuelle des demandes
let demandesView=localStorage.getItem('demandesView')||'cards';
let demandesData=[];
let demandesCommMap={};

// Changer la vue des demandes
function setDemandesView(view){
  demandesView=view;
  localStorage.setItem('demandesView',view);
  
  document.getElementById('btn-view-cards').classList.toggle('active',view==='cards');
  document.getElementById('btn-view-table').classList.toggle('active',view==='table');
  
  document.getElementById('demandes-cards').style.display=view==='cards'?'block':'none';
  document.getElementById('demandes-table').style.display=view==='table'?'block':'none';
  
  renderDemandes();
}

// Filtrer les demandes
function filterDemandes(){
  renderDemandes();
}

async function showDemandes(){
  demandesData=await dbGetAll('demandes');
  const commerciaux=await dbGetAll('commerciaux');
  demandesCommMap=Object.fromEntries(commerciaux.map(c=>[c.id,c]));
  demandesData.sort((a,b)=>new Date(b.dateCreation)-new Date(a.dateCreation));
  
  // Appliquer la vue sauvegard√©e
  document.getElementById('btn-view-cards').classList.toggle('active',demandesView==='cards');
  document.getElementById('btn-view-table').classList.toggle('active',demandesView==='table');
  document.getElementById('demandes-cards').style.display=demandesView==='cards'?'block':'none';
  document.getElementById('demandes-table').style.display=demandesView==='table'?'block':'none';
  
  renderDemandes();
}

function renderDemandes(){
  const searchTerm=(document.getElementById('search-demandes')?.value||'').toLowerCase();
  const statutFilter=document.getElementById('filter-demandes-statut')?.value||'';
  
  // Filtrer les donn√©es
  let filtered=demandesData.filter(d=>{
    const matchSearch=!searchTerm||
      (d.nom||'').toLowerCase().includes(searchTerm)||
      (d.prenom||'').toLowerCase().includes(searchTerm)||
      (d.raisonSociale||'').toLowerCase().includes(searchTerm)||
      (d.email||'').toLowerCase().includes(searchTerm)||
      (d.ville||'').toLowerCase().includes(searchTerm)||
      (d.formationsInteressees||'').toLowerCase().includes(searchTerm);
    const matchStatut=!statutFilter||d.statut===statutFilter;
    return matchSearch&&matchStatut;
  });
  
  if(demandesView==='cards'){
    renderDemandesCards(filtered);
  }else{
    renderDemandesTable(filtered);
  }
}

function renderDemandesCards(demandes){
  const container=document.getElementById('demandes-cards');
  
  if(!demandes.length){
    container.innerHTML='<div class="empty-state"><div class="empty-state-icon">üì©</div><h3>Aucune demande</h3><p>Les demandes re√ßues par email depuis le site DesClick appara√Ætront ici</p></div>';
    return;
  }
  
  container.innerHTML=demandes.map(d=>{
    const comm=d.commercialAssigne?demandesCommMap[d.commercialAssigne]:null;
    const commInfo=comm?`<span class="status status-actif">üë§ ${esc(comm.prenom||'')} ${esc(comm.nom)}</span>`:'<span class="status status-en-attente">Non assign√©</span>';
    const badgeNew = getBadgeNouveau(d.dateCreation);
    return `
    <div class="demande-card ${slug(d.statut)}">
      <div class="demande-header">
        <div>
          <div class="demande-title">${esc(d.raisonSociale||'Sans entreprise')} - ${esc(d.nom)} ${esc(d.prenom)}${badgeNew}</div>
          <span class="status status-${slug(d.statut)}">${d.statut||'Nouveau'}</span>
          ${d.priorite?`<span class="priority priority-${slug(d.priorite)}">${d.priorite}</span>`:''}
          ${commInfo}
        </div>
        <div class="demande-date">${fmtDate(d.dateCreation)} ${getBoutonFavori('demandes', d.id)}</div>
      </div>
      <div class="demande-body">
        <p><strong>üìß</strong> ${esc(d.email||'-')} | <strong>üìû</strong> ${esc(d.telephone||'-')}</p>
        <p><strong>üè¢</strong> ${esc(d.raisonSociale||'-')} | <strong>SIREN:</strong> ${esc(d.siren||'-')}</p>
        <p><strong>üìç</strong> ${esc(d.adresse||'')} ${esc(d.codePostal||'')} ${esc(d.ville||'-')}</p>
        ${d.formationsInteressees?`<p><strong>üìö Formations:</strong> ${esc(d.formationsInteressees)}</p>`:''}
        ${d.besoinsSpecifiques?`<p><strong>üéØ Besoins:</strong> ${esc(d.besoinsSpecifiques)}</p>`:''}
        ${d.message?`<p><strong>üí¨ Message:</strong> ${esc(d.message)}</p>`:''}
      </div>
      <div class="demande-footer">
        <button class="btn btn-success btn-sm" onclick="convertirDemande(${d.id})">‚úÖ Convertir</button>
        <button class="btn btn-info btn-sm" onclick="assignerCommercial(${d.id})">üë§ Assigner</button>
        <button class="btn btn-warning btn-sm" onclick="envoyerAccuseManuel(${d.id})">üìß Accus√©</button>
        <button class="btn btn-secondary btn-sm" onclick="changerStatutDemande(${d.id},'En cours')">üîÑ</button>
        <button class="btn btn-secondary btn-sm" onclick="changerStatutDemande(${d.id},'Archiv√©')">üì¶</button>
        <button class="btn btn-primary btn-sm" onclick="openModal('demande',${d.id})">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelete('demandes',${d.id})">üóëÔ∏è</button>
      </div>
    </div>
  `;}).join('');
}

function renderDemandesTable(demandes){
  const tbody=document.getElementById('table-demandes');
  
  if(!demandes.length){
    tbody.innerHTML='<tr><td colspan="13" class="empty-state"><div class="empty-state-icon">üì©</div><h3>Aucune demande</h3></td></tr>';
    return;
  }
  
  tbody.innerHTML=demandes.map(d=>{
    const comm=d.commercialAssigne?demandesCommMap[d.commercialAssigne]:null;
    const commName=comm?`${esc(comm.prenom||'')} ${esc(comm.nom)}`:'<em style="color:var(--gray-400)">-</em>';
    const badgeNew = getBadgeNouveau(d.dateCreation);
    return `
    <tr>
      <td><code>DEM-${String(d.id).padStart(3,'0')}</code>${badgeNew}</td>
      <td>${fmtDate(d.dateCreation)}</td>
      <td><strong>${esc(d.raisonSociale||'-')}</strong></td>
      <td>${esc(d.siren||'-')}</td>
      <td>${esc(d.prenom||'')} ${esc(d.nom||'-')}</td>
      <td><a href="mailto:${esc(d.email)}">${esc(d.email||'-')}</a></td>
      <td>${esc(d.telephone||'-')}</td>
      <td>${esc(d.ville||'-')}</td>
      <td>${trunc(d.formationsInteressees,20)}</td>
      <td>${commName}</td>
      <td><span class="priority priority-${slug(d.priorite)}">${d.priorite||'Normale'}</span></td>
      <td><span class="status status-${slug(d.statut)}">${d.statut||'Nouveau'}</span></td>
      <td class="action-btns">
        ${getBoutonFavori('demandes', d.id)}
        <button class="btn btn-success btn-icon" onclick="convertirDemande(${d.id})" title="Convertir">‚úÖ</button>
        <button class="btn btn-info btn-icon" onclick="assignerCommercial(${d.id})" title="Assigner">üë§</button>
        <button class="btn btn-warning btn-icon" onclick="envoyerAccuseManuel(${d.id})" title="Accus√©">üìß</button>
        <button class="btn btn-primary btn-icon" onclick="openModal('demande',${d.id})" title="Modifier">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-icon" onclick="confirmDelete('demandes',${d.id})" title="Supprimer">üóëÔ∏è</button>
      </td>
    </tr>
  `;}).join('');
}

// Assigner un commercial rapidement
async function assignerCommercial(demandeId){
  const demande=await dbGet('demandes',demandeId);
  if(!demande)return;
  
  const commerciaux=await dbGetAll('commerciaux');
  const actifs=commerciaux.filter(c=>c.statut==='Actif');
  
  if(!actifs.length){
    toast('Aucun commercial actif disponible','warning');
    return;
  }
  
  const options=actifs.map(c=>`${c.id}:${c.prenom||''} ${c.nom} (${c.email||''})`).join('\n');
  const choix=prompt(`S√©lectionner le commercial (ID):\n\n${options}\n\nEntrez l'ID du commercial:`);
  
  if(choix){
    const commId=parseInt(choix);
    const comm=actifs.find(c=>c.id===commId);
    if(comm){
      demande.commercialAssigne=commId;
      demande.statut='En cours';
      await dbPut('demandes',demande);
      
      // Stocker la notification au commercial
      const sujet=`Demande assign√©e - ${demande.raisonSociale||demande.nom}`;
      const corps=`Bonjour ${comm.prenom||''} ${comm.nom},

Une demande vous a √©t√© assign√©e :

Client : ${demande.prenom||''} ${demande.nom}
Entreprise : ${demande.raisonSociale||'-'}
Email : ${demande.email||'-'}
T√©l√©phone : ${demande.telephone||'-'}
Ville : ${demande.ville||'-'}

Formations : ${demande.formationsInteressees||'-'}
Besoins : ${demande.besoinsSpecifiques||'-'}

Priorit√© : ${demande.priorite||'Normale'}

--
CRM Formation DesClick`;

      await stockerEmail(comm.email,sujet,corps,'Notification commercial',demandeId);
      await addHistory('Assignation',`Demande assign√©e √† ${comm.nom}`);
      toast(`Demande assign√©e √† ${comm.prenom||''} ${comm.nom}. Email ajout√© √† la bo√Æte d'envoi.`,'success');
      await showDemandes();
      await updateDashboard();
    }else{
      toast('Commercial non trouv√©','error');
    }
  }
}

// Envoyer accus√© de r√©ception manuellement
async function envoyerAccuseManuel(demandeId){
  const demande=await dbGet('demandes',demandeId);
  if(!demande||!demande.email){
    toast('Email client manquant','warning');
    return;
  }
  
  const clientNom=`${demande.prenom||''} ${demande.nom||''}`.trim();
  const sujet='Accus√© de r√©ception de votre demande de formation - DesClick';
  const corps=`Bonjour ${clientNom},

Nous avons bien re√ßu votre mail, nous accusons r√©ception de votre demande de formation.

Nous allons vous r√©pondre dans les plus brefs d√©lais.

Bien √† vous.

--
Formation DesClick`;

  try{
    await stockerEmail(demande.email,sujet,corps,'Accus√© de r√©ception',demandeId);
    toast('Email ajout√© √† la bo√Æte d\'envoi','success');
    await updateEmailsBadge();
  }catch(err){
    console.error('Erreur envoyerAccuseManuel:',err);
    toast('Erreur lors de la cr√©ation de l\'email','error');
  }
}

// ============ EMAILS ============
let emailsData=[];
let emailsDemandesMap={};

async function showEmails(){
  emailsData=await dbGetAll('emails');
  const demandes=await dbGetAll('demandes');
  emailsDemandesMap=Object.fromEntries(demandes.map(d=>[d.id,d]));
  emailsData.sort((a,b)=>new Date(b.dateCreation)-new Date(a.dateCreation));
  renderEmails();
  await updateEmailsBadge();
}

async function updateEmailsBadge(){
  try{
    const emails=await dbGetAll('emails');
    const enAttente=emails.filter(e=>e.statut==='En attente').length;
    const badge=document.getElementById('count-emails');
    if(badge){
      badge.textContent=enAttente;
      badge.style.display=enAttente>0?'inline':'none';
    }
  }catch(err){
    console.error('Erreur updateEmailsBadge:',err);
  }
}

function filterEmails(){
  renderEmails();
}

function renderEmails(){
  const searchTerm=(document.getElementById('search-emails')?.value||'').toLowerCase();
  const statutFilter=document.getElementById('filter-emails-statut')?.value||'';
  const typeFilter=document.getElementById('filter-emails-type')?.value||'';
  
  let filtered=emailsData.filter(e=>{
    const matchSearch=!searchTerm||
      (e.destinataire||'').toLowerCase().includes(searchTerm)||
      (e.sujet||'').toLowerCase().includes(searchTerm)||
      (e.corps||'').toLowerCase().includes(searchTerm);
    const matchStatut=!statutFilter||e.statut===statutFilter;
    const matchType=!typeFilter||e.type===typeFilter;
    return matchSearch&&matchStatut&&matchType;
  });
  
  const tbody=document.getElementById('table-emails');
  
  if(!filtered.length){
    tbody.innerHTML='<tr><td colspan="10" class="empty-state"><div class="empty-state-icon">üìß</div><h3>Aucun email</h3><p>Les emails √† envoyer appara√Ætront ici</p></td></tr>';
    return;
  }
  
  tbody.innerHTML=filtered.map(e=>{
    const demande=e.demandeId?emailsDemandesMap[e.demandeId]:null;
    const demandeInfo=demande?`<a href="#" onclick="openModal('demande',${e.demandeId});return false;">DEM-${String(e.demandeId).padStart(3,'0')}</a>`:'-';
    const statutClass=e.statut==='Envoy√©'?'status-envoye':e.statut==='Erreur'?'status-refuse':'status-en-attente';
    
    return `<tr>
      <td><code>EML-${String(e.id).padStart(4,'0')}</code></td>
      <td>${fmtDate(e.dateCreation)}</td>
      <td><span class="status status-${slug(e.type)}">${esc(e.type||'-')}</span></td>
      <td><a href="mailto:${esc(e.destinataire)}">${esc(e.destinataire||'-')}</a></td>
      <td><strong>${trunc(e.sujet,30)}</strong></td>
      <td>${trunc(e.corps,40)}</td>
      <td>${demandeInfo}</td>
      <td><span class="status ${statutClass}">${e.statut||'En attente'}</span></td>
      <td>${e.dateEnvoi?fmtDate(e.dateEnvoi):'-'}</td>
      <td class="action-btns">
        ${e.statut==='En attente'?`<button class="btn btn-success btn-icon" onclick="envoyerUnEmail(${e.id})" title="Envoyer">üì§</button>`:''}
        ${e.statut==='En attente'?`<button class="btn btn-info btn-icon" onclick="marquerEmailEnvoye(${e.id})" title="Marquer envoy√©">‚úÖ</button>`:''}
        <button class="btn btn-secondary btn-icon" onclick="voirEmail(${e.id})" title="Voir">üëÅÔ∏è</button>
        <button class="btn btn-primary btn-icon" onclick="openModal('email',${e.id})" title="Modifier">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-icon" onclick="confirmDelete('emails',${e.id})" title="Supprimer">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

// Stocker un email dans la base
async function stockerEmail(destinataire,sujet,corps,type='Autre',demandeId=null){
  if(!destinataire){
    console.error('stockerEmail: destinataire manquant');
    throw new Error('Destinataire manquant');
  }
  const email={
    destinataire,
    sujet:sujet||'(Sans sujet)',
    corps:corps||'',
    type,
    demandeId:demandeId?parseInt(demandeId):null,
    statut:'En attente',
    dateCreation:new Date().toISOString(),
    dateEnvoi:null
  };
  try{
    await dbAdd('emails',email);
    await updateEmailsBadge();
    await addHistory('Email cr√©√©',`Email "${trunc(sujet,30)}" pour ${destinataire}`);
    console.log('Email stock√© avec succ√®s:',destinataire);
  }catch(err){
    console.error('Erreur stockerEmail:',err);
    throw err;
  }
}

// Envoyer un email (ouvrir mailto)
async function envoyerUnEmail(id){
  const email=await dbGet('emails',id);
  if(!email)return;
  
  const subjectEncoded=encodeURIComponent(email.sujet);
  const bodyEncoded=encodeURIComponent(email.corps);
  const mailtoUrl=`mailto:${email.destinataire}?subject=${subjectEncoded}&body=${bodyEncoded}`;
  
  // Ouvrir le client email
  const link=document.createElement('a');
  link.href=mailtoUrl;
  link.style.display='none';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  toast(`üìß Email ouvert dans votre client email. N'oubliez pas de cliquer sur Envoyer !`,'info');
}

// Marquer un email comme envoy√©
async function marquerEmailEnvoye(id){
  const email=await dbGet('emails',id);
  if(!email)return;
  
  email.statut='Envoy√©';
  email.dateEnvoi=new Date().toISOString();
  await dbPut('emails',email);
  
  await addHistory('Email envoy√©',`Email "${trunc(email.sujet,30)}" envoy√© √† ${email.destinataire}`);
  toast('Email marqu√© comme envoy√©','success');
  await showEmails();
}

// Voir le contenu complet d'un email
async function voirEmail(id){
  const email=await dbGet('emails',id);
  if(!email)return;
  
  const modal=document.createElement('div');
  modal.className='modal-overlay active';
  modal.innerHTML=`
    <div class="modal" style="max-width:700px">
      <div class="modal-header">
        <h3 class="modal-title">üìß ${esc(email.sujet)}</h3>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
      </div>
      <div class="modal-body">
        <p><strong>√Ä :</strong> ${esc(email.destinataire)}</p>
        <p><strong>Type :</strong> ${esc(email.type)}</p>
        <p><strong>Statut :</strong> ${esc(email.statut)}</p>
        <p><strong>Date cr√©ation :</strong> ${fmtDate(email.dateCreation)}</p>
        ${email.dateEnvoi?`<p><strong>Date envoi :</strong> ${fmtDate(email.dateEnvoi)}</p>`:''}
        <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
        <div style="background:var(--gray-50);padding:1rem;border-radius:8px;white-space:pre-wrap;font-family:monospace;font-size:.75rem">${esc(email.corps)}</div>
      </div>
      <div class="modal-footer">
        ${email.statut==='En attente'?`<button class="btn btn-success" onclick="envoyerUnEmail(${email.id});this.closest('.modal-overlay').remove()">üì§ Envoyer</button>`:''}
        ${email.statut==='En attente'?`<button class="btn btn-info" onclick="marquerEmailEnvoye(${email.id});this.closest('.modal-overlay').remove()">‚úÖ Marquer envoy√©</button>`:''}
        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Fermer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// Envoyer tous les emails en attente
async function envoyerTousEmails(){
  const emails=await dbGetAll('emails');
  const enAttente=emails.filter(e=>e.statut==='En attente');
  
  if(!enAttente.length){
    toast('Aucun email en attente','info');
    return;
  }
  
  if(!confirm(`Voulez-vous ouvrir ${enAttente.length} email(s) dans votre client email ?`))return;
  
  for(let i=0;i<enAttente.length;i++){
    setTimeout(()=>{
      envoyerUnEmail(enAttente[i].id);
    },i*1500);
  }
  
  toast(`${enAttente.length} email(s) en cours d'ouverture...`,'info');
}

async function convertirDemande(id){
  const demande=await dbGet('demandes',id);
  if(!demande)return;
  
  // Cr√©er l'entreprise avec les nouveaux champs
  // Le SIREN de la demande est directement mis dans le SIRET
  const entId=await dbAdd('entreprises',{
    nom:demande.raisonSociale||`${demande.nom} ${demande.prenom}`,
    enseigne:'',
    adresse:demande.adresse||'',
    codePostal:demande.codePostal||'',
    ville:demande.ville||'',
    emailPro:'',
    contact:`${demande.prenom||''} ${demande.nom||''}`.trim(),
    qualiteContact:'',
    emailContact:demande.email||'',
    mobileContact:demande.telephone||'',
    siret:demande.siren||'',
    idcc:'',
    secteurActivite:'',
    opco:'',
    nbSalaries:0,
    commercial:demande.commercialAssigne?parseInt(demande.commercialAssigne):null,
    statut:'Prospect'
  });
  
  // Cr√©er l'opportunit√©
  await dbAdd('opportunites',{
    nom:`Demande ${demande.raisonSociale||demande.nom} - ${demande.formationsInteressees||'Formation'}`,
    entreprise:entId,
    etape:'Prospection',
    etat:'En cours',
    priorite:'Moyenne',
    notes:`Formulaire de contact DesClick:\n\nFormations: ${demande.formationsInteressees||'-'}\nBesoins: ${demande.besoinsSpecifiques||'-'}\nMessage: ${demande.message||'-'}`
  });
  
  // Marquer la demande comme convertie
  demande.statut='Converti';
  demande.dateConversion=new Date().toISOString();
  await dbPut('demandes',demande);
  
  await addHistory('Conversion','Demande convertie en Entreprise + Opportunit√©');
  toast('Demande convertie avec succ√®s!','success');
  await showDemandes();
  await updateDashboard();
}

async function changerStatutDemande(id,statut){
  const demande=await dbGet('demandes',id);
  if(!demande)return;
  demande.statut=statut;
  await dbPut('demandes',demande);
  toast('Statut mis √† jour','success');
  await showDemandes();
  await updateDashboard();
}

// ============ EMAILS DEVIS & CONVENTIONS ============

// Obtenir l'email d'une entreprise
async function getEntrepriseEmail(nomEntreprise) {
  if (!nomEntreprise) return '';
  const entreprises = await dbGetAll('entreprises');
  const ent = entreprises.find(e => 
    (e.nom || e.raisonSociale || '').toLowerCase() === nomEntreprise.toLowerCase()
  );
  return ent?.emailContact || ent?.email || ent?.emailPro || '';
}

// Obtenir l'email PRO d'une entreprise
async function getEntrepriseEmailPro(nomEntreprise) {
  if (!nomEntreprise) return '';
  const entreprises = await dbGetAll('entreprises');
  const ent = entreprises.find(e => 
    (e.nom || e.raisonSociale || '').toLowerCase() === nomEntreprise.toLowerCase()
  );
  return ent?.emailPro || ent?.emailContact || ent?.email || '';
}

// ---- DEVIS : Pr√©visualisation et Envoi ----

async function previsualiserMailDevis(id) {
  const devis = await dbGet('devis', id);
  if (!devis) { toast('Devis non trouv√©', 'error'); return; }
  
  const emailDest = await getEntrepriseEmail(devis.entreprise);
  const ttc = (devis.montantHT || 0) * (1 + (devis.tva || 20) / 100);
  
  const sujet = `Devis ${devis.numero || 'DEV-' + String(id).padStart(4, '0')} - Formation ${devis.formation || ''} - Formation DesClick`;
  
  const corps = `Bonjour,

Suite √† notre √©change, veuillez trouver ci-joint notre devis n¬∞${devis.numero || 'DEV-' + String(id).padStart(4, '0')} concernant la formation "${devis.formation || ''}".

üìã R√©capitulatif du devis :
‚Ä¢ Entreprise : ${devis.entreprise || '-'}
‚Ä¢ Formation : ${devis.formation || '-'}
‚Ä¢ Dur√©e : ${devis.duree || '-'} heures
‚Ä¢ Nombre de stagiaires : ${devis.nbStagiaires || '-'}
‚Ä¢ Montant HT : ${fmtMoney(devis.montantHT)}
‚Ä¢ Montant TTC : ${fmtMoney(ttc)}

üìé Pi√®ces jointes :
‚Ä¢ Devis n¬∞${devis.numero || 'DEV-' + String(id).padStart(4, '0')} (PDF)
‚Ä¢ Conditions G√©n√©rales de Vente (CGV)
‚Ä¢ Programme de formation

Ce devis est valable 30 jours √† compter de sa date d'√©mission.

Pour toute question ou pour valider ce devis, n'h√©sitez pas √† nous contacter.

Cordialement,

L'√©quipe Formation DesClick
üìû 01 80 91 60 00
üìß formation@des-click.com
üåê www.formation.des-click.com`;

  const modalHtml = `
    <div id="modal-preview-mail-devis" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:700px">
        <div class="modal-header" style="background:linear-gradient(135deg,#2563eb,#3b82f6)">
          <h3 class="modal-title">üëÅÔ∏èüìß Pr√©visualisation Email - Devis</h3>
          <button class="modal-close" onclick="document.getElementById('modal-preview-mail-devis').remove()">‚úï</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow-y:auto">
          <div style="background:#f0f9ff;padding:15px;border-radius:10px;margin-bottom:15px;border-left:4px solid #2563eb">
            <div style="margin-bottom:10px">
              <strong>üìß Destinataire :</strong> 
              <span style="color:${emailDest ? '#16a34a' : '#dc2626'}">${emailDest || '‚ö†Ô∏è Email non renseign√© dans la fiche entreprise'}</span>
            </div>
            <div style="margin-bottom:10px">
              <strong>üìù Sujet :</strong> ${esc(sujet)}
            </div>
            <div style="margin-bottom:10px">
              <strong>üìé Pi√®ces jointes :</strong>
              <div style="display:flex;gap:10px;margin-top:5px;flex-wrap:wrap">
                <span style="background:#dbeafe;padding:4px 10px;border-radius:20px;font-size:0.85em">üìÑ Devis PDF</span>
                <span style="background:#fef3c7;padding:4px 10px;border-radius:20px;font-size:0.85em">üìã CGV</span>
                <span style="background:#dcfce7;padding:4px 10px;border-radius:20px;font-size:0.85em">üìö Programme de formation</span>
              </div>
            </div>
          </div>
          
          <div style="background:#f8fafc;padding:15px;border-radius:10px;border:1px solid #e2e8f0">
            <strong style="color:#475569">Corps du message :</strong>
            <pre style="white-space:pre-wrap;font-family:inherit;margin-top:10px;color:#1e293b;line-height:1.6">${esc(corps)}</pre>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('modal-preview-mail-devis').remove()">Fermer</button>
          <button class="btn btn-success" onclick="document.getElementById('modal-preview-mail-devis').remove();envoyerMailDevisVersOnglet(${id})">üìß Envoyer vers onglet Mail</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

async function envoyerMailDevisVersOnglet(id) {
  const devis = await dbGet('devis', id);
  if (!devis) { toast('Devis non trouv√©', 'error'); return; }
  
  const emailDest = await getEntrepriseEmail(devis.entreprise);
  
  if (!emailDest) {
    toast('‚ö†Ô∏è Email destinataire non trouv√©. Veuillez renseigner l\'email dans la fiche entreprise.', 'warning');
    return;
  }
  
  const ttc = (devis.montantHT || 0) * (1 + (devis.tva || 20) / 100);
  const sujet = `Devis ${devis.numero || 'DEV-' + String(id).padStart(4, '0')} - Formation ${devis.formation || ''} - Formation DesClick`;
  
  const corps = `Bonjour,

Suite √† notre √©change, veuillez trouver ci-joint notre devis n¬∞${devis.numero || 'DEV-' + String(id).padStart(4, '0')} concernant la formation "${devis.formation || ''}".

üìã R√©capitulatif du devis :
‚Ä¢ Entreprise : ${devis.entreprise || '-'}
‚Ä¢ Formation : ${devis.formation || '-'}
‚Ä¢ Dur√©e : ${devis.duree || '-'} heures
‚Ä¢ Nombre de stagiaires : ${devis.nbStagiaires || '-'}
‚Ä¢ Montant HT : ${fmtMoney(devis.montantHT)}
‚Ä¢ Montant TTC : ${fmtMoney(ttc)}

üìé Pi√®ces jointes :
‚Ä¢ Devis n¬∞${devis.numero || 'DEV-' + String(id).padStart(4, '0')} (PDF)
‚Ä¢ Conditions G√©n√©rales de Vente (CGV)
‚Ä¢ Programme de formation

Ce devis est valable 30 jours √† compter de sa date d'√©mission.

Pour toute question ou pour valider ce devis, n'h√©sitez pas √† nous contacter.

Cordialement,

L'√©quipe Formation DesClick
üìû 01 80 91 60 00
üìß formation@des-click.com
üåê www.formation.des-click.com`;

  try {
    await stockerEmail(emailDest, sujet, corps, 'Devis', null);
    
    // Mettre √† jour le devis avec la date d'envoi
    devis.dateEnvoiMail = new Date().toISOString();
    devis.emailEnvoyeA = emailDest;
    await dbPut('devis', devis);
    
    toast(`‚úÖ Email ajout√© dans l'onglet Mail ! Destinataire: ${emailDest}`, 'success');
    
    // Proposer d'aller vers l'onglet Mail
    if (confirm(`Email cr√©√© avec succ√®s !\n\nVoulez-vous aller dans l'onglet Mail pour l'envoyer ?`)) {
      switchSection('emails');
    }
  } catch (err) {
    console.error('Erreur envoi mail devis:', err);
    toast('‚ùå Erreur lors de la cr√©ation de l\'email', 'error');
  }
}

// ---- CONVENTIONS : Pr√©visualisation et Envoi (Email Pro) ----

async function previsualiserMailConvention(id) {
  const convention = await dbGet('conventions', id);
  if (!convention) { toast('Convention non trouv√©e', 'error'); return; }
  
  // Utiliser l'email PRO pour les conventions
  const emailDest = await getEntrepriseEmailPro(convention.entreprise);
  const ttc = (convention.prixHT || 0) * (convention.quantite || 1) * (1 + (convention.tva || 20) / 100);
  
  const sujet = `Convention de Formation ${convention.numero || 'CONV-' + String(id).padStart(4, '0')} - ${convention.formation || ''} - Formation DesClick`;
  
  const corps = `Bonjour,

Veuillez trouver ci-joint la convention de formation n¬∞${convention.numero || 'CONV-' + String(id).padStart(4, '0')} pour signature.

üìã R√©capitulatif de la convention :
‚Ä¢ Entreprise : ${convention.entreprise || '-'}
‚Ä¢ Formation : ${convention.formation || '-'}
‚Ä¢ Dates de formation : du ${fmtDate(convention.dateDebut)} au ${fmtDate(convention.dateFin)}
‚Ä¢ Lieu : ${convention.lieu || '√Ä d√©finir'}
‚Ä¢ Dur√©e : ${convention.duree || '-'} heures
‚Ä¢ Nombre de stagiaires : ${convention.nbStagiaires || '-'}
‚Ä¢ Montant TTC : ${fmtMoney(ttc)}

üìé Pi√®ces jointes :
‚Ä¢ Convention de formation (PDF)
‚Ä¢ Programme de formation
‚Ä¢ R√®glement int√©rieur

üìù Merci de nous retourner un exemplaire sign√© par email ou courrier.

Pour toute question, n'h√©sitez pas √† nous contacter.

Cordialement,

L'√©quipe Formation DesClick
üìû 01 80 91 60 00
üìß formation@des-click.com
üåê www.formation.des-click.com`;

  const modalHtml = `
    <div id="modal-preview-mail-convention" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:700px">
        <div class="modal-header" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6)">
          <h3 class="modal-title">üëÅÔ∏èüìß Pr√©visualisation Email - Convention (Email Pro)</h3>
          <button class="modal-close" onclick="document.getElementById('modal-preview-mail-convention').remove()">‚úï</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow-y:auto">
          <div style="background:#faf5ff;padding:15px;border-radius:10px;margin-bottom:15px;border-left:4px solid #7c3aed">
            <div style="background:#fef3c7;padding:8px 12px;border-radius:6px;margin-bottom:10px;font-size:0.9em">
              <strong>‚ö†Ô∏è Email Pro :</strong> L'envoi se fait via l'adresse email professionnelle de l'entreprise
            </div>
            <div style="margin-bottom:10px">
              <strong>üìß Destinataire (Email Pro) :</strong> 
              <span style="color:${emailDest ? '#16a34a' : '#dc2626'}">${emailDest || '‚ö†Ô∏è Email Pro non renseign√© dans la fiche entreprise'}</span>
            </div>
            <div style="margin-bottom:10px">
              <strong>üìù Sujet :</strong> ${esc(sujet)}
            </div>
            <div style="margin-bottom:10px">
              <strong>üìé Pi√®ces jointes :</strong>
              <div style="display:flex;gap:10px;margin-top:5px;flex-wrap:wrap">
                <span style="background:#e9d5ff;padding:4px 10px;border-radius:20px;font-size:0.85em">üìÑ Convention PDF</span>
                <span style="background:#dcfce7;padding:4px 10px;border-radius:20px;font-size:0.85em">üìö Programme de formation</span>
                <span style="background:#fef3c7;padding:4px 10px;border-radius:20px;font-size:0.85em">üìã R√®glement int√©rieur</span>
              </div>
            </div>
          </div>
          
          <div style="background:#f8fafc;padding:15px;border-radius:10px;border:1px solid #e2e8f0">
            <strong style="color:#475569">Corps du message :</strong>
            <pre style="white-space:pre-wrap;font-family:inherit;margin-top:10px;color:#1e293b;line-height:1.6">${esc(corps)}</pre>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('modal-preview-mail-convention').remove()">Fermer</button>
          <button class="btn btn-success" onclick="document.getElementById('modal-preview-mail-convention').remove();envoyerMailConventionVersOnglet(${id})">üìß Envoyer vers onglet Mail</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

async function envoyerMailConventionVersOnglet(id) {
  const convention = await dbGet('conventions', id);
  if (!convention) { toast('Convention non trouv√©e', 'error'); return; }
  
  // Utiliser l'email PRO pour les conventions
  const emailDest = await getEntrepriseEmailPro(convention.entreprise);
  
  if (!emailDest) {
    toast('‚ö†Ô∏è Email Pro destinataire non trouv√©. Veuillez renseigner l\'email Pro dans la fiche entreprise.', 'warning');
    return;
  }
  
  const ttc = (convention.prixHT || 0) * (convention.quantite || 1) * (1 + (convention.tva || 20) / 100);
  const sujet = `Convention de Formation ${convention.numero || 'CONV-' + String(id).padStart(4, '0')} - ${convention.formation || ''} - Formation DesClick`;
  
  const corps = `Bonjour,

Veuillez trouver ci-joint la convention de formation n¬∞${convention.numero || 'CONV-' + String(id).padStart(4, '0')} pour signature.

üìã R√©capitulatif de la convention :
‚Ä¢ Entreprise : ${convention.entreprise || '-'}
‚Ä¢ Formation : ${convention.formation || '-'}
‚Ä¢ Dates de formation : du ${fmtDate(convention.dateDebut)} au ${fmtDate(convention.dateFin)}
‚Ä¢ Lieu : ${convention.lieu || '√Ä d√©finir'}
‚Ä¢ Dur√©e : ${convention.duree || '-'} heures
‚Ä¢ Nombre de stagiaires : ${convention.nbStagiaires || '-'}
‚Ä¢ Montant TTC : ${fmtMoney(ttc)}

üìé Pi√®ces jointes :
‚Ä¢ Convention de formation (PDF)
‚Ä¢ Programme de formation
‚Ä¢ R√®glement int√©rieur

üìù Merci de nous retourner un exemplaire sign√© par email ou courrier.

Pour toute question, n'h√©sitez pas √† nous contacter.

Cordialement,

L'√©quipe Formation DesClick
üìû 01 80 91 60 00
üìß formation@des-click.com
üåê www.formation.des-click.com`;

  try {
    await stockerEmail(emailDest, sujet, corps, 'Convention', null);
    
    // Mettre √† jour la convention avec la date d'envoi
    convention.dateEnvoiMail = new Date().toISOString();
    convention.emailEnvoyeA = emailDest;
    await dbPut('conventions', convention);
    
    toast(`‚úÖ Email ajout√© dans l'onglet Mail ! Destinataire (Email Pro): ${emailDest}`, 'success');
    
    // Proposer d'aller vers l'onglet Mail
    if (confirm(`Email cr√©√© avec succ√®s !\n\nVoulez-vous aller dans l'onglet Mail pour l'envoyer ?`)) {
      switchSection('emails');
    }
  } catch (err) {
    console.error('Erreur envoi mail convention:', err);
    toast('‚ùå Erreur lors de la cr√©ation de l\'email', 'error');
  }
}

// ============ RECHERCHE SIREN & OPCO ============

// Variable pour stocker les r√©sultats de recherche SIREN
let sirenSearchResult = null;

// Rechercher les informations d'une entreprise via SIREN sur Pappers.fr
async function rechercherSIREN() {
  let numero = document.getElementById('f-siren')?.value?.trim().replace(/\s/g, '');
  
  if (!numero || (numero.length !== 9 && numero.length !== 14)) {
    toast('‚ö†Ô∏è Veuillez saisir un N¬∞ SIREN (9 chiffres) ou SIRET (14 chiffres)', 'warning');
    return;
  }
  
  // D√©terminer si c'est un SIREN ou SIRET
  const isSiret = numero.length === 14;
  const siren = isSiret ? numero.substring(0, 9) : numero;
  const typeRecherche = isSiret ? 'SIRET' : 'SIREN';
  
  // Afficher le chargement
  const resultZone = document.getElementById('siren-result-zone');
  const resultContent = document.getElementById('siren-result-content');
  resultZone.style.display = 'block';
  resultContent.innerHTML = `<div style="text-align:center;padding:20px"><span style="font-size:2em">‚è≥</span><br>Recherche par ${typeRecherche} en cours...</div>`;
  
  // Essayer plusieurs APIs en cascade
  let result = null;
  
  // 1. Essayer l'API gouvernementale (recherche-entreprises.api.gouv.fr)
  try {
    resultContent.innerHTML = `<div style="text-align:center;padding:20px"><span style="font-size:2em">‚è≥</span><br>Recherche via API Gouvernementale...</div>`;
    const gouv = await rechercherViaAPIGouv(numero, isSiret);
    if (gouv) {
      result = gouv;
      toast(`‚úÖ Entreprise trouv√©e via API Gouvernementale`, 'success');
    }
  } catch (e) {
    console.log('API Gouv √©chou√©:', e.message);
  }
  
  // 2. Si pas trouv√©, essayer Pappers via proxy CORS
  if (!result) {
    try {
      resultContent.innerHTML = `<div style="text-align:center;padding:20px"><span style="font-size:2em">‚è≥</span><br>Recherche via Pappers.fr...</div>`;
      const pappers = await rechercherViaPappers(numero, isSiret, siren);
      if (pappers) {
        result = pappers;
        toast(`‚úÖ Entreprise trouv√©e via Pappers.fr`, 'success');
      }
    } catch (e) {
      console.log('Pappers √©chou√©:', e.message);
    }
  }
  
  // Afficher le r√©sultat ou l'alternative manuelle
  if (result) {
    sirenSearchResult = result;
    afficherResultatSIREN(result);
  } else {
    afficherAlternativePappers(numero);
  }
}

// Parser une adresse pour extraire code postal et ville
function parserAdresse(adresseComplete, codePostalExistant, villeExistante) {
  let codePostal = codePostalExistant || '';
  let ville = villeExistante || '';
  let adresse = adresseComplete || '';
  
  // Si code postal et ville d√©j√† pr√©sents, retourner directement
  if (codePostal && ville) {
    return { adresse, codePostal, ville };
  }
  
  // Regex pour extraire code postal (5 chiffres) suivi de la ville
  // Format typique: "12 RUE EXEMPLE 75001 PARIS" ou "75001 PARIS"
  const regexCPVille = /\b(\d{5})\s+([A-Z√Ä-√ú][A-Z√Ä-√úa-z√†-√º\s\-']+)$/i;
  const match = adresseComplete?.match(regexCPVille);
  
  if (match) {
    codePostal = match[1];
    ville = match[2].trim().toUpperCase();
    // Enlever le CP et la ville de l'adresse
    adresse = adresseComplete.replace(regexCPVille, '').trim();
    // Nettoyer les virgules ou tirets en fin d'adresse
    adresse = adresse.replace(/[,\-\s]+$/, '').trim();
  }
  
  return { adresse, codePostal, ville };
}

// Calculer le num√©ro de TVA intracommunautaire fran√ßais
function calculerTVA(siren) {
  if (!siren || siren.length !== 9) return '';
  const sirenNum = parseInt(siren, 10);
  if (isNaN(sirenNum)) return '';
  const cle = (12 + 3 * (sirenNum % 97)) % 97;
  return `FR${cle.toString().padStart(2, '0')}${siren}`;
}

// Recherche via API Gouvernementale (gratuite, sans cl√©)
async function rechercherViaAPIGouv(numero, isSiret) {
  const url = `https://recherche-entreprises.api.gouv.fr/search?q=${numero}&page=1&per_page=1`;
  
  const response = await fetch(url, {
    method: 'GET',
    headers: { 'Accept': 'application/json' }
  });
  
  if (!response.ok) throw new Error('API Gouv non disponible');
  
  const data = await response.json();
  
  if (!data.results || data.results.length === 0) {
    throw new Error('Entreprise non trouv√©e');
  }
  
  const ent = data.results[0];
  const siege = ent.siege || ent.matching_etablissements?.[0] || {};
  
  // Parser l'adresse pour extraire CP et ville
  const adresseComplete = siege.adresse || siege.geo_adresse || '';
  const parsed = parserAdresse(
    adresseComplete,
    siege.code_postal || '',
    siege.commune || siege.libelle_commune || ''
  );
  
  // Extraire les infos IDCC
  let idcc = '';
  let conventionCollective = '';
  
  if (ent.complements?.convention_collective_renseignee && ent.complements?.liste_idcc?.length > 0) {
    idcc = ent.complements.liste_idcc[0];
  } else if (ent.liste_idcc?.length > 0) {
    idcc = ent.liste_idcc[0];
  }
  
  // Chercher le libell√© de la convention collective
  if (ent.complements?.conventions_collectives?.length > 0) {
    const cc = ent.complements.conventions_collectives[0];
    idcc = cc.idcc || idcc;
    conventionCollective = cc.libelle || cc.titre || '';
  }
  
  // Calculer le num√©ro de TVA intracommunautaire
  const siren = ent.siren || '';
  const tvaIntracommunautaire = calculerTVA(siren);
  
  return {
    siren: siren,
    raisonSociale: ent.nom_complet || ent.nom_raison_sociale || '',
    siret: siege.siret || '',
    adresse: parsed.adresse || adresseComplete,
    codePostal: parsed.codePostal,
    ville: parsed.ville,
    codeNAF: siege.activite_principale || ent.activite_principale || '',
    libelleNAF: siege.libelle_activite_principale || ent.libelle_activite_principale || '',
    effectif: ent.tranche_effectif_salarie || siege.tranche_effectif_salarie || '',
    formeJuridique: ent.nature_juridique || '',
    dateCreation: ent.date_creation || siege.date_creation || '',
    dirigeant: ent.dirigeants?.[0] ? `${ent.dirigeants[0].prenom || ''} ${ent.dirigeants[0].nom || ''}`.trim() : '',
    qualiteDirigeant: ent.dirigeants?.[0]?.qualite || ent.dirigeants?.[0]?.fonction || '',
    conventionCollective: conventionCollective,
    idcc: idcc,
    tvaIntracommunautaire: tvaIntracommunautaire
  };
}

// Recherche via Pappers avec proxy CORS
async function rechercherViaPappers(numero, isSiret, siren) {
  const PAPPERS_API_KEY = '8ab372b75afdae5d26d1cec119d594274e89903ad9e3fef8';
  const parametre = isSiret ? `siret=${numero}` : `siren=${numero}`;
  const apiUrl = `https://api.pappers.fr/v2/entreprise?${parametre}&api_token=${PAPPERS_API_KEY}`;
  
  // Essayer plusieurs proxies CORS
  const proxies = [
    `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`
  ];
  
  for (const proxyUrl of proxies) {
    try {
      const response = await fetch(proxyUrl, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      });
      
      if (response.ok) {
        const data = await response.json();
        
        if (data.siren || data.nom_entreprise) {
          const sirenFound = data.siren || siren;
          return {
            siren: sirenFound,
            raisonSociale: data.nom_entreprise || data.denomination || '',
            siret: data.siege?.siret || '',
            adresse: data.siege?.adresse_ligne_1 || '',
            codePostal: data.siege?.code_postal || '',
            ville: data.siege?.ville || '',
            codeNAF: data.siege?.code_naf || data.code_naf || '',
            libelleNAF: data.siege?.libelle_code_naf || data.libelle_code_naf || '',
            effectif: data.effectif || data.tranche_effectif || '',
            effectifMin: data.effectif_min || '',
            effectifMax: data.effectif_max || '',
            formeJuridique: data.forme_juridique || '',
            dateCreation: data.date_creation || '',
            capitalSocial: data.capital || '',
            codeAPE: data.code_naf || data.siege?.code_naf || '',
            libelleAPE: data.libelle_code_naf || data.siege?.libelle_code_naf || '',
            conventionCollective: data.convention_collectives?.[0]?.nom || '',
            idcc: data.convention_collectives?.[0]?.idcc || '',
            dirigeant: data.representants?.[0] ? `${data.representants[0].prenom || ''} ${data.representants[0].nom || ''}`.trim() : '',
            qualiteDirigeant: data.representants?.[0]?.qualite || '',
            tvaIntracommunautaire: data.numero_tva_intracommunautaire || calculerTVA(sirenFound),
            statutRCS: data.statut_rcs || ''
          };
        }
      }
    } catch (e) {
      console.log('Proxy √©chou√©:', e.message);
      continue;
    }
  }
  
  // Si tous les proxies √©chouent, essayer en direct (au cas o√π)
  try {
    const directUrl = `https://api.pappers.fr/v2/entreprise?${parametre}`;
    const response = await fetch(directUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'api-key': PAPPERS_API_KEY
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      const sirenFound = data.siren || '';
      return {
        siren: sirenFound,
        raisonSociale: data.nom_entreprise || data.denomination || '',
        siret: data.siege?.siret || '',
        adresse: data.siege?.adresse_ligne_1 || '',
        codePostal: data.siege?.code_postal || '',
        ville: data.siege?.ville || '',
        codeNAF: data.siege?.code_naf || data.code_naf || '',
        libelleNAF: data.siege?.libelle_code_naf || data.libelle_code_naf || '',
        effectif: data.effectif || data.tranche_effectif || '',
        formeJuridique: data.forme_juridique || '',
        dateCreation: data.date_creation || '',
        capitalSocial: data.capital || '',
        conventionCollective: data.convention_collectives?.[0]?.nom || '',
        idcc: data.convention_collectives?.[0]?.idcc || '',
        dirigeant: data.representants?.[0] ? `${data.representants[0].prenom || ''} ${data.representants[0].nom || ''}`.trim() : '',
        qualiteDirigeant: data.representants?.[0]?.qualite || '',
        tvaIntracommunautaire: data.numero_tva_intracommunautaire || calculerTVA(sirenFound)
      };
    }
  } catch (e) {
    console.log('Direct API √©chou√©:', e.message);
  }
  
  return null;
}

// Afficher les r√©sultats de la recherche SIREN/SIRET
function afficherResultatSIREN(data) {
  const resultContent = document.getElementById('siren-result-content');
  
  // Formater l'effectif
  let effectifDisplay = data.effectif || '-';
  if (data.effectifMin && data.effectifMax) {
    effectifDisplay = `${data.effectifMin} - ${data.effectifMax} salari√©s`;
  }
  
  // Calculer TVA si pas pr√©sent
  const tva = data.tvaIntracommunautaire || (data.siren ? calculerTVA(data.siren) : '');
  
  resultContent.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.9em">
      <div style="grid-column:1/-1;background:#dbeafe;padding:10px;border-radius:6px;margin-bottom:5px">
        <strong style="color:#1e40af;font-size:1.1em">${esc(data.raisonSociale || '-')}</strong>
        ${data.formeJuridique ? `<span style="color:#64748b;margin-left:10px">(${esc(data.formeJuridique)})</span>` : ''}
      </div>
      
      <div><strong>üî¢ SIREN:</strong> <code>${esc(data.siren || '-')}</code></div>
      <div><strong>üî¢ SIRET:</strong> <code>${esc(data.siret || '-')}</code></div>
      
      <div><strong>üìç Adresse:</strong> ${esc(data.adresse || '-')}</div>
      <div><strong>üèôÔ∏è CP / Ville:</strong> <code>${esc(data.codePostal || '-')}</code> ${esc(data.ville || '-')}</div>
      
      <div><strong>üè≠ Code NAF:</strong> <code>${esc(data.codeNAF || data.codeAPE || '-')}</code> ${data.libelleNAF || data.libelleAPE ? `<br><small style="color:#64748b">${esc(data.libelleNAF || data.libelleAPE)}</small>` : ''}</div>
      <div><strong>üë• Effectif:</strong> ${esc(effectifDisplay)}</div>
      
      <div><strong>üìÖ Cr√©ation:</strong> ${data.dateCreation ? fmtDate(data.dateCreation) : '-'}</div>
      ${data.capitalSocial ? `<div><strong>üí∞ Capital:</strong> ${fmtMoney(data.capitalSocial)}</div>` : '<div></div>'}
      
      ${tva ? `
        <div style="grid-column:1/-1;background:#e0f2fe;padding:10px;border-radius:6px;margin-top:5px">
          <strong style="color:#0369a1">üá™üá∫ TVA Intracommunautaire:</strong> <code style="font-size:1.1em;background:#fff;padding:2px 8px;border-radius:4px">${esc(tva)}</code>
        </div>
      ` : ''}
      
      ${data.idcc || data.conventionCollective ? `
        <div style="grid-column:1/-1;background:#fef3c7;padding:10px;border-radius:6px;margin-top:5px">
          <strong style="color:#92400e">üìã Convention Collective / IDCC:</strong><br>
          ${data.idcc ? `<code style="font-size:1.1em;background:#fff;padding:2px 8px;border-radius:4px;margin-right:10px">IDCC ${esc(data.idcc)}</code>` : ''}
          ${data.conventionCollective ? `<span style="color:#78350f">${esc(data.conventionCollective)}</span>` : '<span style="color:#92400e;font-style:italic">Non renseign√©e</span>'}
        </div>
      ` : `
        <div style="grid-column:1/-1;background:#fef3c7;padding:10px;border-radius:6px;margin-top:5px">
          <strong style="color:#92400e">üìã Convention Collective / IDCC:</strong>
          <span style="color:#92400e;font-style:italic;margin-left:10px">Non renseign√©e - Recherchez sur France Comp√©tences</span>
        </div>
      `}
      
      ${data.dirigeant ? `
        <div style="grid-column:1/-1;background:#dcfce7;padding:10px;border-radius:6px;margin-top:5px">
          <strong style="color:#166534">üë§ Dirigeant:</strong> ${esc(data.dirigeant)}
          ${data.qualiteDirigeant ? `<span style="color:#64748b"> (${esc(data.qualiteDirigeant)})</span>` : ''}
        </div>
      ` : ''}
    </div>
  `;
}

// Afficher l'alternative pour ouvrir Pappers manuellement
function afficherAlternativePappers(numero) {
  const resultZone = document.getElementById('siren-result-zone');
  const resultContent = document.getElementById('siren-result-content');
  resultZone.style.display = 'block';
  sirenSearchResult = null;
  
  resultContent.innerHTML = `
    <div style="text-align:center">
      <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:15px">
        <p style="margin:0;color:#92400e"><strong>‚ö†Ô∏è L'API automatique n'est pas accessible depuis votre navigateur.</strong><br>
        <small>Utilisez le lien ci-dessous pour rechercher manuellement.</small></p>
      </div>
      
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:15px">
        <a href="https://www.pappers.fr/entreprise/${numero}" target="_blank" class="btn btn-primary" style="font-size:1em;padding:12px 20px">
          üîç Ouvrir Pappers.fr ‚Üí ${numero}
        </a>
      </div>
      
      <div style="background:#f0f9ff;padding:15px;border-radius:8px;text-align:left">
        <h4 style="margin:0 0 10px 0;color:#1e40af">üìã Copiez les informations depuis Pappers :</h4>
        <div style="display:grid;gap:8px">
          <div class="form-row" style="gap:8px">
            <input class="form-input" id="manual-raison" placeholder="Raison sociale" style="flex:2">
            <input class="form-input" id="manual-siret" placeholder="SIRET (14 chiffres)" style="flex:1" maxlength="14">
          </div>
          <input class="form-input" id="manual-adresse" placeholder="Adresse">
          <div class="form-row" style="gap:8px">
            <input class="form-input" id="manual-cp" placeholder="Code postal" style="flex:1" maxlength="5">
            <input class="form-input" id="manual-ville" placeholder="Ville" style="flex:2">
          </div>
          <div class="form-row" style="gap:8px">
            <input class="form-input" id="manual-naf" placeholder="Code NAF (ex: 8559A)" style="flex:1">
            <input class="form-input" id="manual-effectif" placeholder="Effectif" type="number" style="flex:1">
          </div>
        </div>
        <button type="button" class="btn btn-success" style="margin-top:12px;width:100%" onclick="appliquerSaisieManuelle()">
          üì• Appliquer ces informations
        </button>
      </div>
    </div>
  `;
}

// Appliquer les informations SIREN trouv√©es automatiquement
function appliquerInfosSIREN() {
  if (!sirenSearchResult) {
    toast('‚ö†Ô∏è Aucune information √† appliquer', 'warning');
    return;
  }
  
  // Remplir les champs du formulaire
  if (sirenSearchResult.raisonSociale) {
    const raisonField = document.getElementById('f-raisonSociale') || document.getElementById('f-nom');
    if (raisonField) raisonField.value = sirenSearchResult.raisonSociale;
  }
  if (sirenSearchResult.siret) {
    const siretField = document.getElementById('f-siret') || document.getElementById('f-siren');
    if (siretField) siretField.value = sirenSearchResult.siret;
  }
  if (sirenSearchResult.adresse) {
    const adresseField = document.getElementById('f-adresse');
    if (adresseField) adresseField.value = sirenSearchResult.adresse;
  }
  if (sirenSearchResult.codePostal) {
    const cpField = document.getElementById('f-codePostal');
    if (cpField) cpField.value = sirenSearchResult.codePostal;
  }
  if (sirenSearchResult.ville) {
    const villeField = document.getElementById('f-ville');
    if (villeField) villeField.value = sirenSearchResult.ville;
  }
  if (sirenSearchResult.codeNAF) {
    const nafField = document.getElementById('f-codeNAF');
    if (nafField) nafField.value = sirenSearchResult.codeNAF;
  }
  if (sirenSearchResult.effectif) {
    const effectifField = document.getElementById('f-effectif') || document.getElementById('f-nbSalaries');
    if (effectifField) effectifField.value = sirenSearchResult.effectif;
  }
  if (sirenSearchResult.libelleNAF) {
    const secteurField = document.getElementById('f-secteurActivite') || document.getElementById('f-secteurActivite-demande');
    if (secteurField && !secteurField.value) secteurField.value = sirenSearchResult.libelleNAF;
  }
  
  // Appliquer l'IDCC si pr√©sent
  if (sirenSearchResult.idcc) {
    const idccSelect = document.getElementById('f-idcc') || document.getElementById('f-idcc-demande');
    if (idccSelect) {
      // Chercher l'option correspondante
      let found = false;
      for (let i = 0; i < idccSelect.options.length; i++) {
        if (idccSelect.options[i].value === sirenSearchResult.idcc || 
            idccSelect.options[i].value === sirenSearchResult.idcc.toString().padStart(4, '0')) {
          idccSelect.selectedIndex = i;
          found = true;
          break;
        }
      }
      if (found) {
        // D√©clencher l'auto-compl√©tion de l'OPCO
        if (document.getElementById('f-idcc')) {
          onIDCCChange();
        } else if (document.getElementById('f-idcc-demande')) {
          onIDCCChangeDemande();
        }
      }
    }
  }
  
  // Si pas d'IDCC trouv√© mais OPCO pr√©sent dans la recherche
  if (!sirenSearchResult.idcc && sirenSearchResult.conventionCollective) {
    // Essayer de trouver par le nom de la convention
    const idccSelect = document.getElementById('f-idcc') || document.getElementById('f-idcc-demande');
    if (idccSelect) {
      for (let i = 0; i < idccSelect.options.length; i++) {
        const intitule = idccSelect.options[i].dataset?.intitule?.toLowerCase() || '';
        if (intitule && sirenSearchResult.conventionCollective.toLowerCase().includes(intitule.substring(0, 20))) {
          idccSelect.selectedIndex = i;
          if (document.getElementById('f-idcc')) {
            onIDCCChange();
          } else {
            onIDCCChangeDemande();
          }
          break;
        }
      }
    }
  }
  
  toast('‚úÖ Informations appliqu√©es avec succ√®s', 'success');
  
  // Masquer la zone de r√©sultat
  document.getElementById('siren-result-zone').style.display = 'none';
}

// Appliquer les informations saisies manuellement
function appliquerSaisieManuelle() {
  const raison = document.getElementById('manual-raison')?.value;
  const adresse = document.getElementById('manual-adresse')?.value;
  const cp = document.getElementById('manual-cp')?.value;
  const ville = document.getElementById('manual-ville')?.value;
  const naf = document.getElementById('manual-naf')?.value;
  const effectif = document.getElementById('manual-effectif')?.value;
  
  if (raison) document.getElementById('f-raisonSociale').value = raison;
  if (adresse) document.getElementById('f-adresse').value = adresse;
  if (cp) document.getElementById('f-codePostal').value = cp;
  if (ville) document.getElementById('f-ville').value = ville;
  if (naf) {
    const nafField = document.getElementById('f-codeNAF');
    if (nafField) nafField.value = naf;
  }
  if (effectif) {
    const effectifField = document.getElementById('f-effectif');
    if (effectifField) effectifField.value = effectif;
  }
  
  toast('‚úÖ Informations appliqu√©es', 'success');
  document.getElementById('siren-result-zone').style.display = 'none';
}

// Rechercher l'OPCO - Ouvre directement les outils de recherche
async function rechercherOPCO() {
  let numero = document.getElementById('f-siren')?.value?.trim().replace(/\s/g, '');
  
  if (!numero || (numero.length !== 9 && numero.length !== 14)) {
    toast('‚ö†Ô∏è Veuillez d\'abord saisir un N¬∞ SIREN (9 chiffres) ou SIRET (14 chiffres)', 'warning');
    return;
  }
  
  // Ouvrir le modal avec liens et copie automatique
  const modalHtml = `
    <div id="modal-recherche-opco" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:700px;width:95%">
        <div class="modal-header" style="background:linear-gradient(135deg,#059669,#10b981)">
          <h3 class="modal-title">üè¢ Recherche OPCO - France Comp√©tences</h3>
          <button class="modal-close" onclick="document.getElementById('modal-recherche-opco').remove()">‚úï</button>
        </div>
        <div class="modal-body">
          
          <!-- Bloc SIRET avec copie -->
          <div style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);padding:20px;border-radius:12px;margin-bottom:20px;border:2px solid #22c55e">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:15px">
              <div>
                <div style="font-size:0.85em;color:#166534;margin-bottom:5px">üîç SIRET/SIREN √† rechercher :</div>
                <code id="siret-a-copier" style="font-size:1.8em;font-weight:bold;color:#166534;background:#fff;padding:8px 15px;border-radius:8px;display:inline-block;letter-spacing:2px">${numero}</code>
              </div>
              <button class="btn" onclick="copierSIRET('${numero}')" style="background:#059669;color:white;padding:12px 20px;font-size:1em">
                üìã Copier le SIRET
              </button>
            </div>
          </div>
          
          <!-- Instructions -->
          <div style="background:#dbeafe;padding:15px;border-radius:10px;margin-bottom:20px;border-left:4px solid #3b82f6">
            <strong style="color:#1e40af">üìù Instructions :</strong>
            <ol style="margin:10px 0 0 20px;color:#1e3a8a">
              <li>Cliquez sur <strong>"üìã Copier le SIRET"</strong> ci-dessus</li>
              <li>Cliquez sur <strong>"üèõÔ∏è Ouvrir France Comp√©tences"</strong> ci-dessous</li>
              <li>Collez le SIRET (<kbd style="background:#e2e8f0;padding:2px 6px;border-radius:4px">Ctrl+V</kbd>) dans le champ de recherche</li>
              <li>Revenez ici et s√©lectionnez l'OPCO trouv√©</li>
            </ol>
          </div>
          
          <!-- Bouton principal France Comp√©tences -->
          <div style="margin-bottom:20px">
            <button onclick="ouvrirFranceCompetences('${numero}')" 
                    style="width:100%;padding:20px;font-size:1.2em;background:linear-gradient(135deg,#166534,#22c55e);color:white;border:none;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:15px;box-shadow:0 4px 15px rgba(34,197,94,0.3)">
              <span style="font-size:1.5em">üèõÔ∏è</span>
              <span>Ouvrir France Comp√©tences</span>
              <span style="font-size:1.2em">‚ÜóÔ∏è</span>
            </button>
          </div>
          
          <!-- Autres sites -->
          <details style="margin-bottom:20px">
            <summary style="cursor:pointer;padding:10px;background:#f8fafc;border-radius:8px;font-weight:600;color:#64748b">
              üîó Autres sites de recherche OPCO...
            </summary>
            <div style="display:flex;flex-direction:column;gap:10px;padding-top:15px">
              <a href="https://www.cfadock.fr/?siret=${numero}" target="_blank" 
                 style="display:flex;align-items:center;gap:12px;padding:12px;background:#dbeafe;border-radius:8px;text-decoration:none;color:#1e40af;border:1px solid #3b82f6">
                <span style="font-size:1.5em">üîç</span>
                <div style="flex:1">
                  <strong>CFADock.fr</strong><br>
                  <small style="color:#64748b">Recherche directe avec le SIRET pr√©-rempli</small>
                </div>
                <span>‚Üí</span>
              </a>
              <a href="https://www.trouver-mon-opco.fr/annuaire-opco-siret-siren/" target="_blank"
                 style="display:flex;align-items:center;gap:12px;padding:12px;background:#fef3c7;border-radius:8px;text-decoration:none;color:#92400e;border:1px solid #f59e0b">
                <span style="font-size:1.5em">üìã</span>
                <div style="flex:1">
                  <strong>Trouver-mon-OPCO.fr</strong><br>
                  <small style="color:#64748b">Annuaire SIRET/SIREN vers OPCO</small>
                </div>
                <span>‚Üí</span>
              </a>
            </div>
          </details>
          
          <!-- S√©lection OPCO -->
          <div style="background:#f8fafc;padding:15px;border-radius:10px;border:2px solid #e2e8f0">
            <label style="font-weight:700;color:#374151;margin-bottom:12px;display:block;font-size:1.05em">
              ‚úÖ S√©lectionnez l'OPCO trouv√© :
            </label>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
              ${['AKTO', 'OPCO EP', 'OPCO Atlas', 'OPCO Mobilit√©s', 'OPCO Sant√©', 'L\'Opcommerce', 'OPCO 2i', 'AFDAS', 'Ocapiat', 'Constructys', 'Uniformation', 'Autre'].map(opco => `
                <button type="button" class="btn" style="padding:10px 8px;font-size:0.85em;background:#fff;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;transition:all 0.2s" 
                        onmouseover="this.style.borderColor='#059669';this.style.background='#dcfce7';this.style.transform='scale(1.02)'" 
                        onmouseout="this.style.borderColor='#e2e8f0';this.style.background='#fff';this.style.transform='scale(1)'"
                        onclick="selectionnerOPCO('${opco}')">${opco}</button>
              `).join('')}
            </div>
          </div>
          
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('modal-recherche-opco').remove()">Fermer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Copier le SIRET dans le presse-papiers
function copierSIRET(numero) {
  navigator.clipboard.writeText(numero).then(() => {
    toast('‚úÖ SIRET copi√© dans le presse-papiers !', 'success');
    // Animation visuelle
    const el = document.getElementById('siret-a-copier');
    if (el) {
      el.style.background = '#dcfce7';
      el.style.transition = 'background 0.3s';
      setTimeout(() => { el.style.background = '#fff'; }, 500);
    }
  }).catch(() => {
    toast('‚ö†Ô∏è Impossible de copier, s√©lectionnez manuellement', 'warning');
  });
}

// Ouvrir France Comp√©tences et copier le SIRET
function ouvrirFranceCompetences(numero) {
  navigator.clipboard.writeText(numero).then(() => {
    toast('‚úÖ SIRET copi√© ! Collez-le sur le site France Comp√©tences', 'success');
  }).catch(() => {});
  window.open('https://quel-est-mon-opco.francecompetences.fr/', '_blank');
}

// Afficher le r√©sultat de la recherche OPCO (si API fonctionne)
function afficherResultatOPCO(data) {
  const modalHtml = `
    <div id="modal-result-opco" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:500px">
        <div class="modal-header" style="background:linear-gradient(135deg,#059669,#10b981)">
          <h3 class="modal-title">‚úÖ OPCO Identifi√©</h3>
          <button class="modal-close" onclick="document.getElementById('modal-result-opco').remove()">‚úï</button>
        </div>
        <div class="modal-body">
          <div style="text-align:center;padding:20px">
            <div style="font-size:3em;margin-bottom:15px">üè¢</div>
            <h2 style="color:#059669;margin:0 0 20px 0">${esc(data.nom || '-')}</h2>
            
            <div style="background:#f0fdf4;padding:15px;border-radius:10px;text-align:left">
              ${data.siren ? `<div style="margin-bottom:8px"><strong>üî¢ SIREN OPCO:</strong> <code>${esc(data.siren)}</code></div>` : ''}
              ${data.idcc ? `<div style="margin-bottom:8px"><strong>üìã IDCC:</strong> <code>${esc(data.idcc)}</code></div>` : ''}
              ${data.codeNAF ? `<div style="margin-bottom:8px"><strong>üè≠ Code NAF:</strong> <code>${esc(data.codeNAF)}</code></div>` : ''}
              ${data.url ? `<div><strong>üåê Site web:</strong> <a href="${esc(data.url)}" target="_blank" style="color:#059669">${esc(data.url)}</a></div>` : ''}
            </div>
            
            <div style="margin-top:20px;padding:15px;background:#dbeafe;border-radius:10px">
              <p style="margin:0;color:#1e40af">
                <strong>‚úÖ L'OPCO a √©t√© automatiquement s√©lectionn√© dans le formulaire.</strong>
              </p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="document.getElementById('modal-result-opco').remove()">Fermer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Modal de recherche OPCO manuelle (fallback) - non utilis√© maintenant
function ouvrirModalOPCOManuel(siren) {
  rechercherOPCO(); // R√©utilise la fonction principale
}

// S√©lectionner un OPCO et l'appliquer au formulaire
function selectionnerOPCO(opco) {
  const opcoSelect = document.getElementById('f-opco');
  if (opcoSelect) {
    // Chercher l'option correspondante
    const options = opcoSelect.options;
    for (let i = 0; i < options.length; i++) {
      if (options[i].value === opco || options[i].text === opco) {
        opcoSelect.selectedIndex = i;
        break;
      }
    }
  }
  
  toast(`‚úÖ OPCO "${opco}" s√©lectionn√©`, 'success');
  document.getElementById('modal-recherche-opco')?.remove();
}

// ============ POST FORMATION ============

// Variables globales Post Formation
let currentPostFormationSession = null;
let postFormationDocs = [];

// Initialiser l'onglet Post Formation
async function initPostFormation() {
  await chargerListeSessionsPostFormation();
}

// Charger la liste des sessions pour le s√©lecteur
async function chargerListeSessionsPostFormation() {
  const select = document.getElementById('post-formation-session');
  if (!select) return;
  
  const sessions = await getAll('sessions');
  const formations = await getAll('formations');
  const entreprises = await getAll('entreprises');
  
  // Trier par date d√©croissante
  sessions.sort((a, b) => new Date(b.dateDebut || 0) - new Date(a.dateDebut || 0));
  
  select.innerHTML = '<option value="">-- S√©lectionner une session --</option>';
  
  sessions.forEach(s => {
    const formation = formations.find(f => f.nom === s.formation) || {};
    const entreprise = entreprises.find(e => e.raisonSociale === s.entreprise) || {};
    const dateDebut = s.dateDebut ? fmtDate(s.dateDebut) : 'N/A';
    const dateFin = s.dateFin ? fmtDate(s.dateFin) : 'N/A';
    
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = `${s.reference || 'N/A'} - ${s.formation || 'N/A'} - ${s.entreprise || 'N/A'} (${dateDebut} ‚Üí ${dateFin})`;
    opt.dataset.entreprise = s.entreprise || '';
    opt.dataset.formation = s.formation || '';
    select.appendChild(opt);
  });
}

// Charger les donn√©es post-formation pour une session
async function chargerPostFormation() {
  const sessionId = document.getElementById('post-formation-session')?.value;
  
  if (!sessionId) {
    resetPostFormation();
    return;
  }
  
  const session = await get('sessions', parseInt(sessionId));
  if (!session) {
    toast('‚ùå Session introuvable', 'error');
    return;
  }
  
  currentPostFormationSession = session;
  
  // Afficher le donneur d'ordre
  const entreprise = await getAll('entreprises').then(e => e.find(x => x.raisonSociale === session.entreprise));
  document.getElementById('post-formation-donneur').value = entreprise?.raisonSociale || session.entreprise || '-';
  
  // Charger les documents de la session
  await chargerDocumentsPostFormation(session);
  
  // Charger les √©carts de comp√©tences
  await chargerEcartsPostFormation(session);
  
  // Charger les √©margements
  await chargerEmargementsPostFormation(session);
  
  // Charger le tableau des stagiaires
  await chargerStagiairesPostFormation(session);
  
  // Charger les √©valuations de satisfaction
  await chargerSatisfactionPostFormation(session);
  
  // Mettre √† jour les KPIs
  await updateKPIsPostFormation(session);
  
  // V√©rifier les pr√©-requis
  verifierPrerequisGeneration(session);
  
  toast('‚úÖ Session charg√©e', 'success');
}

// R√©initialiser l'affichage
function resetPostFormation() {
  currentPostFormationSession = null;
  document.getElementById('post-formation-donneur').value = '';
  document.getElementById('kpi-pf-docs').textContent = '0';
  document.getElementById('kpi-pf-stagiaires').textContent = '0';
  document.getElementById('kpi-pf-reussite').textContent = '-';
  document.getElementById('kpi-pf-progression').textContent = '-';
  document.getElementById('kpi-pf-pv').textContent = '0';
  document.getElementById('kpi-pf-attestations').textContent = '0';
  document.getElementById('kpi-pf-satisfaction').textContent = '-';
  
  document.getElementById('table-post-formation-docs').innerHTML = '<tr><td colspan="6" class="empty-state">S√©lectionnez une session</td></tr>';
  document.getElementById('table-pf-stagiaires').innerHTML = '<tr><td colspan="7" class="empty-state">S√©lectionnez une session</td></tr>';
  document.getElementById('pf-ecarts-content').innerHTML = '<p class="empty-state">S√©lectionnez une session pour voir les √©valuations</p>';
  document.getElementById('pf-emargements-content').innerHTML = '<p class="empty-state">S√©lectionnez une session pour voir les √©margements</p>';
}

// Afficher un onglet Post Formation
function showPostFormationTab(tabName) {
  // Masquer tous les onglets
  document.querySelectorAll('.post-formation-tab').forEach(tab => tab.style.display = 'none');
  
  // Afficher l'onglet s√©lectionn√©
  const tab = document.getElementById(`pf-tab-${tabName}`);
  if (tab) tab.style.display = 'block';
  
  // Mettre √† jour les boutons
  document.querySelectorAll('[id^="btn-pf-"]').forEach(btn => {
    btn.className = btn.id === `btn-pf-${tabName}` ? 'btn btn-primary' : 'btn btn-secondary';
  });
}

// Charger les documents de la session
async function chargerDocumentsPostFormation(session) {
  const allDocs = await getAll('post_formation_docs');
  const docs = allDocs.filter(d => d.sessionId === session.id);
  postFormationDocs = docs;
  
  // R√©partir par cat√©gorie
  const categories = {
    pedagogiques: docs.filter(d => d.categorie === 'pedagogique'),
    evaluations: docs.filter(d => d.categorie === 'evaluation'),
    presence: docs.filter(d => d.categorie === 'presence'),
    satisfaction: docs.filter(d => d.categorie === 'satisfaction'),
    admin: docs.filter(d => d.categorie === 'administratif')
  };
  
  // Afficher dans les zones de cat√©gories
  Object.entries(categories).forEach(([key, items]) => {
    const zone = document.getElementById(`docs-${key}`);
    if (zone) {
      if (items.length === 0) {
        zone.innerHTML = '<span style="color:#9ca3af">Aucun document</span>';
      } else {
        zone.innerHTML = items.map(d => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(0,0,0,0.1)">
            <span>üìÑ ${esc(d.nom)}</span>
            <button class="btn btn-sm" onclick="telechargerDocPF(${d.id})" title="T√©l√©charger">‚¨áÔ∏è</button>
          </div>
        `).join('');
      }
    }
  });
  
  // Tableau complet
  const tbody = document.getElementById('table-post-formation-docs');
  if (docs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Aucun document pour cette session</td></tr>';
  } else {
    tbody.innerHTML = docs.map(d => `
      <tr>
        <td>${getIconeTypeDoc(d.type)}</td>
        <td><strong>${esc(d.nom)}</strong></td>
        <td><span class="badge ${getBadgeCategorie(d.categorie)}">${esc(d.categorie || '-')}</span></td>
        <td>${fmtDate(d.dateUpload)}</td>
        <td>${formatFileSize(d.taille || 0)}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="telechargerDocPF(${d.id})" title="T√©l√©charger">‚¨áÔ∏è</button>
          <button class="btn btn-sm btn-secondary" onclick="envoyerDocVersGED(${d.id})" title="Envoyer vers GED">üìÅ</button>
          <button class="btn btn-sm btn-danger" onclick="supprimerDocPF(${d.id})" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>
    `).join('');
  }
  
  document.getElementById('kpi-pf-docs').textContent = docs.length;
}

// Ic√¥ne selon type de fichier
function getIconeTypeDoc(type) {
  const types = {
    'pdf': 'üìï',
    'doc': 'üìò', 'docx': 'üìò',
    'xls': 'üìó', 'xlsx': 'üìó',
    'ppt': 'üìô', 'pptx': 'üìô',
    'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è',
    'zip': 'üì¶'
  };
  return types[type?.toLowerCase()] || 'üìÑ';
}

// Badge couleur selon cat√©gorie
function getBadgeCategorie(cat) {
  const badges = {
    'pedagogique': 'badge-blue',
    'evaluation': 'badge-green',
    'presence': 'badge-yellow',
    'satisfaction': 'badge-purple',
    'administratif': 'badge-red'
  };
  return badges[cat] || 'badge-gray';
}

// Formater la taille de fichier
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Modal upload document
function ouvrirUploadDocPostFormation() {
  if (!currentPostFormationSession) {
    toast('‚ö†Ô∏è Veuillez d\'abord s√©lectionner une session', 'warning');
    return;
  }
  
  const modalHtml = `
    <div id="modal-upload-pf" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:500px">
        <div class="modal-header" style="background:linear-gradient(135deg,#7c3aed,#a855f7)">
          <h3 class="modal-title">üì§ Uploader un Document</h3>
          <button class="modal-close" onclick="document.getElementById('modal-upload-pf').remove()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Session</label>
            <input type="text" class="form-input" value="${esc(currentPostFormationSession.reference)} - ${esc(currentPostFormationSession.formation)}" readonly style="background:#f1f5f9">
          </div>
          <div class="form-group">
            <label class="form-label">Cat√©gorie *</label>
            <select class="form-select" id="upload-pf-categorie" required>
              <option value="">-- S√©lectionner --</option>
              <option value="pedagogique">üìö Document P√©dagogique</option>
              <option value="evaluation">üìù √âvaluation / QCM</option>
              <option value="presence">‚úçÔ∏è Pr√©sence / √âmargement</option>
              <option value="satisfaction">‚≠ê Questionnaire Satisfaction</option>
              <option value="administratif">üìÑ Document Administratif</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Document *</label>
            <input type="file" class="form-input" id="upload-pf-file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.zip">
            <small style="color:#64748b">Formats accept√©s: PDF, Word, Excel, PowerPoint, Images, ZIP</small>
          </div>
          <div class="form-group">
            <label class="form-label">Description (optionnel)</label>
            <textarea class="form-input" id="upload-pf-description" rows="2" placeholder="Description du document..."></textarea>
          </div>
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="upload-pf-ged" checked>
              <span>√âgalement classer dans la GED</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('modal-upload-pf').remove()">Annuler</button>
          <button class="btn btn-primary" onclick="saveUploadDocPF()">üì§ Uploader</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Sauvegarder le document upload√©
async function saveUploadDocPF() {
  const categorie = document.getElementById('upload-pf-categorie').value;
  const fileInput = document.getElementById('upload-pf-file');
  const description = document.getElementById('upload-pf-description').value;
  const versGED = document.getElementById('upload-pf-ged').checked;
  
  if (!categorie) {
    toast('‚ö†Ô∏è Veuillez s√©lectionner une cat√©gorie', 'warning');
    return;
  }
  
  if (!fileInput.files || fileInput.files.length === 0) {
    toast('‚ö†Ô∏è Veuillez s√©lectionner un fichier', 'warning');
    return;
  }
  
  const file = fileInput.files[0];
  
  // Lire le fichier en base64
  const reader = new FileReader();
  reader.onload = async function(e) {
    const base64 = e.target.result;
    const extension = file.name.split('.').pop().toLowerCase();
    
    const doc = {
      sessionId: currentPostFormationSession.id,
      sessionRef: currentPostFormationSession.reference,
      entreprise: currentPostFormationSession.entreprise,
      formation: currentPostFormationSession.formation,
      nom: file.name,
      type: extension,
      taille: file.size,
      categorie: categorie,
      description: description,
      contenu: base64,
      dateUpload: new Date().toISOString()
    };
    
    const id = await put('post_formation_docs', doc);
    
    // Si demand√©, ajouter aussi √† la GED
    if (versGED) {
      const gedDoc = {
        type: 'session',
        reference: currentPostFormationSession.reference,
        entreprise: currentPostFormationSession.entreprise,
        nom: file.name,
        categorie: 'Post-Formation - ' + categorie,
        contenu: base64,
        dateUpload: new Date().toISOString(),
        taille: file.size
      };
      await put('ged_documents', gedDoc);
    }
    
    document.getElementById('modal-upload-pf').remove();
    toast('‚úÖ Document upload√© avec succ√®s', 'success');
    
    // Recharger les documents
    await chargerDocumentsPostFormation(currentPostFormationSession);
  };
  
  reader.readAsDataURL(file);
}

// T√©l√©charger un document
async function telechargerDocPF(id) {
  const doc = await get('post_formation_docs', id);
  if (!doc || !doc.contenu) {
    toast('‚ùå Document introuvable', 'error');
    return;
  }
  
  const link = document.createElement('a');
  link.href = doc.contenu;
  link.download = doc.nom;
  link.click();
}

// Supprimer un document
async function supprimerDocPF(id) {
  if (!confirm('Supprimer ce document ?')) return;
  
  await del('post_formation_docs', id);
  toast('‚úÖ Document supprim√©', 'success');
  await chargerDocumentsPostFormation(currentPostFormationSession);
}

// Envoyer vers GED
async function envoyerDocVersGED(id) {
  const doc = await get('post_formation_docs', id);
  if (!doc) return;
  
  const gedDoc = {
    type: 'session',
    reference: doc.sessionRef,
    entreprise: doc.entreprise,
    nom: doc.nom,
    categorie: 'Post-Formation - ' + doc.categorie,
    contenu: doc.contenu,
    dateUpload: new Date().toISOString(),
    taille: doc.taille
  };
  
  await put('ged_documents', gedDoc);
  toast('‚úÖ Document class√© dans la GED', 'success');
}

// Charger les √©carts de comp√©tences
async function chargerEcartsPostFormation(session) {
  const allEvals = await getAll('ecarts_evaluations');
  const evals = allEvals.filter(e => e.sessionRef === session.reference);
  
  const container = document.getElementById('pf-ecarts-content');
  
  if (evals.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding:30px">
        <p style="font-size:1.2em">üìä Aucune √©valuation d'√©carts de comp√©tences</p>
        <p style="color:#64748b">Les √©valuations entr√©e/sortie n'ont pas encore √©t√© r√©alis√©es pour cette session.</p>
        <button class="btn btn-primary" onclick="naviguerVersEcarts('${session.reference}')">Cr√©er une √©valuation</button>
      </div>
    `;
    return;
  }
  
  // Calculer les statistiques
  let totalEntree = 0, totalSortie = 0, nbStagiaires = 0, nbReussis = 0;
  
  evals.forEach(ev => {
    if (ev.scoreEntree !== undefined) totalEntree += ev.scoreEntree;
    if (ev.scoreSortie !== undefined) totalSortie += ev.scoreSortie;
    if (ev.scoreSortie !== undefined) nbStagiaires++;
    if (ev.succes) nbReussis++;
  });
  
  const moyEntree = nbStagiaires > 0 ? (totalEntree / nbStagiaires).toFixed(1) : '-';
  const moySortie = nbStagiaires > 0 ? (totalSortie / nbStagiaires).toFixed(1) : '-';
  const progression = nbStagiaires > 0 ? ((totalSortie - totalEntree) / nbStagiaires).toFixed(1) : '-';
  
  container.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px">
      <div style="background:#dbeafe;padding:15px;border-radius:10px;text-align:center">
        <div style="font-size:2em;font-weight:bold;color:#1e40af">${moyEntree}%</div>
        <div style="color:#64748b">Score Entr√©e Moyen</div>
      </div>
      <div style="background:#dcfce7;padding:15px;border-radius:10px;text-align:center">
        <div style="font-size:2em;font-weight:bold;color:#166534">${moySortie}%</div>
        <div style="color:#64748b">Score Sortie Moyen</div>
      </div>
      <div style="background:#fef3c7;padding:15px;border-radius:10px;text-align:center">
        <div style="font-size:2em;font-weight:bold;color:#92400e">+${progression}%</div>
        <div style="color:#64748b">Progression Moyenne</div>
      </div>
      <div style="background:#fce7f3;padding:15px;border-radius:10px;text-align:center">
        <div style="font-size:2em;font-weight:bold;color:#be185d">${nbReussis}/${nbStagiaires}</div>
        <div style="color:#64748b">R√©ussite</div>
      </div>
    </div>
    
    <table class="data-table">
      <thead>
        <tr>
          <th>Stagiaire</th>
          <th>Date Entr√©e</th>
          <th>Score Entr√©e</th>
          <th>Date Sortie</th>
          <th>Score Sortie</th>
          <th>Progression</th>
          <th>R√©sultat</th>
        </tr>
      </thead>
      <tbody>
        ${evals.map(ev => `
          <tr>
            <td><strong>${esc(ev.stagiaire || '-')}</strong></td>
            <td>${ev.dateEntree ? fmtDate(ev.dateEntree) : '-'}</td>
            <td><span class="badge badge-blue">${ev.scoreEntree !== undefined ? ev.scoreEntree + '%' : '-'}</span></td>
            <td>${ev.dateSortie ? fmtDate(ev.dateSortie) : '-'}</td>
            <td><span class="badge badge-green">${ev.scoreSortie !== undefined ? ev.scoreSortie + '%' : '-'}</span></td>
            <td><span class="badge badge-yellow">+${ev.progression || 0}%</span></td>
            <td>${ev.succes ? '<span class="badge badge-green">‚úÖ Acquis</span>' : '<span class="badge badge-red">‚ö†Ô∏è Non acquis</span>'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

// Charger les √©margements
async function chargerEmargementsPostFormation(session) {
  const allEmargements = await getAll('emargements');
  const emargements = allEmargements.filter(e => e.sessionRef === session.reference);
  
  const container = document.getElementById('pf-emargements-content');
  
  if (emargements.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding:30px">
        <p style="font-size:1.2em">‚úçÔ∏è Aucun √©margement</p>
        <p style="color:#64748b">Les feuilles d'√©margement n'ont pas √©t√© compl√©t√©es pour cette session.</p>
      </div>
    `;
    return;
  }
  
  // Grouper par date
  const byDate = {};
  emargements.forEach(e => {
    const date = e.date || 'Non d√©finie';
    if (!byDate[date]) byDate[date] = [];
    byDate[date].push(e);
  });
  
  let html = '';
  Object.entries(byDate).sort((a, b) => new Date(a[0]) - new Date(b[0])).forEach(([date, items]) => {
    const nbPresents = items.filter(i => i.present).length;
    html += `
      <div style="margin-bottom:20px;border:1px solid #e2e8f0;border-radius:10px;overflow:hidden">
        <div style="background:#f1f5f9;padding:12px 15px;display:flex;justify-content:space-between;align-items:center">
          <strong>üìÖ ${fmtDate(date)}</strong>
          <span class="badge badge-${nbPresents === items.length ? 'green' : 'yellow'}">${nbPresents}/${items.length} pr√©sents</span>
        </div>
        <table class="data-table" style="margin:0">
          <thead>
            <tr><th>Stagiaire</th><th>Matin</th><th>Apr√®s-midi</th><th>Signature</th></tr>
          </thead>
          <tbody>
            ${items.map(i => `
              <tr>
                <td>${esc(i.stagiaire || '-')}</td>
                <td>${i.matin ? '‚úÖ' : '‚ùå'}</td>
                <td>${i.apresMidi ? '‚úÖ' : '‚ùå'}</td>
                <td>${i.signature ? '<span class="badge badge-green">Sign√©</span>' : '<span class="badge badge-gray">Non sign√©</span>'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Charger le tableau des stagiaires
async function chargerStagiairesPostFormation(session) {
  const allStagiaires = await getAll('stagiaires');
  const stagiaires = allStagiaires.filter(s => s.entreprise === session.entreprise || s.session === session.reference);
  
  const allEvals = await getAll('ecarts_evaluations');
  const evals = allEvals.filter(e => e.sessionRef === session.reference);
  
  const allEmargements = await getAll('emargements');
  const emargements = allEmargements.filter(e => e.sessionRef === session.reference);
  
  const allPV = await getAll('proces_verbaux');
  const pvSession = allPV.filter(p => p.sessionId === session.id);
  
  const tbody = document.getElementById('table-pf-stagiaires');
  
  // Utiliser les stagiaires des √©valuations si disponibles
  const listeStagiaires = evals.length > 0 ? 
    [...new Set(evals.map(e => e.stagiaire))] : 
    stagiaires.map(s => `${s.prenom} ${s.nom}`);
  
  if (listeStagiaires.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Aucun stagiaire pour cette session</td></tr>';
    return;
  }
  
  tbody.innerHTML = listeStagiaires.map(nom => {
    const evalStagiaire = evals.find(e => e.stagiaire === nom) || {};
    const emargStagiaire = emargements.filter(e => e.stagiaire === nom);
    const nbPresences = emargStagiaire.filter(e => e.present || e.matin || e.apresMidi).length;
    const totalJours = [...new Set(emargements.map(e => e.date))].length;
    
    const hasAttestation = pvSession.some(p => p.stagiaires?.includes(nom));
    
    return `
      <tr>
        <td><strong>${esc(nom)}</strong></td>
        <td><span class="badge badge-blue">${evalStagiaire.scoreEntree !== undefined ? evalStagiaire.scoreEntree + '%' : '-'}</span></td>
        <td><span class="badge badge-green">${evalStagiaire.scoreSortie !== undefined ? evalStagiaire.scoreSortie + '%' : '-'}</span></td>
        <td><span class="badge badge-yellow">${evalStagiaire.progression !== undefined ? '+' + evalStagiaire.progression + '%' : '-'}</span></td>
        <td><span class="badge badge-${nbPresences === totalJours && totalJours > 0 ? 'green' : 'gray'}">${nbPresences}/${totalJours || '?'} jours</span></td>
        <td>${evalStagiaire.succes ? '<span class="badge badge-green">‚úÖ R√©ussi</span>' : '<span class="badge badge-red">‚ö†Ô∏è En cours</span>'}</td>
        <td>
          ${hasAttestation ? '<span class="badge badge-green">üìÑ G√©n√©r√©</span>' : '<span class="badge badge-gray">-</span>'}
        </td>
      </tr>
    `;
  }).join('');
  
  document.getElementById('kpi-pf-stagiaires').textContent = listeStagiaires.length;
}

// Mettre √† jour les KPIs
async function updateKPIsPostFormation(session) {
  const allEvals = await getAll('ecarts_evaluations');
  const evals = allEvals.filter(e => e.sessionRef === session.reference);
  
  const allPV = await getAll('proces_verbaux');
  const pvs = allPV.filter(p => p.sessionId === session.id);
  
  const allCerts = await getAll('certificats_realisation');
  const certs = allCerts.filter(c => c.sessionId === session.id);
  
  const allSat = await getAll('eval_chaud_session');
  const sats = allSat.filter(s => s.sessionId === session.id);
  
  // Taux de r√©ussite
  const nbReussis = evals.filter(e => e.succes).length;
  const nbTotal = evals.length;
  const tauxReussite = nbTotal > 0 ? Math.round((nbReussis / nbTotal) * 100) : 0;
  
  // Progression moyenne
  const progressions = evals.filter(e => e.progression !== undefined).map(e => e.progression);
  const moyProgression = progressions.length > 0 ? 
    Math.round(progressions.reduce((a, b) => a + b, 0) / progressions.length) : 0;
  
  // Score satisfaction moyen
  let satScore = '-';
  if (sats.length > 0) {
    const scores = sats.map(s => {
      const sum = (s.c1||0)+(s.c2||0)+(s.c3||0)+(s.c4||0)+(s.c5||0)+(s.c6||0)+(s.c7||0)+(s.c8||0);
      return sum / 8 / 5 * 100;
    });
    satScore = Math.round(scores.reduce((a,b)=>a+b,0) / scores.length) + '%';
  }
  
  document.getElementById('kpi-pf-reussite').textContent = nbTotal > 0 ? tauxReussite + '%' : '-';
  document.getElementById('kpi-pf-progression').textContent = progressions.length > 0 ? '+' + moyProgression + '%' : '-';
  document.getElementById('kpi-pf-pv').textContent = pvs.length;
  document.getElementById('kpi-pf-attestations').textContent = certs.length;
  document.getElementById('kpi-pf-satisfaction').textContent = satScore;
}

// V√©rifier les pr√©-requis pour la g√©n√©ration
function verifierPrerequisGeneration(session) {
  const checks = {
    session: !!session,
    ecarts: false,
    emargements: false,
    stagiaires: false
  };
  
  // V√©rifications asynchrones
  Promise.all([
    getAll('ecarts_evaluations'),
    getAll('emargements'),
    getAll('stagiaires')
  ]).then(([evals, emargements, stagiaires]) => {
    const sessionEvals = evals.filter(e => e.sessionRef === session.reference);
    const sessionEmarg = emargements.filter(e => e.sessionRef === session.reference);
    
    checks.ecarts = sessionEvals.length > 0 && sessionEvals.some(e => e.scoreSortie !== undefined);
    checks.emargements = sessionEmarg.length > 0;
    checks.stagiaires = sessionEvals.length > 0 || stagiaires.some(s => s.session === session.reference);
    
    // Mettre √† jour l'affichage
    document.getElementById('check-session').textContent = checks.session ? '‚úÖ' : '‚ùå';
    document.getElementById('check-ecarts').textContent = checks.ecarts ? '‚úÖ' : '‚ùå';
    document.getElementById('check-emargements').textContent = checks.emargements ? '‚úÖ' : '‚ùå';
    document.getElementById('check-stagiaires').textContent = checks.stagiaires ? '‚úÖ' : '‚ùå';
    
    // Couleur du bloc
    const allOk = Object.values(checks).every(v => v);
    const prereqDiv = document.getElementById('pf-prerequis');
    prereqDiv.style.background = allOk ? '#dcfce7' : '#fef3c7';
    prereqDiv.querySelector('h4').style.color = allOk ? '#166534' : '#92400e';
  });
}

// Naviguer vers les √©carts de comp√©tences
function naviguerVersEcarts(sessionRef) {
  showPage('qualiopi');
  // S√©lectionner l'onglet √©carts si disponible
  setTimeout(() => {
    document.querySelector('[data-quali="ecarts"]')?.click();
  }, 100);
}

// G√©n√©rer le Proc√®s Verbal
async function genererProcesVerbal() {
  if (!currentPostFormationSession) {
    toast('‚ö†Ô∏è Veuillez s√©lectionner une session', 'warning');
    return;
  }
  
  const session = currentPostFormationSession;
  
  // R√©cup√©rer les donn√©es
  const allEvals = await getAll('ecarts_evaluations');
  const evals = allEvals.filter(e => e.sessionRef === session.reference);
  
  const allEmargements = await getAll('emargements');
  const emargements = allEmargements.filter(e => e.sessionRef === session.reference);
  
  const entreprise = await getAll('entreprises').then(e => e.find(x => x.raisonSociale === session.entreprise));
  
  if (evals.length === 0) {
    toast('‚ö†Ô∏è Aucune √©valuation trouv√©e pour cette session', 'warning');
    return;
  }
  
  // Calculer les statistiques
  const nbStagiaires = evals.length;
  const nbReussis = evals.filter(e => e.succes).length;
  const moyProgression = evals.reduce((acc, e) => acc + (e.progression || 0), 0) / nbStagiaires;
  
  // G√©n√©rer le contenu HTML du PV
  const pvContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Proc√®s Verbal de Formation - ${session.reference}</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; line-height: 1.6; }
    .header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #7c3aed; padding-bottom: 20px; }
    .header h1 { color: #7c3aed; margin: 0; }
    .section { margin-bottom: 30px; }
    .section h2 { color: #4f46e5; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
    th { background: #f1f5f9; }
    .success { color: #16a34a; font-weight: bold; }
    .warning { color: #dc2626; }
    .stats { display: flex; justify-content: space-around; background: #f8fafc; padding: 20px; border-radius: 10px; margin: 20px 0; }
    .stat { text-align: center; }
    .stat-value { font-size: 2em; font-weight: bold; color: #7c3aed; }
    .signature { margin-top: 60px; display: flex; justify-content: space-between; }
    .signature-box { width: 45%; text-align: center; }
    .signature-line { border-top: 1px solid #000; margin-top: 60px; padding-top: 10px; }
    @media print { body { padding: 20px; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>PROC√àS VERBAL DE FORMATION</h1>
    <p style="font-size: 1.2em; color: #64748b;">Formation DesClick</p>
  </div>
  
  <div class="section">
    <h2>üìã Informations de la Formation</h2>
    <table>
      <tr><th width="30%">R√©f√©rence Session</th><td>${esc(session.reference || '-')}</td></tr>
      <tr><th>Formation</th><td>${esc(session.formation || '-')}</td></tr>
      <tr><th>Entreprise / Donneur d'ordre</th><td>${esc(session.entreprise || '-')}</td></tr>
      <tr><th>Dates</th><td>Du ${fmtDate(session.dateDebut)} au ${fmtDate(session.dateFin)}</td></tr>
      <tr><th>Dur√©e</th><td>${session.duree || '-'} heures</td></tr>
      <tr><th>Lieu</th><td>${esc(session.lieu || session.modalite || '-')}</td></tr>
      <tr><th>Formateur</th><td>${esc(session.formateur || '-')}</td></tr>
    </table>
  </div>
  
  <div class="section">
    <h2>üìä Bilan Global</h2>
    <div class="stats">
      <div class="stat">
        <div class="stat-value">${nbStagiaires}</div>
        <div>Stagiaires form√©s</div>
      </div>
      <div class="stat">
        <div class="stat-value">${nbReussis}</div>
        <div>Ayant acquis les comp√©tences</div>
      </div>
      <div class="stat">
        <div class="stat-value">+${moyProgression.toFixed(1)}%</div>
        <div>Progression moyenne</div>
      </div>
      <div class="stat">
        <div class="stat-value">${Math.round((nbReussis/nbStagiaires)*100)}%</div>
        <div>Taux de r√©ussite</div>
      </div>
    </div>
  </div>
  
  <div class="section">
    <h2>üë• R√©sultats Individuels</h2>
    <table>
      <thead>
        <tr>
          <th>Stagiaire</th>
          <th>Score Entr√©e</th>
          <th>Score Sortie</th>
          <th>Progression</th>
          <th>R√©sultat</th>
        </tr>
      </thead>
      <tbody>
        ${evals.map(e => `
          <tr>
            <td>${esc(e.stagiaire || '-')}</td>
            <td>${e.scoreEntree !== undefined ? e.scoreEntree + '%' : '-'}</td>
            <td>${e.scoreSortie !== undefined ? e.scoreSortie + '%' : '-'}</td>
            <td>+${e.progression || 0}%</td>
            <td class="${e.succes ? 'success' : 'warning'}">${e.succes ? '‚úÖ Acquis' : '‚ö†Ô∏è Non acquis'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  </div>
  
  <div class="section">
    <h2>‚úçÔ∏è Observations</h2>
    <p>La formation s'est d√©roul√©e conform√©ment au programme pr√©vu. Les objectifs p√©dagogiques ont √©t√© atteints pour ${nbReussis} stagiaire(s) sur ${nbStagiaires}.</p>
    <p>La progression moyenne des comp√©tences est de <strong>+${moyProgression.toFixed(1)}%</strong>.</p>
  </div>
  
  <div class="signature">
    <div class="signature-box">
      <div class="signature-line">
        <strong>Le Formateur</strong><br>
        ${esc(session.formateur || '-')}
      </div>
    </div>
    <div class="signature-box">
      <div class="signature-line">
        <strong>Le Responsable Formation</strong><br>
        Formation DesClick
      </div>
    </div>
  </div>
  
  <p style="text-align: center; margin-top: 40px; color: #64748b; font-size: 0.9em;">
    Document g√©n√©r√© le ${fmtDate(new Date().toISOString())} - Formation DesClick
  </p>
</body>
</html>
  `;
  
  // Sauvegarder le PV
  const pv = {
    sessionId: session.id,
    sessionRef: session.reference,
    entreprise: session.entreprise,
    formation: session.formation,
    dateGeneration: new Date().toISOString(),
    nbStagiaires: nbStagiaires,
    nbReussis: nbReussis,
    progression: moyProgression,
    stagiaires: evals.map(e => e.stagiaire),
    contenuHtml: pvContent
  };
  
  await put('proces_verbaux', pv);
  
  // Ouvrir dans une nouvelle fen√™tre pour impression
  const printWindow = window.open('', '_blank');
  printWindow.document.write(pvContent);
  printWindow.document.close();
  
  toast('‚úÖ Proc√®s Verbal g√©n√©r√©', 'success');
  await updateKPIsPostFormation(session);
  await chargerStagiairesPostFormation(session);
  
  // Mettre √† jour la liste des PV g√©n√©r√©s
  document.getElementById('pv-liste').innerHTML = `<div style="color:#166534">‚úÖ PV g√©n√©r√© le ${fmtDate(new Date().toISOString())}</div>`;
}

// G√©n√©rer les Attestations de Formation
async function genererAttestations() {
  if (!currentPostFormationSession) {
    toast('‚ö†Ô∏è Veuillez s√©lectionner une session', 'warning');
    return;
  }
  
  const session = currentPostFormationSession;
  
  const allEvals = await getAll('ecarts_evaluations');
  const evals = allEvals.filter(e => e.sessionRef === session.reference && e.succes);
  
  if (evals.length === 0) {
    toast('‚ö†Ô∏è Aucun stagiaire ayant r√©ussi pour cette session', 'warning');
    return;
  }
  
  // G√©n√©rer une attestation par stagiaire
  let attestationsHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Attestations de Formation - ${session.reference}</title>
  <style>
    @page { size: A4; margin: 0; }
    body { font-family: 'Georgia', serif; margin: 0; padding: 0; }
    .attestation { 
      page-break-after: always; 
      height: 100vh; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      padding: 60px;
      box-sizing: border-box;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }
    .attestation:last-child { page-break-after: auto; }
    .cadre {
      border: 3px solid #7c3aed;
      padding: 50px;
      background: white;
      max-width: 600px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .logo { font-size: 2em; margin-bottom: 20px; }
    h1 { color: #7c3aed; font-size: 2em; margin: 20px 0; text-transform: uppercase; letter-spacing: 2px; }
    .nom-stagiaire { font-size: 1.8em; color: #1e40af; margin: 30px 0; font-weight: bold; }
    .formation { font-size: 1.3em; color: #4f46e5; margin: 20px 0; font-style: italic; }
    .details { margin: 30px 0; line-height: 1.8; color: #475569; }
    .date-lieu { margin-top: 30px; color: #64748b; }
    .signature { margin-top: 40px; }
    .signature-line { border-top: 1px solid #000; width: 200px; margin: 40px auto 10px; }
  </style>
</head>
<body>
  `;
  
  evals.forEach(ev => {
    attestationsHtml += `
    <div class="attestation">
      <div class="cadre">
        <div class="logo">üéì</div>
        <h1>Attestation de Formation</h1>
        
        <p>Nous certifions que</p>
        <div class="nom-stagiaire">${esc(ev.stagiaire)}</div>
        
        <p>a suivi avec succ√®s la formation</p>
        <div class="formation">"${esc(session.formation)}"</div>
        
        <div class="details">
          <p>Dispens√©e par <strong>Formation DesClick</strong></p>
          <p>Du <strong>${fmtDate(session.dateDebut)}</strong> au <strong>${fmtDate(session.dateFin)}</strong></p>
          <p>Dur√©e : <strong>${session.duree || '-'} heures</strong></p>
          <p>Score obtenu : <strong>${ev.scoreSortie}%</strong> | Progression : <strong>+${ev.progression}%</strong></p>
        </div>
        
        <div class="date-lieu">
          Fait √† Paris, le ${fmtDate(new Date().toISOString())}
        </div>
        
        <div class="signature">
          <div class="signature-line"></div>
          <p>Le Responsable Formation<br><small>Formation DesClick</small></p>
        </div>
      </div>
    </div>
    `;
  });
  
  attestationsHtml += '</body></html>';
  
  // Sauvegarder
  const cert = {
    sessionId: session.id,
    sessionRef: session.reference,
    type: 'attestation',
    dateGeneration: new Date().toISOString(),
    nbStagiaires: evals.length,
    stagiaires: evals.map(e => e.stagiaire)
  };
  await put('certificats_realisation', cert);
  
  // Ouvrir pour impression
  const printWindow = window.open('', '_blank');
  printWindow.document.write(attestationsHtml);
  printWindow.document.close();
  
  toast(`‚úÖ ${evals.length} attestation(s) g√©n√©r√©e(s)`, 'success');
  await updateKPIsPostFormation(session);
  
  document.getElementById('attestations-liste').innerHTML = `<div style="color:#166534">‚úÖ ${evals.length} attestation(s) g√©n√©r√©e(s)</div>`;
}

// G√©n√©rer les Certificats de R√©alisation
async function genererCertificats() {
  if (!currentPostFormationSession) {
    toast('‚ö†Ô∏è Veuillez s√©lectionner une session', 'warning');
    return;
  }
  
  const session = currentPostFormationSession;
  const entreprise = await getAll('entreprises').then(e => e.find(x => x.raisonSociale === session.entreprise));
  
  const allEvals = await getAll('ecarts_evaluations');
  const evals = allEvals.filter(e => e.sessionRef === session.reference);
  
  const certificatHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Certificat de R√©alisation - ${session.reference}</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; line-height: 1.6; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { color: #f59e0b; margin: 0; border-bottom: 3px solid #f59e0b; padding-bottom: 15px; }
    .section { margin: 25px 0; }
    .section h2 { color: #92400e; font-size: 1.1em; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
    th { background: #fef3c7; width: 35%; }
    .signatures { display: flex; justify-content: space-between; margin-top: 50px; }
    .signature-box { width: 45%; }
    .signature-line { border-bottom: 1px solid #000; height: 60px; margin-bottom: 10px; }
    .footer { margin-top: 40px; text-align: center; color: #64748b; font-size: 0.9em; }
    @media print { body { padding: 20px; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìú CERTIFICAT DE R√âALISATION</h1>
    <p>Article L. 6353-1 du Code du travail</p>
  </div>
  
  <div class="section">
    <h2>ORGANISME DE FORMATION</h2>
    <table>
      <tr><th>Raison sociale</th><td>Formation DesClick</td></tr>
      <tr><th>N¬∞ de d√©claration d'activit√©</th><td>[√Ä compl√©ter]</td></tr>
    </table>
  </div>
  
  <div class="section">
    <h2>ENTREPRISE B√âN√âFICIAIRE / DONNEUR D'ORDRE</h2>
    <table>
      <tr><th>Raison sociale</th><td>${esc(entreprise?.raisonSociale || session.entreprise || '-')}</td></tr>
      <tr><th>SIRET</th><td>${esc(entreprise?.siret || '-')}</td></tr>
      <tr><th>Adresse</th><td>${esc(entreprise?.adresse || '-')} ${esc(entreprise?.codePostal || '')} ${esc(entreprise?.ville || '')}</td></tr>
    </table>
  </div>
  
  <div class="section">
    <h2>ACTION DE FORMATION</h2>
    <table>
      <tr><th>Intitul√© de la formation</th><td>${esc(session.formation || '-')}</td></tr>
      <tr><th>R√©f√©rence session</th><td>${esc(session.reference || '-')}</td></tr>
      <tr><th>Objectifs</th><td>Acquisition des comp√©tences pr√©vues au programme</td></tr>
      <tr><th>Nature de l'action</th><td>Action de formation</td></tr>
      <tr><th>Dates de r√©alisation</th><td>Du ${fmtDate(session.dateDebut)} au ${fmtDate(session.dateFin)}</td></tr>
      <tr><th>Dur√©e totale</th><td>${session.duree || '-'} heures</td></tr>
      <tr><th>Modalit√©</th><td>${esc(session.modalite || 'Pr√©sentiel')}</td></tr>
      <tr><th>Lieu</th><td>${esc(session.lieu || '-')}</td></tr>
    </table>
  </div>
  
  <div class="section">
    <h2>STAGIAIRES AYANT R√âALIS√â L'ACTION</h2>
    <table>
      <tr><th>Nombre de stagiaires</th><td>${evals.length}</td></tr>
      <tr><th>Liste des stagiaires</th><td>${evals.map(e => esc(e.stagiaire)).join(', ')}</td></tr>
      <tr><th>Dur√©e effective par stagiaire</th><td>${session.duree || '-'} heures</td></tr>
    </table>
  </div>
  
  <p style="margin-top: 30px;">
    Je soussign√©(e), repr√©sentant l√©gal de l'organisme de formation <strong>Formation DesClick</strong>, 
    certifie que l'action de formation mentionn√©e ci-dessus a bien √©t√© r√©alis√©e.
  </p>
  
  <div class="signatures">
    <div class="signature-box">
      <p><strong>L'organisme de formation</strong></p>
      <p>Formation DesClick</p>
      <div class="signature-line"></div>
      <p>Date et signature<br><small>(cachet de l'organisme)</small></p>
    </div>
    <div class="signature-box">
      <p><strong>L'entreprise b√©n√©ficiaire</strong></p>
      <p>${esc(entreprise?.raisonSociale || session.entreprise || '-')}</p>
      <div class="signature-line"></div>
      <p>Date et signature<br><small>(cachet de l'entreprise)</small></p>
    </div>
  </div>
  
  <div class="footer">
    <p>Document g√©n√©r√© le ${fmtDate(new Date().toISOString())}</p>
    <p>Ce certificat est √©tabli conform√©ment aux dispositions de l'article L. 6353-1 du Code du travail</p>
  </div>
</body>
</html>
  `;
  
  // Sauvegarder
  const cert = {
    sessionId: session.id,
    sessionRef: session.reference,
    entreprise: session.entreprise,
    type: 'certificat_realisation',
    dateGeneration: new Date().toISOString(),
    nbStagiaires: evals.length
  };
  await put('certificats_realisation', cert);
  
  // Ouvrir pour impression
  const printWindow = window.open('', '_blank');
  printWindow.document.write(certificatHtml);
  printWindow.document.close();
  
  toast('‚úÖ Certificat de r√©alisation g√©n√©r√©', 'success');
  await updateKPIsPostFormation(session);
  
  document.getElementById('certificats-liste').innerHTML = `<div style="color:#166534">‚úÖ Certificat g√©n√©r√© le ${fmtDate(new Date().toISOString())}</div>`;
}

// ============ SATISFACTION STAGIAIRES (√âvaluation √† chaud) ============

// Crit√®res d'√©valuation √† chaud
const CRITERES_EVAL_CHAUD = {
  generaux: [
    { id: 'c1', label: 'Information obtenue avant le d√©but de la formation' },
    { id: 'c2', label: 'Dur√©e et rythme de la formation par rapport au contenu du programme' },
    { id: 'c3', label: 'Horaires de la formation' },
    { id: 'c4', label: 'Lieu et locaux o√π s\'est d√©roul√©e la formation' },
    { id: 'c5', label: 'Programme et m√©thodes p√©dagogiques' },
    { id: 'c6', label: 'Mat√©riels et supports mis √† disposition' }
  ],
  satisfaction: [
    { id: 'c7', label: 'Appr√©ciation globale de la formation' },
    { id: 'c8', label: 'Recommanderiez-vous cette formation ?' }
  ]
};

// Charger les √©valuations de satisfaction pour une session
async function chargerSatisfactionPostFormation(session) {
  if (!session) {
    resetSatisfactionDisplay();
    return;
  }
  
  const allEvals = await getAll('eval_chaud_session');
  const evals = allEvals.filter(e => e.sessionId === session.id);
  
  if (evals.length === 0) {
    resetSatisfactionDisplay();
    document.getElementById('table-pf-satisfaction').innerHTML = '<tr><td colspan="12" class="empty-state">Aucune √©valuation pour cette session. Cliquez sur "‚ûï Saisir une √©valuation".</td></tr>';
    return;
  }
  
  // Calculer les moyennes par crit√®re
  const moyennes = {};
  for (let i = 1; i <= 8; i++) {
    const key = `c${i}`;
    const scores = evals.map(e => e[key]).filter(s => s !== undefined && s !== null);
    moyennes[key] = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
  }
  
  // Moyenne appr√©ciations g√©n√©rales (c1-c6)
  const moyGen = (moyennes.c1 + moyennes.c2 + moyennes.c3 + moyennes.c4 + moyennes.c5 + moyennes.c6) / 6;
  
  // Moyenne niveau satisfaction (c7-c8)
  const moySat = (moyennes.c7 + moyennes.c8) / 2;
  
  // Score global
  const scoreGlobal = (moyGen + moySat) / 2;
  
  // Mettre √† jour l'affichage
  document.getElementById('pf-sat-global').textContent = (scoreGlobal / 5 * 100).toFixed(1) + '%';
  document.getElementById('pf-sat-appreciation').textContent = (moyGen / 5 * 100).toFixed(1) + '%';
  document.getElementById('pf-sat-niveau').textContent = (moySat / 5 * 100).toFixed(1) + '%';
  document.getElementById('pf-sat-recommande').textContent = (moyennes.c8 / 5 * 100).toFixed(1) + '%';
  
  // Afficher les scores par crit√®re avec √©toiles
  for (let i = 1; i <= 8; i++) {
    const score = moyennes[`c${i}`];
    document.getElementById(`sat-c${i}`).innerHTML = renderStars(score);
    document.getElementById(`sat-s${i}`).textContent = score.toFixed(2) + '/5';
  }
  
  // Moyennes sections
  document.getElementById('pf-sat-moy-gen').textContent = moyGen.toFixed(2) + '/5 (' + (moyGen / 5 * 100).toFixed(1) + '%)';
  document.getElementById('pf-sat-moy-sat').textContent = moySat.toFixed(2) + '/5 (' + (moySat / 5 * 100).toFixed(1) + '%)';
  
  // Jauge recommandation
  const tauxReco = (moyennes.c8 / 5 * 100).toFixed(1);
  document.getElementById('pf-sat-jauge').style.width = tauxReco + '%';
  document.getElementById('pf-sat-jauge-val').textContent = tauxReco + '%';
  
  // Tableau des √©valuations individuelles
  const tbody = document.getElementById('table-pf-satisfaction');
  tbody.innerHTML = evals.map(e => {
    const moyIndiv = ((e.c1||0)+(e.c2||0)+(e.c3||0)+(e.c4||0)+(e.c5||0)+(e.c6||0)+(e.c7||0)+(e.c8||0)) / 8;
    const hasDoc = e.documentContenu ? `<button class="btn btn-sm btn-info" onclick="telechargerDocEvalChaud(${e.id})" title="T√©l√©charger le questionnaire">üìé</button>` : '';
    return `
      <tr>
        <td><strong>${esc(e.stagiaire || '-')}</strong></td>
        <td>${fmtDate(e.dateEval)}</td>
        <td>${renderMiniStars(e.c1)}</td>
        <td>${renderMiniStars(e.c2)}</td>
        <td>${renderMiniStars(e.c3)}</td>
        <td>${renderMiniStars(e.c4)}</td>
        <td>${renderMiniStars(e.c5)}</td>
        <td>${renderMiniStars(e.c6)}</td>
        <td>${renderMiniStars(e.c7)}</td>
        <td>${renderMiniStars(e.c8)}</td>
        <td><strong>${moyIndiv.toFixed(1)}</strong></td>
        <td>
          ${hasDoc}
          <button class="btn btn-sm btn-secondary" onclick="modifierEvalChaud(${e.id})" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-danger" onclick="supprimerEvalChaud(${e.id})" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  }).join('');
  
  // Commentaires
  const commentaires = evals.filter(e => e.commentaire && e.commentaire.trim());
  const commDiv = document.getElementById('pf-sat-commentaires');
  if (commentaires.length === 0) {
    commDiv.innerHTML = '<p class="empty-state">Aucun commentaire</p>';
  } else {
    commDiv.innerHTML = commentaires.map(e => `
      <div style="background:#f8fafc;padding:12px 15px;border-radius:8px;border-left:4px solid #8b5cf6">
        <div style="font-weight:600;color:#374151;margin-bottom:5px">${esc(e.stagiaire || 'Anonyme')}</div>
        <div style="color:#64748b;font-style:italic">"${esc(e.commentaire)}"</div>
      </div>
    `).join('');
  }
}

// R√©initialiser l'affichage satisfaction
function resetSatisfactionDisplay() {
  document.getElementById('pf-sat-global').textContent = '-';
  document.getElementById('pf-sat-appreciation').textContent = '-';
  document.getElementById('pf-sat-niveau').textContent = '-';
  document.getElementById('pf-sat-recommande').textContent = '-';
  
  for (let i = 1; i <= 8; i++) {
    document.getElementById(`sat-c${i}`).textContent = '-';
    document.getElementById(`sat-s${i}`).textContent = '-';
  }
  
  document.getElementById('pf-sat-moy-gen').textContent = '-';
  document.getElementById('pf-sat-moy-sat').textContent = '-';
  document.getElementById('pf-sat-jauge').style.width = '0%';
  document.getElementById('pf-sat-jauge-val').textContent = '-';
  document.getElementById('pf-sat-commentaires').innerHTML = '<p class="empty-state">Aucun commentaire</p>';
}

// G√©n√©rer les √©toiles
function renderStars(score) {
  const fullStars = Math.floor(score);
  const halfStar = score - fullStars >= 0.5;
  const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
  
  return '‚òÖ'.repeat(fullStars) + (halfStar ? '¬Ω' : '') + '‚òÜ'.repeat(emptyStars);
}

function renderMiniStars(score) {
  if (!score) return '<span style="color:#9ca3af">-</span>';
  const color = score >= 4 ? '#22c55e' : score >= 3 ? '#f59e0b' : '#ef4444';
  return `<span style="color:${color};font-weight:bold">${score}</span>`;
}

// Modal saisie √©valuation √† chaud
function ouvrirSaisieEvalChaud(evalId = null) {
  if (!currentPostFormationSession) {
    toast('‚ö†Ô∏è Veuillez d\'abord s√©lectionner une session', 'warning');
    return;
  }
  
  const session = currentPostFormationSession;
  
  // Cr√©er le formulaire
  let critereRows = '';
  
  CRITERES_EVAL_CHAUD.generaux.forEach((c, i) => {
    critereRows += `
      <div class="form-group" style="margin-bottom:10px">
        <label class="form-label" style="font-size:0.9em">${i+1}. ${c.label}</label>
        <div style="display:flex;gap:10px">
          ${[1,2,3,4,5].map(n => `
            <label style="display:flex;align-items:center;gap:5px;cursor:pointer">
              <input type="radio" name="eval-${c.id}" value="${n}" required>
              <span style="font-size:1.2em;color:#f59e0b">${'‚òÖ'.repeat(n)}</span>
            </label>
          `).join('')}
        </div>
      </div>
    `;
  });
  
  critereRows += '<hr style="margin:20px 0;border-color:#e2e8f0">';
  critereRows += '<h4 style="color:#166534;margin-bottom:15px">‚≠ê Niveau de Satisfaction</h4>';
  
  CRITERES_EVAL_CHAUD.satisfaction.forEach((c, i) => {
    critereRows += `
      <div class="form-group" style="margin-bottom:10px">
        <label class="form-label" style="font-size:0.9em">${i+1}. ${c.label}</label>
        <div style="display:flex;gap:10px">
          ${[1,2,3,4,5].map(n => `
            <label style="display:flex;align-items:center;gap:5px;cursor:pointer">
              <input type="radio" name="eval-${c.id}" value="${n}" required>
              <span style="font-size:1.2em;color:#f59e0b">${'‚òÖ'.repeat(n)}</span>
            </label>
          `).join('')}
        </div>
      </div>
    `;
  });
  
  const modalHtml = `
    <div id="modal-eval-chaud" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:700px;max-height:90vh;overflow-y:auto">
        <div class="modal-header" style="background:linear-gradient(135deg,#8b5cf6,#a855f7)">
          <h3 class="modal-title">üìä √âvaluation √† Chaud - Satisfaction Stagiaire</h3>
          <button class="modal-close" onclick="document.getElementById('modal-eval-chaud').remove()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Session</label>
            <input type="text" class="form-input" value="${esc(session.reference)} - ${esc(session.formation)}" readonly style="background:#f1f5f9">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Stagiaire *</label>
              <select class="form-select" id="eval-chaud-stagiaire" required>
                <option value="">-- S√©lectionner --</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Date √©valuation</label>
              <input type="date" class="form-input" id="eval-chaud-date" value="${new Date().toISOString().split('T')[0]}">
            </div>
          </div>
          
          <h4 style="color:#1e40af;margin:20px 0 15px 0;border-bottom:2px solid #3b82f6;padding-bottom:8px">üìã Appr√©ciations G√©n√©rales</h4>
          <p style="color:#64748b;font-size:0.85em;margin-bottom:15px">√âvaluez chaque crit√®re de 1 √† 5 √©toiles (1 = Tr√®s insatisfait, 5 = Tr√®s satisfait)</p>
          
          ${critereRows}
          
          <div class="form-group" style="margin-top:20px">
            <label class="form-label">üí¨ Commentaire libre (optionnel)</label>
            <textarea class="form-input" id="eval-chaud-commentaire" rows="3" placeholder="Suggestions, remarques, points d'am√©lioration..."></textarea>
          </div>
          
          <div class="form-group" style="margin-top:20px;padding:15px;background:#f3e8ff;border-radius:8px;border:1px solid #a855f7">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
              <label class="form-label" style="color:#7c3aed;margin:0">üìé Questionnaire scann√© (optionnel)</label>
              <button type="button" class="btn btn-sm btn-info" onclick="ouvrirImportAutoQuestionnaire()" title="Import intelligent avec OCR">
                ü§ñ Import automatique
              </button>
            </div>
            <input type="file" class="form-input" id="eval-chaud-document" accept=".pdf,.jpg,.jpeg,.png" onchange="onDocumentSelected(this)">
            <small style="color:#6b7280">Joindre le scan ou la photo du questionnaire papier rempli. L'OCR tentera d'extraire les r√©ponses automatiquement.</small>
            <div id="ocr-preview-zone" style="display:none;margin-top:15px;padding:15px;background:#fff;border-radius:8px;border:2px dashed #a855f7">
              <div id="ocr-status" style="text-align:center;padding:10px">
                <span class="ocr-spinner"></span> Analyse en cours...
              </div>
              <div id="ocr-results" style="display:none"></div>
            </div>
          </div>
          
          <input type="hidden" id="eval-chaud-id" value="${evalId || ''}">
          <input type="hidden" id="eval-chaud-doc-existant" value="">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('modal-eval-chaud').remove()">Annuler</button>
          <button class="btn btn-primary" onclick="saveEvalChaud()">üíæ Enregistrer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // Charger la liste des stagiaires
  chargerStagiairesEvalChaud(session);
}

// Charger les stagiaires pour le dropdown
async function chargerStagiairesEvalChaud(session) {
  const select = document.getElementById('eval-chaud-stagiaire');
  
  // R√©cup√©rer depuis les √©valuations d'√©carts ou les stagiaires
  const allEvals = await getAll('ecarts_evaluations');
  const evals = allEvals.filter(e => e.sessionRef === session.reference);
  
  const allStagiaires = await getAll('stagiaires');
  const stagiaires = allStagiaires.filter(s => s.entreprise === session.entreprise);
  
  // Combiner les sources
  const noms = new Set();
  evals.forEach(e => { if (e.stagiaire) noms.add(e.stagiaire); });
  stagiaires.forEach(s => { if (s.prenom && s.nom) noms.add(`${s.prenom} ${s.nom}`); });
  
  // Ajouter au select
  [...noms].sort().forEach(nom => {
    const opt = document.createElement('option');
    opt.value = nom;
    opt.textContent = nom;
    select.appendChild(opt);
  });
  
  // Option pour saisie manuelle
  const optAutre = document.createElement('option');
  optAutre.value = '__autre__';
  optAutre.textContent = '+ Autre stagiaire...';
  select.appendChild(optAutre);
  
  select.addEventListener('change', () => {
    if (select.value === '__autre__') {
      const nom = prompt('Nom du stagiaire :');
      if (nom) {
        const opt = document.createElement('option');
        opt.value = nom;
        opt.textContent = nom;
        select.insertBefore(opt, select.lastChild);
        select.value = nom;
      } else {
        select.value = '';
      }
    }
  });
}

// Sauvegarder l'√©valuation √† chaud
async function saveEvalChaud() {
  const stagiaire = document.getElementById('eval-chaud-stagiaire').value;
  const dateEval = document.getElementById('eval-chaud-date').value;
  const commentaire = document.getElementById('eval-chaud-commentaire').value;
  const evalId = document.getElementById('eval-chaud-id').value;
  const fileInput = document.getElementById('eval-chaud-document');
  const docExistant = document.getElementById('eval-chaud-doc-existant').value;
  
  if (!stagiaire) {
    toast('‚ö†Ô∏è Veuillez s√©lectionner un stagiaire', 'warning');
    return;
  }
  
  // R√©cup√©rer les notes
  const scores = {};
  for (let i = 1; i <= 8; i++) {
    const radio = document.querySelector(`input[name="eval-c${i}"]:checked`);
    if (!radio) {
      toast(`‚ö†Ô∏è Veuillez noter le crit√®re ${i}`, 'warning');
      return;
    }
    scores[`c${i}`] = parseInt(radio.value);
  }
  
  // Calculer la moyenne
  const moyenne = Object.values(scores).reduce((a, b) => a + b, 0) / 8;
  
  // R√©cup√©rer l'ann√©e de la session pour les stats
  const annee = dateEval ? new Date(dateEval).getFullYear() : new Date().getFullYear();
  
  const evalData = {
    sessionId: currentPostFormationSession.id,
    sessionRef: currentPostFormationSession.reference,
    entreprise: currentPostFormationSession.entreprise,
    entrepriseId: currentPostFormationSession.entrepriseId,
    formation: currentPostFormationSession.formation,
    formationId: currentPostFormationSession.formationId,
    stagiaire: stagiaire,
    dateEval: dateEval || new Date().toISOString().split('T')[0],
    annee: annee,
    commentaire: commentaire,
    moyenne: moyenne,
    ...scores
  };
  
  // G√©rer le document upload√©
  if (fileInput && fileInput.files && fileInput.files.length > 0) {
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = async function(e) {
      evalData.documentNom = file.name;
      evalData.documentType = file.name.split('.').pop().toLowerCase();
      evalData.documentTaille = file.size;
      evalData.documentContenu = e.target.result;
      evalData.documentDate = new Date().toISOString();
      
      await finalizeSaveEvalChaud(evalData, evalId);
    };
    
    reader.readAsDataURL(file);
  } else {
    // Conserver le document existant si pr√©sent
    if (docExistant) {
      const oldEval = await get('eval_chaud_session', parseInt(evalId));
      if (oldEval && oldEval.documentContenu) {
        evalData.documentNom = oldEval.documentNom;
        evalData.documentType = oldEval.documentType;
        evalData.documentTaille = oldEval.documentTaille;
        evalData.documentContenu = oldEval.documentContenu;
        evalData.documentDate = oldEval.documentDate;
      }
    }
    await finalizeSaveEvalChaud(evalData, evalId);
  }
}

// Finaliser la sauvegarde de l'√©valuation √† chaud
async function finalizeSaveEvalChaud(evalData, evalId) {
  if (evalId) {
    evalData.id = parseInt(evalId);
  }
  
  // Sauvegarder dans eval_chaud_session
  const savedId = await put('eval_chaud_session', evalData);
  
  // Synchroniser avec satisfactions_chaud pour Qualiopi
  await syncEvalChaudToQualiopi(evalData, savedId);
  
  // Si document upload√©, aussi l'ajouter dans post_formation_docs
  if (evalData.documentContenu) {
    const docData = {
      sessionId: evalData.sessionId,
      sessionRef: evalData.sessionRef,
      entreprise: evalData.entreprise,
      formation: evalData.formation,
      nom: `Satisfaction_${evalData.stagiaire.replace(/\s+/g, '_')}_${evalData.documentNom}`,
      type: evalData.documentType,
      taille: evalData.documentTaille,
      categorie: 'satisfaction',
      description: `Questionnaire de satisfaction - ${evalData.stagiaire}`,
      contenu: evalData.documentContenu,
      dateUpload: new Date().toISOString(),
      evalChaudId: savedId
    };
    await put('post_formation_docs', docData);
  }
  
  document.getElementById('modal-eval-chaud').remove();
  toast('‚úÖ √âvaluation enregistr√©e', 'success');
  
  // Recharger
  await chargerSatisfactionPostFormation(currentPostFormationSession);
  await chargerDocumentsPostFormation(currentPostFormationSession);
}

// Synchroniser une √©valuation √† chaud vers le module Qualiopi
async function syncEvalChaudToQualiopi(evalData, evalId) {
  // Cr√©er ou mettre √† jour dans satisfactions_chaud
  const qualiopiData = {
    evalChaudId: evalId,
    stagiaire: evalData.stagiaire,
    sessionId: evalData.sessionId,
    sessionRef: evalData.sessionRef,
    entreprise: evalData.entreprise,
    entrepriseId: evalData.entrepriseId,
    formation: evalData.formation,
    formationId: evalData.formationId,
    date: evalData.dateEval,
    annee: evalData.annee,
    noteGlobale: evalData.moyenne,
    contenu: ((evalData.c5 + evalData.c6) / 2),  // Programme et mat√©riels
    pedagogie: ((evalData.c2 + evalData.c3) / 2), // Dur√©e et horaires
    conditions: ((evalData.c1 + evalData.c4) / 2), // Info et lieu
    recommande: evalData.c8,
    appreciation: evalData.c7,
    commentaire: evalData.commentaire,
    c1: evalData.c1, c2: evalData.c2, c3: evalData.c3, c4: evalData.c4,
    c5: evalData.c5, c6: evalData.c6, c7: evalData.c7, c8: evalData.c8,
    hasDocument: !!evalData.documentContenu,
    dateSync: new Date().toISOString()
  };
  
  // Chercher si une entr√©e existe d√©j√†
  const allSatChaud = await getAll('satisfactions_chaud');
  const existing = allSatChaud.find(s => s.evalChaudId === evalId);
  
  if (existing) {
    qualiopiData.id = existing.id;
  }
  
  await put('satisfactions_chaud', qualiopiData);
}

// Modifier une √©valuation
async function modifierEvalChaud(id) {
  const evalData = await get('eval_chaud_session', id);
  if (!evalData) return;
  
  ouvrirSaisieEvalChaud(id);
  
  // Remplir le formulaire
  setTimeout(() => {
    document.getElementById('eval-chaud-stagiaire').value = evalData.stagiaire || '';
    document.getElementById('eval-chaud-date').value = evalData.dateEval || '';
    document.getElementById('eval-chaud-commentaire').value = evalData.commentaire || '';
    
    for (let i = 1; i <= 8; i++) {
      const score = evalData[`c${i}`];
      if (score) {
        const radio = document.querySelector(`input[name="eval-c${i}"][value="${score}"]`);
        if (radio) radio.checked = true;
      }
    }
    
    // Afficher le document existant s'il y en a un
    if (evalData.documentContenu) {
      document.getElementById('eval-chaud-doc-existant').value = 'true';
      const fileZone = document.getElementById('eval-chaud-document').parentNode;
      fileZone.insertAdjacentHTML('beforeend', `
        <div id="doc-existant-info" style="margin-top:10px;padding:10px;background:#dcfce7;border-radius:6px;display:flex;align-items:center;justify-content:space-between">
          <span>üìÑ <strong>${esc(evalData.documentNom)}</strong> d√©j√† joint</span>
          <div>
            <button type="button" class="btn btn-sm btn-primary" onclick="telechargerDocEvalChaud(${id})">‚¨áÔ∏è T√©l√©charger</button>
            <button type="button" class="btn btn-sm btn-danger" onclick="supprimerDocEvalChaud(${id})">üóëÔ∏è Supprimer</button>
          </div>
        </div>
      `);
    }
  }, 100);
}

// T√©l√©charger le document d'une √©valuation
async function telechargerDocEvalChaud(id) {
  const evalData = await get('eval_chaud_session', id);
  if (!evalData || !evalData.documentContenu) {
    toast('‚ùå Document introuvable', 'error');
    return;
  }
  
  const link = document.createElement('a');
  link.href = evalData.documentContenu;
  link.download = evalData.documentNom;
  link.click();
}

// Supprimer le document d'une √©valuation
async function supprimerDocEvalChaud(id) {
  if (!confirm('Supprimer le document joint ?')) return;
  
  const evalData = await get('eval_chaud_session', id);
  if (evalData) {
    delete evalData.documentNom;
    delete evalData.documentType;
    delete evalData.documentTaille;
    delete evalData.documentContenu;
    delete evalData.documentDate;
    await put('eval_chaud_session', evalData);
  }
  
  document.getElementById('eval-chaud-doc-existant').value = '';
  const docInfo = document.getElementById('doc-existant-info');
  if (docInfo) docInfo.remove();
  
  toast('‚úÖ Document supprim√©', 'success');
}

// ============ OCR - TRAITEMENT AUTOMATIQUE DES QUESTIONNAIRES ============

// Variables globales OCR
let ocrWorker = null;
let ocrResultats = null;

// Mots-cl√©s pour d√©tecter les crit√®res dans le texte OCR
const OCR_KEYWORDS = {
  c1: ['information', 'avant', 'd√©but', 'pr√©alable', 'renseignement', 'inscription'],
  c2: ['dur√©e', 'rythme', 'temps', 'contenu', 'programme'],
  c3: ['horaire', 'heure', 'planning', 'cr√©neau'],
  c4: ['lieu', 'local', 'locaux', 'salle', 'espace', 'accueil'],
  c5: ['programme', 'm√©thode', 'p√©dagogique', 'p√©dagogie', 'contenu', 'objectif'],
  c6: ['mat√©riel', 'support', 'document', 'outil', '√©quipement'],
  c7: ['globale', 'g√©n√©ral', 'ensemble', 'appr√©ciation', 'satisfaction'],
  c8: ['recommand', 'conseill', 'propos', 'sugg√©r']
};

// Patterns pour d√©tecter les notes
const NOTE_PATTERNS = {
  // Notes num√©riques : 1, 2, 3, 4, 5 ou 1/5, 2/5, etc.
  numeric: /\b([1-5])\s*(?:\/\s*5)?(?:\s*(?:√©toile|‚òÖ|star)s?)?\b/gi,
  // Texte : Tr√®s satisfait, Satisfait, etc.
  textual: {
    5: /tr√®s\s*satisfait|excellent|parfait|5\s*\/\s*5|‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ/gi,
    4: /satisfait|bien|bon|4\s*\/\s*5|‚òÖ‚òÖ‚òÖ‚òÖ/gi,
    3: /moyen|correct|passable|3\s*\/\s*5|‚òÖ‚òÖ‚òÖ/gi,
    2: /insatisfait|insuffisant|mauvais|2\s*\/\s*5|‚òÖ‚òÖ/gi,
    1: /tr√®s\s*insatisfait|nul|1\s*\/\s*5|‚òÖ/gi
  },
  // Cases coch√©es : [X], [‚úì], ‚òë, etc.
  checkbox: /[\[Ôºà\(]?\s*[xX‚úì‚úî‚òë]\s*[\]Ôºâ\)]?/g,
  // Oui/Non pour recommandation
  yesNo: {
    yes: /\boui\b|‚òë\s*oui|oui\s*‚òë|\[x\]\s*oui/gi,
    no: /\bnon\b|‚òë\s*non|non\s*‚òë|\[x\]\s*non/gi
  }
};

// Initialiser le worker Tesseract
async function initOCRWorker() {
  if (ocrWorker) return ocrWorker;
  
  try {
    ocrWorker = await Tesseract.createWorker('fra', 1, {
      logger: m => {
        if (m.status === 'recognizing text') {
          const progress = Math.round(m.progress * 100);
          const statusEl = document.getElementById('ocr-status');
          if (statusEl) {
            statusEl.innerHTML = `<span class="ocr-spinner"></span> Analyse OCR : ${progress}%`;
          }
        }
      }
    });
    return ocrWorker;
  } catch (e) {
    console.error('Erreur initialisation OCR:', e);
    throw new Error('Impossible d\'initialiser l\'OCR');
  }
}

// Fonction appel√©e quand un document est s√©lectionn√©
async function onDocumentSelected(input) {
  if (!input.files || !input.files.length) return;
  
  const file = input.files[0];
  const ext = file.name.split('.').pop().toLowerCase();
  
  // V√©rifier le type de fichier
  if (!['jpg', 'jpeg', 'png', 'pdf'].includes(ext)) {
    toast('‚ö†Ô∏è Format non support√© pour l\'OCR. Utilisez JPG, PNG ou PDF.', 'warning');
    return;
  }
  
  // Demander si on veut lancer l'analyse
  if (confirm('Voulez-vous analyser automatiquement ce questionnaire avec l\'OCR ?\n\nL\'analyse tentera d\'extraire les r√©ponses pour pr√©-remplir le formulaire.')) {
    await analyserDocumentOCR(file);
  }
}

// Ouvrir le modal d'import automatique
function ouvrirImportAutoQuestionnaire() {
  const modalHtml = `
    <div id="modal-ocr-import" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:700px">
        <div class="modal-header" style="background:linear-gradient(135deg,#8b5cf6,#6366f1)">
          <h3 class="modal-title">ü§ñ Import Automatique - OCR Intelligent</h3>
          <button class="modal-close" onclick="document.getElementById('modal-ocr-import').remove()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="info-box" style="margin-bottom:20px;border-left:4px solid #8b5cf6">
            <strong>üìã Comment √ßa marche ?</strong><br>
            <ol style="margin:10px 0 0 20px;line-height:1.8">
              <li>Scannez ou photographiez le questionnaire de satisfaction rempli</li>
              <li>Uploadez l'image (JPG, PNG) ou le PDF</li>
              <li>L'OCR analyse le document et extrait les r√©ponses</li>
              <li>V√©rifiez et corrigez si n√©cessaire avant validation</li>
            </ol>
          </div>
          
          <div style="border:2px dashed #a855f7;border-radius:12px;padding:30px;text-align:center;background:#faf5ff">
            <div style="font-size:3em;margin-bottom:15px">üìÑ</div>
            <p style="margin-bottom:15px;color:#6b7280">Glissez-d√©posez votre questionnaire ici ou</p>
            <input type="file" id="ocr-file-input" accept=".jpg,.jpeg,.png,.pdf" style="display:none" onchange="lancerAnalyseOCRModal(this)">
            <button class="btn btn-primary" onclick="document.getElementById('ocr-file-input').click()" style="padding:12px 30px">
              üì§ Choisir un fichier
            </button>
            <p style="margin-top:10px;font-size:0.85em;color:#9ca3af">Formats accept√©s : JPG, PNG, PDF</p>
          </div>
          
          <div id="ocr-modal-progress" style="display:none;margin-top:20px">
            <div style="text-align:center;padding:20px">
              <div class="ocr-spinner" style="width:40px;height:40px;border-width:4px;margin:0 auto 15px"></div>
              <div id="ocr-modal-status" style="font-weight:500;color:#6b7280">Initialisation de l'OCR...</div>
              <div style="margin-top:15px;background:#e2e8f0;border-radius:8px;height:8px;overflow:hidden">
                <div id="ocr-modal-bar" style="height:100%;width:0%;background:linear-gradient(90deg,#8b5cf6,#6366f1);transition:width 0.3s"></div>
              </div>
            </div>
          </div>
          
          <div id="ocr-modal-results" style="display:none;margin-top:20px">
            <!-- R√©sultats de l'analyse -->
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // Ajouter le drag & drop
  const dropZone = document.querySelector('#modal-ocr-import .modal-body > div:nth-child(2)');
  if (dropZone) {
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#6366f1';
      dropZone.style.background = '#ede9fe';
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = '#a855f7';
      dropZone.style.background = '#faf5ff';
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#a855f7';
      dropZone.style.background = '#faf5ff';
      if (e.dataTransfer.files.length) {
        document.getElementById('ocr-file-input').files = e.dataTransfer.files;
        lancerAnalyseOCRModal(document.getElementById('ocr-file-input'));
      }
    });
  }
}

// Lancer l'analyse depuis le modal
async function lancerAnalyseOCRModal(input) {
  if (!input.files || !input.files.length) return;
  
  const file = input.files[0];
  
  // Afficher la progression
  document.querySelector('#modal-ocr-import .modal-body > div:nth-child(2)').style.display = 'none';
  document.getElementById('ocr-modal-progress').style.display = 'block';
  
  try {
    const resultats = await analyserDocumentOCR(file, true);
    
    if (resultats) {
      afficherResultatsOCRModal(resultats, file);
    }
  } catch (e) {
    console.error('Erreur OCR:', e);
    document.getElementById('ocr-modal-status').innerHTML = `<span style="color:#ef4444">‚ùå Erreur : ${e.message}</span>`;
  }
}

// Analyser un document avec OCR
async function analyserDocumentOCR(file, isModal = false) {
  const statusEl = isModal ? document.getElementById('ocr-modal-status') : document.getElementById('ocr-status');
  const barEl = isModal ? document.getElementById('ocr-modal-bar') : null;
  
  try {
    // Afficher la zone de pr√©visualisation
    if (!isModal) {
      document.getElementById('ocr-preview-zone').style.display = 'block';
    }
    
    // Initialiser l'OCR
    if (statusEl) statusEl.innerHTML = '<span class="ocr-spinner"></span> Initialisation OCR...';
    
    // Convertir le fichier en image si c'est un PDF
    let imageData;
    const ext = file.name.split('.').pop().toLowerCase();
    
    if (ext === 'pdf') {
      if (statusEl) statusEl.innerHTML = '<span class="ocr-spinner"></span> Conversion du PDF...';
      imageData = await convertPDFToImage(file);
    } else {
      imageData = await fileToBase64(file);
    }
    
    // Lancer l'OCR
    if (statusEl) statusEl.innerHTML = '<span class="ocr-spinner"></span> Analyse du document...';
    
    const worker = await initOCRWorker();
    
    const { data } = await worker.recognize(imageData, {}, {
      logger: m => {
        if (m.status === 'recognizing text' && barEl) {
          const progress = Math.round(m.progress * 100);
          barEl.style.width = progress + '%';
          if (statusEl) statusEl.innerHTML = `<span class="ocr-spinner"></span> Analyse OCR : ${progress}%`;
        }
      }
    });
    
    // Analyser le texte extrait
    const resultats = analyserTexteOCR(data.text);
    
    if (statusEl) {
      statusEl.innerHTML = `<span style="color:#22c55e">‚úÖ Analyse termin√©e</span>`;
    }
    
    ocrResultats = resultats;
    
    if (!isModal) {
      afficherResultatsOCRPreview(resultats);
    }
    
    return resultats;
    
  } catch (e) {
    console.error('Erreur OCR:', e);
    if (statusEl) {
      statusEl.innerHTML = `<span style="color:#ef4444">‚ùå Erreur : ${e.message}</span>`;
    }
    toast('‚ùå Erreur lors de l\'analyse OCR', 'error');
    return null;
  }
}

// Convertir un fichier en base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Convertir PDF en image (premi√®re page)
async function convertPDFToImage(file) {
  // Utiliser pdf.js pour extraire une image
  const arrayBuffer = await file.arrayBuffer();
  
  // Pour simplifier, on retourne le PDF tel quel - Tesseract peut parfois le g√©rer
  // Dans un cas r√©el, on utiliserait pdf.js pour rendre en canvas
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Analyser le texte extrait par OCR pour identifier les r√©ponses
function analyserTexteOCR(texte) {
  const lignes = texte.split('\n').map(l => l.trim()).filter(l => l.length > 0);
  const resultats = {
    stagiaire: null,
    date: null,
    scores: {},
    commentaire: null,
    confiance: {},
    texteOriginal: texte
  };
  
  // Chercher le nom du stagiaire
  for (const ligne of lignes) {
    const matchNom = ligne.match(/(?:nom|stagiaire|participant)\s*[:\-]?\s*([A-Za-z√Ä-√ø\s\-]+)/i);
    if (matchNom) {
      resultats.stagiaire = matchNom[1].trim();
      resultats.confiance.stagiaire = 'medium';
      break;
    }
  }
  
  // Chercher la date
  for (const ligne of lignes) {
    const matchDate = ligne.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
    if (matchDate) {
      let annee = matchDate[3];
      if (annee.length === 2) annee = '20' + annee;
      resultats.date = `${annee}-${matchDate[2].padStart(2, '0')}-${matchDate[1].padStart(2, '0')}`;
      resultats.confiance.date = 'high';
      break;
    }
  }
  
  // Analyser chaque crit√®re
  for (let i = 1; i <= 8; i++) {
    const critereKey = `c${i}`;
    const keywords = OCR_KEYWORDS[critereKey];
    
    // Chercher les lignes contenant les mots-cl√©s du crit√®re
    for (let j = 0; j < lignes.length; j++) {
      const ligne = lignes[j].toLowerCase();
      const ligneComplete = lignes.slice(j, j + 3).join(' ').toLowerCase();
      
      // V√©rifier si la ligne contient des mots-cl√©s du crit√®re
      const hasKeyword = keywords.some(kw => ligneComplete.includes(kw.toLowerCase()));
      
      if (hasKeyword) {
        // Chercher une note dans cette zone
        const score = extraireNote(ligneComplete);
        if (score) {
          resultats.scores[critereKey] = score.value;
          resultats.confiance[critereKey] = score.confidence;
          break;
        }
      }
    }
  }
  
  // Si pas de scores trouv√©s, essayer une analyse plus simple
  // Chercher toutes les notes dans le document
  if (Object.keys(resultats.scores).length < 4) {
    const toutesNotes = extraireToutesNotes(texte);
    if (toutesNotes.length >= 8) {
      for (let i = 1; i <= 8 && i <= toutesNotes.length; i++) {
        if (!resultats.scores[`c${i}`]) {
          resultats.scores[`c${i}`] = toutesNotes[i - 1];
          resultats.confiance[`c${i}`] = 'low';
        }
      }
    }
  }
  
  // Chercher le commentaire
  for (const ligne of lignes) {
    if (ligne.toLowerCase().includes('commentaire') || 
        ligne.toLowerCase().includes('remarque') || 
        ligne.toLowerCase().includes('suggestion')) {
      const idx = lignes.indexOf(ligne);
      if (idx < lignes.length - 1) {
        resultats.commentaire = lignes.slice(idx + 1, idx + 4).join(' ').substring(0, 500);
        break;
      }
    }
  }
  
  return resultats;
}

// Extraire une note d'un texte
function extraireNote(texte) {
  // Chercher des notes textuelles d'abord
  for (const [score, pattern] of Object.entries(NOTE_PATTERNS.textual)) {
    if (pattern.test(texte)) {
      return { value: parseInt(score), confidence: 'high' };
    }
  }
  
  // Chercher des notes num√©riques
  const matchNum = texte.match(/\b([1-5])\b/);
  if (matchNum) {
    return { value: parseInt(matchNum[1]), confidence: 'medium' };
  }
  
  // Compter les √©toiles ou cases coch√©es
  const etoiles = (texte.match(/‚òÖ|‚òÜ|‚úì|‚úî|‚òë|\[x\]/gi) || []).length;
  if (etoiles >= 1 && etoiles <= 5) {
    return { value: etoiles, confidence: 'medium' };
  }
  
  return null;
}

// Extraire toutes les notes du document
function extraireToutesNotes(texte) {
  const notes = [];
  
  // Pattern pour trouver des suites de notes (1-5)
  const matches = texte.match(/(?<![0-9])[1-5](?![0-9\/])/g);
  
  if (matches) {
    matches.forEach(m => {
      const n = parseInt(m);
      if (n >= 1 && n <= 5) notes.push(n);
    });
  }
  
  return notes.slice(0, 8);
}

// Afficher les r√©sultats OCR dans la pr√©visualisation
function afficherResultatsOCRPreview(resultats) {
  const resultsDiv = document.getElementById('ocr-results');
  if (!resultsDiv) return;
  
  const nbScores = Object.keys(resultats.scores).length;
  const qualite = nbScores >= 6 ? 'high' : nbScores >= 3 ? 'medium' : 'low';
  const qualiteText = qualite === 'high' ? 'Bonne' : qualite === 'medium' ? 'Moyenne' : 'Faible';
  const qualiteColor = qualite === 'high' ? '#22c55e' : qualite === 'medium' ? '#f59e0b' : '#ef4444';
  
  resultsDiv.innerHTML = `
    <div style="margin-bottom:15px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong>üìä R√©sultats de l'analyse</strong>
        <span class="ocr-confidence ${qualite}" style="margin-left:10px">Qualit√©: ${qualiteText}</span>
      </div>
      <button type="button" class="btn btn-sm btn-success" onclick="appliquerResultatsOCR()">‚úÖ Appliquer</button>
    </div>
    
    ${resultats.stagiaire ? `
      <div class="ocr-result-item">
        <span class="ocr-result-label">üë§ Stagiaire d√©tect√©</span>
        <span class="ocr-result-value">
          <strong>${esc(resultats.stagiaire)}</strong>
          <span class="ocr-confidence ${resultats.confiance.stagiaire || 'low'}">${(resultats.confiance.stagiaire || 'low').toUpperCase()}</span>
        </span>
      </div>
    ` : ''}
    
    ${resultats.date ? `
      <div class="ocr-result-item">
        <span class="ocr-result-label">üìÖ Date d√©tect√©e</span>
        <span class="ocr-result-value">
          <strong>${resultats.date}</strong>
          <span class="ocr-confidence ${resultats.confiance.date || 'low'}">${(resultats.confiance.date || 'low').toUpperCase()}</span>
        </span>
      </div>
    ` : ''}
    
    <div style="margin-top:10px;font-weight:500;color:#374151">üìù Notes d√©tect√©es :</div>
    ${[1,2,3,4,5,6,7,8].map(i => {
      const key = `c${i}`;
      const score = resultats.scores[key];
      const conf = resultats.confiance[key] || 'low';
      const label = CRITERES_EVAL_CHAUD.generaux[i-1]?.label || CRITERES_EVAL_CHAUD.satisfaction[i-7]?.label || `Crit√®re ${i}`;
      return `
        <div class="ocr-result-item" style="border-left-color:${score ? '#22c55e' : '#e2e8f0'}">
          <span class="ocr-result-label" style="font-size:0.85em">${i}. ${label.substring(0, 40)}...</span>
          <span class="ocr-result-value">
            ${score ? `
              <strong style="color:#f59e0b">${'‚òÖ'.repeat(score)}${'‚òÜ'.repeat(5-score)}</strong>
              <span class="ocr-confidence ${conf}">${conf.toUpperCase()}</span>
            ` : '<span style="color:#9ca3af">Non d√©tect√©</span>'}
          </span>
        </div>
      `;
    }).join('')}
    
    ${resultats.commentaire ? `
      <div style="margin-top:10px;padding:10px;background:#f8fafc;border-radius:6px">
        <div style="font-weight:500;color:#374151;margin-bottom:5px">üí¨ Commentaire d√©tect√© :</div>
        <div style="font-style:italic;color:#64748b">"${esc(resultats.commentaire.substring(0, 200))}..."</div>
      </div>
    ` : ''}
    
    <div style="margin-top:15px;padding:10px;background:#fef3c7;border-radius:6px;font-size:0.85em;color:#92400e">
      ‚ö†Ô∏è <strong>Important :</strong> V√©rifiez les valeurs avant de valider. L'OCR peut faire des erreurs.
    </div>
  `;
  
  resultsDiv.style.display = 'block';
  document.getElementById('ocr-status').style.display = 'none';
}

// Afficher les r√©sultats dans le modal
function afficherResultatsOCRModal(resultats, file) {
  document.getElementById('ocr-modal-progress').style.display = 'none';
  
  const resultsDiv = document.getElementById('ocr-modal-results');
  const nbScores = Object.keys(resultats.scores).length;
  
  resultsDiv.innerHTML = `
    <div class="card" style="margin:0">
      <div class="card-header" style="background:#dcfce7">
        <h4 class="card-title" style="color:#166534;margin:0">‚úÖ Analyse termin√©e - ${nbScores}/8 crit√®res d√©tect√©s</h4>
      </div>
      <div style="padding:15px">
        <div style="margin-bottom:15px;padding:10px;background:#f0fdf4;border-radius:8px;display:flex;align-items:center;gap:10px">
          <span style="font-size:1.5em">üìÑ</span>
          <div>
            <div style="font-weight:500">${esc(file.name)}</div>
            <div style="font-size:0.85em;color:#6b7280">${(file.size / 1024).toFixed(1)} Ko</div>
          </div>
        </div>
        
        ${resultats.stagiaire ? `<p><strong>üë§ Stagiaire :</strong> ${esc(resultats.stagiaire)}</p>` : ''}
        ${resultats.date ? `<p><strong>üìÖ Date :</strong> ${resultats.date}</p>` : ''}
        
        <div style="margin:15px 0">
          <strong>üìù Notes d√©tect√©es :</strong>
          <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;margin-top:10px">
            ${[1,2,3,4,5,6,7,8].map(i => {
              const score = resultats.scores[`c${i}`];
              return `
                <div style="text-align:center;padding:10px;background:${score ? '#dcfce7' : '#f1f5f9'};border-radius:8px">
                  <div style="font-size:0.8em;color:#6b7280">C${i}</div>
                  <div style="font-size:1.2em;font-weight:bold;color:${score ? '#166534' : '#9ca3af'}">${score || '-'}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:20px">
          <button class="btn btn-success" onclick="appliquerResultatsOCRDepuisModal()" style="flex:1">
            ‚úÖ Appliquer et fermer
          </button>
          <button class="btn btn-secondary" onclick="document.getElementById('modal-ocr-import').remove()">
            Annuler
          </button>
        </div>
      </div>
    </div>
  `;
  
  resultsDiv.style.display = 'block';
}

// Appliquer les r√©sultats OCR au formulaire
function appliquerResultatsOCR() {
  if (!ocrResultats) {
    toast('‚ö†Ô∏è Aucun r√©sultat √† appliquer', 'warning');
    return;
  }
  
  // Appliquer le stagiaire
  if (ocrResultats.stagiaire) {
    const select = document.getElementById('eval-chaud-stagiaire');
    // Chercher si le stagiaire existe dans la liste
    const option = Array.from(select.options).find(o => 
      o.text.toLowerCase().includes(ocrResultats.stagiaire.toLowerCase())
    );
    if (option) {
      select.value = option.value;
    }
  }
  
  // Appliquer la date
  if (ocrResultats.date) {
    document.getElementById('eval-chaud-date').value = ocrResultats.date;
  }
  
  // Appliquer les scores
  for (const [key, value] of Object.entries(ocrResultats.scores)) {
    const radio = document.querySelector(`input[name="eval-${key}"][value="${value}"]`);
    if (radio) {
      radio.checked = true;
      // Animation visuelle
      radio.parentElement.style.background = '#dcfce7';
      setTimeout(() => radio.parentElement.style.background = '', 1000);
    }
  }
  
  // Appliquer le commentaire
  if (ocrResultats.commentaire) {
    document.getElementById('eval-chaud-commentaire').value = ocrResultats.commentaire;
  }
  
  toast('‚úÖ R√©sultats OCR appliqu√©s au formulaire', 'success');
}

// Appliquer les r√©sultats depuis le modal
function appliquerResultatsOCRDepuisModal() {
  appliquerResultatsOCR();
  
  // Copier le fichier dans le champ de fichier principal
  const modalInput = document.getElementById('ocr-file-input');
  const mainInput = document.getElementById('eval-chaud-document');
  
  if (modalInput.files.length > 0 && mainInput) {
    const dt = new DataTransfer();
    dt.items.add(modalInput.files[0]);
    mainInput.files = dt.files;
  }
  
  document.getElementById('modal-ocr-import').remove();
}

// ============ IMPORT EN MASSE DES QUESTIONNAIRES ============

// Ouvrir le modal d'import en masse
function ouvrirImportMasseQuestionnaires() {
  if (!currentPostFormationSession) {
    toast('‚ö†Ô∏è Veuillez d\'abord s√©lectionner une session', 'warning');
    return;
  }
  
  const session = currentPostFormationSession;
  
  const modalHtml = `
    <div id="modal-import-masse" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:900px;max-height:90vh;overflow-y:auto">
        <div class="modal-header" style="background:linear-gradient(135deg,#8b5cf6,#6366f1)">
          <h3 class="modal-title">ü§ñ Import en Masse - OCR Intelligent</h3>
          <button class="modal-close" onclick="document.getElementById('modal-import-masse').remove()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="info-box" style="margin-bottom:20px">
            <strong>üìã Session :</strong> ${esc(session.reference)} - ${esc(session.formation)}<br>
            <strong>üè¢ Entreprise :</strong> ${esc(session.entreprise)}
          </div>
          
          <div style="border:2px dashed #a855f7;border-radius:12px;padding:30px;text-align:center;background:#faf5ff;margin-bottom:20px">
            <div style="font-size:3em;margin-bottom:15px">üìÑüìÑüìÑ</div>
            <p style="margin-bottom:15px;color:#6b7280">S√©lectionnez plusieurs questionnaires scann√©s</p>
            <input type="file" id="import-masse-files" accept=".jpg,.jpeg,.png,.pdf" multiple style="display:none" onchange="preparerImportMasse(this)">
            <button class="btn btn-primary" onclick="document.getElementById('import-masse-files').click()" style="padding:12px 30px">
              üì§ Choisir les fichiers
            </button>
            <p style="margin-top:10px;font-size:0.85em;color:#9ca3af">Formats : JPG, PNG, PDF (plusieurs fichiers)</p>
          </div>
          
          <div id="import-masse-liste" style="display:none">
            <h4 style="margin-bottom:15px">üìã Fichiers √† traiter</h4>
            <div id="import-masse-files-list"></div>
            
            <div style="margin-top:20px;display:flex;gap:10px">
              <button class="btn btn-success" onclick="lancerImportMasseOCR()" style="flex:1">
                üöÄ Lancer l'analyse OCR
              </button>
              <button class="btn btn-secondary" onclick="document.getElementById('import-masse-files').value='';document.getElementById('import-masse-liste').style.display='none'">
                üóëÔ∏è Annuler
              </button>
            </div>
          </div>
          
          <div id="import-masse-progress" style="display:none">
            <h4 style="margin-bottom:15px">‚è≥ Analyse en cours...</h4>
            <div id="import-masse-progress-list"></div>
          </div>
          
          <div id="import-masse-resultats" style="display:none">
            <h4 style="margin-bottom:15px">‚úÖ R√©sultats de l'import</h4>
            <div id="import-masse-resultats-list"></div>
            
            <div style="margin-top:20px;display:flex;gap:10px">
              <button class="btn btn-success" onclick="validerImportMasse()" style="flex:1">
                ‚úÖ Valider et enregistrer tout
              </button>
              <button class="btn btn-secondary" onclick="document.getElementById('modal-import-masse').remove()">
                Fermer
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Variables pour l'import en masse
let importMasseFiles = [];
let importMasseResultats = [];

// Pr√©parer l'import en masse
function preparerImportMasse(input) {
  if (!input.files || !input.files.length) return;
  
  importMasseFiles = Array.from(input.files);
  
  const listeDiv = document.getElementById('import-masse-files-list');
  listeDiv.innerHTML = importMasseFiles.map((f, i) => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px;margin:5px 0;background:#f8fafc;border-radius:6px">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:1.5em">üìÑ</span>
        <div>
          <div style="font-weight:500">${esc(f.name)}</div>
          <div style="font-size:0.85em;color:#6b7280">${(f.size / 1024).toFixed(1)} Ko</div>
        </div>
      </div>
      <button class="btn btn-sm btn-danger" onclick="retirerFichierImportMasse(${i})">‚úï</button>
    </div>
  `).join('');
  
  document.getElementById('import-masse-liste').style.display = 'block';
}

// Retirer un fichier de la liste
function retirerFichierImportMasse(index) {
  importMasseFiles.splice(index, 1);
  if (importMasseFiles.length === 0) {
    document.getElementById('import-masse-liste').style.display = 'none';
  } else {
    preparerImportMasse({ files: importMasseFiles });
  }
}

// Lancer l'OCR sur tous les fichiers
async function lancerImportMasseOCR() {
  if (!importMasseFiles.length) return;
  
  document.getElementById('import-masse-liste').style.display = 'none';
  document.getElementById('import-masse-progress').style.display = 'block';
  
  const progressDiv = document.getElementById('import-masse-progress-list');
  importMasseResultats = [];
  
  for (let i = 0; i < importMasseFiles.length; i++) {
    const file = importMasseFiles[i];
    
    // Afficher le statut
    progressDiv.innerHTML = `
      <div style="text-align:center;padding:20px">
        <div class="ocr-spinner" style="width:40px;height:40px;border-width:4px;margin:0 auto 15px"></div>
        <div style="font-weight:500">Analyse ${i + 1}/${importMasseFiles.length}</div>
        <div style="color:#6b7280">${esc(file.name)}</div>
        <div style="margin-top:15px;background:#e2e8f0;border-radius:8px;height:8px;overflow:hidden">
          <div style="height:100%;width:${((i) / importMasseFiles.length * 100)}%;background:linear-gradient(90deg,#8b5cf6,#6366f1);transition:width 0.3s"></div>
        </div>
      </div>
    `;
    
    try {
      const resultat = await analyserDocumentOCR(file, false);
      importMasseResultats.push({
        file: file,
        resultat: resultat,
        statut: 'success'
      });
    } catch (e) {
      importMasseResultats.push({
        file: file,
        resultat: null,
        statut: 'error',
        erreur: e.message
      });
    }
  }
  
  afficherResultatsImportMasse();
}

// Afficher les r√©sultats de l'import en masse
function afficherResultatsImportMasse() {
  document.getElementById('import-masse-progress').style.display = 'none';
  document.getElementById('import-masse-resultats').style.display = 'block';
  
  const resultatsDiv = document.getElementById('import-masse-resultats-list');
  
  resultatsDiv.innerHTML = importMasseResultats.map((r, i) => {
    const nbScores = r.resultat ? Object.keys(r.resultat.scores).length : 0;
    const qualite = nbScores >= 6 ? 'high' : nbScores >= 3 ? 'medium' : 'low';
    const qualiteColor = qualite === 'high' ? '#22c55e' : qualite === 'medium' ? '#f59e0b' : '#ef4444';
    
    if (r.statut === 'error') {
      return `
        <div style="padding:15px;margin:10px 0;background:#fee2e2;border-radius:8px;border-left:4px solid #ef4444">
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:1.5em">‚ùå</span>
            <div>
              <div style="font-weight:500">${esc(r.file.name)}</div>
              <div style="color:#991b1b;font-size:0.85em">Erreur: ${esc(r.erreur)}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    return `
      <div style="padding:15px;margin:10px 0;background:#f8fafc;border-radius:8px;border-left:4px solid ${qualiteColor}" id="import-masse-item-${i}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:1.5em">‚úÖ</span>
            <div>
              <div style="font-weight:500">${esc(r.file.name)}</div>
              <div style="font-size:0.85em;color:#6b7280">
                ${r.resultat.stagiaire ? 'üë§ ' + esc(r.resultat.stagiaire) : ''}
                ${r.resultat.date ? ' | üìÖ ' + r.resultat.date : ''}
              </div>
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:bold;color:${qualiteColor}">${nbScores}/8 crit√®res</div>
            <div style="font-size:0.85em;color:#6b7280">
              ${Object.entries(r.resultat.scores).map(([k, v]) => `${k}:${v}`).join(' ')}
            </div>
          </div>
        </div>
        <div style="margin-top:10px;display:grid;grid-template-columns:repeat(8,1fr);gap:5px">
          ${[1,2,3,4,5,6,7,8].map(j => {
            const score = r.resultat.scores[`c${j}`];
            return `
              <div style="text-align:center;padding:5px;background:${score ? '#dcfce7' : '#f1f5f9'};border-radius:4px">
                <div style="font-size:0.7em;color:#6b7280">C${j}</div>
                <input type="number" min="1" max="5" value="${score || ''}" 
                       style="width:100%;text-align:center;border:1px solid #e2e8f0;border-radius:4px;padding:2px"
                       onchange="modifierScoreImportMasse(${i}, 'c${j}', this.value)">
              </div>
            `;
          }).join('')}
        </div>
        <div style="margin-top:10px">
          <input type="text" placeholder="Nom du stagiaire" value="${esc(r.resultat.stagiaire || '')}"
                 style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px"
                 onchange="modifierStagiaireImportMasse(${i}, this.value)">
        </div>
      </div>
    `;
  }).join('');
}

// Modifier un score dans les r√©sultats
function modifierScoreImportMasse(index, critere, valeur) {
  if (importMasseResultats[index] && importMasseResultats[index].resultat) {
    const v = parseInt(valeur);
    if (v >= 1 && v <= 5) {
      importMasseResultats[index].resultat.scores[critere] = v;
    } else {
      delete importMasseResultats[index].resultat.scores[critere];
    }
  }
}

// Modifier le stagiaire dans les r√©sultats
function modifierStagiaireImportMasse(index, nom) {
  if (importMasseResultats[index] && importMasseResultats[index].resultat) {
    importMasseResultats[index].resultat.stagiaire = nom;
  }
}

// Valider et enregistrer tous les r√©sultats
async function validerImportMasse() {
  if (!currentPostFormationSession) return;
  
  const session = currentPostFormationSession;
  let nbImportes = 0;
  let nbErreurs = 0;
  
  for (const r of importMasseResultats) {
    if (r.statut !== 'success' || !r.resultat) continue;
    
    const scores = r.resultat.scores;
    if (Object.keys(scores).length < 4) {
      nbErreurs++;
      continue;
    }
    
    // Cr√©er l'√©valuation
    const moyenne = Object.values(scores).reduce((a, b) => a + b, 0) / Object.keys(scores).length;
    const annee = r.resultat.date ? new Date(r.resultat.date).getFullYear() : new Date().getFullYear();
    
    const evalData = {
      sessionId: session.id,
      sessionRef: session.reference,
      entreprise: session.entreprise,
      entrepriseId: session.entrepriseId,
      formation: session.formation,
      formationId: session.formationId,
      stagiaire: r.resultat.stagiaire || 'Stagiaire ' + (nbImportes + 1),
      dateEval: r.resultat.date || new Date().toISOString().split('T')[0],
      annee: annee,
      commentaire: r.resultat.commentaire || '',
      moyenne: moyenne,
      importOCR: true,
      fichierOrigine: r.file.name,
      c1: scores.c1 || 3,
      c2: scores.c2 || 3,
      c3: scores.c3 || 3,
      c4: scores.c4 || 3,
      c5: scores.c5 || 3,
      c6: scores.c6 || 3,
      c7: scores.c7 || 3,
      c8: scores.c8 || 3
    };
    
    // Lire le fichier pour le stocker
    try {
      const base64 = await fileToBase64(r.file);
      evalData.documentNom = r.file.name;
      evalData.documentType = r.file.name.split('.').pop().toLowerCase();
      evalData.documentTaille = r.file.size;
      evalData.documentContenu = base64;
      evalData.documentDate = new Date().toISOString();
    } catch (e) {
      console.warn('Erreur lecture fichier:', e);
    }
    
    // Sauvegarder
    const savedId = await put('eval_chaud_session', evalData);
    await syncEvalChaudToQualiopi(evalData, savedId);
    
    nbImportes++;
  }
  
  document.getElementById('modal-import-masse').remove();
  toast(`‚úÖ ${nbImportes} √©valuation(s) import√©e(s)${nbErreurs > 0 ? `, ${nbErreurs} erreur(s)` : ''}`, 'success');
  
  // Recharger les donn√©es
  await chargerSatisfactionPostFormation(currentPostFormationSession);
}

// ============ IMPORT CSV DES QUESTIONNAIRES ============

function ouvrirImportCSVQuestionnaires() {
  if (!currentPostFormationSession) {
    toast('‚ö†Ô∏è Veuillez d\'abord s√©lectionner une session', 'warning');
    return;
  }
  
  const session = currentPostFormationSession;
  
  const modalHtml = `
    <div id="modal-import-csv" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:700px">
        <div class="modal-header" style="background:linear-gradient(135deg,#059669,#10b981)">
          <h3 class="modal-title">üì• Import CSV - Questionnaires de Satisfaction</h3>
          <button class="modal-close" onclick="document.getElementById('modal-import-csv').remove()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="info-box" style="margin-bottom:20px">
            <strong>üìã Session :</strong> ${esc(session.reference)} - ${esc(session.formation)}
          </div>
          
          <div style="margin-bottom:20px">
            <h4 style="margin-bottom:10px">üìÑ Format du fichier CSV attendu :</h4>
            <div style="background:#f1f5f9;padding:15px;border-radius:8px;font-family:monospace;font-size:0.85em;overflow-x:auto">
              Stagiaire;Date;C1;C2;C3;C4;C5;C6;C7;C8;Commentaire<br>
              Jean Dupont;2025-01-08;4;5;4;5;4;5;5;4;Tr√®s bonne formation<br>
              Marie Martin;2025-01-08;5;4;5;4;5;4;4;5;Formateur excellent
            </div>
            <p style="margin-top:10px;font-size:0.85em;color:#6b7280">
              ‚Ä¢ S√©parateur : point-virgule (;)<br>
              ‚Ä¢ Notes C1-C8 : de 1 √† 5<br>
              ‚Ä¢ Date : format AAAA-MM-JJ
            </p>
          </div>
          
          <div style="margin-bottom:20px">
            <button class="btn btn-secondary" onclick="telechargerModeleCSV()">üì• T√©l√©charger le mod√®le CSV</button>
          </div>
          
          <div style="border:2px dashed #10b981;border-radius:12px;padding:30px;text-align:center;background:#f0fdf4">
            <input type="file" id="import-csv-file" accept=".csv" style="display:none" onchange="traiterImportCSV(this)">
            <button class="btn btn-success" onclick="document.getElementById('import-csv-file').click()" style="padding:12px 30px">
              üì§ Choisir un fichier CSV
            </button>
          </div>
          
          <div id="import-csv-preview" style="display:none;margin-top:20px">
            <h4 style="margin-bottom:10px">üëÄ Aper√ßu des donn√©es</h4>
            <div id="import-csv-table" style="max-height:300px;overflow:auto"></div>
            <div style="margin-top:15px;display:flex;gap:10px">
              <button class="btn btn-success" onclick="validerImportCSV()" style="flex:1">‚úÖ Importer</button>
              <button class="btn btn-secondary" onclick="document.getElementById('import-csv-preview').style.display='none'">Annuler</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// T√©l√©charger le mod√®le CSV
function telechargerModeleCSV() {
  const modele = `Stagiaire;Date;C1;C2;C3;C4;C5;C6;C7;C8;Commentaire
Jean Dupont;${new Date().toISOString().split('T')[0]};4;5;4;5;4;5;5;4;Tr√®s bonne formation
Marie Martin;${new Date().toISOString().split('T')[0]};5;4;5;4;5;4;4;5;Formateur excellent`;
  
  const blob = new Blob(['\ufeff' + modele], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'modele_satisfaction.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// Variables pour l'import CSV
let importCSVData = [];

// Traiter le fichier CSV
function traiterImportCSV(input) {
  if (!input.files || !input.files.length) return;
  
  const file = input.files[0];
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const text = e.target.result;
    const lignes = text.split(/\r?\n/).filter(l => l.trim());
    
    if (lignes.length < 2) {
      toast('‚ö†Ô∏è Le fichier CSV est vide ou mal format√©', 'warning');
      return;
    }
    
    // Parser les lignes
    const headers = lignes[0].split(';').map(h => h.trim().toLowerCase());
    importCSVData = [];
    
    for (let i = 1; i < lignes.length; i++) {
      const valeurs = lignes[i].split(';');
      if (valeurs.length < 10) continue;
      
      const row = {
        stagiaire: valeurs[0]?.trim() || '',
        date: valeurs[1]?.trim() || '',
        c1: parseInt(valeurs[2]) || 3,
        c2: parseInt(valeurs[3]) || 3,
        c3: parseInt(valeurs[4]) || 3,
        c4: parseInt(valeurs[5]) || 3,
        c5: parseInt(valeurs[6]) || 3,
        c6: parseInt(valeurs[7]) || 3,
        c7: parseInt(valeurs[8]) || 3,
        c8: parseInt(valeurs[9]) || 3,
        commentaire: valeurs[10]?.trim() || ''
      };
      
      importCSVData.push(row);
    }
    
    // Afficher l'aper√ßu
    afficherAper√ßuCSV();
  };
  
  reader.readAsText(file);
}

// Afficher l'aper√ßu du CSV
function afficherAper√ßuCSV() {
  const tableDiv = document.getElementById('import-csv-table');
  
  tableDiv.innerHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:0.85em">
      <thead style="background:#f1f5f9">
        <tr>
          <th style="padding:8px;border:1px solid #e2e8f0">Stagiaire</th>
          <th style="padding:8px;border:1px solid #e2e8f0">Date</th>
          <th style="padding:8px;border:1px solid #e2e8f0">C1</th>
          <th style="padding:8px;border:1px solid #e2e8f0">C2</th>
          <th style="padding:8px;border:1px solid #e2e8f0">C3</th>
          <th style="padding:8px;border:1px solid #e2e8f0">C4</th>
          <th style="padding:8px;border:1px solid #e2e8f0">C5</th>
          <th style="padding:8px;border:1px solid #e2e8f0">C6</th>
          <th style="padding:8px;border:1px solid #e2e8f0">C7</th>
          <th style="padding:8px;border:1px solid #e2e8f0">C8</th>
          <th style="padding:8px;border:1px solid #e2e8f0">Moy</th>
        </tr>
      </thead>
      <tbody>
        ${importCSVData.map(r => {
          const moy = ((r.c1+r.c2+r.c3+r.c4+r.c5+r.c6+r.c7+r.c8)/8).toFixed(1);
          return `
            <tr>
              <td style="padding:8px;border:1px solid #e2e8f0">${esc(r.stagiaire)}</td>
              <td style="padding:8px;border:1px solid #e2e8f0">${r.date}</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center">${r.c1}</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center">${r.c2}</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center">${r.c3}</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center">${r.c4}</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center">${r.c5}</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center">${r.c6}</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center">${r.c7}</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center">${r.c8}</td>
              <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;font-weight:bold">${moy}</td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
    <div style="margin-top:10px;font-weight:500;color:#059669">${importCSVData.length} ligne(s) √† importer</div>
  `;
  
  document.getElementById('import-csv-preview').style.display = 'block';
}

// Valider et importer le CSV
async function validerImportCSV() {
  if (!currentPostFormationSession || !importCSVData.length) return;
  
  const session = currentPostFormationSession;
  let nbImportes = 0;
  
  for (const row of importCSVData) {
    const moyenne = (row.c1+row.c2+row.c3+row.c4+row.c5+row.c6+row.c7+row.c8) / 8;
    const annee = row.date ? new Date(row.date).getFullYear() : new Date().getFullYear();
    
    const evalData = {
      sessionId: session.id,
      sessionRef: session.reference,
      entreprise: session.entreprise,
      entrepriseId: session.entrepriseId,
      formation: session.formation,
      formationId: session.formationId,
      stagiaire: row.stagiaire,
      dateEval: row.date || new Date().toISOString().split('T')[0],
      annee: annee,
      commentaire: row.commentaire,
      moyenne: moyenne,
      importCSV: true,
      c1: row.c1,
      c2: row.c2,
      c3: row.c3,
      c4: row.c4,
      c5: row.c5,
      c6: row.c6,
      c7: row.c7,
      c8: row.c8
    };
    
    const savedId = await put('eval_chaud_session', evalData);
    await syncEvalChaudToQualiopi(evalData, savedId);
    nbImportes++;
  }
  
  document.getElementById('modal-import-csv').remove();
  toast(`‚úÖ ${nbImportes} √©valuation(s) import√©e(s) depuis le CSV`, 'success');
  
  importCSVData = [];
  await chargerSatisfactionPostFormation(currentPostFormationSession);
}

// Supprimer une √©valuation
async function supprimerEvalChaud(id) {
  if (!confirm('Supprimer cette √©valuation ?')) return;
  
  await del('eval_chaud_session', id);
  toast('‚úÖ √âvaluation supprim√©e', 'success');
  await chargerSatisfactionPostFormation(currentPostFormationSession);
}

// Exporter le bilan satisfaction en PDF
async function exporterSatisfactionPDF() {
  if (!currentPostFormationSession) {
    toast('‚ö†Ô∏è Aucune session s√©lectionn√©e', 'warning');
    return;
  }
  
  const session = currentPostFormationSession;
  const allEvals = await getAll('eval_chaud_session');
  const evals = allEvals.filter(e => e.sessionId === session.id);
  
  if (evals.length === 0) {
    toast('‚ö†Ô∏è Aucune √©valuation √† exporter', 'warning');
    return;
  }
  
  // Calculer les moyennes
  const moyennes = {};
  for (let i = 1; i <= 8; i++) {
    const key = `c${i}`;
    const scores = evals.map(e => e[key]).filter(s => s !== undefined);
    moyennes[key] = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
  }
  
  const moyGen = (moyennes.c1 + moyennes.c2 + moyennes.c3 + moyennes.c4 + moyennes.c5 + moyennes.c6) / 6;
  const moySat = (moyennes.c7 + moyennes.c8) / 2;
  const scoreGlobal = (moyGen + moySat) / 2;
  
  const htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bilan Satisfaction - ${session.reference}</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; }
    .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #8b5cf6; padding-bottom: 20px; }
    .header h1 { color: #8b5cf6; margin: 0; }
    .kpis { display: flex; justify-content: space-around; margin: 30px 0; }
    .kpi { text-align: center; padding: 15px 25px; background: #f8fafc; border-radius: 10px; }
    .kpi-value { font-size: 2em; font-weight: bold; color: #8b5cf6; }
    .kpi-label { color: #64748b; font-size: 0.9em; }
    .section { margin: 25px 0; }
    .section h2 { color: #374151; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
    th { background: #f8fafc; }
    .stars { color: #f59e0b; }
    .comment { background: #f8fafc; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #8b5cf6; }
    @media print { body { padding: 20px; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä BILAN DE SATISFACTION</h1>
    <p>√âvaluation √† Chaud - Formation DesClick</p>
  </div>
  
  <div class="section">
    <table>
      <tr><th width="30%">Session</th><td>${esc(session.reference)}</td></tr>
      <tr><th>Formation</th><td>${esc(session.formation)}</td></tr>
      <tr><th>Entreprise</th><td>${esc(session.entreprise)}</td></tr>
      <tr><th>Dates</th><td>Du ${fmtDate(session.dateDebut)} au ${fmtDate(session.dateFin)}</td></tr>
      <tr><th>Nombre d'√©valuations</th><td>${evals.length}</td></tr>
    </table>
  </div>
  
  <div class="kpis">
    <div class="kpi">
      <div class="kpi-value">${(scoreGlobal / 5 * 100).toFixed(1)}%</div>
      <div class="kpi-label">Score Global</div>
    </div>
    <div class="kpi">
      <div class="kpi-value">${(moyGen / 5 * 100).toFixed(1)}%</div>
      <div class="kpi-label">Appr√©ciations</div>
    </div>
    <div class="kpi">
      <div class="kpi-value">${(moySat / 5 * 100).toFixed(1)}%</div>
      <div class="kpi-label">Satisfaction</div>
    </div>
    <div class="kpi">
      <div class="kpi-value">${(moyennes.c8 / 5 * 100).toFixed(1)}%</div>
      <div class="kpi-label">Recommandation</div>
    </div>
  </div>
  
  <div class="section">
    <h2>üìã Appr√©ciations G√©n√©rales</h2>
    <table>
      <tr><th>Crit√®re</th><th>Note</th><th>%</th></tr>
      ${CRITERES_EVAL_CHAUD.generaux.map((c, i) => `
        <tr>
          <td>${i+1}. ${c.label}</td>
          <td class="stars">${renderStars(moyennes[c.id])}</td>
          <td><strong>${(moyennes[c.id] / 5 * 100).toFixed(1)}%</strong></td>
        </tr>
      `).join('')}
      <tr style="background:#dbeafe"><td><strong>Moyenne</strong></td><td class="stars">${renderStars(moyGen)}</td><td><strong>${(moyGen / 5 * 100).toFixed(1)}%</strong></td></tr>
    </table>
  </div>
  
  <div class="section">
    <h2>‚≠ê Niveau de Satisfaction</h2>
    <table>
      <tr><th>Crit√®re</th><th>Note</th><th>%</th></tr>
      ${CRITERES_EVAL_CHAUD.satisfaction.map((c, i) => `
        <tr>
          <td>${i+1}. ${c.label}</td>
          <td class="stars">${renderStars(moyennes[c.id])}</td>
          <td><strong>${(moyennes[c.id] / 5 * 100).toFixed(1)}%</strong></td>
        </tr>
      `).join('')}
      <tr style="background:#dcfce7"><td><strong>Moyenne</strong></td><td class="stars">${renderStars(moySat)}</td><td><strong>${(moySat / 5 * 100).toFixed(1)}%</strong></td></tr>
    </table>
  </div>
  
  ${evals.filter(e => e.commentaire).length > 0 ? `
  <div class="section">
    <h2>üí¨ Commentaires</h2>
    ${evals.filter(e => e.commentaire).map(e => `
      <div class="comment">
        <strong>${esc(e.stagiaire)}</strong><br>
        <em>"${esc(e.commentaire)}"</em>
      </div>
    `).join('')}
  </div>
  ` : ''}
  
  <p style="text-align: center; margin-top: 40px; color: #64748b; font-size: 0.9em;">
    Document g√©n√©r√© le ${fmtDate(new Date().toISOString())} - Formation DesClick
  </p>
</body>
</html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(htmlContent);
  printWindow.document.close();
  
  toast('‚úÖ Bilan satisfaction g√©n√©r√©', 'success');
}

// ============ QUESTIONNAIRE √Ä CHAUD (SATISFACTION) ============
async function genererQuestionnaireChaud(sessionId) {
  try {
    const session = await dbGet('sessions', sessionId);
    if (!session) {
      toast('‚ö†Ô∏è Session non trouv√©e', 'error');
      return;
    }
    
    // Charger les donn√©es li√©es
    const [formation, entreprise, formateurs, lieux, stagiaires] = await Promise.all([
      session.formation ? dbGet('formations', session.formation) : null,
      session.entreprise ? dbGet('entreprises', session.entreprise) : null,
      dbGetAll('formateurs'),
      dbGetAll('lieux'),
      dbGetAll('stagiaires')
    ]);
    
    const formateur = formateurs.find(f => f.id == session.formateur);
    const lieu = lieux.find(l => l.id == session.lieu);
    
    // R√©cup√©rer les stagiaires de la session
    const stagiaireIds = session.stagiaires ? session.stagiaires.split(',').filter(x => x) : [];
    const stagiairesList = stagiaires.filter(s => stagiaireIds.includes(String(s.id)));
    
    // Formater les dates
    const dateDebut = session.dateDebutEffective || session.dateDebutPrev;
    const dateFin = session.dateFinEffective || session.dateFinPrev;
    const dateRange = dateDebut ? (dateFin && dateFin !== dateDebut ? `${fmtDate(dateDebut)} au ${fmtDate(dateFin)}` : fmtDate(dateDebut)) : '_______________';
    
    // Lieu de formation
    let lieuText = '_______________';
    if (session.modalite === 'Intra' && session.lieuIntra) {
      lieuText = session.lieuIntra;
    } else if (lieu) {
      lieuText = `${lieu.nom}${lieu.ville ? ' - ' + lieu.ville : ''}`;
    }
    
    // Charger les param√®tres pour le logo/nom organisme
    const params = await dbGet('parametres', 'general');
    const nomOrganisme = params?.nomOrganisme || 'Formation DesClick';
    const logoUrl = params?.logo || '';
    
    // G√©n√©rer un questionnaire pour chaque stagiaire ou un vierge si pas de stagiaires
    const questionnairesHTML = stagiairesList.length > 0 
      ? stagiairesList.map(stag => genererPageQuestionnaire(stag, formation, dateRange, lieuText, formateur, nomOrganisme, logoUrl)).join('<div style="page-break-after: always;"></div>')
      : genererPageQuestionnaire(null, formation, dateRange, lieuText, formateur, nomOrganisme, logoUrl);
    
    const htmlContent = `
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Questionnaire Satisfaction - ${formation?.nom || 'Formation'}</title>
  <style>
    @page { size: A4; margin: 15mm; }
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      font-size: 11pt;
      line-height: 1.4;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .page {
      max-width: 210mm;
      margin: 0 auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid #8b5cf6;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .header-left {
      flex: 1;
    }
    .header-right {
      text-align: right;
    }
    .logo {
      max-height: 50px;
      max-width: 150px;
    }
    h1 {
      color: #8b5cf6;
      font-size: 20pt;
      margin: 0 0 5px 0;
    }
    .subtitle {
      color: #64748b;
      font-size: 10pt;
    }
    .intro {
      background: #f8fafc;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 10pt;
      color: #475569;
      border-left: 4px solid #8b5cf6;
    }
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 20px;
      margin-bottom: 20px;
      padding: 15px;
      background: #faf5ff;
      border-radius: 8px;
    }
    .info-item {
      display: flex;
      align-items: baseline;
    }
    .info-label {
      font-weight: 600;
      color: #7c3aed;
      min-width: 130px;
    }
    .info-value {
      flex: 1;
      border-bottom: 1px dotted #a78bfa;
      padding-bottom: 2px;
    }
    .section-title {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      padding: 8px 15px;
      border-radius: 6px;
      font-size: 11pt;
      font-weight: 600;
      margin: 20px 0 10px 0;
    }
    table.eval {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 10pt;
    }
    table.eval th {
      background: #8b5cf6;
      color: white;
      padding: 10px 8px;
      text-align: center;
      font-weight: 600;
    }
    table.eval th:first-child {
      text-align: left;
      width: 45%;
    }
    table.eval td {
      border: 1px solid #e2e8f0;
      padding: 10px 8px;
    }
    table.eval td:not(:first-child) {
      text-align: center;
      width: 13.75%;
    }
    table.eval tr:nth-child(even) {
      background: #faf5ff;
    }
    .checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid #8b5cf6;
      border-radius: 4px;
      display: inline-block;
      margin: 0 auto;
    }
    .stars-section {
      margin: 20px 0;
      padding: 15px;
      background: #fef3c7;
      border-radius: 8px;
    }
    .stars-row {
      display: flex;
      align-items: center;
      margin: 12px 0;
    }
    .stars-label {
      flex: 1;
      font-weight: 500;
    }
    .stars {
      display: flex;
      gap: 5px;
    }
    .star {
      width: 28px;
      height: 28px;
      border: 2px solid #f59e0b;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14pt;
      color: #f59e0b;
    }
    .comments-section {
      margin-top: 20px;
    }
    .comment-box {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      min-height: 80px;
      background: #fff;
    }
    .comment-box label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    .comment-lines {
      border-bottom: 1px dotted #cbd5e1;
      height: 25px;
    }
    .footer {
      margin-top: 25px;
      padding-top: 15px;
      border-top: 2px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      font-size: 9pt;
      color: #64748b;
    }
    .signature-box {
      text-align: center;
    }
    .signature-line {
      border-bottom: 1px solid #333;
      width: 150px;
      margin: 30px auto 5px;
    }
    @media print {
      body { padding: 0; }
      .page { max-width: 100%; }
    }
  </style>
</head>
<body>
${questionnairesHTML}
</body>
</html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    
    toast('‚úÖ Questionnaire(s) g√©n√©r√©(s) - ' + (stagiairesList.length || 1) + ' exemplaire(s)', 'success');
    
  } catch (err) {
    console.error('Erreur genererQuestionnaireChaud:', err);
    toast('‚ùå Erreur lors de la g√©n√©ration', 'error');
  }
}

function genererPageQuestionnaire(stagiaire, formation, dateRange, lieuText, formateur, nomOrganisme, logoUrl) {
  const stagiaireNom = stagiaire ? `${stagiaire.prenom || ''} ${stagiaire.nom || ''}`.trim() : '_______________';
  const formationNom = formation?.nom || '_______________';
  const formateurNom = formateur ? `${formateur.prenom || ''} ${formateur.nom || ''}`.trim() : '_______________';
  
  return `
  <div class="page">
    <div class="header">
      <div class="header-left">
        <h1>üìã Questionnaire de Satisfaction</h1>
        <div class="subtitle">√âvaluation √† chaud - Fin de formation</div>
      </div>
      <div class="header-right">
        ${logoUrl ? `<img src="${logoUrl}" class="logo" alt="Logo">` : `<strong>${esc(nomOrganisme)}</strong>`}
      </div>
    </div>
    
    <div class="intro">
      Ce questionnaire a pour objectif d'√©valuer avec vous la formation que nous dispensons, dans un souci permanent d'y apporter des am√©liorations et de r√©pondre √† vos attentes. Aussi, votre avis √©tant pr√©cieux, nous vous demandons de bien vouloir r√©pondre avec soin √† toutes les questions pos√©es.
    </div>
    
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">üë§ Stagiaire :</span>
        <span class="info-value">${esc(stagiaireNom)}</span>
      </div>
      <div class="info-item">
        <span class="info-label">üìö Formation :</span>
        <span class="info-value">${esc(formationNom)}</span>
      </div>
      <div class="info-item">
        <span class="info-label">üìÖ Dates :</span>
        <span class="info-value">${esc(dateRange)}</span>
      </div>
      <div class="info-item">
        <span class="info-label">üìç Lieu :</span>
        <span class="info-value">${esc(lieuText)}</span>
      </div>
      <div class="info-item" style="grid-column: span 2">
        <span class="info-label">üë®‚Äçüè´ Intervenant(s) :</span>
        <span class="info-value">${esc(formateurNom)}</span>
      </div>
    </div>
    
    <div class="section-title">üìä Votre appr√©ciation de la formation</div>
    
    <table class="eval">
      <thead>
        <tr>
          <th>Concernant la formation, diriez-vous que vous en √™tes :</th>
          <th>Pas satisfait du tout</th>
          <th>Peu satisfait</th>
          <th>Satisfait</th>
          <th>Tr√®s satisfait</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Informations obtenues avant le d√©but de la formation</td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
        </tr>
        <tr>
          <td>Dur√©e et rythme de la formation par rapport au contenu</td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
        </tr>
        <tr>
          <td>Horaires de la formation</td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
        </tr>
        <tr>
          <td>Lieu / locaux o√π s'est d√©roul√©e la formation</td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
        </tr>
        <tr>
          <td>Programmes et m√©thodes p√©dagogiques</td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
        </tr>
        <tr>
          <td>Mat√©riels et supports mis √† disposition</td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
          <td><div class="checkbox"></div></td>
        </tr>
      </tbody>
    </table>
    
    <div class="stars-section">
      <div class="section-title" style="margin-top:0">‚≠ê Votre niveau de satisfaction</div>
      
      <div class="stars-row">
        <span class="stars-label">Donnez-nous votre appr√©ciation globale de la formation :</span>
        <div class="stars">
          <div class="star">‚òÜ</div>
          <div class="star">‚òÜ</div>
          <div class="star">‚òÜ</div>
          <div class="star">‚òÜ</div>
          <div class="star">‚òÜ</div>
        </div>
      </div>
      
      <div class="stars-row">
        <span class="stars-label">Recommanderiez-vous cette formation ?</span>
        <div class="stars">
          <div class="star">‚òÜ</div>
          <div class="star">‚òÜ</div>
          <div class="star">‚òÜ</div>
          <div class="star">‚òÜ</div>
          <div class="star">‚òÜ</div>
        </div>
      </div>
      <small style="color:#92400e;display:block;margin-top:8px">Entourez ou noircissez le nombre d'√©toiles correspondant √† votre appr√©ciation (1 = minimum, 5 = maximum)</small>
    </div>
    
    <div class="comments-section">
      <div class="comment-box">
        <label>üí¨ Commentaires, suggestions ou remarques :</label>
        <div class="comment-lines"></div>
        <div class="comment-lines"></div>
        <div class="comment-lines"></div>
      </div>
    </div>
    
    <div class="footer">
      <div>
        <strong>${esc(nomOrganisme)}</strong><br>
        Questionnaire de satisfaction - √âvaluation √† chaud
      </div>
      <div class="signature-box">
        Date : ____/____/________
        <div class="signature-line"></div>
        Signature du stagiaire
      </div>
    </div>
  </div>
  `;
}

// ============ PARSE EMAIL ============
function openParseModal(){document.getElementById('modal-parse').classList.add('active');document.getElementById('email-content').value='';}
function closeParseModal(){document.getElementById('modal-parse').classList.remove('active');}

async function parseEmail(){
  const content=document.getElementById('email-content').value;
  if(!content.trim()){toast('Veuillez coller le contenu de l\'email','warning');return;}
  
  // Fonction d'extraction simple
  const extract=(pattern)=>{
    const regex=new RegExp(pattern+'\\s*[:\\-]?\\s*(.+?)(?:\\n|$)','i');
    const match=content.match(regex);
    return match?match[1].trim():'';
  };
  
  // Fonction d'extraction pour le SIREN (chiffres uniquement)
  const extractSiren=()=>{
    const regex=/Num[√©e]ro\s+de\s+SIREN\s*[:\-]?\s*(\d+)/i;
    const match=content.match(regex);
    return match?match[1].trim():'';
  };
  
  // Fonction d'extraction pour les champs multilignes (jusqu'au prochain label ou fin)
  const extractMultiline=(pattern,nextPatterns=[])=>{
    const startRegex=new RegExp(pattern+'\\s*[:\\-]?\\s*','i');
    const startMatch=content.match(startRegex);
    if(!startMatch)return '';
    
    const startIndex=startMatch.index+startMatch[0].length;
    let endIndex=content.length;
    
    // Trouver le prochain label
    for(const np of nextPatterns){
      const nextRegex=new RegExp('\\n\\s*'+np+'\\s*[:\\-]','i');
      const nextMatch=content.slice(startIndex).match(nextRegex);
      if(nextMatch&&(startIndex+nextMatch.index)<endIndex){
        endIndex=startIndex+nextMatch.index;
      }
    }
    
    return content.slice(startIndex,endIndex).trim();
  };
  
  const demande={
    nom:extract('Nom'),
    prenom:extract('Pr[√©e]nom'),
    email:extract('E?-?mail'),
    telephone:extract('T[√©e]l[√©e]phone'),
    raisonSociale:extract('Raison sociale'),
    siren:extractSiren(),
    adresse:extract('Adresse'),
    codePostal:extract('Code postal'),
    ville:extract('Ville'),
    formationsInteressees:extractMultiline('(Nous sommes |Formations? )?int[√©e]ress[√©e]s?( par les formations)?',['Besoins','Message']),
    besoinsSpecifiques:extractMultiline('Besoins( sp[√©e]cifiques)?',['Message']),
    message:extractMultiline('Message',['Cordialement','Bien [√†a] vous','Merci']),
    statut:'Nouveau',
    priorite:'Normale',
    source:'Site DesClick'
  };
  
  closeParseModal();
  
  // Ouvrir le modal de demande avec les donn√©es pr√©-remplies
  currentModal='demande';
  editId=null;
  document.getElementById('modal-title').textContent='Nouvelle Demande';
  document.getElementById('modal-body').innerHTML=FORMS['demande']();
  
  // Charger les selects (notamment les commerciaux)
  await loadSelects();
  
  // Pr√©-remplir les champs
  Object.keys(demande).forEach(k=>{
    const el=document.getElementById('f-'+k);
    if(el)el.value=demande[k];
  });
  
  // Cocher les options d'envoi par d√©faut
  const checkAccuse=document.getElementById('f-envoyerAccuseReception');
  const checkNotif=document.getElementById('f-notifierCommercial');
  if(checkAccuse)checkAccuse.checked=true;
  if(checkNotif)checkNotif.checked=true;
  
  document.getElementById('modal').classList.add('active');
  toast('Donn√©es extraites avec succ√®s!','success');
}

// ============ ENTREPRISES ============
let entreprisesData=[];
let entreprisesCommMap={};

async function showEntreprises(){
  entreprisesData=await dbGetAll('entreprises');
  const commerciaux=await dbGetAll('commerciaux');
  const stagiaires=await dbGetAll('stagiaires');
  entreprisesCommMap=Object.fromEntries(commerciaux.map(c=>[c.id,c]));
  // Compter les stagiaires par entreprise
  window.entreprisesStagiairesCount = {};
  stagiaires.forEach(s => {
    const entId = s.entreprise;
    if (entId) {
      window.entreprisesStagiairesCount[entId] = (window.entreprisesStagiairesCount[entId] || 0) + 1;
    }
  });
  renderEntreprises();
}

function filterEntreprises(){
  renderEntreprises();
}

async function renderEntreprises(){
  const searchTerm=(document.getElementById('search-ent')?.value||'').toLowerCase();
  const statutFilter=document.getElementById('filter-ent-statut')?.value||'';
  
  let filtered=entreprisesData.filter(d=>{
    const matchSearch=!searchTerm||
      (d.nom||'').toLowerCase().includes(searchTerm)||
      (d.enseigne||'').toLowerCase().includes(searchTerm)||
      (d.ville||'').toLowerCase().includes(searchTerm)||
      (d.contact||'').toLowerCase().includes(searchTerm)||
      (d.siret||'').toLowerCase().includes(searchTerm)||
      (d.secteurActivite||'').toLowerCase().includes(searchTerm)||
      (d.opco||'').toLowerCase().includes(searchTerm);
    const matchStatut=!statutFilter||d.statut===statutFilter;
    return matchSearch&&matchStatut;
  });
  
  const tbody=document.getElementById('table-entreprises');
  
  // Afficher/masquer la colonne Code Activation selon le r√¥le
  const isAdminOrGest=currentUser&&(currentUser.role==='Admin'||currentUser.role==='Gestionnaire');
  document.querySelectorAll('.col-code-activation').forEach(el=>{
    el.style.display=isAdminOrGest?'table-cell':'none';
  });
  
  if(!filtered.length){
    tbody.innerHTML=`<tr><td colspan="${isAdminOrGest?23:22}" class="empty-state"><div class="empty-state-icon">üè¢</div><h3>Aucune entreprise</h3></td></tr>`;
    return;
  }
  
  tbody.innerHTML=filtered.map(d=>{
    const id=d.id;
    const comm=entreprisesCommMap[d.commercial];
    const emailDispo = d.emailContact || d.emailPro;
    const acts=`<td class="action-btns" style="white-space:nowrap">
      <button class="btn btn-sm" style="background:#8b5cf6;color:#fff" onclick="ouvrirDemandeInfosStagiaires(${id})" title="Demander infos stagiaires"${!emailDispo?' disabled':''}>üìß</button>
      <button class="btn btn-secondary btn-icon" onclick="openModal('entreprise',${id})" title="Modifier">‚úèÔ∏è</button>
      <button class="btn btn-danger btn-icon" onclick="confirmDelete('entreprises',${id})" title="Supprimer">üóëÔ∏è</button>
    </td>`;
    const codeActivationCell=isAdminOrGest?`<td class="col-code-activation">${esc(d.codeActivation||'-')}</td>`:'';
    return `<tr>
      <td><code>ENT-${String(id).padStart(3,'0')}</code></td>
      <td><strong>${esc(d.nom||'-')}</strong></td>
      <td>${esc(d.enseigne||'-')}</td>
      <td>${esc(d.adresse||'-')}</td>
      <td>${esc(d.codePostal||'-')}</td>
      <td>${esc(d.ville||'-')}</td>
      <td>${d.emailPro?`<a href="mailto:${esc(d.emailPro)}">${esc(d.emailPro)}</a>`:'-'}</td>
      <td>${esc(d.contact||'-')}</td>
      <td>${esc(d.qualiteContact||'-')}</td>
      <td>${d.emailContact?`<a href="mailto:${esc(d.emailContact)}">${esc(d.emailContact)}</a>`:'-'}</td>
      <td>${esc(d.mobileContact||'-')}</td>
      <td>${d.dateCreation?fmtDate(d.dateCreation):'-'}</td>
      <td>${d.commercial?`<code>COM-${String(d.commercial).padStart(3,'0')}</code>`:'-'}</td>
      <td>${comm?esc(comm.prenom||'')+' '+esc(comm.nom):'-'}</td>
      <td>${esc(d.idcc||'-')}</td>
      <td>${esc(d.secteurActivite||'-')}</td>
      <td>${esc(d.siret||'-')}</td>
      <td>${esc(d.opco||'-')}</td>
      ${codeActivationCell}
      <td>${d.nbSalaries||'-'}</td>
      <td>${window.entreprisesStagiairesCount?.[id] ? `<span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:10px;font-weight:600">${window.entreprisesStagiairesCount[id]}</span>` : '<span style="color:#94a3b8">0</span>'}</td>
      <td><span class="status status-${slug(d.statut)}">${d.statut||'Prospect'}</span></td>
      ${acts}
    </tr>`;
  }).join('');
}

// ============ STAGIAIRES ============
let stagiairesData=[];
let stagiairesEntMap={};

// ============ OPPORTUNITES ============
let opportunitesData=[];
let opportunitesEntMap={};

async function showOpportunites(){
  opportunitesData=await dbGetAll('opportunites');
  const ent=await dbGetAll('entreprises');
  opportunitesEntMap=Object.fromEntries(ent.map(e=>[e.id,e]));
  opportunitesData.sort((a,b)=>new Date(b.dateCreation||0)-new Date(a.dateCreation||0));
  renderOpportunites();
}

function filterOpportunites(){renderOpportunites();}

function renderOpportunites(){
  const searchTerm=(document.getElementById('search-opp')?.value||'').toLowerCase();
  const etapeFilter=document.getElementById('filter-opp-etape')?.value||'';
  const etatFilter=document.getElementById('filter-opp-etat')?.value||'';
  
  let filtered=opportunitesData.filter(o=>{
    const ent=opportunitesEntMap[o.entreprise];
    const matchSearch=!searchTerm||
      (o.nom||'').toLowerCase().includes(searchTerm)||
      (ent&&ent.nom.toLowerCase().includes(searchTerm))||
      (o.interlocuteur||'').toLowerCase().includes(searchTerm)||
      (o.ville||'').toLowerCase().includes(searchTerm);
    const matchEtape=!etapeFilter||o.etape===etapeFilter;
    const matchEtat=!etatFilter||o.etat===etatFilter;
    return matchSearch&&matchEtape&&matchEtat;
  });
  
  const tbody=document.getElementById('table-opportunites');
  if(!filtered.length){
    tbody.innerHTML='<tr><td colspan="14" class="empty-state"><div class="empty-state-icon">üéØ</div><h3>Aucune opportunit√©</h3></td></tr>';
    return;
  }
  
  tbody.innerHTML=filtered.map(o=>{
    const ent=opportunitesEntMap[o.entreprise];
    const ville=o.ville||(ent?ent.ville:'-');
    const interlocuteur=o.interlocuteur||(ent?ent.contact:'-');
    const mobile=o.mobile||(ent?ent.mobileContact:'-');
    const badgeNew = getBadgeNouveau(o.dateCreation);
    
    return `<tr>
      <td><code>OPP-${String(o.id).padStart(3,'0')}</code>${badgeNew}</td>
      <td><strong>${esc(o.nom||'-')}</strong></td>
      <td>${ent?`<small>ENT-${String(ent.id).padStart(3,'0')}</small><br>${esc(ent.nom)}`:'-'}</td>
      <td>${esc(ville)}</td>
      <td>${esc(interlocuteur)}</td>
      <td>${esc(mobile)}</td>
      <td><span class="etape etape-${slug(o.etape)}">${o.etape||'-'}</span></td>
      <td class="montant">${o.montant?fmtMoney(o.montant):'-'}</td>
      <td>${o.pourcentageReussite||0}%</td>
      <td><span class="priority-${slug(o.priorite||'moyenne')}">${o.priorite||'Moyenne'}</span></td>
      <td>${esc(o.source||'-')}</td>
      <td>${o.dateCloture?fmtDate(o.dateCloture):'-'}</td>
      <td><span class="status status-${slug(o.etat)}">${o.etat||'-'}</span>${o.etat==='Perdu'&&o.motifEchec?`<br><small style="color:var(--red-600)">${esc(o.motifEchec)}</small>`:''}</td>
      <td class="action-btns">
        ${getBoutonFavori('opportunites', o.id)}
        ${getBoutonDupliquer('opportunites', o.id)}
        <button class="btn btn-secondary btn-icon" onclick="openModal('opportunite',${o.id})">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-icon" onclick="confirmDelete('opportunites',${o.id})">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

async function onOpportuniteEntrepriseChange(){
  const entrepriseId=document.getElementById('f-entreprise')?.value;
  const villeField=document.getElementById('f-ville');
  const interlocuteurField=document.getElementById('f-interlocuteur');
  const mobileField=document.getElementById('f-mobile');
  
  if(entrepriseId){
    const ent=await dbGet('entreprises',parseInt(entrepriseId));
    if(ent){
      if(villeField)villeField.value=ent.ville||'';
      if(interlocuteurField)interlocuteurField.value=ent.contact||'';
      if(mobileField)mobileField.value=ent.mobileContact||'';
    }
  }else{
    if(villeField)villeField.value='';
    if(interlocuteurField)interlocuteurField.value='';
    if(mobileField)mobileField.value='';
  }
}

function onOpportuniteEtatChange(){
  const etat=document.getElementById('f-etat')?.value;
  const motifGroup=document.getElementById('group-motif-echec');
  if(motifGroup){
    motifGroup.style.display=etat==='Perdu'?'block':'none';
  }
}

// ============ ANALYSE - √âtapes 1 et 2 ============
let analysesData=[];
let currentAnalyseOpp=null;
let currentAnalyseEnt=null;
let editAnalyseId=null;

async function showAnalyses(){
  analysesData=await dbGetAll('analyses');
  analysesData.sort((a,b)=>new Date(b.dateCreation||0)-new Date(a.dateCreation||0));
  
  // Charger les commerciaux pour le select
  const commerciaux=await dbGetAll('commerciaux');
  const selectComm=document.getElementById('analyse-commercial');
  if(selectComm){
    selectComm.innerHTML='<option value="">-- S√©lectionner --</option>'+
      commerciaux.map(c=>`<option value="${c.id}">${esc(c.nom)} ${esc(c.prenom||'')}</option>`).join('');
  }
  
  renderAnalysesList();
}

function filterAnalyses(){renderAnalysesList();}

function renderAnalysesList(){
  const searchTerm=(document.getElementById('search-analyses')?.value||'').toLowerCase();
  const filterStatut=document.getElementById('filter-analyse-statut')?.value||'';
  
  let filtered=analysesData.filter(a=>{
    const matchSearch=!searchTerm||
      (a.entreprise||'').toLowerCase().includes(searchTerm)||
      (a.contact||'').toLowerCase().includes(searchTerm)||
      (a.formation||'').toLowerCase().includes(searchTerm)||
      (a.email||'').toLowerCase().includes(searchTerm);
    const matchStatut=!filterStatut||a.statut===filterStatut;
    return matchSearch&&matchStatut;
  });
  
  const tbody=document.getElementById('table-analyses');
  if(!filtered.length){
    tbody.innerHTML='<tr><td colspan="9" class="empty-state"><div class="empty-state-icon">üìã</div><h3>Aucune analyse</h3><p>Cr√©ez une analyse √† partir d\'une demande de formation</p></td></tr>';
  }else{
    tbody.innerHTML=filtered.map(d=>{
      const id=d.id;
      const demLabel=d.demandeId?`DEM-${String(d.demandeId).padStart(3,'0')}`:'-';
      const statutClass=d.statut==='R√©ponse re√ßue'?'conforme':d.statut==='Envoy√©'||d.statut==='En attente'?'en-attente':'nouveau';
      const canEval=d.statut==='R√©ponse re√ßue';
      return `<tr>
        <td><code style="background:#dbeafe;color:#1d4ed8;padding:4px 8px;border-radius:4px">ANA-${String(id).padStart(3,'0')}</code></td>
        <td><small style="color:#64748b">${demLabel}</small></td>
        <td><strong>${esc(d.entreprise||'-')}</strong></td>
        <td>${esc(d.contact||'-')}</td>
        <td><a href="mailto:${esc(d.email||'')}" style="color:#3b82f6">${esc(d.email||'-')}</a></td>
        <td>${esc(d.formation||'-')}</td>
        <td>${fmtDate(d.dateAnalyse)}</td>
        <td><span class="status status-${statutClass}">${d.statut||'√Ä envoyer'}</span></td>
        <td class="action-btns">
          ${canEval?`<button class="btn btn-success btn-icon" onclick="creerEvaluationDepuisAnalyse(${id})" title="Cr√©er l'√©valuation">üìù</button>`:''}
          <button class="btn btn-info btn-icon" onclick="relancerQuestionnaire(${id})" title="Relancer">üìß</button>
          <button class="btn btn-secondary btn-icon" onclick="ouvrirModifierAnalyse(${id})" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-icon" onclick="confirmDelete('analyses',${id})" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('');
  }
  
  // Mettre √† jour les KPIs
  document.getElementById('kpi-analyses-total').textContent=analysesData.length;
  document.getElementById('kpi-analyses-attente').textContent=analysesData.filter(a=>a.statut==='En attente'||a.statut==='Envoy√©').length;
  document.getElementById('kpi-analyses-recues').textContent=analysesData.filter(a=>a.statut==='R√©ponse re√ßue').length;
  // √Ä √©valuer = r√©ponses re√ßues sans √©valuation associ√©e
  document.getElementById('kpi-analyses-evaluer').textContent=analysesData.filter(a=>a.statut==='R√©ponse re√ßue'&&!a.evaluationCreee).length;
}

let currentAnalyseDemande=null;

async function ouvrirNouvelleAnalyse(){
  editAnalyseId=null;
  currentAnalyseDemande=null;
  
  // Charger les demandes non encore analys√©es
  const demandes=await dbGetAll('demandes');
  const analyses=await dbGetAll('analyses');
  const demandesAnalysees=new Set(analyses.map(a=>a.demandeId));
  
  const demandesDisponibles=demandes.filter(d=>!demandesAnalysees.has(d.id)&&d.statut!=='Spam');
  
  const select=document.getElementById('analyse-demande');
  if(demandesDisponibles.length===0){
    select.innerHTML='<option value="">Aucune demande disponible</option>';
  }else{
    select.innerHTML='<option value="">-- S√©lectionner une demande --</option>'+
      demandesDisponibles.map(d=>`<option value="${d.id}">DEM-${String(d.id).padStart(3,'0')} - ${esc(d.entreprise||d.nom||'')} - ${esc(d.formation||d.sujet||'')}</option>`).join('');
  }
  
  document.getElementById('analyse-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('analyse-infos-demande').style.display='none';
  document.getElementById('analyse-message').value='';
  document.getElementById('analyse-statut').value='√Ä envoyer';
  
  document.getElementById('titre-analyse-travail').textContent='üìã Nouvelle Analyse des Besoins';
  document.getElementById('zone-analyse-travail').style.display='block';
  document.getElementById('zone-analyse-travail').scrollIntoView({behavior:'smooth'});
}

async function ouvrirModifierAnalyse(id){
  const analyse=await dbGet('analyses',id);
  if(!analyse){toast('Analyse non trouv√©e','error');return;}
  
  editAnalyseId=id;
  
  // Recharger la liste des demandes
  const demandes=await dbGetAll('demandes');
  const select=document.getElementById('analyse-demande');
  select.innerHTML='<option value="">-- S√©lectionner une demande --</option>'+
    demandes.map(d=>`<option value="${d.id}"${d.id===analyse.demandeId?' selected':''}>DEM-${String(d.id).padStart(3,'0')} - ${esc(d.entreprise||d.nom||'')}</option>`).join('');
  
  if(analyse.demandeId){
    currentAnalyseDemande=await dbGet('demandes',analyse.demandeId);
    afficherInfosDemande();
  }
  
  document.getElementById('analyse-date').value=analyse.dateAnalyse||'';
  document.getElementById('analyse-message').value=analyse.messagePersonnalise||'';
  document.getElementById('analyse-statut').value=analyse.statut||'√Ä envoyer';
  
  document.getElementById('titre-analyse-travail').textContent=`üìã Modifier ANA-${String(id).padStart(3,'0')}`;
  document.getElementById('zone-analyse-travail').style.display='block';
  document.getElementById('zone-analyse-travail').scrollIntoView({behavior:'smooth'});
}

function fermerZoneAnalyse(){
  document.getElementById('zone-analyse-travail').style.display='none';
  editAnalyseId=null;
  currentAnalyseDemande=null;
}

async function onAnalyseSelectDemande(){
  const demandeId=document.getElementById('analyse-demande').value;
  
  if(!demandeId){
    document.getElementById('analyse-infos-demande').style.display='none';
    currentAnalyseDemande=null;
    return;
  }
  
  currentAnalyseDemande=await dbGet('demandes',parseInt(demandeId));
  afficherInfosDemande();
}

function afficherInfosDemande(){
  if(!currentAnalyseDemande){
    document.getElementById('analyse-infos-demande').style.display='none';
    return;
  }
  
  const d=currentAnalyseDemande;
  document.getElementById('info-dem-entreprise').textContent=d.entreprise||d.nom||'-';
  document.getElementById('info-dem-contact').textContent=d.nom||d.contact||'-';
  document.getElementById('info-dem-email').textContent=d.email||'-';
  document.getElementById('info-dem-tel').textContent=d.telephone||d.mobile||'-';
  document.getElementById('info-dem-formation').textContent=d.formation||d.sujet||'-';
  document.getElementById('info-dem-date').textContent=fmtDate(d.dateReception||d.dateCreation);
  document.getElementById('info-dem-message').textContent=d.message||d.description||'Aucun message';
  
  document.getElementById('analyse-infos-demande').style.display='block';
}

async function envoyerQuestionnaireAnalyse(){
  if(!currentAnalyseDemande){
    toast('S√©lectionnez d\'abord une demande','warning');
    return;
  }
  
  const d=currentAnalyseDemande;
  const email=d.email||'';
  const nom=d.nom||d.contact||'';
  const entreprise=d.entreprise||'';
  const formation=d.formation||d.sujet||'la formation demand√©e';
  
  if(!email){
    toast('Aucun email disponible pour cette demande','warning');
    return;
  }
  
  // Construire le lien vers le formulaire
  const baseUrl=window.location.href.split('?')[0]+'?questionnaire=1';
  const params=new URLSearchParams();
  params.set('entreprise',entreprise);
  params.set('email',email);
  params.set('nom',nom);
  params.set('formation',formation);
  
  const lienFormulaire=baseUrl+'&'+params.toString();
  const messagePerso=document.getElementById('analyse-message').value;
  
  const sujet=`üìã Questionnaire d'analyse des besoins - ${formation}`;
  const corps=`Bonjour${nom?' '+nom:''},

Suite √† votre demande de formation concernant "${formation}", nous souhaitons mieux comprendre vos besoins pour vous proposer une solution parfaitement adapt√©e.

${messagePerso?messagePerso+'\\n\\n':''}üìã Merci de remplir notre questionnaire d'analyse des besoins :

${lienFormulaire}

Ce questionnaire nous permettra de :
‚Ä¢ Pr√©ciser vos objectifs op√©rationnels
‚Ä¢ Identifier le niveau des participants
‚Ä¢ D√©finir les modalit√©s de formation souhait√©es
‚Ä¢ Adapter notre proposition √† votre contexte

Une fois compl√©t√©, vous recevrez un code de r√©ponse que vous pourrez nous renvoyer.

Nous restons √† votre disposition pour toute question.

Cordialement,
L'√©quipe Formation DesClick
üìû 01 80 91 62 25 | ‚úâÔ∏è formation@des-click.com`;

  window.location.href='mailto:'+encodeURIComponent(email)+
    '?subject='+encodeURIComponent(sujet)+
    '&body='+encodeURIComponent(corps);
  
  toast('Ouverture de votre client email...','info');
  
  // Mettre √† jour le statut
  document.getElementById('analyse-statut').value='Envoy√©';
}

function copierLienQuestionnaire(){
  if(!currentAnalyseDemande){
    toast('S√©lectionnez d\'abord une demande','warning');
    return;
  }
  
  const d=currentAnalyseDemande;
  const baseUrl=window.location.href.split('?')[0]+'?questionnaire=1';
  const params=new URLSearchParams();
  params.set('entreprise',d.entreprise||'');
  params.set('email',d.email||'');
  params.set('nom',d.nom||'');
  
  const lien=baseUrl+'&'+params.toString();
  navigator.clipboard.writeText(lien);
  toast('Lien copi√© dans le presse-papier !','success');
}

function previsualiserQuestionnaire(){
  const baseUrl=window.location.href.split('?')[0]+'?questionnaire=1';
  window.open(baseUrl,'_blank');
}

async function enregistrerAnalyse(){
  const demandeId=document.getElementById('analyse-demande').value;
  if(!demandeId){
    toast('S√©lectionnez une demande','warning');
    return;
  }
  
  const d=currentAnalyseDemande;
  const data={
    demandeId:parseInt(demandeId),
    entreprise:d?.entreprise||d?.nom||'',
    contact:d?.nom||d?.contact||'',
    email:d?.email||'',
    telephone:d?.telephone||d?.mobile||'',
    formation:d?.formation||d?.sujet||'',
    dateAnalyse:document.getElementById('analyse-date').value,
    messagePersonnalise:document.getElementById('analyse-message').value,
    statut:document.getElementById('analyse-statut').value,
    questionsIncluses:{
      objectifs:document.getElementById('q-objectifs')?.checked,
      prerequis:document.getElementById('q-prerequis')?.checked,
      modalites:document.getElementById('q-modalites')?.checked,
      dates:document.getElementById('q-dates')?.checked,
      stagiaires:document.getElementById('q-stagiaires')?.checked,
      handicap:document.getElementById('q-handicap')?.checked,
      financement:document.getElementById('q-financement')?.checked
    }
  };
  
  if(editAnalyseId){
    data.id=editAnalyseId;
    await dbPut('analyses',data);
    await addHistory('Modification','Analyse ANA-'+String(editAnalyseId).padStart(3,'0'));
    toast('Analyse mise √† jour','success');
  }else{
    data.dateCreation=new Date().toISOString();
    const id=await dbAdd('analyses',data);
    await addHistory('Cr√©ation','Nouvelle analyse ANA-'+String(id).padStart(3,'0'));
    toast('Analyse enregistr√©e','success');
  }
  
  fermerZoneAnalyse();
  await showAnalyses();
}

async function relancerQuestionnaire(id){
  const analyse=await dbGet('analyses',id);
  if(!analyse){return;}
  
  currentAnalyseDemande={
    email:analyse.email,
    nom:analyse.contact,
    entreprise:analyse.entreprise,
    formation:analyse.formation
  };
  
  envoyerQuestionnaireAnalyse();
}

async function creerEvaluationDepuisAnalyse(analyseId){
  // Naviguer vers l'onglet √âvaluation et pr√©-s√©lectionner l'analyse
  naviguerVersSection('analyse-eval','evaluation');
  setTimeout(async()=>{
    await ouvrirNouvelleEvaluation();
    document.getElementById('eval-analyse').value=analyseId;
    await onEvalSelectAnalyse();
  },300);
}

// ============ EVALUATION - Traitement des r√©ponses et cr√©ation session ============
let evaluationsData=[];
let currentEvalAnalyse=null;
let editEvalId=null;

async function showEvaluations(){
  evaluationsData=await dbGetAll('evaluations');
  evaluationsData.sort((a,b)=>new Date(b.dateCreation||0)-new Date(a.dateCreation||0));
  
  // Charger les formations pour le select
  const formations=await dbGetAll('formations');
  const selectForm=document.getElementById('eval-formation-preconisee');
  if(selectForm){
    selectForm.innerHTML='<option value="">-- S√©lectionner --</option>'+
      formations.map(f=>`<option value="${f.id}">${esc(f.intitule||f.nom)}</option>`).join('');
  }
  
  renderEvaluationsList();
}

function filterEvaluations(){renderEvaluationsList();}

function renderEvaluationsList(){
  const searchTerm=(document.getElementById('search-evaluations')?.value||'').toLowerCase();
  const filterStatut=document.getElementById('filter-eval-statut')?.value||'';
  
  let filtered=evaluationsData.filter(e=>{
    const matchSearch=!searchTerm||
      (e.entreprise||'').toLowerCase().includes(searchTerm)||
      (e.contact||'').toLowerCase().includes(searchTerm)||
      (e.formationPreconisee||'').toLowerCase().includes(searchTerm);
    const matchStatut=!filterStatut||e.statut===filterStatut;
    return matchSearch&&matchStatut;
  });
  
  const tbody=document.getElementById('table-evaluations');
  if(!filtered.length){
    tbody.innerHTML='<tr><td colspan="9" class="empty-state"><div class="empty-state-icon">üìù</div><h3>Aucune √©valuation</h3><p>Cr√©ez une √©valuation √† partir d\'une analyse avec r√©ponse re√ßue</p></td></tr>';
  }else{
    tbody.innerHTML=filtered.map(d=>{
      const id=d.id;
      const statutClass=d.statut==='Session cr√©√©e'?'conforme':d.statut==='Valid√©'?'en-cours':'nouveau';
      const canCreateSession=d.statut==='Valid√©';
      return `<tr>
        <td><code style="background:#f3e8ff;color:#7c3aed;padding:4px 8px;border-radius:4px">EVA-${String(id).padStart(3,'0')}</code></td>
        <td><strong>${esc(d.entreprise||'-')}</strong></td>
        <td>${esc(d.contact||'-')}</td>
        <td>${esc(d.formationPreconiseeNom||d.formationPreconisee||'-')}</td>
        <td style="text-align:center">${d.nbStagiaires||'-'}</td>
        <td>${d.modalites?{intra:'üè¢ Intra',inter:'üèõÔ∏è Inter',distance:'üíª Distance',mixte:'üîÑ Mixte'}[d.modalites]||d.modalites:'-'}</td>
        <td>${fmtDate(d.dateEvaluation)}</td>
        <td><span class="status status-${statutClass}">${d.statut||'√Ä traiter'}</span></td>
        <td class="action-btns">
          ${canCreateSession?`<button class="btn btn-success btn-icon" onclick="creerSessionDepuisEval(${id})" title="Cr√©er session">üéì</button>`:''}
          <button class="btn btn-info btn-icon" onclick="genererPDFEvaluationById(${id})" title="PDF">üìÑ</button>
          <button class="btn btn-secondary btn-icon" onclick="ouvrirModifierEvaluation(${id})" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-icon" onclick="confirmDelete('evaluations',${id})" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('');
  }
  
  // Mettre √† jour les KPIs
  document.getElementById('kpi-eval-total').textContent=evaluationsData.length;
  document.getElementById('kpi-eval-traiter').textContent=evaluationsData.filter(e=>e.statut==='√Ä traiter'||e.statut==='En cours').length;
  document.getElementById('kpi-eval-validees').textContent=evaluationsData.filter(e=>e.statut==='Valid√©').length;
  document.getElementById('kpi-eval-sessions').textContent=evaluationsData.filter(e=>e.statut==='Session cr√©√©e').length;
}

async function ouvrirNouvelleEvaluation(){
  editEvalId=null;
  currentEvalAnalyse=null;
  
  // Charger les analyses avec r√©ponse re√ßue
  const analyses=await dbGetAll('analyses');
  const evaluations=await dbGetAll('evaluations');
  const analysesEvaluees=new Set(evaluations.map(e=>e.analyseId));
  
  const analysesDisponibles=analyses.filter(a=>a.statut==='R√©ponse re√ßue'&&!analysesEvaluees.has(a.id));
  
  const select=document.getElementById('eval-analyse');
  if(analysesDisponibles.length===0){
    select.innerHTML='<option value="">Aucune analyse avec r√©ponse disponible</option>';
  }else{
    select.innerHTML='<option value="">-- S√©lectionner une analyse --</option>'+
      analysesDisponibles.map(a=>`<option value="${a.id}">ANA-${String(a.id).padStart(3,'0')} - ${esc(a.entreprise||'')} (${esc(a.contact||'')})</option>`).join('');
  }
  
  // Charger les formations
  const formations=await dbGetAll('formations');
  const selectForm=document.getElementById('eval-formation-preconisee');
  if(selectForm){
    selectForm.innerHTML='<option value="">-- S√©lectionner --</option>'+
      formations.map(f=>`<option value="${f.id}">${esc(f.intitule||f.nom)}</option>`).join('');
  }
  
  document.getElementById('eval-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('eval-infos-analyse').style.display='none';
  reinitialiserFormulaireEvaluation();
  
  document.getElementById('titre-evaluation-travail').textContent='üìù Nouvelle √âvaluation des Besoins';
  document.getElementById('zone-evaluation-travail').style.display='block';
  document.getElementById('zone-evaluation-travail').scrollIntoView({behavior:'smooth'});
}

async function ouvrirModifierEvaluation(id){
  const evaluation=await dbGet('evaluations',id);
  if(!evaluation){toast('√âvaluation non trouv√©e','error');return;}
  
  editEvalId=id;
  
  // Recharger les analyses
  const analyses=await dbGetAll('analyses');
  const select=document.getElementById('eval-analyse');
  select.innerHTML='<option value="">-- S√©lectionner une analyse --</option>'+
    analyses.map(a=>`<option value="${a.id}"${a.id===evaluation.analyseId?' selected':''}>ANA-${String(a.id).padStart(3,'0')} - ${esc(a.entreprise||'')}</option>`).join('');
  
  if(evaluation.analyseId){
    currentEvalAnalyse=await dbGet('analyses',evaluation.analyseId);
    afficherInfosAnalyse();
  }
  
  // Remplir le formulaire
  document.getElementById('eval-date').value=evaluation.dateEvaluation||'';
  document.getElementById('eval-objectifs').value=evaluation.objectifs||'';
  document.getElementById('eval-prerequis').value=evaluation.prerequis||'';
  document.getElementById('eval-nb-stagiaires').value=evaluation.nbStagiaires||'';
  document.getElementById('eval-dates-souhaitees').value=evaluation.datesSouhaitees||'';
  document.getElementById('eval-modalites').value=evaluation.modalites||'';
  document.getElementById('eval-handicap').value=evaluation.handicap||'non';
  document.getElementById('eval-financement').value=evaluation.financement||'';
  document.getElementById('eval-autres-besoins').value=evaluation.autresBesoins||'';
  document.getElementById('eval-synthese').value=evaluation.synthese||'';
  document.getElementById('eval-preconisations').value=evaluation.preconisations||'';
  document.getElementById('eval-formation-preconisee').value=evaluation.formationPreconisee||'';
  document.getElementById('eval-duree-preconisee').value=evaluation.dureePreconisee||'';
  document.getElementById('eval-statut').value=evaluation.statut||'√Ä traiter';
  
  document.getElementById('titre-evaluation-travail').textContent=`üìù Modifier EVA-${String(id).padStart(3,'0')}`;
  document.getElementById('zone-evaluation-travail').style.display='block';
  document.getElementById('zone-evaluation-travail').scrollIntoView({behavior:'smooth'});
}

function fermerZoneEvaluation(){
  document.getElementById('zone-evaluation-travail').style.display='none';
  editEvalId=null;
  currentEvalAnalyse=null;
}

function reinitialiserFormulaireEvaluation(){
  const fields=['eval-objectifs','eval-prerequis','eval-nb-stagiaires','eval-dates-souhaitees',
    'eval-autres-besoins','eval-synthese','eval-preconisations','eval-duree-preconisee'];
  fields.forEach(f=>{const el=document.getElementById(f);if(el)el.value='';});
  document.getElementById('eval-modalites').value='';
  document.getElementById('eval-handicap').value='non';
  document.getElementById('eval-financement').value='';
  document.getElementById('eval-formation-preconisee').value='';
  document.getElementById('eval-statut').value='√Ä traiter';
}

async function onEvalSelectAnalyse(){
  const anaId=document.getElementById('eval-analyse').value;
  
  if(!anaId){
    document.getElementById('eval-infos-analyse').style.display='none';
    currentEvalAnalyse=null;
    return;
  }
  
  currentEvalAnalyse=await dbGet('analyses',parseInt(anaId));
  afficherInfosAnalyse();
}

function afficherInfosAnalyse(){
  if(!currentEvalAnalyse){
    document.getElementById('eval-infos-analyse').style.display='none';
    return;
  }
  
  const a=currentEvalAnalyse;
  document.getElementById('eval-info-entreprise').textContent=a.entreprise||'-';
  document.getElementById('eval-info-contact').textContent=a.contact||'-';
  document.getElementById('eval-info-email').textContent=a.email||'-';
  document.getElementById('eval-info-tel').textContent=a.telephone||'-';
  document.getElementById('eval-info-formation').textContent=a.formation||'-';
  document.getElementById('eval-info-date').textContent=fmtDate(a.dateAnalyse);
  
  document.getElementById('eval-infos-analyse').style.display='block';
}

function importerReponsesQuestionnaire(){
  const code=prompt('Collez le code de r√©ponse (DESCLICK-EVAL::...)');
  if(!code)return;
  
  if(!code.startsWith('DESCLICK-EVAL::')){
    toast('Code invalide. Doit commencer par DESCLICK-EVAL::','error');
    return;
  }
  
  try{
    const base64Data=code.replace('DESCLICK-EVAL::','');
    const jsonStr=decodeURIComponent(escape(atob(base64Data)));
    const data=JSON.parse(jsonStr);
    
    // Remplir le formulaire
    document.getElementById('eval-objectifs').value=data.objectifs||'';
    document.getElementById('eval-prerequis').value=data.prerequis||'';
    document.getElementById('eval-nb-stagiaires').value=data.nbStagiaires||'';
    document.getElementById('eval-dates-souhaitees').value=data.besoinDate||'';
    document.getElementById('eval-autres-besoins').value=data.autresBesoins||'';
    
    if(data.modalites){
      const modalitesMap={'Dans vos locaux':'intra','Dans nos locaux':'inter','√Ä distance':'distance','Mixte':'mixte'};
      document.getElementById('eval-modalites').value=modalitesMap[data.modalites]||'';
    }
    document.getElementById('eval-handicap').value=data.handicap==='OUI'?'oui':'non';
    
    toast('R√©ponses import√©es avec succ√®s !','success');
  }catch(e){
    console.error(e);
    toast('Erreur lors du d√©codage du code','error');
  }
}

async function enregistrerEvaluation(){
  const analyseId=document.getElementById('eval-analyse').value;
  if(!analyseId){
    toast('S√©lectionnez une analyse','warning');
    return;
  }
  
  const synthese=document.getElementById('eval-synthese').value.trim();
  if(!synthese){
    toast('La synth√®se est obligatoire','warning');
    return;
  }
  
  const a=currentEvalAnalyse;
  const formationId=document.getElementById('eval-formation-preconisee').value;
  let formationNom='';
  if(formationId){
    const form=await dbGet('formations',parseInt(formationId));
    formationNom=form?form.intitule||form.nom:'';
  }
  
  const data={
    analyseId:parseInt(analyseId),
    entreprise:a?.entreprise||'',
    contact:a?.contact||'',
    email:a?.email||'',
    telephone:a?.telephone||'',
    dateEvaluation:document.getElementById('eval-date').value,
    objectifs:document.getElementById('eval-objectifs').value,
    prerequis:document.getElementById('eval-prerequis').value,
    nbStagiaires:parseInt(document.getElementById('eval-nb-stagiaires').value)||0,
    datesSouhaitees:document.getElementById('eval-dates-souhaitees').value,
    modalites:document.getElementById('eval-modalites').value,
    handicap:document.getElementById('eval-handicap').value,
    financement:document.getElementById('eval-financement').value,
    autresBesoins:document.getElementById('eval-autres-besoins').value,
    synthese:synthese,
    preconisations:document.getElementById('eval-preconisations').value,
    formationPreconisee:formationId?parseInt(formationId):null,
    formationPreconiseeNom:formationNom,
    dureePreconisee:parseInt(document.getElementById('eval-duree-preconisee').value)||0,
    statut:document.getElementById('eval-statut').value
  };
  
  if(editEvalId){
    data.id=editEvalId;
    await dbPut('evaluations',data);
    await addHistory('Modification','√âvaluation EVA-'+String(editEvalId).padStart(3,'0'));
    toast('√âvaluation mise √† jour','success');
  }else{
    data.dateCreation=new Date().toISOString();
    const id=await dbAdd('evaluations',data);
    
    // Marquer l'analyse comme √©valu√©e
    if(currentEvalAnalyse){
      currentEvalAnalyse.evaluationCreee=true;
      await dbPut('analyses',currentEvalAnalyse);
    }
    
    await addHistory('Cr√©ation','Nouvelle √©valuation EVA-'+String(id).padStart(3,'0'));
    toast('√âvaluation enregistr√©e','success');
  }
  
  fermerZoneEvaluation();
  await showEvaluations();
}

async function creerSessionDepuisEvaluation(){
  if(!editEvalId&&!currentEvalAnalyse){
    toast('Enregistrez d\'abord l\'√©valuation','warning');
    return;
  }
  
  // R√©cup√©rer l'√©valuation courante
  const evalId=editEvalId;
  const evaluation=evalId?await dbGet('evaluations',evalId):null;
  
  if(!evaluation){
    toast('√âvaluation non trouv√©e','error');
    return;
  }
  
  // Naviguer vers les sessions et ouvrir le formulaire
  showPage('sessions');
  setTimeout(async()=>{
    openModal('session');
    // Pr√©-remplir avec les donn√©es de l'√©valuation
    document.getElementById('form-session-formation').value=evaluation.formationPreconisee||'';
    document.getElementById('form-session-nbPlaces').value=evaluation.nbStagiaires||10;
    if(evaluation.modalites){
      const modalitesMap={intra:'Intra',inter:'Inter',distance:'E-learning',mixte:'Blended'};
      document.getElementById('form-session-modalite').value=modalitesMap[evaluation.modalites]||'Intra';
    }
  },300);
}

async function creerSessionDepuisEval(evalId){
  const evaluation=await dbGet('evaluations',evalId);
  if(!evaluation){
    toast('√âvaluation non trouv√©e','error');
    return;
  }
  
  if(confirm(`Cr√©er une session de formation bas√©e sur l'√©valuation EVA-${String(evalId).padStart(3,'0')} ?`)){
    showPage('sessions');
    setTimeout(async()=>{
      openModal('session');
      document.getElementById('form-session-formation').value=evaluation.formationPreconisee||'';
      document.getElementById('form-session-nbPlaces').value=evaluation.nbStagiaires||10;
      if(evaluation.modalites){
        const modalitesMap={intra:'Intra',inter:'Inter',distance:'E-learning',mixte:'Blended'};
        document.getElementById('form-session-modalite').value=modalitesMap[evaluation.modalites]||'Intra';
      }
      
      // Mettre √† jour le statut de l'√©valuation
      evaluation.statut='Session cr√©√©e';
      await dbPut('evaluations',evaluation);
    },300);
  }
}

async function genererPDFEvaluation(){
  toast('G√©n√©ration du PDF de synth√®se...','info');
  // La fonction sera appel√©e pour g√©n√©rer le PDF
}

async function genererPDFEvaluationById(id){
  toast('G√©n√©ration du PDF de synth√®se...','info');
}

function importerCodeEval(){
  const code=document.getElementById('import-code-eval').value.trim();
  
  if(!code){
    toast('Collez un code','warning');
    return;
  }
  
  if(!code.startsWith('DESCLICK-EVAL::')){
    toast('Code invalide. Doit commencer par DESCLICK-EVAL::','error');
    return;
  }
  
  try{
    const base64Data=code.replace('DESCLICK-EVAL::','');
    const jsonStr=decodeURIComponent(escape(atob(base64Data)));
    const data=JSON.parse(jsonStr);
    
    // Remplir le formulaire avec les donn√©es d√©cod√©es
    document.getElementById('fiche-nom').value=data.nom||'';
    document.getElementById('fiche-prenom').value=data.prenom||'';
    document.getElementById('fiche-adresse').value=data.adresse||'';
    document.getElementById('fiche-cp').value=data.codePostal||'';
    document.getElementById('fiche-ville').value=data.ville||'';
    document.getElementById('fiche-email').value=data.email||'';
    document.getElementById('fiche-tel').value=data.telephone||'';
    document.getElementById('fiche-entreprise').value=data.entreprise||'';
    document.getElementById('fiche-siret').value=data.siret||'';
    document.getElementById('fiche-handicap').value=data.handicap||'NON';
    document.getElementById('fiche-nbSalaries').value=data.nbSalaries||'';
    document.getElementById('fiche-autresBesoinsId').value=data.autresBesoinsId||'NON';
    document.getElementById('fiche-besoinDate').value=data.besoinDate||'';
    document.getElementById('fiche-besoinGeneral').value=data.besoinGeneral||'';
    document.getElementById('fiche-prerequis').value=data.prerequis||'Voir le programme de formation';
    document.getElementById('fiche-objectifs').value=data.objectifs||'';
    document.getElementById('fiche-modalites').value=data.modalites||'Dans vos locaux';
    document.getElementById('fiche-autresBesoins').value=data.autresBesoins||'NON';
    document.getElementById('fiche-formation').value=data.formation||'';
    
    document.getElementById('zone-import-code').style.display='none';
    toast('‚úÖ Donn√©es import√©es avec succ√®s !','success');
    
  }catch(e){
    console.error('Erreur d√©codage:',e);
    toast('Erreur lors du d√©codage du code','error');
  }
}

// Zone de collage pour √âvaluation
function afficherZoneCollageEval(){
  const zone=document.getElementById('zone-collage-eval');
  zone.style.display=zone.style.display==='none'?'block':'none';
  document.getElementById('zone-import-code').style.display='none';
  document.getElementById('collage-reponses-eval').value='';
  document.getElementById('preview-reponses-eval').style.display='none';
}

function previsualiserReponsesEval(){
  const data=document.getElementById('collage-reponses-eval').value;
  if(!data.trim()){toast('Collez des donn√©es','warning');return;}
  
  const cols=data.split('\t');
  const labels=['Horodateur','Email','Nom-Pr√©nom','Adresse','CP','Ville','T√©l√©phone','Entreprise','SIRET','Handicap','Autres besoins id.','Nb salari√©s','Besoin date','Besoin g√©n√©ral','Pr√©requis','Objectifs','Modalit√©s','Autres besoins','Formation'];
  
  let html='<table style="width:100%;border-collapse:collapse">';
  cols.forEach((val,i)=>{
    if(val&&i<labels.length){
      html+=`<tr><td style="padding:2px 4px;border:1px solid var(--gray-300);font-weight:bold;background:var(--gray-100)">${labels[i]}</td><td style="padding:2px 4px;border:1px solid var(--gray-300)">${esc(val.substring(0,60))}${val.length>60?'...':''}</td></tr>`;
    }
  });
  html+='</table>';
  
  document.getElementById('preview-reponses-eval').innerHTML=html;
  document.getElementById('preview-reponses-eval').style.display='block';
}

function appliquerReponsesEval(){
  const data=document.getElementById('collage-reponses-eval').value;
  if(!data.trim()){toast('Collez des donn√©es','warning');return;}
  
  const cols=data.split('\t');
  const parsed=parseGoogleSheetsRow(cols);
  
  document.getElementById('fiche-nom').value=parsed.clientNom||'';
  document.getElementById('fiche-prenom').value=parsed.clientPrenom||'';
  document.getElementById('fiche-adresse').value=parsed.clientAdresse||'';
  document.getElementById('fiche-cp').value=parsed.clientCP||'';
  document.getElementById('fiche-ville').value=parsed.clientVille||'';
  document.getElementById('fiche-email').value=parsed.clientEmail||'';
  document.getElementById('fiche-tel').value=parsed.clientTel||'';
  document.getElementById('fiche-entreprise').value=parsed.clientEntreprise||'';
  document.getElementById('fiche-siret').value=parsed.clientSiret||'';
  document.getElementById('fiche-handicap').value=parsed.situationHandicap||'NON';
  document.getElementById('fiche-nbSalaries').value=parsed.nbSalaries||'';
  document.getElementById('fiche-autresBesoinsId').value=parsed.autresBesoinsIdentifies||'NON';
  document.getElementById('fiche-besoinDate').value=parsed.besoinDate||'';
  document.getElementById('fiche-besoinGeneral').value=parsed.besoinGeneral||'';
  document.getElementById('fiche-prerequis').value=parsed.prerequis||'';
  document.getElementById('fiche-objectifs').value=parsed.objectifsClient||'';
  document.getElementById('fiche-modalites').value=parsed.modalitesFormation||'Dans vos locaux';
  document.getElementById('fiche-autresBesoins').value=parsed.autresBesoins||'NON';
  document.getElementById('fiche-formation').value=parsed.formationTexte||'';
  
  document.getElementById('zone-collage-eval').style.display='none';
  toast('R√©ponses appliqu√©es','success');
}

// Import en masse des codes
function afficherSyncMasseEval(){
  document.getElementById('zone-sync-masse-eval').style.display='block';
  document.getElementById('sync-masse-data-eval').value='';
  document.getElementById('sync-masse-results-eval').style.display='none';
}

function fermerSyncMasseEval(){
  document.getElementById('zone-sync-masse-eval').style.display='none';
}

async function importerCodesEnMasse(){
  const data=document.getElementById('sync-masse-data-eval').value.trim();
  if(!data){toast('Collez des codes','warning');return;}
  
  const lines=data.split('\n').filter(l=>l.trim().startsWith('DESCLICK-EVAL::'));
  if(!lines.length){
    toast('Aucun code DESCLICK-EVAL:: valide trouv√©','warning');
    return;
  }
  
  let imported=0;
  let errors=0;
  const results=[];
  
  for(const line of lines){
    try{
      const base64Data=line.trim().replace('DESCLICK-EVAL::','');
      const jsonStr=decodeURIComponent(escape(atob(base64Data)));
      const formData=JSON.parse(jsonStr);
      
      // Cr√©er l'√©valuation
      const evalData={
        dateCreation:new Date().toISOString(),
        dateEvaluation:new Date().toISOString().split('T')[0],
        clientNom:formData.nom||'',
        clientPrenom:formData.prenom||'',
        clientAdresse:formData.adresse||'',
        clientCP:formData.codePostal||'',
        clientVille:formData.ville||'',
        clientEmail:formData.email||'',
        clientTel:formData.telephone||'',
        clientEntreprise:formData.entreprise||'',
        clientSiret:formData.siret||'',
        situationHandicap:formData.handicap||'NON',
        nbSalaries:formData.nbSalaries||'',
        autresBesoinsIdentifies:formData.autresBesoinsId||'NON',
        besoinDate:formData.besoinDate||'',
        besoinGeneral:formData.besoinGeneral||'',
        prerequis:formData.prerequis||'Voir le programme de formation',
        objectifsClient:formData.objectifs||'',
        modalitesFormation:formData.modalites||'Dans vos locaux',
        autresBesoins:formData.autresBesoins||'NON',
        formationTexte:formData.formation||'',
        statut:'En cours'
      };
      
      await dbAdd('evaluations',evalData);
      imported++;
      results.push({success:true,nom:formData.nom,entreprise:formData.entreprise});
    }catch(e){
      errors++;
      results.push({success:false,error:e.message});
    }
  }
  
  // Afficher les r√©sultats
  let html=`<div style="margin-bottom:.5rem;font-size:.8rem">
    <strong>üìä R√©sum√©:</strong> 
    <span style="color:var(--success)">${imported} import√©e(s)</span>
    ${errors?` | <span style="color:var(--danger)">${errors} erreur(s)</span>`:''}
  </div>`;
  html+='<table style="width:100%;font-size:.65rem;border-collapse:collapse">';
  html+='<tr style="background:var(--gray-200)"><th style="padding:3px">Statut</th><th style="padding:3px">Client</th><th style="padding:3px">Entreprise</th></tr>';
  
  results.slice(0,20).forEach(r=>{
    if(r.success){
      html+=`<tr style="color:var(--success)"><td style="padding:2px;border:1px solid var(--gray-300)">‚úÖ</td><td style="padding:2px;border:1px solid var(--gray-300)">${esc(r.nom)}</td><td style="padding:2px;border:1px solid var(--gray-300)">${esc(r.entreprise)}</td></tr>`;
    }else{
      html+=`<tr style="color:var(--danger)"><td style="padding:2px;border:1px solid var(--gray-300)">‚ùå</td><td colspan="2" style="padding:2px;border:1px solid var(--gray-300)">${esc(r.error)}</td></tr>`;
    }
  });
  html+='</table>';
  
  document.getElementById('sync-masse-results-eval').innerHTML=html;
  document.getElementById('sync-masse-results-eval').style.display='block';
  
  if(imported>0){
    await addHistory('Import',imported+' √©valuations import√©es par code');
    toast(imported+' √©valuation(s) import√©e(s)','success');
    await showEvaluations();
  }
}

// G√©n√©ration PDF √âvaluation (nouvelle version adapt√©e)
function genererPDFEvaluation(){
  const a=currentEvalAnalyse||{};
  const formationSelect=document.getElementById('eval-formation-preconisee');
  const formationNom=formationSelect?.options[formationSelect.selectedIndex]?.text||'';
  
  const data={
    date:document.getElementById('eval-date')?.value||new Date().toISOString().split('T')[0],
    entreprise:a.entreprise||document.getElementById('eval-info-entreprise')?.textContent||'',
    contact:a.contact||document.getElementById('eval-info-contact')?.textContent||'',
    email:a.email||document.getElementById('eval-info-email')?.textContent||'',
    telephone:a.telephone||document.getElementById('eval-info-tel')?.textContent||'',
    formation:a.formation||document.getElementById('eval-info-formation')?.textContent||'',
    objectifs:document.getElementById('eval-objectifs')?.value||'',
    prerequis:document.getElementById('eval-prerequis')?.value||'',
    nbStagiaires:document.getElementById('eval-nb-stagiaires')?.value||'',
    datesSouhaitees:document.getElementById('eval-dates-souhaitees')?.value||'',
    modalites:document.getElementById('eval-modalites')?.value||'',
    handicap:document.getElementById('eval-handicap')?.value||'non',
    financement:document.getElementById('eval-financement')?.value||'',
    autresBesoins:document.getElementById('eval-autres-besoins')?.value||'',
    synthese:document.getElementById('eval-synthese')?.value||'',
    preconisations:document.getElementById('eval-preconisations')?.value||'',
    formationPreconisee:formationNom||'',
    dureePreconisee:document.getElementById('eval-duree-preconisee')?.value||''
  };
  
  genererPDFEvaluationBesoin(data);
}

async function genererPDFEvaluationById(id){
  const evaluation=await dbGet('evaluations',id);
  if(!evaluation){toast('√âvaluation non trouv√©e','error');return;}
  
  const data={
    date:evaluation.dateEvaluation||new Date().toISOString().split('T')[0],
    entreprise:evaluation.entreprise||'',
    contact:evaluation.contact||'',
    email:evaluation.email||'',
    telephone:evaluation.telephone||'',
    formation:evaluation.formationPreconiseeNom||'',
    objectifs:evaluation.objectifs||'',
    prerequis:evaluation.prerequis||'',
    nbStagiaires:evaluation.nbStagiaires||'',
    datesSouhaitees:evaluation.datesSouhaitees||'',
    modalites:evaluation.modalites||'',
    handicap:evaluation.handicap||'non',
    financement:evaluation.financement||'',
    autresBesoins:evaluation.autresBesoins||'',
    synthese:evaluation.synthese||'',
    preconisations:evaluation.preconisations||'',
    formationPreconisee:evaluation.formationPreconiseeNom||'',
    dureePreconisee:evaluation.dureePreconisee||''
  };
  
  genererPDFEvaluationBesoin(data);
}

function genererPDFEvaluationBesoin(data){
  const modalitesText={intra:'Dans vos locaux',inter:'Dans nos locaux',distance:'√Ä distance',mixte:'Mixte'};
  const handicapText=data.handicap==='oui'?'OUI':'NON';
  const financement=data.financement||'Non pr√©cis√©';
  
  const htmlContent=`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Fiche Evaluation Besoin Client</title>
  <style>
    @page{size:A4;margin:15mm}
    body{font-family:Arial,sans-serif;font-size:11pt;line-height:1.4;color:#333}
    .header{text-align:center;margin-bottom:20px}
    .logo{color:#0066cc;font-size:24pt;font-weight:bold}
    .logo span{color:#ff6600}
    .subtitle{color:#ff6600;font-size:10pt}
    .title{text-align:center;font-size:14pt;font-weight:bold;text-decoration:underline;margin:20px 0}
    table{width:100%;border-collapse:collapse;margin-bottom:15px}
    td{padding:8px;border:1px solid #333;vertical-align:top}
    .label{font-weight:normal}
    .value{font-weight:bold}
    .section-title{background:#f5a623;color:#fff;padding:8px;font-weight:bold;border:1px solid #333}
    .section-blue{background:#4a90d9;color:#fff;padding:8px;font-weight:bold;border:1px solid #333}
    .section-green{background:#22c55e;color:#fff;padding:8px;font-weight:bold;border:1px solid #333}
    .orange{color:#f5a623}
    .blue{color:#0066cc}
    .content-box{padding:10px;min-height:40px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="header">
    <div class="logo"><span>D</span>esClick</div>
    <div class="subtitle">Formation</div>
  </div>
  
  <div class="title">FICHE D'√âVALUATION DES BESOINS DE FORMATION</div>
  
  <table>
    <tr>
      <td class="section-blue" colspan="3">INFORMATIONS CLIENT</td>
    </tr>
    <tr>
      <td colspan="2" class="label">Entreprise : <span class="value">${esc(data.entreprise||'')}</span></td>
      <td class="label">Date : <span class="value">${fmtDate(data.date)}</span></td>
    </tr>
    <tr>
      <td colspan="2" class="label">Contact : <span class="value">${esc(data.contact||data.nom||'')} ${esc(data.prenom||'')}</span></td>
      <td class="label">T√©l√©phone : <span class="value">${esc(data.telephone||data.tel||'')}</span></td>
    </tr>
    <tr>
      <td colspan="3" class="label">Email : <span class="value blue">${esc(data.email||'')}</span></td>
    </tr>
    <tr>
      <td class="label">Nombre de stagiaires : <span class="value">${esc(data.nbStagiaires||'')}</span></td>
      <td class="label">Handicap : <span class="value">${handicapText}</span></td>
      <td class="label">Financement : <span class="value">${esc(financement)}</span></td>
    </tr>
  </table>
  
  <table>
    <tr><td class="section-title" colspan="2"><span class="orange">FORMATION DEMAND√âE</span></td></tr>
    <tr>
      <td class="label">Formation : <span class="value">${esc(data.formation||'')}</span></td>
      <td class="label">Dates souhait√©es : <span class="value">${esc(data.datesSouhaitees||data.besoinDate||'')}</span></td>
    </tr>
    <tr>
      <td colspan="2" class="label">Modalit√©s : <span class="value">${modalitesText[data.modalites]||esc(data.modalites||'')}</span></td>
    </tr>
  </table>
  
  <table>
    <tr><td class="section-blue">OBJECTIFS OP√âRATIONNELS SOUHAIT√âS</td></tr>
    <tr><td class="content-box">${esc(data.objectifs||data.objectifsClient||'')}</td></tr>
  </table>
  
  <table>
    <tr><td class="section-blue">NIVEAU ACTUEL / PR√âREQUIS</td></tr>
    <tr><td class="content-box">${esc(data.prerequis||'Voir le programme de formation')}</td></tr>
  </table>
  
  ${data.autresBesoins?`
  <table>
    <tr><td class="section-title">AUTRES BESOINS EXPRIM√âS</td></tr>
    <tr><td class="content-box">${esc(data.autresBesoins)}</td></tr>
  </table>
  `:''}
  
  <table>
    <tr><td class="section-green">SYNTH√àSE DE L'√âVALUATION DES BESOINS</td></tr>
    <tr><td class="content-box" style="min-height:80px">${esc(data.synthese||'')}</td></tr>
  </table>
  
  <table>
    <tr><td class="section-green">PR√âCONISATIONS DE FORMATION</td></tr>
    <tr><td class="content-box">${esc(data.preconisations||'')}</td></tr>
    <tr>
      <td>
        <p><strong>Formation pr√©conis√©e :</strong> ${esc(data.formationPreconisee||data.formation||'')}</p>
        <p><strong>Dur√©e pr√©conis√©e :</strong> ${data.dureePreconisee?data.dureePreconisee+' heures':'√Ä d√©finir'}</p>
      </td>
    </tr>
  </table>
  
  <div style="margin-top:30px;display:flex;justify-content:space-between">
    <div style="text-align:center;width:45%">
      <p>Signature du client :</p>
      <div style="border-bottom:1px solid #333;height:60px;margin-top:20px"></div>
    </div>
    <div style="text-align:center;width:45%">
      <p>Pour DesClick Formation :</p>
      <div style="border-bottom:1px solid #333;height:60px;margin-top:20px"></div>
    </div>
  </div>
</body>
</html>`;
  
  const printWindow=window.open('','_blank','width=800,height=600');
  if(!printWindow){
    toast('Popup bloqu√©! Autorisez les popups.','error');
    return;
  }
  printWindow.document.write(htmlContent);
  printWindow.document.close();
  setTimeout(()=>{printWindow.print();},500);
  toast('PDF g√©n√©r√©','success');
}

// Parsing Google Sheets
function parseGoogleSheetsRow(cols){
  const nomPrenom=(cols[2]||'').trim().split(' ');
  return {
    dateAnalyse:cols[0]?parseGoogleDate(cols[0]):new Date().toISOString().split('T')[0],
    clientEmail:(cols[1]||'').trim(),
    clientNom:nomPrenom[0]||'',
    clientPrenom:nomPrenom.slice(1).join(' ')||'',
    clientAdresse:(cols[3]||'').trim(),
    clientCP:(cols[4]||'').trim(),
    clientVille:(cols[5]||'').trim(),
    clientTel:(cols[6]||'').trim(),
    clientEntreprise:(cols[7]||'').trim(),
    clientSiret:(cols[8]||'').trim(),
    situationHandicap:(cols[9]||'').toUpperCase().includes('OUI')?'OUI':'NON',
    autresBesoinsIdentifies:(cols[10]||'').toUpperCase().includes('OUI')?'OUI':'NON',
    nbSalaries:cols[11]||'',
    besoinDate:(cols[12]||'').trim(),
    besoinGeneral:(cols[13]||'').trim(),
    prerequis:(cols[14]||'Voir le programme de formation').trim(),
    objectifsClient:(cols[15]||'').trim(),
    modalitesFormation:(cols[16]||'Dans vos locaux').trim(),
    autresBesoins:(cols[17]||'').toUpperCase().includes('OUI')?'OUI':'NON',
    formationTexte:(cols[18]||'').trim()
  };
}

function parseGoogleDate(dateStr){
  const match=dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if(match)return `${match[3]}-${match[2].padStart(2,'0')}-${match[1].padStart(2,'0')}`;
  return new Date().toISOString().split('T')[0];
}

// ============ DEVIS ============
let devisData=[];
let editDevisId=null;

async function showDevis(){
  devisData=await dbGetAll('devis');
  devisData.sort((a,b)=>new Date(b.dateCreation||b.date||0)-new Date(a.dateCreation||a.date||0));
  renderDevisList();
}

function filterDevis(){renderDevisList();}

function renderDevisList(){
  const searchTerm=(document.getElementById('search-devis')?.value||'').toLowerCase();
  
  let filtered=devisData.filter(d=>{
    return !searchTerm||
      (d.numero||'').toLowerCase().includes(searchTerm)||
      (d.entreprise||'').toLowerCase().includes(searchTerm)||
      (d.formation||'').toLowerCase().includes(searchTerm);
  });
  
  const tbody=document.getElementById('table-devis');
  if(!filtered.length){
    tbody.innerHTML='<tr><td colspan="10" class="empty-state"><div class="empty-state-icon">üìÑ</div><h3>Aucun devis</h3><p>Cliquez sur "‚ûï Nouveau Devis" ou "üìã Cr√©er depuis Session"</p></td></tr>';
    return;
  }
  
  tbody.innerHTML=filtered.map(d=>{
    const ttc=(d.montantHT||0)*(1+(d.tva||20)/100);
    const isSigne=d.statut==='Sign√©';
    const signeIcon=d.fichierSigne?
      '<span title="Voir document sign√©" style="color:#16a34a;cursor:pointer" onclick="voirDevisSigneById('+d.id+')">‚úÖ Voir</span>':
      '<span style="color:#9ca3af">‚Äî</span>';
    
    // Quick Wins: Badges Nouveau et Expiration
    const badgeNew = getBadgeNouveau(d.dateCreation || d.date);
    const badgeExp = getBadgeExpiration(d);
    
    // Boutons selon le statut
    let actionsBtns = getBoutonFavori('devis', d.id);
    actionsBtns += getBoutonDupliquer('devis', d.id);
    actionsBtns += `
      <button class="btn btn-primary btn-icon" onclick="genererPDFDevisById(${d.id})" title="G√©n√©rer PDF">üìÑ</button>
      <button class="btn btn-info btn-icon" onclick="ouvrirModifierDevis(${d.id})" title="Modifier">‚úèÔ∏è</button>`;
    
    // Boutons Email - Visualiser et Envoyer
    actionsBtns += `<button class="btn btn-secondary btn-icon" onclick="previsualiserMailDevis(${d.id})" title="Visualiser le mail">üëÅÔ∏èüìß</button>`;
    actionsBtns += `<button class="btn btn-warning btn-icon" onclick="envoyerMailDevisVersOnglet(${d.id})" title="Envoyer vers onglet Mail">üìß</button>`;
    
    // Si pas encore sign√©, afficher le bouton Valider & Sign√©
    if(d.statut!=='Sign√©'){
      actionsBtns+=`<button class="btn btn-success btn-icon" onclick="validerEtSignerDevis(${d.id})" title="Valider & Sign√©">‚úÖ</button>`;
    }
    
    // Bouton upload document sign√©
    actionsBtns+=`<button class="btn btn-warning btn-icon" onclick="uploadDocumentSigne('devis',${d.id})" title="Upload sign√©">üì§</button>`;
    actionsBtns+=`<button class="btn btn-danger btn-icon" onclick="confirmDelete('devis',${d.id})" title="Supprimer">üóëÔ∏è</button>`;
    
    return `<tr>
      <td><code>${esc(d.numero||'DEV-'+String(d.id).padStart(4,'0'))}</code>${badgeNew}</td>
      <td>${fmtDate(d.date)} ${badgeExp}</td>
      <td><strong>${esc(d.entreprise||'-')}</strong><br><small>${esc(d.contact||'')}</small></td>
      <td>${esc(d.formation||'-')}</td>
      <td class="montant">${fmtMoney(d.montantHT)}</td>
      <td class="montant"><strong>${fmtMoney(ttc)}</strong></td>
      <td><span class="status status-${slug(d.statut)}">${d.statut||'Brouillon'}</span></td>
      <td>${signeIcon}</td>
      <td class="action-btns">${actionsBtns}</td>
    </tr>`;
  }).join('');
}

async function ouvrirNouveauDevis(){
  editDevisId=null;
  await chargerSelectsDevis();
  reinitialiserFormulaireDevis();
  reinitialiserDevisSigne();
  
  // G√©n√©rer le num√©ro de devis
  const annee=new Date().getFullYear();
  const count=devisData.filter(d=>d.numero&&d.numero.includes(annee.toString())).length+1;
  document.getElementById('devis-numero').value=`DEV-${annee}-${String(count).padStart(4,'0')}`;
  document.getElementById('devis-date').value=new Date().toISOString().split('T')[0];
  
  document.getElementById('titre-devis-travail').textContent='üìÑ Nouveau Devis';
  document.getElementById('zone-devis-travail').style.display='block';
  document.getElementById('zone-devis-travail').scrollIntoView({behavior:'smooth'});
}

async function ouvrirCreerDevisDepuisSession(){
  editDevisId=null;
  await chargerSelectsDevis();
  reinitialiserFormulaireDevis();
  reinitialiserDevisSigne();
  
  // G√©n√©rer le num√©ro de devis
  const annee=new Date().getFullYear();
  const count=devisData.filter(d=>d.numero&&d.numero.includes(annee.toString())).length+1;
  document.getElementById('devis-numero').value=`DEV-${annee}-${String(count).padStart(4,'0')}`;
  document.getElementById('devis-date').value=new Date().toISOString().split('T')[0];
  
  document.getElementById('titre-devis-travail').textContent='üìÑ Cr√©er Devis depuis Session';
  document.getElementById('zone-devis-travail').style.display='block';
  document.getElementById('zone-devis-travail').scrollIntoView({behavior:'smooth'});
}

async function ouvrirModifierDevis(id){
  const devis=await dbGet('devis',id);
  if(!devis){toast('Devis non trouv√©','error');return;}
  
  editDevisId=id;
  await chargerSelectsDevis();
  
  // Remplir le formulaire
  document.getElementById('devis-numero').value=devis.numero||`DEV-${String(id).padStart(4,'0')}`;
  document.getElementById('devis-date').value=devis.date||'';
  document.getElementById('devis-entreprise').value=devis.entreprise||'';
  document.getElementById('devis-siret').value=devis.siret||'';
  document.getElementById('devis-adresse').value=devis.adresse||'';
  document.getElementById('devis-cp').value=devis.cp||'';
  document.getElementById('devis-ville').value=devis.ville||'';
  document.getElementById('devis-contact').value=devis.contact||'';
  document.getElementById('devis-tel').value=devis.tel||'';
  document.getElementById('devis-email').value=devis.email||'';
  document.getElementById('devis-formation').value=devis.formation||'';
  document.getElementById('devis-lieu').value=devis.lieu||'';
  document.getElementById('devis-dateDebut').value=devis.dateDebut||'';
  document.getElementById('devis-dateFin').value=devis.dateFin||'';
  document.getElementById('devis-horairesMatin').value=devis.horairesMatin||'';
  document.getElementById('devis-horairesAprem').value=devis.horairesAprem||'';
  document.getElementById('devis-duree').value=devis.duree||'';
  document.getElementById('devis-modalite').value=devis.modalite||'INTRA';
  document.getElementById('devis-nbStagiaires').value=devis.nbStagiaires||1;
  document.getElementById('devis-tarifHoraire').value=devis.tarifHoraire||'';
  document.getElementById('devis-nbHeures').value=devis.nbHeures||'';
  document.getElementById('devis-montantHT').value=devis.montantHT||'';
  document.getElementById('devis-tva').value=devis.tva||20;
  document.getElementById('devis-reglement').value=devis.reglement||'Ch√®que | Ech: Comptant';
  document.getElementById('devis-conseiller').value=devis.conseiller||'';
  document.getElementById('devis-statut').value=devis.statut||'Brouillon';
  document.getElementById('devis-observations').value=devis.observations||'';
  document.getElementById('devis-mandat').checked=devis.mandat||false;
  
  // Charger le fichier sign√© s'il existe
  chargerDevisSigneDepuisDevis(devis);
  
  calculerTTCDevis();
  
  document.getElementById('titre-devis-travail').textContent=`üìÑ Modifier ${devis.numero||'Devis'}`;
  document.getElementById('zone-devis-travail').style.display='block';
  document.getElementById('zone-devis-travail').scrollIntoView({behavior:'smooth'});
}

function fermerZoneDevis(){
  document.getElementById('zone-devis-travail').style.display='none';
  editDevisId=null;
}

async function chargerSelectsDevis(){
  // Charger les sessions
  const sessions=await dbGetAll('sessions');
  const formations=await dbGetAll('formations');
  const entreprises=await dbGetAll('entreprises');
  const commerciaux=await dbGetAll('commerciaux');
  
  const formMap=Object.fromEntries(formations.map(f=>[f.id,f]));
  const entMap=Object.fromEntries(entreprises.map(e=>[e.id,e]));
  
  const selectSession=document.getElementById('devis-session');
  selectSession.innerHTML='<option value="">-- Cr√©er sans session --</option>'+
    sessions.map(s=>{
      const form=formMap[s.formation];
      const ent=entMap[s.entreprise];
      return `<option value="${s.id}">SES-${String(s.id).padStart(3,'0')} - ${form?esc(form.nom):'?'} - ${ent?esc(ent.nom):'?'}</option>`;
    }).join('');
  
  const selectConseiller=document.getElementById('devis-conseiller');
  selectConseiller.innerHTML='<option value="">S√©lectionner...</option>'+
    commerciaux.map(c=>`<option value="${c.id}">${esc(c.nom)} ${esc(c.prenom||'')}</option>`).join('');
}

function reinitialiserFormulaireDevis(){
  const fields=['devis-entreprise','devis-siret','devis-adresse','devis-cp','devis-ville','devis-contact','devis-tel','devis-email','devis-formation','devis-lieu','devis-dateDebut','devis-dateFin','devis-horairesMatin','devis-horairesAprem','devis-duree','devis-tarifHoraire','devis-nbHeures','devis-montantHT','devis-montantTTC','devis-observations'];
  fields.forEach(f=>{const el=document.getElementById(f);if(el)el.value='';});
  document.getElementById('devis-session').value='';
  document.getElementById('devis-nbStagiaires').value='1';
  document.getElementById('devis-tva').value='20';
  document.getElementById('devis-modalite').value='INTRA';
  document.getElementById('devis-reglement').value='Ch√®que | Ech: Comptant';
  document.getElementById('devis-statut').value='Brouillon';
  document.getElementById('devis-mandat').checked=false;
  document.getElementById('devis-formule-calcul').textContent='';
}

async function onDevisSelectSession(){
  const sessionId=document.getElementById('devis-session').value;
  if(!sessionId)return;
  
  const session=await dbGet('sessions',parseInt(sessionId));
  if(!session)return;
  
  const formation=session.formation?await dbGet('formations',parseInt(session.formation)):null;
  const entreprise=session.entreprise?await dbGet('entreprises',parseInt(session.entreprise)):null;
  const lieu=session.lieu?await dbGet('lieux',parseInt(session.lieu)):null;
  
  // Remplir les infos client
  if(entreprise){
    document.getElementById('devis-entreprise').value=entreprise.nom||'';
    document.getElementById('devis-siret').value=entreprise.siret||'';
    document.getElementById('devis-adresse').value=entreprise.adresse||'';
    document.getElementById('devis-cp').value=entreprise.codePostal||'';
    document.getElementById('devis-ville').value=entreprise.ville||'';
    document.getElementById('devis-contact').value=entreprise.contact||'';
    document.getElementById('devis-tel').value=entreprise.mobileContact||'';
    document.getElementById('devis-email').value=entreprise.emailContact||entreprise.emailPro||'';
  }
  
  // Remplir les infos formation
  if(formation){
    document.getElementById('devis-formation').value=formation.nom||'';
  }
  
  // Lieu
  if(session.modalite==='Intra'&&session.lieuIntra){
    document.getElementById('devis-lieu').value=session.lieuIntra;
  }else if(lieu){
    document.getElementById('devis-lieu').value=`${lieu.nom}, ${lieu.adresse||''} ${lieu.codePostal||''} ${lieu.ville||''}`;
  }
  
  // Dates et horaires
  document.getElementById('devis-dateDebut').value=session.dateDebutPrev||session.dateDebutEffective||'';
  document.getElementById('devis-dateFin').value=session.dateFinPrev||session.dateFinEffective||'';
  document.getElementById('devis-horairesMatin').value='9:00 √† 12:30';
  document.getElementById('devis-horairesAprem').value='13:30 √† 17:00';
  document.getElementById('devis-duree').value=session.nbHeures||formation?.duree||'';
  document.getElementById('devis-modalite').value=session.modalite==='Intra'?'INTRA':'INTER';
  
  // Tarification
  const nbStag=session.nbStagiairesChiffrage||1;
  document.getElementById('devis-nbStagiaires').value=nbStag;
  document.getElementById('devis-tarifHoraire').value=session.tauxHoraire||'';
  document.getElementById('devis-nbHeures').value=session.nbHeures||formation?.duree||'';
  
  // Calculer le montant
  let montantHT=0;
  if(session.typeChiffrage==='Forfait Horaire'){
    montantHT=(session.tauxHoraire||0)*(session.nbHeures||0)*nbStag;
  }else if(session.typeChiffrage==='Forfait Journalier'){
    montantHT=(session.forfaitJour||0)*(session.nbJours||0);
  }else{
    montantHT=session.montantGlobal||0;
  }
  document.getElementById('devis-montantHT').value=montantHT;
  
  calculerTTCDevis();
  toast('Donn√©es de la session import√©es','success');
}

function calculerMontantDevis(){
  const nbStag=parseFloat(document.getElementById('devis-nbStagiaires').value)||1;
  const tarifH=parseFloat(document.getElementById('devis-tarifHoraire').value)||0;
  const nbHeures=parseFloat(document.getElementById('devis-nbHeures').value)||0;
  
  const montant=nbStag*tarifH*nbHeures;
  document.getElementById('devis-montantHT').value=montant.toFixed(2);
  
  // Afficher la formule
  document.getElementById('devis-formule-calcul').innerHTML=
    `<strong>Calcul:</strong> ${nbStag} stagiaire(s) √ó ${tarifH.toFixed(2)}‚Ç¨/h √ó ${nbHeures}h = <strong>${montant.toFixed(2)}‚Ç¨ HT</strong>`;
  
  calculerTTCDevis();
}

function calculerTTCDevis(){
  const montantHT=parseFloat(document.getElementById('devis-montantHT').value)||0;
  const tva=parseFloat(document.getElementById('devis-tva').value)||20;
  const ttc=montantHT*(1+tva/100);
  document.getElementById('devis-montantTTC').value=ttc.toFixed(2);
}

async function enregistrerDevis(){
  const data={
    numero:document.getElementById('devis-numero').value,
    date:document.getElementById('devis-date').value,
    sessionId:document.getElementById('devis-session').value||null,
    entreprise:document.getElementById('devis-entreprise').value,
    siret:document.getElementById('devis-siret').value,
    adresse:document.getElementById('devis-adresse').value,
    cp:document.getElementById('devis-cp').value,
    ville:document.getElementById('devis-ville').value,
    contact:document.getElementById('devis-contact').value,
    tel:document.getElementById('devis-tel').value,
    email:document.getElementById('devis-email').value,
    formation:document.getElementById('devis-formation').value,
    lieu:document.getElementById('devis-lieu').value,
    dateDebut:document.getElementById('devis-dateDebut').value,
    dateFin:document.getElementById('devis-dateFin').value,
    horairesMatin:document.getElementById('devis-horairesMatin').value,
    horairesAprem:document.getElementById('devis-horairesAprem').value,
    duree:document.getElementById('devis-duree').value,
    modalite:document.getElementById('devis-modalite').value,
    nbStagiaires:document.getElementById('devis-nbStagiaires').value,
    tarifHoraire:document.getElementById('devis-tarifHoraire').value,
    nbHeures:document.getElementById('devis-nbHeures').value,
    montantHT:parseFloat(document.getElementById('devis-montantHT').value)||0,
    tva:parseFloat(document.getElementById('devis-tva').value)||20,
    reglement:document.getElementById('devis-reglement').value,
    conseiller:document.getElementById('devis-conseiller').value,
    statut:document.getElementById('devis-statut').value,
    observations:document.getElementById('devis-observations').value,
    mandat:document.getElementById('devis-mandat').checked,
    fichierSigne:devisSigneData||null
  };
  
  if(!data.entreprise){toast('L\'entreprise est obligatoire','warning');return;}
  if(!data.formation){toast('La formation est obligatoire','warning');return;}
  
  if(editDevisId){
    data.id=editDevisId;
    await dbPut('devis',data);
    await addHistory('Modification','Devis '+data.numero);
    toast('Devis mis √† jour','success');
  }else{
    data.dateCreation=new Date().toISOString();
    await dbAdd('devis',data);
    await addHistory('Cr√©ation','Devis '+data.numero);
    toast('Devis enregistr√©','success');
  }
  
  fermerZoneDevis();
  await showDevis();
}

function getDevisDataFromForm(){
  return {
    numero:document.getElementById('devis-numero').value,
    date:document.getElementById('devis-date').value,
    entreprise:document.getElementById('devis-entreprise').value,
    siret:document.getElementById('devis-siret').value,
    adresse:document.getElementById('devis-adresse').value,
    cp:document.getElementById('devis-cp').value,
    ville:document.getElementById('devis-ville').value,
    contact:document.getElementById('devis-contact').value,
    tel:document.getElementById('devis-tel').value,
    email:document.getElementById('devis-email').value,
    formation:document.getElementById('devis-formation').value,
    lieu:document.getElementById('devis-lieu').value,
    dateDebut:document.getElementById('devis-dateDebut').value,
    dateFin:document.getElementById('devis-dateFin').value,
    horairesMatin:document.getElementById('devis-horairesMatin').value||'9:00 √† 12:30',
    horairesAprem:document.getElementById('devis-horairesAprem').value||'13:30 √† 17:00',
    duree:document.getElementById('devis-duree').value,
    modalite:document.getElementById('devis-modalite').value,
    nbStagiaires:parseInt(document.getElementById('devis-nbStagiaires').value)||1,
    tarifHoraire:parseFloat(document.getElementById('devis-tarifHoraire').value)||0,
    nbHeures:parseInt(document.getElementById('devis-nbHeures').value)||0,
    montantHT:parseFloat(document.getElementById('devis-montantHT').value)||0,
    tva:parseFloat(document.getElementById('devis-tva').value)||20,
    reglement:document.getElementById('devis-reglement').value,
    conseiller:document.getElementById('devis-conseiller').value,
    observations:document.getElementById('devis-observations').value,
    mandat:document.getElementById('devis-mandat').checked
  };
}

// Fonction pour afficher erreur copiable
function showErrorCopiable(titre,erreur){
  const msg=titre+': '+erreur.message+'\n\nStack:\n'+erreur.stack;
  const div=document.createElement('div');
  div.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:3px solid red;padding:20px;z-index:99999;max-width:90%;max-height:80vh;overflow:auto;border-radius:10px;box-shadow:0 10px 50px rgba(0,0,0,0.5)';
  div.innerHTML='<h3 style="color:red;margin-bottom:10px">‚ùå '+titre+'</h3><textarea style="width:100%;height:200px;font-family:monospace;font-size:12px" readonly>'+msg.replace(/</g,'&lt;')+'</textarea><br><button onclick="this.parentElement.remove()" style="margin-top:10px;padding:10px 20px;cursor:pointer">Fermer</button>';
  document.body.appendChild(div);
}

async function genererPDFDevis(){
  try{
    const data=getDevisDataFromForm();
    console.log('Donn√©es devis:',data);
    genererPDFDevisDocument(data);
  }catch(e){
    console.error('Erreur genererPDFDevis:',e);
    showErrorCopiable('Erreur genererPDFDevis',e);
  }
}

async function genererPDFDevisById(id){
  try{
    console.log('G√©n√©ration PDF pour devis ID:',id);
    const devis=await dbGet('devis',id);
    if(!devis){toast('Devis non trouv√©','error');return;}
    console.log('Devis trouv√©:',devis);
    genererPDFDevisDocument(devis);
  }catch(e){
    console.error('Erreur genererPDFDevisById:',e);
    showErrorCopiable('Erreur genererPDFDevisById',e);
  }
}

function genererPDFDevisDocument(data){
  try{
  // Parser toutes les valeurs num√©riques
  const montantHT=parseFloat(data.montantHT)||0;
  const tva=parseFloat(data.tva)||20;
  const tvaAmount=montantHT*tva/100;
  const ttc=montantHT+tvaAmount;
  const nbStag=parseInt(data.nbStagiaires)||0;
  const tarifH=parseFloat(data.tarifHoraire)||0;
  const nbH=parseInt(data.nbHeures)||0;
  const duree=data.duree||nbH||0;
  
  // Fonction d'√©chappement locale
  const escHtml=(s)=>s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])):'';
  
  // Formater les dates
  const formatDateFr=(d)=>{
    if(!d)return '';
    const date=new Date(d);
    if(isNaN(date.getTime()))return d;
    return date.toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});
  };
  
  // Formater montant EUR
  const formatEUR=(n)=>(parseFloat(n)||0).toFixed(2).replace('.',',')+' EUR';
  
  const htmlContent=`<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Devis ${escHtml(data.numero||'')}</title>
<style>
@page{size:A4;margin:8mm}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;font-size:7.5pt;line-height:1.2;color:#000;padding:12px}

/* COULEURS */
.bleu{color:#2563eb}
.orange{color:#ea580c}
.bg-bleu{background:#2563eb;color:#fff}
.bg-orange{background:#ea580c;color:#fff}
.bg-bleu-clair{background:#dbeafe}
.bg-orange-clair{background:#ffedd5}

/* HEADER */
.header-top{display:table;width:100%;margin-bottom:12px}
.header-top-left{display:table-cell;width:50%;vertical-align:top}
.header-top-right{display:table-cell;width:50%;vertical-align:top;text-align:right}
.logo-text{font-size:26pt;font-weight:bold;line-height:1}
.logo-d{color:#ea580c}
.logo-es{color:#2563eb}
.logo-sub{font-size:10pt;color:#ea580c;padding-left:3px}
.doc-title{font-size:20pt;font-weight:bold;color:#2563eb}

/* INFO BOXES */
.info-row{display:table;width:100%;margin:8px 0}
.info-box{display:table-cell;vertical-align:top;padding:0 6px}
.info-box-ndoc{width:30%}
.info-box-conseiller{width:40%;text-align:center}
.info-box-date{width:30%}
.info-label{font-size:6.5pt;color:#fff;padding:3px 10px;text-align:center}
.info-value{font-size:9pt;font-weight:bold;padding:5px 10px;text-align:center}
.box-bleu .info-label{background:#2563eb}
.box-bleu .info-value{background:#dbeafe;color:#2563eb}
.box-orange .info-label{background:#ea580c}
.box-orange .info-value{background:#ffedd5;color:#ea580c}
.conseiller-label{font-size:7pt;color:#666}
.conseiller-value{font-size:9pt;font-weight:bold;color:#000}

/* PARTIES */
.parties-row{display:table;width:100%;margin:10px 0;border-spacing:8px 0}
.partie-box{display:table-cell;width:50%;vertical-align:top;border:1px solid #ddd}
.partie-header{background:#2563eb;color:#fff;padding:5px 10px;font-weight:bold;font-size:8pt;text-align:center;text-transform:uppercase}
.partie-content{padding:8px}
.partie-nom{font-weight:bold;font-size:9pt;color:#2563eb;margin-bottom:4px}
.partie-detail{font-size:7.5pt;line-height:1.4;color:#333}
.partie-siret{margin-top:4px}
.partie-contact{font-weight:bold;color:#ea580c;margin-top:4px}

/* TABLEAU */
table.items{width:100%;border-collapse:collapse;margin:8px 0 6px 0}
table.items th{background:#2563eb;color:#fff;padding:6px 8px;text-align:left;font-weight:bold;font-size:7.5pt}
table.items th.r{text-align:right}
table.items td{padding:8px;border:1px solid #ddd;vertical-align:top;font-size:7.5pt}
table.items td.r{text-align:right}
.item-main{font-weight:bold;margin-bottom:5px}
.item-sub{color:#555;padding-left:8px;font-size:7pt;line-height:1.4}
.item-sub div{margin:2px 0}
.item-note{color:#666;font-size:7pt;font-style:italic;margin-top:6px;padding-top:5px;border-top:1px dotted #ccc}

/* MANDAT */
.mandat-section{margin:6px 0;padding:8px;border:1px solid #000}
.mandat-header{margin-bottom:5px}
.mandat-checkbox{display:inline-block;width:10px;height:10px;border:1px solid #000;vertical-align:middle;margin-right:5px}
.mandat-title{font-weight:bold;font-size:8pt}
.mandat-text{font-style:italic;font-size:7pt;color:#000;line-height:1.3;text-align:justify}
.mandat-footer{font-size:6.5pt;color:#666;text-align:center;margin-top:5px;padding-top:5px;border-top:1px solid #eee}

/* TOTAUX */
.totaux-wrapper{text-align:right;margin:8px 0 6px 0}
table.totaux{display:inline-table;border-collapse:collapse;font-size:8pt}
table.totaux td{padding:5px 12px;border:1px solid #ddd}
table.totaux .label{text-align:left;color:#333}
table.totaux .value{text-align:right;font-weight:bold}
table.totaux tr.total td{background:#f0f0f0;font-weight:bold;font-size:9pt}

/* SECTIONS */
.section{margin:5px 0;font-size:7.5pt}
.section-title{font-weight:bold;text-transform:uppercase;margin-bottom:2px}
.section-content{color:#555}

/* LEGAL */
.legal{font-size:6.5pt;color:#666;margin-top:8px;line-height:1.3}

/* FOOTER */
.footer{margin-top:8px;padding-top:6px;border-top:1px solid #ccc;font-size:6.5pt;color:#666;text-align:center;line-height:1.3}
.footer-company{font-weight:bold}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header-top">
  <div class="header-top-left">
    <div class="logo-text"><span class="logo-d">D</span><span class="logo-es">es Click</span></div>
    <div class="logo-sub">Formation</div>
  </div>
  <div class="header-top-right">
    <div class="doc-title">DEVIS</div>
  </div>
</div>

<!-- INFO BOXES : N. Document | Conseiller | Date -->
<div class="info-row">
  <div class="info-box info-box-ndoc">
    <div class="box-bleu">
      <div class="info-label">N. Document</div>
      <div class="info-value">${escHtml(data.numero||'')}</div>
    </div>
  </div>
  <div class="info-box info-box-conseiller">
    <div class="conseiller-label">Votre conseiller</div>
    <div class="conseiller-value">${escHtml(data.conseiller||'Service Formation')}</div>
  </div>
  <div class="info-box info-box-date">
    <div class="box-orange">
      <div class="info-label">Date</div>
      <div class="info-value">${formatDateFr(data.date)}</div>
    </div>
  </div>
</div>

<!-- PARTIES : EMETTEUR | CLIENT -->
<table class="parties-row" style="border-collapse:separate;border-spacing:15px 0;width:100%">
  <tr>
    <td class="partie-box" style="width:50%;border:1px solid #ddd;vertical-align:top">
      <div class="partie-header">ORGANISME DE FORMATION</div>
      <div class="partie-content">
        <div class="partie-nom">DesClick Formation</div>
        <div class="partie-detail">
          3, rue Lech Walesa<br>
          94270 Le Kremlin-Bicetre<br>
          Tel: 01 80 91 60 00<br>
          Email: support@des-click.com<br>
          Web: www.des-click.com
        </div>
      </div>
    </td>
    <td class="partie-box" style="width:50%;border:1px solid #ddd;vertical-align:top">
      <div class="partie-header">CLIENT</div>
      <div class="partie-content">
        <div class="partie-nom">${escHtml(data.entreprise||'')}</div>
        <div class="partie-detail">
          ${escHtml(data.adresse||'')}<br>
          ${escHtml(data.cp||'')} ${escHtml(data.ville||'')}
          ${data.siret?'<div class="partie-siret"><strong>SIRET:</strong> '+escHtml(data.siret)+'</div>':''}
          <div class="partie-contact">${escHtml(data.contact||'')}</div>
          ${escHtml(data.tel||'')}${data.email?' - '+escHtml(data.email):''}
        </div>
      </div>
    </td>
  </tr>
</table>

<!-- TABLEAU DESIGNATION -->
<table class="items">
  <thead>
    <tr>
      <th style="width:50%">DESIGNATION</th>
      <th class="r" style="width:10%">QTE</th>
      <th class="r" style="width:20%">P.U. HT</th>
      <th class="r" style="width:20%">TOTAL HT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <div class="item-main">${escHtml(data.formation||'Formation')}</div>
        <div class="item-sub">
          <div>- Lieu : ${escHtml(data.lieu||'A definir')}</div>
          <div>- Dates : du ${formatDateFr(data.dateDebut)} au ${formatDateFr(data.dateFin)}</div>
          <div>- Horaires : ${escHtml(data.horairesMatin||'9h00-12h30')} / ${escHtml(data.horairesAprem||'13h30-17h00')}</div>
          <div>- Duree : ${duree} heures</div>
          <div>- Modalite : ${escHtml(data.modalite||'INTRA')}</div>
          <div>- Nombre de stagiaires : ${nbStag}</div>
        </div>
        ${nbStag&&tarifH&&nbH?'<div class="item-note">Calcul : '+nbStag+' stagiaire(s) x '+tarifH.toFixed(2)+' EUR/h x '+nbH+'h = '+montantHT.toFixed(2)+' EUR HT</div>':''}
      </td>
      <td class="r">1</td>
      <td class="r">${formatEUR(montantHT)}</td>
      <td class="r">${formatEUR(montantHT)}</td>
    </tr>
  </tbody>
</table>

<!-- MANDAT si coche -->
${data.mandat?`
<div class="mandat-section">
  <div class="mandat-header">
    <span class="mandat-checkbox"></span>
    <span class="mandat-title">Mandat (facultatif)</span>
  </div>
  <div class="mandat-text">
    Par la presente et a la date de signature, je mandate Faouzi DJABER, representant legal de l'organisme de formation SAS DC WEB APS, pour effectuer toutes les demarches necessaires a la constitution et au suivi de mon dossier aupres de l'OPCO ou du FAF jusqu'a son reglement. Tout document ou declaration transmis en mon nom par le mandataire m'engage en cas d'erreur, de non-conformite ou de fausse declaration.
  </div>
  <div class="mandat-footer">
    En cas de mandat, ces signatures valent bon pour mandat et bon pour acceptation de mandat
  </div>
</div>
`:''}

<!-- TOTAUX -->
<div class="totaux-wrapper">
  <table class="totaux">
    <tr>
      <td class="label">Sous-total HT</td>
      <td class="value">${formatEUR(montantHT)}</td>
    </tr>
    <tr>
      <td class="label">TVA (${tva}%)</td>
      <td class="value">${formatEUR(tvaAmount)}</td>
    </tr>
    <tr class="total">
      <td class="label">TOTAL TTC</td>
      <td class="value">${formatEUR(ttc)}</td>
    </tr>
  </table>
</div>

<!-- MODE DE REGLEMENT -->
<div class="section">
  <div class="section-title">MODE DE REGLEMENT</div>
  <div class="section-content">Mode: ${escHtml(data.reglement||'Cheque | Ech: Comptant')}</div>
</div>

<!-- OBSERVATIONS -->
<div class="section">
  <div class="section-title">OBSERVATIONS</div>
  <div class="section-content">${escHtml(data.observations||'Aucune observation')}</div>
</div>

<!-- MENTIONS LEGALES -->
<div class="legal">
En validant ce document, le client reconnait avoir pris connaissance des conditions generales de vente disponibles sur www.des-click.com et les accepte sans reserve.<br>
Conformement a l'article L.221-28 du Code de la Consommation, le client renonce expressement a son droit de retractation pour les prestations de services pleinement executees.
</div>

<!-- FOOTER -->
<div class="footer">
  <div class="footer-company">S.A.S DC WEB APS</div>
  <div>Capital: 1 000,00 EUR - RCS Creteil 812 748 440 - SIRET: 812 748 440 00019 - TVA: FR12 812748440</div>
  <div>3, rue Lech Walesa, 94270 Le Kremlin-Bicetre - Tel: 01 80 91 60 00 - support@des-click.com - www.des-click.com</div>
</div>

</body>
</html>`;
  
  console.log('HTML genere, ouverture fenetre...');
  const printWindow=window.open('','_blank','width=800,height=600');
  if(!printWindow){
    toast('Popup bloque! Autorisez les popups pour ce site.','error');
    return;
  }
  printWindow.document.write(htmlContent);
  printWindow.document.close();
  setTimeout(()=>{printWindow.print();},500);
  toast('PDF Devis genere','success');
  }catch(e){
    console.error('Erreur genererPDFDevisDocument:',e);
    showErrorCopiable('Erreur genererPDFDevisDocument',e);
  }
}

// ============ DEVIS SIGNE - UPLOAD ============
let devisSigneData=null; // Stocke temporairement le fichier en base64

function onDevisSigneSelect(event){
  const file=event.target.files[0];
  if(!file)return;
  
  // V√©rifier le type de fichier
  const allowedTypes=['application/pdf','image/jpeg','image/jpg','image/png'];
  if(!allowedTypes.includes(file.type)){
    toast('Format non support√©. Utilisez PDF, JPG ou PNG.','error');
    return;
  }
  
  // V√©rifier la taille (max 10 Mo)
  if(file.size>10*1024*1024){
    toast('Fichier trop volumineux (max 10 Mo)','error');
    return;
  }
  
  // Lire le fichier en base64
  const reader=new FileReader();
  reader.onload=function(e){
    devisSigneData={
      name:file.name,
      type:file.type,
      size:file.size,
      data:e.target.result,
      uploadedAt:new Date().toISOString()
    };
    
    // Mettre √† jour l'affichage
    updateDevisSigneUI();
    toast('Fichier pr√™t. N\'oubliez pas d\'enregistrer le devis!','success');
  };
  reader.onerror=function(){
    toast('Erreur lors de la lecture du fichier','error');
  };
  reader.readAsDataURL(file);
}

function updateDevisSigneUI(){
  const infoDiv=document.getElementById('devis-signe-info');
  const btnVoir=document.getElementById('btn-voir-devis-signe');
  const btnSuppr=document.getElementById('btn-suppr-devis-signe');
  
  if(devisSigneData){
    const sizeKo=(devisSigneData.size/1024).toFixed(1);
    const dateUpload=devisSigneData.uploadedAt?new Date(devisSigneData.uploadedAt).toLocaleDateString('fr-FR'):'';
    infoDiv.innerHTML=`<strong style="color:#166534">‚úÖ ${esc(devisSigneData.name)}</strong> <span style="color:#666">(${sizeKo} Ko - ${dateUpload})</span>`;
    btnVoir.style.display='inline-block';
    btnSuppr.style.display='inline-block';
  }else{
    infoDiv.innerHTML='Aucun fichier t√©l√©vers√©';
    btnVoir.style.display='none';
    btnSuppr.style.display='none';
  }
}

function voirDevisSigne(){
  if(!devisSigneData||!devisSigneData.data){
    toast('Aucun fichier √† afficher','warning');
    return;
  }
  
  // Ouvrir dans une nouvelle fen√™tre
  const win=window.open('','_blank');
  if(!win){
    toast('Popup bloqu√©!','error');
    return;
  }
  
  if(devisSigneData.type==='application/pdf'){
    win.document.write(`<html><head><title>${esc(devisSigneData.name)}</title></head><body style="margin:0"><embed src="${devisSigneData.data}" type="application/pdf" width="100%" height="100%" style="position:absolute;top:0;left:0;right:0;bottom:0"></body></html>`);
  }else{
    win.document.write(`<html><head><title>${esc(devisSigneData.name)}</title></head><body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f0f0f0"><img src="${devisSigneData.data}" style="max-width:100%;max-height:100vh"></body></html>`);
  }
  win.document.close();
}

async function voirDevisSigneById(id){
  const devis=await dbGet('devis',id);
  if(!devis||!devis.fichierSigne){
    toast('Aucun fichier sign√©','warning');
    return;
  }
  
  devisSigneData=devis.fichierSigne;
  voirDevisSigne();
}

// ============ VALIDER ET SIGNER ============
async function validerEtSignerDevis(id){
  if(!confirm('Marquer ce devis comme "Valid√© et Sign√©" ?')){
    return;
  }
  
  const devis=await dbGet('devis',id);
  if(!devis){
    toast('Devis non trouv√©','error');
    return;
  }
  
  devis.statut='Sign√©';
  devis.dateSignature=new Date().toISOString();
  await dbPut('devis',devis);
  
  toast('Devis marqu√© comme sign√© !','success');
  await showDevis();
}

async function validerEtSignerConvention(id){
  if(!confirm('Marquer cette convention comme "Valid√©e et Sign√©e" ?')){
    return;
  }
  
  const conv=await dbGet('conventions',id);
  if(!conv){
    toast('Convention non trouv√©e','error');
    return;
  }
  
  conv.statut='Sign√©e';
  conv.dateSignature=new Date().toISOString();
  await dbPut('conventions',conv);
  
  toast('Convention marqu√©e comme sign√©e !','success');
  await loadConventions();
}

// ============ UPLOAD DOCUMENT SIGN√â ============
let uploadDocType=null;
let uploadDocId=null;

function uploadDocumentSigne(type,id){
  uploadDocType=type;
  uploadDocId=id;
  document.getElementById('upload-doc-signe-input').value='';
  document.getElementById('upload-doc-signe-preview').style.display='none';
  document.getElementById('upload-doc-signe-preview').innerHTML='';
  
  const titre=type==='devis'?'Devis':'Convention';
  document.getElementById('upload-doc-signe-titre').textContent=`üì§ Uploader le ${titre} sign√©`;
  
  document.getElementById('modal-upload-doc-signe').style.display='flex';
}

function fermerModalUploadDocSigne(){
  document.getElementById('modal-upload-doc-signe').style.display='none';
  uploadDocType=null;
  uploadDocId=null;
}

function onUploadDocSigneChange(input){
  const file=input.files[0];
  if(!file)return;
  
  const previewDiv=document.getElementById('upload-doc-signe-preview');
  
  // V√©rifier le type de fichier
  const allowedTypes=['application/pdf','image/jpeg','image/png','image/jpg'];
  if(!allowedTypes.includes(file.type)){
    toast('Format non support√©. Utilisez PDF, JPG ou PNG.','warning');
    input.value='';
    return;
  }
  
  // V√©rifier la taille (max 10 Mo)
  if(file.size>10*1024*1024){
    toast('Fichier trop volumineux (max 10 Mo)','warning');
    input.value='';
    return;
  }
  
  // Afficher aper√ßu
  const reader=new FileReader();
  reader.onload=function(e){
    const base64=e.target.result;
    
    if(file.type==='application/pdf'){
      previewDiv.innerHTML=`
        <div style="text-align:center;padding:20px;background:#f1f5f9;border-radius:8px">
          <div style="font-size:3rem">üìÑ</div>
          <p style="margin-top:10px;font-weight:600">${esc(file.name)}</p>
          <p style="color:#64748b;font-size:0.9em">${(file.size/1024).toFixed(1)} Ko</p>
        </div>`;
    }else{
      previewDiv.innerHTML=`
        <div style="text-align:center">
          <img src="${base64}" style="max-width:100%;max-height:300px;border-radius:8px;border:1px solid #e5e7eb">
          <p style="margin-top:10px;color:#64748b;font-size:0.9em">${esc(file.name)} - ${(file.size/1024).toFixed(1)} Ko</p>
        </div>`;
    }
    
    previewDiv.style.display='block';
  };
  reader.readAsDataURL(file);
}

async function confirmerUploadDocSigne(){
  const input=document.getElementById('upload-doc-signe-input');
  const file=input.files[0];
  
  if(!file){
    toast('Veuillez s√©lectionner un fichier','warning');
    return;
  }
  
  if(!uploadDocType||!uploadDocId){
    toast('Erreur: type ou ID manquant','error');
    return;
  }
  
  // Lire le fichier en base64
  const reader=new FileReader();
  reader.onload=async function(e){
    const base64=e.target.result;
    
    try{
      // R√©cup√©rer le document
      const doc=await dbGet(uploadDocType,uploadDocId);
      if(!doc){
        toast('Document non trouv√©','error');
        return;
      }
      
      // Mettre √† jour avec le fichier sign√©
      doc.fichierSigne={
        data:base64,
        name:file.name,
        type:file.type,
        size:file.size,
        dateUpload:new Date().toISOString()
      };
      doc.statut=uploadDocType==='devis'?'Sign√©':'Sign√©e';
      doc.dateSignature=new Date().toISOString();
      
      await dbPut(uploadDocType,doc);
      
      toast('Document sign√© upload√© avec succ√®s !','success');
      fermerModalUploadDocSigne();
      
      // Rafra√Æchir la liste
      if(uploadDocType==='devis'){
        await showDevis();
      }else{
        await loadConventions();
      }
    }catch(err){
      console.error('Erreur upload:',err);
      toast('Erreur lors de l\'upload','error');
    }
  };
  reader.readAsDataURL(file);
}

// Voir convention sign√©e
async function voirConventionSigneeById(id){
  const conv=await dbGet('conventions',id);
  if(!conv||!conv.fichierSigne){
    toast('Aucun fichier sign√©','warning');
    return;
  }
  
  const fichier=conv.fichierSigne;
  
  // Ouvrir dans une nouvelle fen√™tre
  if(fichier.type==='application/pdf'){
    const win=window.open('','_blank');
    win.document.write(`
      <html><head><title>Convention sign√©e - ${conv.numero||''}</title></head>
      <body style="margin:0;padding:0">
        <embed src="${fichier.data}" type="application/pdf" width="100%" height="100%" style="position:absolute;top:0;left:0;right:0;bottom:0">
      </body></html>
    `);
  }else{
    const win=window.open('','_blank');
    win.document.write(`
      <html><head><title>Convention sign√©e - ${conv.numero||''}</title></head>
      <body style="margin:0;padding:20px;background:#f5f5f5;text-align:center">
        <h2>Convention sign√©e - ${esc(conv.numero||'')}</h2>
        <img src="${fichier.data}" style="max-width:100%;border:1px solid #ddd;border-radius:8px">
        <p style="margin-top:15px;color:#666">Upload√© le ${fmtDate(fichier.dateUpload)}</p>
      </body></html>
    `);
  }
}

function supprimerDevisSigne(){
  if(confirm('Supprimer le fichier du devis sign√©?')){
    devisSigneData=null;
    updateDevisSigneUI();
    document.getElementById('devis-signe-input').value='';
    toast('Fichier supprim√©. N\'oubliez pas d\'enregistrer!','info');
  }
}

function reinitialiserDevisSigne(){
  devisSigneData=null;
  document.getElementById('devis-signe-input').value='';
  updateDevisSigneUI();
}

function chargerDevisSigneDepuisDevis(devis){
  if(devis&&devis.fichierSigne){
    devisSigneData=devis.fichierSigne;
  }else{
    devisSigneData=null;
  }
  updateDevisSigneUI();
}

async function envoyerDevisParEmail(){
  const data=getDevisDataFromForm();
  
  if(!data.email){
    toast('Veuillez renseigner l\'email du client','warning');
    return;
  }
  
  const sujet=`Devis ${data.numero} - Formation ${data.formation}`;
  const corps=`Bonjour ${data.contact||''},

Suite √† notre √©change, veuillez trouver ci-joint notre devis ${data.numero} pour la formation "${data.formation}".

D√©tails:
- Montant HT: ${(data.montantHT||0).toFixed(2)}‚Ç¨
- TVA (${data.tva||20}%): ${((data.montantHT||0)*(data.tva||20)/100).toFixed(2)}‚Ç¨
- Montant TTC: ${((data.montantHT||0)*(1+(data.tva||20)/100)).toFixed(2)}‚Ç¨

Nous restons √† votre disposition pour toute information compl√©mentaire.

Cordialement,

Service Formation
DesClick Formation
T√©l: 01 80 91 60 00
Email: formation@des-click.com`;

  document.getElementById('email-analyse-dest').value=data.email;
  document.getElementById('email-analyse-sujet').value=sujet;
  document.getElementById('email-analyse-corps').value=corps;
  document.getElementById('modal-email-analyse').classList.add('active');
}

// ============ CONVENTIONS ============
let conventionsData=[];
let editConventionId=null;

async function loadConventions(){
  conventionsData=await dbGetAll('conventions');
  renderConventions();
}

function renderConventions(){
  const tbody=document.getElementById('table-conventions');
  if(!tbody)return;
  
  const search=(document.getElementById('search-conventions')?.value||'').toLowerCase();
  const filtered=conventionsData.filter(c=>{
    const searchStr=`${c.numero} ${c.entreprise} ${c.formation}`.toLowerCase();
    return searchStr.includes(search);
  });
  
  if(filtered.length===0){
    tbody.innerHTML='<tr><td colspan="9" class="empty">Aucune convention</td></tr>';
    return;
  }
  
  tbody.innerHTML=filtered.map(c=>{
    const ttc=(c.prixHT||0)*(c.quantite||1)*(1+(c.tva||20)/100);
    const signeIcon=c.fichierSigne?
      '<span title="Voir document sign√©" style="color:#16a34a;cursor:pointer" onclick="voirConventionSigneeById('+c.id+')">‚úÖ Voir</span>':
      '<span style="color:#9ca3af">‚Äî</span>';
    
    // Boutons selon le statut
    let actionsBtns=`
      <button class="btn btn-primary btn-icon" onclick="genererPDFConventionById(${c.id})" title="G√©n√©rer PDF">üìÑ</button>
      <button class="btn btn-info btn-icon" onclick="ouvrirModifierConvention(${c.id})" title="Modifier">‚úèÔ∏è</button>`;
    
    // Boutons Email - Visualiser et Envoyer (email Pro)
    actionsBtns += `<button class="btn btn-secondary btn-icon" onclick="previsualiserMailConvention(${c.id})" title="Visualiser le mail">üëÅÔ∏èüìß</button>`;
    actionsBtns += `<button class="btn btn-warning btn-icon" onclick="envoyerMailConventionVersOnglet(${c.id})" title="Envoyer vers onglet Mail (Email Pro)">üìß</button>`;
    
    // Si pas encore sign√©e, afficher le bouton Valider & Sign√©e
    if(c.statut!=='Sign√©e'){
      actionsBtns+=`<button class="btn btn-success btn-icon" onclick="validerEtSignerConvention(${c.id})" title="Valider & Sign√©e">‚úÖ</button>`;
    }
    
    // Bouton upload document sign√©
    actionsBtns+=`<button class="btn btn-warning btn-icon" onclick="uploadDocumentSigne('conventions',${c.id})" title="Upload sign√©">üì§</button>`;
    actionsBtns+=`<button class="btn btn-danger btn-icon" onclick="confirmDelete('conventions',${c.id})" title="Supprimer">üóëÔ∏è</button>`;
    
    return `<tr>
      <td><code>${esc(c.numero||'CONV-'+String(c.id).padStart(4,'0'))}</code></td>
      <td>${fmtDate(c.date)}</td>
      <td><strong>${esc(c.entreprise||'-')}</strong></td>
      <td>${esc(c.formation||'-')}</td>
      <td>${fmtDate(c.dateDebut)} - ${fmtDate(c.dateFin)}</td>
      <td class="montant"><strong>${fmtMoney(ttc)}</strong></td>
      <td><span class="status status-${slug(c.statut)}">${c.statut||'Brouillon'}</span></td>
      <td>${signeIcon}</td>
      <td class="action-btns">${actionsBtns}</td>
    </tr>`;
  }).join('');
}

function filterConventions(){
  renderConventions();
}

async function chargerSelectsConvention(){
  // Charger les devis valid√©s
  const devisSelect=document.getElementById('conv-devis');
  if(devisSelect){
    const devisList=await dbGetAll('devis');
    devisSelect.innerHTML='<option value="">-- S√©lectionner un devis --</option>'+
      devisList.filter(d=>d.statut==='Valid√©'||d.statut==='Accept√©'||true).map(d=>
        `<option value="${d.id}">${esc(d.numero||'DEV-'+d.id)} - ${esc(d.entreprise||'')} - ${esc(d.formation||'')}</option>`
      ).join('');
  }
  
  // Charger les entreprises
  const entrepriseSelect=document.getElementById('conv-entreprise-select');
  if(entrepriseSelect){
    const entreprisesList=await dbGetAll('entreprises');
    entrepriseSelect.innerHTML='<option value="">-- S√©lectionner une entreprise --</option>'+
      entreprisesList.map(e=>
        `<option value="${e.id}" data-adresse="${esc(e.adresse||'')}" data-cp="${esc(e.cp||'')}" data-ville="${esc(e.ville||'')}" data-siret="${esc(e.siret||'')}" data-contact="${esc(e.contact||'')}">${esc(e.nom||e.raisonSociale||'Entreprise '+e.id)}</option>`
      ).join('');
  }
}

// Quand on s√©lectionne une entreprise
async function onConvEntrepriseChange(){
  const select=document.getElementById('conv-entreprise-select');
  const selectedOption=select.options[select.selectedIndex];
  
  if(!select.value){
    return;
  }
  
  // Remplir le champ texte entreprise
  document.getElementById('conv-entreprise').value=selectedOption.textContent;
  
  // Remplir les autres champs depuis les data attributes
  document.getElementById('conv-adresse').value=selectedOption.dataset.adresse||'';
  document.getElementById('conv-cp').value=selectedOption.dataset.cp||'';
  document.getElementById('conv-ville').value=selectedOption.dataset.ville||'';
  document.getElementById('conv-siret').value=selectedOption.dataset.siret||'';
  document.getElementById('conv-representant').value=selectedOption.dataset.contact||'';
  
  // Charger automatiquement les stagiaires de cette entreprise
  await chargerStagiairesEntrepriseConv();
}

// Charger les stagiaires de l'entreprise s√©lectionn√©e (pour convention)
async function chargerStagiairesEntrepriseConv(){
  const entrepriseNom=(document.getElementById('conv-entreprise').value||'').trim();
  const listeDiv=document.getElementById('conv-stagiaires-liste');
  
  if(!entrepriseNom){
    toast('Veuillez d\'abord s√©lectionner une entreprise','warning');
    return;
  }
  
  // R√©cup√©rer tous les stagiaires
  const allStagiaires=await dbGetAll('stagiaires');
  
  // Filtrer par nom d'entreprise
  const entrepriseNomLower=entrepriseNom.toLowerCase();
  let stagiaires=allStagiaires.filter(s=>{
    const stagEntreprise=(s.entreprise||'').toLowerCase().trim();
    return stagEntreprise===entrepriseNomLower || 
           stagEntreprise.includes(entrepriseNomLower) || 
           entrepriseNomLower.includes(stagEntreprise);
  });
  
  if(stagiaires.length===0){
    listeDiv.innerHTML=`
      <div style="padding:20px;text-align:center;color:#999">
        <p>Aucun stagiaire trouv√© pour <strong>${esc(entrepriseNom)}</strong></p>
        <button class="btn btn-sm btn-success" onclick="ouvrirAjoutStagiaireConv()">‚ûï Ajouter un stagiaire</button>
      </div>`;
    updateConvStagiairesSelection();
    return;
  }
  
  // R√©cup√©rer les IDs d√©j√† s√©lectionn√©s
  const selectedIds=(document.getElementById('conv-stagiaires-ids').value||'').split(',').filter(id=>id);
  
  // Afficher les stagiaires avec checkboxes
  listeDiv.innerHTML=stagiaires.map(s=>{
    const checked=selectedIds.includes(String(s.id))?'checked':'';
    const civilite=s.civilite||'Mr.';
    const nom=s.nom||'';
    const prenom=s.prenom||'';
    const fonction=s.fonction||s.poste||'Employ√©';
    return `
      <label style="display:flex;align-items:center;padding:10px 15px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s" 
             onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background=''">
        <input type="checkbox" class="conv-stag-checkbox" value="${s.id}" 
               data-civilite="${esc(civilite)}" data-nom="${esc(nom)}" data-prenom="${esc(prenom)}" data-fonction="${esc(fonction)}"
               ${checked} onchange="updateConvStagiairesSelection()" style="width:18px;height:18px;margin-right:12px">
        <div style="flex:1">
          <strong>${esc(civilite)} ${esc(nom)} ${esc(prenom)}</strong>
          <span style="color:#666;font-size:0.9em"> - ${esc(fonction)}</span>
        </div>
      </label>`;
  }).join('');
  
  updateConvStagiairesSelection();
  toast(stagiaires.length+' stagiaire(s) trouv√©(s)','success');
}

// Mettre √† jour la s√©lection des stagiaires
function updateStagiairesSelection(){
  const checkboxes=document.querySelectorAll('.conv-stag-checkbox:checked');
  const ids=Array.from(checkboxes).map(cb=>cb.value);
  document.getElementById('conv-stagiaires-ids').value=ids.join(',');
  document.getElementById('conv-stagiaires-count').textContent=ids.length+' stagiaire(s) s√©lectionn√©(s)';
}

// Obtenir les stagiaires s√©lectionn√©s sous forme de texte pour le PDF
function getStagiairesSelectionnesTexte(){
  const checkboxes=document.querySelectorAll('.conv-stag-checkbox:checked');
  return Array.from(checkboxes).map(cb=>{
    return `${cb.dataset.civilite}, ${cb.dataset.nom}, ${cb.dataset.prenom}, ${cb.dataset.fonction}`;
  }).join('\n');
}

// Ouvrir modal ajout stagiaire
function ouvrirAjoutStagiaireConv(){
  document.getElementById('new-stag-nom').value='';
  document.getElementById('new-stag-prenom').value='';
  document.getElementById('new-stag-civilite').value='Mr.';
  document.getElementById('new-stag-fonction').value='Employ√©';
  document.getElementById('modal-ajout-stagiaire-conv').style.display='flex';
}

// Fermer modal
function fermerModalStagiaireConv(){
  document.getElementById('modal-ajout-stagiaire-conv').style.display='none';
}

// Ajouter un stagiaire manuellement
async function ajouterStagiaireConv(){
  const civilite=document.getElementById('new-stag-civilite').value;
  const nom=document.getElementById('new-stag-nom').value.trim();
  const prenom=document.getElementById('new-stag-prenom').value.trim();
  const fonction=document.getElementById('new-stag-fonction').value.trim();
  
  if(!nom){
    toast('Le nom est obligatoire','warning');
    return;
  }
  
  // R√©cup√©rer l'entreprise
  const entrepriseId=document.getElementById('conv-entreprise-select').value||null;
  const entrepriseNom=document.getElementById('conv-entreprise').value;
  
  // Sauvegarder le stagiaire en base
  const newStagiaire={
    civilite,
    nom,
    prenom,
    fonction,
    entrepriseId:entrepriseId?parseInt(entrepriseId):null,
    entreprise:entrepriseNom,
    dateCreation:new Date().toISOString()
  };
  
  const id=await dbAdd('stagiaires',newStagiaire);
  toast('Stagiaire ajout√©','success');
  fermerModalStagiaireConv();
  
  // Ajouter directement le stagiaire √† la liste affich√©e
  const listeDiv=document.getElementById('conv-stagiaires-liste');
  const currentContent=listeDiv.innerHTML;
  
  // Si le message "aucun stagiaire" est affich√©, le remplacer
  if(currentContent.includes('Aucun stagiaire') || currentContent.includes('pas li√© √† une session')){
    listeDiv.innerHTML='';
  }
  
  // Ajouter le nouveau stagiaire avec checkbox coch√©e
  const newLabel=document.createElement('label');
  newLabel.style.cssText='display:flex;align-items:center;padding:10px 15px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s';
  newLabel.onmouseover=function(){this.style.background='#f0f9ff';};
  newLabel.onmouseout=function(){this.style.background='';};
  newLabel.innerHTML=`
    <input type="checkbox" class="conv-stag-checkbox" value="${id}" 
           data-civilite="${esc(civilite)}" data-nom="${esc(nom)}" data-prenom="${esc(prenom)}" data-fonction="${esc(fonction)}"
           checked onchange="updateConvStagiairesSelection()" style="width:18px;height:18px;margin-right:12px">
    <div style="flex:1">
      <strong>${esc(civilite)} ${esc(nom)} ${esc(prenom)}</strong>
      <span style="color:#666;font-size:0.9em"> - ${esc(fonction)}</span>
    </div>`;
  listeDiv.appendChild(newLabel);
  
  updateConvStagiairesSelection();
}

async function onConvSelectDevis(){
  const devisId=document.getElementById('conv-devis').value;
  console.log('S√©lection devis ID:', devisId);
  if(!devisId)return;
  
  const devis=await dbGet('devis',parseInt(devisId));
  console.log('Devis r√©cup√©r√©:', devis);
  if(!devis){
    toast('Devis non trouv√©','error');
    return;
  }
  
  // Remplir les champs depuis le devis
  document.getElementById('conv-entreprise').value=devis.entreprise||'';
  document.getElementById('conv-adresse').value=devis.adresse||'';
  document.getElementById('conv-cp').value=devis.cp||'';
  document.getElementById('conv-ville').value=devis.ville||'';
  document.getElementById('conv-siret').value=devis.siret||'';
  document.getElementById('conv-representant').value=devis.contact||'';
  document.getElementById('conv-formation').value=devis.formation||'';
  document.getElementById('conv-nature').value=devis.modalite?devis.modalite+' pr√©sentiel':'INTRA pr√©sentiel';
  document.getElementById('conv-duree').value=devis.nbHeures||devis.duree||'';
  document.getElementById('conv-lieu').value=devis.lieu||'';
  document.getElementById('conv-dateDebut').value=devis.dateDebut||'';
  document.getElementById('conv-dateFin').value=devis.dateFin||'';
  document.getElementById('conv-horairesMatin').value=devis.horairesMatin||'9:00 √† 12:30';
  document.getElementById('conv-horairesAprem').value=devis.horairesAprem||'13:30 √† 17:00';
  document.getElementById('conv-prixHT').value=devis.montantHT||'';
  document.getElementById('conv-tva').value=devis.tva||20;
  document.getElementById('conv-quantite').value=1;
  
  toast('Devis charg√©: '+devis.entreprise,'info');
  
  // Charger les stagiaires depuis la session li√©e au devis
  await chargerStagiairesDepuisSession(devis);
}

// Charger les stagiaires depuis la session li√©e au devis
async function chargerStagiairesDepuisSession(devis){
  const listeDiv=document.getElementById('conv-stagiaires-liste');
  
  console.log('=== CHARGEMENT STAGIAIRES DEPUIS SESSION ===');
  console.log('Session ID du devis:', devis.sessionId);
  
  // V√©rifier si le devis a une session associ√©e
  if(!devis.sessionId){
    listeDiv.innerHTML=`
      <div style="padding:20px;text-align:center;color:#666">
        <p style="font-size:1.1em;margin-bottom:10px">‚ö†Ô∏è Ce devis n'est pas li√© √† une session</p>
        <div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:12px;margin:10px 0;text-align:left">
          <p style="margin-bottom:8px"><strong>üí° Pour avoir des stagiaires :</strong></p>
          <ol style="margin:0;padding-left:20px;font-size:0.9em">
            <li>Cr√©ez d'abord une <strong>üìÖ Session</strong> avec des stagiaires</li>
            <li>Puis cr√©ez un <strong>üí∞ Devis</strong> depuis cette session</li>
            <li>La convention pourra alors r√©cup√©rer les stagiaires automatiquement</li>
          </ol>
        </div>
        <p style="margin-top:15px">Ou ajoutez des stagiaires manuellement :</p>
        <button class="btn btn-success" style="margin-top:10px" onclick="ouvrirAjoutStagiaireConv()">‚ûï Ajouter un stagiaire</button>
      </div>`;
    updateConvStagiairesSelection();
    return;
  }
  
  // R√©cup√©rer la session
  const session=await dbGet('sessions',parseInt(devis.sessionId));
  console.log('Session r√©cup√©r√©e:', session);
  
  if(!session){
    listeDiv.innerHTML=`
      <div style="padding:20px;text-align:center;color:#999">
        <p>Session non trouv√©e (ID: ${devis.sessionId})</p>
        <button class="btn btn-sm btn-success" onclick="ouvrirAjoutStagiaireConv()">‚ûï Ajouter un stagiaire</button>
      </div>`;
    updateConvStagiairesSelection();
    return;
  }
  
  // R√©cup√©rer les IDs des stagiaires de la session
  const stagiairesIds=(session.stagiaires||'').split(',').filter(id=>id.trim());
  console.log('IDs stagiaires de la session:', stagiairesIds);
  
  if(stagiairesIds.length===0){
    listeDiv.innerHTML=`
      <div style="padding:20px;text-align:center;color:#666">
        <p style="font-size:1.1em;margin-bottom:10px">‚ö†Ô∏è Aucun stagiaire dans la session</p>
        <p style="font-size:0.9em">La session <strong>${esc(session.reference||'')}</strong> n'a pas de stagiaires inscrits.</p>
        <button class="btn btn-success" style="margin-top:15px" onclick="ouvrirAjoutStagiaireConv()">‚ûï Ajouter un stagiaire</button>
      </div>`;
    updateConvStagiairesSelection();
    return;
  }
  
  // R√©cup√©rer les donn√©es compl√®tes des stagiaires
  const stagiaires=[];
  for(const id of stagiairesIds){
    const stag=await dbGet('stagiaires',parseInt(id));
    if(stag) stagiaires.push(stag);
  }
  
  console.log('Stagiaires charg√©s:', stagiaires);
  
  if(stagiaires.length===0){
    listeDiv.innerHTML=`
      <div style="padding:20px;text-align:center;color:#999">
        <p>Stagiaires de la session introuvables</p>
        <button class="btn btn-sm btn-success" onclick="ouvrirAjoutStagiaireConv()">‚ûï Ajouter un stagiaire</button>
      </div>`;
    updateConvStagiairesSelection();
    return;
  }
  
  // R√©cup√©rer les IDs d√©j√† s√©lectionn√©s
  const selectedIds=(document.getElementById('conv-stagiaires-ids').value||'').split(',').filter(id=>id);
  
  // Afficher les stagiaires avec checkboxes - tous coch√©s par d√©faut
  listeDiv.innerHTML=stagiaires.map(s=>{
    const checked=selectedIds.length>0?selectedIds.includes(String(s.id))?'checked':'':'checked'; // Coch√© par d√©faut si pas de s√©lection existante
    const civilite=s.civilite||'Mr.';
    const nom=s.nom||'';
    const prenom=s.prenom||'';
    const fonction=s.fonction||s.poste||'Employ√©';
    return `
      <label style="display:flex;align-items:center;padding:10px 15px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s" 
             onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background=''">
        <input type="checkbox" class="conv-stag-checkbox" value="${s.id}" 
               data-civilite="${esc(civilite)}" data-nom="${esc(nom)}" data-prenom="${esc(prenom)}" data-fonction="${esc(fonction)}"
               ${checked} onchange="updateConvStagiairesSelection()" style="width:18px;height:18px;margin-right:12px">
        <div style="flex:1">
          <strong>${esc(civilite)} ${esc(nom)} ${esc(prenom)}</strong>
          <span style="color:#666;font-size:0.9em"> - ${esc(fonction)}</span>
        </div>
      </label>`;
  }).join('');
  
  updateConvStagiairesSelection();
  toast(stagiaires.length+' stagiaire(s) charg√©(s) depuis la session','success');
}

// Mettre √† jour la s√©lection des stagiaires (convention)
function updateConvStagiairesSelection(){
  const checkboxes=document.querySelectorAll('.conv-stag-checkbox:checked');
  const ids=Array.from(checkboxes).map(cb=>cb.value);
  document.getElementById('conv-stagiaires-ids').value=ids.join(',');
  document.getElementById('conv-stagiaires-count').textContent=ids.length+' stagiaire(s) s√©lectionn√©(s)';
}

function reinitialiserFormulaireConvention(){
  document.getElementById('conv-numero').value='';
  document.getElementById('conv-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('conv-devis').value='';
  document.getElementById('conv-entreprise-select').value='';
  document.getElementById('conv-entreprise').value='';
  document.getElementById('conv-adresse').value='';
  document.getElementById('conv-cp').value='';
  document.getElementById('conv-ville').value='';
  document.getElementById('conv-siret').value='';
  document.getElementById('conv-representant').value='';
  document.getElementById('conv-fonction').value='G√©rant';
  document.getElementById('conv-formation').value='';
  document.getElementById('conv-nature').value='INTRA pr√©sentiel';
  document.getElementById('conv-type').value='Action de formation';
  document.getElementById('conv-duree').value='';
  document.getElementById('conv-lieu').value='';
  document.getElementById('conv-dateDebut').value='';
  document.getElementById('conv-dateFin').value='';
  document.getElementById('conv-horairesMatin').value='9:00 √† 12:30';
  document.getElementById('conv-horairesAprem').value='13:30 √† 17:00';
  // R√©initialiser zone stagiaires
  document.getElementById('conv-stagiaires-ids').value='';
  document.getElementById('conv-stagiaires-liste').innerHTML=`
    <div style="padding:20px;text-align:center;color:#999">
      <p>S√©lectionnez une entreprise puis cliquez sur "üîÑ Charger stagiaires"</p>
      <p style="font-size:0.85em">ou ajoutez des stagiaires manuellement</p>
    </div>`;
  document.getElementById('conv-stagiaires-count').textContent='0 stagiaire(s) s√©lectionn√©(s)';
  document.getElementById('conv-prixHT').value='';
  document.getElementById('conv-tva').value=20;
  document.getElementById('conv-quantite').value=1;
  document.getElementById('conv-lieuSignature').value='Le Kremlin Bic√™tre';
  document.getElementById('conv-statut').value='Brouillon';
}

async function ouvrirNouvelleConvention(){
  editConventionId=null;
  await chargerSelectsConvention();
  reinitialiserFormulaireConvention();
  
  // G√©n√©rer le num√©ro de convention
  const annee=new Date().getFullYear().toString().slice(-2);
  const count=conventionsData.filter(c=>c.numero&&c.numero.includes('-'+annee+'-')).length+1;
  document.getElementById('conv-numero').value=`DC-${annee}-${String(count).padStart(4,'0')}`;
  document.getElementById('conv-date').value=new Date().toISOString().split('T')[0];
  
  document.getElementById('titre-convention-travail').textContent='üìë Nouvelle Convention';
  document.getElementById('zone-convention-travail').style.display='block';
  document.getElementById('zone-convention-travail').scrollIntoView({behavior:'smooth'});
}

async function ouvrirCreerConventionDepuisDevis(){
  await ouvrirNouvelleConvention();
  toast('S√©lectionnez un devis pour pr√©-remplir la convention','info');
}

async function ouvrirModifierConvention(id){
  const conv=await dbGet('conventions',id);
  if(!conv){toast('Convention non trouv√©e','error');return;}
  
  editConventionId=id;
  await chargerSelectsConvention();
  
  document.getElementById('conv-numero').value=conv.numero||'';
  document.getElementById('conv-date').value=conv.date||'';
  document.getElementById('conv-devis').value=conv.devisId||'';
  document.getElementById('conv-entreprise-select').value=conv.entrepriseId||'';
  document.getElementById('conv-entreprise').value=conv.entreprise||'';
  document.getElementById('conv-adresse').value=conv.adresse||'';
  document.getElementById('conv-cp').value=conv.cp||'';
  document.getElementById('conv-ville').value=conv.ville||'';
  document.getElementById('conv-siret').value=conv.siret||'';
  document.getElementById('conv-representant').value=conv.representant||'';
  document.getElementById('conv-fonction').value=conv.fonction||'G√©rant';
  document.getElementById('conv-formation').value=conv.formation||'';
  document.getElementById('conv-nature').value=conv.nature||'INTRA pr√©sentiel';
  document.getElementById('conv-type').value=conv.type||'Action de formation';
  document.getElementById('conv-duree').value=conv.duree||'';
  document.getElementById('conv-lieu').value=conv.lieu||'';
  document.getElementById('conv-dateDebut').value=conv.dateDebut||'';
  document.getElementById('conv-dateFin').value=conv.dateFin||'';
  document.getElementById('conv-horairesMatin').value=conv.horairesMatin||'9:00 √† 12:30';
  document.getElementById('conv-horairesAprem').value=conv.horairesAprem||'13:30 √† 17:00';
  // Stocker les IDs des stagiaires pour les cocher apr√®s chargement
  document.getElementById('conv-stagiaires-ids').value=conv.stagiairesIds||'';
  document.getElementById('conv-prixHT').value=conv.prixHT||'';
  document.getElementById('conv-tva').value=conv.tva||20;
  document.getElementById('conv-quantite').value=conv.quantite||1;
  document.getElementById('conv-lieuSignature').value=conv.lieuSignature||'Le Kremlin Bic√™tre';
  document.getElementById('conv-statut').value=conv.statut||'Brouillon';
  
  // Charger les stagiaires enregistr√©s dans la convention
  await chargerStagiairesConventionExistante(conv);
  
  document.getElementById('titre-convention-travail').textContent='üìë Modifier Convention '+conv.numero;
  document.getElementById('zone-convention-travail').style.display='block';
  document.getElementById('zone-convention-travail').scrollIntoView({behavior:'smooth'});
}

// Charger les stagiaires d'une convention existante
async function chargerStagiairesConventionExistante(conv){
  const listeDiv=document.getElementById('conv-stagiaires-liste');
  const stagiairesIds=(conv.stagiairesIds||'').split(',').filter(id=>id.trim());
  
  if(stagiairesIds.length===0){
    listeDiv.innerHTML=`
      <div style="padding:20px;text-align:center;color:#999">
        <p>Aucun stagiaire enregistr√© pour cette convention</p>
        <button class="btn btn-sm btn-success" onclick="ouvrirAjoutStagiaireConv()">‚ûï Ajouter un stagiaire</button>
      </div>`;
    updateConvStagiairesSelection();
    return;
  }
  
  // R√©cup√©rer les donn√©es des stagiaires
  const stagiaires=[];
  for(const id of stagiairesIds){
    const stag=await dbGet('stagiaires',parseInt(id));
    if(stag) stagiaires.push(stag);
  }
  
  if(stagiaires.length===0){
    listeDiv.innerHTML=`
      <div style="padding:20px;text-align:center;color:#999">
        <p>Stagiaires introuvables</p>
        <button class="btn btn-sm btn-success" onclick="ouvrirAjoutStagiaireConv()">‚ûï Ajouter un stagiaire</button>
      </div>`;
    updateConvStagiairesSelection();
    return;
  }
  
  // Afficher les stagiaires avec checkboxes (tous coch√©s car d√©j√† enregistr√©s)
  listeDiv.innerHTML=stagiaires.map(s=>{
    const civilite=s.civilite||'Mr.';
    const nom=s.nom||'';
    const prenom=s.prenom||'';
    const fonction=s.fonction||s.poste||'Employ√©';
    return `
      <label style="display:flex;align-items:center;padding:10px 15px;border-bottom:1px solid #eee;cursor:pointer;transition:background 0.2s" 
             onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background=''">
        <input type="checkbox" class="conv-stag-checkbox" value="${s.id}" 
               data-civilite="${esc(civilite)}" data-nom="${esc(nom)}" data-prenom="${esc(prenom)}" data-fonction="${esc(fonction)}"
               checked onchange="updateConvStagiairesSelection()" style="width:18px;height:18px;margin-right:12px">
        <div style="flex:1">
          <strong>${esc(civilite)} ${esc(nom)} ${esc(prenom)}</strong>
          <span style="color:#666;font-size:0.9em"> - ${esc(fonction)}</span>
        </div>
      </label>`;
  }).join('');
  
  updateConvStagiairesSelection();
}

function fermerZoneConvention(){
  document.getElementById('zone-convention-travail').style.display='none';
  editConventionId=null;
}

function getConventionDataFromForm(){
  return {
    numero:document.getElementById('conv-numero').value,
    date:document.getElementById('conv-date').value,
    devisId:document.getElementById('conv-devis').value,
    entrepriseId:document.getElementById('conv-entreprise-select').value||null,
    entreprise:document.getElementById('conv-entreprise').value,
    adresse:document.getElementById('conv-adresse').value,
    cp:document.getElementById('conv-cp').value,
    ville:document.getElementById('conv-ville').value,
    siret:document.getElementById('conv-siret').value,
    representant:document.getElementById('conv-representant').value,
    fonction:document.getElementById('conv-fonction').value,
    formation:document.getElementById('conv-formation').value,
    nature:document.getElementById('conv-nature').value,
    type:document.getElementById('conv-type').value,
    duree:parseInt(document.getElementById('conv-duree').value)||0,
    lieu:document.getElementById('conv-lieu').value,
    dateDebut:document.getElementById('conv-dateDebut').value,
    dateFin:document.getElementById('conv-dateFin').value,
    horairesMatin:document.getElementById('conv-horairesMatin').value,
    horairesAprem:document.getElementById('conv-horairesAprem').value,
    stagiaires:getStagiairesSelectionnesTexte(),
    stagiairesIds:document.getElementById('conv-stagiaires-ids').value,
    prixHT:parseFloat(document.getElementById('conv-prixHT').value)||0,
    tva:parseFloat(document.getElementById('conv-tva').value)||20,
    quantite:parseInt(document.getElementById('conv-quantite').value)||1,
    lieuSignature:document.getElementById('conv-lieuSignature').value,
    statut:document.getElementById('conv-statut').value
  };
}

async function sauvegarderConvention(){
  const data=getConventionDataFromForm();
  
  if(!data.numero||!data.entreprise||!data.formation){
    toast('Veuillez remplir les champs obligatoires','warning');
    return;
  }
  
  data.updatedAt=new Date().toISOString();
  
  if(editConventionId){
    data.id=editConventionId;
    await dbPut('conventions',data);
    toast('Convention mise √† jour','success');
  }else{
    data.createdAt=new Date().toISOString();
    await dbAdd('conventions',data);
    toast('Convention cr√©√©e','success');
  }
  
  fermerZoneConvention();
  await loadConventions();
}

async function genererPDFConvention(){
  const data=getConventionDataFromForm();
  genererPDFConventionDocument(data);
}

async function genererPDFConventionById(id){
  const conv=await dbGet('conventions',id);
  if(!conv){toast('Convention non trouv√©e','error');return;}
  genererPDFConventionDocument(conv);
}

function genererPDFConventionDocument(data){
  try{
  const prixHT=parseFloat(data.prixHT)||0;
  const tva=parseFloat(data.tva)||20;
  const quantite=parseInt(data.quantite)||1;
  const totalHT=prixHT*quantite;
  const tvaAmount=totalHT*tva/100;
  const ttc=totalHT+tvaAmount;
  const duree=parseInt(data.duree)||0;
  
  const escHtml=(s)=>s?String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])):'';
  
  const formatDateFr=(d)=>{
    if(!d)return '';
    const date=new Date(d);
    if(isNaN(date.getTime()))return d;
    return date.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric'});
  };
  
  const formatDateLong=(d)=>{
    if(!d)return '';
    const date=new Date(d);
    if(isNaN(date.getTime()))return d;
    const options={day:'numeric',month:'long',year:'numeric'};
    return date.toLocaleDateString('fr-FR',options);
  };
  
  const formatEUR=(n)=>(parseFloat(n)||0).toFixed(2).replace('.',',')+' EUR';
  
  // Parser les stagiaires
  const stagiairesLines=(data.stagiaires||'').split('\n').filter(l=>l.trim());
  const stagiairesHtml=stagiairesLines.map(line=>{
    const parts=line.split(',').map(p=>p.trim());
    return `<tr>
      <td>${escHtml(parts[0]||'')}</td>
      <td>${escHtml(parts[1]||'')}</td>
      <td>${escHtml(parts[2]||'')}</td>
      <td>${escHtml(parts[3]||'')}</td>
    </tr>`;
  }).join('')||'<tr><td colspan="4" style="text-align:center;color:#999">Aucun stagiaire renseigne</td></tr>';
  
  const htmlContent=`<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Convention ${escHtml(data.numero||'')}</title>
<style>
@page{size:A4;margin:8mm}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;font-size:7.5pt;line-height:1.3;color:#333;padding:10px}

/* HEADER */
.header{margin-bottom:12px}
.logo{font-size:20pt;font-weight:bold;margin-bottom:2px}
.logo-d{color:#ea580c}
.logo-es{color:#2563eb}
.logo-sub{font-size:9pt;color:#ea580c}

/* TITRE */
.titre-convention{text-align:center;margin:15px 0}
.titre-convention h1{font-size:12pt;color:#2563eb;margin-bottom:3px}
.titre-convention .ref{font-size:7.5pt;color:#666}

/* PARTIES */
.parties{margin:10px 0;font-size:7.5pt}
.parties-titre{font-weight:bold;color:#2563eb;margin-bottom:6px}
.partie{margin:6px 0;line-height:1.4}
.partie-num{font-weight:bold}

/* ARTICLES */
.article{margin:10px 0}
.article-titre{font-weight:bold;color:#2563eb;margin-bottom:5px;font-size:8pt}
.article-contenu{margin-left:5px;font-size:7.5pt}
.article-liste{margin:5px 0 5px 12px}
.article-liste li{margin:2px 0}
.article-liste li strong{color:#2563eb}

/* TABLEAU STAGIAIRES */
table.stagiaires{width:100%;border-collapse:collapse;margin:8px 0}
table.stagiaires th{background:#2563eb;color:#fff;padding:4px 6px;text-align:left;font-size:7pt}
table.stagiaires td{padding:4px 6px;border:1px solid #ddd;font-size:7pt}
table.stagiaires tr:nth-child(even){background:#f9f9f9}

/* TABLEAU FINANCIER */
table.financier{width:100%;border-collapse:collapse;margin:8px 0}
table.financier th{background:#2563eb;color:#fff;padding:4px 6px;text-align:center;font-size:7pt}
table.financier td{padding:4px 6px;border:1px solid #ddd;text-align:center;font-size:7pt}
table.financier .total{background:#f0f0f0;font-weight:bold}

/* SIGNATURES */
.signatures{display:table;width:100%;margin-top:20px}
.signature-box{display:table-cell;width:50%;padding:8px;vertical-align:top}
.signature-titre{font-weight:bold;margin-bottom:3px;font-size:7.5pt}
.signature-nom{color:#2563eb;margin-bottom:3px;font-size:7.5pt}
.signature-zone{height:50px;border-bottom:1px solid #ccc;margin-top:6px}
.signature-label{font-size:6.5pt;color:#666}

/* FOOTER */
.footer{margin-top:15px;padding-top:8px;border-top:1px solid #ccc;font-size:6.5pt;color:#666;text-align:center;line-height:1.3}
</style>
</head>
<body>

<!-- HEADER LOGO -->
<div class="header">
  <div class="logo"><span class="logo-d">D</span><span class="logo-es">esClick</span></div>
  <div class="logo-sub">Formation</div>
</div>

<!-- TITRE -->
<div class="titre-convention">
  <h1>CONVENTION DE FORMATION PROFESSIONNELLE N¬∞ ${escHtml(data.numero||'')}</h1>
  <div class="ref">(Article L.6353-1 du Code du travail)</div>
</div>

<!-- PARTIES -->
<div class="parties">
  <div class="parties-titre">Entre les soussignes :</div>
  
  <div class="partie">
    <span class="partie-num">1</span> la societe <strong>DC WEB APS</strong> domiciliee au 3, rue Lech Walesa 94270 - Le Kremlin-Bicetre et enregistree sous le numero de declaration d'activite <strong>11 94 101 81 94</strong> aupres de la Direction Regionale des Entreprises, de la Concurrence, de la Consommation, du Travail et de l'Emploi en Ile de France (DIRECCTE Ile de France).
  </div>
  
  <div class="partie">
    <span class="partie-num">2</span> La societe <strong>${escHtml(data.entreprise||'')}</strong> domiciliee ${escHtml(data.adresse||'')} ${escHtml(data.cp||'')} ${escHtml(data.ville||'')}
    ${data.siret?'<br>immatriculee au Registre du Commerce et des Societes sous le numero <strong>'+escHtml(data.siret)+'</strong>':''}
    ${data.representant?' representee par son '+escHtml(data.fonction||'gerant')+' : <strong>'+escHtml(data.representant)+'</strong>.':''}
  </div>
  
  <p style="margin-top:15px">Est conclue la convention suivante, en application des dispositions du Livre III de la Sixieme partie du Code du travail portant organisation de la formation professionnelle continue.</p>
</div>

<!-- ARTICLE 1 -->
<div class="article">
  <div class="article-titre">Article 1er : Objet de la convention</div>
  <div class="article-contenu">
    <p>L'organisme DC WEB APS organisera l'action de formation suivante :</p>
    <ul class="article-liste">
      <li>Intitule du stage: <strong>${escHtml(data.formation||'')}</strong></li>
      <li>Nature de l'action : <strong>${escHtml(data.nature||'INTRA presentiel')}</strong></li>
      <li>Objectifs operationnels : joints en annexe</li>
      <li>Programme et methodes : joints en annexe</li>
      <li>Type d'action de formation (article L.6313-1 du Code du travail): ${escHtml(data.type||'Action de formation')}</li>
      <li>Duree : <strong>${duree} heures</strong></li>
      <li>Lieu: ${escHtml(data.lieu||data.entreprise+' - '+data.adresse+' '+data.cp+' '+data.ville)}</li>
      <li>Dates et horaires : du <strong>${formatDateFr(data.dateDebut)}</strong> au <strong>${formatDateFr(data.dateFin)}</strong> de ${escHtml(data.horairesMatin||'9:00 a 12:30')} et de ${escHtml(data.horairesAprem||'13:30 a 17:00')}</li>
    </ul>
  </div>
</div>

<!-- ARTICLE 2 -->
<div class="article">
  <div class="article-titre">Article 2 : Effectif forme</div>
  <div class="article-contenu">
    <p>L'organisme DC WEB APS animera une/des sessions de formation pour les personnes suivantes :</p>
    <table class="stagiaires">
      <thead>
        <tr><th>Civilite</th><th>Nom</th><th>Prenom</th><th>Fonction</th></tr>
      </thead>
      <tbody>
        ${stagiairesHtml}
      </tbody>
    </table>
  </div>
</div>

<!-- ARTICLE 3 -->
<div class="article">
  <div class="article-titre">Article 3 : Dispositions financieres</div>
  <div class="article-contenu">
    <p>En contrepartie de cette action de formation, l'employeur s'acquittera des couts suivants :</p>
    <table class="financier">
      <thead>
        <tr><th>Quantite</th><th>Prix</th><th>Cout Total H.T</th><th>T.V.A ${tva}%</th><th>TOTAL GENERAL (TTC)</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>${quantite}</td>
          <td>${formatEUR(prixHT)}</td>
          <td>${formatEUR(totalHT)}</td>
          <td>${formatEUR(tvaAmount)}</td>
          <td class="total">${formatEUR(ttc)}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ARTICLE 4 -->
<div class="article">
  <div class="article-titre">Article 4 : Modalites d'evaluation et de sanction</div>
  <div class="article-contenu">
    <p>Le controle des connaissances sera assure par la verification de l'assiduite des participants et l'accent mis sur leur participation constante et active, notamment dans le cadre d'etudes des cas pratiques.</p>
    <p style="margin-top:5px">Une attestation sera remise aux beneficiaires a l'issue de la formation.</p>
  </div>
</div>

<!-- ARTICLE 5 -->
<div class="article">
  <div class="article-titre">Article 5 : Modalites de reglement</div>
  <div class="article-contenu">
    <p>En cas de paiement par un OPCO, l'Etablissement s'engage a effectuer la demande de prise en charge avant le debut de la formation. En cas de prise en charge partielle, la difference sera a la charge de <strong>${escHtml(data.entreprise||'')}</strong>. En cas de refus ou d'absence d'accord au 1er jour, la totalite des frais sera facturee a l'entreprise.</p>
  </div>
</div>

<!-- ARTICLE 6 -->
<div class="article">
  <div class="article-titre">Article 6 : Dedit ou abandon</div>
  <div class="article-contenu">
    <p>En cas de dedit par l'entreprise a moins de 15 jours francs avant le debut de l'action mentionnee a l'article 1, ou d'abandon en cours de formation par un ou plusieurs stagiaires, l'organisme remboursera sur le cout total, les sommes qu'il n'aura pas reellement depensees ou engagees pour la realisation de ladite action.</p>
  </div>
</div>

<!-- ARTICLE 7 -->
<div class="article">
  <div class="article-titre">Article 7 : Differends eventuels</div>
  <div class="article-contenu">
    <p>Si une contestation ou un differend ne peuvent etre regles a l'amiable, le Tribunal de Creteil sera seul competent pour regler le litige.</p>
  </div>
</div>

<!-- DATE ET LIEU -->
<p style="margin-top:15px;font-size:7.5pt">Fait en double exemplaire, a <strong>${escHtml(data.lieuSignature||'Le Kremlin Bicetre')}</strong>, le <strong>${formatDateLong(data.date)}</strong></p>

<!-- SIGNATURES -->
<div class="signatures">
  <div class="signature-box">
    <div class="signature-titre">SAS - DC WEB APS</div>
    <div class="signature-nom">DJABER Faouzi,</div>
    <div>Representant legal de DC WEB APS</div>
    <div class="signature-zone"></div>
  </div>
  <div class="signature-box">
    <div class="signature-label">Acceptation - Date</div>
    <div class="signature-zone"></div>
    <div class="signature-label">Signature du demandeur</div>
  </div>
</div>

<!-- FOOTER -->
<div class="footer">
  <strong>SAS - DC WEB APS</strong><br>
  3, Rue Lech Walesa - 94270 Le Kremlin-Bicetre<br>
  Numero SIRET : 81274844000037<br>
  Numero de declaration d'activite : 11 94 10181 94 (aupres du prefet de region de l'ile de France) - ID Data dock : 0080818
</div>

</body>
</html>`;
  
  const printWindow=window.open('','_blank','width=800,height=600');
  if(!printWindow){
    toast('Popup bloque! Autorisez les popups pour ce site.','error');
    return;
  }
  printWindow.document.write(htmlContent);
  printWindow.document.close();
  setTimeout(()=>{printWindow.print();},500);
  toast('PDF Convention genere','success');
  }catch(e){
    console.error('Erreur genererPDFConventionDocument:',e);
    if(typeof showErrorCopiable==='function'){
      showErrorCopiable('Erreur genererPDFConventionDocument',e);
    }else{
      toast('Erreur: '+e.message,'error');
    }
  }
}

// ============ ANALYSE - FORMULAIRE MODAL (ancien - conserv√© pour compatibilit√©) ============
async function onAnalyseOpportuniteChange(){
  const oppId=document.getElementById('f-opportunite')?.value;
  
  if(oppId){
    const opp=await dbGet('opportunites',parseInt(oppId));
    if(opp){
      const ent=opp.entreprise?await dbGet('entreprises',parseInt(opp.entreprise)):null;
      
      // Pr√©-remplir les champs du formulaire depuis l'opportunit√©/entreprise
      if(ent){
        const contact=(ent.contact||'').split(' ');
        document.getElementById('f-clientNom').value=contact[0]||'';
        document.getElementById('f-clientPrenom').value=contact.slice(1).join(' ')||'';
        document.getElementById('f-clientAdresse').value=ent.adresse||'';
        document.getElementById('f-clientCP').value=ent.codePostal||'';
        document.getElementById('f-clientVille').value=ent.ville||opp.ville||'';
        document.getElementById('f-clientEmail').value=ent.emailContact||ent.emailPro||'';
        document.getElementById('f-clientTel').value=ent.mobileContact||'';
        document.getElementById('f-clientEntreprise').value=ent.nom||'';
        document.getElementById('f-clientSiret').value=ent.siret||'';
        document.getElementById('f-nbSalaries').value=ent.nbSalaries||'';
      }
    }
  }
}

function ouvrirImportGoogleSheets(){
  document.getElementById('import-sheets-data').value='';
  document.getElementById('import-preview').style.display='none';
  document.getElementById('modal-import-sheets').classList.add('active');
}

function closeImportSheets(){
  document.getElementById('modal-import-sheets').classList.remove('active');
}

// Mapping des colonnes Google Sheets vers les champs du formulaire
const SHEETS_MAPPING={
  0:'horodateur',
  1:'clientEmail',
  2:'clientNom',
  3:'clientAdresse',
  4:'clientCP',
  5:'clientVille',
  6:'clientTel',
  7:'clientEntreprise',
  8:'clientSiret',
  9:'situationHandicap',
  10:'autresBesoinsIdentifies',
  11:'nbSalaries',
  12:'besoinDate',
  13:'besoinGeneral',
  14:'prerequis',
  15:'objectifsClient',
  16:'modalitesFormation',
  17:'autresBesoins',
  18:'formationTexte'
};

function previsualiserImport(){
  const data=document.getElementById('import-sheets-data').value;
  if(!data.trim()){
    toast('Veuillez coller des donn√©es','warning');
    return;
  }
  
  const cols=data.split('\t');
  const preview=document.getElementById('import-preview-content');
  
  let html='<table style="width:100%;font-size:.7rem;border-collapse:collapse">';
  html+='<tr style="background:var(--gray-200)"><th style="padding:4px;border:1px solid var(--gray-300)">Champ</th><th style="padding:4px;border:1px solid var(--gray-300)">Valeur</th></tr>';
  
  const labels={
    horodateur:'Horodateur',
    clientEmail:'Email',
    clientNom:'Nom - Pr√©nom',
    clientAdresse:'Adresse',
    clientCP:'Code Postal',
    clientVille:'Ville',
    clientTel:'T√©l√©phone',
    clientEntreprise:'Entreprise',
    clientSiret:'SIRET',
    situationHandicap:'Situation handicap',
    autresBesoinsIdentifies:'Autres besoins identifi√©s',
    nbSalaries:'Nb salari√©s',
    besoinDate:'Besoin date',
    besoinGeneral:'Besoin g√©n√©ral',
    prerequis:'Pr√©requis',
    objectifsClient:'Objectifs client',
    modalitesFormation:'Modalit√©s',
    autresBesoins:'Autres besoins',
    formationTexte:'Formation'
  };
  
  Object.entries(SHEETS_MAPPING).forEach(([idx,field])=>{
    const val=cols[parseInt(idx)]||'';
    if(val){
      html+=`<tr><td style="padding:4px;border:1px solid var(--gray-300);font-weight:bold">${labels[field]||field}</td><td style="padding:4px;border:1px solid var(--gray-300)">${esc(val.substring(0,100))}${val.length>100?'...':''}</td></tr>`;
    }
  });
  html+='</table>';
  
  preview.innerHTML=html;
  document.getElementById('import-preview').style.display='block';
}

function appliquerImport(){
  const data=document.getElementById('import-sheets-data').value;
  if(!data.trim()){
    toast('Veuillez coller des donn√©es','warning');
    return;
  }
  
  const cols=data.split('\t');
  
  // Appliquer les valeurs aux champs du formulaire
  Object.entries(SHEETS_MAPPING).forEach(([idx,field])=>{
    const val=(cols[parseInt(idx)]||'').trim();
    const el=document.getElementById('f-'+field);
    if(el&&val){
      if(el.tagName==='SELECT'){
        // Chercher l'option correspondante
        const opts=Array.from(el.options);
        const match=opts.find(o=>o.value.toLowerCase()===val.toLowerCase()||o.text.toLowerCase()===val.toLowerCase());
        if(match)el.value=match.value;
        else if(val.toLowerCase().includes('oui'))el.value='OUI';
        else if(val.toLowerCase().includes('non'))el.value='NON';
      }else{
        el.value=val;
      }
    }
  });
  
  // Extraire nom et pr√©nom si format "NOM Pr√©nom"
  const nomPrenom=cols[2]||'';
  if(nomPrenom){
    const parts=nomPrenom.trim().split(' ');
    if(parts.length>=2){
      document.getElementById('f-clientNom').value=parts[0];
      document.getElementById('f-clientPrenom').value=parts.slice(1).join(' ');
    }else{
      document.getElementById('f-clientNom').value=nomPrenom;
    }
  }
  
  closeImportSheets();
  toast('Donn√©es import√©es avec succ√®s','success');
}

async function genererPDFAnalyse(){
  // R√©cup√©rer toutes les valeurs du formulaire
  const data={
    date:document.getElementById('f-dateAnalyse')?.value||new Date().toISOString().split('T')[0],
    nom:document.getElementById('f-clientNom')?.value||'',
    prenom:document.getElementById('f-clientPrenom')?.value||'',
    adresse:document.getElementById('f-clientAdresse')?.value||'',
    cp:document.getElementById('f-clientCP')?.value||'',
    ville:document.getElementById('f-clientVille')?.value||'',
    email:document.getElementById('f-clientEmail')?.value||'',
    tel:document.getElementById('f-clientTel')?.value||'',
    entreprise:document.getElementById('f-clientEntreprise')?.value||'',
    siret:document.getElementById('f-clientSiret')?.value||'',
    handicap:document.getElementById('f-situationHandicap')?.value||'NON',
    autresBesoinsIdentifies:document.getElementById('f-autresBesoinsIdentifies')?.value||'NON',
    nbSalaries:document.getElementById('f-nbSalaries')?.value||'',
    besoinDate:document.getElementById('f-besoinDate')?.value||'',
    besoinGeneral:document.getElementById('f-besoinGeneral')?.value||'',
    prerequis:document.getElementById('f-prerequis')?.value||'Voir le programme de formation',
    objectifsClient:document.getElementById('f-objectifsClient')?.value||'',
    modalites:document.getElementById('f-modalitesFormation')?.value||'',
    autresBesoins:document.getElementById('f-autresBesoins')?.value||'NON',
    formation:document.getElementById('f-formationTexte')?.value||'',
    synthese:document.getElementById('f-synthese')?.value||''
  };
  
  // Cr√©er le contenu HTML du PDF
  const htmlContent=`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Fiche Evaluation Besoin Client</title>
  <style>
    @page{size:A4;margin:15mm}
    body{font-family:Arial,sans-serif;font-size:11pt;line-height:1.4;color:#333}
    .header{text-align:center;margin-bottom:20px}
    .logo{color:#0066cc;font-size:24pt;font-weight:bold}
    .logo span{color:#ff6600}
    .subtitle{color:#ff6600;font-size:10pt}
    .title{text-align:center;font-size:14pt;font-weight:bold;text-decoration:underline;margin:20px 0}
    table{width:100%;border-collapse:collapse;margin-bottom:15px}
    td{padding:8px;border:1px solid #333;vertical-align:top}
    .label{font-weight:normal}
    .value{font-weight:bold}
    .section-title{background:#f5a623;color:#fff;padding:8px;font-weight:bold;border:1px solid #333}
    .section-blue{background:#4a90d9;color:#fff;padding:8px;font-weight:bold;border:1px solid #333}
    .orange{color:#f5a623}
    .blue{color:#0066cc}
  </style>
</head>
<body>
  <div class="header">
    <div class="logo"><span>D</span>esClick</div>
    <div class="subtitle">Formation</div>
  </div>
  
  <div class="title">FICHE EVALUATION BESOIN CLIENT</div>
  
  <table>
    <tr>
      <td colspan="2" class="label">Nom - Pr√©nom : <span class="value">${esc(data.nom)} ${esc(data.prenom)}</span></td>
      <td class="label">Date : <span class="value">${fmtDate(data.date)}</span></td>
    </tr>
    <tr>
      <td colspan="3" class="label">Adresse : <span class="value">${esc(data.adresse)}</span></td>
    </tr>
    <tr>
      <td class="label">Code Postal : <span class="value">${esc(data.cp)}</span></td>
      <td colspan="2" class="label">Ville : <span class="value">${esc(data.ville)}</span></td>
    </tr>
    <tr>
      <td colspan="2" class="label">Email : <span class="value blue">${esc(data.email)}</span></td>
      <td class="label">T√©l√©phone : <span class="value">${esc(data.tel)}</span></td>
    </tr>
    <tr>
      <td colspan="3" class="label">Entreprise : <span class="value">${esc(data.entreprise)}</span></td>
    </tr>
    <tr>
      <td colspan="3" class="label">Num√©ro Siret : <span class="value blue">${esc(data.siret)}</span></td>
    </tr>
    <tr>
      <td colspan="3" class="label">Situation de handicap ? <span class="value">${data.handicap}</span></td>
    </tr>
    <tr>
      <td colspan="3" class="label">Voyez-vous d'autres besoins qui n'auraient pas √©t√© identifi√©s pr√©c√©demment : <span class="value">${data.autresBesoinsIdentifies}</span></td>
    </tr>
    <tr>
      <td colspan="3" class="label">Nombre de salari√©s : <span class="value">${esc(data.nbSalaries)}</span></td>
    </tr>
  </table>
  
  <table>
    <tr><td class="section-title" colspan="3"><span class="orange">Besoin pour quelle date : ${esc(data.besoinDate)}</span></td></tr>
    <tr><td class="section-blue" colspan="3">Besoin g√©n√©ral :</td></tr>
    <tr><td colspan="3">${esc(data.besoinGeneral)}</td></tr>
  </table>
  
  <table>
    <tr><td class="section-blue">Pr√©requis des formations demand√©es :</td></tr>
    <tr><td>${esc(data.prerequis)}</td></tr>
  </table>
  
  <table>
    <tr><td class="section-blue">D√©tails des objectifs op√©rationnels du client :</td></tr>
    <tr><td>${esc(data.objectifsClient)}</td></tr>
  </table>
  
  <table>
    <tr><td class="section-blue" colspan="3"><span class="orange" style="text-decoration:underline">Actions √† entreprendre :</span></td></tr>
    <tr>
      <td colspan="3">
        <p><strong class="blue">Modalit√©s</strong> : ${esc(data.modalites)}</p>
        <p><strong class="blue">Autres Besoins</strong> : ${data.autresBesoins}</p>
        <p><strong class="blue">Formation</strong> : ${esc(data.formation)}</p>
      </td>
    </tr>
  </table>
  
  ${data.synthese?`
  <table>
    <tr><td class="section-title">SYNTH√àSE DE L'ANALYSE</td></tr>
    <tr><td>${esc(data.synthese).replace(/\\n/g,'<br>')}</td></tr>
  </table>
  `:''}
</body>
</html>`;
  
  // Ouvrir dans une nouvelle fen√™tre pour impression/PDF
  const printWindow=window.open('','_blank','width=800,height=600');
  if(!printWindow){
    toast('Popup bloqu√©! Autorisez les popups.','error');
    return;
  }
  printWindow.document.write(htmlContent);
  printWindow.document.close();
  setTimeout(()=>{printWindow.print();},500);
  toast('PDF g√©n√©r√©','success');
}

async function genererPDFAnalyseById(id){
  const analyse=await dbGet('analyses',id);
  if(!analyse){
    toast('Analyse non trouv√©e','error');
    return;
  }
  
  const data={
    date:analyse.dateAnalyse||new Date().toISOString().split('T')[0],
    nom:analyse.clientNom||'',
    prenom:analyse.clientPrenom||'',
    adresse:analyse.clientAdresse||'',
    cp:analyse.clientCP||'',
    ville:analyse.clientVille||'',
    email:analyse.clientEmail||'',
    tel:analyse.clientTel||'',
    entreprise:analyse.clientEntreprise||'',
    siret:analyse.clientSiret||'',
    handicap:analyse.situationHandicap||'NON',
    autresBesoinsIdentifies:analyse.autresBesoinsIdentifies||'NON',
    nbSalaries:analyse.nbSalaries||'',
    besoinDate:analyse.besoinDate||'',
    besoinGeneral:analyse.besoinGeneral||'',
    prerequis:analyse.prerequis||'Voir le programme de formation',
    objectifsClient:analyse.objectifsClient||'',
    modalites:analyse.modalitesFormation||'',
    autresBesoins:analyse.autresBesoins||'NON',
    formation:analyse.formationTexte||'',
    synthese:analyse.synthese||''
  };
  
  genererPDFEvaluationBesoin(data);
}

async function ouvrirMailAnalyse(){
  const oppId=document.getElementById('f-opportunite')?.value;
  const formationId=document.getElementById('f-formation')?.value;
  
  // R√©cup√©rer l'email depuis le formulaire ou l'opportunit√©
  let destinataire=document.getElementById('f-clientEmail')?.value||'';
  let nomFormation=document.getElementById('f-formationTexte')?.value||'';
  
  if(!destinataire&&oppId){
    const opp=await dbGet('opportunites',parseInt(oppId));
    const ent=opp&&opp.entreprise?await dbGet('entreprises',parseInt(opp.entreprise)):null;
    destinataire=ent?(ent.emailContact||ent.emailPro||''):'';
  }
  
  if(!nomFormation&&formationId){
    const form=await dbGet('formations',parseInt(formationId));
    nomFormation=form?form.nom:'[Nom de la formation]';
  }
  
  if(!nomFormation)nomFormation='[Nom de la formation]';
  
  const sujet=`Formation ${nomFormation} - Questionnaire d'√©valuation des besoins`;
  const corps=`Bonjour Monsieur,

Suite √† votre demande, veuillez trouver ci-joint notre formation ${nomFormation} ainsi que notre questionnaire d'√©valuation des besoins.

Veuillez cliquer sur le lien ci-dessous pour acc√©der au questionnaire d'√©valuation des besoins de formation :

https://docs.google.com/forms/d/e/1FAIpQLSem8i9LKeCX36l-zKDScvPnFefqph6dBcxGU-azPQh-IinncA/viewform

Nous restons √† votre disposition pour de plus amples informations.

Vous pouvez nous contacter par t√©l√©phone au : 01 80 91 62 25 ou par mail : formation@des-click.com

Nous nous permettrons de vous recontacter pour d√©finir votre projet de formation.


Bien √† vous,

Service formation`;

  // Remplir et ouvrir la modal
  document.getElementById('email-analyse-dest').value=destinataire;
  document.getElementById('email-analyse-sujet').value=sujet;
  document.getElementById('email-analyse-corps').value=corps;
  document.getElementById('modal-email-analyse').classList.add('active');
}

function closeEmailAnalyse(){
  document.getElementById('modal-email-analyse').classList.remove('active');
}

function copierEmailAnalyse(){
  const corps=document.getElementById('email-analyse-corps').value;
  navigator.clipboard.writeText(corps).then(()=>{
    toast('Email copi√© dans le presse-papier','success');
  }).catch(()=>{
    toast('Erreur lors de la copie','error');
  });
}

async function envoyerEmailAnalyse(){
  const destinataire=document.getElementById('email-analyse-dest').value;
  const sujet=document.getElementById('email-analyse-sujet').value;
  const corps=document.getElementById('email-analyse-corps').value;
  
  if(!destinataire){
    toast('Veuillez saisir un destinataire','warning');
    return;
  }
  
  await stockerEmail(destinataire,sujet,corps,'Questionnaire analyse',null);
  toast('Email ajout√© √† la bo√Æte d\'envoi','success');
  closeEmailAnalyse();
}

// ============ WORKFLOW SUIVI COMPLET ============
const WORKFLOW_ETAPES=[
  {id:'Demande',label:'üì• Demande',icon:'üì•',color:'#3b82f6'},
  {id:'Analyse',label:'üìã Analyse',icon:'üìã',color:'#8b5cf6'},
  {id:'Evaluation',label:'üìä √âvaluation',icon:'üìä',color:'#ec4899'},
  {id:'Devis',label:'üí∞ Devis',icon:'üí∞',color:'#f59e0b'},
  {id:'Convention',label:'üìë Convention',icon:'üìë',color:'#10b981'},
  {id:'PriseEnCharge',label:'üìÑ Prise en Charge',icon:'üìÑ',color:'#06b6d4'},
  {id:'Termine',label:'‚úÖ Termin√©',icon:'‚úÖ',color:'#22c55e'}
];

let workflowData=[];
let filtreEtapeActuel='';
let allDataForFilters={demandes:[],analyses:[],evaluations:[],sessions:[],opportunites:[]};

async function showSuiviWorkflow(){
  // Charger toutes les donn√©es
  const [demandes,analyses,evaluations,stagiaires,sessions,devis,conventions,dpcs,entreprises,emails,opportunites]=await Promise.all([
    dbGetAll('demandes'),
    dbGetAll('analyses'),
    dbGetAll('evaluations'),
    dbGetAll('stagiaires'),
    dbGetAll('sessions'),
    dbGetAll('devis'),
    dbGetAll('conventions'),
    dbGetAll('dpc'),
    dbGetAll('entreprises'),
    dbGetAll('emails'),
    dbGetAll('opportunites')
  ]);
  
  // Stocker pour les filtres
  allDataForFilters={demandes,analyses,evaluations,sessions,opportunites};
  
  // Construire les workflows par entreprise/opportunit√©
  workflowData=construireWorkflows(demandes,analyses,evaluations,stagiaires,sessions,devis,conventions,dpcs,emails);
  
  // Remplir le filtre entreprises
  const filterEnt=document.getElementById('filter-suivi-entreprise');
  if(filterEnt){
    const entUniques=[...new Set(workflowData.map(w=>w.entreprise).filter(Boolean))].sort();
    filterEnt.innerHTML='<option value="">üè¢ Toutes les entreprises</option>'+
      entUniques.map(e=>`<option value="${esc(e)}">${esc(e)}</option>`).join('');
  }
  
  // Remplir le filtre demandes
  const filterDem=document.getElementById('filter-suivi-demande');
  if(filterDem){
    filterDem.innerHTML='<option value="">üì• Toutes les demandes</option>'+
      demandes.map(d=>`<option value="${d.id}">DEM-${String(d.id).padStart(3,'0')} - ${esc(d.raisonSociale||d.nom||'').substring(0,25)}</option>`).join('');
  }
  
  // Remplir le filtre opportunit√©s
  const filterOpp=document.getElementById('filter-suivi-opportunite');
  if(filterOpp){
    filterOpp.innerHTML='<option value="">üéØ Toutes les opportunit√©s</option>'+
      opportunites.map(o=>`<option value="${o.id}">OPP-${String(o.id).padStart(3,'0')} - ${esc(o.nom||o.titre||'').substring(0,25)}</option>`).join('');
  }
  
  // Remplir le filtre sessions
  const filterSess=document.getElementById('filter-suivi-session');
  if(filterSess){
    filterSess.innerHTML='<option value="">üìÖ Toutes les sessions</option>'+
      sessions.map(s=>`<option value="${s.id}">SESS-${String(s.id).padStart(3,'0')} - ${esc(s.formation||'').substring(0,20)} (${fmtDate(s.dateDebut)||''})</option>`).join('');
  }
  
  // Mettre √† jour les compteurs dans les fl√®ches
  const countDemande=demandes.length;
  const countAnalyse=analyses.length;
  const countEvaluation=evaluations.length;
  const countDevis=devis.length;
  const countConvention=conventions.length;
  const countPEC=dpcs.length;
  const countTermine=conventions.filter(c=>c.statut==='Termin√©e'||c.statut==='R√©alis√©e'||c.statut==='Sign√©e').length;
  
  if(document.getElementById('wf-count-demande')) document.getElementById('wf-count-demande').textContent=countDemande;
  if(document.getElementById('wf-count-analyse')) document.getElementById('wf-count-analyse').textContent=countAnalyse;
  if(document.getElementById('wf-count-evaluation')) document.getElementById('wf-count-evaluation').textContent=countEvaluation;
  if(document.getElementById('wf-count-devis')) document.getElementById('wf-count-devis').textContent=countDevis;
  if(document.getElementById('wf-count-convention')) document.getElementById('wf-count-convention').textContent=countConvention;
  if(document.getElementById('wf-count-pec')) document.getElementById('wf-count-pec').textContent=countPEC;
  if(document.getElementById('wf-count-termine')) document.getElementById('wf-count-termine').textContent=countTermine;
  
  renderSuiviWorkflow();
}

function filtrerParEtape(etape){
  filtreEtapeActuel=etape;
  
  // Mettre √† jour l'affichage du filtre actif
  const filtreActif=document.getElementById('filtre-etape-actif');
  const filtreLabel=document.getElementById('filtre-etape-label');
  
  if(etape){
    const etapeInfo=WORKFLOW_ETAPES.find(e=>e.id===etape)||{label:etape};
    filtreActif.style.display='block';
    filtreLabel.textContent=`Filtre actif: ${etapeInfo.label}`;
    
    // Mettre en √©vidence l'√©tape active
    document.querySelectorAll('.wf-step').forEach(step=>{
      step.classList.toggle('active',step.dataset.etape===etape);
    });
  }else{
    filtreActif.style.display='none';
    document.querySelectorAll('.wf-step').forEach(step=>step.classList.remove('active'));
  }
  
  renderSuiviWorkflow();
}

function construireWorkflows(demandes,analyses,evaluations,stagiaires,sessions,devis,conventions,dpcs,emails){
  const workflows=[];
  
  // Cr√©er un workflow pour chaque demande/analyse/devis
  demandes.forEach(d=>{
    const wf={
      id:'DEM-'+d.id,
      type:'demande',
      demandeId:d.id,
      opportuniteId:d.opportuniteId||null,
      sessionId:null,
      entreprise:d.raisonSociale||d.entreprise||d.nom||'',
      contact:d.contact||d.nom||'',
      email:d.email||'',
      titre:d.formationsInteressees||'Demande de formation',
      dateCreation:d.dateReception||d.dateCreation,
      etapeActuelle:determinerEtapeDemande(d),
      statut:d.statut,
      historique:[],
      documents:[],
      echanges:[]
    };
    
    // Ajouter √† l'historique
    wf.historique.push({date:d.dateReception||d.dateCreation,type:'creation',titre:'Demande re√ßue',icon:'üì•'});
    if(d.dateAccuse) wf.historique.push({date:d.dateAccuse,type:'email',titre:'Accus√© de r√©ception envoy√©',icon:'üìß'});
    if(d.statut==='Converti') wf.historique.push({date:d.dateConversion,type:'conversion',titre:'Converti en opportunit√©',icon:'‚úÖ'});
    
    // Lier les emails
    const emailsLies=emails.filter(e=>(e.destinataire||'').includes(d.email)||(e.sujet||'').includes(d.raisonSociale));
    emailsLies.forEach(e=>{
      wf.echanges.push({date:e.date||e.dateCreation,type:'email_envoye',titre:e.sujet||'Email',statut:e.statut});
    });
    
    workflows.push(wf);
  });
  
  // Enrichir avec les analyses li√©es
  analyses.forEach(a=>{
    let wf=workflows.find(w=>w.entreprise===a.entreprise);
    if(!wf){
      wf={
        id:'ANA-'+a.id,
        type:'analyse',
        demandeId:a.demandeId||null,
        opportuniteId:a.opportuniteId||null,
        sessionId:null,
        entreprise:a.entreprise||'',
        contact:a.contact||'',
        email:a.email||'',
        titre:a.formation||'Analyse des besoins',
        dateCreation:a.dateCreation,
        etapeActuelle:'Analyse',
        statut:a.statut,
        historique:[],
        documents:[],
        echanges:[]
      };
      workflows.push(wf);
    }
    wf.analyse=a;
    wf.analyseId=a.id;
    wf.historique.push({date:a.dateCreation,type:'analyse',titre:'Analyse des besoins cr√©√©e',icon:'üìã',lien:{type:'analyse',id:a.id}});
    if(a.statut==='Valid√©e') wf.etapeActuelle='Evaluation';
  });
  
  // Enrichir avec les √©valuations
  evaluations.forEach(ev=>{
    let wf=workflows.find(w=>w.entreprise===ev.entreprise||w.analyseId===ev.analyseId);
    if(wf){
      wf.evaluation=ev;
      wf.historique.push({date:ev.dateCreation||ev.date,type:'evaluation',titre:'√âvaluation cr√©√©e',icon:'üìä',lien:{type:'evaluation',id:ev.id}});
      if(ev.statut==='Valid√©e'||ev.statut==='Compl√®te') wf.etapeActuelle='Devis';
      else if(wf.etapeActuelle==='Analyse') wf.etapeActuelle='Evaluation';
    }
  });
  
  // Enrichir avec les devis
  devis.forEach(d=>{
    let wf=workflows.find(w=>w.entreprise===d.entreprise);
    if(wf){
      wf.devis=d;
      wf.devisId=d.id;
      wf.historique.push({date:d.date||d.dateCreation,type:'devis',titre:`Devis ${d.numero} cr√©√©`,icon:'üí∞',lien:{type:'devis',id:d.id}});
      if(d.statut==='Sign√©'){
        wf.historique.push({date:d.dateSignature,type:'signature',titre:'Devis sign√©',icon:'‚úÖ'});
        wf.etapeActuelle='Convention';
      }else{
        wf.etapeActuelle='Devis';
      }
      if(d.fichierSigne) wf.documents.push({type:'devis_signe',titre:'Devis sign√©',date:d.dateSignature});
    }
  });
  
  // Enrichir avec les conventions
  conventions.forEach(c=>{
    let wf=workflows.find(w=>w.entreprise===c.entreprise);
    if(wf){
      wf.convention=c;
      wf.conventionId=c.id;
      wf.sessionId=c.sessionId||null;
      wf.historique.push({date:c.date||c.dateCreation,type:'convention',titre:`Convention ${c.numero} cr√©√©e`,icon:'üìë',lien:{type:'convention',id:c.id}});
      if(c.statut==='Sign√©e'){
        wf.historique.push({date:c.dateSignature,type:'signature',titre:'Convention sign√©e',icon:'‚úÖ'});
        wf.etapeActuelle='PriseEnCharge';
      }else{
        wf.etapeActuelle='Convention';
      }
      if(c.fichierSigne) wf.documents.push({type:'convention_signee',titre:'Convention sign√©e',date:c.dateSignature});
    }
  });
  
  // Enrichir avec les sessions
  sessions.forEach(s=>{
    let wf=workflows.find(w=>w.conventionId===s.conventionId||w.entreprise===s.entreprise);
    if(wf){
      wf.session=s;
      wf.sessionId=s.id;
      wf.historique.push({date:s.dateDebut||s.dateCreation,type:'session',titre:`Session planifi√©e (${fmtDate(s.dateDebut)})`,icon:'üìÖ',lien:{type:'session',id:s.id}});
    }
  });
  
  // Enrichir avec les DPC
  dpcs.forEach(d=>{
    let wf=workflows.find(w=>w.convention&&w.convention.id===d.convention);
    if(wf){
      wf.dpc=d;
      wf.dpcId=d.id;
      wf.historique.push({date:d.dateCreation,type:'dpc',titre:'Demande de prise en charge cr√©√©e',icon:'üìÑ',lien:{type:'dpc',id:d.id}});
      if(d.statut==='Valid√©'||d.statut==='Accept√©'||d.statut==='Accept√©e') wf.etapeActuelle='Termine';
    }
  });
  
  // Trier par date
  workflows.sort((a,b)=>new Date(b.dateCreation||0)-new Date(a.dateCreation||0));
  
  return workflows;
}

function determinerEtapeDemande(d){
  if(d.statut==='Converti') return 'Analyse';
  if(d.statut==='Trait√©') return 'Analyse';
  return 'Demande';
}

function filterSuiviWorkflow(){
  renderSuiviWorkflow();
}

function renderSuiviWorkflow(){
  const container=document.getElementById('suivi-workflow-liste');
  if(!container)return;
  
  const search=(document.getElementById('search-suivi')?.value||'').toLowerCase();
  const filterEnt=document.getElementById('filter-suivi-entreprise')?.value;
  const filterDem=document.getElementById('filter-suivi-demande')?.value;
  const filterOpp=document.getElementById('filter-suivi-opportunite')?.value;
  const filterSess=document.getElementById('filter-suivi-session')?.value;
  
  let filtered=workflowData.filter(w=>{
    if(search && !(w.entreprise||'').toLowerCase().includes(search) && !(w.titre||'').toLowerCase().includes(search)) return false;
    if(filterEnt && w.entreprise!==filterEnt) return false;
    if(filterDem && w.demandeId!=filterDem) return false;
    if(filterOpp && w.opportuniteId!=filterOpp) return false;
    if(filterSess && w.sessionId!=filterSess) return false;
    if(filtreEtapeActuel && w.etapeActuelle!==filtreEtapeActuel) return false;
    return true;
  });
  
  if(filtered.length===0){
    container.innerHTML='<div style="text-align:center;padding:40px;color:#64748b"><div style="font-size:3rem;margin-bottom:15px">üìä</div><h3>Aucun workflow trouv√©</h3><p>Aucune donn√©e ne correspond aux filtres s√©lectionn√©s.</p></div>';
    return;
  }
  
  container.innerHTML=filtered.map(w=>renderWorkflowCard(w)).join('');
}

function renderWorkflowCard(wf){
  const etapeInfo=WORKFLOW_ETAPES.find(e=>e.id===wf.etapeActuelle)||{label:wf.etapeActuelle,icon:'üìå',color:'#64748b'};
  
  // Barre de progression
  const etapeIndex=WORKFLOW_ETAPES.findIndex(e=>e.id===wf.etapeActuelle);
  const progression=Math.round(((etapeIndex+1)/WORKFLOW_ETAPES.length)*100);
  
  // Timeline des √©tapes
  const etapesHtml=WORKFLOW_ETAPES.slice(0,-1).map((e,i)=>{
    const isComplete=i<etapeIndex;
    const isCurrent=i===etapeIndex;
    return `<div class="wf-etape ${isComplete?'complete':''} ${isCurrent?'current':''}" title="${e.label}">
      <div class="wf-etape-icon">${e.icon}</div>
      <div class="wf-etape-line"></div>
    </div>`;
  }).join('');
  
  // Historique avec √©changes
  let historiqueHtml=wf.historique.slice(-5).map(h=>`
    <div class="timeline-item completed">
      <div class="timeline-item-content">
        <div class="timeline-item-title">${h.icon||'üìå'} ${esc(h.titre)}</div>
        <div class="timeline-item-date">${fmtDate(h.date)}</div>
        ${h.lien?`<button class="btn btn-sm btn-info" onclick="ouvrirDocument('${h.lien.type}',${h.lien.id})" style="margin-top:5px">üìÑ Voir</button>`:''}
      </div>
    </div>
  `).join('');
  
  // Documents
  const docsHtml=wf.documents.length>0?`
    <div style="margin-top:10px;padding-top:10px;border-top:1px solid #e5e7eb">
      <strong style="font-size:0.85em;color:#374151">üìé Documents:</strong>
      ${wf.documents.map(d=>`<span class="status status-valide" style="margin-left:5px;font-size:0.75em">${d.titre}</span>`).join('')}
    </div>`:'';
  
  // √âchanges emails
  const echangesHtml=wf.echanges.length>0?`
    <div style="margin-top:10px;padding-top:10px;border-top:1px solid #e5e7eb">
      <strong style="font-size:0.85em;color:#374151">üìß √âchanges (${wf.echanges.length}):</strong>
      ${wf.echanges.slice(-3).map(e=>`
        <div style="font-size:0.8em;color:#64748b;margin-top:5px">
          ${e.type==='email_envoye'?'üì§':'üì•'} ${esc(e.titre)} - <span class="status status-${slug(e.statut)}" style="font-size:0.7em">${e.statut||'En attente'}</span>
        </div>`).join('')}
    </div>`:'';
  
  return `
    <div class="suivi-card" data-wf-id="${wf.id}">
      <div class="suivi-card-header">
        <div class="suivi-card-info">
          <h3>${esc(wf.titre||'Workflow')}</h3>
          <p>üè¢ ${esc(wf.entreprise||'-')} ‚Ä¢ üë§ ${esc(wf.contact||'-')} ‚Ä¢ üìß ${esc(wf.email||'-')}</p>
        </div>
        <div class="suivi-card-actions">
          <span class="status" style="background:${etapeInfo.color}20;color:${etapeInfo.color}">${etapeInfo.label}</span>
          <button class="btn btn-primary btn-sm" onclick="ouvrirDetailWorkflow('${wf.id}')">üëÅÔ∏è D√©tails</button>
          <button class="btn btn-success btn-sm" onclick="envoyerMessageWorkflow('${wf.id}')">üí¨ Message</button>
        </div>
      </div>
      
      <!-- Barre de progression -->
      <div style="padding:15px 20px;background:#f8fafc;border-bottom:1px solid #e5e7eb">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <span style="font-weight:600;color:#374151;font-size:0.9em">Progression du workflow</span>
          <span style="font-weight:700;color:${etapeInfo.color}">${progression}%</span>
        </div>
        <div style="display:flex;align-items:center;gap:5px">${etapesHtml}</div>
      </div>
      
      <div class="suivi-timeline" style="padding:15px 20px">
        <div class="suivi-timeline-title">üìà Historique r√©cent</div>
        ${historiqueHtml||'<p style="color:#94a3b8;font-size:0.85em">Aucun historique</p>'}
        ${docsHtml}
        ${echangesHtml}
      </div>
    </div>`;
}

function ouvrirDocument(type,id){
  switch(type){
    case 'analyse':naviguerVersSection('analyse-eval','analyse');break;
    case 'devis':naviguerVersSection('documents','devis');break;
    case 'convention':naviguerVersSection('documents','conventions');break;
    case 'dpc':showPage('dpc');break;
  }
}

function ouvrirDetailWorkflow(wfId){
  const wf=workflowData.find(w=>w.id===wfId);
  if(!wf){toast('Workflow non trouv√©','error');return;}
  
  const modalHtml=`
    <div id="modal-detail-wf" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;justify-content:center;align-items:center;padding:20px">
      <div style="background:#fff;border-radius:12px;width:800px;max-width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
        <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#0066cc,#0052a3);border-radius:12px 12px 0 0">
          <h3 style="margin:0;color:#fff">üìä ${esc(wf.titre)}</h3>
          <button onclick="document.getElementById('modal-detail-wf').remove()" style="background:rgba(255,255,255,0.2);border:none;font-size:1.5rem;cursor:pointer;color:#fff;width:35px;height:35px;border-radius:50%">&times;</button>
        </div>
        <div style="padding:20px">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
            <div class="card" style="padding:15px">
              <h4 style="margin:0 0 10px 0;color:#374151">üè¢ Informations</h4>
              <p><strong>Entreprise:</strong> ${esc(wf.entreprise)}</p>
              <p><strong>Contact:</strong> ${esc(wf.contact)}</p>
              <p><strong>Email:</strong> ${esc(wf.email)}</p>
              <p><strong>Date cr√©ation:</strong> ${fmtDate(wf.dateCreation)}</p>
            </div>
            <div class="card" style="padding:15px">
              <h4 style="margin:0 0 10px 0;color:#374151">üìÑ Documents li√©s</h4>
              ${wf.analyse?`<p>üìã <a href="#" onclick="naviguerVersSection('analyse-eval','analyse');document.getElementById('modal-detail-wf').remove()">Analyse des besoins</a></p>`:''}
              ${wf.devis?`<p>üí∞ <a href="#" onclick="naviguerVersSection('documents','devis');document.getElementById('modal-detail-wf').remove()">Devis ${wf.devis.numero||''}</a></p>`:''}
              ${wf.convention?`<p>üìë <a href="#" onclick="naviguerVersSection('documents','conventions');document.getElementById('modal-detail-wf').remove()">Convention ${wf.convention.numero||''}</a></p>`:''}
              ${wf.dpc?`<p>üìÑ <a href="#" onclick="showPage('dpc');document.getElementById('modal-detail-wf').remove()">Prise en charge</a></p>`:''}
              ${(!wf.analyse&&!wf.devis&&!wf.convention&&!wf.dpc)?'<p style="color:#94a3b8">Aucun document</p>':''}
            </div>
          </div>
          
          <h4 style="margin:20px 0 15px 0;color:#374151">üìß Tous les √©changes</h4>
          <div style="max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;padding:10px">
            ${wf.echanges.length>0?wf.echanges.map(e=>`
              <div style="padding:10px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center">
                <div>
                  <span>${e.type==='email_envoye'?'üì§ Envoy√©':'üì• Re√ßu'}</span>
                  <strong style="margin-left:10px">${esc(e.titre)}</strong>
                </div>
                <div>
                  <span style="color:#64748b;font-size:0.85em">${fmtDate(e.date)}</span>
                  <span class="status status-${slug(e.statut)}" style="margin-left:10px">${e.statut||'-'}</span>
                </div>
              </div>
            `).join(''):'<p style="color:#94a3b8;text-align:center;padding:20px">Aucun √©change enregistr√©</p>'}
          </div>
          
          <h4 style="margin:20px 0 15px 0;color:#374151">üìà Historique complet</h4>
          <div style="max-height:250px;overflow-y:auto">
            ${wf.historique.map(h=>`
              <div class="timeline-item completed">
                <div class="timeline-item-content">
                  <div class="timeline-item-title">${h.icon||'üìå'} ${esc(h.titre)}</div>
                  <div class="timeline-item-date">${fmtDate(h.date)}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        <div style="padding:15px 20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;background:#f8fafc;border-radius:0 0 12px 12px">
          <button class="btn btn-info" onclick="envoyerMessageWorkflow('${wf.id}');document.getElementById('modal-detail-wf').remove()">üí¨ Envoyer un message</button>
          <button class="btn btn-secondary" onclick="document.getElementById('modal-detail-wf').remove()">Fermer</button>
        </div>
      </div>
    </div>`;
  
  document.body.insertAdjacentHTML('beforeend',modalHtml);
}

function envoyerMessageWorkflow(wfId){
  const wf=workflowData.find(w=>w.id===wfId);
  if(wf){
    showPage('messagerie');
    setTimeout(()=>{
      ouvrirNouveauMessage();
      document.getElementById('msg-nouveau-sujet').value=`RE: ${wf.titre} - ${wf.entreprise}`;
    },300);
  }
}

// ============ TABLEAU DE CONTR√îLE ============
let tableauControleData=[];

async function showTableauControle(){
  const [opportunites,entreprises,formations,demandes,analyses,evaluations,devis,conventions,dpc,sessions,emargements,attestations,evalPre,evalPost]=await Promise.all([
    dbGetAll('opportunites'),
    dbGetAll('entreprises'),
    dbGetAll('formations'),
    dbGetAll('demandes'),
    dbGetAll('analyses'),
    dbGetAll('evaluations'),
    dbGetAll('devis'),
    dbGetAll('conventions'),
    dbGetAll('dpc'),
    dbGetAll('sessions'),
    dbGetAll('emargements'),
    dbGetAll('attestations'),
    dbGetAll('evalPre'),
    dbGetAll('evalPost')
  ]);
  
  // Cr√©er un map pour acc√®s rapide
  const entMap={};entreprises.forEach(e=>entMap[e.id]=e);
  const formMap={};formations.forEach(f=>formMap[f.id]=f);
  
  // Remplir le filtre entreprises
  const filterEnt=document.getElementById('filter-controle-entreprise');
  if(filterEnt){
    filterEnt.innerHTML='<option value="">üè¢ Toutes les entreprises</option>'+
      entreprises.map(e=>`<option value="${e.id}">${esc(e.nom)}</option>`).join('');
  }
  
  // Construire les donn√©es du tableau
  tableauControleData=opportunites.map(opp=>{
    const ent=entMap[opp.entreprise]||{};
    const form=formMap[opp.formation]||{};
    
    // Trouver les √©l√©ments li√©s
    const demande=demandes.find(d=>d.id===opp.demandeId||d.entreprise===opp.entreprise);
    const analyse=analyses.find(a=>a.opportunite==opp.id);
    const evaluation=evaluations.find(ev=>ev.opportunite==opp.id);
    const devisItem=devis.find(d=>d.opportunite==opp.id);
    const convention=conventions.find(c=>c.opportunite==opp.id||c.devisId===(devisItem?.id));
    const pec=dpc.find(p=>p.opportunite==opp.id||p.entreprise==opp.entreprise);
    const session=sessions.find(s=>s.opportunite==opp.id||s.formation==opp.formation);
    
    // √âvaluations pr√©/post li√©es √† la session ou opportunit√©
    const hasEvalPre=evalPre.some(e=>e.opportunite==opp.id||e.session==session?.id);
    const hasEvalPost=evalPost.some(e=>e.opportunite==opp.id||e.session==session?.id);
    
    // √âmargements et attestations de la session
    const sessionEmargements=session?emargements.filter(e=>e.sessionId==session.id):[];
    const sessionAttestations=session?attestations.filter(a=>a.session==session.id):[];
    
    // Calculer le score de compl√©tion
    let score=0,total=0;
    
    // Demande (2 points)
    total+=2;
    if(demande)score++;
    if(demande&&(demande.statut==='Trait√©'||demande.statut==='Converti'))score++;
    
    // Analyse (2 points)
    total+=2;
    if(analyse)score++;
    if(analyse&&analyse.statut==='R√©ponse re√ßue')score++;
    
    // √âvaluations pr√©/post (2 points)
    total+=2;
    if(hasEvalPre)score++;
    if(hasEvalPost)score++;
    
    // Devis (3 points)
    total+=3;
    if(devisItem)score++;
    if(devisItem&&(devisItem.statut==='Envoy√©'||devisItem.statut==='Accept√©'||devisItem.statut==='Sign√©'))score++;
    if(devisItem&&devisItem.fichierSigne)score++;
    
    // Convention (3 points)
    total+=3;
    if(convention)score++;
    if(convention&&(convention.statut==='Envoy√©e'||convention.statut==='Sign√©e'||convention.statut==='Valid√©e'))score++;
    if(convention&&convention.fichierSigne)score++;
    
    // PEC OPCO (2 points)
    total+=2;
    if(pec)score++;
    if(pec&&pec.statut==='Accord√©')score++;
    
    // Session (3 points)
    total+=3;
    if(session)score++;
    if(sessionEmargements.length>0)score++;
    if(session&&session.statut==='Termin√©e')score++;
    
    // Documents finaux (2 points)
    total+=2;
    if(sessionEmargements.length>0)score++;
    if(sessionAttestations.length>0)score++;
    
    const pourcentage=Math.round((score/total)*100);
    
    return {
      id:opp.id,
      entreprise:ent.nom||'-',
      entrepriseId:opp.entreprise,
      formation:form.intitule||form.nom||'-',
      statut:opp.statut||'Nouveau',
      // Demande
      demandeRecue:!!demande,
      demandeTraitee:demande&&(demande.statut==='Trait√©'||demande.statut==='Converti'),
      // Analyse
      analyseCree:!!analyse,
      analyseEnvoyee:analyse&&(analyse.statut==='Questionnaire envoy√©'||analyse.statut==='R√©ponse re√ßue'),
      // √âvaluation
      evalPre:hasEvalPre,
      evalPost:hasEvalPost,
      // Devis
      devisCree:!!devisItem,
      devisEnvoye:devisItem&&(devisItem.statut==='Envoy√©'||devisItem.statut==='Accept√©'||devisItem.statut==='Sign√©'),
      devisSigne:devisItem&&!!devisItem.fichierSigne,
      // Convention
      conventionCreee:!!convention,
      conventionEnvoyee:convention&&(convention.statut==='Envoy√©e'||convention.statut==='Sign√©e'||convention.statut==='Valid√©e'),
      conventionSignee:convention&&!!convention.fichierSigne,
      // PEC
      pecTransmis:!!pec,
      pecAccorde:pec&&pec.statut==='Accord√©',
      // Session
      sessionPlanifiee:!!session,
      sessionEmargee:sessionEmargements.length>0,
      sessionTerminee:session&&session.statut==='Termin√©e',
      // Final
      emargementsFinal:sessionEmargements.length>0,
      attestationsFinal:sessionAttestations.length>0,
      // Score
      pourcentage,
      score,
      total
    };
  });
  
  renderTableauControle();
}

function renderTableauControle(){
  const tbody=document.getElementById('tbody-controle');
  if(!tbody)return;
  
  const search=(document.getElementById('search-controle')?.value||'').toLowerCase();
  const filterEnt=document.getElementById('filter-controle-entreprise')?.value;
  const filterStatut=document.getElementById('filter-controle-statut')?.value;
  
  let filtered=tableauControleData.filter(row=>{
    if(search&&!row.entreprise.toLowerCase().includes(search)&&!row.formation.toLowerCase().includes(search))return false;
    if(filterEnt&&row.entrepriseId!=filterEnt)return false;
    if(filterStatut){
      if(filterStatut==='complet'&&row.pourcentage<100)return false;
      if(filterStatut==='en-cours'&&(row.pourcentage>=100||row.pourcentage<20))return false;
      if(filterStatut==='incomplet'&&row.pourcentage>=20)return false;
    }
    return true;
  });
  
  // Trier par pourcentage d√©croissant
  filtered.sort((a,b)=>b.pourcentage-a.pourcentage);
  
  // Fonction pour cr√©er un badge
  const badge=(val,uploaded=false,label='')=>{
    if(uploaded)return`<span class="ctrl-badge uploaded" title="${label} - Upload√©">üì§</span>`;
    if(val===true)return`<span class="ctrl-badge done" title="${label} - Fait">‚úÖ</span>`;
    if(val===false)return`<span class="ctrl-badge pending" title="${label} - En attente">‚è≥</span>`;
    return`<span class="ctrl-badge na" title="${label} - N/A">‚Äî</span>`;
  };
  
  // Fonction pour cr√©er une cellule group√©e avec plusieurs badges
  const cellGroup=(items)=>{
    return`<td class="ctrl-td"><div class="ctrl-cell">${items.join('')}</div></td>`;
  };
  
  tbody.innerHTML=filtered.map(row=>{
    const barColor=row.pourcentage>=80?'#22c55e':row.pourcentage>=50?'#f59e0b':'#ef4444';
    const barBg=row.pourcentage>=80?'#dcfce7':row.pourcentage>=50?'#fef3c7':'#fee2e2';
    
    return`
    <tr>
      <td class="ctrl-td-fixed" style="left:0;font-weight:700;color:#1e40af;font-size:0.95em">${row.id}</td>
      <td class="ctrl-td-fixed" style="left:50px;text-align:left;font-weight:600;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(row.entreprise)}">${esc(row.entreprise)}</td>
      <td class="ctrl-td" style="text-align:left;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#475569" title="${esc(row.formation)}">${esc(row.formation)}</td>
      <td class="ctrl-td"><span class="status status-${slug(row.statut)}">${row.statut}</span></td>
      ${cellGroup([
        badge(row.demandeRecue,false,'Re√ßue'),
        badge(row.demandeTraitee,false,'Trait√©e')
      ])}
      ${cellGroup([
        badge(row.analyseCree,false,'Cr√©√©e'),
        badge(row.analyseEnvoyee,false,'Envoy√©e')
      ])}
      ${cellGroup([
        badge(row.evalPre,false,'Pr√©'),
        badge(row.evalPost,false,'Post')
      ])}
      ${cellGroup([
        badge(row.devisCree,false,'Cr√©√©'),
        badge(row.devisEnvoye,false,'Envoy√©'),
        badge(row.devisSigne,row.devisSigne,'Sign√©')
      ])}
      ${cellGroup([
        badge(row.conventionCreee,false,'Cr√©√©e'),
        badge(row.conventionEnvoyee,false,'Envoy√©e'),
        badge(row.conventionSignee,row.conventionSignee,'Sign√©e')
      ])}
      ${cellGroup([
        badge(row.pecTransmis,false,'Transmis'),
        badge(row.pecAccorde,false,'Accord√©')
      ])}
      ${cellGroup([
        badge(row.sessionPlanifiee,false,'Planifi√©e'),
        badge(row.sessionTerminee,false,'Termin√©e')
      ])}
      ${cellGroup([
        badge(row.emargementsFinal,false,'√âmargements'),
        badge(row.attestationsFinal,false,'Attestations')
      ])}
      <td class="ctrl-td">
        <div style="display:flex;align-items:center;gap:8px;justify-content:center">
          <div style="width:60px;height:10px;background:${barBg};border-radius:5px;overflow:hidden;border:1px solid ${barColor}30">
            <div style="width:${row.pourcentage}%;height:100%;background:${barColor};border-radius:5px"></div>
          </div>
          <span style="font-weight:700;font-size:0.95em;color:${barColor};min-width:40px">${row.pourcentage}%</span>
        </div>
      </td>
    </tr>`;
  }).join('');
  
  // Mettre √† jour les statistiques
  const complets=filtered.filter(r=>r.pourcentage>=100).length;
  const encours=filtered.filter(r=>r.pourcentage>=20&&r.pourcentage<100).length;
  const incomplets=filtered.filter(r=>r.pourcentage<20).length;
  const uploades=filtered.filter(r=>r.devisSigne||r.conventionSignee).length;
  const tauxMoyen=filtered.length>0?Math.round(filtered.reduce((a,r)=>a+r.pourcentage,0)/filtered.length):0;
  
  document.getElementById('ctrl-complets').textContent=complets;
  document.getElementById('ctrl-encours').textContent=encours;
  document.getElementById('ctrl-incomplets').textContent=incomplets;
  document.getElementById('ctrl-uploades').textContent=uploades;
  document.getElementById('ctrl-taux').textContent=tauxMoyen+'%';
}

function filterTableauControle(){
  renderTableauControle();
}

function exporterTableauControle(){
  if(tableauControleData.length===0){
    toast('Aucune donn√©e √† exporter','warning');
    return;
  }
  
  const headers=['ID','Entreprise','Formation','Statut','Demande Re√ßue','Demande Trait√©e','Analyse Cr√©√©e','Analyse Envoy√©e','√âval Pr√©','√âval Post','Devis Cr√©√©','Devis Envoy√©','Devis Sign√©','Convention Cr√©√©e','Convention Envoy√©e','Convention Sign√©e','PEC Transmis','PEC Accord√©','Session Planifi√©e','Session √âmarg√©e','Session Termin√©e','√âmargements','Attestations','Compl√©tion %'];
  
  const rows=tableauControleData.map(r=>[
    r.id,
    r.entreprise,
    r.formation,
    r.statut,
    r.demandeRecue?'Oui':'Non',
    r.demandeTraitee?'Oui':'Non',
    r.analyseCree?'Oui':'Non',
    r.analyseEnvoyee?'Oui':'Non',
    r.evalPre?'Oui':'Non',
    r.evalPost?'Oui':'Non',
    r.devisCree?'Oui':'Non',
    r.devisEnvoye?'Oui':'Non',
    r.devisSigne?'Oui':'Non',
    r.conventionCreee?'Oui':'Non',
    r.conventionEnvoyee?'Oui':'Non',
    r.conventionSignee?'Oui':'Non',
    r.pecTransmis?'Oui':'Non',
    r.pecAccorde?'Oui':'Non',
    r.sessionPlanifiee?'Oui':'Non',
    r.sessionEmargee?'Oui':'Non',
    r.sessionTerminee?'Oui':'Non',
    r.emargementsFinal?'Oui':'Non',
    r.attestationsFinal?'Oui':'Non',
    r.pourcentage+'%'
  ]);
  
  const csv=[headers.join(';'),...rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(';'))].join('\n');
  
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='tableau-controle-'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
  URL.revokeObjectURL(url);
  
  toast('Export CSV t√©l√©charg√©','success');
}

// ============ MESSAGERIE INTERNE ============
let messagesData=[];
let conversationActive=null;

async function showMessagerie(){
  messagesData=await dbGetAll('messages');
  const [commerciaux,formateurs,gestionnaires]=await Promise.all([
    dbGetAll('commerciaux'),
    dbGetAll('formateurs'),
    dbGetAll('gestionnaires')
  ]);
  
  // Remplir le filtre destinataires
  const filterDest=document.getElementById('filter-msg-dest');
  if(filterDest){
    let options='<option value="">Tous</option>';
    options+='<optgroup label="üë®‚Äçüíº Commerciaux">'+commerciaux.map(c=>`<option value="COM-${c.id}">${esc(c.nom)} ${esc(c.prenom||'')}</option>`).join('')+'</optgroup>';
    options+='<optgroup label="üë®‚Äçüè´ Formateurs">'+formateurs.map(f=>`<option value="FOR-${f.id}">${esc(f.nom)} ${esc(f.prenom||'')}</option>`).join('')+'</optgroup>';
    options+='<optgroup label="üë§ Gestionnaires">'+gestionnaires.map(g=>`<option value="GES-${g.id}">${esc(g.nom)} ${esc(g.prenom||'')}</option>`).join('')+'</optgroup>';
    filterDest.innerHTML=options;
  }
  
  renderConversations();
}

function filterMessages(){
  renderConversations();
}

function renderConversations(){
  const container=document.getElementById('msg-conversations-liste');
  if(!container)return;
  
  const filterType=document.getElementById('filter-msg-type')?.value;
  const filterDest=document.getElementById('filter-msg-dest')?.value;
  
  // Grouper les messages par conversation (sujet)
  const conversations={};
  messagesData.forEach(m=>{
    const key=m.sujet||'Sans sujet';
    if(!conversations[key]) conversations[key]={sujet:key,messages:[],dernierMessage:null,nonLus:0};
    conversations[key].messages.push(m);
    if(!conversations[key].dernierMessage||new Date(m.date)>new Date(conversations[key].dernierMessage.date)){
      conversations[key].dernierMessage=m;
    }
    if(!m.lu&&m.destinataireId===currentUser?.id) conversations[key].nonLus++;
  });
  
  let convList=Object.values(conversations);
  
  // Filtrer
  if(filterType==='nonlu') convList=convList.filter(c=>c.nonLus>0);
  if(filterType==='envoye') convList=convList.filter(c=>c.messages.some(m=>m.expediteurId===currentUser?.id));
  if(filterType==='recu') convList=convList.filter(c=>c.messages.some(m=>m.destinataireId===currentUser?.id));
  
  // Trier par date
  convList.sort((a,b)=>new Date(b.dernierMessage?.date||0)-new Date(a.dernierMessage?.date||0));
  
  if(convList.length===0){
    container.innerHTML='<div style="text-align:center;padding:30px;color:#94a3b8"><p>Aucune conversation</p></div>';
    return;
  }
  
  container.innerHTML=convList.map(c=>`
    <div class="msg-conv-item ${conversationActive===c.sujet?'active':''}" onclick="ouvrirConversation('${esc(c.sujet)}')" style="padding:15px;border-bottom:1px solid #e5e7eb;cursor:pointer;transition:background 0.2s;${conversationActive===c.sujet?'background:#e0f2fe;':''}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div style="font-weight:600;color:#1e293b;font-size:0.9em">${esc(c.sujet)}</div>
        ${c.nonLus>0?`<span style="background:#ef4444;color:#fff;font-size:0.7em;padding:2px 8px;border-radius:10px">${c.nonLus}</span>`:''}
      </div>
      <div style="font-size:0.8em;color:#64748b;margin-top:5px">${esc(c.dernierMessage?.expediteur||'-')}</div>
      <div style="font-size:0.75em;color:#94a3b8;margin-top:3px">${fmtDate(c.dernierMessage?.date)}</div>
    </div>
  `).join('');
}

function ouvrirConversation(sujet){
  conversationActive=sujet;
  renderConversations();
  
  const conv=messagesData.filter(m=>m.sujet===sujet);
  conv.sort((a,b)=>new Date(a.date)-new Date(b.date));
  
  // Marquer comme lus
  conv.forEach(async m=>{
    if(!m.lu&&m.destinataireId===currentUser?.id){
      m.lu=true;
      await dbPut('messages',m);
    }
  });
  
  const header=document.getElementById('msg-header');
  const contenu=document.getElementById('msg-contenu');
  const reponse=document.getElementById('msg-reponse');
  
  header.innerHTML=`<strong style="color:#1e293b">${esc(sujet)}</strong><span style="color:#64748b;font-size:0.9em;margin-left:15px">${conv.length} message(s)</span>`;
  
  contenu.innerHTML=conv.map(m=>`
    <div style="margin-bottom:15px;display:flex;flex-direction:column;${m.expediteurId===currentUser?.id?'align-items:flex-end':'align-items:flex-start'}">
      <div style="max-width:70%;background:${m.expediteurId===currentUser?.id?'#0066cc':'#fff'};color:${m.expediteurId===currentUser?.id?'#fff':'#1e293b'};padding:12px 16px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)">
        <div style="font-weight:600;font-size:0.85em;margin-bottom:5px;opacity:0.9">${esc(m.expediteur||'Inconnu')}</div>
        <div style="font-size:0.9em;line-height:1.5">${esc(m.contenu||'')}</div>
        <div style="font-size:0.75em;opacity:0.7;margin-top:8px;text-align:right">${fmtDate(m.date)} ${m.date?new Date(m.date).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}):''}</div>
      </div>
    </div>
  `).join('');
  
  contenu.scrollTop=contenu.scrollHeight;
  reponse.style.display='block';
}

async function envoyerReponseMessage(){
  const texte=document.getElementById('msg-reponse-texte').value.trim();
  if(!texte){toast('Veuillez saisir un message','warning');return;}
  if(!conversationActive){toast('Aucune conversation s√©lectionn√©e','warning');return;}
  
  const message={
    sujet:conversationActive,
    expediteur:currentUser?.nom||'Moi',
    expediteurId:currentUser?.id,
    contenu:texte,
    date:new Date().toISOString(),
    lu:false
  };
  
  await dbAdd('messages',message);
  document.getElementById('msg-reponse-texte').value='';
  
  messagesData=await dbGetAll('messages');
  ouvrirConversation(conversationActive);
  toast('Message envoy√© !','success');
}

function ouvrirNouveauMessage(){
  const modalHtml=`
    <div id="modal-nouveau-msg" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;justify-content:center;align-items:center;padding:20px">
      <div style="background:#fff;border-radius:12px;width:500px;max-width:95%;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
        <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-radius:12px 12px 0 0">
          <h3 style="margin:0;color:#0066cc">‚úâÔ∏è Nouveau Message</h3>
          <button onclick="document.getElementById('modal-nouveau-msg').remove()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#64748b">&times;</button>
        </div>
        <div style="padding:20px">
          <div class="form-group" style="margin-bottom:15px">
            <label class="form-label">Destinataire</label>
            <select class="form-select" id="msg-nouveau-dest" style="width:100%">
              <option value="">-- Choisir --</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:15px">
            <label class="form-label">Sujet</label>
            <input type="text" class="form-input" id="msg-nouveau-sujet" style="width:100%" placeholder="Objet du message">
          </div>
          <div class="form-group">
            <label class="form-label">Message</label>
            <textarea class="form-textarea" id="msg-nouveau-contenu" rows="5" style="width:100%" placeholder="Votre message..."></textarea>
          </div>
        </div>
        <div style="padding:15px 20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;background:#f8fafc;border-radius:0 0 12px 12px">
          <button class="btn btn-secondary" onclick="document.getElementById('modal-nouveau-msg').remove()">Annuler</button>
          <button class="btn btn-primary" onclick="envoyerNouveauMessage()">üì§ Envoyer</button>
        </div>
      </div>
    </div>`;
  
  document.body.insertAdjacentHTML('beforeend',modalHtml);
  
  // Remplir les destinataires
  Promise.all([dbGetAll('commerciaux'),dbGetAll('formateurs'),dbGetAll('gestionnaires')]).then(([com,form,gest])=>{
    const select=document.getElementById('msg-nouveau-dest');
    let options='<option value="">-- Choisir --</option>';
    options+='<optgroup label="üë®‚Äçüíº Commerciaux">'+com.map(c=>`<option value="COM-${c.id}" data-nom="${esc(c.nom)} ${esc(c.prenom||'')}">${esc(c.nom)} ${esc(c.prenom||'')}</option>`).join('')+'</optgroup>';
    options+='<optgroup label="üë®‚Äçüè´ Formateurs">'+form.map(f=>`<option value="FOR-${f.id}" data-nom="${esc(f.nom)} ${esc(f.prenom||'')}">${esc(f.nom)} ${esc(f.prenom||'')}</option>`).join('')+'</optgroup>';
    options+='<optgroup label="üë§ Gestionnaires">'+gest.map(g=>`<option value="GES-${g.id}" data-nom="${esc(g.nom)} ${esc(g.prenom||'')}">${esc(g.nom)} ${esc(g.prenom||'')}</option>`).join('')+'</optgroup>';
    select.innerHTML=options;
  });
}

async function envoyerNouveauMessage(){
  const destSelect=document.getElementById('msg-nouveau-dest');
  const destId=destSelect.value;
  const destNom=destSelect.options[destSelect.selectedIndex]?.dataset?.nom||'';
  const sujet=document.getElementById('msg-nouveau-sujet').value.trim();
  const contenu=document.getElementById('msg-nouveau-contenu').value.trim();
  
  if(!destId||!sujet||!contenu){
    toast('Veuillez remplir tous les champs','warning');
    return;
  }
  
  const message={
    sujet:sujet,
    expediteur:currentUser?.nom||'Moi',
    expediteurId:currentUser?.id,
    destinataire:destNom,
    destinataireId:destId,
    contenu:contenu,
    date:new Date().toISOString(),
    lu:false
  };
  
  await dbAdd('messages',message);
  document.getElementById('modal-nouveau-msg').remove();
  
  messagesData=await dbGetAll('messages');
  renderConversations();
  toast('Message envoy√© !','success');
}

// ============ DEMANDE DE PRISE EN CHARGE ============
let dpcData=[];
let filtrePECEtape='';

async function showDPC(){
  dpcData=await dbGetAll('dpc');
  const [conventions,entreprises]=await Promise.all([
    dbGetAll('conventions'),
    dbGetAll('entreprises')
  ]);
  
  const convMap=Object.fromEntries(conventions.map(c=>[c.id,c]));
  const entMap=Object.fromEntries(entreprises.map(e=>[e.id,e]));
  
  // Remplir le filtre entreprises
  const filterEnt=document.getElementById('filter-dpc-entreprise');
  if(filterEnt){
    const entUniques=[...new Set(dpcData.map(d=>entMap[d.entrepriseId]?.nom||d.entreprise).filter(Boolean))].sort();
    filterEnt.innerHTML='<option value="">üè¢ Toutes les entreprises</option>'+
      entUniques.map(e=>`<option value="${esc(e)}">${esc(e)}</option>`).join('');
  }
  
  // Remplir le filtre OPCO
  const filterOpco=document.getElementById('filter-dpc-opco');
  if(filterOpco){
    const opcos=[...new Set(dpcData.map(d=>d.opco).filter(Boolean))];
    filterOpco.innerHTML='<option value="">Tous les OPCO</option>'+opcos.map(o=>`<option value="${esc(o)}">${esc(o)}</option>`).join('');
  }
  
  // Mettre √† jour les stats
  updateStatsDPC();
  
  renderDPC(convMap,entMap);
}

function updateWorkflowPEC(filtered){
  // Compteurs par √©tape
  const transmis=filtered.filter(d=>d.statut==='Transmis'&&!d.dateResultat).length;
  const enAttente=filtered.filter(d=>d.dateDepot&&!d.dateResultat&&d.statut!=='Transmis'&&d.statut!=="Demande d'information").length;
  const demandeInfo=filtered.filter(d=>d.statut==="Demande d'information").length;
  const accorde=filtered.filter(d=>d.statut==='Accord√©'&&!d.dateTransmissionDocs).length;
  const docsTransmis=filtered.filter(d=>d.dateTransmissionDocs&&!d.dateEncaissement).length;
  const encaisse=filtered.filter(d=>d.dateEncaissement).length;
  
  // Mettre √† jour les compteurs
  if(document.getElementById('wf-pec-transmis')) document.getElementById('wf-pec-transmis').textContent=transmis;
  if(document.getElementById('wf-pec-enattente')) document.getElementById('wf-pec-enattente').textContent=enAttente;
  if(document.getElementById('wf-pec-demandeinfo')) document.getElementById('wf-pec-demandeinfo').textContent=demandeInfo;
  if(document.getElementById('wf-pec-accorde')) document.getElementById('wf-pec-accorde').textContent=accorde;
  if(document.getElementById('wf-pec-docs')) document.getElementById('wf-pec-docs').textContent=docsTransmis;
  if(document.getElementById('wf-pec-encaisse')) document.getElementById('wf-pec-encaisse').textContent=encaisse;
  
  // Mode affichage
  const modeEl=document.getElementById('wf-pec-mode');
  const dureeTotaleEl=document.getElementById('wf-pec-duree-totale');
  const dureeValueEl=document.getElementById('wf-pec-duree-value');
  
  const isSingle=filtered.length===1;
  const record=isSingle?filtered[0]:null;
  
  if(modeEl){
    if(isSingle){
      modeEl.textContent=`üìã Dossier: ${record.numero||'PEC-'+record.id}`;
      modeEl.style.background='#dbeafe';
      modeEl.style.color='#1e40af';
    }else{
      modeEl.textContent=`üìä ${filtered.length} dossier(s) - Dur√©es moyennes`;
      modeEl.style.background='#f1f5f9';
      modeEl.style.color='#64748b';
    }
  }
  
  // Mettre √† jour les dur√©es
  if(isSingle){
    // Mode un seul enregistrement: dates d√©but/fin
    afficherDatesPEC(record);
    
    // Dur√©e totale
    if(dureeTotaleEl&&dureeValueEl){
      if(record.dateDepot&&record.dateEncaissement){
        const diff=diffJoursPEC(record.dateDepot,record.dateEncaissement);
        dureeTotaleEl.style.display='block';
        dureeValueEl.textContent=formatDureePEC(diff);
      }else if(record.dateDepot&&record.dateResultat){
        const diff=diffJoursPEC(record.dateDepot,record.dateResultat);
        dureeTotaleEl.style.display='block';
        dureeValueEl.textContent=formatDureePEC(diff)+' (en cours)';
      }else{
        dureeTotaleEl.style.display='none';
      }
    }
  }else{
    // Mode plusieurs enregistrements: dur√©es moyennes
    afficherDureesMoyennesPEC(filtered);
    
    // Dur√©e totale moyenne
    if(dureeTotaleEl&&dureeValueEl){
      const durees=[];
      filtered.forEach(p=>{
        if(p.dateDepot&&p.dateEncaissement){
          const diff=diffJoursPEC(p.dateDepot,p.dateEncaissement);
          if(diff>=0) durees.push(diff);
        }
      });
      if(durees.length>0){
        dureeTotaleEl.style.display='block';
        dureeValueEl.textContent='Moyenne: '+formatDureePEC(durees.reduce((a,b)=>a+b,0)/durees.length);
      }else{
        dureeTotaleEl.style.display='none';
      }
    }
  }
}

function afficherDatesPEC(record){
  // Transmis: dateDepot ‚Üí (en attente de r√©ponse)
  const elTransmis=document.getElementById('wf-pec-duree-transmis');
  if(elTransmis){
    if(record.dateDepot){
      elTransmis.innerHTML=`<div style="font-size:0.65em;line-height:1.3;margin-top:5px">
        <div style="color:#10b981">‚ñ∂ ${fmtDateCourtPEC(record.dateDepot)}</div>
      </div>`;
    }else{
      elTransmis.innerHTML='';
    }
  }
  
  // En attente: dateDepot ‚Üí dateResultat
  const elAttente=document.getElementById('wf-pec-duree-enattente');
  if(elAttente){
    if(record.dateDepot){
      const duree=record.dateResultat?calculerDureeEntrePEC(record.dateDepot,record.dateResultat):null;
      elAttente.innerHTML=`<div style="font-size:0.65em;line-height:1.3;margin-top:5px">
        <div style="color:#10b981">‚ñ∂ ${fmtDateCourtPEC(record.dateDepot)}</div>
        ${record.dateResultat?`<div style="color:#ef4444">‚ñ† ${fmtDateCourtPEC(record.dateResultat)}</div>`:''}
        ${duree?`<div style="color:#0066cc;font-weight:600">${duree}</div>`:''}
      </div>`;
    }else{
      elAttente.innerHTML='';
    }
  }
  
  // Demande d'info: (si statut = Demande d'information)
  const elInfo=document.getElementById('wf-pec-duree-demandeinfo');
  if(elInfo){
    if(record.statut==="Demande d'information"){
      elInfo.innerHTML=`<div style="font-size:0.65em;line-height:1.3;margin-top:5px;color:#8b5cf6">En cours</div>`;
    }else{
      elInfo.innerHTML='';
    }
  }
  
  // Accord√©: dateResultat ‚Üí dateTransmissionDocs
  const elAccorde=document.getElementById('wf-pec-duree-accorde');
  if(elAccorde){
    if(record.dateResultat&&record.statut==='Accord√©'){
      const duree=record.dateTransmissionDocs?calculerDureeEntrePEC(record.dateResultat,record.dateTransmissionDocs):null;
      elAccorde.innerHTML=`<div style="font-size:0.65em;line-height:1.3;margin-top:5px">
        <div style="color:#10b981">‚ñ∂ ${fmtDateCourtPEC(record.dateResultat)}</div>
        ${record.dateTransmissionDocs?`<div style="color:#ef4444">‚ñ† ${fmtDateCourtPEC(record.dateTransmissionDocs)}</div>`:''}
        ${duree?`<div style="color:#0066cc;font-weight:600">${duree}</div>`:''}
      </div>`;
    }else{
      elAccorde.innerHTML='';
    }
  }
  
  // Docs transmis: dateTransmissionDocs ‚Üí dateEncaissement
  const elDocs=document.getElementById('wf-pec-duree-docs');
  if(elDocs){
    if(record.dateTransmissionDocs){
      const duree=record.dateEncaissement?calculerDureeEntrePEC(record.dateTransmissionDocs,record.dateEncaissement):null;
      elDocs.innerHTML=`<div style="font-size:0.65em;line-height:1.3;margin-top:5px">
        <div style="color:#10b981">‚ñ∂ ${fmtDateCourtPEC(record.dateTransmissionDocs)}</div>
        ${record.dateEncaissement?`<div style="color:#ef4444">‚ñ† ${fmtDateCourtPEC(record.dateEncaissement)}</div>`:''}
        ${duree?`<div style="color:#0066cc;font-weight:600">${duree}</div>`:''}
      </div>`;
    }else{
      elDocs.innerHTML='';
    }
  }
  
  // Encaiss√©: dateEncaissement
  const elEncaisse=document.getElementById('wf-pec-duree-encaisse');
  if(elEncaisse){
    if(record.dateEncaissement){
      elEncaisse.innerHTML=`<div style="font-size:0.65em;line-height:1.3;margin-top:5px">
        <div style="color:#10b981">‚úì ${fmtDateCourtPEC(record.dateEncaissement)}</div>
      </div>`;
    }else{
      elEncaisse.innerHTML='';
    }
  }
}

function afficherDureesMoyennesPEC(filtered){
  // Dur√©e moyenne D√©p√¥t ‚Üí R√©sultat (attente r√©ponse OPCO)
  const dureesAttente=[];
  filtered.forEach(p=>{
    if(p.dateDepot&&p.dateResultat){
      const diff=diffJoursPEC(p.dateDepot,p.dateResultat);
      if(diff>=0) dureesAttente.push(diff);
    }
  });
  
  // Dur√©e moyenne R√©sultat ‚Üí Transmission docs
  const dureesDocs=[];
  filtered.forEach(p=>{
    if(p.dateResultat&&p.dateTransmissionDocs){
      const diff=diffJoursPEC(p.dateResultat,p.dateTransmissionDocs);
      if(diff>=0) dureesDocs.push(diff);
    }
  });
  
  // Dur√©e moyenne Transmission docs ‚Üí Encaissement
  const dureesEncaissement=[];
  filtered.forEach(p=>{
    if(p.dateTransmissionDocs&&p.dateEncaissement){
      const diff=diffJoursPEC(p.dateTransmissionDocs,p.dateEncaissement);
      if(diff>=0) dureesEncaissement.push(diff);
    }
  });
  
  // Afficher les dur√©es moyennes
  const etapes=[
    {id:'transmis',duree:null},
    {id:'enattente',duree:dureesAttente.length?formatDureePEC(dureesAttente.reduce((a,b)=>a+b,0)/dureesAttente.length):null},
    {id:'demandeinfo',duree:null},
    {id:'accorde',duree:dureesDocs.length?formatDureePEC(dureesDocs.reduce((a,b)=>a+b,0)/dureesDocs.length):null},
    {id:'docs',duree:dureesEncaissement.length?formatDureePEC(dureesEncaissement.reduce((a,b)=>a+b,0)/dureesEncaissement.length):null},
    {id:'encaisse',duree:null}
  ];
  
  etapes.forEach(e=>{
    const el=document.getElementById('wf-pec-duree-'+e.id);
    if(el){
      if(e.duree){
        el.innerHTML=`<div style="font-size:0.65em;margin-top:5px;background:#f1f5f9;padding:2px 6px;border-radius:4px;color:#64748b">‚åÄ ${e.duree}</div>`;
      }else{
        el.innerHTML='';
      }
    }
  });
}

function updateStatsDPC(){
  const total=dpcData.length;
  const transmis=dpcData.filter(d=>d.statut==='Transmis').length;
  const accordes=dpcData.filter(d=>d.statut==='Accord√©').length;
  const montantAccorde=dpcData.filter(d=>d.statut==='Accord√©').reduce((s,d)=>s+(parseFloat(d.montantAccorde)||0),0);
  const montantEncaisse=dpcData.filter(d=>d.dateEncaissement).reduce((s,d)=>s+(parseFloat(d.montantAccorde)||parseFloat(d.montantDemande)||0),0);
  
  if(document.getElementById('stat-dpc-total')) document.getElementById('stat-dpc-total').textContent=total;
  if(document.getElementById('stat-dpc-transmis')) document.getElementById('stat-dpc-transmis').textContent=transmis;
  if(document.getElementById('stat-dpc-accordes')) document.getElementById('stat-dpc-accordes').textContent=accordes;
  if(document.getElementById('stat-dpc-montant')) document.getElementById('stat-dpc-montant').textContent=fmtMoney(montantAccorde);
  if(document.getElementById('stat-dpc-encaisse')) document.getElementById('stat-dpc-encaisse').textContent=fmtMoney(montantEncaisse);
}

function diffJoursPEC(date1,date2){
  const d1=new Date(date1);
  const d2=new Date(date2);
  return Math.round((d2-d1)/(1000*60*60*24));
}

function formatDureePEC(jours){
  jours=Math.round(jours);
  if(jours===0) return '< 1j';
  if(jours===1) return '1j';
  if(jours<7) return `${jours}j`;
  if(jours<30) return `${Math.round(jours/7)}sem`;
  return `${Math.round(jours/30)}mois`;
}

function fmtDateCourtPEC(date){
  if(!date) return '';
  const d=new Date(date);
  return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'});
}

function calculerDureeEntrePEC(date1,date2){
  if(!date1||!date2) return null;
  const diff=diffJoursPEC(date1,date2);
  if(diff<0) return null;
  return formatDureePEC(diff);
}

function filtrerPECParEtape(etape){
  filtrePECEtape=etape;
  
  const filtreActif=document.getElementById('filtre-pec-etape-actif');
  const filtreLabel=document.getElementById('filtre-pec-etape-label');
  
  if(etape){
    filtreActif.style.display='block';
    const etapeLabels={
      Transmis:'üì§ Transmis',
      EnAttente:'‚è≥ En attente',
      DemandeInfo:'‚ùì Demande d\'info',
      Accorde:'‚úÖ Accord√©',
      DocsTransmis:'üìÑ Docs transmis',
      Encaisse:'üí∞ Encaiss√©'
    };
    filtreLabel.textContent=`Filtre: ${etapeLabels[etape]||etape}`;
    
    // Mettre en √©vidence l'√©tape active
    document.querySelectorAll('#page-dpc .wf-step').forEach(step=>{
      step.classList.toggle('active',step.dataset.etape===etape);
    });
  }else{
    filtreActif.style.display='none';
    document.querySelectorAll('#page-dpc .wf-step').forEach(step=>{
      step.classList.remove('active');
    });
  }
  
  filterDPC();
}

function resetFiltreDPC(){
  filtrePECEtape='';
  const filtreActif=document.getElementById('filtre-pec-etape-actif');
  if(filtreActif) filtreActif.style.display='none';
  if(document.getElementById('filter-dpc-entreprise')) document.getElementById('filter-dpc-entreprise').value='';
  if(document.getElementById('filter-dpc-opco')) document.getElementById('filter-dpc-opco').value='';
  document.querySelectorAll('#page-dpc .wf-step').forEach(step=>step.classList.remove('active'));
  filterDPC();
}

function filterDPC(){
  dbGetAll('conventions').then(conventions=>{
    dbGetAll('entreprises').then(entreprises=>{
      const convMap=Object.fromEntries(conventions.map(c=>[c.id,c]));
      const entMap=Object.fromEntries(entreprises.map(e=>[e.id,e]));
      renderDPC(convMap,entMap);
    });
  });
}

function renderDPC(convMap,entMap){
  const tbody=document.getElementById('table-dpc');
  if(!tbody)return;
  
  const search=(document.getElementById('search-dpc')?.value||'').toLowerCase();
  const filterEnt=document.getElementById('filter-dpc-entreprise')?.value;
  const filterOpco=document.getElementById('filter-dpc-opco')?.value;
  const filterStatut=document.getElementById('filter-dpc-statut')?.value;
  
  let filtered=dpcData.filter(d=>{
    const ent=entMap[d.entrepriseId]||{};
    const entNom=ent.nom||d.entreprise||'';
    if(search && !entNom.toLowerCase().includes(search) && !(d.numero||'').toLowerCase().includes(search) && !(d.opco||'').toLowerCase().includes(search)) return false;
    if(filterEnt && entNom!==filterEnt) return false;
    if(filterOpco && d.opco!==filterOpco) return false;
    if(filterStatut && d.statut!==filterStatut) return false;
    
    return true;
  });
  
  // Mettre √† jour le workflow PEC selon les r√©sultats filtr√©s
  updateWorkflowPEC(filtered);
  
  if(filtered.length===0){
    tbody.innerHTML='<tr><td colspan="13" class="empty">Aucune demande de prise en charge</td></tr>';
    return;
  }
  
  tbody.innerHTML=filtered.map(d=>{
    const conv=convMap[d.convention]||{};
    const ent=entMap[d.entrepriseId]||{};
    const entNom=ent.nom||d.entreprise||'-';
    const entId=d.entrepriseId?`ENT-${String(d.entrepriseId).padStart(3,'0')}`:'-';
    const numero=d.numero||`PEC-${String(d.id).padStart(3,'0')}`;
    
    // Statut avec couleur
    let statutClass='status-en-attente';
    if(d.statut==='Accord√©') statutClass='status-valide';
    else if(d.statut==='Refus√©'||d.statut==='Annul√©') statutClass='status-refuse';
    else if(d.statut==='Transmis') statutClass='status-envoye';
    else if(d.statut==="Demande d'information") statutClass='status-en-cours';
    
    return `<tr>
      <td><code>${esc(numero)}</code></td>
      <td><code>${entId}</code></td>
      <td>${esc(entNom)}</td>
      <td>${esc(d.opco||'-')}</td>
      <td class="montant">${fmtMoney(d.montantDemande||0)}</td>
      <td class="montant" style="color:#10b981;font-weight:600">${d.montantAccorde?fmtMoney(d.montantAccorde):'-'}</td>
      <td>${fmtDate(d.dateDepot)||'-'}</td>
      <td>${fmtDate(d.dateResultat)||'-'}</td>
      <td><span class="status ${statutClass}">${d.statut||'En attente'}</span></td>
      <td>${fmtDate(d.dateTransmissionDocs)||'-'}</td>
      <td>${d.dateEncaissement?`<span style="color:#10b981;font-weight:600">${fmtDate(d.dateEncaissement)}</span>`:'-'}</td>
      <td>${d.courrierOpco?`<button class="btn btn-success btn-sm" onclick="voirCourrierOPCO(${d.id})">üìÑ</button>`:'<span style="color:#94a3b8">-</span>'}</td>
      <td class="action-btns">
        <button class="btn btn-info btn-icon" onclick="openModal('dpc',${d.id})" title="Modifier">‚úèÔ∏è</button>
        <button class="btn btn-warning btn-icon" onclick="uploadCourrierOPCO(${d.id})" title="Upload courrier">üì§</button>
        <button class="btn btn-danger btn-icon" onclick="confirmDelete('dpc',${d.id})" title="Supprimer">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

async function onSelectEntrepriseDPC(){
  const select=document.getElementById('f-entrepriseId');
  const input=document.getElementById('f-entreprise');
  if(select&&input){
    const opt=select.options[select.selectedIndex];
    input.value=opt?opt.text:'';
    
    // Auto-remplir IDCC et OPCO depuis l'entreprise
    if(select.value){
      const entreprise = await dbGet('entreprises', parseInt(select.value));
      if(entreprise){
        // Si l'entreprise a un IDCC, le s√©lectionner
        if(entreprise.idcc){
          const idccSelect = document.getElementById('f-idcc-dpc');
          if(idccSelect){
            for(let i=0; i<idccSelect.options.length; i++){
              if(idccSelect.options[i].value === entreprise.idcc){
                idccSelect.selectedIndex = i;
                onIDCCChangeDPC();
                break;
              }
            }
          }
        }
        // Si l'entreprise a un OPCO, le s√©lectionner
        if(entreprise.opco){
          const opcoSelect = document.getElementById('f-opco');
          if(opcoSelect){
            for(let i=0; i<opcoSelect.options.length; i++){
              if(opcoSelect.options[i].value === entreprise.opco || opcoSelect.options[i].text === entreprise.opco){
                opcoSelect.selectedIndex = i;
                break;
              }
            }
          }
        }
        // Si l'entreprise a un secteur, le remplir
        if(entreprise.secteurActivite){
          const secteurField = document.getElementById('f-secteurActivite-dpc');
          if(secteurField) secteurField.value = entreprise.secteurActivite;
        }
      }
    }
  }
}

function previewCourrierOPCO(input){
  const preview=document.getElementById('f-courrierOpco-preview');
  if(!preview)return;
  
  if(input.files&&input.files[0]){
    const file=input.files[0];
    if(file.size>10*1024*1024){
      toast('Fichier trop volumineux (max 10 Mo)','error');
      input.value='';
      return;
    }
    preview.innerHTML=`<div style="color:#10b981;font-weight:600">‚úÖ ${esc(file.name)} (${(file.size/1024).toFixed(1)} Ko)</div>`;
  }else{
    preview.innerHTML='';
  }
}

async function uploadCourrierOPCO(id){
  const modalHtml=`
    <div id="modal-upload-courrier" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;justify-content:center;align-items:center;padding:20px">
      <div style="background:#fff;border-radius:12px;width:500px;max-width:95%;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
        <div style="padding:20px;border-bottom:1px solid #e5e7eb;background:#f8fafc;border-radius:12px 12px 0 0">
          <h3 style="margin:0;color:#0066cc">üì§ Upload Courrier OPCO</h3>
        </div>
        <div style="padding:20px">
          <div style="border:2px dashed #cbd5e1;border-radius:8px;padding:30px;text-align:center;background:#f8fafc">
            <input type="file" id="upload-courrier-file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="previewUploadCourrier(this)">
            <div style="font-size:2.5rem;margin-bottom:15px">üìÑ</div>
            <button type="button" class="btn btn-primary" onclick="document.getElementById('upload-courrier-file').click()">üìÅ S√©lectionner un fichier</button>
            <p style="margin-top:10px;color:#64748b;font-size:0.85em">PDF, JPG ou PNG (max 10 Mo)</p>
            <div id="upload-courrier-preview" style="margin-top:15px"></div>
          </div>
        </div>
        <div style="padding:15px 20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;background:#f8fafc;border-radius:0 0 12px 12px">
          <button class="btn btn-secondary" onclick="document.getElementById('modal-upload-courrier').remove()">Annuler</button>
          <button class="btn btn-primary" onclick="confirmerUploadCourrier(${id})">üíæ Enregistrer</button>
        </div>
      </div>
    </div>`;
  
  document.body.insertAdjacentHTML('beforeend',modalHtml);
}

function previewUploadCourrier(input){
  const preview=document.getElementById('upload-courrier-preview');
  if(!preview)return;
  
  if(input.files&&input.files[0]){
    const file=input.files[0];
    if(file.size>10*1024*1024){
      toast('Fichier trop volumineux (max 10 Mo)','error');
      input.value='';
      return;
    }
    preview.innerHTML=`<div style="padding:10px;background:#d1fae5;border-radius:6px;color:#065f46;font-weight:600">‚úÖ ${esc(file.name)} (${(file.size/1024).toFixed(1)} Ko)</div>`;
  }else{
    preview.innerHTML='';
  }
}

async function confirmerUploadCourrier(id){
  const input=document.getElementById('upload-courrier-file');
  if(!input||!input.files||!input.files[0]){
    toast('Veuillez s√©lectionner un fichier','warning');
    return;
  }
  
  const file=input.files[0];
  const reader=new FileReader();
  
  reader.onload=async function(e){
    const dpc=await dbGet('dpc',id);
    if(!dpc){toast('DPC non trouv√©','error');return;}
    
    dpc.courrierOpco={
      data:e.target.result,
      name:file.name,
      type:file.type,
      size:file.size,
      dateUpload:new Date().toISOString()
    };
    
    await dbPut('dpc',dpc);
    document.getElementById('modal-upload-courrier').remove();
    toast('Courrier OPCO enregistr√© !','success');
    showDPC();
  };
  
  reader.readAsDataURL(file);
}

function voirCourrierOPCO(id){
  dbGet('dpc',id).then(dpc=>{
    if(!dpc||!dpc.courrierOpco){
      toast('Aucun courrier enregistr√©','warning');
      return;
    }
    
    const data=dpc.courrierOpco.data;
    const type=dpc.courrierOpco.type;
    const name=dpc.courrierOpco.name;
    
    if(type==='application/pdf'){
      const win=window.open('','_blank');
      win.document.write(`<html><head><title>${esc(name)}</title></head><body style="margin:0"><embed src="${data}" type="application/pdf" width="100%" height="100%"></body></html>`);
    }else{
      const win=window.open('','_blank');
      win.document.write(`<html><head><title>${esc(name)}</title></head><body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f1f5f9"><img src="${data}" style="max-width:100%;max-height:100vh"></body></html>`);
    }
  });
}

function genererPDFDPC(id){
  toast('G√©n√©ration PDF en cours...','info');
  // √Ä impl√©menter
}

// ============ DEMANDE INFOS STAGIAIRES ============
let selectedAnalyseForStagiaires=null;

async function ouvrirModalDemandeInfosStagiaires(){
  // Charger les analyses
  const analyses=await dbGetAll('analyses');
  const select=document.getElementById('demande-stag-analyse');
  
  select.innerHTML='<option value="">-- Choisir une analyse --</option>'+
    analyses.filter(a=>a.entreprise).map(a=>
      `<option value="${a.id}">${esc(a.entreprise||'')} - ${esc(a.formation||'Formation non pr√©cis√©e')} (${fmtDate(a.dateCreation)||''})</option>`
    ).join('');
  
  // R√©initialiser
  selectedAnalyseForStagiaires=null;
  document.getElementById('demande-stag-infos').style.display='none';
  document.getElementById('demande-stag-email-preview').style.display='none';
  document.getElementById('btn-envoyer-demande-stag').style.display='none';
  document.getElementById('btn-copier-tout-stag').style.display='none';
  
  document.getElementById('modal-demande-stagiaires').style.display='flex';
}

function fermerModalDemandeInfosStagiaires(){
  document.getElementById('modal-demande-stagiaires').style.display='none';
}

async function onSelectAnalyseForStagiaires(){
  const analyseId=document.getElementById('demande-stag-analyse').value;
  if(!analyseId){
    document.getElementById('demande-stag-infos').style.display='none';
    document.getElementById('demande-stag-email-preview').style.display='none';
    document.getElementById('btn-envoyer-demande-stag').style.display='none';
    document.getElementById('btn-copier-tout-stag').style.display='none';
    return;
  }
  
  const analyse=await dbGet('analyses',parseInt(analyseId));
  if(!analyse){
    toast('Analyse non trouv√©e','error');
    return;
  }
  
  selectedAnalyseForStagiaires=analyse;
  
  // Afficher les infos de l'analyse
  document.getElementById('demande-stag-entreprise').textContent=analyse.entreprise||'-';
  document.getElementById('demande-stag-contact').textContent=analyse.contact||'-';
  document.getElementById('demande-stag-email').textContent=analyse.email||'-';
  document.getElementById('demande-stag-formation').textContent=analyse.formation||'-';
  document.getElementById('demande-stag-nb').textContent=analyse.nbStagiaires||analyse.effectif||'-';
  document.getElementById('demande-stag-modalite').textContent=analyse.modalite||'-';
  document.getElementById('demande-stag-infos').style.display='block';
  
  // G√©n√©rer le lien du formulaire
  const baseUrl=window.location.origin+window.location.pathname;
  const lienFormulaire=`${baseUrl}?formulaire_stagiaires=1&analyseId=${analyseId}`;
  document.getElementById('demande-stag-lien').value=lienFormulaire;
  
  // Pr√©remplir l'email
  document.getElementById('demande-stag-destinataire').value=analyse.email||'';
  document.getElementById('demande-stag-objet').value=`Informations stagiaires - Formation ${analyse.formation||''}`;
  
  const message=`Bonjour ${analyse.contact||''},

Suite √† notre analyse de vos besoins de formation, nous vous remercions de bien vouloir nous transmettre les informations concernant les stagiaires qui participeront √† la formation "${analyse.formation||''}".

Pour faciliter cette d√©marche, merci de compl√©ter le formulaire en ligne accessible via ce lien :
${lienFormulaire}

Informations rappel :
- Entreprise : ${analyse.entreprise||'-'}
- Formation : ${analyse.formation||'-'}
- Nombre de stagiaires pr√©vu : ${analyse.nbStagiaires||analyse.effectif||'-'}
- Modalit√© : ${analyse.modalite||'-'}

Pour chaque stagiaire, nous aurons besoin des informations suivantes :
‚Ä¢ Civilit√©
‚Ä¢ Nom
‚Ä¢ Pr√©nom  
‚Ä¢ Fonction dans l'entreprise
‚Ä¢ Email
‚Ä¢ T√©l√©phone

Ces informations sont n√©cessaires pour √©tablir la convention de formation et les documents administratifs.

Nous restons √† votre disposition pour toute question.

Cordialement,
L'√©quipe Formation DesClick`;
  
  document.getElementById('demande-stag-message').value=message;
  
  // Afficher l'aper√ßu
  document.getElementById('demande-stag-email-preview').style.display='block';
  document.getElementById('btn-envoyer-demande-stag').style.display='inline-flex';
  document.getElementById('btn-copier-tout-stag').style.display='inline-flex';
}

function copierLienFormulaireStagiaires(){
  const lien=document.getElementById('demande-stag-lien').value;
  navigator.clipboard.writeText(lien).then(()=>{
    toast('Lien copi√© !','success');
  }).catch(()=>{
    // Fallback
    const input=document.getElementById('demande-stag-lien');
    input.select();
    document.execCommand('copy');
    toast('Lien copi√© !','success');
  });
}

function ouvrirEmailClient(){
  const destinataire=document.getElementById('demande-stag-destinataire').value;
  const objet=encodeURIComponent(document.getElementById('demande-stag-objet').value);
  const corps=encodeURIComponent(document.getElementById('demande-stag-message').value);
  
  window.open(`mailto:${destinataire}?subject=${objet}&body=${corps}`,'_blank');
}

function copierToutEmail(){
  const objet=document.getElementById('demande-stag-objet').value;
  const message=document.getElementById('demande-stag-message').value;
  const texte=`Objet: ${objet}\n\n${message}`;
  
  navigator.clipboard.writeText(texte).then(()=>{
    toast('Email copi√© dans le presse-papier !','success');
  }).catch(()=>{
    toast('Erreur lors de la copie','error');
  });
}

// ============ IMPORT STAGIAIRES ============
let stagiairesAImporter=[];

function ouvrirModalImportStagiaires(){
  document.getElementById('import-stagiaires-code').value='';
  document.getElementById('import-stagiaires-preview').style.display='none';
  document.getElementById('btn-confirmer-import').style.display='none';
  stagiairesAImporter=[];
  document.getElementById('modal-import-stagiaires').style.display='flex';
}

function fermerModalImportStagiaires(){
  document.getElementById('modal-import-stagiaires').style.display='none';
}

function previsualiserImportStagiaires(){
  const code=document.getElementById('import-stagiaires-code').value.trim();
  if(!code){
    toast('Veuillez coller un code','warning');
    return;
  }
  
  try{
    // D√©coder le code base64
    const jsonStr=decodeURIComponent(escape(atob(code)));
    const data=JSON.parse(jsonStr);
    
    if(data.type!=='STAGIAIRES_FORMATION'||!data.stagiaires||!Array.isArray(data.stagiaires)){
      toast('Code invalide ou format non reconnu','error');
      return;
    }
    
    stagiairesAImporter=data.stagiaires;
    const entreprise=data.entreprise||'Non sp√©cifi√©e';
    const formation=data.formation||'Non sp√©cifi√©e';
    
    // Afficher l'aper√ßu
    const liste=document.getElementById('import-stagiaires-liste');
    liste.innerHTML=`
      <div style="padding:10px;background:#f0f9ff;border-bottom:1px solid #e5e7eb">
        <strong>Entreprise:</strong> ${esc(entreprise)} | <strong>Formation:</strong> ${esc(formation)}
      </div>
      ${stagiairesAImporter.map((s,i)=>`
        <div style="padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px">
          <span style="background:#0066cc;color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8em">${i+1}</span>
          <div>
            <strong>${esc(s.civilite||'')} ${esc(s.nom||'')} ${esc(s.prenom||'')}</strong>
            <span style="color:#666;font-size:0.9em"> - ${esc(s.fonction||'')}</span>
            <div style="font-size:0.85em;color:#64748b">${esc(s.email||'')} ${s.telephone?'| '+esc(s.telephone):''}</div>
          </div>
        </div>
      `).join('')}
    `;
    
    // Stocker l'entreprise pour l'import
    stagiairesAImporter.forEach(s=>{
      s.entreprise=entreprise;
    });
    
    document.getElementById('import-stagiaires-preview').style.display='block';
    document.getElementById('btn-confirmer-import').style.display='inline-flex';
    toast(stagiairesAImporter.length+' stagiaire(s) d√©tect√©(s)','success');
    
  }catch(e){
    console.error('Erreur d√©codage:',e);
    toast('Erreur: code invalide ou corrompu','error');
  }
}

async function confirmerImportStagiaires(){
  if(stagiairesAImporter.length===0){
    toast('Aucun stagiaire √† importer','warning');
    return;
  }
  
  let importes=0;
  for(const s of stagiairesAImporter){
    try{
      await dbAdd('stagiaires',{
        civilite:s.civilite||'Mr.',
        nom:s.nom||'',
        prenom:s.prenom||'',
        fonction:s.fonction||'',
        email:s.email||'',
        telephone:s.telephone||'',
        entreprise:s.entreprise||'',
        statut:'Actif',
        dateCreation:new Date().toISOString(),
        source:'Import formulaire'
      });
      importes++;
    }catch(e){
      console.error('Erreur import stagiaire:',e);
    }
  }
  
  toast(importes+' stagiaire(s) import√©(s) avec succ√®s !','success');
  fermerModalImportStagiaires();
  
  // Rafra√Æchir la liste
  await showStagiaires();
}

async function showStagiaires(){
  stagiairesData=await dbGetAll('stagiaires');
  const ent=await dbGetAll('entreprises');
  stagiairesEntMap=Object.fromEntries(ent.map(e=>[e.id,e]));
  stagiairesData.sort((a,b)=>(a.nom||'').localeCompare(b.nom||''));
  
  // Remplir le filtre entreprises
  const filterEnt=document.getElementById('filter-stagiaires-entreprise');
  if(filterEnt){
    filterEnt.innerHTML='<option value="">Toutes entreprises</option>'+ent.map(e=>`<option value="${e.id}">${esc(e.nom)}</option>`).join('');
  }
  
  // Afficher/masquer les colonnes confidentielles selon le r√¥le
  const isAdminOrGest=currentUser&&(currentUser.role==='Admin'||currentUser.role==='Gestionnaire');
  document.querySelectorAll('.col-confidentiel').forEach(el=>{
    el.style.display=isAdminOrGest?'table-cell':'none';
  });
  
  renderStagiaires();
}

function filterStagiaires(){renderStagiaires();}

function renderStagiaires(){
  const searchTerm=(document.getElementById('search-stagiaires')?.value||'').toLowerCase();
  const entFilter=document.getElementById('filter-stagiaires-entreprise')?.value||'';
  const pshFilter=document.getElementById('filter-stagiaires-psh')?.value||'';
  
  let filtered=stagiairesData.filter(s=>{
    const ent=stagiairesEntMap[s.entreprise];
    const matchSearch=!searchTerm||
      (s.nom||'').toLowerCase().includes(searchTerm)||
      (s.prenom||'').toLowerCase().includes(searchTerm)||
      (s.email||'').toLowerCase().includes(searchTerm)||
      (ent&&ent.nom.toLowerCase().includes(searchTerm));
    const matchEnt=!entFilter||s.entreprise==entFilter;
    const matchPsh=!pshFilter||(pshFilter==='oui'&&s.psh)||(pshFilter==='non'&&!s.psh);
    return matchSearch&&matchEnt&&matchPsh;
  });
  
  const tbody=document.getElementById('table-stagiaires-main');
  const isAdminOrGest=currentUser&&(currentUser.role==='Admin'||currentUser.role==='Gestionnaire');
  
  if(!filtered.length){
    const colspan=isAdminOrGest?12:9;
    tbody.innerHTML=`<tr><td colspan="${colspan}" class="empty-state"><div class="empty-state-icon">üë•</div><h3>Aucun stagiaire</h3></td></tr>`;
    return;
  }
  
  tbody.innerHTML=filtered.map(s=>{
    const ent=stagiairesEntMap[s.entreprise];
    const confidentialCells=isAdminOrGest?`
      <td class="col-confidentiel">${s.dateNaissance?fmtDate(s.dateNaissance):'-'}</td>
      <td class="col-confidentiel">${esc(s.numSecu||'-')}</td>
      <td class="col-confidentiel">${s.tauxHoraire?fmtMoney(s.tauxHoraire):'-'}</td>
    `:'';
    
    return `<tr>
      <td><code>STG-${String(s.id).padStart(3,'0')}</code></td>
      <td><strong>${esc(s.nom||'-')}</strong></td>
      <td>${esc(s.prenom||'-')}</td>
      <td>${ent?esc(ent.nom):'-'}</td>
      <td>${esc(s.fonction||'-')}</td>
      <td>${s.email?`<a href="mailto:${esc(s.email)}">${esc(s.email)}</a>`:'-'}</td>
      <td>${esc(s.telephone||'-')}</td>
      <td>${s.psh?'<span style="color:#059669;font-weight:bold">‚úì PSH</span>':'-'}</td>
      ${confidentialCells}
      <td class="action-btns">
        <button class="btn btn-secondary btn-icon" onclick="openModal('stagiaire',${s.id})">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-icon" onclick="confirmDelete('stagiaires',${s.id})">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

// ============ SESSIONS ============
let sessionsData=[];
let sessionsEntMap={};
let sessionsFormMap={};
let sessionsLieuxMap={};
let sessionsStagMap={};

async function showSessions(){
  sessionsData=await dbGetAll('sessions');
  const [ent,form,lieux,stag]=await Promise.all([
    dbGetAll('entreprises'),dbGetAll('formations'),dbGetAll('lieux'),dbGetAll('stagiaires')
  ]);
  sessionsEntMap=Object.fromEntries(ent.map(e=>[e.id,e]));
  sessionsFormMap=Object.fromEntries(form.map(f=>[f.id,f]));
  sessionsLieuxMap=Object.fromEntries(lieux.map(l=>[l.id,l]));
  sessionsStagMap=Object.fromEntries(stag.map(s=>[s.id,s]));
  sessionsData.sort((a,b)=>new Date(b.dateCreation)-new Date(a.dateCreation));
  renderSessions();
}

function filterSessions(){renderSessions();}

function renderSessions(){
  const searchTerm=(document.getElementById('search-sessions')?.value||'').toLowerCase();
  const modaliteFilter=document.getElementById('filter-sessions-modalite')?.value||'';
  const statutFilter=document.getElementById('filter-sessions-statut')?.value||'';
  
  let filtered=sessionsData.filter(s=>{
    const ent=sessionsEntMap[s.entreprise];
    const form=sessionsFormMap[s.formation];
    const matchSearch=!searchTerm||
      (ent&&ent.nom.toLowerCase().includes(searchTerm))||
      (form&&form.nom.toLowerCase().includes(searchTerm))||
      (s.lieuIntra||'').toLowerCase().includes(searchTerm);
    const matchModalite=!modaliteFilter||s.modalite===modaliteFilter;
    const matchStatut=!statutFilter||s.statut===statutFilter;
    return matchSearch&&matchModalite&&matchStatut;
  });
  
  const tbody=document.getElementById('table-sessions');
  if(!filtered.length){
    tbody.innerHTML='<tr><td colspan="13" class="empty-state"><div class="empty-state-icon">üìÖ</div><h3>Aucune session</h3></td></tr>';
    return;
  }
  
  tbody.innerHTML=filtered.map(s=>{
    const ent=sessionsEntMap[s.entreprise];
    const form=sessionsFormMap[s.formation];
    const lieu=sessionsLieuxMap[s.lieu];
    const stagCount=s.stagiaires?s.stagiaires.split(',').filter(x=>x).length:0;
    const montant=s.typeChiffrage==='Forfait Journalier'?(s.nbJours||0)*(s.forfaitJour||0):s.typeChiffrage==='Forfait Horaire'?(s.tauxHoraire||0)*(s.nbHeures||0)*(s.nbStagiairesChiffrage||1):(s.montantGlobal||0);
    
    return `<tr>
      <td><code>SES-${String(s.id).padStart(3,'0')}</code></td>
      <td><strong>${form?esc(form.nom):'-'}</strong></td>
      <td>${ent?esc(ent.nom):'-'}</td>
      <td><span class="status status-${slug(s.typeFormation)}">${s.typeFormation||'Pr√©sentiel'}</span></td>
      <td><span class="priority priority-${s.modalite==='Intra'?'urgente':'normale'}">${s.modalite||'Inter'}</span></td>
      <td>${s.modalite==='Intra'?trunc(s.lieuIntra,15):(lieu?esc(lieu.nom):'-')}</td>
      <td>${s.dateDebutPrev?fmtDate(s.dateDebutPrev):'-'}</td>
      <td>${s.dateDebutEffective?fmtDate(s.dateDebutEffective):'-'}</td>
      <td>${stagCount}</td>
      <td><small>${s.typeChiffrage||'Forfait'}</small></td>
      <td><strong>${fmtMoney(montant)}</strong></td>
      <td><span class="status status-${slug(s.statut)}">${s.statut||'Planifi√©e'}</span></td>
      <td class="action-btns" style="white-space:nowrap">
        <button class="btn btn-sm" style="background:#f59e0b;color:#fff" onclick="genererQuestionnaireChaud(${s.id})" title="Questionnaire satisfaction √† chaud">üìã</button>
        <button class="btn btn-secondary btn-icon" onclick="openModal('session',${s.id})">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-icon" onclick="confirmDelete('sessions',${s.id})">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

// Gestion du changement de modalit√© (Inter/Intra)
function onSessionModaliteChange(){
  const modalite=document.getElementById('f-modalite')?.value;
  const lieuInterGroup=document.getElementById('group-lieu-inter');
  const lieuIntraGroup=document.getElementById('group-lieu-intra');
  
  if(modalite==='Intra'){
    if(lieuInterGroup)lieuInterGroup.style.display='none';
    if(lieuIntraGroup)lieuIntraGroup.style.display='block';
    onSessionEntrepriseChange(); // Mettre √† jour l'adresse
  }else{
    if(lieuInterGroup)lieuInterGroup.style.display='block';
    if(lieuIntraGroup)lieuIntraGroup.style.display='none';
  }
}

// Gestion du changement d'entreprise (pour l'adresse en Intra et les stagiaires)
async function onSessionEntrepriseChange(){
  const entrepriseId=document.getElementById('f-entreprise')?.value;
  const lieuIntraInput=document.getElementById('f-lieuIntra');
  const stagiairesList=document.getElementById('session-stagiaires-list');
  const stagiairesHidden=document.getElementById('f-stagiaires');
  const selectedStagiaires=(stagiairesHidden?.value||'').split(',').filter(s=>s);
  
  // Mettre √† jour l'adresse pour Intra
  if(entrepriseId&&lieuIntraInput){
    const ent=await dbGet('entreprises',parseInt(entrepriseId));
    if(ent){
      const adresse=`${ent.adresse||''} ${ent.codePostal||''} ${ent.ville||''}`.trim()||'Adresse non renseign√©e';
      lieuIntraInput.value=adresse;
    }
  }else if(lieuIntraInput){
    lieuIntraInput.value='';
  }
  
  // Charger les stagiaires de l'entreprise
  if(stagiairesList){
    if(!entrepriseId){
      stagiairesList.innerHTML='<tr><td colspan="5" style="padding:1rem;text-align:center;color:var(--gray-400)">S√©lectionnez une entreprise</td></tr>';
      return;
    }
    
    const allStag=await dbGetAll('stagiaires');
    const filtered=allStag.filter(s=>s.entreprise==entrepriseId);
    
    if(!filtered.length){
      stagiairesList.innerHTML='<tr><td colspan="5" style="padding:1rem;text-align:center;color:var(--gray-400)">Aucun stagiaire pour cette entreprise</td></tr>';
      return;
    }
    
    stagiairesList.innerHTML=filtered.map(s=>{
      const isChecked=selectedStagiaires.includes(String(s.id));
      return `<tr style="border-bottom:1px solid var(--gray-100)">
        <td style="padding:0.4rem;text-align:center"><input type="checkbox" class="stag-checkbox" value="${s.id}" ${isChecked?'checked':''} onchange="updateStagiairesSelection()"></td>
        <td style="padding:0.4rem"><code>STG-${String(s.id).padStart(3,'0')}</code></td>
        <td style="padding:0.4rem"><strong>${esc(s.nom||'-')}</strong></td>
        <td style="padding:0.4rem">${esc(s.prenom||'-')}</td>
        <td style="padding:0.4rem;text-align:center">${s.psh?'<span style="color:#059669">‚úì</span>':'-'}</td>
      </tr>`;
    }).join('');
    
    // Mettre √† jour le nombre de stagiaires pour le chiffrage horaire
    updateNbStagiairesChiffrage();
  }
}

// Mettre √† jour la s√©lection des stagiaires dans le champ hidden
function updateStagiairesSelection(){
  const checkboxes=document.querySelectorAll('.stag-checkbox:checked');
  const selected=Array.from(checkboxes).map(cb=>cb.value);
  const hiddenField=document.getElementById('f-stagiaires');
  if(hiddenField)hiddenField.value=selected.join(',');
  
  // Mettre √† jour le nombre de stagiaires pour le chiffrage horaire
  updateNbStagiairesChiffrage();
  
  // Mettre √† jour le checkbox "tout s√©lectionner"
  const allCheckboxes=document.querySelectorAll('.stag-checkbox');
  const checkAll=document.getElementById('check-all-stagiaires');
  if(checkAll)checkAll.checked=allCheckboxes.length>0&&checkboxes.length===allCheckboxes.length;
}

// S√©lectionner/D√©s√©lectionner tous les stagiaires
function toggleAllStagiaires(checked){
  document.querySelectorAll('.stag-checkbox').forEach(cb=>{cb.checked=checked;});
  updateStagiairesSelection();
}

// Mettre √† jour le nombre de stagiaires pour le chiffrage horaire
function updateNbStagiairesChiffrage(){
  const checkboxes=document.querySelectorAll('.stag-checkbox:checked');
  const nbStagField=document.getElementById('f-nbStagiairesChiffrage');
  if(nbStagField&&checkboxes.length>0){
    nbStagField.value=checkboxes.length;
    updateSessionMontant();
  }
}

// Gestion du changement de type de chiffrage
function onSessionChiffrageChange(){
  const type=document.getElementById('f-typeChiffrage')?.value;
  
  document.getElementById('chiffrage-forfait-total').style.display=type==='Forfait Total'?'block':'none';
  document.getElementById('chiffrage-forfait-journalier').style.display=type==='Forfait Journalier'?'block':'none';
  document.getElementById('chiffrage-forfait-horaire').style.display=type==='Forfait Horaire'?'block':'none';
  
  updateSessionMontant();
}

// Calcul du montant global
function updateSessionMontant(){
  const type=document.getElementById('f-typeChiffrage')?.value;
  
  if(type==='Forfait Journalier'){
    const nbJours=parseFloat(document.getElementById('f-nbJours')?.value)||0;
    const forfaitJour=parseFloat(document.getElementById('f-forfaitJour')?.value)||0;
    const montant=nbJours*forfaitJour;
    const montantField=document.getElementById('f-montantJournalier');
    if(montantField)montantField.value=montant.toFixed(2);
  }else if(type==='Forfait Horaire'){
    const tauxHoraire=parseFloat(document.getElementById('f-tauxHoraire')?.value)||0;
    const nbHeures=parseFloat(document.getElementById('f-nbHeures')?.value)||0;
    const nbStagiaires=parseFloat(document.getElementById('f-nbStagiairesChiffrage')?.value)||1;
    const montant=tauxHoraire*nbHeures*nbStagiaires;
    const montantField=document.getElementById('f-montantHoraire');
    if(montantField)montantField.value=montant.toFixed(2);
  }
}

// V√©rifier les disponibilit√©s des formateurs pour une p√©riode
async function verifierDisponibilitesFormateurs(){
  const dateDebut=document.getElementById('f-dateDebutPrev')?.value||document.getElementById('f-dateDebutEffective')?.value;
  const dateFin=document.getElementById('f-dateFinPrev')?.value||document.getElementById('f-dateFinEffective')?.value||dateDebut;
  
  if(!dateDebut){
    toast('Veuillez d\'abord s√©lectionner une date de d√©but','warning');
    return;
  }
  
  const debut=new Date(dateDebut);
  const fin=new Date(dateFin||dateDebut);
  
  // R√©cup√©rer les donn√©es n√©cessaires
  const [formateurs,agendaEvents,sessions,absences]=await Promise.all([
    dbGetAll('formateurs'),
    dbGetAll('agenda_events'),
    dbGetAll('sessions'),
    dbGetAll('absences_formateurs')
  ]);
  
  const formateursActifs=formateurs.filter(f=>f.statut==='Actif');
  const currentSessionId=document.getElementById('f-id')?.value;
  
  // Analyser chaque formateur
  const disponibles=[];
  const indisponibles=[];
  
  formateursActifs.forEach(f=>{
    const isInterne=f.type==='Interne';
    
    // 1. V√©rifier s'il y a une absence (uniquement pour les internes)
    if(isInterne){
      const absencesPeriode=absences.filter(a=>{
        if(a.formateurId!=f.id)return false;
        const aDebut=new Date(a.dateDebut);
        const aFin=new Date(a.dateFin);
        // V√©rifier chevauchement
        return debut<=aFin&&fin>=aDebut;
      });
      
      if(absencesPeriode.length>0){
        const absence=absencesPeriode[0];
        const typeAbsence=TYPES_ABSENCE.find(t=>t.code===absence.type)||{label:absence.type};
        indisponibles.push({
          formateur:f,
          raison:`${typeAbsence.label} du ${new Date(absence.dateDebut).toLocaleDateString('fr-FR')} au ${new Date(absence.dateFin).toLocaleDateString('fr-FR')}`,
          typeIndispo:'absence',
          couleur:typeAbsence.couleur||'#ef4444',
          sessions:[]
        });
        return; // Passer au formateur suivant
      }
    }
    
    // 2. V√©rifier s'il n'y a pas de conflit avec des sessions existantes
    const sessionsFormateur=sessions.filter(s=>
      s.formateur==f.id&&
      s.id!=currentSessionId&&
      s.statut!=='Annul√©e'
    );
    
    const sessionsConflit=sessionsFormateur.filter(s=>{
      const sDebut=new Date(s.dateDebutPrev||s.dateDebutEffective);
      const sFin=new Date(s.dateFinPrev||s.dateFinEffective||s.dateDebutPrev||s.dateDebutEffective);
      return debut<=sFin&&fin>=sDebut;
    });
    
    if(sessionsConflit.length>0){
      indisponibles.push({
        formateur:f,
        raison:'Session d√©j√† planifi√©e',
        typeIndispo:'session',
        couleur:'#8b5cf6',
        sessions:sessionsConflit
      });
      return;
    }
    
    // 3. V√©rifier disponibilit√©s (diff√©rent selon interne/externe)
    if(isInterne){
      // Formateur interne: disponible par d√©faut s'il n'est pas absent et pas en session
      const rdvFormateur=agendaEvents.filter(e=>
        e.formateurId==f.id&&
        e.type!=='disponibilite'&&
        new Date(e.date)>=debut&&
        new Date(e.date)<=fin
      );
      
      disponibles.push({
        formateur:f,
        disponibilite:null,
        rdv:rdvFormateur,
        typeFormateur:'interne'
      });
    }else{
      // Formateur externe: doit avoir d√©clar√© une disponibilit√©
      const disponibilites=agendaEvents.filter(e=>
        e.type==='disponibilite'&&
        e.formateurId==f.id
      );
      
      const aDisponibilite=disponibilites.some(d=>{
        const dDebut=new Date(d.date);
        const dFin=d.dateFin?new Date(d.dateFin):dDebut;
        return dDebut<=debut&&dFin>=fin;
      });
      
      const rdvFormateur=agendaEvents.filter(e=>
        e.formateurId==f.id&&
        e.type!=='disponibilite'&&
        new Date(e.date)>=debut&&
        new Date(e.date)<=fin
      );
      
      if(aDisponibilite){
        disponibles.push({
          formateur:f,
          disponibilite:disponibilites.find(d=>{
            const dDebut=new Date(d.date);
            const dFin=d.dateFin?new Date(d.dateFin):dDebut;
            return dDebut<=debut&&dFin>=fin;
          }),
          rdv:rdvFormateur,
          typeFormateur:'externe'
        });
      }else{
        indisponibles.push({
          formateur:f,
          raison:'Aucune disponibilit√© d√©clar√©e pour cette p√©riode',
          typeIndispo:'non_declare',
          couleur:'#9ca3af',
          sessions:[]
        });
      }
    }
  });
  
  // Trier: internes d'abord
  disponibles.sort((a,b)=>{
    if(a.typeFormateur==='interne'&&b.typeFormateur!=='interne')return -1;
    if(a.typeFormateur!=='interne'&&b.typeFormateur==='interne')return 1;
    return 0;
  });
  
  // Afficher les r√©sultats
  const dispoContainer=document.getElementById('session-formateurs-dispo');
  const indispoContainer=document.getElementById('session-formateurs-indispo');
  const dispoList=document.getElementById('session-formateurs-dispo-list');
  const indispoList=document.getElementById('session-formateurs-indispo-list');
  
  if(disponibles.length>0){
    dispoContainer.style.display='block';
    dispoList.innerHTML=disponibles.map(d=>`
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px;background:white;border-radius:6px;margin-bottom:6px;border:1px solid #86efac">
        <div>
          <strong>${esc(d.formateur.nom)} ${esc(d.formateur.prenom||'')}</strong>
          <span style="background:${d.typeFormateur==='interne'?'#3b82f6':'#10b981'};color:white;padding:2px 6px;border-radius:4px;font-size:0.7em;margin-left:8px">
            ${d.typeFormateur==='interne'?'üè¢ Interne':'üåê Externe'}
          </span>
          ${d.rdv&&d.rdv.length>0?`<span style="color:#f59e0b;font-size:0.75em;margin-left:8px">‚ö†Ô∏è ${d.rdv.length} RDV/t√¢che(s)</span>`:''}
          ${d.disponibilite?`<div style="font-size:0.75em;color:#6b7280;margin-top:4px">üìÖ Disponibilit√© d√©clar√©e du ${new Date(d.disponibilite.date).toLocaleDateString('fr-FR')} au ${new Date(d.disponibilite.dateFin||d.disponibilite.date).toLocaleDateString('fr-FR')}</div>`:''}
        </div>
        <button type="button" class="btn btn-success btn-sm" onclick="selectionnerFormateur(${d.formateur.id})" style="padding:4px 12px">
          ‚úì S√©lectionner
        </button>
      </div>
    `).join('');
  }else{
    dispoContainer.style.display='none';
  }
  
  if(indisponibles.length>0){
    indispoContainer.style.display='block';
    indispoList.innerHTML=indisponibles.map(d=>`
      <div style="padding:10px;background:white;border-radius:6px;margin-bottom:6px;border-left:4px solid ${d.couleur};font-size:0.85em">
        <div style="display:flex;align-items:center;gap:8px">
          <strong>${esc(d.formateur.nom)} ${esc(d.formateur.prenom||'')}</strong>
          <span style="background:${d.formateur.type==='Interne'?'#3b82f6':'#10b981'};color:white;padding:2px 6px;border-radius:4px;font-size:0.7em">
            ${d.formateur.type==='Interne'?'üè¢ Interne':'üåê Externe'}
          </span>
        </div>
        <div style="color:#991b1b;font-size:0.8em;margin-top:6px;display:flex;align-items:center;gap:6px">
          <span style="background:${d.couleur};width:8px;height:8px;border-radius:50%"></span>
          ${d.raison}
        </div>
        ${d.sessions.length>0?`<div style="font-size:0.75em;color:#6b7280;margin-top:4px">${d.sessions.map(s=>`‚Ä¢ Session du ${s.dateDebutPrev||s.dateDebutEffective}`).join('<br>')}</div>`:''}
      </div>
    `).join('');
  }else{
    indispoContainer.style.display='none';
  }
  
  if(disponibles.length===0&&indisponibles.length===0){
    toast('Aucun formateur trouv√©','warning');
  }else{
    toast(`${disponibles.length} formateur(s) disponible(s), ${indisponibles.length} indisponible(s)`,'info');
  }
}

// S√©lectionner un formateur depuis la liste des disponibilit√©s
function selectionnerFormateur(formateurId){
  const select=document.getElementById('f-formateur');
  if(select){
    select.value=formateurId;
    toast('Formateur s√©lectionn√©','success');
  }
}

// ============ GESTION DES ABSENCES FORMATEURS ============
const TYPES_ABSENCE=[
  {code:'conges',label:'üèñÔ∏è Cong√©s pay√©s',couleur:'#3b82f6'},
  {code:'maladie',label:'üè• Maladie',couleur:'#ef4444'},
  {code:'formation',label:'üìö En formation',couleur:'#8b5cf6'},
  {code:'conges_exceptionnels',label:'üéâ Cong√©s exceptionnels',couleur:'#f59e0b'},
  {code:'autre',label:'üìå Autre absence',couleur:'#6b7280'}
];

// Couleurs attribu√©es aux formateurs (pour diff√©renciation visuelle)
const COULEURS_FORMATEURS=[
  '#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6',
  '#06b6d4','#ec4899','#84cc16','#f97316','#6366f1',
  '#14b8a6','#a855f7','#eab308','#22c55e','#e11d48'
];

// √âtat global pour le calendrier des disponibilit√©s
let calendrierDispoState={
  moisActuel:new Date().getMonth(),
  anneeActuelle:new Date().getFullYear(),
  formateurSelectionne:null,
  typeAction:'indisponibilite', // 'disponibilite' ou 'indisponibilite'
  joursSelectionnes:new Set()
};

async function ouvrirGestionAbsences(){
  const [formateurs,absences,agendaEvents]=await Promise.all([
    dbGetAll('formateurs'),
    dbGetAll('absences_formateurs'),
    dbGetAll('agenda_events')
  ]);
  
  const formateursActifs=formateurs.filter(f=>f.statut==='Actif');
  
  // Attribuer une couleur √† chaque formateur
  formateursActifs.forEach((f,i)=>{
    f.couleur=f.couleur||COULEURS_FORMATEURS[i%COULEURS_FORMATEURS.length];
  });
  
  // R√©initialiser l'√©tat
  calendrierDispoState={
    moisActuel:new Date().getMonth(),
    anneeActuelle:new Date().getFullYear(),
    formateurSelectionne:null,
    typeAction:'indisponibilite',
    joursSelectionnes:new Set()
  };
  
  const modal=document.createElement('div');
  modal.className='modal-overlay active';
  modal.id='modal-gestion-absences';
  modal.innerHTML=`
    <div class="modal" style="max-width:1100px;max-height:95vh;overflow:hidden;display:flex;flex-direction:column">
      <div class="modal-header" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white">
        <h3 class="modal-title">üìÖ Gestion des disponibilit√©s / indisponibilit√©s</h3>
        <button class="modal-close" onclick="document.getElementById('modal-gestion-absences').remove()" style="color:white">√ó</button>
      </div>
      <div class="modal-body" style="overflow-y:auto;flex:1;padding:15px">
        <div style="display:grid;grid-template-columns:300px 1fr;gap:20px">
          <!-- Colonne gauche: Formateurs et options -->
          <div>
            <!-- S√©lection du formateur -->
            <div style="background:#f8fafc;padding:15px;border-radius:10px;margin-bottom:15px;border:1px solid #e5e7eb">
              <h4 style="margin:0 0 10px 0;font-size:0.9em;color:#374151">üë§ S√©lectionner un formateur</h4>
              <div id="liste-formateurs-dispo" style="max-height:200px;overflow-y:auto">
                ${formateursActifs.map((f,i)=>`
                  <div class="formateur-item" onclick="selectFormateurDispo(${f.id})" data-id="${f.id}"
                    style="display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;cursor:pointer;margin-bottom:4px;border:2px solid transparent;transition:all 0.2s">
                    <span style="width:12px;height:12px;background:${f.couleur};border-radius:50%;flex-shrink:0"></span>
                    <span style="flex:1;font-size:0.85em"><strong>${esc(f.nom)}</strong> ${esc(f.prenom||'')}</span>
                    <span style="font-size:0.7em;background:${f.type==='Interne'?'#3b82f6':'#10b981'};color:white;padding:2px 6px;border-radius:4px">${f.type==='Interne'?'Int':'Ext'}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- Type d'action -->
            <div id="options-action" style="display:none;background:#f8fafc;padding:15px;border-radius:10px;margin-bottom:15px;border:1px solid #e5e7eb">
              <h4 style="margin:0 0 10px 0;font-size:0.9em;color:#374151">‚öôÔ∏è Type de d√©claration</h4>
              <div style="display:flex;gap:8px;margin-bottom:15px">
                <button id="btn-type-indispo" class="btn btn-sm" onclick="setTypeActionDispo('indisponibilite')" style="flex:1;background:#ef4444;color:white;border:none">
                  üö´ Indisponibilit√©
                </button>
                <button id="btn-type-dispo" class="btn btn-sm" onclick="setTypeActionDispo('disponibilite')" style="flex:1;background:#e5e7eb;color:#374151;border:none">
                  ‚úÖ Disponibilit√©
                </button>
              </div>
              
              <div id="options-indispo">
                <label class="form-label" style="font-size:0.85em">Type d'absence</label>
                <select class="form-select" id="absence-type-calendrier" style="font-size:0.85em">
                  ${TYPES_ABSENCE.map(t=>`<option value="${t.code}">${t.label}</option>`).join('')}
                </select>
              </div>
              
              <div id="options-dispo" style="display:none">
                <p style="font-size:0.8em;color:#6b7280;margin:0">
                  Pour les formateurs externes, d√©clarez les jours o√π ils sont disponibles.
                </p>
              </div>
              
              <div style="margin-top:15px">
                <label class="form-label" style="font-size:0.85em">Commentaire (optionnel)</label>
                <input class="form-input" id="dispo-commentaire" placeholder="Motif..." style="font-size:0.85em">
              </div>
            </div>
            
            <!-- Jours s√©lectionn√©s -->
            <div id="jours-selectionnes-container" style="display:none;background:#ecfdf5;padding:15px;border-radius:10px;border:1px solid #10b981">
              <h4 style="margin:0 0 10px 0;font-size:0.9em;color:#059669">üìã Jours s√©lectionn√©s</h4>
              <div id="jours-selectionnes-liste" style="font-size:0.85em;max-height:100px;overflow-y:auto"></div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button class="btn btn-sm btn-success" onclick="enregistrerJoursSelectionnes()" style="flex:1">üíæ Enregistrer</button>
                <button class="btn btn-sm btn-secondary" onclick="annulerSelection()" style="flex:1">‚úñÔ∏è Annuler</button>
              </div>
            </div>
          </div>
          
          <!-- Colonne droite: Calendrier -->
          <div>
            <!-- Navigation mois -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px">
              <button class="btn btn-sm btn-secondary" onclick="naviguerMoisDispo(-1)">‚óÄ Pr√©c√©dent</button>
              <h3 id="titre-mois-calendrier" style="margin:0;color:#1e293b"></h3>
              <button class="btn btn-sm btn-secondary" onclick="naviguerMoisDispo(1)">Suivant ‚ñ∂</button>
            </div>
            
            <!-- Calendrier -->
            <div id="mini-calendrier-dispo" style="background:white;border-radius:10px;border:1px solid #e5e7eb;overflow:hidden"></div>
            
            <!-- L√©gende -->
            <div style="margin-top:15px;padding:10px;background:#f8fafc;border-radius:8px;display:flex;flex-wrap:wrap;gap:15px;font-size:0.75em">
              <span><span style="display:inline-block;width:12px;height:12px;background:#fee2e2;border:1px solid #fca5a5;border-radius:3px"></span> Indisponible</span>
              <span><span style="display:inline-block;width:12px;height:12px;background:#dcfce7;border:1px solid #86efac;border-radius:3px"></span> Disponible</span>
              <span><span style="display:inline-block;width:12px;height:12px;background:#e0e7ff;border:1px solid #a5b4fc;border-radius:3px"></span> En session</span>
              <span><span style="display:inline-block;width:12px;height:12px;background:#fef3c7;border:2px solid #fbbf24;border-radius:3px"></span> S√©lectionn√©</span>
            </div>
          </div>
        </div>
        
        <!-- Liste des p√©riodes d√©clar√©es -->
        <div style="margin-top:20px">
          <h4 style="margin:0 0 15px 0;color:#374151">üìã P√©riodes d√©clar√©es</h4>
          <div id="liste-periodes-declarees">${renderPeriodesDeclarees(absences,agendaEvents,formateurs)}</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('modal-gestion-absences').remove()">Fermer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Afficher le calendrier initial
  renderCalendrierDispo();
}

function selectFormateurDispo(formateurId){
  calendrierDispoState.formateurSelectionne=formateurId;
  calendrierDispoState.joursSelectionnes.clear();
  
  // Mettre √† jour l'affichage des formateurs
  document.querySelectorAll('.formateur-item').forEach(el=>{
    const id=parseInt(el.dataset.id);
    if(id===formateurId){
      el.style.background='#eff6ff';
      el.style.borderColor='#3b82f6';
    }else{
      el.style.background='';
      el.style.borderColor='transparent';
    }
  });
  
  // Afficher les options
  document.getElementById('options-action').style.display='block';
  document.getElementById('jours-selectionnes-container').style.display='none';
  
  // Rafra√Æchir le calendrier
  renderCalendrierDispo();
}

function setTypeActionDispo(type){
  calendrierDispoState.typeAction=type;
  calendrierDispoState.joursSelectionnes.clear();
  
  const btnIndispo=document.getElementById('btn-type-indispo');
  const btnDispo=document.getElementById('btn-type-dispo');
  
  if(type==='indisponibilite'){
    btnIndispo.style.background='#ef4444';
    btnIndispo.style.color='white';
    btnDispo.style.background='#e5e7eb';
    btnDispo.style.color='#374151';
    document.getElementById('options-indispo').style.display='block';
    document.getElementById('options-dispo').style.display='none';
  }else{
    btnDispo.style.background='#10b981';
    btnDispo.style.color='white';
    btnIndispo.style.background='#e5e7eb';
    btnIndispo.style.color='#374151';
    document.getElementById('options-indispo').style.display='none';
    document.getElementById('options-dispo').style.display='block';
  }
  
  document.getElementById('jours-selectionnes-container').style.display='none';
  renderCalendrierDispo();
}

function naviguerMoisDispo(delta){
  calendrierDispoState.moisActuel+=delta;
  if(calendrierDispoState.moisActuel>11){
    calendrierDispoState.moisActuel=0;
    calendrierDispoState.anneeActuelle++;
  }else if(calendrierDispoState.moisActuel<0){
    calendrierDispoState.moisActuel=11;
    calendrierDispoState.anneeActuelle--;
  }
  renderCalendrierDispo();
}

async function renderCalendrierDispo(){
  const {moisActuel,anneeActuelle,formateurSelectionne}=calendrierDispoState;
  
  // Titre du mois
  const nomsMois=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
  document.getElementById('titre-mois-calendrier').textContent=`${nomsMois[moisActuel]} ${anneeActuelle}`;
  
  // Charger les donn√©es
  const [absences,agendaEvents,sessions,formateurs]=await Promise.all([
    dbGetAll('absences_formateurs'),
    dbGetAll('agenda_events'),
    dbGetAll('sessions'),
    dbGetAll('formateurs')
  ]);
  
  // Premier jour du mois et nombre de jours
  const premierJour=new Date(anneeActuelle,moisActuel,1);
  const dernierJour=new Date(anneeActuelle,moisActuel+1,0);
  const nbJours=dernierJour.getDate();
  const jourDebutSemaine=(premierJour.getDay()+6)%7; // Lundi = 0
  
  const today=new Date();
  today.setHours(0,0,0,0);
  
  // Cr√©er le tableau des √©v√©nements par jour pour tous les formateurs
  const evenementsParJour={};
  
  // Absences (indisponibilit√©s)
  absences.forEach(a=>{
    const debut=new Date(a.dateDebut);
    const fin=new Date(a.dateFin);
    for(let d=new Date(debut);d<=fin;d.setDate(d.getDate()+1)){
      if(d.getMonth()===moisActuel&&d.getFullYear()===anneeActuelle){
        const key=d.getDate();
        if(!evenementsParJour[key])evenementsParJour[key]=[];
        const formateur=formateurs.find(f=>f.id==a.formateurId);
        evenementsParJour[key].push({
          type:'absence',
          formateurId:a.formateurId,
          formateurNom:formateur?`${formateur.nom} ${formateur.prenom||''}`:'',
          formateurCouleur:formateur?.couleur||'#6b7280',
          typeAbsence:a.type,
          motif:a.motif
        });
      }
    }
  });
  
  // Disponibilit√©s d√©clar√©es
  agendaEvents.filter(e=>e.type==='disponibilite').forEach(e=>{
    const debut=new Date(e.date);
    const fin=e.dateFin?new Date(e.dateFin):debut;
    for(let d=new Date(debut);d<=fin;d.setDate(d.getDate()+1)){
      if(d.getMonth()===moisActuel&&d.getFullYear()===anneeActuelle){
        const key=d.getDate();
        if(!evenementsParJour[key])evenementsParJour[key]=[];
        const formateur=formateurs.find(f=>f.id==e.formateurId);
        evenementsParJour[key].push({
          type:'disponibilite',
          formateurId:e.formateurId,
          formateurNom:formateur?`${formateur.nom} ${formateur.prenom||''}`:'',
          formateurCouleur:formateur?.couleur||'#6b7280'
        });
      }
    }
  });
  
  // Sessions
  sessions.filter(s=>s.statut!=='Annul√©e').forEach(s=>{
    const debut=new Date(s.dateDebutPrev||s.dateDebutEffective);
    const fin=new Date(s.dateFinPrev||s.dateFinEffective||debut);
    for(let d=new Date(debut);d<=fin;d.setDate(d.getDate()+1)){
      if(d.getMonth()===moisActuel&&d.getFullYear()===anneeActuelle){
        const key=d.getDate();
        if(!evenementsParJour[key])evenementsParJour[key]=[];
        const formateur=formateurs.find(f=>f.id==s.formateur);
        evenementsParJour[key].push({
          type:'session',
          formateurId:s.formateur,
          formateurNom:formateur?`${formateur.nom} ${formateur.prenom||''}`:'',
          formateurCouleur:formateur?.couleur||'#6b7280'
        });
      }
    }
  });
  
  // Construire le HTML du calendrier
  let html=`
    <table style="width:100%;border-collapse:collapse">
      <thead>
        <tr style="background:#f1f5f9">
          <th style="padding:10px;text-align:center;font-size:0.8em;color:#64748b">Lun</th>
          <th style="padding:10px;text-align:center;font-size:0.8em;color:#64748b">Mar</th>
          <th style="padding:10px;text-align:center;font-size:0.8em;color:#64748b">Mer</th>
          <th style="padding:10px;text-align:center;font-size:0.8em;color:#64748b">Jeu</th>
          <th style="padding:10px;text-align:center;font-size:0.8em;color:#64748b">Ven</th>
          <th style="padding:10px;text-align:center;font-size:0.8em;color:#9ca3af">Sam</th>
          <th style="padding:10px;text-align:center;font-size:0.8em;color:#9ca3af">Dim</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  let jour=1;
  for(let semaine=0;semaine<6;semaine++){
    if(jour>nbJours)break;
    html+=`<tr>`;
    for(let jourSemaine=0;jourSemaine<7;jourSemaine++){
      if((semaine===0&&jourSemaine<jourDebutSemaine)||jour>nbJours){
        html+=`<td style="padding:5px;border:1px solid #e5e7eb;background:#f8fafc"></td>`;
      }else{
        const dateJour=new Date(anneeActuelle,moisActuel,jour);
        const isToday=dateJour.getTime()===today.getTime();
        const isWeekend=jourSemaine>=5;
        const isPast=dateJour<today;
        const eventsJour=evenementsParJour[jour]||[];
        
        // Filtrer par formateur s√©lectionn√©
        const eventsFormateurSelectionne=formateurSelectionne?
          eventsJour.filter(e=>e.formateurId==formateurSelectionne):[];
        
        // D√©terminer la couleur de fond
        let bgColor='white';
        let borderColor='#e5e7eb';
        
        if(calendrierDispoState.joursSelectionnes.has(jour)){
          bgColor='#fef3c7';
          borderColor='#fbbf24';
        }else if(formateurSelectionne&&eventsFormateurSelectionne.length>0){
          const hasAbsence=eventsFormateurSelectionne.some(e=>e.type==='absence');
          const hasDispo=eventsFormateurSelectionne.some(e=>e.type==='disponibilite');
          const hasSession=eventsFormateurSelectionne.some(e=>e.type==='session');
          if(hasSession){bgColor='#e0e7ff';borderColor='#a5b4fc';}
          else if(hasAbsence){bgColor='#fee2e2';borderColor='#fca5a5';}
          else if(hasDispo){bgColor='#dcfce7';borderColor='#86efac';}
        }
        
        if(isWeekend&&bgColor==='white')bgColor='#f8fafc';
        if(isPast&&bgColor==='white')bgColor='#f1f5f9';
        
        // Points color√©s pour les √©v√©nements de tous les formateurs
        let dotsHtml='';
        if(eventsJour.length>0&&!formateurSelectionne){
          const uniqueFormateurs=[...new Set(eventsJour.map(e=>e.formateurId))];
          dotsHtml=`<div style="display:flex;gap:2px;justify-content:center;flex-wrap:wrap;margin-top:2px">
            ${uniqueFormateurs.slice(0,4).map(fId=>{
              const evt=eventsJour.find(e=>e.formateurId===fId);
              return `<span style="width:6px;height:6px;background:${evt?.formateurCouleur||'#6b7280'};border-radius:50%"></span>`;
            }).join('')}
            ${uniqueFormateurs.length>4?`<span style="font-size:0.6em;color:#6b7280">+${uniqueFormateurs.length-4}</span>`:''}
          </div>`;
        }
        
        const clickable=formateurSelectionne&&!isPast;
        
        html+=`
          <td onclick="${clickable?`toggleJourDispo(${jour})`:''}" 
            style="padding:5px;border:1px solid ${borderColor};background:${bgColor};vertical-align:top;min-height:50px;height:60px;
              ${clickable?'cursor:pointer;':''}${isToday?'box-shadow:inset 0 0 0 2px #3b82f6;':''}">
            <div style="font-weight:${isToday?'700':'500'};font-size:0.85em;color:${isWeekend?'#9ca3af':'#374151'}">${jour}</div>
            ${dotsHtml}
          </td>
        `;
        jour++;
      }
    }
    html+=`</tr>`;
  }
  
  html+=`</tbody></table>`;
  document.getElementById('mini-calendrier-dispo').innerHTML=html;
}

function toggleJourDispo(jour){
  if(!calendrierDispoState.formateurSelectionne)return;
  
  if(calendrierDispoState.joursSelectionnes.has(jour)){
    calendrierDispoState.joursSelectionnes.delete(jour);
  }else{
    calendrierDispoState.joursSelectionnes.add(jour);
  }
  
  // Mettre √† jour l'affichage des jours s√©lectionn√©s
  updateJoursSelectionnesAffichage();
  renderCalendrierDispo();
}

function updateJoursSelectionnesAffichage(){
  const container=document.getElementById('jours-selectionnes-container');
  const liste=document.getElementById('jours-selectionnes-liste');
  
  if(calendrierDispoState.joursSelectionnes.size===0){
    container.style.display='none';
    return;
  }
  
  container.style.display='block';
  const jours=[...calendrierDispoState.joursSelectionnes].sort((a,b)=>a-b);
  const {moisActuel,anneeActuelle}=calendrierDispoState;
  
  liste.innerHTML=jours.map(j=>{
    const date=new Date(anneeActuelle,moisActuel,j);
    return `<span style="display:inline-block;background:#fef3c7;padding:2px 6px;border-radius:4px;margin:2px;font-size:0.8em">${date.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric'})}</span>`;
  }).join('');
}

function annulerSelection(){
  calendrierDispoState.joursSelectionnes.clear();
  document.getElementById('jours-selectionnes-container').style.display='none';
  renderCalendrierDispo();
}

async function enregistrerJoursSelectionnes(){
  const {formateurSelectionne,typeAction,joursSelectionnes,moisActuel,anneeActuelle}=calendrierDispoState;
  
  if(!formateurSelectionne||joursSelectionnes.size===0){
    toast('S√©lectionnez au moins un jour','warning');
    return;
  }
  
  const jours=[...joursSelectionnes].sort((a,b)=>a-b);
  const commentaire=document.getElementById('dispo-commentaire').value;
  
  // Regrouper les jours cons√©cutifs en p√©riodes
  const periodes=[];
  let debutPeriode=jours[0];
  let finPeriode=jours[0];
  
  for(let i=1;i<=jours.length;i++){
    if(i<jours.length&&jours[i]===finPeriode+1){
      finPeriode=jours[i];
    }else{
      periodes.push({debut:debutPeriode,fin:finPeriode});
      if(i<jours.length){
        debutPeriode=jours[i];
        finPeriode=jours[i];
      }
    }
  }
  
  // Enregistrer chaque p√©riode
  for(const p of periodes){
    const dateDebut=new Date(anneeActuelle,moisActuel,p.debut).toISOString().split('T')[0];
    const dateFin=new Date(anneeActuelle,moisActuel,p.fin).toISOString().split('T')[0];
    
    if(typeAction==='indisponibilite'){
      const typeAbsence=document.getElementById('absence-type-calendrier').value;
      await dbAdd('absences_formateurs',{
        formateurId:formateurSelectionne,
        type:typeAbsence,
        dateDebut,
        dateFin,
        motif:commentaire,
        createdAt:new Date().toISOString()
      });
    }else{
      await dbAdd('agenda_events',{
        type:'disponibilite',
        formateurId:formateurSelectionne,
        date:dateDebut,
        dateFin:dateFin,
        titre:'Disponibilit√©',
        description:commentaire,
        createdAt:new Date().toISOString()
      });
    }
  }
  
  toast(`${periodes.length} p√©riode(s) enregistr√©e(s)`,'success');
  
  // Rafra√Æchir
  calendrierDispoState.joursSelectionnes.clear();
  document.getElementById('jours-selectionnes-container').style.display='none';
  document.getElementById('dispo-commentaire').value='';
  
  const [absences,agendaEvents,formateurs]=await Promise.all([
    dbGetAll('absences_formateurs'),
    dbGetAll('agenda_events'),
    dbGetAll('formateurs')
  ]);
  document.getElementById('liste-periodes-declarees').innerHTML=renderPeriodesDeclarees(absences,agendaEvents,formateurs);
  renderCalendrierDispo();
}

function renderPeriodesDeclarees(absences,agendaEvents,formateurs){
  const formateurMap={};
  formateurs.forEach(f=>{
    f.couleur=f.couleur||COULEURS_FORMATEURS[formateurs.indexOf(f)%COULEURS_FORMATEURS.length];
    formateurMap[f.id]=f;
  });
  
  const periodes=[];
  
  // Absences
  absences.forEach(a=>{
    const f=formateurMap[a.formateurId];
    const type=TYPES_ABSENCE.find(t=>t.code===a.type)||{label:a.type,couleur:'#6b7280'};
    periodes.push({
      id:a.id,
      store:'absences_formateurs',
      type:'indisponibilite',
      formateurId:a.formateurId,
      formateurNom:f?`${f.nom} ${f.prenom||''}`:'',
      formateurCouleur:f?.couleur||'#6b7280',
      label:type.label,
      couleur:type.couleur,
      dateDebut:new Date(a.dateDebut),
      dateFin:new Date(a.dateFin),
      motif:a.motif
    });
  });
  
  // Disponibilit√©s
  agendaEvents.filter(e=>e.type==='disponibilite').forEach(e=>{
    const f=formateurMap[e.formateurId];
    periodes.push({
      id:e.id,
      store:'agenda_events',
      type:'disponibilite',
      formateurId:e.formateurId,
      formateurNom:f?`${f.nom} ${f.prenom||''}`:'',
      formateurCouleur:f?.couleur||'#6b7280',
      label:'‚úÖ Disponible',
      couleur:'#10b981',
      dateDebut:new Date(e.date),
      dateFin:e.dateFin?new Date(e.dateFin):new Date(e.date),
      motif:e.description
    });
  });
  
  if(periodes.length===0){
    return '<div style="text-align:center;padding:20px;color:#9ca3af">Aucune p√©riode d√©clar√©e</div>';
  }
  
  // Trier par date d√©croissante
  periodes.sort((a,b)=>b.dateDebut-a.dateDebut);
  
  const today=new Date();
  today.setHours(0,0,0,0);
  
  return `<div style="display:grid;gap:8px;max-height:300px;overflow-y:auto">
    ${periodes.map(p=>{
      const isPast=p.dateFin<today;
      const isNow=p.dateDebut<=today&&p.dateFin>=today;
      return `
        <div style="display:flex;align-items:center;gap:10px;padding:10px;background:${isPast?'#f8fafc':'white'};border-radius:8px;border-left:4px solid ${p.formateurCouleur};${isPast?'opacity:0.7;':''}">
          <span style="width:10px;height:10px;background:${p.formateurCouleur};border-radius:50%;flex-shrink:0"></span>
          <div style="flex:1;min-width:0">
            <div style="font-weight:600;font-size:0.85em">${esc(p.formateurNom)}</div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-size:0.8em">
              <span style="background:${p.couleur};color:white;padding:2px 6px;border-radius:4px">${p.label}</span>
              <span style="color:#6b7280">${p.dateDebut.toLocaleDateString('fr-FR')} - ${p.dateFin.toLocaleDateString('fr-FR')}</span>
              ${isNow?'<span style="background:#f59e0b;color:white;padding:2px 6px;border-radius:4px;font-size:0.75em">EN COURS</span>':''}
            </div>
            ${p.motif?`<div style="font-size:0.75em;color:#6b7280;margin-top:2px">${esc(p.motif)}</div>`:''}
          </div>
          <button onclick="supprimerPeriode('${p.store}',${p.id})" class="btn btn-sm btn-danger" style="padding:4px 8px;flex-shrink:0">üóëÔ∏è</button>
        </div>
      `;
    }).join('')}
  </div>`;
}

async function supprimerPeriode(store,id){
  if(!confirm('Supprimer cette p√©riode ?'))return;
  await dbDelete(store,id);
  toast('P√©riode supprim√©e','success');
  
  const [absences,agendaEvents,formateurs]=await Promise.all([
    dbGetAll('absences_formateurs'),
    dbGetAll('agenda_events'),
    dbGetAll('formateurs')
  ]);
  document.getElementById('liste-periodes-declarees').innerHTML=renderPeriodesDeclarees(absences,agendaEvents,formateurs);
  renderCalendrierDispo();
}

function renderListeAbsences(absences,formateurs){
  if(!absences||absences.length===0){
    return '<div style="text-align:center;padding:30px;color:#9ca3af"><p>Aucune absence enregistr√©e</p></div>';
  }
  
  const formateurMap={};
  formateurs.forEach(f=>formateurMap[f.id]=f);
  
  // Trier par date d√©but d√©croissante
  absences.sort((a,b)=>new Date(b.dateDebut)-new Date(a.dateDebut));
  
  const today=new Date();
  today.setHours(0,0,0,0);
  
  return `<table style="width:100%;font-size:0.85em">
    <thead style="background:#f1f5f9">
      <tr>
        <th style="padding:10px;text-align:left">Formateur</th>
        <th style="padding:10px;text-align:left">Type</th>
        <th style="padding:10px;text-align:center">Du</th>
        <th style="padding:10px;text-align:center">Au</th>
        <th style="padding:10px;text-align:left">Motif</th>
        <th style="padding:10px;text-align:center">Statut</th>
        <th style="padding:10px;text-align:center">Actions</th>
      </tr>
    </thead>
    <tbody>
      ${absences.map(a=>{
        const f=formateurMap[a.formateurId];
        const type=TYPES_ABSENCE.find(t=>t.code===a.type)||{label:a.type,couleur:'#6b7280'};
        const debut=new Date(a.dateDebut);
        const fin=new Date(a.dateFin);
        let statut='passee';
        let statutLabel='Pass√©e';
        let statutColor='#9ca3af';
        if(debut<=today&&fin>=today){
          statut='encours';
          statutLabel='En cours';
          statutColor='#f59e0b';
        }else if(debut>today){
          statut='avenir';
          statutLabel='√Ä venir';
          statutColor='#3b82f6';
        }
        return `<tr style="border-bottom:1px solid #e5e7eb">
          <td style="padding:10px"><strong>${f?esc(f.nom)+' '+esc(f.prenom||''):'-'}</strong></td>
          <td style="padding:10px"><span style="background:${type.couleur};color:white;padding:2px 8px;border-radius:4px;font-size:0.8em">${type.label}</span></td>
          <td style="padding:10px;text-align:center">${new Date(a.dateDebut).toLocaleDateString('fr-FR')}</td>
          <td style="padding:10px;text-align:center">${new Date(a.dateFin).toLocaleDateString('fr-FR')}</td>
          <td style="padding:10px;color:#6b7280">${esc(a.motif||'-')}</td>
          <td style="padding:10px;text-align:center"><span style="background:${statutColor};color:white;padding:2px 8px;border-radius:4px;font-size:0.75em">${statutLabel}</span></td>
          <td style="padding:10px;text-align:center">
            <button class="btn btn-sm btn-danger" onclick="supprimerAbsence(${a.id})" style="padding:4px 8px">üóëÔ∏è</button>
          </td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

async function enregistrerAbsence(){
  const formateurId=document.getElementById('absence-formateur').value;
  const type=document.getElementById('absence-type').value;
  const dateDebut=document.getElementById('absence-debut').value;
  const dateFin=document.getElementById('absence-fin').value;
  const motif=document.getElementById('absence-motif').value;
  
  if(!formateurId||!type||!dateDebut||!dateFin){
    toast('Veuillez remplir tous les champs obligatoires','warning');
    return;
  }
  
  if(new Date(dateFin)<new Date(dateDebut)){
    toast('La date de fin doit √™tre apr√®s la date de d√©but','warning');
    return;
  }
  
  await dbAdd('absences_formateurs',{
    formateurId:parseInt(formateurId),
    type,
    dateDebut,
    dateFin,
    motif,
    createdAt:new Date().toISOString()
  });
  
  toast('Absence enregistr√©e','success');
  
  // Rafra√Æchir la liste
  const [formateurs,absences]=await Promise.all([
    dbGetAll('formateurs'),
    dbGetAll('absences_formateurs')
  ]);
  document.getElementById('liste-absences-modal').innerHTML=renderListeAbsences(absences,formateurs);
  
  // R√©initialiser le formulaire
  document.getElementById('absence-motif').value='';
}

async function supprimerAbsence(id){
  if(!confirm('Supprimer cette absence ?'))return;
  await dbDelete('absences_formateurs',id);
  toast('Absence supprim√©e','success');
  
  const [formateurs,absences]=await Promise.all([
    dbGetAll('formateurs'),
    dbGetAll('absences_formateurs')
  ]);
  const listeModal=document.getElementById('liste-absences-modal');
  if(listeModal)listeModal.innerHTML=renderListeAbsences(absences,formateurs);
}

// Afficher les absences en cours dans la section formateurs
async function afficherAbsencesEnCours(){
  const [formateurs,absences]=await Promise.all([
    dbGetAll('formateurs'),
    dbGetAll('absences_formateurs')
  ]);
  
  const today=new Date();
  today.setHours(0,0,0,0);
  const dans30jours=new Date(today);
  dans30jours.setDate(dans30jours.getDate()+30);
  
  // Filtrer les absences en cours ou √† venir dans les 30 jours
  const absencesActuelles=absences.filter(a=>{
    const fin=new Date(a.dateFin);
    const debut=new Date(a.dateDebut);
    return fin>=today&&debut<=dans30jours;
  });
  
  const container=document.getElementById('absences-en-cours');
  const liste=document.getElementById('liste-absences-en-cours');
  
  if(absencesActuelles.length===0){
    container.style.display='none';
    return;
  }
  
  const formateurMap={};
  formateurs.forEach(f=>formateurMap[f.id]=f);
  
  container.style.display='block';
  liste.innerHTML=absencesActuelles.map(a=>{
    const f=formateurMap[a.formateurId];
    const type=TYPES_ABSENCE.find(t=>t.code===a.type)||{label:a.type,couleur:'#6b7280'};
    const debut=new Date(a.dateDebut);
    const fin=new Date(a.dateFin);
    const isNow=debut<=today&&fin>=today;
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px;background:white;border-radius:6px;margin-bottom:6px;border-left:3px solid ${type.couleur}">
      <span style="font-weight:600">${f?esc(f.nom)+' '+esc(f.prenom||''):'-'}</span>
      <span style="background:${type.couleur};color:white;padding:2px 6px;border-radius:4px;font-size:0.75em">${type.label}</span>
      <span style="color:#6b7280;font-size:0.85em">du ${debut.toLocaleDateString('fr-FR')} au ${fin.toLocaleDateString('fr-FR')}</span>
      ${isNow?'<span style="background:#ef4444;color:white;padding:2px 6px;border-radius:4px;font-size:0.7em">EN COURS</span>':''}
    </div>`;
  }).join('');
}

// Obtenir le statut de disponibilit√© d'un formateur pour aujourd'hui
async function getStatutDisponibiliteFormateur(formateurId,formateur){
  const [absences,sessions,agendaEvents]=await Promise.all([
    dbGetAll('absences_formateurs'),
    dbGetAll('sessions'),
    dbGetAll('agenda_events')
  ]);
  
  const today=new Date();
  today.setHours(0,0,0,0);
  
  // Pour les formateurs internes: v√©rifier absences
  if(formateur.type==='Interne'){
    const absenceEnCours=absences.find(a=>{
      if(a.formateurId!=formateurId)return false;
      const debut=new Date(a.dateDebut);
      const fin=new Date(a.dateFin);
      return debut<=today&&fin>=today;
    });
    
    if(absenceEnCours){
      const type=TYPES_ABSENCE.find(t=>t.code===absenceEnCours.type);
      return {statut:'absent',label:type?.label||'Absent',couleur:type?.couleur||'#ef4444'};
    }
    
    // V√©rifier si en session aujourd'hui
    const sessionAujourdhui=sessions.find(s=>{
      if(s.formateur!=formateurId||s.statut==='Annul√©e')return false;
      const debut=new Date(s.dateDebutPrev||s.dateDebutEffective);
      const fin=new Date(s.dateFinPrev||s.dateFinEffective||debut);
      return debut<=today&&fin>=today;
    });
    
    if(sessionAujourdhui){
      return {statut:'session',label:'En formation',couleur:'#8b5cf6'};
    }
    
    return {statut:'disponible',label:'Disponible',couleur:'#10b981'};
  }
  
  // Pour les formateurs externes: v√©rifier disponibilit√©s d√©clar√©es
  const disponibilite=agendaEvents.find(e=>{
    if(e.type!=='disponibilite'||e.formateurId!=formateurId)return false;
    const debut=new Date(e.date);
    const fin=e.dateFin?new Date(e.dateFin):debut;
    return debut<=today&&fin>=today;
  });
  
  if(disponibilite){
    return {statut:'disponible',label:'Disponible',couleur:'#10b981'};
  }
  
  // V√©rifier si en session
  const sessionAujourdhui=sessions.find(s=>{
    if(s.formateur!=formateurId||s.statut==='Annul√©e')return false;
    const debut=new Date(s.dateDebutPrev||s.dateDebutEffective);
    const fin=new Date(s.dateFinPrev||s.dateFinEffective||debut);
    return debut<=today&&fin>=today;
  });
  
  if(sessionAujourdhui){
    return {statut:'session',label:'En formation',couleur:'#8b5cf6'};
  }
  
  return {statut:'inconnu',label:'Non d√©clar√©',couleur:'#9ca3af'};
}

// ============ INDICATEURS QUALIOPI PAR ONGLET ============

// Calcul centralis√© des indicateurs Qualiopi
async function calculerIndicateursQualiopi(){
  const [demandes,analyses,evaluations,sessions,stagiaires,formations,formateurs,satisfactions,reclamations,attestations,emargements,evalPre,evalPost,devis,conventions,dpc,conceptions]=await Promise.all([
    dbGetAll('demandes'),
    dbGetAll('analyses'),
    dbGetAll('evaluations'),
    dbGetAll('sessions'),
    dbGetAll('stagiaires'),
    dbGetAll('formations'),
    dbGetAll('formateurs'),
    dbGetAll('satisfactions'),
    dbGetAll('reclamations'),
    dbGetAll('attestations'),
    dbGetAll('emargements'),
    dbGetAll('evalPre'),
    dbGetAll('evalPost'),
    dbGetAll('devis'),
    dbGetAll('conventions'),
    dbGetAll('dpc'),
    dbGetAll('conceptions')
  ]);
  
  const today=new Date();
  const derniers30j=new Date(today);derniers30j.setDate(derniers30j.getDate()-30);
  
  // ====== CRIT√àRE 1: Information du public ======
  // 1.1 Formations avec programme complet
  const formationsAvecProgramme=formations.filter(f=>f.objectifs&&f.contenu&&f.duree);
  const tauxProgramme=formations.length>0?Math.round((formationsAvecProgramme.length/formations.length)*100):0;
  
  // 1.2 Indicateurs de r√©sultats (taux satisfaction)
  const satisfactionsRecentes=satisfactions.filter(s=>new Date(s.date)>=derniers30j);
  const tauxSatisfaction=satisfactions.length>0?Math.round(satisfactions.reduce((a,s)=>a+(s.noteGlobale||0),0)/satisfactions.length*20):0;
  
  // 1.4 D√©lais d'acc√®s (demandes trait√©es < 48h)
  const demandesTraitees=demandes.filter(d=>d.statut==='Trait√©'||d.statut==='Converti'||d.statut==='Analys√©');
  const demandesRapides=demandesTraitees.filter(d=>{
    if(!d.dateTraitement&&!d.dateModification)return false;
    const dateRef=d.dateTraitement||d.dateModification;
    const dateDebut=d.dateReception||d.dateCreation||d.date;
    if(!dateDebut)return false;
    const diff=(new Date(dateRef)-new Date(dateDebut))/(1000*60*60);
    return diff<=48;
  });
  const tauxDelaiAcces=demandesTraitees.length>0?Math.round((demandesRapides.length/demandesTraitees.length)*100):100;
  const delaiMoyenDemandes=demandesTraitees.length>0?Math.round(demandesTraitees.reduce((a,d)=>{
    const dateRef=d.dateTraitement||d.dateModification;
    const dateDebut=d.dateReception||d.dateCreation||d.date;
    if(!dateRef||!dateDebut)return a;
    return a+(new Date(dateRef)-new Date(dateDebut))/(1000*60*60);
  },0)/demandesTraitees.length):0;
  const nbDemandesEnAttente=demandes.filter(d=>d.statut==='Nouveau'||d.statut==='En attente'||!d.statut).length;
  
  // ====== CRIT√àRE 2: Identification des objectifs ======
  // 2.1 Analyses du besoin r√©alis√©es (analyses cr√©√©es / demandes)
  const analysesRealisees=analyses.filter(a=>a.statut!=='Annul√©');
  const tauxAnalyses=demandes.length>0?Math.round((analysesRealisees.length/demandes.length)*100):100;
  
  // 2.2 Questionnaires envoy√©s et r√©ponses re√ßues
  const analysesEnvoyees=analyses.filter(a=>a.statut==='Envoy√©'||a.statut==='En attente'||a.statut==='R√©ponse re√ßue');
  const analysesAvecReponse=analyses.filter(a=>a.statut==='R√©ponse re√ßue');
  const tauxReponsesAnalyse=analysesEnvoyees.length>0?Math.round((analysesAvecReponse.length/analysesEnvoyees.length)*100):0;
  const nbAnalysesEnAttente=analyses.filter(a=>a.statut==='Envoy√©'||a.statut==='En attente').length;
  const nbAnalysesReponseRecue=analysesAvecReponse.length;
  
  // 2.3 √âvaluations des besoins r√©alis√©es
  const evaluationsRealisees=evaluations.filter(e=>e.statut!=='Annul√©');
  const evaluationsValidees=evaluations.filter(e=>e.statut==='Valid√©'||e.statut==='Session cr√©√©e');
  const tauxEvaluations=analysesAvecReponse.length>0?Math.round((evaluationsRealisees.length/analysesAvecReponse.length)*100):0;
  const nbEvaluationsATraiter=evaluations.filter(e=>e.statut==='√Ä traiter'||e.statut==='En cours').length;
  const nbEvaluationsValidees=evaluationsValidees.length;
  const nbSessionsCreees=evaluations.filter(e=>e.statut==='Session cr√©√©e').length;
  
  // 2.3 Positionnements pr√©alables (stagiaires avec √©valuation pr√©-formation)
  const stagAvecPositionnement=stagiaires.filter(s=>evalPre.some(e=>e.stagiaire==s.id));
  const tauxPositionnement=stagiaires.length>0?Math.round((stagAvecPositionnement.length/stagiaires.length)*100):0;
  
  // 2.4 Adaptation PSH (stagiaires PSH identifi√©s)
  const stagiairesPSH=stagiaires.filter(s=>s.psh==='Oui'||s.psh===true);
  const nbPSH=stagiairesPSH.length;
  
  // ====== CRIT√àRE 3: Adaptation des prestations ======
  // 3.1 Proc√©dures de positionnement appliqu√©es
  // (m√™me calcul que 2.3)
  
  // ====== CRIT√àRE 4: Moyens p√©dagogiques ======
  // 4.1 Sessions avec formateur assign√©
  const sessionsAvecFormateur=sessions.filter(s=>s.formateur);
  const tauxFormateurAssigne=sessions.length>0?Math.round((sessionsAvecFormateur.length/sessions.length)*100):100;
  
  // 4.2 Taux d'√©margement
  const sessionsTerminees=sessions.filter(s=>s.statut==='Termin√©e');
  const emargementParSession={};
  emargements.forEach(e=>{emargementParSession[e.sessionId]=(emargementParSession[e.sessionId]||0)+1;});
  const sessionsAvecEmargement=sessionsTerminees.filter(s=>emargementParSession[s.id]);
  const tauxEmargement=sessionsTerminees.length>0?Math.round((sessionsAvecEmargement.length/sessionsTerminees.length)*100):100;
  
  // ====== CRIT√àRE 5: Qualification des personnels ======
  // 5.1 Formateurs avec qualifications renseign√©es
  const formateursAvecCV=formateurs.filter(f=>f.specialites||f.cv||f.diplomes);
  const tauxFormateursQualifies=formateurs.length>0?Math.round((formateursAvecCV.length/formateurs.length)*100):0;
  
  // ====== CRIT√àRE 6: Inscription OF ======
  // (documents administratifs - g√©r√© dans onglet Qualiopi)
  
  // ====== CRIT√àRE 7: Am√©lioration continue ======
  // 7.1 Taux de retour questionnaires satisfaction
  const tauxRetourSatisfaction=sessionsTerminees.length>0?Math.round((satisfactions.length/Math.max(sessionsTerminees.length*3,1))*100):0;
  
  // 7.2 R√©clamations trait√©es < 72h
  const reclamationsTraitees=reclamations.filter(r=>r.statut==='Trait√©'||r.statut==='Cl√¥tur√©');
  const reclamationsRapides=reclamationsTraitees.filter(r=>{
    if(!r.dateTraitement||!r.date)return true;
    return ((new Date(r.dateTraitement)-new Date(r.date))/(1000*60*60))<=72;
  });
  const tauxReclamations72h=reclamationsTraitees.length>0?Math.round((reclamationsRapides.length/reclamationsTraitees.length)*100):100;
  const reclamationsEnAttente=reclamations.filter(r=>r.statut==='Nouveau'||r.statut==='En cours').length;
  
  // 7.3 Attestations g√©n√©r√©es
  const stagAvecAttestation=stagiaires.filter(s=>attestations.some(a=>a.stagiaire==s.id));
  const tauxAttestations=stagiaires.length>0?Math.round((stagAvecAttestation.length/stagiaires.length)*100):0;
  
  // ====== DEVIS ======
  const devisEnvoyes=devis.filter(d=>d.statut==='Envoy√©'||d.statut==='Accept√©'||d.statut==='Sign√©');
  const devisAcceptes=devis.filter(d=>d.statut==='Accept√©'||d.statut==='Sign√©');
  const tauxConversionDevis=devisEnvoyes.length>0?Math.round((devisAcceptes.length/devisEnvoyes.length)*100):0;
  const devisEnAttente=devis.filter(d=>d.statut==='Brouillon'||d.statut==='En attente'||d.statut==='Envoy√©').length;
  
  // ====== CONVENTIONS ======
  const conventionsSignees=conventions.filter(c=>c.statut==='Sign√©e'||c.statut==='Valid√©e');
  const tauxConventionsSignees=conventions.length>0?Math.round((conventionsSignees.length/conventions.length)*100):0;
  const conventionsEnAttente=conventions.filter(c=>c.statut==='En attente signature'||c.statut==='Brouillon'||c.statut==='Envoy√©e').length;
  
  // ====== DPC/PEC ======
  const pecAccordees=dpc.filter(p=>p.statut==='Accord√©');
  const pecTransmises=dpc.filter(p=>p.statut==='Transmis'||p.statut==='Accord√©'||p.statut==='Refus√©');
  const tauxPecAccordees=pecTransmises.length>0?Math.round((pecAccordees.length/pecTransmises.length)*100):0;
  const pecEnAttente=dpc.filter(p=>p.statut==='Transmis'||p.statut==="Demande d'information").length;
  const montantPecAccorde=pecAccordees.reduce((a,p)=>a+(parseFloat(p.montantAccorde)||0),0);
  
  // ====== CONCEPTION ======
  const conceptionsTerminees=conceptions.filter(c=>c.statut==='Termin√©'||c.statut==='Documents g√©n√©r√©s');
  const tauxConceptionTerminee=conceptions.length>0?Math.round((conceptionsTerminees.length/conceptions.length)*100):0;
  const conceptionsAVerifier=conceptions.filter(c=>c.statut==='En attente v√©rification'||c.statut==='Dates √† modifier').length;
  
  // Score global par crit√®re
  const scoreCritere1=Math.round((tauxProgramme+Math.min(tauxSatisfaction,100)+tauxDelaiAcces)/3);
  const scoreCritere2=Math.round((tauxAnalyses+tauxEvaluations+tauxPositionnement+100)/4); // 100 pour PSH identifi√©s
  const scoreCritere3=Math.round(tauxPositionnement);
  const scoreCritere4=Math.round((tauxFormateurAssigne+tauxEmargement)/2);
  const scoreCritere5=Math.round(tauxFormateursQualifies);
  const scoreCritere6=50; // Documents admin - √† √©valuer manuellement
  const scoreCritere7=Math.round((Math.min(tauxRetourSatisfaction,100)+tauxReclamations72h+tauxAttestations)/3);
  
  const scoreGlobal=Math.round((scoreCritere1+scoreCritere2+scoreCritere3+scoreCritere4+scoreCritere5+scoreCritere6+scoreCritere7)/7);
  
  return {
    // Crit√®re 1
    tauxProgramme,tauxSatisfaction,tauxDelaiAcces,delaiMoyenDemandes,
    // Crit√®re 2 - Analyses
    tauxAnalyses,nbAnalyses:analyses.length,nbAnalysesEnAttente,nbAnalysesReponseRecue,tauxReponsesAnalyse,
    // Crit√®re 2 - √âvaluations
    tauxEvaluations,nbEvaluations:evaluations.length,nbEvaluationsATraiter,nbEvaluationsValidees,nbSessionsCreees,
    // Crit√®re 2 - Positionnement
    tauxPositionnement,nbPSH,
    // Crit√®re 4
    tauxFormateurAssigne,tauxEmargement,
    // Crit√®re 5
    tauxFormateursQualifies,
    // Crit√®re 7
    tauxRetourSatisfaction,tauxReclamations72h,tauxAttestations,reclamationsEnAttente,
    // Scores
    scoreCritere1,scoreCritere2,scoreCritere3,scoreCritere4,scoreCritere5,scoreCritere6,scoreCritere7,scoreGlobal,
    // Compteurs
    nbDemandes:demandes.length,nbDemandesEnAttente,
    nbStagiaires:stagiaires.length,nbFormations:formations.length,
    nbFormateurs:formateurs.length,nbSessions:sessions.length,nbSessionsTerminees:sessionsTerminees.length,
    nbSatisfactions:satisfactions.length,nbReclamations:reclamations.length,
    // Devis
    nbDevis:devis.length,devisEnAttente,tauxConversionDevis,nbDevisAcceptes:devisAcceptes.length,
    // Conventions
    nbConventions:conventions.length,conventionsEnAttente,tauxConventionsSignees,nbConventionsSignees:conventionsSignees.length,
    // DPC/PEC
    nbPec:dpc.length,pecEnAttente,tauxPecAccordees,nbPecAccordees:pecAccordees.length,montantPecAccorde,
    // Conception
    nbConceptions:conceptions.length,conceptionsAVerifier,tauxConceptionTerminee
  };
}

// Afficher les indicateurs Qualiopi sur chaque onglet
async function afficherIndicateursQualiopi(page){
  const ind=await calculerIndicateursQualiopi();
  
  switch(page){
    case 'dashboard':
      afficherWidgetQualiopiDashboard(ind);
      break;
    case 'demandes':
      afficherQualiopiDemandes(ind);
      break;
    case 'analyse':
      afficherQualiopiAnalyse(ind);
      break;
    case 'evaluation':
      afficherQualiopiEvaluation(ind);
      break;
    case 'sessions':
      afficherQualiopiSessions(ind);
      break;
    case 'stagiaires':
      afficherQualiopiStagiaires(ind);
      break;
    case 'referentiels':
      afficherQualiopiFormations(ind);
      afficherQualiopiFormateurs(ind);
      break;
    case 'devis':
      afficherQualiopiDevis(ind);
      break;
    case 'conventions':
      afficherQualiopiConventions(ind);
      break;
    case 'dpc':
      afficherQualiopiDPC(ind);
      break;
    case 'conception':
      afficherQualiopiConception(ind);
      break;
  }
}

// Widget Qualiopi Dashboard
function afficherWidgetQualiopiDashboard(ind){
  // Score global
  document.getElementById('qualiopi-score-global').textContent=ind.scoreGlobal+'%';
  
  // Mini crit√®res
  const criteres=[
    {num:1,nom:'Information public',score:ind.scoreCritere1,couleur:'#3b82f6'},
    {num:2,nom:'Objectifs/besoins',score:ind.scoreCritere2,couleur:'#8b5cf6'},
    {num:3,nom:'Adaptation',score:ind.scoreCritere3,couleur:'#ec4899'},
    {num:4,nom:'Moyens p√©dago.',score:ind.scoreCritere4,couleur:'#f59e0b'},
    {num:5,nom:'Qualification',score:ind.scoreCritere5,couleur:'#10b981'},
    {num:6,nom:'Inscription OF',score:ind.scoreCritere6,couleur:'#06b6d4'},
    {num:7,nom:'Am√©lioration',score:ind.scoreCritere7,couleur:'#ef4444'}
  ];
  
  document.getElementById('qualiopi-criteres-mini').innerHTML=criteres.map(c=>`
    <div class="qualiopi-critere-mini">
      <div class="qualiopi-critere-num" style="background:${c.couleur}">${c.num}</div>
      <div class="qualiopi-critere-info">
        <div class="qualiopi-critere-name">${c.nom}</div>
        <div class="qualiopi-critere-bar"><div class="qualiopi-critere-fill" style="width:${c.score}%;background:${c.score>=80?'#22c55e':c.score>=50?'#f59e0b':'#ef4444'}"></div></div>
      </div>
      <div class="qualiopi-critere-pct" style="color:${c.score>=80?'#22c55e':c.score>=50?'#f59e0b':'#ef4444'}">${c.score}%</div>
    </div>
  `).join('');
  
  // Alertes
  const alertes=[];
  if(ind.nbDemandesEnAttente>0)alertes.push({type:'warning',titre:`${ind.nbDemandesEnAttente} demande(s) en attente`,texte:'Crit√®re 1.4 - D√©lai d\'acc√®s < 48h'});
  if(ind.nbAnalysesEnAttente>3)alertes.push({type:'warning',titre:`${ind.nbAnalysesEnAttente} questionnaire(s) sans r√©ponse`,texte:'Crit√®re 2.1 - Relancer les contacts'});
  if(ind.nbEvaluationsATraiter>0)alertes.push({type:'warning',titre:`${ind.nbEvaluationsATraiter} √©valuation(s) √† traiter`,texte:'Crit√®re 2.3 - Analyser les r√©ponses re√ßues'});
  if(ind.reclamationsEnAttente>0)alertes.push({type:'danger',titre:`${ind.reclamationsEnAttente} r√©clamation(s) non trait√©e(s)`,texte:'Crit√®re 7.2 - Traitement < 72h obligatoire'});
  if(ind.tauxPositionnement<50)alertes.push({type:'warning',titre:`Positionnements: ${ind.tauxPositionnement}%`,texte:'Crit√®re 2.3 - Positionnement pr√©alable stagiaires'});
  if(ind.tauxFormateursQualifies<80)alertes.push({type:'warning',titre:`Qualifications formateurs: ${ind.tauxFormateursQualifies}%`,texte:'Crit√®re 5.1 - Renseigner CV/comp√©tences'});
  if(ind.tauxProgramme<80)alertes.push({type:'warning',titre:`Programmes complets: ${ind.tauxProgramme}%`,texte:'Crit√®re 1.1 - Compl√©ter fiches formations'});
  if(ind.scoreGlobal>=80)alertes.push({type:'success',titre:'Conformit√© Qualiopi satisfaisante',texte:`Score global: ${ind.scoreGlobal}%`});
  
  document.getElementById('qualiopi-alertes').innerHTML=alertes.length>0?alertes.map(a=>`
    <div class="qualiopi-alert ${a.type==='danger'?'':a.type}" style="margin-bottom:8px">
      <div class="qualiopi-alert-icon">${a.type==='danger'?'üö®':a.type==='warning'?'‚ö†Ô∏è':'‚úÖ'}</div>
      <div class="qualiopi-alert-content">
        <div class="qualiopi-alert-title">${a.titre}</div>
        <div class="qualiopi-alert-text">${a.texte}</div>
      </div>
    </div>
  `).join(''):'<div style="text-align:center;color:#22c55e;padding:20px">‚úÖ Aucune alerte - Conformit√© OK</div>';
}

// Indicateurs page Demandes
function afficherQualiopiDemandes(ind){
  const container=document.getElementById('qualiopi-demandes');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxDelaiAcces>=80?'green':ind.tauxDelaiAcces>=50?'yellow':'red'}">üìä</div>
      <div>
        <div class="qualiopi-indicator-label">D√©lai traitement < 48h</div>
        <div class="qualiopi-indicator-value">${ind.tauxDelaiAcces}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C1.4</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">‚è±Ô∏è</div>
      <div>
        <div class="qualiopi-indicator-label">D√©lai moyen</div>
        <div class="qualiopi-indicator-value">${ind.delaiMoyenDemandes}h</div>
      </div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.nbDemandesEnAttente>0?'yellow':'green'}">${ind.nbDemandesEnAttente>0?'‚ö†Ô∏è':'‚úÖ'}</div>
      <div>
        <div class="qualiopi-indicator-label">En attente</div>
        <div class="qualiopi-indicator-value">${ind.nbDemandesEnAttente}</div>
      </div>
    </div>
  `;
}

// Indicateurs page Analyse
function afficherQualiopiAnalyse(ind){
  const container=document.getElementById('qualiopi-analyse');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxAnalyses>=80?'green':ind.tauxAnalyses>=50?'yellow':'red'}">üìã</div>
      <div>
        <div class="qualiopi-indicator-label">Demandes analys√©es</div>
        <div class="qualiopi-indicator-value">${ind.tauxAnalyses}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C2.1</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxReponsesAnalyse>=70?'green':ind.tauxReponsesAnalyse>=50?'yellow':'red'}">üì¨</div>
      <div>
        <div class="qualiopi-indicator-label">Taux de r√©ponses</div>
        <div class="qualiopi-indicator-value">${ind.tauxReponsesAnalyse}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C2.2</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.nbAnalysesEnAttente>3?'yellow':'green'}">${ind.nbAnalysesEnAttente>0?'‚è≥':'‚úÖ'}</div>
      <div>
        <div class="qualiopi-indicator-label">En attente r√©ponse</div>
        <div class="qualiopi-indicator-value">${ind.nbAnalysesEnAttente}</div>
      </div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">‚úâÔ∏è</div>
      <div>
        <div class="qualiopi-indicator-label">R√©ponses re√ßues</div>
        <div class="qualiopi-indicator-value">${ind.nbAnalysesReponseRecue}/${ind.nbAnalyses}</div>
      </div>
    </div>
  `;
}

// Indicateurs page Evaluation
function afficherQualiopiEvaluation(ind){
  const container=document.getElementById('qualiopi-evaluation');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxEvaluations>=80?'green':ind.tauxEvaluations>=50?'yellow':'red'}">üìù</div>
      <div>
        <div class="qualiopi-indicator-label">R√©ponses √©valu√©es</div>
        <div class="qualiopi-indicator-value">${ind.tauxEvaluations}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C2.3</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.nbEvaluationsATraiter>3?'yellow':'green'}">${ind.nbEvaluationsATraiter>0?'‚è≥':'‚úÖ'}</div>
      <div>
        <div class="qualiopi-indicator-label">√Ä traiter</div>
        <div class="qualiopi-indicator-value">${ind.nbEvaluationsATraiter}</div>
      </div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon green">‚úÖ</div>
      <div>
        <div class="qualiopi-indicator-label">√âvaluations valid√©es</div>
        <div class="qualiopi-indicator-value">${ind.nbEvaluationsValidees}</div>
      </div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">üéì</div>
      <div>
        <div class="qualiopi-indicator-label">Sessions cr√©√©es</div>
        <div class="qualiopi-indicator-value">${ind.nbSessionsCreees}</div>
      </div>
    </div>
  `;
}

// Indicateurs page Sessions
function afficherQualiopiSessions(ind){
  const container=document.getElementById('qualiopi-sessions');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxFormateurAssigne>=90?'green':ind.tauxFormateurAssigne>=70?'yellow':'red'}">üë®‚Äçüè´</div>
      <div>
        <div class="qualiopi-indicator-label">Sessions avec formateur</div>
        <div class="qualiopi-indicator-value">${ind.tauxFormateurAssigne}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C4.2</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxEmargement>=90?'green':ind.tauxEmargement>=70?'yellow':'red'}">‚úçÔ∏è</div>
      <div>
        <div class="qualiopi-indicator-label">√âmargements complets</div>
        <div class="qualiopi-indicator-value">${ind.tauxEmargement}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C4.1</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">üìä</div>
      <div>
        <div class="qualiopi-indicator-label">Sessions termin√©es</div>
        <div class="qualiopi-indicator-value">${ind.nbSessionsTerminees}/${ind.nbSessions}</div>
      </div>
    </div>
  `;
}

// Indicateurs page Stagiaires
function afficherQualiopiStagiaires(ind){
  const container=document.getElementById('qualiopi-stagiaires');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxPositionnement>=80?'green':ind.tauxPositionnement>=50?'yellow':'red'}">üìù</div>
      <div>
        <div class="qualiopi-indicator-label">Avec positionnement</div>
        <div class="qualiopi-indicator-value">${ind.tauxPositionnement}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C2.3</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxAttestations>=80?'green':ind.tauxAttestations>=50?'yellow':'red'}">üìú</div>
      <div>
        <div class="qualiopi-indicator-label">Avec attestation</div>
        <div class="qualiopi-indicator-value">${ind.tauxAttestations}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C7.3</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">‚ôø</div>
      <div>
        <div class="qualiopi-indicator-label">PSH identifi√©s</div>
        <div class="qualiopi-indicator-value">${ind.nbPSH}</div>
      </div>
      <div class="qualiopi-indicator-ref">C2.4</div>
    </div>
  `;
}

// Indicateurs section Formations
function afficherQualiopiFormations(ind){
  const container=document.getElementById('qualiopi-formations');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxProgramme>=80?'green':ind.tauxProgramme>=50?'yellow':'red'}">üìö</div>
      <div>
        <div class="qualiopi-indicator-label">Programmes complets</div>
        <div class="qualiopi-indicator-value">${ind.tauxProgramme}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C1.1</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">üìä</div>
      <div>
        <div class="qualiopi-indicator-label">Total formations</div>
        <div class="qualiopi-indicator-value">${ind.nbFormations}</div>
      </div>
    </div>
  `;
}

// Indicateurs section Formateurs
function afficherQualiopiFormateurs(ind){
  const container=document.getElementById('qualiopi-formateurs');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxFormateursQualifies>=80?'green':ind.tauxFormateursQualifies>=50?'yellow':'red'}">üéì</div>
      <div>
        <div class="qualiopi-indicator-label">Qualifications renseign√©es</div>
        <div class="qualiopi-indicator-value">${ind.tauxFormateursQualifies}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C5.1</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">üë•</div>
      <div>
        <div class="qualiopi-indicator-label">Total formateurs</div>
        <div class="qualiopi-indicator-value">${ind.nbFormateurs}</div>
      </div>
    </div>
  `;
}

// Indicateurs page Devis
function afficherQualiopiDevis(ind){
  const container=document.getElementById('qualiopi-devis');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxConversionDevis>=50?'green':ind.tauxConversionDevis>=30?'yellow':'red'}">üìä</div>
      <div>
        <div class="qualiopi-indicator-label">Taux conversion</div>
        <div class="qualiopi-indicator-value">${ind.tauxConversionDevis}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C1.3</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.devisEnAttente>3?'yellow':'green'}">${ind.devisEnAttente>3?'‚è≥':'‚úÖ'}</div>
      <div>
        <div class="qualiopi-indicator-label">En attente</div>
        <div class="qualiopi-indicator-value">${ind.devisEnAttente}</div>
      </div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">‚úì</div>
      <div>
        <div class="qualiopi-indicator-label">Accept√©s</div>
        <div class="qualiopi-indicator-value">${ind.nbDevisAcceptes}/${ind.nbDevis}</div>
      </div>
    </div>
  `;
}

// Indicateurs page Conventions
function afficherQualiopiConventions(ind){
  const container=document.getElementById('qualiopi-conventions');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxConventionsSignees>=80?'green':ind.tauxConventionsSignees>=50?'yellow':'red'}">üìù</div>
      <div>
        <div class="qualiopi-indicator-label">Conventions sign√©es</div>
        <div class="qualiopi-indicator-value">${ind.tauxConventionsSignees}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C1.3</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.conventionsEnAttente>0?'yellow':'green'}">${ind.conventionsEnAttente>0?'‚è≥':'‚úÖ'}</div>
      <div>
        <div class="qualiopi-indicator-label">En attente signature</div>
        <div class="qualiopi-indicator-value">${ind.conventionsEnAttente}</div>
      </div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">üìë</div>
      <div>
        <div class="qualiopi-indicator-label">Total</div>
        <div class="qualiopi-indicator-value">${ind.nbConventionsSignees}/${ind.nbConventions}</div>
      </div>
    </div>
  `;
}

// Indicateurs page DPC/PEC
function afficherQualiopiDPC(ind){
  const container=document.getElementById('qualiopi-dpc');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxPecAccordees>=70?'green':ind.tauxPecAccordees>=50?'yellow':'red'}">‚úÖ</div>
      <div>
        <div class="qualiopi-indicator-label">Taux PEC accord√©es</div>
        <div class="qualiopi-indicator-value">${ind.tauxPecAccordees}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C6.1</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.pecEnAttente>3?'yellow':'green'}">${ind.pecEnAttente>3?'‚è≥':'‚úÖ'}</div>
      <div>
        <div class="qualiopi-indicator-label">En attente</div>
        <div class="qualiopi-indicator-value">${ind.pecEnAttente}</div>
      </div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">üí∂</div>
      <div>
        <div class="qualiopi-indicator-label">Montant accord√©</div>
        <div class="qualiopi-indicator-value">${new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(ind.montantPecAccorde)}</div>
      </div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">üìä</div>
      <div>
        <div class="qualiopi-indicator-label">Accord√©es</div>
        <div class="qualiopi-indicator-value">${ind.nbPecAccordees}/${ind.nbPec}</div>
      </div>
    </div>
  `;
}

// Indicateurs page Conception
function afficherQualiopiConception(ind){
  const container=document.getElementById('qualiopi-conception');
  if(!container)return;
  container.style.display='flex';
  container.innerHTML=`
    <div class="qualiopi-indicators-title">üèÜ Qualiopi</div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.tauxConceptionTerminee>=80?'green':ind.tauxConceptionTerminee>=50?'yellow':'red'}">üìÑ</div>
      <div>
        <div class="qualiopi-indicator-label">Documents g√©n√©r√©s</div>
        <div class="qualiopi-indicator-value">${ind.tauxConceptionTerminee}%</div>
      </div>
      <div class="qualiopi-indicator-ref">C3.1</div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon ${ind.conceptionsAVerifier>0?'yellow':'green'}">${ind.conceptionsAVerifier>0?'‚ö†Ô∏è':'‚úÖ'}</div>
      <div>
        <div class="qualiopi-indicator-label">√Ä v√©rifier/modifier</div>
        <div class="qualiopi-indicator-value">${ind.conceptionsAVerifier}</div>
      </div>
    </div>
    <div class="qualiopi-indicator">
      <div class="qualiopi-indicator-icon blue">üìã</div>
      <div>
        <div class="qualiopi-indicator-label">Total conceptions</div>
        <div class="qualiopi-indicator-value">${ind.nbConceptions}</div>
      </div>
    </div>
  `;
}

// ============ QUALIOPI ============
const QUALIOPI_CRITERES=[
  {id:1,titre:'Information du public',indicateurs:['Diffusion des informations','Indicateurs de r√©sultats','Conditions d\'acc√®s','D√©lais d\'acc√®s']},
  {id:2,titre:'Identification des objectifs',indicateurs:['Analyse du besoin','Objectifs et pr√©requis','Positionnement pr√©alable','Adaptation PSH']},
  {id:3,titre:'Adaptation des prestations',indicateurs:['Proc√©dures positionnement','Contenus adapt√©s','Dur√©es adapt√©es','Parcours individualis√©s']},
  {id:4,titre:'Moyens p√©dagogiques',indicateurs:['Moyens p√©dagogiques','Coordination intervenants','Ressources documentaires','Personnel d√©di√© handicap']},
  {id:5,titre:'Qualification personnels',indicateurs:['Comp√©tences formateurs','Veille sectorielle','Veille p√©dagogique','Plan d√©veloppement']},
  {id:6,titre:'Inscription de l\'OF',indicateurs:['Gestion comp√©tences','Veille r√©glementaire','Conformit√© l√©gale','R√©seau professionnel']},
  {id:7,titre:'Am√©lioration continue',indicateurs:['Recueil appr√©ciations','Traitement r√©clamations','Mesures am√©lioration','Actions correctives']}
];

async function showQualiopiIndicateurs(){
  const docsQualiopi=await dbGetAll('qualiopi_docs')||[];
  
  document.getElementById('qualiopi-criteres').innerHTML=QUALIOPI_CRITERES.map(c=>`
    <div class="critere-card" style="margin-bottom:20px;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden">
      <div class="critere-header" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;padding:15px;display:flex;justify-content:space-between;align-items:center">
        <div class="critere-title" style="font-weight:600">Crit√®re ${c.id} : ${c.titre}</div>
        <div class="critere-progress" style="width:100px;height:8px;background:rgba(255,255,255,0.3);border-radius:4px;overflow:hidden">
          <div class="critere-progress-fill" style="width:${getQualiopiProgress(c.id,docsQualiopi)}%;height:100%;background:#22c55e"></div>
        </div>
      </div>
      <div style="padding:15px">
        ${c.indicateurs.map((ind,i)=>{
          const indicateurId='C'+c.id+'I'+(i+1);
          const docs=docsQualiopi.filter(d=>d.indicateur===indicateurId);
          return `
          <div class="indicateur-item" style="display:flex;flex-direction:column;padding:12px;background:#f8fafc;border-radius:8px;margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <span style="font-weight:500">${c.id}.${i+1} ${ind}</span>
              <div style="display:flex;align-items:center;gap:8px">
                <span class="status status-${docs.length>0?'conforme':'en-attente'}">${docs.length>0?'Conforme':'En attente'}</span>
                <button class="btn btn-sm btn-primary" onclick="uploadDocQualiopi('${indicateurId}','${c.id}.${i+1} ${ind}')">üì§ Doc</button>
              </div>
            </div>
            ${docs.length>0?`
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:5px">
              ${docs.map(doc=>`
                <div style="display:flex;align-items:center;gap:5px;background:#e0f2fe;padding:4px 8px;border-radius:4px;font-size:0.75em">
                  <span>üìÑ ${esc(doc.nom)}</span>
                  <button class="btn btn-icon" style="width:18px;height:18px;font-size:0.6em;background:#ef4444;color:white" onclick="deleteDocQualiopi(${doc.id})">√ó</button>
                </div>
              `).join('')}
            </div>
            `:''}
          </div>`;
        }).join('')}
      </div>
    </div>
  `).join('');
}

function getQualiopiProgress(critereId,docs){
  const nbIndicateurs=QUALIOPI_CRITERES.find(c=>c.id===critereId)?.indicateurs.length||4;
  const docsForCritere=docs.filter(d=>d.indicateur.startsWith('C'+critereId));
  const uniqueIndicateurs=new Set(docsForCritere.map(d=>d.indicateur));
  return Math.round((uniqueIndicateurs.size/nbIndicateurs)*100);
}

async function uploadDocQualiopi(indicateurId,indicateurNom){
  const input=document.createElement('input');
  input.type='file';
  input.accept='.pdf,.doc,.docx,.jpg,.jpeg,.png,.xls,.xlsx';
  input.onchange=async function(){
    if(this.files.length>0){
      const file=this.files[0];
      const reader=new FileReader();
      reader.onload=async function(e){
        const doc={
          indicateur:indicateurId,
          indicateurNom:indicateurNom,
          nom:file.name,
          type:file.type,
          taille:file.size,
          data:e.target.result,
          dateUpload:new Date().toISOString()
        };
        await dbAdd('qualiopi_docs',doc);
        toast('Document ajout√© pour '+indicateurNom,'success');
        showQualiopiIndicateurs();
      };
      reader.readAsDataURL(file);
    }
  };
  input.click();
}

async function deleteDocQualiopi(id){
  if(confirm('Supprimer ce document ?')){
    await dbDelete('qualiopi_docs',id);
    toast('Document supprim√©','success');
    showQualiopiIndicateurs();
  }
}

// ============ DOCUMENTS QUALIOPI AVANC√âS ============
let docsQualiopiData=[];
let docQualiEditId=null;
let docQualiCurrentFile=null;

async function loadDocsQualiopi(){
  docsQualiopiData=await dbGetAll('qualiopi_docs')||[];
  renderDocsQualiopi();
}

function filterDocsQualiopi(){
  renderDocsQualiopi();
}

function renderDocsQualiopi(){
  const tbody=document.getElementById('table-docs-qualiopi');
  if(!tbody)return;
  
  const search=(document.getElementById('search-docs-quali')?.value||'').toLowerCase();
  const filterCritere=document.getElementById('filter-docs-critere')?.value;
  const filterType=document.getElementById('filter-docs-type')?.value;
  
  let filtered=docsQualiopiData.filter(d=>{
    if(search&&!d.titre?.toLowerCase().includes(search)&&!d.nom?.toLowerCase().includes(search))return false;
    if(filterCritere&&d.critere!==filterCritere)return false;
    if(filterType&&d.typeDoc!==filterType)return false;
    return true;
  });
  
  // Trier par date
  filtered.sort((a,b)=>new Date(b.dateUpload)-new Date(a.dateUpload));
  
  const typeIcons={procedure:'üìã',formulaire:'üìù',modele:'üìÑ',preuve:'‚úÖ',rapport:'üìä',autre:'üìé'};
  const critereColors={C1:'#3b82f6',C2:'#8b5cf6',C3:'#ec4899',C4:'#f59e0b',C5:'#10b981',C6:'#06b6d4',C7:'#6366f1'};
  
  if(!filtered.length){
    tbody.innerHTML=`<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìÅ</div><h3>Aucun document</h3><p>Ajoutez vos premiers documents Qualiopi</p></td></tr>`;
  }else{
    tbody.innerHTML=filtered.map(d=>{
      const typeIcon=typeIcons[d.typeDoc]||'üìé';
      const critColor=critereColors[d.critere]||'#64748b';
      const taille=d.taille?(d.taille/1024).toFixed(1)+' Ko':'-';
      return`<tr>
        <td><span style="background:${critColor};color:white;padding:4px 8px;border-radius:4px;font-weight:600;font-size:0.8em">${d.critere||'-'}</span></td>
        <td><strong>${esc(d.titre||d.nom)}</strong>${d.description?`<br><small style="color:#64748b">${trunc(d.description,50)}</small>`:''}</td>
        <td><span style="display:flex;align-items:center;gap:5px">${typeIcon} ${d.typeDoc||'autre'}</span></td>
        <td><span style="background:#e0f2fe;color:#0369a1;padding:3px 8px;border-radius:4px;font-weight:600">v${d.version||'1.0'}</span></td>
        <td>${fmtDate(d.dateUpload)}</td>
        <td>${taille}</td>
        <td class="action-btns">
          <button class="btn btn-info btn-icon" onclick="voirDocQualiopi(${d.id})" title="Visualiser">üëÅÔ∏è</button>
          <button class="btn btn-success btn-icon" onclick="telechargerDocQualiById(${d.id})" title="T√©l√©charger">üì•</button>
          <button class="btn btn-secondary btn-icon" onclick="editerDocQualiopi(${d.id})" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-icon" onclick="supprimerDocQualiopi(${d.id})" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('');
  }
  
  // Stats
  document.getElementById('docs-quali-total').textContent=docsQualiopiData.length;
  document.getElementById('docs-quali-procedures').textContent=docsQualiopiData.filter(d=>d.typeDoc==='procedure').length;
  document.getElementById('docs-quali-preuves').textContent=docsQualiopiData.filter(d=>d.typeDoc==='preuve').length;
  // Docs √† mettre √† jour (plus de 6 mois)
  const sixMonthsAgo=new Date();sixMonthsAgo.setMonth(sixMonthsAgo.getMonth()-6);
  document.getElementById('docs-quali-maj').textContent=docsQualiopiData.filter(d=>new Date(d.dateUpload)<sixMonthsAgo).length;
}

function ouvrirModalDocQualiopi(){
  docQualiEditId=null;
  docQualiCurrentFile=null;
  document.getElementById('modal-doc-quali-titre').textContent='üìÅ Ajouter un document Qualiopi';
  document.getElementById('doc-quali-titre').value='';
  document.getElementById('doc-quali-critere').value='';
  document.getElementById('doc-quali-type').value='';
  document.getElementById('doc-quali-version').value='1.0';
  document.getElementById('doc-quali-date-revision').value='';
  document.getElementById('doc-quali-description').value='';
  document.getElementById('doc-quali-fichier').value='';
  document.getElementById('doc-quali-fichier-info').style.display='none';
  document.getElementById('modal-doc-qualiopi').style.display='flex';
}

function fermerModalDocQualiopi(){
  document.getElementById('modal-doc-qualiopi').style.display='none';
}

function onDocQualiFileChange(input){
  const file=input.files[0];
  if(!file)return;
  
  if(file.size>20*1024*1024){
    toast('Fichier trop volumineux (max 20 Mo)','warning');
    input.value='';
    return;
  }
  
  docQualiCurrentFile=file;
  document.getElementById('doc-quali-fichier-info').innerHTML=`‚úÖ <strong>${esc(file.name)}</strong> (${(file.size/1024).toFixed(1)} Ko)`;
  document.getElementById('doc-quali-fichier-info').style.display='block';
  
  // Auto-remplir le titre si vide
  if(!document.getElementById('doc-quali-titre').value){
    document.getElementById('doc-quali-titre').value=file.name.replace(/\.[^/.]+$/,'');
  }
}

async function sauvegarderDocQualiopi(){
  const titre=document.getElementById('doc-quali-titre').value.trim();
  const critere=document.getElementById('doc-quali-critere').value;
  const typeDoc=document.getElementById('doc-quali-type').value;
  const version=document.getElementById('doc-quali-version').value.trim();
  
  if(!titre||!critere||!typeDoc){
    toast('Veuillez remplir les champs obligatoires','warning');
    return;
  }
  
  if(!docQualiEditId&&!docQualiCurrentFile){
    toast('Veuillez s√©lectionner un fichier','warning');
    return;
  }
  
  let doc;
  if(docQualiEditId){
    doc=await dbGet('qualiopi_docs',docQualiEditId);
  }else{
    doc={};
  }
  
  doc.titre=titre;
  doc.critere=critere;
  doc.typeDoc=typeDoc;
  doc.version=version;
  doc.dateRevision=document.getElementById('doc-quali-date-revision').value||null;
  doc.description=document.getElementById('doc-quali-description').value.trim();
  doc.dateUpload=new Date().toISOString();
  
  if(docQualiCurrentFile){
    const reader=new FileReader();
    reader.onload=async function(e){
      doc.nom=docQualiCurrentFile.name;
      doc.type=docQualiCurrentFile.type;
      doc.taille=docQualiCurrentFile.size;
      doc.data=e.target.result;
      
      if(docQualiEditId){
        await dbPut('qualiopi_docs',doc);
        toast('Document mis √† jour','success');
      }else{
        await dbAdd('qualiopi_docs',doc);
        toast('Document ajout√©','success');
      }
      
      fermerModalDocQualiopi();
      loadDocsQualiopi();
    };
    reader.readAsDataURL(docQualiCurrentFile);
  }else{
    await dbPut('qualiopi_docs',doc);
    toast('Document mis √† jour','success');
    fermerModalDocQualiopi();
    loadDocsQualiopi();
  }
}

async function editerDocQualiopi(id){
  const doc=await dbGet('qualiopi_docs',id);
  if(!doc)return;
  
  docQualiEditId=id;
  docQualiCurrentFile=null;
  
  document.getElementById('modal-doc-quali-titre').textContent='‚úèÔ∏è Modifier le document';
  document.getElementById('doc-quali-titre').value=doc.titre||doc.nom||'';
  document.getElementById('doc-quali-critere').value=doc.critere||'';
  document.getElementById('doc-quali-type').value=doc.typeDoc||'';
  document.getElementById('doc-quali-version').value=doc.version||'1.0';
  document.getElementById('doc-quali-date-revision').value=doc.dateRevision||'';
  document.getElementById('doc-quali-description').value=doc.description||'';
  document.getElementById('doc-quali-fichier').value='';
  document.getElementById('doc-quali-fichier-info').innerHTML=`üìÑ Fichier actuel: <strong>${esc(doc.nom)}</strong>`;
  document.getElementById('doc-quali-fichier-info').style.display='block';
  
  document.getElementById('modal-doc-qualiopi').style.display='flex';
}

let viewDocQualiId=null;
async function voirDocQualiopi(id){
  const doc=await dbGet('qualiopi_docs',id);
  if(!doc||!doc.data){
    toast('Document non disponible','warning');
    return;
  }
  
  viewDocQualiId=id;
  document.getElementById('view-doc-quali-titre').textContent=`üìÑ ${doc.titre||doc.nom}`;
  document.getElementById('view-doc-quali-info').textContent=`Version ${doc.version||'1.0'} ‚Ä¢ ${fmtDate(doc.dateUpload)} ‚Ä¢ ${(doc.taille/1024).toFixed(1)} Ko`;
  
  const content=document.getElementById('view-doc-quali-content');
  
  if(doc.type==='application/pdf'){
    content.innerHTML=`<iframe src="${doc.data}" style="width:100%;height:100%;border:none"></iframe>`;
  }else if(doc.type.startsWith('image/')){
    content.innerHTML=`<img src="${doc.data}" style="max-width:100%;max-height:100%;object-fit:contain">`;
  }else{
    content.innerHTML=`
      <div style="text-align:center;padding:40px">
        <div style="font-size:5rem;margin-bottom:20px">üìÑ</div>
        <h3>${esc(doc.nom)}</h3>
        <p style="color:#64748b;margin:15px 0">Ce type de fichier ne peut pas √™tre pr√©visualis√©</p>
        <button class="btn btn-primary" onclick="telechargerDocQualiopi()">üì• T√©l√©charger pour visualiser</button>
      </div>`;
  }
  
  document.getElementById('modal-view-doc-quali').style.display='flex';
}

function fermerViewDocQualiopi(){
  document.getElementById('modal-view-doc-quali').style.display='none';
  viewDocQualiId=null;
}

async function telechargerDocQualiopi(){
  if(!viewDocQualiId)return;
  await telechargerDocQualiById(viewDocQualiId);
}

async function telechargerDocQualiById(id){
  const doc=await dbGet('qualiopi_docs',id);
  if(!doc||!doc.data){
    toast('Document non disponible','warning');
    return;
  }
  
  const link=document.createElement('a');
  link.href=doc.data;
  link.download=doc.nom||'document';
  link.click();
  toast('T√©l√©chargement lanc√©','success');
}

async function supprimerDocQualiopi(id){
  if(!confirm('Supprimer ce document ?'))return;
  await dbDelete('qualiopi_docs',id);
  toast('Document supprim√©','success');
  loadDocsQualiopi();
}

// ============ VEILLE QUALIOPI ============
let veilleData=[];
let veilleEditId=null;
let veilleTypeFilter='';
let veilleVue='tableau';
let sourcesVeilleData=[];

async function loadVeille(){
  veilleData=await dbGetAll('veille')||[];
  sourcesVeilleData=await dbGetAll('sources_veille')||[];
  
  // Si pas de sources, ajouter les sources par d√©faut
  if(sourcesVeilleData.length===0){
    await initSourcesVeilleDefaut();
    sourcesVeilleData=await dbGetAll('sources_veille')||[];
  }
  
  // Si pas de donn√©es, ajouter des donn√©es d√©mo
  if(veilleData.length===0){
    await genererVeilleDemo();
    veilleData=await dbGetAll('veille')||[];
  }
  
  renderSourcesVeille();
  renderVeille();
}

// Actualiser la veille
async function actualiserVeille() {
  toast('üîÑ Actualisation en cours...', 'info');
  await loadVeille();
  toast('‚úÖ Veille actualis√©e', 'success');
}

async function initSourcesVeilleDefaut(){
  const sourcesDefaut=[
    {nom:'L√©gifrance',url:'https://www.legifrance.gouv.fr',type:'juridique',couleur:'#3b82f6'},
    {nom:'Minist√®re du Travail',url:'https://www.travail-emploi.gouv.fr',type:'juridique',couleur:'#22c55e'},
    {nom:'France Comp√©tences',url:'https://www.francecompetences.fr',type:'pedagogique',couleur:'#f59e0b'},
    {nom:'Centre Inffo',url:'https://www.centre-inffo.fr',type:'pedagogique',couleur:'#8b5cf6'},
    {nom:'Qualiopi.fr',url:'https://www.qualiopi.fr',type:'pedagogique',couleur:'#ef4444'},
    {nom:'D√©fi M√©tiers',url:'https://www.defi-metiers.fr',type:'sectorielle',couleur:'#0891b2'}
  ];
  
  for(const s of sourcesDefaut){
    s.dateCreation=new Date().toISOString();
    await dbAdd('sources_veille',s);
  }
}

async function genererVeilleDemo(){
  const sources=await dbGetAll('sources_veille')||[];
  const veillesDemo=[
    {
      type:'juridique',
      source:sources.find(s=>s.nom==='L√©gifrance')?.nom||'L√©gifrance',
      sourceUrl:'https://www.legifrance.gouv.fr',
      resume:'Nouvelles obligations pour les organismes de formation concernant le suivi des indicateurs de r√©sultats. Renforcement des crit√®res 1 et 7.',
      principaleInfo:'D√©cret n¬∞2024-567 - Renforcement des exigences de suivi Qualiopi',
      impact:'important',
      actions:'Mettre √† jour les proc√©dures de suivi des indicateurs. Former l\'√©quipe aux nouvelles exigences.',
      diffusionNewsletter:true,
      diffusionSite:false,
      diffusionDocs:true,
      diffusionOutils:false,
      dateRecueil:new Date(Date.now()-30*24*60*60*1000).toISOString().slice(0,10)
    },
    {
      type:'pedagogique',
      source:sources.find(s=>s.nom==='Centre Inffo')?.nom||'Centre Inffo',
      sourceUrl:'https://www.centre-inffo.fr',
      resume:'Publication d\'un nouveau guide sur les modalit√©s p√©dagogiques en distanciel. Recommandations sur l\'engagement des apprenants.',
      principaleInfo:'Guide des bonnes pratiques en formation √† distance 2024',
      impact:'moyen',
      actions:'Int√©grer les recommandations dans nos formations e-learning. Revoir les outils d\'engagement.',
      diffusionNewsletter:true,
      diffusionSite:true,
      diffusionDocs:false,
      diffusionOutils:true,
      dateRecueil:new Date(Date.now()-45*24*60*60*1000).toISOString().slice(0,10)
    },
    {
      type:'sectorielle',
      source:sources.find(s=>s.nom==='D√©fi M√©tiers')?.nom||'OPCO EP',
      sourceUrl:'https://www.opcoep.fr',
      resume:'Analyse des comp√©tences √©mergentes dans le secteur de la restauration. Nouvelles certifications recommand√©es.',
      principaleInfo:'√âvolution des m√©tiers de la restauration - √âtude OPCO EP 2024',
      impact:'moyen',
      actions:'Adapter notre catalogue de formations restauration. Proposer les nouvelles certifications.',
      diffusionNewsletter:false,
      diffusionSite:true,
      diffusionDocs:true,
      diffusionOutils:false,
      dateRecueil:new Date(Date.now()-60*24*60*60*1000).toISOString().slice(0,10)
    },
    {
      type:'juridique',
      source:sources.find(s=>s.nom==='Minist√®re du Travail')?.nom||'Minist√®re du Travail',
      sourceUrl:'https://www.travail-emploi.gouv.fr',
      resume:'Clarification des actions de formation √©ligibles au CPF. Impact sur les modalit√©s de prise en charge.',
      principaleInfo:'Modification du Code du Travail - Article L6313-1 (CPF)',
      impact:'important',
      actions:'V√©rifier la conformit√© de nos formations CPF. Mettre √† jour les fiches programmes.',
      diffusionNewsletter:true,
      diffusionSite:true,
      diffusionDocs:true,
      diffusionOutils:false,
      dateRecueil:new Date(Date.now()-90*24*60*60*1000).toISOString().slice(0,10)
    },
    {
      type:'pedagogique',
      source:sources.find(s=>s.nom==='France Comp√©tences')?.nom||'France Comp√©tences',
      sourceUrl:'https://www.francecompetences.fr',
      resume:'Recommandations pour am√©liorer les dispositifs d\'√©valuation pr√© et post-formation. Focus sur les comp√©tences transversales.',
      principaleInfo:'Rapport sur l\'√©valuation des comp√©tences en formation professionnelle',
      impact:'faible',
      actions:'Revoir nos questionnaires d\'√©valuation pr√©/post formation.',
      diffusionNewsletter:false,
      diffusionSite:false,
      diffusionDocs:true,
      diffusionOutils:true,
      dateRecueil:new Date(Date.now()-120*24*60*60*1000).toISOString().slice(0,10)
    }
  ];
  
  for(const v of veillesDemo){
    v.dateCreation=new Date().toISOString();
    await dbAdd('veille',v);
  }
}

function renderSourcesVeille(){
  const container=document.getElementById('sources-veille-list');
  if(!container)return;
  
  const typeConfig={
    pedagogique:{icon:'üìö',bg:'#f3e8ff',color:'#7c3aed'},
    juridique:{icon:'‚öñÔ∏è',bg:'#fef3c7',color:'#b45309'},
    sectorielle:{icon:'üè≠',bg:'#dcfce7',color:'#15803d'}
  };
  
  if(!sourcesVeilleData.length){
    container.innerHTML='<span style="color:#64748b;font-style:italic">Aucune source configur√©e</span>';
    return;
  }
  
  container.innerHTML=sourcesVeilleData.map(s=>{
    const tc=typeConfig[s.type]||typeConfig.pedagogique;
    return `<a href="${esc(s.url)}" target="_blank" class="badge" style="background:${s.couleur||tc.bg}20;color:${s.couleur||tc.color};padding:6px 12px;border-radius:20px;font-size:0.85em;text-decoration:none;border:1px solid ${s.couleur||tc.color}30" title="${esc(s.url)}">${tc.icon} ${esc(s.nom)}</a>`;
  }).join('');
  
  // Mettre √† jour le select des sources dans le modal
  const selectSource=document.getElementById('veille-source-select');
  if(selectSource){
    selectSource.innerHTML='<option value="">-- S√©lectionner une source --</option>'+
      sourcesVeilleData.map(s=>`<option value="${s.id}" data-url="${esc(s.url)}" data-type="${s.type}">${esc(s.nom)}</option>`).join('');
  }
}

function filterVeille(){
  renderVeille();
}

function filtrerTypeVeille(type){
  veilleTypeFilter=type;
  
  // Mise √† jour des boutons
  ['all','pedagogique','juridique','sectorielle'].forEach(t=>{
    const btn=document.getElementById('btn-veille-'+(t||'all'));
    if(btn){
      btn.classList.remove('btn-primary');
      btn.classList.add('btn-secondary');
      btn.style.background='';
      btn.style.color='';
    }
  });
  
  const activeBtn=document.getElementById(type?'btn-veille-'+type:'btn-veille-all');
  if(activeBtn){
    activeBtn.classList.remove('btn-secondary');
    activeBtn.classList.add('btn-primary');
    activeBtn.style.background='#1e40af';
    activeBtn.style.color='white';
  }
  
  renderVeille();
}

function toggleVueVeille(vue){
  veilleVue=vue;
  
  const btnTableau=document.getElementById('btn-veille-tableau');
  const btnCartes=document.getElementById('btn-veille-cartes');
  
  if(vue==='tableau'){
    btnTableau.classList.remove('btn-secondary');
    btnTableau.classList.add('btn-primary');
    btnTableau.style.background='#0891b2';
    btnTableau.style.color='white';
    btnCartes.classList.remove('btn-primary');
    btnCartes.classList.add('btn-secondary');
    btnCartes.style.background='';
    btnCartes.style.color='';
  }else{
    btnCartes.classList.remove('btn-secondary');
    btnCartes.classList.add('btn-primary');
    btnCartes.style.background='#0891b2';
    btnCartes.style.color='white';
    btnTableau.classList.remove('btn-primary');
    btnTableau.classList.add('btn-secondary');
    btnTableau.style.background='';
    btnTableau.style.color='';
  }
  
  document.getElementById('veille-vue-tableau').style.display=vue==='tableau'?'block':'none';
  document.getElementById('veille-vue-cartes').style.display=vue==='cartes'?'block':'none';
  
  renderVeille();
}

function renderVeille(){
  const search=(document.getElementById('search-veille')?.value||'').toLowerCase();
  const filterPeriode=parseInt(document.getElementById('filter-veille-periode')?.value)||0;
  
  let filtered=veilleData.filter(v=>{
    if(search&&!v.source?.toLowerCase().includes(search)&&!v.resume?.toLowerCase().includes(search)&&!v.principaleInfo?.toLowerCase().includes(search))return false;
    if(veilleTypeFilter&&v.type!==veilleTypeFilter)return false;
    if(filterPeriode){
      const dateLimit=new Date();dateLimit.setDate(dateLimit.getDate()-filterPeriode);
      if(new Date(v.dateRecueil)<dateLimit)return false;
    }
    return true;
  });
  
  // Trier par date
  filtered.sort((a,b)=>new Date(b.dateRecueil||b.dateCreation)-new Date(a.dateRecueil||a.dateCreation));
  
  // Render tableau
  renderVeilleTableau(filtered);
  
  // Render cartes
  renderVeilleCartes(filtered);
  
  // Stats
  document.getElementById('veille-total').textContent=veilleData.length;
  document.getElementById('veille-pedagogique').textContent=veilleData.filter(v=>v.type==='pedagogique').length;
  document.getElementById('veille-juridique').textContent=veilleData.filter(v=>v.type==='juridique').length;
  document.getElementById('veille-sectorielle').textContent=veilleData.filter(v=>v.type==='sectorielle').length;
}

function renderVeilleTableau(filtered){
  const tbody=document.getElementById('table-veille-synthese');
  if(!tbody)return;
  
  const typeConfig={
    pedagogique:{icon:'üìö',color:'#8b5cf6',bg:'#f3e8ff'},
    juridique:{icon:'‚öñÔ∏è',color:'#f59e0b',bg:'#fef3c7'},
    sectorielle:{icon:'üè≠',color:'#10b981',bg:'#dcfce7'}
  };
  
  if(!filtered.length){
    tbody.innerHTML='<tr><td colspan="10" class="empty-state"><div class="empty-state-icon">üîç</div><h3>Aucun article de veille</h3><p>Ajoutez des articles manuellement</p></td></tr>';
    return;
  }
  
  tbody.innerHTML=filtered.map(v=>{
    const tc=typeConfig[v.type]||typeConfig.pedagogique;
    const checkIcon=(val)=>val?'<span style="color:#22c55e;font-size:1.2em">‚úì</span>':'<span style="color:#d1d5db">‚Äî</span>';
    
    return `<tr>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="background:${tc.bg};color:${tc.color};padding:2px 8px;border-radius:12px;font-size:0.75em">${tc.icon}</span>
          <div>
            <div style="font-weight:600;font-size:0.9em">${esc(v.source||'-')}</div>
            ${v.sourceUrl?`<a href="${esc(v.sourceUrl)}" target="_blank" style="color:#3b82f6;font-size:0.75em">üîó Lien</a>`:''}
          </div>
        </div>
      </td>
      <td style="font-size:0.85em;max-width:200px">${esc(trunc(v.resume,100)||'-')}</td>
      <td style="white-space:nowrap">${fmtDate(v.dateRecueil)}</td>
      <td style="font-size:0.85em;font-weight:500">${esc(trunc(v.principaleInfo,80)||'-')}</td>
      <td style="font-size:0.85em;background:#f0f9ff">${esc(trunc(v.actions,80)||'-')}</td>
      <td style="text-align:center">${checkIcon(v.diffusionNewsletter)}</td>
      <td style="text-align:center">${checkIcon(v.diffusionSite)}</td>
      <td style="text-align:center">${checkIcon(v.diffusionDocs)}</td>
      <td style="text-align:center">${checkIcon(v.diffusionOutils)}</td>
      <td class="action-btns">
        <button class="btn btn-sm btn-secondary" onclick="editerVeille(${v.id})" title="Modifier">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger" onclick="supprimerVeille(${v.id})" title="Supprimer">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

function renderVeilleCartes(filtered){
  const container=document.getElementById('veille-liste');
  if(!container)return;
  
  const typeConfig={
    pedagogique:{icon:'üìö',color:'#8b5cf6',bg:'#f3e8ff',label:'P√©dagogique'},
    juridique:{icon:'‚öñÔ∏è',color:'#f59e0b',bg:'#fef3c7',label:'Juridique'},
    sectorielle:{icon:'üè≠',color:'#10b981',bg:'#dcfce7',label:'Sectorielle'}
  };
  
  const impactConfig={
    faible:{icon:'üü¢',color:'#22c55e'},
    moyen:{icon:'üü°',color:'#f59e0b'},
    important:{icon:'üî¥',color:'#ef4444'}
  };
  
  if(!filtered.length){
    container.innerHTML=`<div class="card" style="padding:40px;text-align:center;color:#64748b"><div style="font-size:3rem;margin-bottom:15px">üîç</div><h3>Aucun article de veille</h3><p>Ajoutez des articles manuellement</p></div>`;
  }else{
    container.innerHTML=filtered.map(v=>{
      const tc=typeConfig[v.type]||typeConfig.pedagogique;
      const ic=impactConfig[v.impact]||impactConfig.faible;
      
      const diffusions=[];
      if(v.diffusionNewsletter)diffusions.push('üìß Newsletter');
      if(v.diffusionSite)diffusions.push('üåê Site');
      if(v.diffusionDocs)diffusions.push('üìÅ Docs');
      if(v.diffusionOutils)diffusions.push('üõ†Ô∏è Outils');
      
      return`
      <div class="card" style="padding:0;overflow:hidden">
        <div style="display:flex">
          <div style="width:8px;background:${tc.color}"></div>
          <div style="flex:1;padding:20px">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
              <div style="display:flex;align-items:center;gap:10px">
                <span style="background:${tc.bg};color:${tc.color};padding:5px 12px;border-radius:20px;font-size:0.85em;font-weight:600">${tc.icon} ${tc.label}</span>
                <span style="color:${ic.color};font-weight:600">${ic.icon} Impact ${v.impact}</span>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn btn-sm btn-secondary" onclick="editerVeille(${v.id})">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-danger" onclick="supprimerVeille(${v.id})">üóëÔ∏è</button>
              </div>
            </div>
            <div style="font-weight:600;color:#1e40af;margin-bottom:8px">${esc(v.source||'-')}</div>
            <h3 style="margin:0 0 10px 0;color:#1e293b;font-size:1.1em">${esc(v.principaleInfo||'')}</h3>
            <p style="color:#475569;margin:0 0 12px 0;line-height:1.6">${esc(v.resume)}</p>
            ${v.actions?`<div style="background:#f0f9ff;border-left:3px solid #3b82f6;padding:10px 15px;border-radius:0 8px 8px 0;margin-bottom:12px"><strong style="color:#1d4ed8">Actions d'√©volution :</strong> ${esc(v.actions)}</div>`:''}
            ${diffusions.length?`<div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap">${diffusions.map(d=>`<span style="background:#e2e8f0;padding:3px 8px;border-radius:12px;font-size:0.8em">${d}</span>`).join('')}</div>`:''}
            <div style="display:flex;justify-content:space-between;align-items:center;color:#64748b;font-size:0.85em">
              <span>üìÖ Recueil : ${fmtDate(v.dateRecueil)}</span>
              ${v.sourceUrl?`<a href="${esc(v.sourceUrl)}" target="_blank" style="color:#3b82f6;text-decoration:none">üîó Source</a>`:''}
            </div>
          </div>
        </div>
      </div>`;
    }).join('');
  }
}

function ouvrirModalVeille(){
  veilleEditId=null;
  document.getElementById('modal-veille-titre').textContent='üîç Ajouter un article de veille';
  document.getElementById('veille-id').value='';
  document.getElementById('veille-source-select').value='';
  document.getElementById('veille-source-url').value='';
  document.getElementById('veille-type').value='';
  document.getElementById('veille-date').value=new Date().toISOString().slice(0,10);
  document.getElementById('veille-resume').value='';
  document.getElementById('veille-principale-info').value='';
  document.getElementById('veille-impact').value='moyen';
  document.getElementById('veille-actions').value='';
  document.getElementById('veille-diffusion-newsletter').checked=false;
  document.getElementById('veille-diffusion-site').checked=false;
  document.getElementById('veille-diffusion-docs').checked=false;
  document.getElementById('veille-diffusion-outils').checked=false;
  document.getElementById('modal-veille').style.display='flex';
}

function fermerModalVeille(){
  document.getElementById('modal-veille').style.display='none';
}

function onVeilleSourceChange(){
  const select=document.getElementById('veille-source-select');
  const option=select.options[select.selectedIndex];
  if(option&&option.dataset.url){
    document.getElementById('veille-source-url').value=option.dataset.url;
  }
  if(option&&option.dataset.type){
    document.getElementById('veille-type').value=option.dataset.type;
  }
}

async function sauvegarderVeille(){
  const sourceSelect=document.getElementById('veille-source-select');
  const sourceNom=sourceSelect.options[sourceSelect.selectedIndex]?.text||'';
  const type=document.getElementById('veille-type').value;
  const resume=document.getElementById('veille-resume').value.trim();
  const principaleInfo=document.getElementById('veille-principale-info').value.trim();
  const actions=document.getElementById('veille-actions').value.trim();
  
  if(!sourceNom||sourceNom.includes('S√©lectionner')){
    toast('Veuillez s√©lectionner une source','warning');
    return;
  }
  if(!type){
    toast('Veuillez s√©lectionner un type de veille','warning');
    return;
  }
  if(!resume){
    toast('Le r√©sum√© est obligatoire','warning');
    return;
  }
  if(!principaleInfo){
    toast('La principale information est obligatoire','warning');
    return;
  }
  if(!actions){
    toast('Les actions d\'√©volution sont obligatoires','warning');
    return;
  }
  
  const veille={
    source:sourceNom,
    sourceUrl:document.getElementById('veille-source-url').value.trim(),
    type,
    dateRecueil:document.getElementById('veille-date').value||new Date().toISOString().slice(0,10),
    resume,
    principaleInfo,
    impact:document.getElementById('veille-impact').value,
    actions,
    diffusionNewsletter:document.getElementById('veille-diffusion-newsletter').checked,
    diffusionSite:document.getElementById('veille-diffusion-site').checked,
    diffusionDocs:document.getElementById('veille-diffusion-docs').checked,
    diffusionOutils:document.getElementById('veille-diffusion-outils').checked
  };
  
  if(veilleEditId){
    veille.id=veilleEditId;
    await dbPut('veille',veille);
    toast('Article mis √† jour','success');
  }else{
    veille.dateCreation=new Date().toISOString();
    await dbAdd('veille',veille);
    toast('Article ajout√©','success');
  }
  
  fermerModalVeille();
  loadVeille();
}

async function editerVeille(id){
  const v=await dbGet('veille',id);
  if(!v)return;
  
  veilleEditId=id;
  document.getElementById('modal-veille-titre').textContent='‚úèÔ∏è Modifier l\'article';
  document.getElementById('veille-id').value=v.id;
  
  // Trouver la source dans le select
  const selectSource=document.getElementById('veille-source-select');
  const sourceOption=Array.from(selectSource.options).find(o=>o.text===v.source);
  if(sourceOption){
    selectSource.value=sourceOption.value;
  }else{
    selectSource.value='';
  }
  
  document.getElementById('veille-source-url').value=v.sourceUrl||v.source||'';
  document.getElementById('veille-type').value=v.type||'';
  document.getElementById('veille-date').value=v.dateRecueil?v.dateRecueil.slice(0,10):'';
  document.getElementById('veille-resume').value=v.resume||'';
  document.getElementById('veille-principale-info').value=v.principaleInfo||v.titre||'';
  document.getElementById('veille-impact').value=v.impact||'moyen';
  document.getElementById('veille-actions').value=v.actions||'';
  document.getElementById('veille-diffusion-newsletter').checked=v.diffusionNewsletter||false;
  document.getElementById('veille-diffusion-site').checked=v.diffusionSite||false;
  document.getElementById('veille-diffusion-docs').checked=v.diffusionDocs||false;
  document.getElementById('veille-diffusion-outils').checked=v.diffusionOutils||false;
  document.getElementById('modal-veille').style.display='flex';
}

async function supprimerVeille(id){
  if(!confirm('Supprimer cet article de veille ?'))return;
  await dbDelete('veille',id);
  toast('Article supprim√©','success');
  loadVeille();
}

// Gestion des sources de veille
function gererSourcesVeille(){
  renderListeSourcesVeille();
  document.getElementById('modal-sources-veille').style.display='flex';
}

function fermerModalSourcesVeille(){
  document.getElementById('modal-sources-veille').style.display='none';
}

function renderListeSourcesVeille(){
  const container=document.getElementById('liste-sources-veille');
  if(!container)return;
  
  const typeConfig={
    pedagogique:{icon:'üìö',label:'P√©dagogique',bg:'#f3e8ff',color:'#7c3aed'},
    juridique:{icon:'‚öñÔ∏è',label:'Juridique',bg:'#fef3c7',color:'#b45309'},
    sectorielle:{icon:'üè≠',label:'Sectorielle',bg:'#dcfce7',color:'#15803d'}
  };
  
  if(!sourcesVeilleData.length){
    container.innerHTML='<div style="text-align:center;color:#64748b;padding:20px">Aucune source configur√©e</div>';
    return;
  }
  
  container.innerHTML=sourcesVeilleData.map(s=>{
    const tc=typeConfig[s.type]||typeConfig.pedagogique;
    return `<div style="display:flex;align-items:center;gap:10px;padding:12px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0">
      <span style="background:${tc.bg};color:${tc.color};padding:4px 10px;border-radius:15px;font-size:0.8em">${tc.icon} ${tc.label}</span>
      <div style="flex:1">
        <div style="font-weight:600">${esc(s.nom)}</div>
        <a href="${esc(s.url)}" target="_blank" style="color:#3b82f6;font-size:0.85em">${esc(s.url)}</a>
      </div>
      <button class="btn btn-sm btn-danger" onclick="supprimerSourceVeille(${s.id})" title="Supprimer">üóëÔ∏è</button>
    </div>`;
  }).join('');
}

async function ajouterSourceVeille(){
  const nom=document.getElementById('nouvelle-source-nom').value.trim();
  const url=document.getElementById('nouvelle-source-url').value.trim();
  const type=document.getElementById('nouvelle-source-type').value;
  
  if(!nom){
    toast('Le nom de la source est obligatoire','warning');
    return;
  }
  if(!url){
    toast('L\'URL de la source est obligatoire','warning');
    return;
  }
  
  const couleurs={
    pedagogique:'#8b5cf6',
    juridique:'#f59e0b',
    sectorielle:'#10b981'
  };
  
  const source={
    nom,
    url,
    type,
    couleur:couleurs[type]||'#6b7280',
    dateCreation:new Date().toISOString()
  };
  
  await dbAdd('sources_veille',source);
  
  // Reset form
  document.getElementById('nouvelle-source-nom').value='';
  document.getElementById('nouvelle-source-url').value='';
  
  sourcesVeilleData=await dbGetAll('sources_veille')||[];
  renderListeSourcesVeille();
  renderSourcesVeille();
  toast('Source ajout√©e','success');
}

async function supprimerSourceVeille(id){
  if(!confirm('Supprimer cette source de veille ?'))return;
  await dbDelete('sources_veille',id);
  sourcesVeilleData=await dbGetAll('sources_veille')||[];
  renderListeSourcesVeille();
  renderSourcesVeille();
  toast('Source supprim√©e','success');
}

function exporterVeilleCSV(){
  if(!veilleData.length){
    toast('Aucune donn√©e √† exporter','warning');
    return;
  }
  
  const headers=['Source','Type','Date Recueil','R√©sum√©','Principale Information','Actions Evolution','Impact','Newsletter','Site','Documents','Outils'];
  const rows=veilleData.map(v=>[
    v.source||'',
    v.type||'',
    v.dateRecueil||'',
    (v.resume||'').replace(/"/g,'""'),
    (v.principaleInfo||'').replace(/"/g,'""'),
    (v.actions||'').replace(/"/g,'""'),
    v.impact||'',
    v.diffusionNewsletter?'Oui':'Non',
    v.diffusionSite?'Oui':'Non',
    v.diffusionDocs?'Oui':'Non',
    v.diffusionOutils?'Oui':'Non'
  ]);
  
  const csvContent='\\uFEFF'+headers.join(';')+'\\n'+rows.map(r=>r.map(c=>'"'+c+'"').join(';')).join('\\n');
  
  const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='veille_qualiopi_'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
  URL.revokeObjectURL(url);
  
  toast('Export CSV g√©n√©r√©','success');
}

// ============ TUTORIEL ============
const TUTORIEL_ETAPES=['intro','etape1','etape2','etape3','etape4','etape5','etape6','etape7','recap'];
let tutorielEtapeActuelle=0;

function ouvrirTutoriel(){
  tutorielEtapeActuelle=0;
  naviguerTutoriel('intro');
  document.getElementById('modal-tutoriel').style.display='flex';
}

function fermerTutoriel(){
  document.getElementById('modal-tutoriel').style.display='none';
}

function naviguerTutoriel(etape){
  tutorielEtapeActuelle=TUTORIEL_ETAPES.indexOf(etape);
  
  // Mise √† jour boutons nav
  document.querySelectorAll('.tuto-nav').forEach(btn=>{
    btn.classList.remove('active');
    btn.style.background='';
    btn.style.color='';
  });
  const activeBtn=document.querySelector(`.tuto-nav[data-tuto="${etape}"]`);
  if(activeBtn){
    activeBtn.classList.add('active');
    activeBtn.style.background='#1e40af';
    activeBtn.style.color='white';
  }
  
  // Mise √† jour contenu
  document.getElementById('tutoriel-contenu').innerHTML=getTutorielContenu(etape);
  
  // Mise √† jour progression
  document.getElementById('tuto-progression').textContent=`√âtape ${tutorielEtapeActuelle+1} / ${TUTORIEL_ETAPES.length}`;
  
  // Mise √† jour boutons nav
  document.getElementById('tuto-btn-prec').style.visibility=tutorielEtapeActuelle>0?'visible':'hidden';
  document.getElementById('tuto-btn-suiv').textContent=tutorielEtapeActuelle<TUTORIEL_ETAPES.length-1?'Suivant ‚û°Ô∏è':'‚úÖ Terminer';
}

function tutorielPrecedent(){
  if(tutorielEtapeActuelle>0){
    naviguerTutoriel(TUTORIEL_ETAPES[tutorielEtapeActuelle-1]);
  }
}

function tutorielSuivant(){
  if(tutorielEtapeActuelle<TUTORIEL_ETAPES.length-1){
    naviguerTutoriel(TUTORIEL_ETAPES[tutorielEtapeActuelle+1]);
  }else{
    fermerTutoriel();
    toast('üéâ Tutoriel termin√© ! Vous √™tes pr√™t √† utiliser le CRM.','success');
  }
}

function getTutorielContenu(etape){
  const contenus={
    intro:`
      <div style="text-align:center;padding:20px">
        <h1 style="color:#1e40af;font-size:2em;margin-bottom:10px">üìö Processus Complet d'une Action de Formation</h1>
        <p style="color:#64748b;font-size:1.1em;margin-bottom:30px">De la demande client √† la conception p√©dagogique</p>
        
        <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:40px">
          <div style="background:#3b82f6;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">1</div>
            <div style="font-size:0.75em">DEMANDE</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#8b5cf6;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">2</div>
            <div style="font-size:0.75em">ANALYSE</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#0891b2;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">3</div>
            <div style="font-size:0.75em">√âVALUATION</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#22c55e;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">4</div>
            <div style="font-size:0.75em">SESSION</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#f59e0b;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">5</div>
            <div style="font-size:0.75em">DEVIS</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#1e40af;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">6</div>
            <div style="font-size:0.75em">CONVENTION</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#ef4444;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">7</div>
            <div style="font-size:0.75em">CONCEPTION</div>
          </div>
        </div>
        
        <div style="background:#f0fdf4;border:1px solid #22c55e;border-radius:12px;padding:25px;max-width:700px;margin:0 auto;text-align:left">
          <h3 style="color:#22c55e;margin:0 0 15px 0">üéØ Ce que vous allez apprendre</h3>
          <ul style="margin:0;padding-left:20px;color:#374151;line-height:1.8">
            <li>Enregistrer et qualifier les demandes entrantes</li>
            <li>Cr√©er et envoyer un questionnaire d'analyse des besoins</li>
            <li>√âvaluer les r√©ponses et formaliser les pr√©conisations</li>
            <li>Planifier une session de formation</li>
            <li>√âtablir un devis et une convention</li>
            <li>G√©n√©rer les documents p√©dagogiques</li>
            <li>Respecter les exigences Qualiopi √† chaque √©tape</li>
          </ul>
        </div>
        
        <p style="margin-top:30px;color:#64748b">Cliquez sur <strong>Suivant</strong> pour commencer le tutoriel</p>
      </div>
    `,
    
    etape1:`
      <div style="max-width:900px;margin:0 auto">
        <div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;padding:20px;border-radius:12px;margin-bottom:25px;display:flex;align-items:center;gap:20px">
          <div style="background:white;color:#3b82f6;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:bold">1</div>
          <div>
            <h2 style="margin:0">DEMANDE - R√©ception et qualification</h2>
            <p style="margin:5px 0 0 0;opacity:0.9">Enregistrer et qualifier les demandes entrantes des clients</p>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px">
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#1e40af;margin:0 0 15px 0">üìç Acc√®s</h4>
            <p style="margin:0;color:#374151">Menu principal ‚Üí <strong>üì© Demandes</strong></p>
          </div>
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#22c55e;margin:0 0 15px 0">üèÜ Crit√®re Qualiopi</h4>
            <p style="margin:0;color:#374151"><strong>C1.4</strong> - D√©lai d'acc√®s < 48h</p>
          </div>
        </div>
        
        <h3 style="color:#374151;border-bottom:2px solid #3b82f6;padding-bottom:10px">‚ñ∂ Actions √† r√©aliser</h3>
        <ol style="color:#374151;line-height:2">
          <li>Cliquer sur <span style="background:#3b82f6;color:white;padding:3px 10px;border-radius:5px">‚ûï Nouvelle demande</span></li>
          <li>Remplir les informations du formulaire</li>
          <li>Enregistrer et suivre le statut</li>
        </ol>
        
        <h3 style="color:#374151;border-bottom:2px solid #3b82f6;padding-bottom:10px">üìã Champs du formulaire</h3>
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px">
          <thead>
            <tr style="background:#3b82f6;color:white">
              <th style="padding:12px;text-align:left;border:1px solid #2563eb">Champ</th>
              <th style="padding:12px;text-align:left;border:1px solid #2563eb">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0"><strong>Type</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Formation, Information, Devis, Inscription</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0"><strong>Canal</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Email, T√©l√©phone, Site web, R√©seaux sociaux</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0"><strong>Entreprise</strong></td><td style="padding:10px;border:1px solid #e2e8f0">S√©lectionner ou cr√©er une nouvelle entreprise</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0"><strong>Contact</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Nom, pr√©nom, email, t√©l√©phone</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0"><strong>Formation</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Formation souhait√©e (catalogue ou texte libre)</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0"><strong>Message</strong></td><td style="padding:10px;border:1px solid #e2e8f0">D√©tails de la demande</td></tr>
          </tbody>
        </table>
        
        <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:15px 20px;border-radius:0 8px 8px 0">
          <strong style="color:#b45309">üí° Astuce :</strong>
          <span style="color:#92400e">Les demandes re√ßues via le formulaire du site web sont automatiquement import√©es. Traitez-les sous 48h pour respecter Qualiopi.</span>
        </div>
      </div>
    `,
    
    etape2:`
      <div style="max-width:900px;margin:0 auto">
        <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:20px;border-radius:12px;margin-bottom:25px;display:flex;align-items:center;gap:20px">
          <div style="background:white;color:#8b5cf6;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:bold">2</div>
          <div>
            <h2 style="margin:0">ANALYSE - Envoi du questionnaire</h2>
            <p style="margin:5px 0 0 0;opacity:0.9">Recueillir les besoins pr√©cis du client via un questionnaire structur√©</p>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px">
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#8b5cf6;margin:0 0 15px 0">üìç Acc√®s</h4>
            <p style="margin:0;color:#374151">Menu ‚Üí <strong>üìã Analyse & √âval.</strong> ‚Üí Analyse</p>
          </div>
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#22c55e;margin:0 0 15px 0">üèÜ Crit√®re Qualiopi</h4>
            <p style="margin:0;color:#374151"><strong>C2.1</strong> - Analyse du besoin</p>
          </div>
        </div>
        
        <h3 style="color:#374151;border-bottom:2px solid #8b5cf6;padding-bottom:10px">‚ñ∂ Cr√©er une analyse depuis une demande</h3>
        <ol style="color:#374151;line-height:2">
          <li>Dans les demandes, cliquer sur <span style="background:#8b5cf6;color:white;padding:3px 10px;border-radius:5px">üìã Cr√©er analyse</span></li>
          <li>Les informations client sont pr√©-remplies</li>
          <li>S√©lectionner les questions √† inclure</li>
          <li>Personnaliser le message d'accompagnement</li>
          <li>Cliquer sur <span style="background:#3b82f6;color:white;padding:3px 10px;border-radius:5px">üìß Envoyer</span></li>
        </ol>
        
        <h3 style="color:#374151;border-bottom:2px solid #8b5cf6;padding-bottom:10px">üìã Questions du questionnaire</h3>
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px">
          <thead>
            <tr style="background:#8b5cf6;color:white">
              <th style="padding:12px;text-align:left;border:1px solid #7c3aed">Question</th>
              <th style="padding:12px;text-align:left;border:1px solid #7c3aed">Objectif Qualiopi</th>
            </tr>
          </thead>
          <tbody>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">Objectifs op√©rationnels</td><td style="padding:10px;border:1px solid #e2e8f0">Identifier les comp√©tences vis√©es (C2.1)</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0">Pr√©requis</td><td style="padding:10px;border:1px solid #e2e8f0">V√©rifier le niveau actuel (C2.3)</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">Modalit√©s souhait√©es</td><td style="padding:10px;border:1px solid #e2e8f0">Adapter le format de formation</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0">Dates souhait√©es</td><td style="padding:10px;border:1px solid #e2e8f0">Planifier la session</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">Nombre de stagiaires</td><td style="padding:10px;border:1px solid #e2e8f0">Dimensionner la formation</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0">Situation de handicap</td><td style="padding:10px;border:1px solid #e2e8f0">Adapter l'accueil PSH (C2.4)</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">Mode de financement</td><td style="padding:10px;border:1px solid #e2e8f0">Identifier l'OPCO</td></tr>
          </tbody>
        </table>
        
        <div style="background:#dbeafe;border-left:4px solid #3b82f6;padding:15px 20px;border-radius:0 8px 8px 0">
          <strong style="color:#1d4ed8">üìä Suivi :</strong>
          <span style="color:#1e40af">Le statut passe √† "Envoy√©" puis "R√©ponse re√ßue" quand le client r√©pond.</span>
        </div>
      </div>
    `,
    
    etape3:`
      <div style="max-width:900px;margin:0 auto">
        <div style="background:linear-gradient(135deg,#0891b2,#0e7490);color:white;padding:20px;border-radius:12px;margin-bottom:25px;display:flex;align-items:center;gap:20px">
          <div style="background:white;color:#0891b2;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:bold">3</div>
          <div>
            <h2 style="margin:0">√âVALUATION - Traitement des r√©ponses</h2>
            <p style="margin:5px 0 0 0;opacity:0.9">Analyser les r√©ponses et formaliser l'√©valuation des besoins</p>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px">
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#0891b2;margin:0 0 15px 0">üìç Acc√®s</h4>
            <p style="margin:0;color:#374151">Menu ‚Üí <strong>üìã Analyse & √âval.</strong> ‚Üí √âvaluation</p>
          </div>
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#22c55e;margin:0 0 15px 0">üèÜ Crit√®re Qualiopi</h4>
            <p style="margin:0;color:#374151"><strong>C2.3</strong> - Positionnement pr√©alable</p>
          </div>
        </div>
        
        <h3 style="color:#374151;border-bottom:2px solid #0891b2;padding-bottom:10px">‚ñ∂ Cr√©er une √©valuation</h3>
        <ol style="color:#374151;line-height:2">
          <li>S√©lectionner une analyse avec statut <strong>"R√©ponse re√ßue"</strong></li>
          <li>Cliquer sur <span style="background:#0891b2;color:white;padding:3px 10px;border-radius:5px">üìù √âvaluer</span></li>
          <li>Analyser les r√©ponses du client affich√©es</li>
          <li>Compl√©ter les champs d'√©valuation</li>
          <li>R√©diger la <strong>Synth√®se</strong> (obligatoire)</li>
          <li>Formuler les <strong>Pr√©conisations</strong></li>
          <li>G√©n√©rer le PDF de la fiche d'√©valuation</li>
        </ol>
        
        <h3 style="color:#374151;border-bottom:2px solid #0891b2;padding-bottom:10px">üìã Champs cl√©s</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px">
          <div style="background:#ecfeff;padding:15px;border-radius:8px;border:1px solid #0891b2">
            <strong style="color:#0891b2">Synth√®se de l'√©valuation</strong>
            <p style="margin:8px 0 0 0;font-size:0.9em;color:#374151">R√©sum√© de l'analyse des besoins - Document cl√© pour l'audit Qualiopi</p>
          </div>
          <div style="background:#ecfeff;padding:15px;border-radius:8px;border:1px solid #0891b2">
            <strong style="color:#0891b2">Pr√©conisations</strong>
            <p style="margin:8px 0 0 0;font-size:0.9em;color:#374151">Formation recommand√©e + dur√©e pr√©conis√©e</p>
          </div>
        </div>
        
        <div style="background:#f0fdf4;border-left:4px solid #22c55e;padding:15px 20px;border-radius:0 8px 8px 0">
          <strong style="color:#16a34a">‚úÖ Apr√®s validation :</strong>
          <span style="color:#15803d">Cliquez sur "Cr√©er session" pour passer √† la planification.</span>
        </div>
      </div>
    `,
    
    etape4:`
      <div style="max-width:900px;margin:0 auto">
        <div style="background:linear-gradient(135deg,#22c55e,#16a34a);color:white;padding:20px;border-radius:12px;margin-bottom:25px;display:flex;align-items:center;gap:20px">
          <div style="background:white;color:#22c55e;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:bold">4</div>
          <div>
            <h2 style="margin:0">SESSION - Planification de la formation</h2>
            <p style="margin:5px 0 0 0;opacity:0.9">Planifier avec dates, lieu et formateur</p>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px">
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#22c55e;margin:0 0 15px 0">üìç Acc√®s</h4>
            <p style="margin:0;color:#374151">Menu principal ‚Üí <strong>üìÖ Sessions</strong></p>
          </div>
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#22c55e;margin:0 0 15px 0">üèÜ Crit√®re Qualiopi</h4>
            <p style="margin:0;color:#374151"><strong>C4.1</strong> - Moyens p√©dagogiques</p>
          </div>
        </div>
        
        <h3 style="color:#374151;border-bottom:2px solid #22c55e;padding-bottom:10px">üìã Informations de la session</h3>
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px">
          <thead>
            <tr style="background:#22c55e;color:white">
              <th style="padding:12px;text-align:left">Champ</th>
              <th style="padding:12px;text-align:left">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0"><strong>Formation</strong></td><td style="padding:10px;border:1px solid #e2e8f0">S√©lection dans le catalogue</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0"><strong>Dates</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Date de d√©but et de fin</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0"><strong>Horaires</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Heures journali√®res</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0"><strong>Lieu</strong></td><td style="padding:10px;border:1px solid #e2e8f0">S√©lection ou "Dans vos locaux"</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0"><strong>Formateur</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Affectation (v√©rification disponibilit√©)</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0"><strong>Capacit√©</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Nombre maximum de stagiaires</td></tr>
          </tbody>
        </table>
        
        <h3 style="color:#374151;border-bottom:2px solid #22c55e;padding-bottom:10px">üë• Inscription des stagiaires</h3>
        <ol style="color:#374151;line-height:2">
          <li>Depuis la fiche session ‚Üí <span style="background:#22c55e;color:white;padding:3px 10px;border-radius:5px">üë• G√©rer stagiaires</span></li>
          <li>Ajouter les stagiaires (existants ou nouveaux)</li>
          <li>V√©rifier les informations PSH si applicable</li>
        </ol>
        
        <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:15px 20px;border-radius:0 8px 8px 0">
          <strong style="color:#b45309">‚ö†Ô∏è Important :</strong>
          <span style="color:#92400e">La session doit √™tre en statut "Confirm√©e" avant de g√©n√©rer la convention.</span>
        </div>
      </div>
    `,
    
    etape5:`
      <div style="max-width:900px;margin:0 auto">
        <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:20px;border-radius:12px;margin-bottom:25px;display:flex;align-items:center;gap:20px">
          <div style="background:white;color:#f59e0b;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:bold">5</div>
          <div>
            <h2 style="margin:0">DEVIS - Proposition commerciale</h2>
            <p style="margin:5px 0 0 0;opacity:0.9">√âtablir et envoyer le devis au client</p>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px">
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#f59e0b;margin:0 0 15px 0">üìç Acc√®s</h4>
            <p style="margin:0;color:#374151">Menu ‚Üí <strong>üìë Documents</strong> ‚Üí Devis</p>
          </div>
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#22c55e;margin:0 0 15px 0">üèÜ Crit√®re Qualiopi</h4>
            <p style="margin:0;color:#374151"><strong>C1.3</strong> - Conditions de r√©alisation</p>
          </div>
        </div>
        
        <h3 style="color:#374151;border-bottom:2px solid #f59e0b;padding-bottom:10px">üìã Cr√©ation du devis</h3>
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px">
          <thead>
            <tr style="background:#f59e0b;color:white">
              <th style="padding:12px;text-align:left">Champ</th>
              <th style="padding:12px;text-align:left">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0"><strong>Num√©ro</strong></td><td style="padding:10px;border:1px solid #e2e8f0">G√©n√©r√© automatiquement (DEV-XXXX)</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0"><strong>Formation</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Formation concern√©e</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0"><strong>Dur√©e / Stagiaires</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Nombre d'heures et effectif</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0"><strong>Prix HT / TTC</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Calcul√©s automatiquement</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0"><strong>Validit√©</strong></td><td style="padding:10px;border:1px solid #e2e8f0">Date limite du devis</td></tr>
          </tbody>
        </table>
        
        <h3 style="color:#374151;border-bottom:2px solid #f59e0b;padding-bottom:10px">üîÑ Cycle de vie</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px">
          <span style="background:#e2e8f0;padding:8px 15px;border-radius:20px">üìù Brouillon</span>
          <span style="color:#9ca3af">‚Üí</span>
          <span style="background:#dbeafe;color:#1d4ed8;padding:8px 15px;border-radius:20px">üì§ Envoy√©</span>
          <span style="color:#9ca3af">‚Üí</span>
          <span style="background:#dcfce7;color:#16a34a;padding:8px 15px;border-radius:20px">‚úÖ Accept√©</span>
          <span style="color:#9ca3af">‚Üí</span>
          <span style="background:#f0fdf4;color:#22c55e;padding:8px 15px;border-radius:20px">üìÑ Convention</span>
        </div>
        
        <div style="background:#dbeafe;border-left:4px solid #3b82f6;padding:15px 20px;border-radius:0 8px 8px 0">
          <strong style="color:#1d4ed8">üìß Envoi :</strong>
          <span style="color:#1e40af">Le devis peut √™tre g√©n√©r√© en PDF et envoy√© directement par email depuis le CRM.</span>
        </div>
      </div>
    `,
    
    etape6:`
      <div style="max-width:900px;margin:0 auto">
        <div style="background:linear-gradient(135deg,#1e40af,#1d4ed8);color:white;padding:20px;border-radius:12px;margin-bottom:25px;display:flex;align-items:center;gap:20px">
          <div style="background:white;color:#1e40af;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:bold">6</div>
          <div>
            <h2 style="margin:0">CONVENTION - Contractualisation</h2>
            <p style="margin:5px 0 0 0;opacity:0.9">Formaliser l'engagement entre l'OF et le client</p>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px">
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#1e40af;margin:0 0 15px 0">üìç Acc√®s</h4>
            <p style="margin:0;color:#374151">Menu ‚Üí <strong>üìë Documents</strong> ‚Üí Conventions</p>
          </div>
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#22c55e;margin:0 0 15px 0">üèÜ Crit√®re Qualiopi</h4>
            <p style="margin:0;color:#374151"><strong>C1.3</strong> - Contractualisation</p>
          </div>
        </div>
        
        <h3 style="color:#374151;border-bottom:2px solid #1e40af;padding-bottom:10px">üìã Contenu de la convention</h3>
        <ul style="color:#374151;line-height:2">
          <li>Reprend les informations du <strong>devis accept√©</strong></li>
          <li>Reprend les informations de la <strong>session planifi√©e</strong></li>
          <li>Intitul√© et objectifs de la formation</li>
          <li>Dates et lieu de r√©alisation</li>
          <li>Dur√©e et effectif</li>
          <li>Montant et conditions de r√®glement</li>
        </ul>
        
        <h3 style="color:#374151;border-bottom:2px solid #1e40af;padding-bottom:10px">‚úçÔ∏è Gestion des signatures</h3>
        <ol style="color:#374151;line-height:2">
          <li>G√©n√©rer le PDF de la convention</li>
          <li>Envoyer au client pour signature</li>
          <li>Une fois sign√©e, passer le statut √† <strong>"Sign√©e"</strong></li>
          <li>Archiver le document dans la GED</li>
        </ol>
        
        <div style="background:#ecfeff;border-left:4px solid #0891b2;padding:15px 20px;border-radius:0 8px 8px 0;margin-top:20px">
          <strong style="color:#0e7490">üí∂ Financement OPCO :</strong>
          <span style="color:#155e75">Acc√©dez √† l'onglet <strong>Prise en Charge</strong> pour cr√©er la demande de financement.</span>
        </div>
      </div>
    `,
    
    etape7:`
      <div style="max-width:900px;margin:0 auto">
        <div style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:20px;border-radius:12px;margin-bottom:25px;display:flex;align-items:center;gap:20px">
          <div style="background:white;color:#ef4444;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:bold">7</div>
          <div>
            <h2 style="margin:0">CONCEPTION - Documents p√©dagogiques</h2>
            <p style="margin:5px 0 0 0;opacity:0.9">Pr√©parer tous les documents n√©cessaires</p>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px">
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#ef4444;margin:0 0 15px 0">üìç Acc√®s</h4>
            <p style="margin:0;color:#374151">Menu principal ‚Üí <strong>‚úèÔ∏è Conception</strong></p>
          </div>
          <div style="background:#f8fafc;border-radius:10px;padding:20px;border:1px solid #e2e8f0">
            <h4 style="color:#22c55e;margin:0 0 15px 0">üèÜ Crit√®res Qualiopi</h4>
            <p style="margin:0;color:#374151"><strong>C3.1, C4.1, C7</strong></p>
          </div>
        </div>
        
        <h3 style="color:#374151;border-bottom:2px solid #ef4444;padding-bottom:10px">üìÑ Documents √† g√©n√©rer</h3>
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px">
          <thead>
            <tr style="background:#ef4444;color:white">
              <th style="padding:12px;text-align:left">Document</th>
              <th style="padding:12px;text-align:left">Description</th>
              <th style="padding:12px;text-align:center">Crit√®re</th>
            </tr>
          </thead>
          <tbody>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">Programme</td><td style="padding:10px;border:1px solid #e2e8f0">Objectifs, contenu, modalit√©s</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C1.1</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0">Convocations</td><td style="padding:10px;border:1px solid #e2e8f0">D√©tails pratiques stagiaires</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C1.4</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">Feuilles d'√©margement</td><td style="padding:10px;border:1px solid #e2e8f0">Suivi de pr√©sence</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C4.1</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0">Supports p√©dagogiques</td><td style="padding:10px;border:1px solid #e2e8f0">Diaporamas, exercices</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C3.1</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">Questionnaires √©valuation</td><td style="padding:10px;border:1px solid #e2e8f0">Pr√© et post-formation</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C2.3</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0">Questionnaire satisfaction</td><td style="padding:10px;border:1px solid #e2e8f0">Avis des stagiaires</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C7.1</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">Attestation</td><td style="padding:10px;border:1px solid #e2e8f0">D√©livr√©e √† l'issue</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C7.3</td></tr>
          </tbody>
        </table>
        
        <div style="background:#f0fdf4;border-left:4px solid #22c55e;padding:15px 20px;border-radius:0 8px 8px 0">
          <strong style="color:#16a34a">‚úÖ Archivage :</strong>
          <span style="color:#15803d">Tous les documents sont automatiquement horodat√©s et archiv√©s dans la GED pour la tra√ßabilit√© Qualiopi.</span>
        </div>
      </div>
    `,
    
    recap:`
      <div style="max-width:900px;margin:0 auto">
        <h1 style="text-align:center;color:#1e40af;margin-bottom:30px">üìä R√©capitulatif du Workflow</h1>
        
        <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:40px">
          <div style="background:#3b82f6;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">1</div>
            <div style="font-size:0.75em">DEMANDE</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#8b5cf6;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">2</div>
            <div style="font-size:0.75em">ANALYSE</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#0891b2;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">3</div>
            <div style="font-size:0.75em">√âVALUATION</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#22c55e;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">4</div>
            <div style="font-size:0.75em">SESSION</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#f59e0b;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">5</div>
            <div style="font-size:0.75em">DEVIS</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#1e40af;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">6</div>
            <div style="font-size:0.75em">CONVENTION</div>
          </div>
          <div style="color:#9ca3af;font-size:1.5em;display:flex;align-items:center">‚Üí</div>
          <div style="background:#ef4444;color:white;padding:12px 15px;border-radius:8px;text-align:center;min-width:90px">
            <div style="font-size:1.5em;font-weight:bold">7</div>
            <div style="font-size:0.75em">CONCEPTION</div>
          </div>
        </div>
        
        <table style="width:100%;border-collapse:collapse;margin-bottom:30px">
          <thead>
            <tr style="background:#1e40af;color:white">
              <th style="padding:12px;text-align:left">√âtape</th>
              <th style="padding:12px;text-align:left">Action principale</th>
              <th style="padding:12px;text-align:left">Document g√©n√©r√©</th>
              <th style="padding:12px;text-align:center">Qualiopi</th>
            </tr>
          </thead>
          <tbody>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">1. Demande</td><td style="padding:10px;border:1px solid #e2e8f0">Enregistrer la demande</td><td style="padding:10px;border:1px solid #e2e8f0">-</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C1.4</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0">2. Analyse</td><td style="padding:10px;border:1px solid #e2e8f0">Envoyer questionnaire</td><td style="padding:10px;border:1px solid #e2e8f0">Questionnaire</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C2.1</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">3. √âvaluation</td><td style="padding:10px;border:1px solid #e2e8f0">Analyser les r√©ponses</td><td style="padding:10px;border:1px solid #e2e8f0">Fiche √©valuation</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C2.3</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0">4. Session</td><td style="padding:10px;border:1px solid #e2e8f0">Planifier la formation</td><td style="padding:10px;border:1px solid #e2e8f0">Convocations</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C4.1</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">5. Devis</td><td style="padding:10px;border:1px solid #e2e8f0">√âtablir la proposition</td><td style="padding:10px;border:1px solid #e2e8f0">Devis PDF</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C1.3</td></tr>
            <tr><td style="padding:10px;border:1px solid #e2e8f0">6. Convention</td><td style="padding:10px;border:1px solid #e2e8f0">Contractualiser</td><td style="padding:10px;border:1px solid #e2e8f0">Convention PDF</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C1.3</td></tr>
            <tr style="background:#f8fafc"><td style="padding:10px;border:1px solid #e2e8f0">7. Conception</td><td style="padding:10px;border:1px solid #e2e8f0">Pr√©parer les supports</td><td style="padding:10px;border:1px solid #e2e8f0">Kit complet</td><td style="padding:10px;border:1px solid #e2e8f0;text-align:center">C3, C7</td></tr>
          </tbody>
        </table>
        
        <div style="background:#f0fdf4;border:2px solid #22c55e;border-radius:12px;padding:25px">
          <h3 style="color:#22c55e;margin:0 0 15px 0">üèÜ Points cl√©s pour la conformit√© Qualiopi</h3>
          <ul style="margin:0;color:#374151;line-height:2">
            <li>‚úÖ Tracer toutes les demandes et leur traitement (d√©lai < 48h)</li>
            <li>‚úÖ Formaliser l'analyse des besoins avec le questionnaire</li>
            <li>‚úÖ Documenter l'√©valuation et les pr√©conisations</li>
            <li>‚úÖ Archiver tous les documents dans la GED</li>
            <li>‚úÖ Suivre les indicateurs dans le tableau de bord Qualiopi</li>
          </ul>
        </div>
        
        <p style="text-align:center;margin-top:30px;color:#64748b">
          üéâ <strong>F√©licitations !</strong> Vous avez termin√© le tutoriel.
        </p>
      </div>
    `
  };
  
  return contenus[etape]||contenus.intro;
}

// Fonction loadQuali mise √† jour pour les nouvelles sections
async function loadQuali(q){
  if(q==='documents-quali'){
    await loadDocsQualiopi();
  }else if(q==='veille'){
    await loadVeille();
  }else if(q==='indicateurs'){
    showQualiopiIndicateurs();
  }else if(q==='aidar'){
    // Charger le module AIDAR
    await loadAIDAR();
  }else if(q==='ecarts-competences'){
    // Charger le module √âcarts de Comp√©tences
    await loadEcartsSessions();
    showEcartsTab(currentEcartsTab || 'sessions');
  }else if(q==='satisfactions'){
    // Charger les modalit√©s de recueil des appr√©ciations
    await loadAllSatisfactionKPIs();
    showSatisfactionTab(currentSatisfactionTab || 'chaud');
  }else if(q==='reclamations'){
    // Charger les r√©clamations avec KPIs
    await loadReclamationsKPIs();
    await loadReclamations();
  }else{
    await showTable(q==='evaluations-pre'?'evalPre':q==='evaluations-post'?'evalPost':q);
  }
}

// ============ TABLES ============
async function showTable(type){
  const maps=await getMaps();
  const data=await dbGetAll(type==='conception'?'conceptions':type);
  const tbody=document.getElementById('table-'+type);
  if(!tbody)return;
  
  // Filtrage sp√©cial pour formateurs
  let filteredData=data;
  if(type==='formateurs'){
    const filterType=document.getElementById('filter-type-formateur')?.value;
    if(filterType){
      filteredData=data.filter(f=>f.type===filterType);
    }
    // Charger absences et sessions pour afficher la disponibilit√©
    const [absences,sessions]=await Promise.all([
      dbGetAll('absences_formateurs'),
      dbGetAll('sessions')
    ]);
    maps.absences=absences;
    maps.sessions=sessions;
    
    // Afficher les absences en cours
    afficherAbsencesEnCours();
  }
  
  if(!filteredData.length){tbody.innerHTML=`<tr><td colspan="10" class="empty-state"><div class="empty-state-icon">üì≠</div><h3>Aucune donn√©e</h3></td></tr>`;return;}
  tbody.innerHTML=filteredData.map(d=>renderRow(type,d,maps)).join('');
}

async function getMaps(){
  const [ent,form,formateurs,lieux,comm,opps,analyses,devisAll,conv,dcps,stag,gest,actions,commerciaux]=await Promise.all([
    dbGetAll('entreprises'),dbGetAll('formations'),dbGetAll('formateurs'),dbGetAll('lieux'),dbGetAll('commerciaux'),
    dbGetAll('opportunites'),dbGetAll('analyses'),dbGetAll('devis'),dbGetAll('conventions'),dbGetAll('dpc'),
    dbGetAll('stagiaires'),dbGetAll('gestionnaires'),dbGetAll('actions'),dbGetAll('commerciaux')
  ]);
  return{ent:Object.fromEntries(ent.map(e=>[e.id,e])),form:Object.fromEntries(form.map(f=>[f.id,f])),formateurs:Object.fromEntries(formateurs.map(f=>[f.id,f])),lieux:Object.fromEntries(lieux.map(l=>[l.id,l])),comm:Object.fromEntries(comm.map(c=>[c.id,c])),opps:Object.fromEntries(opps.map(o=>[o.id,o])),analyses:Object.fromEntries(analyses.map(a=>[a.id,a])),devis:Object.fromEntries(devisAll.map(d=>[d.id,d])),conv:Object.fromEntries(conv.map(c=>[c.id,c])),dcps:Object.fromEntries(dcps.map(d=>[d.id,d])),stag:Object.fromEntries(stag.map(s=>[s.id,s])),gest:Object.fromEntries(gest.map(g=>[g.id,g])),actions:Object.fromEntries(actions.map(a=>[a.id,a])),commerciaux:Object.fromEntries(commerciaux.map(c=>[c.id,c]))};
}

function renderRow(type,d,m){
  const id=d.id,acts=`<td class="action-btns"><button class="btn btn-secondary btn-icon" onclick="openModal('${type.replace(/s$/,'')}',${id})">‚úèÔ∏è</button><button class="btn btn-danger btn-icon" onclick="confirmDelete('${type}',${id})">üóëÔ∏è</button></td>`;
  switch(type){
    case 'entreprises':const commEnt=m.commerciaux&&m.commerciaux[d.commercial];return`<tr><td><code>ENT-${String(id).padStart(3,'0')}</code></td><td><strong>${esc(d.nom)}</strong></td><td>${esc(d.enseigne||'-')}</td><td>${esc(d.ville||'-')}</td><td>${esc(d.contact||'-')}</td><td>${esc(d.mobileContact||'-')}</td><td>${commEnt?esc(commEnt.nom)+' '+(commEnt.prenom||''):'-'}</td><td>${esc(d.secteurActivite||'-')}</td><td>${esc(d.siret||'-')}</td><td>${esc(d.opco||'-')}</td><td>${d.nbSalaries||'-'}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'Prospect'}</span></td>${acts}</tr>`;
    case 'opportunites':return`<tr><td><code>OPP-${String(id).padStart(3,'0')}</code></td><td><strong>${esc(d.nom)}</strong></td><td>${m.ent[d.entreprise]?esc(m.ent[d.entreprise].nom):'-'}</td><td>${m.form[d.formation]?esc(m.form[d.formation].nom):'-'}</td><td><span class="etape etape-${slug(d.etape)}">${d.etape||'-'}</span></td><td class="montant">${fmt(d.montant)}</td><td><span class="status status-${slug(d.etat)}">${d.etat||'-'}</span></td>${acts}</tr>`;
    case 'analyses':return`<tr><td><code>ANA-${String(id).padStart(3,'0')}</code></td><td><strong>${esc(d.clientNom||'')} ${esc(d.clientPrenom||'')}</strong></td><td>${esc(d.clientEntreprise||'-')}</td><td>${esc(d.clientVille||'-')}</td><td>${esc(d.formationTexte||'-')}</td><td>${fmtDate(d.dateAnalyse)}</td><td>${trunc(d.synthese,30)||'-'}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td><td class="action-btns"><button class="btn btn-success btn-icon" onclick="genererPDFAnalyseById(${id})" title="G√©n√©rer PDF">üìÑ</button><button class="btn btn-secondary btn-icon" onclick="openModal('analyse',${id})">‚úèÔ∏è</button><button class="btn btn-danger btn-icon" onclick="confirmDelete('analyses',${id})">üóëÔ∏è</button></td></tr>`;
    case 'evaluations':return`<tr><td><code>EVA-${String(id).padStart(3,'0')}</code></td><td>ANA-${String(d.analyse).padStart(3,'0')}</td><td>${fmtDate(d.dateEvaluation)}</td><td>${trunc(d.niveauInitial,18)}</td><td>${trunc(d.preconisations,20)}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td>${acts}</tr>`;
    case 'devis':const ttc=(d.montantHT||0)*(1+(d.tva||20)/100);return`<tr><td><code>${d.numero||'DEV-'+String(id).padStart(4,'0')}</code></td><td>${m.opps[d.opportunite]?esc(m.opps[d.opportunite].nom):'-'}</td><td>${m.form[d.formation]?esc(m.form[d.formation].nom):'-'}</td><td class="montant">${fmt(d.montantHT)}</td><td class="montant">${fmt(ttc)}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td>${acts}</tr>`;
    case 'conventions':return`<tr><td><code>${d.numero||'CONV-'+String(id).padStart(4,'0')}</code></td><td>${m.devis[d.devis]?(m.devis[d.devis].numero||'DEV-'+d.devis):'-'}</td><td>${m.form[d.formation]?esc(m.form[d.formation].nom):'-'}</td><td>${fmtDate(d.dateDebut)} - ${fmtDate(d.dateFin)}</td><td>${d.duree||'-'}h</td><td>${m.lieux[d.lieu]?esc(m.lieux[d.lieu].nom):'-'}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td>${acts}</tr>`;
    case 'actions':return`<tr><td><code>ACT-${String(id).padStart(3,'0')}</code></td><td>${m.conv[d.convention]?(m.conv[d.convention].numero||'CONV-'+d.convention):'-'}</td><td>${m.formateurs[d.formateur]?esc(m.formateurs[d.formateur].nom):'-'}</td><td>${fmtDate(d.date)}</td><td>${m.lieux[d.lieu]?esc(m.lieux[d.lieu].nom):'-'}</td><td>${d.nbStagiaires||0}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td>${acts}</tr>`;
    case 'dcp':return`<tr><td><code>DCP-${String(id).padStart(3,'0')}</code></td><td>${m.conv[d.convention]?(m.conv[d.convention].numero||'CONV-'+d.convention):'-'}</td><td>${trunc(d.objectifs,20)}</td><td>${trunc(d.modalites,20)}</td><td>${trunc(d.evaluation,18)}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td>${acts}</tr>`;
    case 'conception':return`<tr><td><code>CON-${String(id).padStart(3,'0')}</code></td><td>${m.dcps[d.dcp]?'DCP-'+d.dcp:'-'}</td><td>${trunc(d.modules,18)}</td><td>${trunc(d.supports,18)}</td><td>${d.progression||0}%</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td>${acts}</tr>`;
    case 'stagiaires':return`<tr><td><code>STG-${String(id).padStart(3,'0')}</code></td><td>${esc(d.nom)}</td><td>${esc(d.prenom||'')}</td><td>${m.ent[d.entreprise]?esc(m.ent[d.entreprise].nom):'-'}</td><td>${esc(d.email||'-')}</td><td>${d.psh?'‚úì':'-'}</td>${acts}</tr>`;
    case 'commerciaux':return`<tr><td><code>COM-${String(id).padStart(3,'0')}</code></td><td>${esc(d.nom)}</td><td>${esc(d.prenom||'')}</td><td>${esc(d.email||'-')}</td><td class="montant">${fmt(d.objectifCA)}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'Actif'}</span></td>${acts}</tr>`;
    case 'formations':return`<tr><td><code>${esc(d.code||'F-'+id)}</code></td><td><strong>${esc(d.nom)}</strong></td><td>${esc(d.domaine||'-')}</td><td>${d.duree||'-'}h</td><td class="montant">${fmt(d.prixHT)}</td><td>${esc(d.certification||'-')}</td>${acts}</tr>`;
    case 'formateurs':
      // Calculer le statut de disponibilit√©
      let dispoLabel='Disponible',dispoCouleur='#10b981',dispoIcon='‚úÖ';
      const today=new Date();today.setHours(0,0,0,0);
      
      if(d.type==='Interne'&&m.absences){
        const absenceEnCours=m.absences.find(a=>{
          if(a.formateurId!=d.id)return false;
          const debut=new Date(a.dateDebut);
          const fin=new Date(a.dateFin);
          return debut<=today&&fin>=today;
        });
        if(absenceEnCours){
          const typeAbs=TYPES_ABSENCE.find(t=>t.code===absenceEnCours.type);
          dispoLabel=typeAbs?.label||'Absent';
          dispoCouleur=typeAbs?.couleur||'#ef4444';
          dispoIcon='üö´';
        }
      }
      
      if(dispoLabel==='Disponible'&&m.sessions){
        const sessionAuj=m.sessions.find(s=>{
          if(s.formateur!=d.id||s.statut==='Annul√©e')return false;
          const debut=new Date(s.dateDebutPrev||s.dateDebutEffective);
          const fin=new Date(s.dateFinPrev||s.dateFinEffective||debut);
          return debut<=today&&fin>=today;
        });
        if(sessionAuj){
          dispoLabel='En formation';
          dispoCouleur='#8b5cf6';
          dispoIcon='üìö';
        }
      }
      
      if(d.type==='Externe'&&dispoLabel==='Disponible'){
        dispoLabel='Non d√©clar√©';
        dispoCouleur='#9ca3af';
        dispoIcon='‚ùì';
      }
      
      return`<tr><td><code>FOR-${String(id).padStart(3,'0')}</code></td><td><strong>${esc(d.nom)} ${esc(d.prenom||'')}</strong></td><td>${esc(d.specialites||'-')}</td><td class="montant">${fmt(d.tarifJour||d.tarifJournalier)}</td><td><span style="background:${d.type==='Interne'?'#3b82f6':'#10b981'};color:white;padding:2px 8px;border-radius:4px;font-size:0.75em">${d.type==='Interne'?'üè¢ Interne':'üåê Externe'}</span></td><td><span class="status status-${slug(d.statut)}">${d.statut||'Actif'}</span></td><td><span style="background:${dispoCouleur};color:white;padding:3px 8px;border-radius:4px;font-size:0.75em">${dispoIcon} ${dispoLabel}</span></td>${acts}</tr>`;
    case 'lieux':return`<tr><td><code>LIEU-${String(id).padStart(3,'0')}</code></td><td><strong>${esc(d.nom)}</strong></td><td>${esc(d.ville||'-')}</td><td>${d.capacite||'-'}</td><td>${d.pmr||'-'}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'Actif'}</span></td>${acts}</tr>`;
    case 'materiel':return`<tr><td><code>MAT-${String(id).padStart(3,'0')}</code></td><td><strong>${esc(d.nom)}</strong></td><td>${esc(d.categorie||'-')}</td><td>${d.quantite||1}</td><td><span class="status status-${slug(d.etat)}">${d.etat||'Bon √©tat'}</span></td>${acts}</tr>`;
    case 'sessions':
      const entSess=m.ent&&m.ent[d.entreprise];
      const stagCnt=d.stagiaires?d.stagiaires.split(',').filter(s=>s).length:0;
      const montantSess=d.typeChiffrage==='Forfait Journalier'?(d.nbJours||0)*(d.forfaitJour||0):d.typeChiffrage==='Forfait Horaire'?(d.tauxHoraire||0)*(d.nbHeures||0)*(d.nbStagiairesChiffrage||1):(d.montantGlobal||0);
      return`<tr><td><code>SES-${String(id).padStart(3,'0')}</code></td><td>${m.form[d.formation]?esc(m.form[d.formation].nom):'-'}</td><td>${entSess?esc(entSess.nom):'-'}</td><td><span class="status status-${slug(d.typeFormation)}">${d.typeFormation||'Pr√©sentiel'}</span></td><td><span class="priority priority-${d.modalite==='Intra'?'urgente':'normale'}">${d.modalite||'Inter'}</span></td><td>${d.modalite==='Intra'?trunc(d.lieuIntra,15):(m.lieux[d.lieu]?esc(m.lieux[d.lieu].nom):'-')}</td><td>${d.dateDebutPrev?fmtDate(d.dateDebutPrev):'-'}</td><td>${d.dateDebutEffective?fmtDate(d.dateDebutEffective):'-'}</td><td>${stagCnt}</td><td><small>${d.typeChiffrage||'Forfait'}</small></td><td><strong>${fmtMoney(montantSess)}</strong></td><td><span class="status status-${slug(d.statut)}">${d.statut||'Planifi√©e'}</span></td>${acts}</tr>`;
    case 'gestionnaires':return`<tr><td><code>USR-${String(id).padStart(3,'0')}</code></td><td><strong>${esc(d.username)}</strong></td><td>${esc(d.nom||'-')}</td><td>${esc(d.prenom||'-')}</td><td>${esc(d.email||'-')}</td><td><span class="role role-${slug(d.role)}">${d.role||'-'}</span></td><td><span class="status status-${slug(d.statut)}">${d.statut||'Actif'}</span></td><td>${d.lastLogin?fmtDate(d.lastLogin):'-'}</td>${acts}</tr>`;
    case 'emargements':return`<tr><td><code>EMG-${String(id).padStart(3,'0')}</code></td><td>${m.actions[d.action]?'ACT-'+d.action:'-'}</td><td>${m.stag[d.stagiaire]?esc(m.stag[d.stagiaire].nom):'-'}</td><td>${fmtDate(d.date)}</td><td>${d.matin?'‚úì':'-'}</td><td>${d.apresmidi?'‚úì':'-'}</td><td>${d.signature?'‚úì':'-'}</td>${acts}</tr>`;
    case 'evalPre':return`<tr><td><code>EPR-${String(id).padStart(3,'0')}</code></td><td>${m.stag[d.stagiaire]?esc(m.stag[d.stagiaire].nom):'-'}</td><td>${m.form[d.formation]?esc(m.form[d.formation].nom):'-'}</td><td>${fmtDate(d.date)}</td><td>${d.niveau||'-'}</td><td>${trunc(d.attentes,18)}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td>${acts}</tr>`;
    case 'evalPost':return`<tr><td><code>EPO-${String(id).padStart(3,'0')}</code></td><td>${m.stag[d.stagiaire]?esc(m.stag[d.stagiaire].nom):'-'}</td><td>${m.form[d.formation]?esc(m.form[d.formation].nom):'-'}</td><td>${fmtDate(d.date)}</td><td>${d.note||'-'}/20</td><td>${trunc(d.acquis,18)}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td>${acts}</tr>`;
    case 'satisfactions':return`<tr><td><code>SAT-${String(id).padStart(3,'0')}</code></td><td>${m.stag[d.stagiaire]?esc(m.stag[d.stagiaire].nom):'-'}</td><td>${m.form[d.formation]?esc(m.form[d.formation].nom):'-'}</td><td>${fmtDate(d.date)}</td><td>${d.noteGlobale||'-'}/5</td><td>${d.recommande?'Oui':'Non'}</td><td>${trunc(d.commentaire,18)}</td>${acts}</tr>`;
    case 'reclamations':return`<tr><td><code>REC-${String(id).padStart(3,'0')}</code></td><td>${fmtDate(d.date)}</td><td>${esc(d.origine||'-')}</td><td>${trunc(d.objet,20)}</td><td>${trunc(d.traitement,18)}</td><td>${d.delai||'-'}j</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td>${acts}</tr>`;
    case 'attestations':return`<tr><td><code>ATT-${String(id).padStart(4,'0')}</code></td><td>${m.stag[d.stagiaire]?esc(m.stag[d.stagiaire].nom):'-'}</td><td>${m.form[d.formation]?esc(m.form[d.formation].nom):'-'}</td><td>${fmtDate(d.date)}</td><td>${d.duree||'-'}h</td><td>${trunc(d.acquis,20)}</td>${acts}</tr>`;
    case 'ameliorations':return`<tr><td><code>AME-${String(id).padStart(3,'0')}</code></td><td>${esc(d.type||'-')}</td><td>${esc(d.origine||'-')}</td><td>${trunc(d.description,20)}</td><td>${m.gest[d.responsable]?esc(m.gest[d.responsable].nom):'-'}</td><td>${fmtDate(d.echeance)}</td><td><span class="status status-${slug(d.statut)}">${d.statut||'-'}</span></td>${acts}</tr>`;
    default:return'';
  }
}

// ============ HISTORIQUE/PARAMS ============
async function showHistorique(){const data=await dbGetAll('historique');data.sort((a,b)=>new Date(b.date)-new Date(a.date));const el=document.getElementById('historique-list');if(!data.length){el.innerHTML='<div class="empty-state"><div class="empty-state-icon">üìú</div><h3>Aucun historique</h3></div>';return;}el.innerHTML=data.slice(0,50).map(h=>`<div style="padding:.35rem 0;border-bottom:1px solid var(--gray-100);font-size:.7rem"><small style="color:var(--gray-500)">${new Date(h.date).toLocaleString('fr-FR')}</small> - <strong>${esc(h.user||'Syst√®me')}</strong> : ${esc(h.action)} - ${esc(h.details)}</div>`).join('');}
async function clearHistory(){if(confirm('Vider ?')){await dbClear('historique');toast('Vid√©','success');showHistorique();}}
async function addHistory(action,details){await dbAdd('historique',{action,details,user:currentUser?.username||'Syst√®me',date:new Date().toISOString()});}
async function loadParams(){const p=await dbGetAll('parametres');if(p.length>0){const d=p[0];['nom','nda','siret','qualiopi','adresse','email'].forEach(k=>{const el=document.getElementById('param-'+k);if(el&&d[k])el.value=d[k];});}}
async function saveParams(){const p=await dbGetAll('parametres');const d={};['nom','nda','siret','qualiopi','adresse','email'].forEach(k=>{const el=document.getElementById('param-'+k);if(el)d[k]=el.value;});if(p.length>0){d.id=p[0].id;await dbPut('parametres',d);}else await dbAdd('parametres',d);toast('Param√®tres enregistr√©s','success');}

// ============ MODAL FORMS ============
const FORMS={
  demande:()=>`<input type="hidden" id="f-id">
    <div class="form-row"><div class="form-group"><label class="form-label">Nom *</label><input class="form-input" id="f-nom" required></div><div class="form-group"><label class="form-label">Pr√©nom *</label><input class="form-input" id="f-prenom" required></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Email *</label><input class="form-input" id="f-email" type="email" required></div><div class="form-group"><label class="form-label">T√©l√©phone</label><input class="form-input" id="f-telephone"></div></div>
    
    <!-- Section SIREN/SIRET avec recherche Pappers -->
    <div style="background:#f0f9ff;padding:15px;border-radius:10px;margin:15px 0;border:2px solid #3b82f6">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <span style="font-size:1.2em">üîç</span>
        <strong style="color:#1e40af">Recherche automatique par SIREN / SIRET</strong>
      </div>
      <div class="form-row">
        <div class="form-group" style="flex:1">
          <label class="form-label">N¬∞ SIREN (9 chiffres) ou SIRET (14 chiffres)</label>
          <div style="display:flex;gap:8px">
            <input class="form-input" id="f-siren" maxlength="14" placeholder="Ex: 832940670 ou 83294067000012" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <button type="button" class="btn btn-primary" onclick="rechercherSIREN()" style="white-space:nowrap" title="Rechercher sur Pappers.fr">üîç Pappers</button>
          </div>
          <small style="color:#64748b">SIREN = 9 chiffres | SIRET = 14 chiffres (SIREN + NIC)</small>
        </div>
        <div class="form-group" style="flex:1">
          <label class="form-label">IDCC (Convention Collective)</label>
          <select class="form-select" id="f-idcc-demande" onchange="onIDCCChangeDemande()">
            <option value="">-- S√©lectionner --</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group" style="flex:1">
          <label class="form-label">OPCO</label>
          <div style="display:flex;gap:8px">
            <select class="form-select" id="f-opco" style="flex:1">
              <option value="">-- S√©lectionner --</option>
              <option>AKTO</option>
              <option>OPCO EP</option>
              <option>OPCO Atlas</option>
              <option>OPCO Mobilit√©s</option>
              <option>OPCO Sant√©</option>
              <option>L'Opcommerce</option>
              <option>OPCO 2i</option>
              <option>AFDAS</option>
              <option>Ocapiat</option>
              <option>Constructys</option>
              <option>Uniformation</option>
              <option>Autre</option>
            </select>
            <button type="button" class="btn btn-success" onclick="rechercherOPCO()" style="white-space:nowrap" title="Rechercher sur France Comp√©tences">üè¢ OPCO</button>
          </div>
        </div>
        <div class="form-group" style="flex:1">
          <label class="form-label">Secteur d'activit√©</label>
          <input class="form-input" id="f-secteurActivite-demande" placeholder="Auto-rempli avec IDCC">
        </div>
      </div>
      
      <!-- Zone de r√©sultat de la recherche -->
      <div id="siren-result-zone" style="display:none;margin-top:10px;padding:10px;background:white;border-radius:8px;border:1px solid #e2e8f0">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <strong style="color:#16a34a">‚úÖ Entreprise trouv√©e</strong>
          <button type="button" class="btn btn-sm btn-success" onclick="appliquerInfosSIREN()">üì• Appliquer les infos</button>
        </div>
        <div id="siren-result-content" style="font-size:0.9em;line-height:1.6"></div>
      </div>
    </div>
    
    <div class="form-group"><label class="form-label">Raison sociale</label><input class="form-input" id="f-raisonSociale"></div>
    <div class="form-group"><label class="form-label">Adresse</label><input class="form-input" id="f-adresse"></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Code postal</label><input class="form-input" id="f-codePostal" maxlength="5"></div><div class="form-group"><label class="form-label">Ville</label><input class="form-input" id="f-ville"></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Code NAF/APE</label><input class="form-input" id="f-codeNAF" placeholder="Ex: 56.10A"></div><div class="form-group"><label class="form-label">Effectif salari√©</label><input class="form-input" id="f-effectif" type="number" min="0"></div></div>
    <div class="form-group"><label class="form-label">Formations int√©ress√©es</label><input class="form-input" id="f-formationsInteressees" placeholder="Ex: Management, Excel, HACCP..."></div>
    <div class="form-group"><label class="form-label">Besoins sp√©cifiques</label><textarea class="form-textarea" id="f-besoinsSpecifiques"></textarea></div>
    <div class="form-group"><label class="form-label">Message</label><textarea class="form-textarea" id="f-message"></textarea></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Commercial assign√©</label><select class="form-select" id="f-commercialAssigne"><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Priorit√©</label><select class="form-select" id="f-priorite"><option>Urgente</option><option selected>Normale</option><option>Basse</option></select></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>Nouveau</option><option>En cours</option><option>Trait√©</option><option>Converti</option><option>Archiv√©</option></select></div><div class="form-group" id="group-emailPro" style="display:none"><label class="form-label">üìß Email professionnel (envoi)</label><input class="form-input" id="f-emailPro" type="email" placeholder="Email pour envoi des notifications"></div></div>
    <div class="form-group"><label class="form-label"><input type="checkbox" id="f-envoyerAccuseReception" checked> Envoyer un accus√© de r√©ception au client</label></div>
    <div class="form-group"><label class="form-label"><input type="checkbox" id="f-notifierCommercial" checked> Notifier le commercial assign√©</label></div>`,
  entreprise:()=>`<input type="hidden" id="f-id">
    <div class="form-row"><div class="form-group"><label class="form-label">Entreprise (Raison Sociale) *</label><input class="form-input" id="f-nom" required></div><div class="form-group"><label class="form-label">Enseigne</label><input class="form-input" id="f-enseigne"></div></div>
    <div class="form-group"><label class="form-label">Adresse</label><input class="form-input" id="f-adresse"></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Code Postal</label><input class="form-input" id="f-codePostal" maxlength="5"></div><div class="form-group"><label class="form-label">Ville</label><input class="form-input" id="f-ville"></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">üìß Email Professionnel</label><input class="form-input" id="f-emailPro" type="email" placeholder="Email principal de l'entreprise"></div><div class="form-group"><label class="form-label">üìÖ Date de cr√©ation</label><input class="form-input" id="f-dateCreationEntreprise" type="date"></div></div>
    <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
    <h4 style="font-size:.8rem;color:var(--gray-600);margin-bottom:.5rem">üë§ Contact Principal</h4>
    <div class="form-row"><div class="form-group"><label class="form-label">Contact (Nom Pr√©nom)</label><input class="form-input" id="f-contact"></div><div class="form-group"><label class="form-label">Qualit√© du contact</label><input class="form-input" id="f-qualiteContact" placeholder="Ex: DRH, G√©rant, Responsable Formation..."></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Email du contact</label><input class="form-input" id="f-emailContact" type="email"></div><div class="form-group"><label class="form-label">N¬∞ Mobile du contact</label><input class="form-input" id="f-mobileContact" placeholder="06 XX XX XX XX"></div></div>
    <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
    <h4 style="font-size:.8rem;color:var(--gray-600);margin-bottom:.5rem">üìä Informations Entreprise</h4>
    <div class="form-row"><div class="form-group"><label class="form-label">Commercial assign√©</label><select class="form-select" id="f-commercial"><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Secteur d'activit√©</label><input class="form-input" id="f-secteurActivite" placeholder="Ex: Restauration, BTP, Commerce..."></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">N¬∞ SIRET</label><input class="form-input" id="f-siret" maxlength="14" placeholder="14 chiffres"></div><div class="form-group"><label class="form-label">IDCC (Convention Collective)</label><select class="form-select" id="f-idcc" onchange="onIDCCChange()"><option value="">-- S√©lectionner ou rechercher --</option></select></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">OPCO</label><select class="form-select" id="f-opco"><option value="">S√©lectionner...</option><option>AKTO</option><option>OPCO EP</option><option>OPCO Atlas</option><option>OPCO Mobilit√©s</option><option>OPCO Sant√©</option><option>L'Opcommerce</option><option>OPCO 2i</option><option>AFDAS</option><option>Ocapiat</option><option>Constructys</option><option>Uniformation</option><option>Autre</option></select></div><div class="form-group"><label class="form-label">Nombre de salari√©s</label><input class="form-input" id="f-nbSalaries" type="number" min="0"></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>Prospect</option><option>Actif</option><option>Inactif</option></select></div><div class="form-group" id="group-codeActivation" style="display:none"><label class="form-label">üîê Code Activation</label><input class="form-input" id="f-codeActivation" placeholder="Code interne"></div></div>`,
  opportunite:()=>`<input type="hidden" id="f-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nom de l'opportunit√© *</label><input class="form-input" id="f-nom" required placeholder="Ex: Formation HACCP - Restaurant XYZ"></div>
      <div class="form-group"><label class="form-label">Entreprise *</label><select class="form-select" id="f-entreprise" required onchange="onOpportuniteEntrepriseChange()"><option value="">S√©lectionner...</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Ville</label><input class="form-input" id="f-ville" readonly style="background:var(--gray-100)"></div>
      <div class="form-group"><label class="form-label">Interlocuteur</label><input class="form-input" id="f-interlocuteur" readonly style="background:var(--gray-100)"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">N¬∞ Mobile</label><input class="form-input" id="f-mobile" readonly style="background:var(--gray-100)"></div>
      <div class="form-group"><label class="form-label">Source</label><select class="form-select" id="f-source"><option>Demande entrante</option><option>Prospection</option><option>Recommandation</option><option>Site web</option><option>Salon/√âv√©nement</option><option>Autre</option></select></div>
    </div>
    <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
    <div class="form-row">
      <div class="form-group"><label class="form-label">√âtape actuelle</label><select class="form-select" id="f-etape"><option>Prospection</option><option>Analyse</option><option>√âvaluation</option><option>Devis</option><option>Convention</option><option>Action Formation</option><option>DCP</option><option>Conception</option></select></div>
      <div class="form-group"><label class="form-label">Avancement du dossier (%)</label><input class="form-input" id="f-avancement" type="number" min="0" max="100" value="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Montant estim√© (‚Ç¨)</label><input class="form-input" id="f-montant" type="number" min="0" step="0.01"></div>
      <div class="form-group"><label class="form-label">% R√©ussite</label><input class="form-input" id="f-pourcentageReussite" type="number" min="0" max="100" value="50"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Date de cl√¥ture pr√©vue</label><input class="form-input" id="f-dateCloture" type="date"></div>
      <div class="form-group"><label class="form-label">Priorit√©</label><select class="form-select" id="f-priorite"><option>Haute</option><option selected>Moyenne</option><option>Basse</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">√âtat</label><select class="form-select" id="f-etat" onchange="onOpportuniteEtatChange()"><option>En cours</option><option>Gagn√©</option><option>Perdu</option></select></div>
      <div class="form-group" id="group-motif-echec" style="display:none"><label class="form-label">Motif de l'√©chec</label><select class="form-select" id="f-motifEchec"><option value="">S√©lectionner...</option><option>Prix trop √©lev√©</option><option>Concurrence</option><option>Budget insuffisant</option><option>Projet report√©</option><option>Projet annul√©</option><option>Pas de r√©ponse</option><option>Autre</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="f-notes" placeholder="Informations compl√©mentaires..."></textarea></div>`,
  stagiaire:()=>`<input type="hidden" id="f-id">
    <div class="form-row"><div class="form-group"><label class="form-label">Nom *</label><input class="form-input" id="f-nom" required></div><div class="form-group"><label class="form-label">Pr√©nom *</label><input class="form-input" id="f-prenom" required></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Entreprise *</label><select class="form-select" id="f-entreprise" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Fonction</label><input class="form-input" id="f-fonction" placeholder="Ex: Cuisinier, Manager..."></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Email</label><input class="form-input" id="f-email" type="email"></div><div class="form-group"><label class="form-label">T√©l√©phone</label><input class="form-input" id="f-telephone"></div></div>
    <div class="form-group"><label class="form-label"><input type="checkbox" id="f-psh"> Personne en Situation de Handicap (PSH)</label></div>
    <div id="group-infos-confidentielles" style="display:none">
      <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
      <h4 style="font-size:.75rem;color:var(--gray-600);margin-bottom:.5rem">üîê Informations confidentielles (Admin/Gestionnaire)</h4>
      <div class="form-row"><div class="form-group"><label class="form-label">Date de naissance</label><input class="form-input" id="f-dateNaissance" type="date"></div><div class="form-group"><label class="form-label">N¬∞ S√©curit√© Sociale</label><input class="form-input" id="f-numSecu" maxlength="15" placeholder="15 chiffres"></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Taux horaire (‚Ç¨)</label><input class="form-input" id="f-tauxHoraire" type="number" step="0.01" min="0"></div><div class="form-group"></div></div>
    </div>`,
  commercial:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Nom *</label><input class="form-input" id="f-nom" required></div><div class="form-group"><label class="form-label">Pr√©nom</label><input class="form-input" id="f-prenom"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Email *</label><input class="form-input" id="f-email" type="email" required></div><div class="form-group"><label class="form-label">Objectif CA</label><input class="form-input" id="f-objectifCA" type="number" min="0"></div></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>Actif</option><option>Inactif</option></select></div>`,
  formation:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Code</label><input class="form-input" id="f-code"></div><div class="form-group"><label class="form-label">Intitul√© *</label><input class="form-input" id="f-nom" required></div></div><div class="form-row"><div class="form-group"><label class="form-label">Domaine</label><input class="form-input" id="f-domaine"></div><div class="form-group"><label class="form-label">Dur√©e (h)</label><input class="form-input" id="f-duree" type="number" min="0"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Prix HT (‚Ç¨)</label><input class="form-input" id="f-prixHT" type="number" min="0"></div><div class="form-group"><label class="form-label">Certification</label><input class="form-input" id="f-certification"></div></div>`,
  formateur:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Nom *</label><input class="form-input" id="f-nom" required></div><div class="form-group"><label class="form-label">Pr√©nom</label><input class="form-input" id="f-prenom"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Email *</label><input class="form-input" id="f-email" type="email" required></div><div class="form-group"><label class="form-label">Sp√©cialit√©s</label><input class="form-input" id="f-specialites"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Tarif jour (‚Ç¨)</label><input class="form-input" id="f-tarifJour" type="number" min="0"></div><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="f-type"><option>Interne</option><option>Externe</option></select></div></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>Actif</option><option>Inactif</option></select></div>`,
  lieu:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Nom *</label><input class="form-input" id="f-nom" required></div><div class="form-group"><label class="form-label">Ville</label><input class="form-input" id="f-ville"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Capacit√©</label><input class="form-input" id="f-capacite" type="number" min="1"></div><div class="form-group"><label class="form-label">PMR</label><select class="form-select" id="f-pmr"><option>Oui</option><option>Non</option></select></div></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>Actif</option><option>Inactif</option></select></div>`,
  materiel:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">D√©signation *</label><input class="form-input" id="f-nom" required></div><div class="form-group"><label class="form-label">Cat√©gorie</label><select class="form-select" id="f-categorie"><option>Informatique</option><option>Audiovisuel</option><option>Mobilier</option><option>P√©dagogique</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Quantit√©</label><input class="form-input" id="f-quantite" type="number" min="1" value="1"></div><div class="form-group"><label class="form-label">√âtat</label><select class="form-select" id="f-etat"><option>Neuf</option><option selected>Bon √©tat</option><option>Us√©</option></select></div></div>`,
  session:()=>`<input type="hidden" id="f-id"><input type="hidden" id="f-stagiaires">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Formation *</label><select class="form-select" id="f-formation" required><option value="">S√©lectionner...</option></select></div>
      <div class="form-group"><label class="form-label">Entreprise *</label><select class="form-select" id="f-entreprise" required onchange="onSessionEntrepriseChange()"><option value="">S√©lectionner...</option></select></div>
    </div>
    <div class="form-group">
      <label class="form-label">üë• Stagiaires de l'entreprise</label>
      <div id="session-stagiaires-container" style="border:1px solid var(--gray-200);border-radius:8px;max-height:200px;overflow-y:auto">
        <table style="width:100%;font-size:0.75rem">
          <thead style="background:var(--gray-100);position:sticky;top:0">
            <tr>
              <th style="padding:0.5rem;width:40px;text-align:center"><input type="checkbox" id="check-all-stagiaires" onchange="toggleAllStagiaires(this.checked)" title="Tout s√©lectionner"></th>
              <th style="padding:0.5rem">ID</th>
              <th style="padding:0.5rem">Nom</th>
              <th style="padding:0.5rem">Pr√©nom</th>
              <th style="padding:0.5rem;width:50px;text-align:center">PSH</th>
            </tr>
          </thead>
          <tbody id="session-stagiaires-list">
            <tr><td colspan="5" style="padding:1rem;text-align:center;color:var(--gray-400)">S√©lectionnez une entreprise</td></tr>
          </tbody>
        </table>
      </div>
      <small style="color:var(--gray-500)">Cochez les stagiaires √† inscrire √† cette session</small>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Type de formation</label><select class="form-select" id="f-typeFormation"><option>Pr√©sentiel</option><option>Distanciel</option><option>Mixte</option></select></div>
      <div class="form-group"><label class="form-label">Modalit√©</label><select class="form-select" id="f-modalite" onchange="onSessionModaliteChange()"><option>Inter</option><option>Intra</option></select></div>
    </div>
    <div class="form-group" id="group-lieu-inter"><label class="form-label">Lieu (Inter)</label><select class="form-select" id="f-lieu"><option value="">S√©lectionner...</option></select></div>
    <div class="form-group" id="group-lieu-intra" style="display:none"><label class="form-label">Lieu (Intra - Adresse entreprise)</label><input class="form-input" id="f-lieuIntra" readonly placeholder="S√©lectionnez une entreprise"></div>
    <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
    <h4 style="font-size:.75rem;color:var(--gray-600);margin-bottom:.5rem">üìÖ Dates</h4>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Date d√©but pr√©visionnelle</label><input class="form-input" id="f-dateDebutPrev" type="date"></div>
      <div class="form-group"><label class="form-label">Date fin pr√©visionnelle</label><input class="form-input" id="f-dateFinPrev" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Date d√©but effective</label><input class="form-input" id="f-dateDebutEffective" type="date"></div>
      <div class="form-group"><label class="form-label">Date fin effective</label><input class="form-input" id="f-dateFinEffective" type="date"></div>
    </div>
    <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
    <h4 style="font-size:.75rem;color:var(--gray-600);margin-bottom:.5rem">üí∞ Chiffrage</h4>
    <div class="form-group"><label class="form-label">Type de chiffrage</label><select class="form-select" id="f-typeChiffrage" onchange="onSessionChiffrageChange()"><option>Forfait Total</option><option>Forfait Journalier</option><option>Forfait Horaire</option></select></div>
    <div id="chiffrage-forfait-total">
      <div class="form-group"><label class="form-label">Montant global (‚Ç¨)</label><input class="form-input" id="f-montantGlobal" type="number" step="0.01" min="0" value="0" onchange="updateSessionMontant()"></div>
    </div>
    <div id="chiffrage-forfait-journalier" style="display:none">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Nombre de jours</label><input class="form-input" id="f-nbJours" type="number" min="0" value="1" onchange="updateSessionMontant()"></div>
        <div class="form-group"><label class="form-label">Montant forfait/jour (‚Ç¨)</label><input class="form-input" id="f-forfaitJour" type="number" step="0.01" min="0" value="0" onchange="updateSessionMontant()"></div>
      </div>
      <div class="form-group"><label class="form-label">Montant global calcul√© (‚Ç¨)</label><input class="form-input" id="f-montantJournalier" type="number" step="0.01" readonly style="background:var(--gray-100)"></div>
    </div>
    <div id="chiffrage-forfait-horaire" style="display:none">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Taux horaire (‚Ç¨)</label><input class="form-input" id="f-tauxHoraire" type="number" step="0.01" min="0" value="0" onchange="updateSessionMontant()"></div>
        <div class="form-group"><label class="form-label">Nombre d'heures</label><input class="form-input" id="f-nbHeures" type="number" min="0" value="1" onchange="updateSessionMontant()"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Nombre de stagiaires</label><input class="form-input" id="f-nbStagiairesChiffrage" type="number" min="1" value="1" onchange="updateSessionMontant()"></div>
        <div class="form-group"><label class="form-label">Montant global calcul√© (‚Ç¨)</label><input class="form-input" id="f-montantHoraire" type="number" step="0.01" readonly style="background:var(--gray-100)"></div>
      </div>
    </div>
    <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>Planifi√©e</option><option>En cours</option><option>Termin√©e</option><option>Annul√©e</option></select></div>
      <div class="form-group"><label class="form-label">Session confirm√©e ?</label><select class="form-select" id="f-confirme"><option value="">Non confirm√©e</option><option value="oui">‚úÖ Confirm√©e</option></select></div>
    </div>
    <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
    <h4 style="font-size:.75rem;color:var(--gray-600);margin-bottom:.5rem">üë®‚Äçüè´ Formateur</h4>
    <div class="form-group">
      <div style="display:flex;gap:10px;align-items:flex-end;margin-bottom:10px">
        <div style="flex:1">
          <label class="form-label">Formateur assign√©</label>
          <select class="form-select" id="f-formateur"><option value="">S√©lectionner...</option></select>
        </div>
        <button type="button" class="btn btn-info" onclick="verifierDisponibilitesFormateurs()" style="height:38px">üîç V√©rifier disponibilit√©s</button>
      </div>
      <div id="session-formateurs-dispo" style="display:none;margin-top:10px;padding:12px;border-radius:8px;background:#f0fdf4;border:1px solid #86efac">
        <div style="font-weight:600;color:#166534;margin-bottom:8px">‚úÖ Formateurs disponibles pour cette p√©riode :</div>
        <div id="session-formateurs-dispo-list"></div>
      </div>
      <div id="session-formateurs-indispo" style="display:none;margin-top:10px;padding:12px;border-radius:8px;background:#fef2f2;border:1px solid #fca5a5">
        <div style="font-weight:600;color:#991b1b;margin-bottom:8px">‚ö†Ô∏è Formateurs occup√©s ou sans disponibilit√© d√©clar√©e :</div>
        <div id="session-formateurs-indispo-list"></div>
      </div>
    </div>
    <div class="form-group"><label class="form-label">üìù Notes</label><textarea class="form-textarea" id="f-notes" rows="2" placeholder="Notes ou observations sur la session..."></textarea></div>`,
  analyse:()=>`<input type="hidden" id="f-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Opportunit√©</label><select class="form-select" id="f-opportunite" onchange="onAnalyseOpportuniteChange()"><option value="">S√©lectionner...</option></select></div>
      <div class="form-group"><label class="form-label">Date d'analyse</label><input class="form-input" id="f-dateAnalyse" type="date"></div>
    </div>
    
    <div style="background:var(--blue-50);padding:1rem;border-radius:8px;margin-bottom:1rem">
      <h4 style="font-size:.8rem;color:var(--blue-700);margin-bottom:.5rem">üì• Import des donn√©es</h4>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button type="button" class="btn btn-info btn-sm" onclick="ouvrirImportGoogleSheets()">üìã Coller depuis Google Sheets</button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="ouvrirMailAnalyse()">üì§ Envoyer questionnaire</button>
        <button type="button" class="btn btn-warning btn-sm" onclick="recupererAnalyseExistante()">üîç R√©cup√©rer analyse existante</button>
      </div>
    </div>
    
    <hr style="margin:1rem 0;border:none;border-top:2px solid var(--primary)">
    <h4 style="font-size:.85rem;color:var(--primary);margin-bottom:1rem">üìã FICHE √âVALUATION BESOIN CLIENT</h4>
    
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nom *</label><input class="form-input" id="f-clientNom" required></div>
      <div class="form-group"><label class="form-label">Pr√©nom *</label><input class="form-input" id="f-clientPrenom" required></div>
    </div>
    <div class="form-group"><label class="form-label">Adresse</label><input class="form-input" id="f-clientAdresse"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Code Postal</label><input class="form-input" id="f-clientCP" maxlength="5"></div>
      <div class="form-group"><label class="form-label">Ville</label><input class="form-input" id="f-clientVille"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="f-clientEmail" type="email"></div>
      <div class="form-group"><label class="form-label">T√©l√©phone</label><input class="form-input" id="f-clientTel"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Entreprise</label><input class="form-input" id="f-clientEntreprise"></div>
      <div class="form-group"><label class="form-label">Num√©ro SIRET</label><input class="form-input" id="f-clientSiret" maxlength="14"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Situation de handicap</label><select class="form-select" id="f-situationHandicap"><option>NON</option><option>OUI</option></select></div>
      <div class="form-group"><label class="form-label">Nombre de salari√©s</label><input class="form-input" id="f-nbSalaries" type="number" min="0"></div>
    </div>
    <div class="form-group"><label class="form-label">Autres besoins non identifi√©s pr√©c√©demment ?</label><select class="form-select" id="f-autresBesoinsIdentifies"><option>NON</option><option>OUI</option></select></div>
    
    <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
    <h4 style="font-size:.75rem;color:var(--orange-600);margin-bottom:.5rem">üìÖ Besoin pour quelle date</h4>
    <div class="form-group"><input class="form-input" id="f-besoinDate" placeholder="Ex: octobre, janvier 2025..."></div>
    
    <h4 style="font-size:.75rem;color:var(--orange-600);margin-bottom:.5rem">üìù Besoin g√©n√©ral</h4>
    <div class="form-group"><textarea class="form-textarea" id="f-besoinGeneral" rows="3" placeholder="Ex: Difficult√© √©conomique, Mutations technologiques, Mieux g√©rer la client√®le, R√©glementation..."></textarea></div>
    
    <h4 style="font-size:.75rem;color:var(--orange-600);margin-bottom:.5rem">üìö Pr√©requis des formations demand√©es</h4>
    <div class="form-group"><textarea class="form-textarea" id="f-prerequis" rows="2" placeholder="Voir le programme de formation"></textarea></div>
    
    <h4 style="font-size:.75rem;color:var(--orange-600);margin-bottom:.5rem">üéØ D√©tails des objectifs op√©rationnels du client</h4>
    <div class="form-group"><textarea class="form-textarea" id="f-objectifsClient" rows="3" placeholder="Ex: Augmentation des ventes, Baisse des co√ªts, Meilleure motivation des salari√©s..."></textarea></div>
    
    <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
    <h4 style="font-size:.75rem;color:var(--green-600);margin-bottom:.5rem">üöÄ Actions √† entreprendre</h4>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Modalit√©s</label><select class="form-select" id="f-modalitesFormation"><option>Dans vos locaux</option><option>Dans nos locaux</option><option>√Ä distance</option><option>Mixte</option></select></div>
      <div class="form-group"><label class="form-label">Autres Besoins</label><select class="form-select" id="f-autresBesoins"><option>NON</option><option>OUI</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Formation demand√©e</label><select class="form-select" id="f-formation"><option value="">S√©lectionner...</option></select></div>
    <div class="form-group"><label class="form-label">Formation (texte libre)</label><input class="form-input" id="f-formationTexte" placeholder="Ex: piloter mon application mobile DC WEB"></div>
    
    <hr style="margin:1rem 0;border:none;border-top:2px solid var(--success)">
    <h4 style="font-size:.85rem;color:var(--success);margin-bottom:.5rem">üìù SYNTH√àSE DE L'ANALYSE</h4>
    <div class="form-group"><textarea class="form-textarea" id="f-synthese" rows="5" placeholder="R√©digez ici votre synth√®se de l'analyse des besoins..."></textarea></div>
    
    <div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>En cours</option><option>Valid√©</option><option>Annul√©</option></select></div>
    
    <hr style="margin:1rem 0;border:none;border-top:1px solid var(--gray-200)">
    <div class="form-group">
      <button type="button" class="btn btn-success" onclick="genererPDFAnalyse()">üìÑ G√©n√©rer le PDF de la fiche</button>
    </div>`,
  evaluation:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Analyse *</label><select class="form-select" id="f-analyse" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Date</label><input class="form-input" id="f-dateEvaluation" type="date"></div></div><div class="form-group"><label class="form-label">Niveau initial</label><textarea class="form-textarea" id="f-niveauInitial"></textarea></div><div class="form-group"><label class="form-label">Pr√©conisations</label><textarea class="form-textarea" id="f-preconisations"></textarea></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>En cours</option><option>Valid√©</option><option>Annul√©</option></select></div>`,
  devis:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Opportunit√© *</label><select class="form-select" id="f-opportunite" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Formation</label><select class="form-select" id="f-formation"><option value="">S√©lectionner...</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Montant HT (‚Ç¨)</label><input class="form-input" id="f-montantHT" type="number" min="0"></div><div class="form-group"><label class="form-label">TVA (%)</label><input class="form-input" id="f-tva" type="number" value="20"></div></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>Brouillon</option><option>Envoy√©</option><option>Valid√©</option><option>Refus√©</option></select></div>`,
  convention:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Devis *</label><select class="form-select" id="f-devis" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Formation</label><select class="form-select" id="f-formation"><option value="">S√©lectionner...</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Date d√©but *</label><input class="form-input" id="f-dateDebut" type="date" required></div><div class="form-group"><label class="form-label">Date fin *</label><input class="form-input" id="f-dateFin" type="date" required></div></div><div class="form-row"><div class="form-group"><label class="form-label">Dur√©e (h)</label><input class="form-input" id="f-duree" type="number" min="0"></div><div class="form-group"><label class="form-label">Lieu</label><select class="form-select" id="f-lieu"><option value="">S√©lectionner...</option></select></div></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>Brouillon</option><option>Envoy√©e</option><option>Sign√©e</option><option>Annul√©e</option></select></div>`,
  action:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Convention *</label><select class="form-select" id="f-convention" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Formateur</label><select class="form-select" id="f-formateur"><option value="">S√©lectionner...</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Date *</label><input class="form-input" id="f-date" type="date" required></div><div class="form-group"><label class="form-label">Lieu</label><select class="form-select" id="f-lieu"><option value="">S√©lectionner...</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Nb Stagiaires</label><input class="form-input" id="f-nbStagiaires" type="number" min="0"></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>Planifi√©e</option><option>En cours</option><option>Termin√©e</option><option>Annul√©e</option></select></div></div>`,
  dpc:()=>`<input type="hidden" id="f-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">N¬∞ Prise en Charge</label><input class="form-input" id="f-numero" placeholder="PEC-001"></div>
      <div class="form-group"><label class="form-label">Convention</label><select class="form-select" id="f-convention"><option value="">S√©lectionner...</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Entreprise *</label><select class="form-select" id="f-entrepriseId" required onchange="onSelectEntrepriseDPC()"><option value="">S√©lectionner...</option></select></div>
      <div class="form-group"><label class="form-label">Nom entreprise</label><input class="form-input" id="f-entreprise" readonly></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">IDCC (Convention Collective)</label><select class="form-select" id="f-idcc-dpc" onchange="onIDCCChangeDPC()"><option value="">-- S√©lectionner --</option></select></div>
      <div class="form-group"><label class="form-label">OPCO *</label><select class="form-select" id="f-opco" required><option value="">S√©lectionner...</option><option>AKTO</option><option>OPCO EP</option><option>OPCO Atlas</option><option>OPCO Mobilit√©s</option><option>OPCO Sant√©</option><option>L'Opcommerce</option><option>OPCO 2i</option><option>AFDAS</option><option>Ocapiat</option><option>Constructys</option><option>Uniformation</option><option>Autre</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">N¬∞ Adh√©rent OPCO</label><input class="form-input" id="f-numAdherent" placeholder="Num√©ro adh√©rent"></div>
      <div class="form-group"><label class="form-label">Secteur d'activit√©</label><input class="form-input" id="f-secteurActivite-dpc" placeholder="Auto-rempli avec IDCC"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Montant demand√© (‚Ç¨) *</label><input class="form-input" id="f-montantDemande" type="number" step="0.01" required></div>
      <div class="form-group"><label class="form-label">Montant accord√© (‚Ç¨)</label><input class="form-input" id="f-montantAccorde" type="number" step="0.01"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Date de d√©p√¥t</label><input class="form-input" id="f-dateDepot" type="date"></div>
      <div class="form-group"><label class="form-label">Date du r√©sultat</label><input class="form-input" id="f-dateResultat" type="date"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">üìÖ Date limite accord OPCO *</label><input class="form-input" id="f-dateLimiteOPCO" type="date" title="Date avant laquelle la formation doit se terminer"></div>
      <div class="form-group"><label class="form-label">Session li√©e</label><select class="form-select" id="f-sessionId"><option value="">S√©lectionner...</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Date transmission docs post-formation</label><input class="form-input" id="f-dateTransmissionDocs" type="date"></div>
      <div class="form-group"><label class="form-label">Date d'encaissement</label><input class="form-input" id="f-dateEncaissement" type="date"></div>
    </div>
    <div class="form-group"><label class="form-label">Statut *</label><select class="form-select" id="f-statut" required><option value="Transmis">üì§ Transmis</option><option value="Accord√©">‚úÖ Accord√©</option><option value="Demande d'information">‚ùì Demande d'information</option><option value="Refus√©">‚ùå Refus√©</option><option value="Annul√©">üö´ Annul√©</option></select></div>
    <div class="form-group"><label class="form-label">Commentaires</label><textarea class="form-textarea" id="f-commentaires" rows="2" placeholder="Informations compl√©mentaires..."></textarea></div>
    <div class="form-group">
      <label class="form-label">üìé Courrier OPCO (PDF, JPG, PNG - max 10 Mo)</label>
      <div style="border:2px dashed #cbd5e1;border-radius:8px;padding:15px;text-align:center;background:#f8fafc">
        <input type="file" id="f-courrierOpco" accept=".pdf,.jpg,.jpeg,.png" onchange="previewCourrierOPCO(this)" style="display:none">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('f-courrierOpco').click()">üì§ S√©lectionner un fichier</button>
        <div id="f-courrierOpco-preview" style="margin-top:10px"></div>
      </div>
    </div>`,
  conception:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">DCP *</label><select class="form-select" id="f-dcp" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Progression (%)</label><input class="form-input" id="f-progression" type="number" min="0" max="100" value="0"></div></div><div class="form-group"><label class="form-label">Modules</label><textarea class="form-textarea" id="f-modules"></textarea></div><div class="form-group"><label class="form-label">Supports</label><textarea class="form-textarea" id="f-supports"></textarea></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>En cours</option><option>Termin√©</option><option>Valid√©</option></select></div>`,
  gestionnaire:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Identifiant *</label><input class="form-input" id="f-username" required></div><div class="form-group"><label class="form-label">Mot de passe *</label><input class="form-input" id="f-passwordNew" type="password" placeholder="Laisser vide si modification"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="f-nom"></div><div class="form-group"><label class="form-label">Pr√©nom</label><input class="form-input" id="f-prenom"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Email</label><input class="form-input" id="f-email" type="email"></div><div class="form-group"><label class="form-label">R√¥le *</label><select class="form-select" id="f-role" required><option>Admin</option><option>Gestionnaire</option><option>Commercial</option><option>Formateur</option></select></div></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>Actif</option><option>Inactif</option></select></div>`,
  emargement:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Action *</label><select class="form-select" id="f-action" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Stagiaire *</label><select class="form-select" id="f-stagiaire" required><option value="">S√©lectionner...</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Date *</label><input class="form-input" id="f-date" type="date" required></div></div><div class="form-row"><div class="form-group"><label class="form-label"><input type="checkbox" id="f-matin"> Matin</label></div><div class="form-group"><label class="form-label"><input type="checkbox" id="f-apresmidi"> Apr√®s-midi</label></div><div class="form-group"><label class="form-label"><input type="checkbox" id="f-signature"> Sign√©</label></div></div>`,
  evalPre:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Stagiaire *</label><select class="form-select" id="f-stagiaire" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Formation *</label><select class="form-select" id="f-formation" required><option value="">S√©lectionner...</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Date</label><input class="form-input" id="f-date" type="date"></div><div class="form-group"><label class="form-label">Niveau</label><select class="form-select" id="f-niveau"><option>D√©butant</option><option>Interm√©diaire</option><option>Avanc√©</option></select></div></div><div class="form-group"><label class="form-label">Attentes</label><textarea class="form-textarea" id="f-attentes"></textarea></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>En attente</option><option>Compl√©t√©</option></select></div>`,
  evalPost:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Stagiaire *</label><select class="form-select" id="f-stagiaire" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Formation *</label><select class="form-select" id="f-formation" required><option value="">S√©lectionner...</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Date</label><input class="form-input" id="f-date" type="date"></div><div class="form-group"><label class="form-label">Note /20</label><input class="form-input" id="f-note" type="number" min="0" max="20"></div></div><div class="form-group"><label class="form-label">Acquis</label><textarea class="form-textarea" id="f-acquis"></textarea></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>En attente</option><option>Valid√©</option><option>Non valid√©</option></select></div>`,
  satisfaction:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Stagiaire *</label><select class="form-select" id="f-stagiaire" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Formation *</label><select class="form-select" id="f-formation" required><option value="">S√©lectionner...</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Date</label><input class="form-input" id="f-date" type="date"></div><div class="form-group"><label class="form-label">Note /5</label><input class="form-input" id="f-noteGlobale" type="number" min="1" max="5"></div></div><div class="form-group"><label class="form-label"><input type="checkbox" id="f-recommande"> Recommande</label></div><div class="form-group"><label class="form-label">Commentaire</label><textarea class="form-textarea" id="f-commentaire"></textarea></div>`,
  reclamation:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Date *</label><input class="form-input" id="f-date" type="date" required></div><div class="form-group"><label class="form-label">Origine</label><select class="form-select" id="f-origine"><option>Stagiaire</option><option>Entreprise</option><option>Financeur</option><option>Autre</option></select></div></div><div class="form-group"><label class="form-label">Objet *</label><textarea class="form-textarea" id="f-objet" required></textarea></div><div class="form-group"><label class="form-label">Traitement</label><textarea class="form-textarea" id="f-traitement"></textarea></div><div class="form-row"><div class="form-group"><label class="form-label">D√©lai (j)</label><input class="form-input" id="f-delai" type="number" min="0"></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>En cours</option><option>R√©solu</option><option>Annul√©</option></select></div></div>`,
  attestation:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Stagiaire *</label><select class="form-select" id="f-stagiaire" required><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">Formation *</label><select class="form-select" id="f-formation" required><option value="">S√©lectionner...</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Date</label><input class="form-input" id="f-date" type="date"></div><div class="form-group"><label class="form-label">Dur√©e (h)</label><input class="form-input" id="f-duree" type="number" min="0"></div></div><div class="form-group"><label class="form-label">Acquis</label><textarea class="form-textarea" id="f-acquis"></textarea></div>`,
  amelioration:()=>`<input type="hidden" id="f-id"><div class="form-row"><div class="form-group"><label class="form-label">Type *</label><select class="form-select" id="f-type" required><option>Corrective</option><option>Pr√©ventive</option><option>Am√©lioration</option></select></div><div class="form-group"><label class="form-label">Origine</label><select class="form-select" id="f-origine"><option>R√©clamation</option><option>Audit</option><option>Satisfaction</option><option>Autre</option></select></div></div><div class="form-group"><label class="form-label">Description *</label><textarea class="form-textarea" id="f-description" required></textarea></div><div class="form-row"><div class="form-group"><label class="form-label">Responsable</label><select class="form-select" id="f-responsable"><option value="">S√©lectionner...</option></select></div><div class="form-group"><label class="form-label">√âch√©ance</label><input class="form-input" id="f-echeance" type="date"></div></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>En cours</option><option>Termin√©</option><option>Annul√©</option></select></div>`,
  email:()=>`<input type="hidden" id="f-id">
    <div class="form-row"><div class="form-group"><label class="form-label">Type *</label><select class="form-select" id="f-type" required><option>Accus√© de r√©ception</option><option>Notification commercial</option><option>Autre</option></select></div><div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="f-statut"><option>En attente</option><option>Envoy√©</option><option>Erreur</option></select></div></div>
    <div class="form-group"><label class="form-label">Destinataire *</label><input class="form-input" id="f-destinataire" type="email" required placeholder="email@exemple.fr"></div>
    <div class="form-group"><label class="form-label">Sujet *</label><input class="form-input" id="f-sujet" required></div>
    <div class="form-group"><label class="form-label">Corps du message *</label><textarea class="form-textarea" id="f-corps" required style="min-height:150px"></textarea></div>
    <div class="form-group"><label class="form-label">Li√© √† la demande</label><select class="form-select" id="f-demandeId"><option value="">Aucune</option></select></div>`
};

const STORE_MAP={demande:'demandes',entreprise:'entreprises',opportunite:'opportunites',stagiaire:'stagiaires',commercial:'commerciaux',formation:'formations',formateur:'formateurs',lieu:'lieux',materiel:'materiel',session:'sessions',analyse:'analyses',evaluation:'evaluations',devis:'devis',convention:'conventions',action:'actions',dpc:'dpc',conception:'conceptions',gestionnaire:'gestionnaires',emargement:'emargements',evalPre:'evalPre',evalPost:'evalPost',satisfaction:'satisfactions',reclamation:'reclamations',attestation:'attestations',amelioration:'ameliorations',email:'emails'};
const NAMES={demande:'Demande',entreprise:'Entreprise',opportunite:'Opportunit√©',stagiaire:'Stagiaire',commercial:'Commercial',formation:'Formation',formateur:'Formateur',lieu:'Lieu',materiel:'Mat√©riel',session:'Session',analyse:'Analyse',evaluation:'√âvaluation',devis:'Devis',convention:'Convention',action:'Action',dpc:'Prise en Charge',conception:'Conception',gestionnaire:'Gestionnaire',emargement:'√âmargement',evalPre:'√âval. Pr√©',evalPost:'√âval. Post',satisfaction:'Satisfaction',reclamation:'R√©clamation',attestation:'Attestation',amelioration:'Am√©lioration',email:'Email'};

async function openModal(type,id=null){
  try{
    currentModal=type;editId=id;
    document.getElementById('modal-title').textContent=(id?'Modifier ':'Nouveau ')+NAMES[type];
    if(!FORMS[type]){
      toast('Formulaire non trouv√© pour: '+type,'error');
      return;
    }
    document.getElementById('modal-body').innerHTML=FORMS[type]();
    await loadSelects();
    if(id)await loadData(type,id);
    
    // Initialisation sp√©ciale pour les sessions
    if(type==='session'&&!id){
      setTimeout(()=>{
        onSessionModaliteChange();
        onSessionChiffrageChange();
      },50);
    }
    
    // Initialisation sp√©ciale pour les opportunit√©s
    if(type==='opportunite'){
      setTimeout(()=>{
        onOpportuniteEtatChange();
        if(id)onOpportuniteEntrepriseChange();
      },50);
    }
    
    // Initialisation sp√©ciale pour les analyses
    if(type==='analyse'&&id){
      setTimeout(()=>{
        onAnalyseOpportuniteChange();
      },50);
    }
    
    document.getElementById('modal').classList.add('active');
  }catch(err){
    console.error('Erreur openModal:',err);
    toast('Erreur ouverture formulaire: '+err.message,'error');
  }
}

function closeModal(){document.getElementById('modal').classList.remove('active');currentModal=null;editId=null;}

async function loadSelects(){
  try{
    const [ent,form,formateurs,lieux,opps,analyses,devisAll,conv,dcps,stag,gest,actions,comm,demandes,sessions]=await Promise.all([
      dbGetAll('entreprises'),dbGetAll('formations'),dbGetAll('formateurs'),dbGetAll('lieux'),
      dbGetAll('opportunites'),dbGetAll('analyses'),dbGetAll('devis'),dbGetAll('conventions'),dbGetAll('dpc'),
      dbGetAll('stagiaires'),dbGetAll('gestionnaires'),dbGetAll('actions'),dbGetAll('commerciaux'),dbGetAll('demandes'),dbGetAll('sessions')
    ]);
    const commActifs=comm.filter(c=>c.statut==='Actif'||!c.statut);
    const formateursActifs=formateurs.filter(f=>f.statut==='Actif'||!f.statut);
    const lieuxActifs=lieux.filter(l=>l.statut==='Actif'||!l.statut);
    const fills={
      'f-entreprise':ent.length?ent.map(e=>`<option value="${e.id}">${esc(e.nom)}</option>`).join(''):'',
      'f-entrepriseId':ent.length?ent.map(e=>`<option value="${e.id}">${esc(e.nom)}</option>`).join(''):'',
      'f-formation':form.map(f=>`<option value="${f.id}">${esc(f.nom)}</option>`).join(''),
      'f-formateur':formateursActifs.map(f=>`<option value="${f.id}">${esc(f.nom)} ${esc(f.prenom||'')} (${f.type||'Interne'})</option>`).join(''),
      'f-lieu':lieuxActifs.map(l=>`<option value="${l.id}">${esc(l.nom)}${l.ville?' - '+esc(l.ville):''}</option>`).join(''),
      'f-opportunite':opps.map(o=>`<option value="${o.id}">${esc(o.nom)}</option>`).join(''),
      'f-analyse':analyses.map(a=>`<option value="${a.id}">ANA-${a.id}${a.clientNom?' - '+esc(a.clientNom):''}</option>`).join(''),
      'f-devis':devisAll.map(d=>`<option value="${d.id}">${d.numero||'DEV-'+d.id}</option>`).join(''),
      'f-convention':conv.map(c=>`<option value="${c.id}">${c.numero||'CONV-'+c.id} - ${esc(c.entreprise||'')}</option>`).join(''),
      'f-dcp':dcps.map(d=>`<option value="${d.id}">${d.numero||'PEC-'+d.id}</option>`).join(''),
      'f-stagiaire':stag.map(s=>`<option value="${s.id}">${esc(s.nom)} ${esc(s.prenom||'')}</option>`).join(''),
      'f-responsable':gest.map(g=>`<option value="${g.id}">${esc(g.nom||g.username)}</option>`).join(''),
      'f-action':actions.map(a=>`<option value="${a.id}">ACT-${a.id}</option>`).join(''),
      'f-commercialAssigne':commActifs.map(c=>`<option value="${c.id}">${esc(c.nom)} ${esc(c.prenom||'')}${c.email?' - '+esc(c.email):''}</option>`).join(''),
      'f-commercial':commActifs.map(c=>`<option value="${c.id}">${esc(c.nom)} ${esc(c.prenom||'')}</option>`).join(''),
      'f-demandeId':demandes.map(d=>`<option value="${d.id}">DEM-${String(d.id).padStart(3,'0')} - ${esc(d.raisonSociale||d.nom||'')}</option>`).join(''),
      'f-sessionId':sessions.map(s=>{const formName=form.find(f=>f.id==s.formation)?.nom||'';const entName=ent.find(e=>e.id==s.entreprise)?.nom||'';return `<option value="${s.id}">SES-${String(s.id).padStart(3,'0')} - ${esc(formName)} - ${esc(entName)}</option>`;}).join('')
    };
    Object.entries(fills).forEach(([id,opts])=>{
      const el=document.getElementById(id);
      if(el){
        // Pour les select multiples, pas de "S√©lectionner..."
        if(el.multiple){
          el.innerHTML=opts;
        }else{
          el.innerHTML='<option value="">S√©lectionner...</option>'+opts;
        }
      }
    });
    
    // Charger les IDCC dans les selects
    await chargerIDCCDansSelects();
  
  // Afficher le champ email pro (demandes) seulement pour Admin et Gestionnaire
  const emailProGroup=document.getElementById('group-emailPro');
  if(emailProGroup && currentUser && (currentUser.role==='Admin'||currentUser.role==='Gestionnaire')){
    emailProGroup.style.display='block';
  }
  
  // Afficher le champ code activation (entreprises) seulement pour Admin et Gestionnaire
  const codeActivationGroup=document.getElementById('group-codeActivation');
  if(codeActivationGroup && currentUser && (currentUser.role==='Admin'||currentUser.role==='Gestionnaire')){
    codeActivationGroup.style.display='block';
  }
  
  // Afficher les informations confidentielles des stagiaires seulement pour Admin et Gestionnaire
  const infosConfidentielles=document.getElementById('group-infos-confidentielles');
  if(infosConfidentielles && currentUser && (currentUser.role==='Admin'||currentUser.role==='Gestionnaire')){
    infosConfidentielles.style.display='block';
  }
  }catch(err){
    console.error('Erreur loadSelects:',err);
  }
}

async function loadData(type,id){
  const store=STORE_MAP[type];
  const data=await dbGet(store,id);
  if(!data)return;
  document.getElementById('f-id').value=data.id;
  Object.keys(data).forEach(k=>{
    const el=document.getElementById('f-'+k);
    if(el){
      if(el.type==='checkbox')el.checked=!!data[k];
      else if(el.multiple&&el.tagName==='SELECT'){
        // Select multiple: s√©lectionner les options
        const values=(data[k]||'').split(',');
        Array.from(el.options).forEach(opt=>{opt.selected=values.includes(opt.value);});
      }else el.value=data[k];
    }
  });
  
  // Initialiser les champs sp√©cifiques pour les sessions
  if(type==='session'){
    // Charger les stagiaires apr√®s avoir d√©fini l'entreprise
    setTimeout(async()=>{
      await onSessionEntrepriseChange();
      onSessionModaliteChange();
      onSessionChiffrageChange();
    },100);
  }
  
  // Initialiser les champs sp√©cifiques pour les opportunit√©s
  if(type==='opportunite'){
    setTimeout(async()=>{
      await onOpportuniteEntrepriseChange();
      onOpportuniteEtatChange();
    },100);
  }
  
  // Initialiser les champs sp√©cifiques pour les analyses
  if(type==='analyse'){
    setTimeout(async()=>{
      await onAnalyseOpportuniteChange();
    },100);
  }
}

async function saveModal(){
  try{
    const store=STORE_MAP[currentModal];
    if(!store){
      toast('Erreur: type de formulaire inconnu','error');
      return;
    }
    const id=document.getElementById('f-id').value;
    const data={};
    document.querySelectorAll('#modal-body [id^="f-"]').forEach(el=>{
      if(el.id==='f-id')return;
      const k=el.id.replace('f-','');
      if(el.type==='checkbox')data[k]=el.checked;
      else if(el.type==='number')data[k]=parseFloat(el.value)||0;
      else if(el.multiple&&el.tagName==='SELECT'){
        // Select multiple: joindre les valeurs s√©lectionn√©es
        data[k]=Array.from(el.selectedOptions).map(o=>o.value).join(',');
      }
      else if(el.tagName==='SELECT'&&el.value){
        // Convertir les IDs de select en nombres si possible
        const numVal=parseInt(el.value);
        data[k]=isNaN(numVal)?el.value:numVal;
      }
      else data[k]=el.value;
    });
    if(currentModal==='gestionnaire'&&data.passwordNew){data.password=hashPassword(data.passwordNew);delete data.passwordNew;}
    else if(currentModal==='gestionnaire'){delete data.passwordNew;if(id){const old=await dbGet(store,parseInt(id));if(old)data.password=old.password;}}
  
  // Calcul du montant global pour les sessions
  if(currentModal==='session'){
    if(data.typeChiffrage==='Forfait Journalier'){
      data.montantGlobal=(data.nbJours||0)*(data.forfaitJour||0);
    }else if(data.typeChiffrage==='Forfait Horaire'){
      data.montantGlobal=(data.tauxHoraire||0)*(data.nbHeures||0)*(data.nbStagiairesChiffrage||1);
    }
    // Supprimer les champs calcul√©s en lecture seule
    delete data.montantJournalier;
    delete data.montantHoraire;
  }
  
  // Gestion sp√©ciale pour les demandes - envoi d'emails
  let envoyerAccuse=false,notifierComm=false,clientEmail='',commEmail='',commNom='',clientNom='';
  if(currentModal==='demande'){
    envoyerAccuse=data.envoyerAccuseReception;
    notifierComm=data.notifierCommercial;
    clientEmail=data.email;
    clientNom=`${data.prenom||''} ${data.nom||''}`.trim();
    
    // R√©cup√©rer l'email du commercial assign√©
    if(data.commercialAssigne){
      const comm=await dbGet('commerciaux',parseInt(data.commercialAssigne));
      if(comm){
        commEmail=comm.email;
        commNom=`${comm.prenom||''} ${comm.nom||''}`.trim();
      }
    }
    
    // Supprimer les champs checkbox qui ne doivent pas √™tre stock√©s
    delete data.envoyerAccuseReception;
    delete data.notifierCommercial;
  }
  
  if(id){data.id=parseInt(id);await dbPut(store,data);await addHistory('Modification',NAMES[currentModal]+' modifi√©');toast(NAMES[currentModal]+' modifi√©','success');}
  else{
      const newId=await dbAdd(store,data);
      await addHistory('Cr√©ation','Nouveau '+NAMES[currentModal]);
      toast(NAMES[currentModal]+' cr√©√©','success');
      
      // Envoi des emails pour les nouvelles demandes
      if(currentModal==='demande'){
        try{
          // Accus√© de r√©ception au client
          if(envoyerAccuse && clientEmail){
            const sujetClient='Accus√© de r√©ception de votre demande de formation - DesClick';
            const corpsClient=`Bonjour ${clientNom},

Nous avons bien re√ßu votre mail, nous accusons r√©ception de votre demande de formation.

Nous allons vous r√©pondre dans les plus brefs d√©lais.

Bien √† vous.

--
Formation DesClick`;
            
            await stockerEmail(clientEmail,sujetClient,corpsClient,'Accus√© de r√©ception',newId);
          }
          
          // Notification au commercial
          if(notifierComm && commEmail && data.commercialAssigne){
            const sujetComm='Nouvelle demande assign√©e - '+(data.raisonSociale||clientNom);
            const corpsComm=`Bonjour ${commNom},

Une nouvelle demande vous a √©t√© assign√©e :

Client : ${clientNom}
Entreprise : ${data.raisonSociale||'-'}
Email : ${clientEmail}
T√©l√©phone : ${data.telephone||'-'}
Ville : ${data.ville||'-'}

Formations : ${data.formationsInteressees||'-'}
Besoins : ${data.besoinsSpecifiques||'-'}
Message : ${data.message||'-'}

Priorit√© : ${data.priorite||'Normale'}

Merci de traiter cette demande rapidement.

--
CRM Formation DesClick`;
            
            await stockerEmail(commEmail,sujetComm,corpsComm,'Notification commercial',newId);
          }
          
          if(envoyerAccuse || (notifierComm && commEmail)){
            toast('Email(s) ajout√©(s) √† la bo√Æte d\'envoi','info');
          }
        }catch(emailErr){
          console.error('Erreur lors de la cr√©ation des emails:',emailErr);
          toast('Demande cr√©√©e, mais erreur lors de la cr√©ation des emails','warning');
        }
      }
    }
    closeModal();await loadPage(currentPage);await updateDashboard();
  }catch(e){toast('Erreur: '+e.message,'error');}
}

// ============ DELETE ============
let delStore=null,delId=null;
function confirmDelete(s,id){delStore=s;delId=id;document.getElementById('confirm-msg').textContent='Supprimer ?';document.getElementById('confirm-btn').onclick=execDelete;document.getElementById('modal-confirm').classList.add('active');}
function closeConfirm(){document.getElementById('modal-confirm').classList.remove('active');}
async function execDelete(){if(delStore&&delId){await dbDelete(delStore,delId);await addHistory('Suppression','√âl√©ment supprim√©');toast('Supprim√©','success');closeConfirm();await loadPage(currentPage);await updateDashboard();}}

// ============ EXPORT ============
async function exportData(){
  const data={version:'5.0',date:new Date().toISOString()};
  for(const s of STORES)data[s]=await dbGetAll(s);
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='crm-desclick-'+new Date().toISOString().split('T')[0]+'.json';a.click();
  toast('Export√©','success');
}


// ============ INITIALISATION COMPTE ADMIN ============
async function loadDemo(){
  // Cr√©er uniquement le compte admin par d√©faut si aucun gestionnaire n'existe
  const gest=await dbGetAll('gestionnaires');
  if(gest.length>0)return;
  
  // Cr√©er le compte administrateur par d√©faut
  await dbAdd('gestionnaires',{username:'admin',password:hashPassword('admin'),nom:'Administrateur',prenom:'',email:'admin@desclick.fr',role:'Admin',statut:'Actif'});
  
  await addHistory('Initialisation','Compte administrateur cr√©√©');
}

// ============ INIT ============
document.getElementById('login-form').addEventListener('submit',async e=>{e.preventDefault();const u=document.getElementById('login-username').value;const p=document.getElementById('login-password').value;const r=document.getElementById('login-role').value;if(!r){toast('Veuillez s√©lectionner votre fonction','warning');return;}const ok=await login(u,p,r);document.getElementById('login-error').classList.toggle('show',!ok);});

async function init(){
  // V√©rifier si on est en mode questionnaire public
  const urlParams = new URLSearchParams(window.location.search);
  
  // Mode questionnaire analyse
  if(urlParams.get('questionnaire') === '1'){
    document.getElementById('questionnaire-public').style.display='block';
    document.querySelector('.login-page').style.display='none';
    document.querySelector('.app').style.display='none';
    initQuestionnairePublic(urlParams);
    return;
  }
  
  // Mode formulaire stagiaires
  if(urlParams.get('formulaire_stagiaires') === '1'){
    document.getElementById('formulaire-stagiaires-public').style.display='block';
    document.querySelector('.login-page').style.display='none';
    document.querySelector('.app').style.display='none';
    initFormulaireStagiairesPublic(urlParams);
    
    // Charger les infos de l'analyse depuis IndexedDB
    const analyseId=urlParams.get('analyseId');
    if(analyseId){
      try{
        await initDB();
        const analyse=await dbGet('analyses',parseInt(analyseId));
        if(analyse){
          chargerInfosAnalyseStagiaires(analyse);
        }else{
          document.querySelector('.fs-info-box').innerHTML='<div style="text-align:center;padding:20px;color:#f59e0b"><p>‚ö†Ô∏è Analyse non trouv√©e. Vous pouvez quand m√™me remplir le formulaire.</p></div>';
        }
      }catch(e){
        console.error('Erreur chargement analyse:',e);
      }
    }
    return;
  }
  
  try{
    await initDB();
    setupNav(); // Appeler setupNav m√™me si loadDemo √©choue
    await loadDemo();
    await checkAuth();
    console.log('‚úÖ CRM DesClick initialis√©');
  }catch(e){
    console.error('Erreur initialisation:',e);
    setupNav(); // Essayer quand m√™me d'activer la navigation
    // Afficher un message d'erreur avec option de r√©initialisation
    const errorDiv=document.createElement('div');
    errorDiv.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:10000;text-align:center;max-width:400px';
    errorDiv.innerHTML=`
      <h2 style="color:#dc2626;margin-bottom:15px">‚ö†Ô∏è Erreur d'initialisation</h2>
      <p style="margin-bottom:20px;color:#666">${e.message || 'La base de donn√©es doit √™tre r√©initialis√©e.'}</p>
      <button onclick="reinitialiserBase()" style="background:#3b82f6;color:white;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;margin-right:10px">
        üîÑ R√©initialiser la base
      </button>
      <button onclick="this.parentElement.remove()" style="background:#6b7280;color:white;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer">
        ‚úï Fermer
      </button>
    `;
    document.body.appendChild(errorDiv);
  }
}

// ============ QUESTIONNAIRE PUBLIC ============
function initQuestionnairePublic(params){
  // Pr√©-remplir les champs si pr√©sents dans l'URL
  const fieldsToFill = ['nom', 'prenom', 'email', 'telephone', 'entreprise', 'siret', 'ville', 'adresse', 'codePostal'];
  fieldsToFill.forEach(field => {
    const value = params.get(field);
    if (value) {
      const el = document.getElementById('q-'+field);
      if (el) el.value = decodeURIComponent(value);
    }
  });
}

function validerQuestionnaire(e){
  e.preventDefault();
  
  const formData = {
    horodateur: new Date().toISOString(),
    nom: document.getElementById('q-nom').value.trim(),
    prenom: document.getElementById('q-prenom').value.trim(),
    adresse: document.getElementById('q-adresse').value.trim(),
    codePostal: document.getElementById('q-codePostal').value.trim(),
    ville: document.getElementById('q-ville').value.trim(),
    email: document.getElementById('q-email').value.trim(),
    telephone: document.getElementById('q-telephone').value.trim(),
    entreprise: document.getElementById('q-entreprise').value.trim(),
    siret: document.getElementById('q-siret').value.trim(),
    nbSalaries: document.getElementById('q-nbSalaries').value.trim(),
    handicap: document.querySelector('input[name="q-handicap"]:checked').value,
    autresBesoinsId: document.querySelector('input[name="q-autresBesoinsId"]:checked').value,
    besoinDate: document.getElementById('q-besoinDate').value.trim(),
    besoinGeneral: document.getElementById('q-besoinGeneral').value.trim(),
    prerequis: document.getElementById('q-prerequis').value.trim(),
    objectifs: document.getElementById('q-objectifs').value.trim(),
    modalites: document.getElementById('q-modalites').value,
    autresBesoins: document.querySelector('input[name="q-autresBesoins"]:checked').value,
    formation: document.getElementById('q-formation').value.trim()
  };
  
  window._questionnaireData = formData;
  
  // G√©n√©rer le code encod√©
  const codeEncode = 'DESCLICK-EVAL::' + btoa(unescape(encodeURIComponent(JSON.stringify(formData))));
  document.getElementById('q-code-reponse').textContent = codeEncode;
  
  // Afficher la modal
  document.getElementById('q-modal-confirmation').classList.add('active');
}

function envoyerQuestionnaireParEmail(){
  const formData = window._questionnaireData;
  const sujet = encodeURIComponent(`Questionnaire √©valuation - ${formData.entreprise} - ${formData.nom} ${formData.prenom}`);
  
  const corps = encodeURIComponent(`Bonjour,

Veuillez trouver ci-dessous mes r√©ponses au questionnaire d'√©valuation des besoins de formation.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã INFORMATIONS CLIENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Nom : ${formData.nom}
Pr√©nom : ${formData.prenom}
Email : ${formData.email}
T√©l√©phone : ${formData.telephone}
Adresse : ${formData.adresse}
Code Postal : ${formData.codePostal}
Ville : ${formData.ville}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üè¢ ENTREPRISE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Entreprise : ${formData.entreprise}
SIRET : ${formData.siret}
Nb salari√©s : ${formData.nbSalaries}
Situation handicap : ${formData.handicap}
Autres besoins identifi√©s : ${formData.autresBesoinsId}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìö BESOINS DE FORMATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Besoin pour quelle date : ${formData.besoinDate}
Besoin g√©n√©ral : ${formData.besoinGeneral}
Pr√©requis : ${formData.prerequis}
Objectifs : ${formData.objectifs}
Modalit√©s : ${formData.modalites}
Autres besoins : ${formData.autresBesoins}
Formation souhait√©e : ${formData.formation}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîë CODE D'IMPORT (pour le CRM)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${document.getElementById('q-code-reponse').textContent}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Cordialement,
${formData.prenom} ${formData.nom}
${formData.entreprise}
`);
  
  window.location.href = `mailto:formation@des-click.com?subject=${sujet}&body=${corps}`;
}

function copierCodeQuestionnaire(){
  const code = document.getElementById('q-code-reponse').textContent;
  navigator.clipboard.writeText(code).then(() => {
    document.getElementById('q-copy-success').style.display = 'block';
    setTimeout(() => {
      document.getElementById('q-copy-success').style.display = 'none';
    }, 3000);
  }).catch(() => {
    const textarea = document.createElement('textarea');
    textarea.value = code;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    document.getElementById('q-copy-success').style.display = 'block';
    setTimeout(() => {
      document.getElementById('q-copy-success').style.display = 'none';
    }, 3000);
  });
}

function fermerModalQuestionnaire(){
  document.getElementById('q-modal-confirmation').classList.remove('active');
}

document.addEventListener('DOMContentLoaded',init);
</script>

<!-- ============ QUESTIONNAIRE PUBLIC ============ -->
<div id="questionnaire-public" style="display:none">
  <style>
    .q-container{max-width:800px;margin:0 auto;padding:20px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    .q-header{text-align:center;padding:30px;background:#fff;border-radius:16px 16px 0 0;border-bottom:4px solid #0066cc}
    .q-logo{font-size:2.5rem;font-weight:bold;color:#0066cc}
    .q-logo span{color:#ff6600}
    .q-logo-sub{color:#ff6600;font-size:1rem;margin-top:-5px}
    .q-header h1{margin-top:20px;font-size:1.5rem;color:#1e293b}
    .q-header p{color:#64748b;margin-top:10px;font-size:.9rem}
    .q-form{background:#fff;padding:30px;border-radius:0 0 16px 16px;box-shadow:0 10px 40px rgba(0,0,0,.1)}
    .q-section{margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid #e5e7eb}
    .q-section:last-child{border-bottom:none;margin-bottom:0}
    .q-section-title{font-size:1.1rem;font-weight:600;color:#0066cc;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #ff6600;display:flex;align-items:center;gap:10px}
    .q-section-title.orange{color:#ff6600}
    .q-form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px}
    .q-form-group{display:flex;flex-direction:column}
    .q-form-group.full{grid-column:1/-1}
    .q-form-group label{font-size:.85rem;font-weight:500;color:#475569;margin-bottom:6px}
    .q-form-group label .required{color:#ef4444}
    .q-form-group input,.q-form-group select,.q-form-group textarea{padding:12px 14px;border:1px solid #cbd5e1;border-radius:8px;font-size:.95rem;transition:all .2s;font-family:inherit}
    .q-form-group input:focus,.q-form-group select:focus,.q-form-group textarea:focus{outline:none;border-color:#0066cc;box-shadow:0 0 0 3px rgba(0,102,204,.1)}
    .q-form-group textarea{resize:vertical;min-height:100px}
    .q-radio-group{display:flex;gap:20px;padding:10px 0}
    .q-radio-option{display:flex;align-items:center;gap:8px;cursor:pointer}
    .q-radio-option input[type="radio"]{width:18px;height:18px;cursor:pointer}
    .q-actions{display:flex;gap:15px;justify-content:center;flex-wrap:wrap;margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb}
    .q-btn{padding:14px 28px;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
    .q-btn-primary{background:#0066cc;color:#fff}
    .q-btn-primary:hover{background:#0052a3;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,102,204,.3)}
    .q-btn-success{background:#10b981;color:#fff}
    .q-btn-success:hover{background:#059669}
    .q-btn-orange{background:#ff6600;color:#fff}
    .q-btn-orange:hover{background:#e55c00}
    .q-footer{text-align:center;padding:20px;color:#64748b;font-size:.8rem}
    .q-footer a{color:#0066cc;text-decoration:none}
    .q-modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .q-modal-overlay.active{display:flex}
    .q-modal{background:#fff;border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .q-modal-header{padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .q-modal-header h2{color:#10b981;font-size:1.3rem}
    .q-modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:#64748b}
    .q-modal-body{padding:20px}
    .q-code-box{background:#1e293b;color:#00ff00;padding:15px;border-radius:8px;font-family:'Courier New',monospace;font-size:.8rem;word-break:break-all;margin:15px 0;max-height:150px;overflow-y:auto}
    .q-copy-success{color:#10b981;font-weight:600;text-align:center;margin-top:10px;display:none}
    @media(max-width:600px){.q-form-row{grid-template-columns:1fr}.q-header{padding:20px}.q-logo{font-size:2rem}.q-form{padding:20px}.q-actions{flex-direction:column}.q-btn{width:100%;justify-content:center}}
  </style>
  
  <div class="q-container">
    <div class="q-header">
      <div class="q-logo"><span>D</span>esClick</div>
      <div class="q-logo-sub">Formation</div>
      <h1>üìã Questionnaire d'√©valuation des besoins</h1>
      <p>Merci de remplir ce formulaire pour nous permettre de mieux comprendre vos besoins de formation.</p>
    </div>
    
    <form class="q-form" id="questionnaire-form" onsubmit="validerQuestionnaire(event)">
      <!-- Informations personnelles -->
      <div class="q-section">
        <h2 class="q-section-title">üë§ Vos informations</h2>
        <div class="q-form-row">
          <div class="q-form-group">
            <label>Nom <span class="required">*</span></label>
            <input type="text" id="q-nom" required placeholder="Votre nom">
          </div>
          <div class="q-form-group">
            <label>Pr√©nom <span class="required">*</span></label>
            <input type="text" id="q-prenom" required placeholder="Votre pr√©nom">
          </div>
        </div>
        <div class="q-form-group full">
          <label>Adresse</label>
          <input type="text" id="q-adresse" placeholder="Num√©ro et nom de rue">
        </div>
        <div class="q-form-row">
          <div class="q-form-group">
            <label>Code Postal</label>
            <input type="text" id="q-codePostal" maxlength="5" placeholder="75001">
          </div>
          <div class="q-form-group">
            <label>Ville</label>
            <input type="text" id="q-ville" placeholder="Paris">
          </div>
        </div>
        <div class="q-form-row">
          <div class="q-form-group">
            <label>Email <span class="required">*</span></label>
            <input type="email" id="q-email" required placeholder="votre@email.com">
          </div>
          <div class="q-form-group">
            <label>T√©l√©phone <span class="required">*</span></label>
            <input type="tel" id="q-telephone" required placeholder="06 12 34 56 78">
          </div>
        </div>
      </div>
      
      <!-- Entreprise -->
      <div class="q-section">
        <h2 class="q-section-title">üè¢ Votre entreprise</h2>
        <div class="q-form-row">
          <div class="q-form-group">
            <label>Nom de l'entreprise <span class="required">*</span></label>
            <input type="text" id="q-entreprise" required placeholder="Nom de votre soci√©t√©">
          </div>
          <div class="q-form-group">
            <label>Num√©ro SIRET</label>
            <input type="text" id="q-siret" maxlength="14" placeholder="12345678901234">
          </div>
        </div>
        <div class="q-form-row">
          <div class="q-form-group">
            <label>Nombre de salari√©s</label>
            <input type="number" id="q-nbSalaries" min="0" placeholder="10">
          </div>
          <div class="q-form-group">
            <label>√ätes-vous en situation de handicap ?</label>
            <div class="q-radio-group">
              <label class="q-radio-option"><input type="radio" name="q-handicap" value="NON" checked> Non</label>
              <label class="q-radio-option"><input type="radio" name="q-handicap" value="OUI"> Oui</label>
            </div>
          </div>
        </div>
        <div class="q-form-group">
          <label>Voyez-vous d'autres besoins qui n'auraient pas √©t√© identifi√©s pr√©c√©demment ?</label>
          <div class="q-radio-group">
            <label class="q-radio-option"><input type="radio" name="q-autresBesoinsId" value="NON" checked> Non</label>
            <label class="q-radio-option"><input type="radio" name="q-autresBesoinsId" value="OUI"> Oui</label>
          </div>
        </div>
      </div>
      
      <!-- Besoins de formation -->
      <div class="q-section">
        <h2 class="q-section-title orange">üìö Vos besoins de formation</h2>
        <div class="q-form-group">
          <label>Pour quelle date avez-vous besoin de cette formation ? <span class="required">*</span></label>
          <input type="text" id="q-besoinDate" required placeholder="Ex: octobre 2025, janvier 2026...">
        </div>
        <div class="q-form-group">
          <label>D√©crivez votre besoin g√©n√©ral <span class="required">*</span></label>
          <textarea id="q-besoinGeneral" required placeholder="D√©crivez en quelques lignes votre besoin de formation..."></textarea>
        </div>
        <div class="q-form-group">
          <label>Pr√©requis des formations demand√©es</label>
          <textarea id="q-prerequis" placeholder="Voir le programme de formation">Voir le programme de formation</textarea>
        </div>
        <div class="q-form-group">
          <label>Quels sont vos objectifs op√©rationnels ? <span class="required">*</span></label>
          <textarea id="q-objectifs" required placeholder="Que souhaitez-vous √™tre capable de faire apr√®s cette formation ?"></textarea>
        </div>
      </div>
      
      <!-- Modalit√©s -->
      <div class="q-section">
        <h2 class="q-section-title">‚öôÔ∏è Modalit√©s souhait√©es</h2>
        <div class="q-form-row">
          <div class="q-form-group">
            <label>Modalit√©s de formation souhait√©es</label>
            <select id="q-modalites">
              <option value="Dans vos locaux">Dans vos locaux (Intra)</option>
              <option value="Dans nos locaux">Dans nos locaux (Inter)</option>
              <option value="√Ä distance">√Ä distance (Visio)</option>
              <option value="Mixte">Mixte (Pr√©sentiel + Distanciel)</option>
            </select>
          </div>
          <div class="q-form-group">
            <label>Avez-vous d'autres besoins ?</label>
            <div class="q-radio-group">
              <label class="q-radio-option"><input type="radio" name="q-autresBesoins" value="NON" checked> Non</label>
              <label class="q-radio-option"><input type="radio" name="q-autresBesoins" value="OUI"> Oui</label>
            </div>
          </div>
        </div>
        <div class="q-form-group">
          <label>Formation souhait√©e <span class="required">*</span></label>
          <input type="text" id="q-formation" required placeholder="Ex: Piloter mon application mobile, Excel avanc√©...">
        </div>
      </div>
      
      <div class="q-actions">
        <button type="submit" class="q-btn q-btn-primary">‚úÖ Valider mes r√©ponses</button>
      </div>
    </form>
    
    <div class="q-footer">
      <p><strong>DesClick Formation</strong></p>
      <p>3, rue Lech Walesa, 94270 Le Kremlin-Bic√™tre</p>
      <p>T√©l: 01 80 91 60 00 | Email: <a href="/cdn-cgi/l/email-protection#23454c514e42574a4c4d634746500e404f4a40480d404c4e"><span class="__cf_email__" data-cfemail="761019041b17021f1918361213055b151a1f151d5815191b">[email&#160;protected]</span></a></p>
      <p style="margin-top:10px"><a href="https://www.des-click.com" target="_blank">www.des-click.com</a></p>
    </div>
  </div>
  
  <!-- Modal de confirmation -->
  <div class="q-modal-overlay" id="q-modal-confirmation" onclick="if(event.target===this)fermerModalQuestionnaire()">
    <div class="q-modal">
      <div class="q-modal-header">
        <h2>‚úÖ R√©ponses valid√©es !</h2>
        <button class="q-modal-close" onclick="fermerModalQuestionnaire()">√ó</button>
      </div>
      <div class="q-modal-body">
        <p>Vos r√©ponses ont √©t√© enregistr√©es. Veuillez choisir une m√©thode pour nous les transmettre :</p>
        
        <h3 style="margin-top:20px;margin-bottom:10px;color:#374151">üìß Option 1 : Envoyer par email</h3>
        <p style="font-size:.85rem;color:#64748b;margin-bottom:10px">Cliquez sur le bouton ci-dessous pour ouvrir votre messagerie avec les donn√©es pr√©-remplies.</p>
        <button class="q-btn q-btn-primary" onclick="envoyerQuestionnaireParEmail()" style="width:100%">üìß Envoyer par email</button>
        
        <h3 style="margin-top:25px;margin-bottom:10px;color:#374151">üìã Option 2 : Copier le code</h3>
        <p style="font-size:.85rem;color:#64748b;margin-bottom:10px">Copiez ce code et envoyez-le √† votre contact DesClick Formation.</p>
        <div class="q-code-box" id="q-code-reponse"></div>
        <button class="q-btn q-btn-success" onclick="copierCodeQuestionnaire()" style="width:100%">üìã Copier le code</button>
        <p class="q-copy-success" id="q-copy-success">‚úÖ Code copi√© dans le presse-papier !</p>
        
        <div style="margin-top:30px;text-align:center">
          <button class="q-btn q-btn-orange" onclick="fermerModalQuestionnaire()">Fermer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============ FORMULAIRE PUBLIC STAGIAIRES ============ -->
<div id="formulaire-stagiaires-public" style="display:none">
  <style>
    .fs-container{max-width:900px;margin:0 auto;padding:20px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    .fs-header{text-align:center;padding:30px;background:#fff;border-radius:16px 16px 0 0;border-bottom:4px solid #0066cc}
    .fs-logo{font-size:2.5rem;font-weight:bold;color:#0066cc}
    .fs-logo span{color:#ff6600}
    .fs-logo-sub{color:#ff6600;font-size:1rem;margin-top:-5px}
    .fs-header h1{margin-top:20px;font-size:1.5rem;color:#1e293b}
    .fs-header p{color:#64748b;margin-top:10px;font-size:.9rem}
    .fs-form{background:#fff;padding:30px;border-radius:0 0 16px 16px;box-shadow:0 10px 40px rgba(0,0,0,.1)}
    .fs-info-box{background:#f0f9ff;border:1px solid #0066cc;border-radius:8px;padding:20px;margin-bottom:25px}
    .fs-info-box h3{margin:0 0 15px 0;color:#0066cc;font-size:1.1rem}
    .fs-info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
    .fs-info-item{font-size:.9rem}
    .fs-info-item strong{color:#374151}
    .fs-stagiaire-card{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:20px;margin-bottom:20px;position:relative}
    .fs-stagiaire-card h4{margin:0 0 15px 0;color:#0066cc;display:flex;align-items:center;gap:10px}
    .fs-stagiaire-card h4 .num{background:#0066cc;color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem}
    .fs-remove-btn{position:absolute;top:15px;right:15px;background:#ef4444;color:#fff;border:none;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center}
    .fs-remove-btn:hover{background:#dc2626}
    .fs-form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:15px}
    .fs-form-group{display:flex;flex-direction:column}
    .fs-form-group label{font-size:.85rem;font-weight:500;color:#475569;margin-bottom:6px}
    .fs-form-group label .required{color:#ef4444}
    .fs-form-group input,.fs-form-group select{padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px;font-size:.95rem;transition:all .2s}
    .fs-form-group input:focus,.fs-form-group select:focus{outline:none;border-color:#0066cc;box-shadow:0 0 0 3px rgba(0,102,204,.1)}
    .fs-add-btn{background:#10b981;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin:20px auto}
    .fs-add-btn:hover{background:#059669}
    .fs-actions{display:flex;gap:15px;justify-content:center;margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb}
    .fs-btn{padding:14px 28px;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
    .fs-btn-primary{background:#0066cc;color:#fff}
    .fs-btn-primary:hover{background:#0052a3;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,102,204,.3)}
    .fs-btn-orange{background:#ff6600;color:#fff}
    .fs-btn-orange:hover{background:#e55c00}
    .fs-footer{text-align:center;padding:20px;color:#64748b;font-size:.8rem}
    .fs-success-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .fs-success-modal.active{display:flex}
    .fs-success-content{background:#fff;border-radius:16px;max-width:500px;width:100%;padding:40px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .fs-success-icon{font-size:4rem;margin-bottom:20px}
    .fs-success-content h2{color:#10b981;margin-bottom:15px}
    .fs-success-content p{color:#64748b;margin-bottom:25px}
    .fs-code-box{background:#1e293b;color:#00ff00;padding:15px;border-radius:8px;font-family:'Courier New',monospace;font-size:.8rem;word-break:break-all;margin:15px 0;max-height:150px;overflow-y:auto;text-align:left}
    @media(max-width:600px){.fs-form-row{grid-template-columns:1fr}.fs-header{padding:20px}.fs-logo{font-size:2rem}.fs-form{padding:20px}.fs-actions{flex-direction:column}.fs-btn{width:100%;justify-content:center}}
  </style>
  
  <div class="fs-container">
    <div class="fs-header">
      <div class="fs-logo"><span>D</span>esClick</div>
      <div class="fs-logo-sub">Formation</div>
      <h1>üë• Formulaire d'inscription des stagiaires</h1>
      <p>Merci de renseigner les informations de chaque stagiaire qui participera √† la formation.</p>
    </div>
    
    <div class="fs-form">
      <!-- Informations de la formation -->
      <div class="fs-info-box">
        <h3>üìã Informations de la formation</h3>
        <div class="fs-info-grid">
          <div class="fs-info-item"><strong>Entreprise :</strong> <span id="fs-entreprise">-</span></div>
          <div class="fs-info-item"><strong>Formation :</strong> <span id="fs-formation">-</span></div>
          <div class="fs-info-item"><strong>Modalit√© :</strong> <span id="fs-modalite">-</span></div>
          <div class="fs-info-item"><strong>Nb stagiaires pr√©vu :</strong> <span id="fs-nb-prevu">-</span></div>
        </div>
      </div>
      
      <!-- Container pour les stagiaires -->
      <div id="fs-stagiaires-container">
        <!-- Les cartes stagiaires seront ajout√©es ici -->
      </div>
      
      <button type="button" class="fs-add-btn" onclick="ajouterStagiaireFormulaire()">
        ‚ûï Ajouter un stagiaire
      </button>
      
      <div class="fs-actions">
        <button type="button" class="fs-btn fs-btn-primary" onclick="validerFormulaireStagiaires()">
          ‚úÖ Valider et envoyer
        </button>
      </div>
    </div>
    
    <div class="fs-footer">
      <p>¬© DesClick Formation - Ce formulaire est s√©curis√©</p>
    </div>
  </div>
  
  <!-- Modal de succ√®s -->
  <div class="fs-success-modal" id="fs-modal-success">
    <div class="fs-success-content">
      <div class="fs-success-icon">‚úÖ</div>
      <h2>Informations enregistr√©es !</h2>
      <p>Les informations des stagiaires ont bien √©t√© enregistr√©es. Vous pouvez copier le code ci-dessous et l'envoyer √† votre contact DesClick Formation.</p>
      
      <div class="fs-code-box" id="fs-code-reponse"></div>
      <button class="fs-btn fs-btn-orange" onclick="copierCodeStagiaires()" style="width:100%;margin-bottom:15px">üìã Copier le code</button>
      <p id="fs-copy-success" style="color:#10b981;display:none">‚úÖ Code copi√© !</p>
      
      <button class="fs-btn fs-btn-primary" onclick="fermerSuccessStagiaires()" style="margin-top:20px">Fermer</button>
    </div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ============ FORMULAIRE PUBLIC STAGIAIRES - SCRIPTS ============
let formulaireStagiairesAnalyseId=null;
let formulaireStagiairesAnalyse=null;
let formulaireStagiairesCount=0;

function initFormulaireStagiairesPublic(urlParams){
  const analyseId=urlParams.get('analyseId');
  if(!analyseId){
    document.querySelector('.fs-form').innerHTML='<div style="text-align:center;padding:40px;color:#ef4444"><h2>‚ö†Ô∏è Erreur</h2><p>Aucune analyse sp√©cifi√©e. Veuillez utiliser le lien fourni par votre contact.</p></div>';
    return;
  }
  
  formulaireStagiairesAnalyseId=analyseId;
  
  // Afficher un message de chargement
  document.querySelector('.fs-info-box').innerHTML='<p style="text-align:center;color:#64748b">Chargement des informations...</p>';
  
  // Ajouter un premier stagiaire
  ajouterStagiaireFormulaire();
}

function chargerInfosAnalyseStagiaires(analyse){
  formulaireStagiairesAnalyse=analyse;
  
  document.getElementById('fs-entreprise').textContent=analyse.entreprise||'-';
  document.getElementById('fs-formation').textContent=analyse.formation||'-';
  document.getElementById('fs-modalite').textContent=analyse.modalite||'-';
  document.getElementById('fs-nb-prevu').textContent=analyse.nbStagiaires||analyse.effectif||'-';
  
  // Restaurer le contenu de la box info
  document.querySelector('.fs-info-box').innerHTML=`
    <h3>üìã Informations de la formation</h3>
    <div class="fs-info-grid">
      <div class="fs-info-item"><strong>Entreprise :</strong> <span id="fs-entreprise">${analyse.entreprise||'-'}</span></div>
      <div class="fs-info-item"><strong>Formation :</strong> <span id="fs-formation">${analyse.formation||'-'}</span></div>
      <div class="fs-info-item"><strong>Modalit√© :</strong> <span id="fs-modalite">${analyse.modalite||'-'}</span></div>
      <div class="fs-info-item"><strong>Nb stagiaires pr√©vu :</strong> <span id="fs-nb-prevu">${analyse.nbStagiaires||analyse.effectif||'-'}</span></div>
    </div>`;
}

function ajouterStagiaireFormulaire(){
  formulaireStagiairesCount++;
  const container=document.getElementById('fs-stagiaires-container');
  
  const card=document.createElement('div');
  card.className='fs-stagiaire-card';
  card.id=`fs-stagiaire-${formulaireStagiairesCount}`;
  card.innerHTML=`
    <h4><span class="num">${formulaireStagiairesCount}</span> Stagiaire ${formulaireStagiairesCount}</h4>
    ${formulaireStagiairesCount>1?'<button type="button" class="fs-remove-btn" onclick="supprimerStagiaireFormulaire('+formulaireStagiairesCount+')">&times;</button>':''}
    <div class="fs-form-row">
      <div class="fs-form-group">
        <label>Civilit√© <span class="required">*</span></label>
        <select id="fs-civilite-${formulaireStagiairesCount}" required>
          <option value="">Choisir...</option>
          <option value="Mr.">Mr.</option>
          <option value="Mme">Mme</option>
        </select>
      </div>
      <div class="fs-form-group">
        <label>Nom <span class="required">*</span></label>
        <input type="text" id="fs-nom-${formulaireStagiairesCount}" required placeholder="NOM">
      </div>
      <div class="fs-form-group">
        <label>Pr√©nom <span class="required">*</span></label>
        <input type="text" id="fs-prenom-${formulaireStagiairesCount}" required placeholder="Pr√©nom">
      </div>
    </div>
    <div class="fs-form-row">
      <div class="fs-form-group">
        <label>Fonction <span class="required">*</span></label>
        <input type="text" id="fs-fonction-${formulaireStagiairesCount}" required placeholder="Ex: Commercial, Manager...">
      </div>
      <div class="fs-form-group">
        <label>Email <span class="required">*</span></label>
        <input type="email" id="fs-email-${formulaireStagiairesCount}" required placeholder="email@entreprise.fr">
      </div>
      <div class="fs-form-group">
        <label>T√©l√©phone</label>
        <input type="tel" id="fs-telephone-${formulaireStagiairesCount}" placeholder="06 12 34 56 78">
      </div>
    </div>
  `;
  
  container.appendChild(card);
  renumerorterStagiairesFormulaire();
}

function supprimerStagiaireFormulaire(num){
  const card=document.getElementById(`fs-stagiaire-${num}`);
  if(card) card.remove();
  renumerorterStagiairesFormulaire();
}

function renumerorterStagiairesFormulaire(){
  const cards=document.querySelectorAll('.fs-stagiaire-card');
  cards.forEach((card,index)=>{
    const num=index+1;
    const h4=card.querySelector('h4');
    if(h4){
      h4.innerHTML=`<span class="num">${num}</span> Stagiaire ${num}`;
    }
  });
}

function validerFormulaireStagiaires(){
  const cards=document.querySelectorAll('.fs-stagiaire-card');
  const stagiaires=[];
  let valid=true;
  
  cards.forEach((card,index)=>{
    const id=card.id.replace('fs-stagiaire-','');
    const civilite=document.getElementById(`fs-civilite-${id}`)?.value||'';
    const nom=document.getElementById(`fs-nom-${id}`)?.value?.trim()||'';
    const prenom=document.getElementById(`fs-prenom-${id}`)?.value?.trim()||'';
    const fonction=document.getElementById(`fs-fonction-${id}`)?.value?.trim()||'';
    const email=document.getElementById(`fs-email-${id}`)?.value?.trim()||'';
    const telephone=document.getElementById(`fs-telephone-${id}`)?.value?.trim()||'';
    
    if(!civilite||!nom||!prenom||!fonction||!email){
      valid=false;
      card.style.borderColor='#ef4444';
    }else{
      card.style.borderColor='#e5e7eb';
      stagiaires.push({civilite,nom,prenom,fonction,email,telephone});
    }
  });
  
  if(!valid){
    alert('Veuillez remplir tous les champs obligatoires (marqu√©s d\'un *)');
    return;
  }
  
  if(stagiaires.length===0){
    alert('Veuillez ajouter au moins un stagiaire');
    return;
  }
  
  // G√©n√©rer le code de r√©ponse
  const codeReponse={
    type:'STAGIAIRES_FORMATION',
    analyseId:formulaireStagiairesAnalyseId,
    entreprise:formulaireStagiairesAnalyse?.entreprise||'',
    formation:formulaireStagiairesAnalyse?.formation||'',
    dateSubmission:new Date().toISOString(),
    stagiaires:stagiaires
  };
  
  const codeBase64=btoa(unescape(encodeURIComponent(JSON.stringify(codeReponse))));
  document.getElementById('fs-code-reponse').textContent=codeBase64;
  document.getElementById('fs-modal-success').classList.add('active');
}

function copierCodeStagiaires(){
  const code=document.getElementById('fs-code-reponse').textContent;
  navigator.clipboard.writeText(code).then(()=>{
    document.getElementById('fs-copy-success').style.display='block';
    setTimeout(()=>{
      document.getElementById('fs-copy-success').style.display='none';
    },3000);
  }).catch(()=>{
    const textarea=document.createElement('textarea');
    textarea.value=code;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    document.getElementById('fs-copy-success').style.display='block';
    setTimeout(()=>{
      document.getElementById('fs-copy-success').style.display='none';
    },3000);
  });
}

function fermerSuccessStagiaires(){
  document.getElementById('fs-modal-success').classList.remove('active');
}

// ============ GED ============
let currentGEDEntreprise=null;

async function showGED(){
  const entreprises=await dbGetAll('entreprises');
  const listeEl=document.getElementById('ged-liste-entreprises');
  if(listeEl){
    listeEl.innerHTML=entreprises.length===0?'<div style="padding:20px;text-align:center;color:#94a3b8">Aucune entreprise</div>':
      entreprises.map(e=>`
        <div class="ged-ent-item" onclick="selectGEDEntreprise(${e.id})" style="padding:10px;border-bottom:1px solid #e5e7eb;cursor:pointer;transition:background 0.2s" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
          <div style="font-weight:600;color:#1e293b">${esc(e.nom)}</div>
          <div style="font-size:0.8em;color:#64748b">${esc(e.ville||'')}</div>
        </div>
      `).join('');
  }
}

function selectGEDEntreprise(id){
  currentGEDEntreprise=id;
  dbGetAll('entreprises').then(entreprises=>{
    const ent=entreprises.find(e=>e.id===id);
    if(ent){
      document.getElementById('ged-entreprise-titre').textContent=ent.nom;
      loadGEDDocuments(id);
    }
  });
}

async function loadGEDDocuments(entrepriseId){
  const docs=await dbGetAll('ged_documents');
  const entDocs=docs.filter(d=>d.entrepriseId===entrepriseId);
  
  // Compter par dossier
  const countPre=entDocs.filter(d=>d.dossier==='preformation').length;
  const countForm=entDocs.filter(d=>d.dossier==='formation').length;
  const countPost=entDocs.filter(d=>d.dossier==='postformation').length;
  
  document.getElementById('ged-count-preformation').textContent=countPre;
  document.getElementById('ged-count-formation').textContent=countForm;
  document.getElementById('ged-count-postformation').textContent=countPost;
  document.getElementById('ged-entreprise-count').textContent=`${entDocs.length} document(s)`;
}

function toggleGEDFolder(folder){
  const content=document.getElementById('ged-content-'+folder);
  const icon=content.previousElementSibling.querySelector('.ged-folder-icon');
  if(content.style.display==='none'){
    content.style.display='block';
    icon.textContent='üìÇ';
  }else{
    content.style.display='none';
    icon.textContent='üìÅ';
  }
}

function uploadDocumentGED(){
  if(!currentGEDEntreprise){
    toast('Veuillez d\'abord s√©lectionner une entreprise','warning');
    return;
  }
  // Ouvrir un modal d'upload
  const html=`
    <div class="form-group">
      <label class="form-label">Dossier</label>
      <select class="form-select" id="ged-upload-dossier">
        <option value="preformation">üìÅ Pr√©formation</option>
        <option value="formation">üìÅ Formation</option>
        <option value="postformation">üìÅ Post-formation</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Type de document</label>
      <select class="form-select" id="ged-upload-type">
        <option value="analyse-besoins">Fiche d'analyse des besoins</option>
        <option value="devis">Devis</option>
        <option value="convention">Convention</option>
        <option value="convocation">Convocation</option>
        <option value="attestation">Attestation</option>
        <option value="emargement">Feuille d'√©margement</option>
        <option value="satisfaction">Questionnaire satisfaction</option>
        <option value="autre">Autre</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Fichier</label>
      <input type="file" id="ged-upload-file" class="form-input">
    </div>
  `;
  document.getElementById('modal-title').textContent='üì§ Uploader un document';
  document.getElementById('modal-body').innerHTML=html;
  document.getElementById('modal').classList.add('active');
  currentModal='ged-upload';
}

function filterGEDEntreprises(){
  const search=(document.getElementById('search-ged-ent')?.value||'').toLowerCase();
  document.querySelectorAll('.ged-ent-item').forEach(item=>{
    const text=item.textContent.toLowerCase();
    item.style.display=text.includes(search)?'block':'none';
  });
}

function filterGEDFormations(){
  // Filtrage des documents formation
}

function uploadDocGED(type){
  toast('Upload '+type+' en d√©veloppement','info');
}

function uploadDocumentFormation(){
  toast('Upload document formation en d√©veloppement','info');
}

// ============ CONCEPTION ============
let conceptionData=[];

// ============ CONCEPTION P√âDAGOGIQUE - V√âRIFICATION DATES & G√âN√âRATION DOCS ============
let conceptionPecSelectionnee=null;
let documentsGeneres={}; // Stockage des documents g√©n√©r√©s {code: {blob, filename, formation}}

// Types de documents avec leurs mod√®les
const DOCS_CONCEPTION={
  formateur:[
    {code:'ordre_mission',label:'üìÑ Ordre de mission',modele:'MODELE_ORDRE_MISSION.docx'},
    {code:'convocation_formateur',label:'üìß Convocation formateur',modele:'MODELE_CONVOCATION_FORMATEUR.docx'},
    {code:'contrat_formateur',label:'üìë Contrat formateur (externe)',modele:'MODELE_CONTRAT_FORMATEUR.docx',externe:true},
    {code:'questionnaire_satisfaction_formateur',label:'‚≠ê Questionnaire satisfaction',modele:'MODELE_SATISFACTION_FORMATEUR.docx'}
  ],
  stagiaires:[
    {code:'convocation_stagiaire',label:'üìß Convocations stagiaires',modele:'MODELE_CONVOCATION_STAGIAIRE.docx'},
    {code:'questionnaire_positionnement',label:'üìã Questionnaire de positionnement',modele:'MODELE_POSITIONNEMENT.docx'},
    {code:'questionnaire_satisfaction_stagiaire',label:'‚≠ê Questionnaire satisfaction',modele:'MODELE_SATISFACTION_STAGIAIRE.docx'},
    {code:'quiz',label:'‚ùì Quiz',modele:'MODELE_QUIZ.docx'},
    {code:'test_final',label:'üìù Test final',modele:'MODELE_TEST_FINAL.docx'}
  ],
  session:[
    {code:'feuille_emargement',label:'‚úçÔ∏è Feuille d\'√©margement',modele:'MODELE_EMARGEMENT.docx'},
    {code:'programme_formation',label:'üìö Programme de formation',modele:'MODELE_PROGRAMME.docx'},
    {code:'attestation_presence',label:'üìú Attestation de pr√©sence',modele:'MODELE_ATTESTATION.docx'}
  ]
};

async function showConception(){
  const [dpcList,sessions,entreprises,formations,formateurs,stagiaires]=await Promise.all([
    dbGetAll('dpc'),
    dbGetAll('sessions'),
    dbGetAll('entreprises'),
    dbGetAll('formations'),
    dbGetAll('formateurs'),
    dbGetAll('stagiaires')
  ]);
  
  // Filtrer les PEC accord√©es
  const pecAccordees=dpcList.filter(d=>d.statut==='Accord√©');
  
  const tbody=document.getElementById('table-conception-pec');
  if(!tbody)return;
  
  if(pecAccordees.length===0){
    tbody.innerHTML='<tr><td colspan="9" class="empty-state"><div class="empty-state-icon">üì≠</div><h3>Aucune prise en charge accord√©e</h3><p>Les PEC accord√©es appara√Ætront ici automatiquement</p></td></tr>';
    return;
  }
  
  tbody.innerHTML=pecAccordees.map(pec=>{
    const ent=entreprises.find(e=>e.id==pec.entrepriseId);
    const session=sessions.find(s=>s.id==pec.sessionId);
    const formation=session?formations.find(f=>f.id==session.formation):null;
    
    // Dates
    const dateDebut=session?.dateDebutPrev||session?.dateDebutEffective;
    const dateFin=session?.dateFinPrev||session?.dateFinEffective||dateDebut;
    const dateLimiteOPCO=pec.dateLimiteOPCO;
    
    // V√©rification des dates
    let verifStatus='‚ùì Non v√©rifi√©';
    let verifClass='status-en-attente';
    let datesOK=false;
    
    if(dateDebut&&dateLimiteOPCO){
      const finDate=new Date(dateFin);
      const limiteDate=new Date(dateLimiteOPCO);
      if(finDate<=limiteDate){
        verifStatus='‚úÖ Dates OK';
        verifClass='status-valide';
        datesOK=true;
      }else{
        verifStatus='‚ö†Ô∏è D√©passement';
        verifClass='status-refuse';
      }
    }else if(!session){
      verifStatus='‚ö†Ô∏è Pas de session';
      verifClass='status-refuse';
    }else if(!dateLimiteOPCO){
      verifStatus='‚ö†Ô∏è Date limite manquante';
      verifClass='status-en-attente';
    }
    
    // Statut conception
    const conceptionStatut=pec.conceptionStatut||'En attente v√©rification';
    
    return `<tr>
      <td><code>${pec.numero||'PEC-'+String(pec.id).padStart(3,'0')}</code></td>
      <td><strong>${ent?esc(ent.nom):esc(pec.entreprise)||'-'}</strong></td>
      <td>${formation?esc(formation.nom):'-'}</td>
      <td>${session?'SES-'+String(session.id).padStart(3,'0'):'-'}</td>
      <td>${dateDebut?fmtDate(dateDebut)+' - '+fmtDate(dateFin):'-'}</td>
      <td><strong style="color:${datesOK?'#10b981':'#ef4444'}">${dateLimiteOPCO?fmtDate(dateLimiteOPCO):'Non d√©finie'}</strong></td>
      <td><span class="status ${verifClass}">${verifStatus}</span></td>
      <td><span class="status status-${slug(conceptionStatut)}">${conceptionStatut}</span></td>
      <td class="action-btns">
        <button class="btn btn-info btn-icon" onclick="ouvrirConception(${pec.id})" title="Pr√©parer">üìã</button>
      </td>
    </tr>`;
  }).join('');
}

async function ouvrirConception(pecId){
  const [dpcList,sessions,entreprises,formations,formateurs,stagiaires,conventions]=await Promise.all([
    dbGetAll('dpc'),
    dbGetAll('sessions'),
    dbGetAll('entreprises'),
    dbGetAll('formations'),
    dbGetAll('formateurs'),
    dbGetAll('stagiaires'),
    dbGetAll('conventions')
  ]);
  
  const pec=dpcList.find(d=>d.id==pecId);
  if(!pec){toast('PEC non trouv√©e','error');return;}
  
  conceptionPecSelectionnee=pec;
  
  // R√©initialiser les documents g√©n√©r√©s pour cette nouvelle PEC
  documentsGeneres={};
  const recapDiv=document.getElementById('recap-docs-generes');
  if(recapDiv)recapDiv.style.display='none';
  
  const ent=entreprises.find(e=>e.id==pec.entrepriseId);
  const session=sessions.find(s=>s.id==pec.sessionId);
  const formation=session?formations.find(f=>f.id==session.formation):null;
  const formateur=session?formateurs.find(f=>f.id==session.formateur):null;
  const stagiairesList=session&&session.stagiaires?session.stagiaires.split(',').map(id=>stagiaires.find(s=>s.id==parseInt(id))).filter(s=>s):[];
  
  // Afficher le workspace
  document.getElementById('conception-workspace').style.display='block';
  document.getElementById('conception-workspace').scrollIntoView({behavior:'smooth'});
  
  // Titre
  document.getElementById('conception-titre').textContent='üìã Pr√©paration - '+(pec.numero||'PEC-'+pec.id)+' - '+(ent?.nom||'');
  
  // R√©sum√©
  document.getElementById('conception-resume').innerHTML=`
    <div><strong>Entreprise :</strong><br>${ent?esc(ent.nom):'-'}</div>
    <div><strong>Formation :</strong><br>${formation?esc(formation.nom):'-'}</div>
    <div><strong>Formateur :</strong><br>${formateur?esc(formateur.nom)+' '+esc(formateur.prenom||''):'-'} <span style="color:${formateur?.type==='Externe'?'#10b981':'#3b82f6'};font-size:0.8em">(${formateur?.type||'Interne'})</span></div>
    <div><strong>Stagiaires :</strong><br>${stagiairesList.length} inscrit(s)</div>
    <div><strong>OPCO :</strong><br>${esc(pec.opco||'-')}</div>
    <div><strong>Montant accord√© :</strong><br>${fmtMoney(pec.montantAccorde||0)}</div>
    <div><strong>Session :</strong><br>${session?'SES-'+session.id:'-'}</div>
    <div><strong>Lieu :</strong><br>${session?.modalite==='Intra'?esc(session.lieuIntra||'-'):(session?.lieu?'Voir lieu':'-')}</div>
  `;
  
  // V√©rification des dates
  const dateDebut=session?.dateDebutPrev||session?.dateDebutEffective;
  const dateFin=session?.dateFinPrev||session?.dateFinEffective||dateDebut;
  const dateLimiteOPCO=pec.dateLimiteOPCO;
  
  let datesOK=false;
  let verifHTML='';
  
  if(!session){
    verifHTML=`<div class="warning-box">‚ö†Ô∏è <strong>Aucune session li√©e √† cette PEC.</strong> Veuillez lier une session dans l'onglet "Prise en charge".</div>`;
  }else if(!dateLimiteOPCO){
    verifHTML=`<div class="warning-box">‚ö†Ô∏è <strong>Date limite OPCO non d√©finie.</strong> Veuillez la renseigner dans l'onglet "Prise en charge".</div>`;
  }else{
    const finDate=new Date(dateFin);
    const limiteDate=new Date(dateLimiteOPCO);
    const joursRestants=Math.ceil((limiteDate-finDate)/(1000*60*60*24));
    
    if(finDate<=limiteDate){
      datesOK=true;
      verifHTML=`
        <div class="success-box" style="background:#ecfdf5;border:1px solid #10b981;padding:15px;border-radius:8px">
          <h4 style="color:#059669;margin:0 0 10px 0">‚úÖ Les dates sont conformes √† l'accord OPCO</h4>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:10px">
            <div style="background:white;padding:10px;border-radius:6px;text-align:center">
              <div style="font-size:0.8em;color:#6b7280">D√©but pr√©vu</div>
              <div style="font-weight:600;color:#1e293b">${fmtDate(dateDebut)}</div>
            </div>
            <div style="background:white;padding:10px;border-radius:6px;text-align:center">
              <div style="font-size:0.8em;color:#6b7280">Fin pr√©vue</div>
              <div style="font-weight:600;color:#1e293b">${fmtDate(dateFin)}</div>
            </div>
            <div style="background:white;padding:10px;border-radius:6px;text-align:center">
              <div style="font-size:0.8em;color:#6b7280">Date limite OPCO</div>
              <div style="font-weight:600;color:#10b981">${fmtDate(dateLimiteOPCO)}</div>
            </div>
          </div>
          <div style="margin-top:10px;text-align:center;color:#059669">
            <strong>‚Üí ${joursRestants} jour(s) de marge avant la date limite</strong>
          </div>
        </div>
        <div style="margin-top:15px;text-align:center">
          <button class="btn btn-success" onclick="passerEtape2Conception()">
            ‚úÖ Passer √† la g√©n√©ration des documents
          </button>
        </div>
      `;
    }else{
      verifHTML=`
        <div class="warning-box" style="background:#fef2f2;border:2px solid #ef4444;padding:15px;border-radius:8px">
          <h4 style="color:#dc2626;margin:0 0 10px 0">‚ö†Ô∏è Les dates d√©passent l'accord OPCO !</h4>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:10px">
            <div style="background:white;padding:10px;border-radius:6px;text-align:center">
              <div style="font-size:0.8em;color:#6b7280">Fin pr√©vue</div>
              <div style="font-weight:600;color:#ef4444">${fmtDate(dateFin)}</div>
            </div>
            <div style="background:white;padding:10px;border-radius:6px;text-align:center">
              <div style="font-size:0.8em;color:#6b7280">Date limite OPCO</div>
              <div style="font-weight:600;color:#dc2626">${fmtDate(dateLimiteOPCO)}</div>
            </div>
            <div style="background:white;padding:10px;border-radius:6px;text-align:center">
              <div style="font-size:0.8em;color:#6b7280">D√©passement</div>
              <div style="font-weight:600;color:#ef4444">${Math.abs(joursRestants)} jour(s)</div>
            </div>
          </div>
        </div>
        <div style="margin-top:15px;text-align:center">
          <button class="btn btn-warning" onclick="afficherOption1Conception()">
            ‚ö†Ô∏è Voir les actions √† effectuer (Option 1)
          </button>
        </div>
      `;
    }
  }
  
  document.getElementById('conception-verif-dates').innerHTML=verifHTML;
  
  // Cacher les sections suivantes par d√©faut
  document.getElementById('conception-etape2').style.display='none';
  document.getElementById('conception-option1').style.display='none';
  
  // Stocker les donn√©es pour la g√©n√©ration
  conceptionPecSelectionnee.session=session;
  conceptionPecSelectionnee.formation=formation;
  conceptionPecSelectionnee.formateur=formateur;
  conceptionPecSelectionnee.entreprise=ent;
  conceptionPecSelectionnee.stagiaires=stagiairesList;
}

function afficherOption1Conception(){
  document.getElementById('conception-option1').style.display='block';
  document.getElementById('conception-etape2').style.display='none';
  document.getElementById('conception-option1').scrollIntoView({behavior:'smooth'});
}

function passerEtape2Conception(){
  document.getElementById('conception-etape2').style.display='block';
  document.getElementById('conception-option1').style.display='none';
  
  const formateur=conceptionPecSelectionnee?.formateur;
  const stagiaires=conceptionPecSelectionnee?.stagiaires||[];
  const formation=conceptionPecSelectionnee?.formation;
  const formationNom=formation?.nom||'Formation';
  const formationCode=formation?.code||'';
  
  // R√©initialiser les documents g√©n√©r√©s pour cette nouvelle conception
  documentsGeneres={};
  
  // Type formateur
  document.getElementById('conception-formateur-type').textContent=formateur?.type||'Interne';
  document.getElementById('conception-nb-stagiaires').textContent='('+stagiaires.length+' stagiaire'+(stagiaires.length>1?'s':'')+')';
  
  // Documents formateur - avec boutons de g√©n√©ration personnalis√©e
  document.getElementById('conception-docs-formateur').innerHTML=`
    <div style="margin-bottom:10px;padding:8px;background:#dbeafe;border-radius:6px;font-size:0.85em">
      <strong>üë®‚Äçüè´ Formateur :</strong> ${esc(formateur?.prenom||'')} ${esc(formateur?.nom||'')} (${formateur?.type||'Interne'})
    </div>
  `+DOCS_CONCEPTION.formateur
    .filter(d=>!d.externe||formateur?.type==='Externe')
    .map(d=>`
      <div class="doc-item" id="doc-item-${d.code}" style="padding:12px;background:white;border-radius:8px;margin-bottom:10px;border:1px solid #e5e7eb">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
          <div>
            <span style="font-weight:500">${d.label}</span>
            <div style="font-size:0.75em;color:#6b7280;margin-top:2px">
              <span id="modele-status-${d.code}" style="margin-left:0"></span>
            </div>
          </div>
          <div style="display:flex;gap:5px;flex-wrap:wrap" id="btns-${d.code}">
            <button class="btn btn-sm btn-secondary" onclick="genererDocConception('${d.code}','formateur')" title="G√©n√©rer avec template par d√©faut">üìù D√©faut</button>
            <button class="btn btn-sm btn-primary" onclick="genererDocFormateur('${d.code}')" title="G√©n√©rer depuis le mod√®le personnalis√©">üìÑ Personnalis√©</button>
          </div>
        </div>
      </div>
    `).join('');
  
  // Documents stagiaires - avec nom de formation
  document.getElementById('conception-docs-stagiaires').innerHTML=`
    <div style="margin-bottom:10px;padding:8px;background:#d1fae5;border-radius:6px;font-size:0.85em">
      <strong>üìö Formation :</strong> ${esc(formationNom)} ${formationCode?'('+formationCode+')':''}
    </div>
  `+DOCS_CONCEPTION.stagiaires.map(d=>`
    <div class="doc-item" id="doc-item-${d.code}" style="padding:12px;background:white;border-radius:8px;margin-bottom:10px;border:1px solid #e5e7eb">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <div>
          <span style="font-weight:500">${d.label}</span>
          <div style="font-size:0.75em;color:#6b7280;margin-top:2px">
            ${stagiaires.length} stagiaire(s) 
            <span id="modele-status-${d.code}" style="margin-left:8px"></span>
          </div>
        </div>
        <div style="display:flex;gap:5px;flex-wrap:wrap" id="btns-${d.code}">
          <button class="btn btn-sm btn-secondary" onclick="genererDocConception('${d.code}','stagiaires')" title="G√©n√©rer avec template par d√©faut">üìù D√©faut</button>
          <button class="btn btn-sm btn-primary" onclick="genererDocsParStagiaire('${d.code}')" title="G√©n√©rer un document personnalis√© par stagiaire depuis le mod√®le">üë• Par stagiaire</button>
        </div>
      </div>
    </div>
  `).join('');
  
  // V√©rifier les mod√®les upload√©s pour chaque type de document
  verifierModelesUploades();
  
  // Documents session - avec nom de formation
  document.getElementById('conception-docs-session').innerHTML=`
    <div style="margin-bottom:10px;padding:8px;background:#fef3c7;border-radius:6px;font-size:0.85em">
      <strong>üìö Formation :</strong> ${esc(formationNom)} ${formationCode?'('+formationCode+')':''}
    </div>
  `+DOCS_CONCEPTION.session.map(d=>`
    <div class="doc-item" id="doc-item-${d.code}" style="padding:12px;background:white;border-radius:8px;margin-bottom:10px;border:1px solid #e5e7eb">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <div>
          <span style="font-weight:500">${d.label}</span>
          <div style="font-size:0.75em;color:#6b7280;margin-top:2px">Session SES-${conceptionPecSelectionnee?.session?.id||''}</div>
        </div>
        <div style="display:flex;gap:5px;flex-wrap:wrap" id="btns-${d.code}">
          <button class="btn btn-sm btn-info" onclick="genererDocConception('${d.code}','session')">üìù G√©n√©rer</button>
        </div>
      </div>
    </div>
  `).join('');
  
  document.getElementById('conception-etape2').scrollIntoView({behavior:'smooth'});
}

// G√©n√©rateur de templates HTML pour les documents
function genererTemplateDocument(codeDoc,data){
  const {entreprise,formation,formateur,session,stagiaires,pec,dateJour,dateDebut,dateFin,lieu}=data;
  
  // Style CSS commun pour tous les documents
  const styleCSS=`
    <style>
      @page{size:A4;margin:2cm}
      body{font-family:'Segoe UI',Arial,sans-serif;font-size:11pt;line-height:1.6;color:#333;max-width:800px;margin:0 auto;padding:40px}
      .header{text-align:center;margin-bottom:30px;border-bottom:3px solid #3b82f6;padding-bottom:20px}
      .logo{font-size:24px;font-weight:bold;color:#1e40af}
      .doc-title{font-size:20px;margin-top:15px;color:#1e293b}
      .section{margin:25px 0;padding:15px;background:#f8fafc;border-radius:8px;border-left:4px solid #3b82f6}
      .section-title{font-size:14px;font-weight:bold;color:#1e40af;margin-bottom:10px;text-transform:uppercase}
      .info-grid{display:grid;grid-template-columns:180px 1fr;gap:8px}
      .info-label{font-weight:600;color:#64748b}
      .info-value{color:#1e293b}
      table{width:100%;border-collapse:collapse;margin:15px 0}
      th,td{border:1px solid #e2e8f0;padding:10px;text-align:left}
      th{background:#f1f5f9;font-weight:600;color:#475569}
      .signature-zone{margin-top:40px;display:grid;grid-template-columns:1fr 1fr;gap:40px}
      .signature-box{border:1px solid #e2e8f0;padding:15px;min-height:80px;text-align:center}
      .signature-label{font-weight:600;margin-bottom:10px;color:#475569}
      .footer{margin-top:40px;text-align:center;font-size:9pt;color:#94a3b8;border-top:1px solid #e2e8f0;padding-top:15px}
      @media print{body{padding:0}.section{break-inside:avoid}}
    </style>
  `;
  
  // En-t√™te commun
  const header=`
    <div class="header">
      <div class="logo">üéØ Formation DesClick</div>
      <div style="font-size:12px;color:#64748b">Organisme de formation certifi√© Qualiopi</div>
    </div>
  `;
  
  // Pied de page commun
  const footer=`
    <div class="footer">
      Formation DesClick - Organisme de formation certifi√© Qualiopi<br>
      Document g√©n√©r√© le ${dateJour}
    </div>
  `;
  
  // Templates selon le type de document
  const templates={
    // ===== DOCUMENTS FORMATEUR =====
    ordre_mission:`
      ${header}
      <h1 class="doc-title">üìÑ ORDRE DE MISSION</h1>
      <div class="section">
        <div class="section-title">Formateur</div>
        <div class="info-grid">
          <span class="info-label">Nom :</span><span class="info-value">${formateur.nom||''} ${formateur.prenom||''}</span>
          <span class="info-label">Statut :</span><span class="info-value">${formateur.type||'Interne'}</span>
          <span class="info-label">Email :</span><span class="info-value">${formateur.email||''}</span>
        </div>
      </div>
      <div class="section">
        <div class="section-title">Mission</div>
        <div class="info-grid">
          <span class="info-label">Formation :</span><span class="info-value"><strong>${formation.nom||''}</strong></span>
          <span class="info-label">Code formation :</span><span class="info-value">${formation.code||''}</span>
          <span class="info-label">Dur√©e :</span><span class="info-value">${formation.duree||''} heures</span>
          <span class="info-label">Dates :</span><span class="info-value">Du ${dateDebut} au ${dateFin}</span>
          <span class="info-label">Lieu :</span><span class="info-value">${lieu}</span>
        </div>
      </div>
      <div class="section">
        <div class="section-title">Client</div>
        <div class="info-grid">
          <span class="info-label">Entreprise :</span><span class="info-value">${entreprise.nom||''}</span>
          <span class="info-label">Adresse :</span><span class="info-value">${entreprise.adresse||''} ${entreprise.codePostal||''} ${entreprise.ville||''}</span>
          <span class="info-label">Contact :</span><span class="info-value">${entreprise.contact||''}</span>
        </div>
      </div>
      <div class="signature-zone">
        <div class="signature-box"><div class="signature-label">Le Responsable Formation</div><br>Date et signature</div>
        <div class="signature-box"><div class="signature-label">Le Formateur</div><br>Lu et approuv√©, date et signature</div>
      </div>
      ${footer}
    `,
    
    convocation_formateur:`
      ${header}
      <h1 class="doc-title">üìß CONVOCATION FORMATEUR</h1>
      <p style="text-align:right">${dateJour}</p>
      <p><strong>√Ä l'attention de :</strong> ${formateur.nom||''} ${formateur.prenom||''}</p>
      <div class="section">
        <p>Nous avons le plaisir de vous convoquer pour animer la formation suivante :</p>
        <div class="info-grid" style="margin-top:15px">
          <span class="info-label">Formation :</span><span class="info-value"><strong>${formation.nom||''}</strong></span>
          <span class="info-label">Dates :</span><span class="info-value">${dateDebut} au ${dateFin}</span>
          <span class="info-label">Horaires :</span><span class="info-value">${session.heureDebut||'09:00'} - ${session.heureFin||'17:00'}</span>
          <span class="info-label">Lieu :</span><span class="info-value">${lieu}</span>
          <span class="info-label">Nombre de stagiaires :</span><span class="info-value">${stagiaires.length} participant(s)</span>
        </div>
      </div>
      <p style="margin-top:20px">Merci de confirmer votre disponibilit√© par retour de mail.</p>
      <p style="margin-top:30px">Cordialement,<br><br><strong>Le Service Formation</strong><br>Formation DesClick</p>
      ${footer}
    `,
    
    contrat_formateur:`
      ${header}
      <h1 class="doc-title">üìë CONTRAT DE PRESTATION DE FORMATION</h1>
      <div class="section">
        <div class="section-title">Entre les parties</div>
        <p><strong>Formation DesClick</strong>, Organisme de formation<br>Ci-apr√®s d√©nomm√© "le Donneur d'ordre"</p>
        <p>Et</p>
        <p><strong>${formateur.nom||''} ${formateur.prenom||''}</strong><br>Formateur ${formateur.type||'externe'}<br>Ci-apr√®s d√©nomm√© "le Prestataire"</p>
      </div>
      <div class="section">
        <div class="section-title">Objet du contrat</div>
        <div class="info-grid">
          <span class="info-label">Formation :</span><span class="info-value">${formation.nom||''}</span>
          <span class="info-label">Dates :</span><span class="info-value">${dateDebut} au ${dateFin}</span>
          <span class="info-label">Dur√©e :</span><span class="info-value">${formation.duree||''} heures</span>
          <span class="info-label">Tarif journalier :</span><span class="info-value">${formateur.tarifJour||formateur.tarifJournalier||''} ‚Ç¨ HT</span>
        </div>
      </div>
      <div class="signature-zone">
        <div class="signature-box"><div class="signature-label">Le Donneur d'ordre</div><br>Date et signature</div>
        <div class="signature-box"><div class="signature-label">Le Prestataire</div><br>Lu et approuv√©, date et signature</div>
      </div>
      ${footer}
    `,
    
    questionnaire_satisfaction_formateur:`
      ${header}
      <h1 class="doc-title">‚≠ê QUESTIONNAIRE DE SATISFACTION - FORMATEUR</h1>
      <div class="section">
        <div class="info-grid">
          <span class="info-label">Formateur :</span><span class="info-value">${formateur.nom||''} ${formateur.prenom||''}</span>
          <span class="info-label">Formation :</span><span class="info-value">${formation.nom||''}</span>
          <span class="info-label">Dates :</span><span class="info-value">${dateDebut} - ${dateFin}</span>
        </div>
      </div>
      <table>
        <tr><th>Crit√®res</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>
        <tr><td>Qualit√© de l'organisation</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
        <tr><td>Ad√©quation des supports p√©dagogiques</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
        <tr><td>Niveau des participants</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
        <tr><td>Conditions mat√©rielles</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
      </table>
      <p><strong>Commentaires :</strong></p>
      <div style="border:1px solid #e2e8f0;min-height:100px;margin:10px 0"></div>
      <p style="margin-top:20px"><strong>Date :</strong> _________________ <strong>Signature :</strong></p>
      ${footer}
    `,
    
    // ===== DOCUMENTS STAGIAIRES =====
    convocation_stagiaire:`
      ${header}
      <h1 class="doc-title">üìß CONVOCATION √Ä LA FORMATION</h1>
      <p style="text-align:right">${dateJour}</p>
      <div class="section">
        <div class="section-title">Informations formation</div>
        <div class="info-grid">
          <span class="info-label">Formation :</span><span class="info-value"><strong>${formation.nom||''}</strong></span>
          <span class="info-label">Dates :</span><span class="info-value">${dateDebut} au ${dateFin}</span>
          <span class="info-label">Horaires :</span><span class="info-value">${session.heureDebut||'09:00'} - ${session.heureFin||'17:00'}</span>
          <span class="info-label">Lieu :</span><span class="info-value">${lieu}</span>
          <span class="info-label">Formateur :</span><span class="info-value">${formateur.nom||''} ${formateur.prenom||''}</span>
        </div>
      </div>
      <div class="section">
        <div class="section-title">Liste des stagiaires convoqu√©s</div>
        <table>
          <tr><th>Nom</th><th>Pr√©nom</th><th>Email</th><th>Entreprise</th></tr>
          ${stagiaires.map(s=>`<tr><td>${s.nom||''}</td><td>${s.prenom||''}</td><td>${s.email||''}</td><td>${entreprise.nom||''}</td></tr>`).join('')}
        </table>
      </div>
      <p>Merci de vous pr√©senter √† l'heure indiqu√©e muni de cette convocation.</p>
      ${footer}
    `,
    
    questionnaire_positionnement:`
      ${header}
      <h1 class="doc-title">üìã QUESTIONNAIRE DE POSITIONNEMENT</h1>
      <div class="section">
        <div class="info-grid">
          <span class="info-label">Formation :</span><span class="info-value"><strong>${formation.nom||''}</strong></span>
          <span class="info-label">Dates :</span><span class="info-value">${dateDebut} - ${dateFin}</span>
        </div>
      </div>
      <div class="section">
        <div class="section-title">Stagiaire</div>
        <div class="info-grid">
          <span class="info-label">Nom :</span><span class="info-value">_________________________________</span>
          <span class="info-label">Pr√©nom :</span><span class="info-value">_________________________________</span>
          <span class="info-label">Fonction :</span><span class="info-value">_________________________________</span>
        </div>
      </div>
      <p><strong>1. Quelles sont vos attentes concernant cette formation ?</strong></p>
      <div style="border:1px solid #e2e8f0;min-height:60px;margin:10px 0"></div>
      <p><strong>2. Avez-vous d√©j√† une exp√©rience dans ce domaine ?</strong> ‚òê Oui ‚òê Non</p>
      <p>Si oui, pr√©cisez :</p>
      <div style="border:1px solid #e2e8f0;min-height:40px;margin:10px 0"></div>
      <p><strong>3. Quels objectifs souhaitez-vous atteindre ?</strong></p>
      <div style="border:1px solid #e2e8f0;min-height:60px;margin:10px 0"></div>
      ${footer}
    `,
    
    questionnaire_satisfaction_stagiaire:`
      ${header}
      <h1 class="doc-title">‚≠ê QUESTIONNAIRE DE SATISFACTION STAGIAIRE</h1>
      <div class="section">
        <div class="info-grid">
          <span class="info-label">Formation :</span><span class="info-value">${formation.nom||''}</span>
          <span class="info-label">Dates :</span><span class="info-value">${dateDebut} - ${dateFin}</span>
          <span class="info-label">Formateur :</span><span class="info-value">${formateur.nom||''} ${formateur.prenom||''}</span>
        </div>
      </div>
      <p><em>Merci d'√©valuer chaque crit√®re de 1 (insuffisant) √† 5 (excellent)</em></p>
      <table>
        <tr><th>Crit√®res</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>
        <tr><td>Contenu de la formation</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
        <tr><td>Qualit√© p√©dagogique du formateur</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
        <tr><td>Organisation et logistique</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
        <tr><td>Supports p√©dagogiques</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
        <tr><td>Atteinte des objectifs</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
      </table>
      <p><strong>Commentaires :</strong></p>
      <div style="border:1px solid #e2e8f0;min-height:80px;margin:10px 0"></div>
      <p><strong>Nom :</strong> _________________ <strong>Date :</strong> _________________ <strong>Signature :</strong></p>
      ${footer}
    `,
    
    quiz:`
      ${header}
      <h1 class="doc-title">‚ùì QUIZ D'√âVALUATION</h1>
      <div class="section">
        <div class="info-grid">
          <span class="info-label">Formation :</span><span class="info-value"><strong>${formation.nom||''}</strong></span>
          <span class="info-label">Nom du stagiaire :</span><span class="info-value">_________________________________</span>
          <span class="info-label">Date :</span><span class="info-value">_________________________________</span>
        </div>
      </div>
      <p><em>Ce quiz permet d'√©valuer vos connaissances. Cochez la ou les bonnes r√©ponses.</em></p>
      <div class="section">
        <p><strong>Question 1 :</strong> [Question √† personnaliser selon la formation]</p>
        <p>‚òê R√©ponse A &nbsp;&nbsp; ‚òê R√©ponse B &nbsp;&nbsp; ‚òê R√©ponse C &nbsp;&nbsp; ‚òê R√©ponse D</p>
      </div>
      <div class="section">
        <p><strong>Question 2 :</strong> [Question √† personnaliser selon la formation]</p>
        <p>‚òê R√©ponse A &nbsp;&nbsp; ‚òê R√©ponse B &nbsp;&nbsp; ‚òê R√©ponse C &nbsp;&nbsp; ‚òê R√©ponse D</p>
      </div>
      <div class="section">
        <p><strong>Question 3 :</strong> [Question √† personnaliser selon la formation]</p>
        <p>‚òê R√©ponse A &nbsp;&nbsp; ‚òê R√©ponse B &nbsp;&nbsp; ‚òê R√©ponse C &nbsp;&nbsp; ‚òê R√©ponse D</p>
      </div>
      <p style="margin-top:20px"><strong>Score :</strong> _____ / 20</p>
      ${footer}
    `,
    
    test_final:`
      ${header}
      <h1 class="doc-title">üìù TEST FINAL D'√âVALUATION</h1>
      <div class="section">
        <div class="info-grid">
          <span class="info-label">Formation :</span><span class="info-value"><strong>${formation.nom||''}</strong></span>
          <span class="info-label">Dur√©e du test :</span><span class="info-value">30 minutes</span>
          <span class="info-label">Nom du stagiaire :</span><span class="info-value">_________________________________</span>
          <span class="info-label">Date :</span><span class="info-value">_________________________________</span>
        </div>
      </div>
      <div class="section">
        <p><strong>Partie 1 - Questions de connaissances (10 points)</strong></p>
        <p>1. _____________________________________________________________________________</p>
        <div style="border:1px solid #e2e8f0;min-height:50px;margin:10px 0"></div>
        <p>2. _____________________________________________________________________________</p>
        <div style="border:1px solid #e2e8f0;min-height:50px;margin:10px 0"></div>
      </div>
      <div class="section">
        <p><strong>Partie 2 - Cas pratique (10 points)</strong></p>
        <div style="border:1px solid #e2e8f0;min-height:100px;margin:10px 0"></div>
      </div>
      <p><strong>Note finale :</strong> _____ / 20 &nbsp;&nbsp; <strong>Appr√©ciation :</strong> _________________________________</p>
      ${footer}
    `,
    
    // ===== DOCUMENTS SESSION =====
    feuille_emargement:`
      ${header}
      <h1 class="doc-title">‚úçÔ∏è FEUILLE D'√âMARGEMENT</h1>
      <div class="section">
        <div class="info-grid">
          <span class="info-label">Formation :</span><span class="info-value"><strong>${formation.nom||''}</strong></span>
          <span class="info-label">Dates :</span><span class="info-value">${dateDebut} au ${dateFin}</span>
          <span class="info-label">Horaires :</span><span class="info-value">${session.heureDebut||'09:00'} - ${session.heureFin||'17:00'}</span>
          <span class="info-label">Lieu :</span><span class="info-value">${lieu}</span>
          <span class="info-label">Formateur :</span><span class="info-value">${formateur.nom||''} ${formateur.prenom||''}</span>
        </div>
      </div>
      <table>
        <tr><th>Nom</th><th>Pr√©nom</th><th>Entreprise</th><th>Matin</th><th>Apr√®s-midi</th></tr>
        ${stagiaires.map(s=>`<tr><td>${s.nom||''}</td><td>${s.prenom||''}</td><td>${entreprise.nom||''}</td><td style="width:80px"></td><td style="width:80px"></td></tr>`).join('')}
        ${stagiaires.length<8?Array(8-stagiaires.length).fill('<tr><td></td><td></td><td></td><td></td><td></td></tr>').join(''):''}
      </table>
      <div class="signature-zone">
        <div class="signature-box"><div class="signature-label">Signature du formateur</div></div>
        <div class="signature-box"><div class="signature-label">Cachet de l'entreprise</div></div>
      </div>
      ${footer}
    `,
    
    programme_formation:`
      ${header}
      <h1 class="doc-title">üìö PROGRAMME DE FORMATION</h1>
      <div class="section">
        <div class="section-title">Informations g√©n√©rales</div>
        <div class="info-grid">
          <span class="info-label">Intitul√© :</span><span class="info-value"><strong>${formation.nom||''}</strong></span>
          <span class="info-label">Code :</span><span class="info-value">${formation.code||''}</span>
          <span class="info-label">Dur√©e :</span><span class="info-value">${formation.duree||''} heures</span>
          <span class="info-label">Public vis√© :</span><span class="info-value">${formation.public||'Tout public'}</span>
          <span class="info-label">Dates :</span><span class="info-value">${dateDebut} au ${dateFin}</span>
        </div>
      </div>
      <div class="section">
        <div class="section-title">Objectifs p√©dagogiques</div>
        <p>${formation.objectifs||'√Ä l\'issue de cette formation, le stagiaire sera capable de ma√Ætriser les comp√©tences cl√©s du domaine.'}</p>
      </div>
      <div class="section">
        <div class="section-title">Contenu de la formation</div>
        <p><strong>Module 1 :</strong> Introduction et fondamentaux</p>
        <p><strong>Module 2 :</strong> Approfondissement des connaissances</p>
        <p><strong>Module 3 :</strong> Mise en pratique et exercices</p>
        <p><strong>Module 4 :</strong> √âvaluation et conclusion</p>
      </div>
      <div class="section">
        <div class="section-title">M√©thodes p√©dagogiques</div>
        <p>‚Ä¢ Apports th√©oriques et m√©thodologiques<br>‚Ä¢ Exercices pratiques et mises en situation<br>‚Ä¢ √âchanges et retours d'exp√©rience</p>
      </div>
      ${footer}
    `,
    
    attestation_presence:`
      ${header}
      <h1 class="doc-title">üìú ATTESTATION DE PR√âSENCE</h1>
      <div class="section" style="text-align:center">
        <p style="font-size:14px">Nous soussign√©s, <strong>Formation DesClick</strong>, organisme de formation,<br>attestons que :</p>
      </div>
      <div class="section">
        <div class="section-title">Liste des stagiaires ayant suivi la formation</div>
        <table>
          <tr><th>Nom</th><th>Pr√©nom</th><th>Entreprise</th></tr>
          ${stagiaires.map(s=>`<tr><td>${s.nom||''}</td><td>${s.prenom||''}</td><td>${entreprise.nom||''}</td></tr>`).join('')}
        </table>
      </div>
      <div class="section">
        <p>Ont bien suivi la formation :</p>
        <div class="info-grid" style="margin-top:15px">
          <span class="info-label">Intitul√© :</span><span class="info-value"><strong>${formation.nom||''}</strong></span>
          <span class="info-label">Dates :</span><span class="info-value">${dateDebut} au ${dateFin}</span>
          <span class="info-label">Dur√©e :</span><span class="info-value">${formation.duree||''} heures</span>
          <span class="info-label">Lieu :</span><span class="info-value">${lieu}</span>
        </div>
      </div>
      <p style="margin-top:30px">Fait √† _________________, le ${dateJour}</p>
      <div style="margin-top:40px;text-align:right">
        <p><strong>Le Responsable Formation</strong></p>
        <p style="margin-top:50px">(Signature et cachet)</p>
      </div>
      ${footer}
    `
  };
  
  // Retourner le document HTML complet
  return `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${codeDoc} - ${formation.nom||'Document'}</title>
  ${styleCSS}
</head>
<body>
  ${templates[codeDoc]||`<p>Template non trouv√© pour : ${codeDoc}</p>`}
</body>
</html>`;
}

async function genererDocConception(codeDoc,typeDoc){
  if(!conceptionPecSelectionnee){
    toast('Aucune PEC s√©lectionn√©e','error');
    return;
  }
  
  const allDocs=[...DOCS_CONCEPTION.formateur,...DOCS_CONCEPTION.stagiaires,...DOCS_CONCEPTION.session];
  const docConfig=allDocs.find(d=>d.code===codeDoc);
  
  if(!docConfig){
    toast('Configuration du document non trouv√©e','error');
    return;
  }
  
  // Donn√©es pour le document
  const pec=conceptionPecSelectionnee;
  const ent=pec.entreprise||{};
  const form=pec.formation||{};
  const formateur=pec.formateur||{};
  const session=pec.session||{};
  const stagiaires=pec.stagiaires||[];
  const dateJour=new Date().toLocaleDateString('fr-FR');
  const dateDebut=fmtDate(session.dateDebutPrev||session.dateDebutEffective)||'√Ä d√©finir';
  const dateFin=fmtDate(session.dateFinPrev||session.dateFinEffective)||'√Ä d√©finir';
  const lieu=session.modalite==='Intra'?(session.lieuIntra||'Sur site client'):'Centre de formation';
  
  // G√©n√©rer le contenu HTML selon le type de document
  let htmlContent=genererTemplateDocument(codeDoc,{
    entreprise:ent,
    formation:form,
    formateur:formateur,
    session:session,
    stagiaires:stagiaires,
    pec:pec,
    dateJour:dateJour,
    dateDebut:dateDebut,
    dateFin:dateFin,
    lieu:lieu
  });
  
  // G√©n√©rer le nom du fichier
  const formationNom=(form.nom||'Formation').replace(/[^a-zA-Z0-9√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ß\s]/gi,'_').replace(/\s+/g,'_');
  const sessionId=session.id||'';
  const filename=`${docConfig.code}_${formationNom}_SES${sessionId}.html`;
  
  // Cr√©er le blob HTML
  const blob=new Blob([htmlContent],{type:'text/html;charset=utf-8'});
  
  // Stocker le document g√©n√©r√©
  documentsGeneres[codeDoc]={
    blob:blob,
    htmlContent:htmlContent,
    filename:filename,
    formation:form.nom||'',
    type:typeDoc,
    label:docConfig.label,
    genereLe:new Date().toISOString(),
    data:{entreprise:ent,formation:form,formateur:formateur,stagiaires:stagiaires}
  };
  
  // Mettre √† jour l'affichage avec les boutons visualiser/t√©l√©charger
  const btnsContainer=document.getElementById('btns-'+codeDoc);
  if(btnsContainer){
    btnsContainer.innerHTML=`
      <span style="color:#10b981;font-weight:600;margin-right:5px">‚úì G√©n√©r√©</span>
      <button class="btn btn-sm btn-success" onclick="visualiserDocConception('${codeDoc}')" title="Visualiser">üëÅÔ∏è Voir</button>
      <button class="btn btn-sm btn-primary" onclick="telechargerDocConception('${codeDoc}')" title="T√©l√©charger">‚¨áÔ∏è T√©l√©charger</button>
      <button class="btn btn-sm btn-secondary" onclick="genererDocConception('${codeDoc}','${typeDoc}')" title="R√©g√©n√©rer">üîÑ</button>
    `;
  }
  
  // Mettre en √©vidence le document g√©n√©r√©
  const docItem=document.getElementById('doc-item-'+codeDoc);
  if(docItem){
    docItem.style.borderColor='#10b981';
    docItem.style.background='#f0fdf4';
  }
  
  toast(`Document "${docConfig.label}" g√©n√©r√© avec succ√®s !`,'success');
  
  // Mettre √† jour le r√©capitulatif
  afficherRecapDocuments();
}

// Visualiser un document g√©n√©r√©
function visualiserDocConception(codeDoc){
  const doc=documentsGeneres[codeDoc];
  if(!doc){
    toast('Document non trouv√©. Veuillez le g√©n√©rer d\'abord.','warning');
    return;
  }
  
  // Cr√©er une modal de pr√©visualisation avec iframe
  const modal=document.createElement('div');
  modal.className='modal active';
  modal.id='modal-preview-doc';
  modal.innerHTML=`
    <div class="modal-content" style="max-width:900px;height:90vh;display:flex;flex-direction:column">
      <div class="modal-header" style="flex-shrink:0">
        <h3>üìÑ ${doc.label} - ${esc(doc.formation)}</h3>
        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
      </div>
      <div class="modal-body" style="padding:10px;flex:1;overflow:hidden;display:flex;flex-direction:column">
        <div style="display:flex;gap:15px;margin-bottom:10px;font-size:0.85em;color:#64748b;flex-shrink:0">
          <span>üìÅ ${doc.filename}</span>
          <span>üìÖ G√©n√©r√© le ${new Date(doc.genereLe).toLocaleString('fr-FR')}</span>
        </div>
        <iframe id="preview-iframe-${codeDoc}" style="flex:1;width:100%;border:1px solid #e2e8f0;border-radius:8px;background:white"></iframe>
      </div>
      <div class="modal-footer" style="padding:15px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;flex-shrink:0">
        <button class="btn btn-info" onclick="imprimerDocConception('${codeDoc}')">
          üñ®Ô∏è Imprimer
        </button>
        <button class="btn btn-primary" onclick="telechargerDocConception('${codeDoc}')">
          ‚¨áÔ∏è T√©l√©charger
        </button>
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Fermer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Charger le contenu HTML dans l'iframe
  const iframe=document.getElementById('preview-iframe-'+codeDoc);
  if(iframe&&doc.htmlContent){
    iframe.srcdoc=doc.htmlContent;
  }
}

// Imprimer un document
function imprimerDocConception(codeDoc){
  const doc=documentsGeneres[codeDoc];
  if(!doc||!doc.htmlContent){
    toast('Document non trouv√©','warning');
    return;
  }
  
  // Ouvrir dans une nouvelle fen√™tre pour impression
  const printWindow=window.open('','_blank');
  printWindow.document.write(doc.htmlContent);
  printWindow.document.close();
  printWindow.onload=function(){
    printWindow.print();
  };
}

// T√©l√©charger un document g√©n√©r√©
function telechargerDocConception(codeDoc){
  const doc=documentsGeneres[codeDoc];
  if(!doc){
    toast('Document non trouv√©. Veuillez le g√©n√©rer d\'abord.','warning');
    return;
  }
  
  // Cr√©er le lien de t√©l√©chargement
  const url=URL.createObjectURL(doc.blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=doc.filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  toast(`T√©l√©chargement de "${doc.filename}" lanc√©`,'success');
}

async function genererTousDocumentsConception(){
  if(!conceptionPecSelectionnee){
    toast('Aucune PEC s√©lectionn√©e','error');
    return;
  }
  
  toast('G√©n√©ration de tous les documents en cours...','info');
  
  // G√©n√©rer tous les documents
  const allDocs=[...DOCS_CONCEPTION.formateur,...DOCS_CONCEPTION.stagiaires,...DOCS_CONCEPTION.session];
  let count=0;
  for(const doc of allDocs){
    if(doc.externe&&conceptionPecSelectionnee.formateur?.type!=='Externe')continue;
    const typeDoc=DOCS_CONCEPTION.formateur.includes(doc)?'formateur':
                  DOCS_CONCEPTION.stagiaires.includes(doc)?'stagiaires':'session';
    await genererDocConception(doc.code,typeDoc);
    count++;
  }
  
  // Mettre √† jour le statut
  const pec=conceptionPecSelectionnee;
  pec.conceptionStatut='Documents g√©n√©r√©s';
  await dbPut('dpc',pec);
  
  toast(`${count} documents g√©n√©r√©s avec succ√®s !`,'success');
}

function envoyerConvocationsConception(){
  if(!conceptionPecSelectionnee?.stagiaires?.length){
    toast('Aucun stagiaire √† convoquer','warning');
    return;
  }
  
  const stagiaires=conceptionPecSelectionnee.stagiaires;
  const emails=stagiaires.filter(s=>s.email).map(s=>s.email);
  
  if(emails.length===0){
    toast('Aucun email de stagiaire disponible','warning');
    return;
  }
  
  toast(`Envoi des convocations √† ${emails.length} stagiaire(s)... (simulation)`,'info');
  setTimeout(()=>toast('Convocations envoy√©es !','success'),1500);
}

function telechargerArchiveConception(){
  const docsGeneres=Object.keys(documentsGeneres);
  
  if(docsGeneres.length===0){
    toast('Aucun document g√©n√©r√©. G√©n√©rez d\'abord les documents.','warning');
    return;
  }
  
  // T√©l√©charger chaque document individuellement (car pas de lib ZIP native)
  toast(`T√©l√©chargement de ${docsGeneres.length} document(s)...`,'info');
  
  docsGeneres.forEach((code,index)=>{
    setTimeout(()=>{
      telechargerDocConception(code);
    },index*500); // Espacer les t√©l√©chargements de 500ms
  });
  
  toast('Tous les documents sont en cours de t√©l√©chargement','success');
}

// Afficher le r√©capitulatif des documents g√©n√©r√©s
function afficherRecapDocuments(){
  const recapDiv=document.getElementById('recap-docs-generes');
  const listeDiv=document.getElementById('liste-docs-generes');
  
  if(!recapDiv||!listeDiv)return;
  
  const docsGeneres=Object.keys(documentsGeneres);
  
  if(docsGeneres.length===0){
    recapDiv.style.display='block';
    listeDiv.innerHTML=`<span style="color:#6b7280;font-style:italic">Aucun document g√©n√©r√© pour le moment</span>`;
    return;
  }
  
  recapDiv.style.display='block';
  listeDiv.innerHTML=docsGeneres.map(code=>{
    const doc=documentsGeneres[code];
    const typeColor=doc.type==='formateur'?'#7c3aed':doc.type==='stagiaires'?'#059669':'#b45309';
    return `
      <div style="display:inline-flex;align-items:center;gap:5px;background:white;padding:6px 10px;border-radius:6px;border:1px solid #e5e7eb;font-size:0.85em">
        <span style="width:8px;height:8px;background:${typeColor};border-radius:50%"></span>
        <span>${doc.label}</span>
        <button onclick="visualiserDocConception('${code}')" style="border:none;background:#3b82f6;color:white;border-radius:4px;padding:2px 6px;cursor:pointer;font-size:0.8em" title="Voir">üëÅÔ∏è</button>
        <button onclick="telechargerDocConception('${code}')" style="border:none;background:#10b981;color:white;border-radius:4px;padding:2px 6px;cursor:pointer;font-size:0.8em" title="T√©l√©charger">‚¨áÔ∏è</button>
      </div>
    `;
  }).join('');
  
  // Ajouter une l√©gende
  listeDiv.innerHTML+=`
    <div style="width:100%;margin-top:10px;font-size:0.75em;color:#6b7280;display:flex;gap:15px;justify-content:center">
      <span><span style="display:inline-block;width:8px;height:8px;background:#7c3aed;border-radius:50%"></span> Formateur</span>
      <span><span style="display:inline-block;width:8px;height:8px;background:#059669;border-radius:50%"></span> Stagiaires</span>
      <span><span style="display:inline-block;width:8px;height:8px;background:#b45309;border-radius:50%"></span> Session</span>
    </div>
  `;
  
  recapDiv.scrollIntoView({behavior:'smooth'});
}

function ouvrirModificationDatesSession(){
  if(!conceptionPecSelectionnee?.session){
    toast('Aucune session li√©e','error');
    return;
  }
  showPage('sessions');
  toast('Modifiez les dates de la session puis revenez dans Conception','info');
}

function envoyerMailAccordNouvelleDates(){
  if(!conceptionPecSelectionnee?.entreprise){
    toast('Aucune entreprise li√©e','error');
    return;
  }
  
  const email=conceptionPecSelectionnee.entreprise.emailContact||conceptionPecSelectionnee.entreprise.emailPro;
  if(!email){
    toast('Email du donneur d\'ordre non trouv√©','warning');
    return;
  }
  
  const subject=encodeURIComponent('Modification des dates de formation - Accord requis');
  const body=encodeURIComponent(`Bonjour,

Suite √† notre √©change, nous vous informons que les dates de la formation "${conceptionPecSelectionnee.formation?.nom||''}" doivent √™tre modifi√©es pour respecter les d√©lais de l'accord OPCO.

Nouvelles dates propos√©es : [√Ä COMPL√âTER]

Merci de nous confirmer votre accord pour ces nouvelles dates.

Cordialement,`);
  
  window.open(`mailto:${email}?subject=${subject}&body=${body}`);
  toast('Client email ouvert','success');
}

function regenererConventionConception(){
  toast('R√©g√©n√©ration de la convention... Veuillez aller dans l\'onglet Conventions.','info');
  naviguerVersSection('documents','conventions');
}

async function marquerApprobationRecue(){
  if(!conceptionPecSelectionnee)return;
  
  if(!confirm('Confirmez-vous avoir re√ßu l\'approbation de l\'OPCO pour les nouvelles dates ?'))return;
  
  conceptionPecSelectionnee.conceptionStatut='Pr√™t pour g√©n√©ration';
  await dbPut('dpc',conceptionPecSelectionnee);
  
  toast('Approbation enregistr√©e. Vous pouvez maintenant g√©n√©rer les documents.','success');
  
  // Passer √† l'√©tape 2
  document.getElementById('conception-option1').style.display='none';
  passerEtape2Conception();
  
  showConception();
}

function ouvrirGestionModelesGED(){
  showPage('ged');
  toast('Ajoutez vos mod√®les de documents dans la section Mod√®les','info');
}

function filterConception(){
  // Le filtrage est g√©r√© via showConception()
  showConception();
}

function genererDocConceptionLegacy(type){
  toast('G√©n√©ration '+type+' - Utilisez le nouveau syst√®me de conception','info');
}

function uploadDocConception(type){
  toast('Upload '+type+' - Utilisez la GED pour uploader les mod√®les','info');
}

// ============ PERMISSIONS ============
let currentPermRole='';
const defaultPermissions={
  Gestionnaire:{
    dashboard:{afficher:true,consulter:true,editer:false},
    demandes:{afficher:true,consulter:true,editer:true},
    entreprises:{afficher:true,consulter:true,editer:true},
    contacts:{afficher:true,consulter:true,editer:true},
    stagiaires:{afficher:true,consulter:true,editer:true},
    opportunites:{afficher:true,consulter:true,editer:true},
    analyse:{afficher:true,consulter:true,editer:true},
    evaluation:{afficher:true,consulter:true,editer:true},
    devis:{afficher:true,consulter:true,editer:true},
    conventions:{afficher:true,consulter:true,editer:true},
    sessions:{afficher:true,consulter:true,editer:true},
    agendaSessions:{afficher:true,consulter:true,editer:true},
    agendaGeneral:{afficher:true,consulter:true,editer:true},
    suivi:{afficher:true,consulter:true,editer:false},
    messagerie:{afficher:true,consulter:true,editer:true},
    dpc:{afficher:true,consulter:true,editer:true},
    conception:{afficher:true,consulter:true,editer:true},
    qualiopi:{afficher:true,consulter:true,editer:true},
    ged:{afficher:true,consulter:true,editer:true},
    referentiels:{afficher:false,consulter:false,editer:false}
  },
  Commercial:{
    dashboard:{afficher:true,consulter:true,editer:false},
    demandes:{afficher:true,consulter:true,editer:false},
    entreprises:{afficher:true,consulter:true,editer:true},
    contacts:{afficher:true,consulter:true,editer:true},
    stagiaires:{afficher:false,consulter:false,editer:false},
    opportunites:{afficher:true,consulter:true,editer:true},
    analyse:{afficher:true,consulter:true,editer:false},
    evaluation:{afficher:false,consulter:false,editer:false},
    devis:{afficher:true,consulter:true,editer:true},
    conventions:{afficher:true,consulter:true,editer:false},
    sessions:{afficher:false,consulter:false,editer:false},
    agendaSessions:{afficher:false,consulter:false,editer:false},
    agendaGeneral:{afficher:true,consulter:true,editer:false},
    suivi:{afficher:true,consulter:true,editer:false},
    messagerie:{afficher:true,consulter:true,editer:true},
    dpc:{afficher:false,consulter:false,editer:false},
    conception:{afficher:false,consulter:false,editer:false},
    qualiopi:{afficher:false,consulter:false,editer:false},
    ged:{afficher:true,consulter:true,editer:false},
    referentiels:{afficher:false,consulter:false,editer:false}
  },
  Formateur:{
    dashboard:{afficher:true,consulter:true,editer:false},
    demandes:{afficher:false,consulter:false,editer:false},
    entreprises:{afficher:false,consulter:false,editer:false},
    contacts:{afficher:false,consulter:false,editer:false},
    stagiaires:{afficher:true,consulter:true,editer:false},
    opportunites:{afficher:false,consulter:false,editer:false},
    analyse:{afficher:false,consulter:false,editer:false},
    evaluation:{afficher:true,consulter:true,editer:true},
    devis:{afficher:false,consulter:false,editer:false},
    conventions:{afficher:false,consulter:false,editer:false},
    sessions:{afficher:true,consulter:true,editer:false},
    agendaSessions:{afficher:true,consulter:true,editer:false},
    agendaGeneral:{afficher:true,consulter:true,editer:false},
    suivi:{afficher:false,consulter:false,editer:false},
    messagerie:{afficher:true,consulter:true,editer:true},
    dpc:{afficher:false,consulter:false,editer:false},
    conception:{afficher:false,consulter:false,editer:false},
    qualiopi:{afficher:true,consulter:true,editer:true},
    ged:{afficher:true,consulter:true,editer:false},
    referentiels:{afficher:false,consulter:false,editer:false}
  }
};

function showPermissionsRole(role){
  currentPermRole=role;
  document.getElementById('permissions-grid').style.display='block';
  document.getElementById('permissions-role-title').textContent='Permissions pour : '+role;
  
  // Activer le bon bouton
  ['Gestionnaire','Commercial','Formateur'].forEach(r=>{
    document.getElementById('btn-perm-'+r.toLowerCase()).classList.toggle('active',r===role);
  });
  
  // Charger les permissions
  const perms=JSON.parse(localStorage.getItem('permissions_'+role)||'null')||defaultPermissions[role];
  
  document.querySelectorAll('#permissions-tbody tr').forEach(tr=>{
    const module=tr.dataset.module;
    if(perms[module]){
      tr.querySelector('.perm-afficher').checked=perms[module].afficher;
      tr.querySelector('.perm-consulter').checked=perms[module].consulter;
      tr.querySelector('.perm-editer').checked=perms[module].editer;
    }
  });
}

function savePermissions(){
  if(!currentPermRole)return;
  
  const perms={};
  document.querySelectorAll('#permissions-tbody tr').forEach(tr=>{
    const module=tr.dataset.module;
    perms[module]={
      afficher:tr.querySelector('.perm-afficher').checked,
      consulter:tr.querySelector('.perm-consulter').checked,
      editer:tr.querySelector('.perm-editer').checked
    };
  });
  
  localStorage.setItem('permissions_'+currentPermRole,JSON.stringify(perms));
  toast('Permissions enregistr√©es pour '+currentPermRole,'success');
}

function resetPermissions(){
  if(!currentPermRole)return;
  localStorage.removeItem('permissions_'+currentPermRole);
  showPermissionsRole(currentPermRole);
  toast('Permissions r√©initialis√©es','info');
}

function filterGestionnaires(){
  const search=(document.getElementById('search-gestionnaires')?.value||'').toLowerCase();
  const role=document.getElementById('filter-role')?.value||'';
  
  document.querySelectorAll('#table-gestionnaires tr').forEach(tr=>{
    const text=tr.textContent.toLowerCase();
    const roleMatch=!role||tr.textContent.includes(role);
    tr.style.display=(text.includes(search)&&roleMatch)?'':'none';
  });
}

// Fonction loadGed
async function loadGed(g){
  if(g==='entreprises'){
    await showGED();
  }else if(g==='formations'){
    await loadGEDFormations();
  }else if(g==='modeles'){
    await loadGEDModeles();
  }
}

async function loadGEDModeles(){
  // Charger les mod√®les de documents
  const docs=await dbGetAll('ged_documents');
  const modeles=docs.filter(d=>d.type==='modele');
  
  // Mettre √† jour le statut de chaque mod√®le
  const codeModeles=[
    'ordre_mission','convocation_formateur','contrat_formateur','questionnaire_satisfaction_formateur',
    'convocation_stagiaire','questionnaire_positionnement','questionnaire_satisfaction_stagiaire','quiz','test_final',
    'feuille_emargement','programme_formation','attestation_presence'
  ];
  
  codeModeles.forEach(code=>{
    const statusEl=document.getElementById('modele-'+code+'-status');
    if(statusEl){
      const modele=modeles.find(m=>m.codeModele===code);
      if(modele){
        statusEl.innerHTML=`<span style="color:#10b981">‚úì ${esc(modele.nom)}</span>`;
      }else{
        statusEl.innerHTML='<span style="color:#ef4444">Non upload√©</span>';
      }
    }
  });
}

async function uploadModeleGED(codeModele){
  const input=document.createElement('input');
  input.type='file';
  input.accept='.doc,.docx,.pdf';
  input.onchange=async function(){
    const file=input.files[0];
    if(!file)return;
    
    // V√©rifier la taille (max 10 Mo)
    if(file.size>10*1024*1024){
      toast('Fichier trop volumineux (max 10 Mo)','error');
      return;
    }
    
    // Lire le fichier en base64
    const reader=new FileReader();
    reader.onload=async function(e){
      const base64=e.target.result;
      
      // Supprimer l'ancien mod√®le s'il existe
      const docs=await dbGetAll('ged_documents');
      const oldModele=docs.find(d=>d.type==='modele'&&d.codeModele===codeModele);
      if(oldModele){
        await dbDelete('ged_documents',oldModele.id);
      }
      
      // Enregistrer le nouveau mod√®le
      await dbAdd('ged_documents',{
        nom:file.name,
        type:'modele',
        codeModele:codeModele,
        mimeType:file.type,
        taille:file.size,
        data:base64,
        dateUpload:new Date().toISOString()
      });
      
      toast('Mod√®le "'+file.name+'" upload√©','success');
      loadGEDModeles();
      verifierModelesUploades();
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

// ============ G√âN√âRATION PERSONNALIS√âE PAR STAGIAIRE ============

// Variables pour les balises de remplacement dans les mod√®les
const BALISES_MODELE = {
  // Stagiaire
  '{NOM_STAGIAIRE}': (data) => data.stagiaire?.nom || '',
  '{PRENOM_STAGIAIRE}': (data) => data.stagiaire?.prenom || '',
  '{NOM_COMPLET_STAGIAIRE}': (data) => `${data.stagiaire?.prenom || ''} ${data.stagiaire?.nom || ''}`.trim(),
  '{EMAIL_STAGIAIRE}': (data) => data.stagiaire?.email || '',
  '{TELEPHONE_STAGIAIRE}': (data) => data.stagiaire?.telephone || '',
  '{FONCTION_STAGIAIRE}': (data) => data.stagiaire?.fonction || '',
  
  // Formation
  '{NOM_FORMATION}': (data) => data.formation?.nom || '',
  '{CODE_FORMATION}': (data) => data.formation?.code || '',
  '{DUREE_FORMATION}': (data) => data.formation?.duree || '',
  '{OBJECTIFS_FORMATION}': (data) => data.formation?.objectifs || '',
  '{PUBLIC_FORMATION}': (data) => data.formation?.public || '',
  
  // Session
  '{DATE_DEBUT}': (data) => fmtDate(data.session?.dateDebutPrev || data.session?.dateDebutEffective) || '',
  '{DATE_FIN}': (data) => fmtDate(data.session?.dateFinPrev || data.session?.dateFinEffective) || '',
  '{LIEU}': (data) => data.session?.modalite === 'Intra' ? (data.session?.lieuIntra || 'Sur site client') : 'Centre de formation',
  '{MODALITE}': (data) => data.session?.modalite || 'Pr√©sentiel',
  '{HORAIRES}': (data) => `${data.session?.heureDebut || '09:00'} - ${data.session?.heureFin || '17:00'}`,
  '{REFERENCE_SESSION}': (data) => data.session?.id ? `SES-${data.session.id}` : '',
  
  // Entreprise
  '{NOM_ENTREPRISE}': (data) => data.entreprise?.nom || data.entreprise?.raisonSociale || '',
  '{ADRESSE_ENTREPRISE}': (data) => data.entreprise?.adresse || '',
  '{SIRET_ENTREPRISE}': (data) => data.entreprise?.siret || '',
  
  // Formateur
  '{NOM_FORMATEUR}': (data) => data.formateur?.nom || '',
  '{PRENOM_FORMATEUR}': (data) => data.formateur?.prenom || '',
  '{NOM_COMPLET_FORMATEUR}': (data) => `${data.formateur?.prenom || ''} ${data.formateur?.nom || ''}`.trim(),
  
  // Dates g√©n√©rales
  '{DATE_JOUR}': () => new Date().toLocaleDateString('fr-FR'),
  '{ANNEE}': () => new Date().getFullYear().toString(),
  
  // Organisme
  '{NOM_ORGANISME}': () => 'Formation DesClick',
  '{ADRESSE_ORGANISME}': () => '123 rue de la Formation, 75000 Paris',
  '{SIRET_ORGANISME}': () => '12345678900012',
  '{NDA_ORGANISME}': () => '11 75 12345 67'
};

// V√©rifier les mod√®les upload√©s et mettre √† jour l'affichage
async function verifierModelesUploades() {
  try {
    const docs = await dbGetAll('ged_documents');
    const modeles = docs.filter(d => d.type === 'modele');
    
    // Liste des codes de documents
    const codesDocs = [
      'questionnaire_satisfaction_stagiaire',
      'questionnaire_positionnement',
      'convocation_stagiaire',
      'quiz',
      'test_final',
      'questionnaire_satisfaction_formateur',
      'ordre_mission',
      'convocation_formateur',
      'contrat_formateur'
    ];
    
    codesDocs.forEach(code => {
      const modele = modeles.find(m => m.codeModele === code);
      const statusEl = document.getElementById(`modele-status-${code}`);
      
      if (statusEl) {
        if (modele) {
          statusEl.innerHTML = `<span style="color:#10b981">‚úÖ Mod√®le: ${esc(modele.nom)}</span>`;
        } else {
          statusEl.innerHTML = `<span style="color:#f59e0b">‚ö†Ô∏è Pas de mod√®le personnalis√©</span>`;
        }
      }
    });
  } catch (e) {
    console.warn('Erreur v√©rification mod√®les:', e);
  }
}

// G√©n√©rer les documents personnalis√©s par stagiaire
async function genererDocsParStagiaire(codeDoc) {
  if (!conceptionPecSelectionnee) {
    toast('Aucune PEC s√©lectionn√©e', 'error');
    return;
  }
  
  const pec = conceptionPecSelectionnee;
  const stagiaires = pec.stagiaires || [];
  
  if (stagiaires.length === 0) {
    toast('Aucun stagiaire dans cette session', 'warning');
    return;
  }
  
  // Chercher le mod√®le upload√©
  const docs = await dbGetAll('ged_documents');
  const modele = docs.find(d => d.type === 'modele' && d.codeModele === codeDoc);
  
  if (!modele) {
    // Proposer d'utiliser le template par d√©faut ou d'uploader un mod√®le
    const choix = confirm(
      `Aucun mod√®le personnalis√© n'a √©t√© upload√© pour ce type de document.\n\n` +
      `Voulez-vous :\n` +
      `‚Ä¢ OK : Utiliser le template par d√©faut pour g√©n√©rer les questionnaires\n` +
      `‚Ä¢ Annuler : Uploader d'abord un mod√®le Word (.docx) personnalis√©`
    );
    
    if (choix) {
      await genererDocsParStagiaireDefaut(codeDoc);
    } else {
      uploadModeleGED(codeDoc);
    }
    return;
  }
  
  // V√©rifier le type de fichier
  const ext = modele.nom.split('.').pop().toLowerCase();
  
  if (ext === 'docx') {
    await genererDocsParStagiaireDocx(codeDoc, modele, stagiaires);
  } else if (ext === 'pdf') {
    toast('Les fichiers PDF ne peuvent pas √™tre personnalis√©s. Veuillez uploader un mod√®le Word (.docx)', 'warning');
  } else {
    toast('Format de mod√®le non support√©. Utilisez un fichier .docx', 'error');
  }
}

// G√©n√©rer les documents √† partir d'un mod√®le DOCX
async function genererDocsParStagiaireDocx(codeDoc, modele, stagiaires) {
  const pec = conceptionPecSelectionnee;
  const formation = pec.formation || {};
  const session = pec.session || {};
  const entreprise = pec.entreprise || {};
  const formateur = pec.formateur || {};
  
  toast('üîÑ G√©n√©ration des questionnaires en cours...', 'info');
  
  try {
    // Convertir le base64 en ArrayBuffer
    const base64Data = modele.data.split(',')[1];
    const binaryString = atob(base64Data);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    
    // Cr√©er un ZIP pour tous les documents g√©n√©r√©s
    const outputZip = new JSZip();
    const docsGeneres = [];
    
    for (const stagiaire of stagiaires) {
      // Pr√©parer les donn√©es de remplacement
      const replacements = {
        'NOM_STAGIAIRE': stagiaire.nom || '',
        'PRENOM_STAGIAIRE': stagiaire.prenom || '',
        'NOM_COMPLET_STAGIAIRE': `${stagiaire.prenom || ''} ${stagiaire.nom || ''}`.trim(),
        'EMAIL_STAGIAIRE': stagiaire.email || '',
        'TELEPHONE_STAGIAIRE': stagiaire.telephone || '',
        'FONCTION_STAGIAIRE': stagiaire.fonction || '',
        'NOM_FORMATION': formation.nom || '',
        'CODE_FORMATION': formation.code || '',
        'DUREE_FORMATION': String(formation.duree || ''),
        'OBJECTIFS_FORMATION': formation.objectifs || '',
        'PUBLIC_FORMATION': formation.public || '',
        'DATE_DEBUT': fmtDate(session.dateDebutPrev || session.dateDebutEffective) || '',
        'DATE_FIN': fmtDate(session.dateFinPrev || session.dateFinEffective) || '',
        'LIEU': session.modalite === 'Intra' ? (session.lieuIntra || 'Sur site client') : 'Centre de formation',
        'MODALITE': session.modalite || 'Pr√©sentiel',
        'HORAIRES': `${session.heureDebut || '09:00'} - ${session.heureFin || '17:00'}`,
        'REFERENCE_SESSION': session.id ? `SES-${session.id}` : '',
        'NOM_ENTREPRISE': entreprise.nom || entreprise.raisonSociale || '',
        'ADRESSE_ENTREPRISE': entreprise.adresse || '',
        'SIRET_ENTREPRISE': entreprise.siret || '',
        'NOM_FORMATEUR': formateur.nom || '',
        'PRENOM_FORMATEUR': formateur.prenom || '',
        'NOM_COMPLET_FORMATEUR': `${formateur.prenom || ''} ${formateur.nom || ''}`.trim(),
        'DATE_JOUR': new Date().toLocaleDateString('fr-FR'),
        'ANNEE': String(new Date().getFullYear()),
        'NOM_ORGANISME': 'Formation DesClick',
        'ADRESSE_ORGANISME': '123 rue de la Formation, 75000 Paris',
        'SIRET_ORGANISME': '12345678900012',
        'NDA_ORGANISME': '11 75 12345 67'
      };
      
      // Charger le mod√®le DOCX avec JSZip
      const docxZip = await JSZip.loadAsync(bytes.buffer);
      
      // Lire et modifier le fichier document.xml principal
      const documentXml = await docxZip.file('word/document.xml').async('string');
      
      // Remplacer les balises dans le XML
      let modifiedXml = documentXml;
      for (const [key, value] of Object.entries(replacements)) {
        // Les balises peuvent √™tre fragment√©es dans le XML Word, on g√®re les cas simples
        const regex = new RegExp(`\\{${key}\\}`, 'g');
        modifiedXml = modifiedXml.replace(regex, escapeXml(value));
      }
      
      // Mettre √† jour le fichier dans le ZIP
      docxZip.file('word/document.xml', modifiedXml);
      
      // V√©rifier et modifier aussi les headers/footers si pr√©sents
      const files = Object.keys(docxZip.files);
      for (const filename of files) {
        if (filename.match(/word\/(header|footer)\d*\.xml/)) {
          let content = await docxZip.file(filename).async('string');
          for (const [key, value] of Object.entries(replacements)) {
            const regex = new RegExp(`\\{${key}\\}`, 'g');
            content = content.replace(regex, escapeXml(value));
          }
          docxZip.file(filename, content);
        }
      }
      
      // G√©n√©rer le document modifi√©
      const output = await docxZip.generateAsync({
        type: 'blob',
        mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      });
      
      // Nom du fichier
      const nomFichier = `${codeDoc}_${(stagiaire.nom || 'stagiaire').replace(/\s+/g, '_')}_${(stagiaire.prenom || '').replace(/\s+/g, '_')}.docx`;
      
      // Ajouter au ZIP final
      outputZip.file(nomFichier, output);
      
      docsGeneres.push({
        nom: nomFichier,
        blob: output,
        stagiaire: `${stagiaire.prenom || ''} ${stagiaire.nom || ''}`.trim()
      });
    }
    
    // Stocker les documents g√©n√©r√©s
    documentsGeneresParStagiaire[codeDoc] = docsGeneres;
    
    // Mettre √† jour l'affichage
    afficherResultatsGenerationStagiaires(codeDoc, docsGeneres, outputZip);
    
    toast(`‚úÖ ${docsGeneres.length} questionnaire(s) g√©n√©r√©(s) avec succ√®s !`, 'success');
    
  } catch (e) {
    console.error('Erreur g√©n√©ration DOCX:', e);
    
    // Proposer le fallback HTML
    if (confirm(`Erreur lors de la g√©n√©ration DOCX: ${e.message}\n\nVoulez-vous g√©n√©rer les documents en format HTML √† la place ?`)) {
      await genererDocsParStagiaireDefaut(codeDoc);
    } else {
      toast('‚ùå G√©n√©ration annul√©e', 'error');
    }
  }
}

// √âchapper les caract√®res sp√©ciaux pour XML
function escapeXml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;');
}

// ============ G√âN√âRATION DOCUMENTS FORMATEUR ============

// G√©n√©rer un document formateur personnalis√©
async function genererDocFormateur(codeDoc) {
  if (!conceptionPecSelectionnee) {
    toast('Aucune PEC s√©lectionn√©e', 'error');
    return;
  }
  
  const pec = conceptionPecSelectionnee;
  const formateur = pec.formateur;
  
  if (!formateur) {
    toast('Aucun formateur dans cette PEC', 'warning');
    return;
  }
  
  // Chercher le mod√®le upload√©
  const docs = await dbGetAll('ged_documents');
  const modele = docs.find(d => d.type === 'modele' && d.codeModele === codeDoc);
  
  if (!modele) {
    const choix = confirm(
      `Aucun mod√®le personnalis√© n'a √©t√© upload√© pour "${codeDoc}".\n\n` +
      `Voulez-vous :\n` +
      `‚Ä¢ OK : Utiliser le template par d√©faut\n` +
      `‚Ä¢ Annuler : Uploader d'abord un mod√®le Word (.docx) personnalis√©`
    );
    
    if (choix) {
      await genererDocConception(codeDoc, 'formateur');
    } else {
      uploadModeleGED(codeDoc);
    }
    return;
  }
  
  // V√©rifier le type de fichier
  const ext = modele.nom.split('.').pop().toLowerCase();
  
  if (ext === 'docx') {
    await genererDocFormateurDocx(codeDoc, modele);
  } else {
    toast('Format non support√©. Utilisez un fichier .docx', 'error');
  }
}

// G√©n√©rer document formateur √† partir d'un DOCX
async function genererDocFormateurDocx(codeDoc, modele) {
  const pec = conceptionPecSelectionnee;
  const formation = pec.formation || {};
  const session = pec.session || {};
  const entreprise = pec.entreprise || {};
  const formateur = pec.formateur || {};
  const stagiaires = pec.stagiaires || [];
  
  toast('üîÑ G√©n√©ration du document en cours...', 'info');
  
  try {
    // Convertir le base64 en ArrayBuffer
    const base64Data = modele.data.split(',')[1];
    const binaryString = atob(base64Data);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    
    // Pr√©parer les donn√©es de remplacement (balises avec accolades ET crochets)
    const dateDebut = fmtDate(session.dateDebutPrev || session.dateDebutEffective) || '___________';
    const dateFin = fmtDate(session.dateFinPrev || session.dateFinEffective) || '___________';
    const lieu = session.modalite === 'Intra' ? (session.lieuIntra || 'Sur site client') : 'Centre de formation';
    
    const replacements = {
      // Formateur - balises avec accolades
      'NOM_FORMATEUR': formateur.nom || '',
      'PRENOM_FORMATEUR': formateur.prenom || '',
      'NOM_COMPLET_FORMATEUR': `${formateur.prenom || ''} ${formateur.nom || ''}`.trim(),
      'EMAIL_FORMATEUR': formateur.email || '',
      'TELEPHONE_FORMATEUR': formateur.telephone || '',
      'ADRESSE_FORMATEUR': formateur.adresse || '',
      'SIRET_FORMATEUR': formateur.siret || '',
      'STATUT_FORMATEUR': formateur.type || 'Interne',
      
      // Formation
      'NOM_FORMATION': formation.nom || '',
      'INTITULE_FORMATION': formation.nom || '',
      'CODE_FORMATION': formation.code || '',
      'DUREE_FORMATION': String(formation.duree || ''),
      'OBJECTIFS_FORMATION': formation.objectifs || '',
      'PUBLIC_FORMATION': formation.public || '',
      
      // Session
      'DATE_DEBUT': dateDebut,
      'DATE_FIN': dateFin,
      'DATES_MISSION': `Du ${dateDebut} au ${dateFin}`,
      'LIEU': lieu,
      'LIEU_FORMATION': lieu,
      'MODALITE': session.modalite || 'Pr√©sentiel',
      'HORAIRES': `${session.heureDebut || '09:00'} - ${session.heureFin || '17:00'}`,
      'REFERENCE_SESSION': session.id ? `SES-${session.id}` : '',
      'NB_PARTICIPANTS': String(stagiaires.length || ''),
      'NOMBRE_PARTICIPANTS': String(stagiaires.length || ''),
      'DUREE_HEURES': String(formation.duree || ''),
      'DUREE_JOURS': String(Math.ceil((formation.duree || 7) / 7)),
      
      // Entreprise
      'NOM_ENTREPRISE': entreprise.nom || entreprise.raisonSociale || '',
      'ADRESSE_ENTREPRISE': entreprise.adresse || '',
      'SIRET_ENTREPRISE': entreprise.siret || '',
      
      // Dates
      'DATE_JOUR': new Date().toLocaleDateString('fr-FR'),
      'ANNEE': String(new Date().getFullYear()),
      
      // Organisme
      'NOM_ORGANISME': 'DC WEP APS',
      'ADRESSE_ORGANISME': 'Le Kremlin Bic√™tre',
      'SIRET_ORGANISME': '12345678900012',
      'NDA_ORGANISME': '11 75 12345 67'
    };
    
    // Ajouter aussi les variantes avec crochets (format [Nom du formateur])
    const replacementsBrackets = {
      'Nom du formateur': `${formateur.prenom || ''} ${formateur.nom || ''}`.trim(),
      'Nom et pr√©nom': `${formateur.prenom || ''} ${formateur.nom || ''}`.trim(),
      'nom du formateur': `${formateur.prenom || ''} ${formateur.nom || ''}`.trim(),
      'NOM DU FORMATEUR': `${formateur.prenom || ''} ${formateur.nom || ''}`.trim(),
      'Intitul√© de la formation': formation.nom || '',
      'intitul√© de la formation': formation.nom || '',
      'Lieu de formation': lieu,
      'lieu de formation': lieu,
      'Dates de mission': `Du ${dateDebut} au ${dateFin}`,
      'dates de mission': `Du ${dateDebut} au ${dateFin}`
    };
    
    // Charger le mod√®le DOCX avec JSZip
    const docxZip = await JSZip.loadAsync(bytes.buffer);
    
    // Lire et modifier le fichier document.xml principal
    let documentXml = await docxZip.file('word/document.xml').async('string');
    
    // Remplacer les balises avec accolades {BALISE}
    for (const [key, value] of Object.entries(replacements)) {
      const regex = new RegExp(`\\{${key}\\}`, 'gi');
      documentXml = documentXml.replace(regex, escapeXml(value));
    }
    
    // Remplacer les balises avec crochets [Texte]
    for (const [key, value] of Object.entries(replacementsBrackets)) {
      const regex = new RegExp(`\\[${key}\\]`, 'gi');
      documentXml = documentXml.replace(regex, escapeXml(value));
    }
    
    // Remplacer aussi les "‚Ä¶‚Ä¶‚Ä¶‚Ä¶" par les valeurs appropri√©es si le contexte le permet
    documentXml = documentXml.replace(/Du ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶* au ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶*/g, `Du ${dateDebut} au ${dateFin}`);
    documentXml = documentXml.replace(/‚Ä¶‚Ä¶‚Ä¶‚Ä¶ heures/g, `${formation.duree || '___'} heures`);
    documentXml = documentXml.replace(/‚Ä¶‚Ä¶‚Ä¶‚Ä¶ jours/g, `${Math.ceil((formation.duree || 7) / 7)} jours`);
    documentXml = documentXml.replace(/Nombre de participants : ‚Ä¶‚Ä¶‚Ä¶‚Ä¶/g, `Nombre de participants : ${stagiaires.length || '___'}`);
    
    // Mettre √† jour le fichier dans le ZIP
    docxZip.file('word/document.xml', documentXml);
    
    // Modifier aussi les headers/footers si pr√©sents
    const files = Object.keys(docxZip.files);
    for (const filename of files) {
      if (filename.match(/word\/(header|footer)\d*\.xml/)) {
        let content = await docxZip.file(filename).async('string');
        for (const [key, value] of Object.entries(replacements)) {
          const regex = new RegExp(`\\{${key}\\}`, 'gi');
          content = content.replace(regex, escapeXml(value));
        }
        for (const [key, value] of Object.entries(replacementsBrackets)) {
          const regex = new RegExp(`\\[${key}\\]`, 'gi');
          content = content.replace(regex, escapeXml(value));
        }
        docxZip.file(filename, content);
      }
    }
    
    // G√©n√©rer le document modifi√©
    const output = await docxZip.generateAsync({
      type: 'blob',
      mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    });
    
    // Nom du fichier
    const nomFichier = `${codeDoc}_${(formateur.nom || 'formateur').replace(/\s+/g, '_')}_${(formateur.prenom || '').replace(/\s+/g, '_')}_${formation.nom ? formation.nom.substring(0, 20).replace(/\s+/g, '_') : ''}.docx`;
    
    // Stocker le document
    documentsGeneres[codeDoc] = {
      blob: output,
      filename: nomFichier,
      formation: formation.nom || '',
      type: 'formateur',
      genereLe: new Date().toISOString()
    };
    
    // Mettre √† jour l'affichage
    const btnsContainer = document.getElementById('btns-' + codeDoc);
    if (btnsContainer) {
      btnsContainer.innerHTML = `
        <span style="color:#10b981;font-weight:600;margin-right:5px">‚úì G√©n√©r√©</span>
        <button class="btn btn-sm btn-success" onclick="telechargerDocFormateur('${codeDoc}')" title="T√©l√©charger">‚¨áÔ∏è T√©l√©charger</button>
        <button class="btn btn-sm btn-info" onclick="visualiserDocFormateur('${codeDoc}')" title="Visualiser">üëÅÔ∏è Voir</button>
        <button class="btn btn-sm btn-secondary" onclick="genererDocFormateur('${codeDoc}')" title="R√©g√©n√©rer">üîÑ</button>
      `;
    }
    
    // Mettre en √©vidence
    const docItem = document.getElementById('doc-item-' + codeDoc);
    if (docItem) {
      docItem.style.borderColor = '#10b981';
      docItem.style.background = '#f0fdf4';
    }
    
    toast(`‚úÖ Document "${codeDoc}" g√©n√©r√© avec succ√®s !`, 'success');
    
  } catch (e) {
    console.error('Erreur g√©n√©ration DOCX formateur:', e);
    toast('‚ùå Erreur lors de la g√©n√©ration: ' + e.message, 'error');
  }
}

// T√©l√©charger un document formateur g√©n√©r√©
function telechargerDocFormateur(codeDoc) {
  const doc = documentsGeneres[codeDoc];
  if (!doc || !doc.blob) {
    toast('Document non trouv√©', 'warning');
    return;
  }
  
  const url = URL.createObjectURL(doc.blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = doc.filename;
  a.click();
  URL.revokeObjectURL(url);
}

// Visualiser un document formateur (pr√©visualisation limit√©e pour DOCX)
function visualiserDocFormateur(codeDoc) {
  const doc = documentsGeneres[codeDoc];
  if (!doc) {
    toast('Document non trouv√©', 'warning');
    return;
  }
  
  // Pour les DOCX, on ne peut pas vraiment pr√©visualiser, donc on t√©l√©charge
  const modalHtml = `
    <div id="modal-preview-formateur" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:500px">
        <div class="modal-header" style="background:linear-gradient(135deg,#2563eb,#1d4ed8)">
          <h3 class="modal-title">üìÑ Document Formateur G√©n√©r√©</h3>
          <button class="modal-close" onclick="document.getElementById('modal-preview-formateur').remove()">‚úï</button>
        </div>
        <div class="modal-body" style="text-align:center;padding:30px">
          <div style="font-size:4em;margin-bottom:20px">üìÑ</div>
          <h4>${esc(doc.filename)}</h4>
          <p style="color:#6b7280;margin:15px 0">Document Word g√©n√©r√© avec succ√®s.</p>
          <p style="font-size:0.9em;color:#9ca3af">Les fichiers DOCX ne peuvent pas √™tre pr√©visualis√©s dans le navigateur.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" onclick="telechargerDocFormateur('${codeDoc}');document.getElementById('modal-preview-formateur').remove()">‚¨áÔ∏è T√©l√©charger</button>
          <button class="btn btn-secondary" onclick="document.getElementById('modal-preview-formateur').remove()">Fermer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Variable pour stocker les documents g√©n√©r√©s par stagiaire
let documentsGeneresParStagiaire = {};

// Afficher les r√©sultats de la g√©n√©ration
function afficherResultatsGenerationStagiaires(codeDoc, docsGeneres, zip) {
  const btnsContainer = document.getElementById('btns-' + codeDoc);
  if (!btnsContainer) return;
  
  btnsContainer.innerHTML = `
    <span style="color:#10b981;font-weight:600;margin-right:5px">‚úì ${docsGeneres.length} doc(s)</span>
    <button class="btn btn-sm btn-success" onclick="telechargerZipStagiaires('${codeDoc}')" title="T√©l√©charger tous les documents">üì¶ ZIP</button>
    <button class="btn btn-sm btn-info" onclick="voirListeDocsStagiaires('${codeDoc}')" title="Voir la liste">üëÅÔ∏è Liste</button>
    <button class="btn btn-sm btn-secondary" onclick="genererDocsParStagiaire('${codeDoc}')" title="R√©g√©n√©rer">üîÑ</button>
  `;
  
  // Stocker le ZIP
  if (!window.zipsGeneres) window.zipsGeneres = {};
  zip.generateAsync({ type: 'blob' }).then(blob => {
    window.zipsGeneres[codeDoc] = blob;
  });
  
  // Mettre en √©vidence
  const docItem = document.getElementById('doc-item-' + codeDoc);
  if (docItem) {
    docItem.style.borderColor = '#10b981';
    docItem.style.background = '#f0fdf4';
  }
}

// T√©l√©charger le ZIP des documents
async function telechargerZipStagiaires(codeDoc) {
  if (!window.zipsGeneres || !window.zipsGeneres[codeDoc]) {
    toast('Aucun document √† t√©l√©charger', 'warning');
    return;
  }
  
  const formation = conceptionPecSelectionnee?.formation?.nom || 'Formation';
  const sessionId = conceptionPecSelectionnee?.session?.id || '';
  const nomZip = `${codeDoc}_${formation.replace(/\s+/g, '_')}_SES${sessionId}.zip`;
  
  const url = URL.createObjectURL(window.zipsGeneres[codeDoc]);
  const a = document.createElement('a');
  a.href = url;
  a.download = nomZip;
  a.click();
  URL.revokeObjectURL(url);
}

// Voir la liste des documents g√©n√©r√©s
function voirListeDocsStagiaires(codeDoc) {
  const docs = documentsGeneresParStagiaire[codeDoc];
  if (!docs || docs.length === 0) {
    toast('Aucun document g√©n√©r√©', 'warning');
    return;
  }
  
  const formation = conceptionPecSelectionnee?.formation?.nom || 'Formation';
  
  const modalHtml = `
    <div id="modal-liste-docs" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:700px;max-height:80vh">
        <div class="modal-header" style="background:linear-gradient(135deg,#10b981,#059669)">
          <h3 class="modal-title">üìÑ Documents g√©n√©r√©s - ${esc(formation)}</h3>
          <button class="modal-close" onclick="document.getElementById('modal-liste-docs').remove()">‚úï</button>
        </div>
        <div class="modal-body" style="max-height:60vh;overflow-y:auto">
          <div class="info-box" style="margin-bottom:15px">
            <strong>${docs.length}</strong> document(s) g√©n√©r√©(s) √† partir du mod√®le personnalis√©
          </div>
          
          <div style="display:flex;flex-direction:column;gap:10px">
            ${docs.map((d, i) => `
              <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:#f8fafc;border-radius:8px;border-left:3px solid #10b981">
                <div>
                  <div style="font-weight:500">üë§ ${esc(d.stagiaire)}</div>
                  <div style="font-size:0.85em;color:#6b7280">${esc(d.nom)}</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="telechargerDocStagiaire('${codeDoc}', ${i})">‚¨áÔ∏è T√©l√©charger</button>
              </div>
            `).join('')}
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" onclick="telechargerZipStagiaires('${codeDoc}');document.getElementById('modal-liste-docs').remove()">üì¶ T√©l√©charger tout (ZIP)</button>
          <button class="btn btn-secondary" onclick="document.getElementById('modal-liste-docs').remove()">Fermer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// T√©l√©charger un document individuel
function telechargerDocStagiaire(codeDoc, index) {
  const docs = documentsGeneresParStagiaire[codeDoc];
  if (!docs || !docs[index]) return;
  
  const doc = docs[index];
  const url = URL.createObjectURL(doc.blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = doc.nom;
  a.click();
  URL.revokeObjectURL(url);
}

// G√©n√©rer avec le template par d√©faut pour chaque stagiaire
async function genererDocsParStagiaireDefaut(codeDoc) {
  if (!conceptionPecSelectionnee) return;
  
  const pec = conceptionPecSelectionnee;
  const stagiaires = pec.stagiaires || [];
  const formation = pec.formation || {};
  const session = pec.session || {};
  const entreprise = pec.entreprise || {};
  const formateur = pec.formateur || {};
  
  const dateDebut = fmtDate(session.dateDebutPrev || session.dateDebutEffective) || '√Ä d√©finir';
  const dateFin = fmtDate(session.dateFinPrev || session.dateFinEffective) || '√Ä d√©finir';
  const lieu = session.modalite === 'Intra' ? (session.lieuIntra || 'Sur site client') : 'Centre de formation';
  
  const zip = new JSZip();
  const docsGeneres = [];
  
  for (const stagiaire of stagiaires) {
    // G√©n√©rer le HTML personnalis√© pour ce stagiaire
    const htmlContent = genererTemplateQuestionnaireStagiaire(codeDoc, {
      stagiaire: stagiaire,
      formation: formation,
      session: session,
      entreprise: entreprise,
      formateur: formateur,
      dateDebut: dateDebut,
      dateFin: dateFin,
      lieu: lieu
    });
    
    const nomFichier = `${codeDoc}_${(stagiaire.nom || 'stagiaire').replace(/\s+/g, '_')}_${(stagiaire.prenom || '').replace(/\s+/g, '_')}.html`;
    
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    zip.file(nomFichier, blob);
    
    docsGeneres.push({
      nom: nomFichier,
      blob: blob,
      stagiaire: `${stagiaire.prenom || ''} ${stagiaire.nom || ''}`.trim(),
      htmlContent: htmlContent
    });
  }
  
  documentsGeneresParStagiaire[codeDoc] = docsGeneres;
  afficherResultatsGenerationStagiaires(codeDoc, docsGeneres, zip);
  
  toast(`‚úÖ ${docsGeneres.length} questionnaire(s) g√©n√©r√©(s) !`, 'success');
}

// Template HTML pour questionnaire de satisfaction par stagiaire
function genererTemplateQuestionnaireStagiaire(codeDoc, data) {
  const { stagiaire, formation, session, entreprise, formateur, dateDebut, dateFin, lieu } = data;
  const nomComplet = `${stagiaire.prenom || ''} ${stagiaire.nom || ''}`.trim();
  const dateJour = new Date().toLocaleDateString('fr-FR');
  
  const styleCSS = `
    <style>
      @media print { body { margin: 0; } @page { size: A4; margin: 15mm; } }
      body { font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.4; color: #333; max-width: 210mm; margin: 0 auto; padding: 20px; }
      .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2563eb; padding-bottom: 15px; margin-bottom: 20px; }
      .logo { font-size: 1.4em; font-weight: bold; color: #2563eb; }
      .doc-title { text-align: center; font-size: 1.3em; font-weight: bold; color: #1e40af; margin: 20px 0; padding: 10px; background: #dbeafe; border-radius: 8px; }
      .section { margin: 15px 0; padding: 12px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #2563eb; }
      .info-grid { display: grid; grid-template-columns: 150px 1fr; gap: 8px; }
      .info-label { font-weight: bold; color: #4b5563; }
      .stagiaire-info { background: #dcfce7; border-left-color: #22c55e; }
      table { width: 100%; border-collapse: collapse; margin: 15px 0; }
      th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: center; }
      th { background: #f1f5f9; font-weight: bold; }
      .checkbox { width: 20px; height: 20px; display: inline-block; border: 2px solid #9ca3af; border-radius: 3px; }
      .signature-zone { display: flex; justify-content: space-between; margin-top: 30px; }
      .signature-box { width: 45%; text-align: center; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; }
      .signature-line { border-top: 1px solid #333; margin-top: 50px; }
      .footer { margin-top: 30px; text-align: center; font-size: 0.85em; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 15px; }
      .critere-row td:first-child { text-align: left; font-weight: 500; }
    </style>
  `;
  
  if (codeDoc === 'questionnaire_satisfaction_stagiaire') {
    return `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Questionnaire de Satisfaction - ${esc(nomComplet)}</title>
  ${styleCSS}
</head>
<body>
  <div class="header">
    <div class="logo">üéì Formation DesClick</div>
    <div style="text-align:right;font-size:0.9em">
      <div>Date : ${dateJour}</div>
      <div>R√©f : QS-${session.id || 'XXX'}</div>
    </div>
  </div>
  
  <h1 class="doc-title">‚≠ê QUESTIONNAIRE DE SATISFACTION √Ä CHAUD</h1>
  
  <div class="section stagiaire-info">
    <div class="info-grid">
      <span class="info-label">üë§ Stagiaire :</span><span><strong>${esc(nomComplet)}</strong></span>
      <span class="info-label">üè¢ Entreprise :</span><span>${esc(entreprise.nom || entreprise.raisonSociale || '')}</span>
      <span class="info-label">üíº Fonction :</span><span>${esc(stagiaire.fonction || '________________')}</span>
    </div>
  </div>
  
  <div class="section">
    <div class="info-grid">
      <span class="info-label">üìö Formation :</span><span><strong>${esc(formation.nom || '')}</strong></span>
      <span class="info-label">üìÖ Dates :</span><span>${dateDebut} au ${dateFin}</span>
      <span class="info-label">üìç Lieu :</span><span>${esc(lieu)}</span>
      <span class="info-label">üë®‚Äçüè´ Formateur :</span><span>${esc(formateur.prenom || '')} ${esc(formateur.nom || '')}</span>
    </div>
  </div>
  
  <p style="margin:20px 0;font-style:italic;color:#6b7280">
    Merci de bien vouloir √©valuer chaque crit√®re en cochant la case correspondante :<br>
    1 = Tr√®s insatisfait | 2 = Insatisfait | 3 = Moyennement satisfait | 4 = Satisfait | 5 = Tr√®s satisfait
  </p>
  
  <table>
    <thead>
      <tr>
        <th style="width:50%;text-align:left">Crit√®res d'√©valuation</th>
        <th>1</th>
        <th>2</th>
        <th>3</th>
        <th>4</th>
        <th>5</th>
      </tr>
    </thead>
    <tbody>
      <tr class="critere-row"><td>1. Information obtenue avant le d√©but de la formation</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
      <tr class="critere-row"><td>2. Dur√©e et rythme de la formation par rapport au contenu</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
      <tr class="critere-row"><td>3. Horaires de la formation</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
      <tr class="critere-row"><td>4. Lieu et locaux o√π s'est d√©roul√©e la formation</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
      <tr class="critere-row"><td>5. Contenu du programme et m√©thodes p√©dagogiques</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
      <tr class="critere-row"><td>6. Supports et mat√©riels p√©dagogiques</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
      <tr class="critere-row" style="background:#fef3c7"><td><strong>7. Appr√©ciation globale de la formation</strong></td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
      <tr class="critere-row" style="background:#dbeafe"><td><strong>8. Recommanderiez-vous cette formation ?</strong></td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
    </tbody>
  </table>
  
  <div style="margin:20px 0">
    <p><strong>üí¨ Commentaires et suggestions d'am√©lioration :</strong></p>
    <div style="border:1px solid #e5e7eb;min-height:100px;border-radius:8px;margin-top:10px;padding:10px"></div>
  </div>
  
  <div style="margin:20px 0">
    <p><strong>‚ú® Ce que vous avez le plus appr√©ci√© :</strong></p>
    <div style="border:1px solid #e5e7eb;min-height:60px;border-radius:8px;margin-top:10px;padding:10px"></div>
  </div>
  
  <div style="margin:20px 0">
    <p><strong>üîß Ce qui pourrait √™tre am√©lior√© :</strong></p>
    <div style="border:1px solid #e5e7eb;min-height:60px;border-radius:8px;margin-top:10px;padding:10px"></div>
  </div>
  
  <div class="signature-zone">
    <div class="signature-box">
      <p>Date : _______________</p>
      <div class="signature-line"></div>
      <p style="margin-top:5px">Signature du stagiaire</p>
    </div>
  </div>
  
  <div class="footer">
    <p>Formation DesClick - Organisme certifi√© Qualiopi</p>
    <p>Ce questionnaire est confidentiel et sera utilis√© uniquement pour am√©liorer nos formations.</p>
  </div>
</body>
</html>`;
  }
  
  // Template par d√©faut pour les autres documents
  return genererTemplateDocument(codeDoc, {
    entreprise,
    formation,
    formateur,
    session,
    stagiaires: [stagiaire],
    pec: conceptionPecSelectionnee,
    dateJour,
    dateDebut,
    dateFin,
    lieu
  });
}

// Afficher l'aide sur les balises disponibles pour les mod√®les
function afficherAideBalisesModele() {
  const modalHtml = `
    <div id="modal-aide-balises" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:800px;max-height:90vh">
        <div class="modal-header" style="background:linear-gradient(135deg,#10b981,#059669)">
          <h3 class="modal-title">üìã Balises disponibles pour les mod√®les Word</h3>
          <button class="modal-close" onclick="document.getElementById('modal-aide-balises').remove()">‚úï</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow-y:auto">
          <div class="info-box" style="margin-bottom:20px;border-left:4px solid #10b981">
            <strong>üí° Comment utiliser :</strong><br>
            Dans votre document Word (.docx), ins√©rez les balises entre accolades. 
            Le syst√®me les remplacera automatiquement par les valeurs correspondantes lors de la g√©n√©ration.
          </div>
          
          <h4 style="color:#059669;margin:15px 0 10px">üë§ Informations Stagiaire</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#f0fdf4;padding:5px;border-radius:4px">{NOM_STAGIAIRE}</code><span>Nom du stagiaire</span>
            <code style="background:#f0fdf4;padding:5px;border-radius:4px">{PRENOM_STAGIAIRE}</code><span>Pr√©nom du stagiaire</span>
            <code style="background:#f0fdf4;padding:5px;border-radius:4px">{NOM_COMPLET_STAGIAIRE}</code><span>Pr√©nom et nom complets</span>
            <code style="background:#f0fdf4;padding:5px;border-radius:4px">{EMAIL_STAGIAIRE}</code><span>Email du stagiaire</span>
            <code style="background:#f0fdf4;padding:5px;border-radius:4px">{TELEPHONE_STAGIAIRE}</code><span>T√©l√©phone du stagiaire</span>
            <code style="background:#f0fdf4;padding:5px;border-radius:4px">{FONCTION_STAGIAIRE}</code><span>Fonction/Poste du stagiaire</span>
          </div>
          
          <h4 style="color:#2563eb;margin:20px 0 10px">üìö Informations Formation</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#dbeafe;padding:5px;border-radius:4px">{NOM_FORMATION}</code><span>Intitul√© de la formation</span>
            <code style="background:#dbeafe;padding:5px;border-radius:4px">{CODE_FORMATION}</code><span>Code/R√©f√©rence de la formation</span>
            <code style="background:#dbeafe;padding:5px;border-radius:4px">{DUREE_FORMATION}</code><span>Dur√©e en heures</span>
            <code style="background:#dbeafe;padding:5px;border-radius:4px">{OBJECTIFS_FORMATION}</code><span>Objectifs p√©dagogiques</span>
            <code style="background:#dbeafe;padding:5px;border-radius:4px">{PUBLIC_FORMATION}</code><span>Public vis√©</span>
          </div>
          
          <h4 style="color:#f59e0b;margin:20px 0 10px">üìÖ Informations Session</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#fef3c7;padding:5px;border-radius:4px">{DATE_DEBUT}</code><span>Date de d√©but de la session</span>
            <code style="background:#fef3c7;padding:5px;border-radius:4px">{DATE_FIN}</code><span>Date de fin de la session</span>
            <code style="background:#fef3c7;padding:5px;border-radius:4px">{LIEU}</code><span>Lieu de la formation</span>
            <code style="background:#fef3c7;padding:5px;border-radius:4px">{MODALITE}</code><span>Modalit√© (Pr√©sentiel, Distanciel...)</span>
            <code style="background:#fef3c7;padding:5px;border-radius:4px">{HORAIRES}</code><span>Horaires (ex: 09:00 - 17:00)</span>
            <code style="background:#fef3c7;padding:5px;border-radius:4px">{REFERENCE_SESSION}</code><span>R√©f√©rence de la session (SES-XXX)</span>
          </div>
          
          <h4 style="color:#8b5cf6;margin:20px 0 10px">üè¢ Informations Entreprise</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{NOM_ENTREPRISE}</code><span>Raison sociale de l'entreprise</span>
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{ADRESSE_ENTREPRISE}</code><span>Adresse de l'entreprise</span>
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{SIRET_ENTREPRISE}</code><span>Num√©ro SIRET</span>
          </div>
          
          <h4 style="color:#ec4899;margin:20px 0 10px">üë®‚Äçüè´ Informations Formateur</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#fce7f3;padding:5px;border-radius:4px">{NOM_FORMATEUR}</code><span>Nom du formateur</span>
            <code style="background:#fce7f3;padding:5px;border-radius:4px">{PRENOM_FORMATEUR}</code><span>Pr√©nom du formateur</span>
            <code style="background:#fce7f3;padding:5px;border-radius:4px">{NOM_COMPLET_FORMATEUR}</code><span>Nom complet du formateur</span>
          </div>
          
          <h4 style="color:#6b7280;margin:20px 0 10px">üìÜ Dates & Organisme</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#f1f5f9;padding:5px;border-radius:4px">{DATE_JOUR}</code><span>Date du jour (g√©n√©ration)</span>
            <code style="background:#f1f5f9;padding:5px;border-radius:4px">{ANNEE}</code><span>Ann√©e en cours</span>
            <code style="background:#f1f5f9;padding:5px;border-radius:4px">{NOM_ORGANISME}</code><span>Nom de l'organisme de formation</span>
            <code style="background:#f1f5f9;padding:5px;border-radius:4px">{ADRESSE_ORGANISME}</code><span>Adresse de l'organisme</span>
            <code style="background:#f1f5f9;padding:5px;border-radius:4px">{SIRET_ORGANISME}</code><span>SIRET de l'organisme</span>
            <code style="background:#f1f5f9;padding:5px;border-radius:4px">{NDA_ORGANISME}</code><span>N¬∞ D√©claration d'Activit√©</span>
          </div>
          
          <div style="margin-top:25px;padding:15px;background:#fef3c7;border-radius:8px">
            <strong>‚ö†Ô∏è Important - Conseils pour que les balises fonctionnent :</strong>
            <ul style="margin:10px 0 0 20px;line-height:1.8">
              <li>Tapez chaque balise <strong>d'un seul coup</strong>, sans interruption (ne pas copier-coller caract√®re par caract√®re)</li>
              <li>Respectez <strong>exactement</strong> la syntaxe : majuscules, underscores, accolades (ex: <code>{NOM_STAGIAIRE}</code>)</li>
              <li>Utilisez un fichier <strong>.docx</strong> (Word 2007 ou plus r√©cent)</li>
              <li>Si vous voulez formater une balise (gras, couleur), <strong>tapez-la d'abord enti√®rement</strong> puis s√©lectionnez-la pour appliquer le formatage</li>
              <li>√âvitez d'√©diter une balise apr√®s l'avoir tap√©e (si vous devez la modifier, supprimez-la et retapez-la)</li>
              <li>Si une balise n'est pas remplac√©e, v√©rifiez qu'elle n'a pas √©t√© "fragment√©e" par Word</li>
            </ul>
          </div>
          
          <div style="margin-top:15px;padding:15px;background:#dbeafe;border-radius:8px">
            <strong>üí° Astuce :</strong> Si les balises ne fonctionnent pas dans votre mod√®le Word, 
            utilisez le bouton "üìù D√©faut" qui g√©n√®re des questionnaires HTML professionnels pr√™ts √† imprimer.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="telechargerModeleExemple('questionnaire_satisfaction_stagiaire')">üì• T√©l√©charger mod√®le exemple</button>
          <button class="btn btn-secondary" onclick="document.getElementById('modal-aide-balises').remove()">Fermer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Afficher l'aide sur les balises pour les documents formateur
function afficherAideBalisesFormateur() {
  const modalHtml = `
    <div id="modal-aide-balises-formateur" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:800px;max-height:90vh">
        <div class="modal-header" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">
          <h3 class="modal-title">üìã Balises pour les mod√®les Formateur</h3>
          <button class="modal-close" onclick="document.getElementById('modal-aide-balises-formateur').remove()">‚úï</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow-y:auto">
          <div class="info-box" style="margin-bottom:20px;border-left:4px solid #8b5cf6">
            <strong>üí° Deux formats support√©s :</strong><br>
            ‚Ä¢ Accolades : <code>{NOM_FORMATEUR}</code><br>
            ‚Ä¢ Crochets : <code>[Nom du formateur]</code>
          </div>
          
          <h4 style="color:#8b5cf6;margin:15px 0 10px">üë®‚Äçüè´ Informations Formateur</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{NOM_FORMATEUR}</code><span>Nom du formateur</span>
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{PRENOM_FORMATEUR}</code><span>Pr√©nom du formateur</span>
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{NOM_COMPLET_FORMATEUR}</code><span>Pr√©nom + Nom</span>
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{EMAIL_FORMATEUR}</code><span>Email du formateur</span>
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{TELEPHONE_FORMATEUR}</code><span>T√©l√©phone</span>
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{ADRESSE_FORMATEUR}</code><span>Adresse</span>
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{SIRET_FORMATEUR}</code><span>SIRET du formateur</span>
            <code style="background:#f3e8ff;padding:5px;border-radius:4px">{STATUT_FORMATEUR}</code><span>Interne/Externe</span>
          </div>
          
          <h4 style="color:#f59e0b;margin:20px 0 10px">üîñ Format Crochets (compatible votre mod√®le)</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#fef3c7;padding:5px;border-radius:4px">[Nom du formateur]</code><span>Pr√©nom + Nom du formateur</span>
            <code style="background:#fef3c7;padding:5px;border-radius:4px">[Nom et pr√©nom]</code><span>Pr√©nom + Nom</span>
            <code style="background:#fef3c7;padding:5px;border-radius:4px">[Intitul√© de la formation]</code><span>Nom de la formation</span>
            <code style="background:#fef3c7;padding:5px;border-radius:4px">[Lieu de formation]</code><span>Lieu</span>
            <code style="background:#fef3c7;padding:5px;border-radius:4px">[Dates de mission]</code><span>Du ... au ...</span>
          </div>
          
          <h4 style="color:#2563eb;margin:20px 0 10px">üìö Informations Formation</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#dbeafe;padding:5px;border-radius:4px">{NOM_FORMATION}</code><span>Intitul√© de la formation</span>
            <code style="background:#dbeafe;padding:5px;border-radius:4px">{CODE_FORMATION}</code><span>Code formation</span>
            <code style="background:#dbeafe;padding:5px;border-radius:4px">{DUREE_FORMATION}</code><span>Dur√©e en heures</span>
            <code style="background:#dbeafe;padding:5px;border-radius:4px">{DUREE_HEURES}</code><span>Dur√©e en heures</span>
            <code style="background:#dbeafe;padding:5px;border-radius:4px">{DUREE_JOURS}</code><span>Dur√©e en jours</span>
          </div>
          
          <h4 style="color:#10b981;margin:20px 0 10px">üìÖ Informations Session/Mission</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#dcfce7;padding:5px;border-radius:4px">{DATE_DEBUT}</code><span>Date de d√©but</span>
            <code style="background:#dcfce7;padding:5px;border-radius:4px">{DATE_FIN}</code><span>Date de fin</span>
            <code style="background:#dcfce7;padding:5px;border-radius:4px">{DATES_MISSION}</code><span>Du ... au ...</span>
            <code style="background:#dcfce7;padding:5px;border-radius:4px">{LIEU}</code><span>Lieu de la formation</span>
            <code style="background:#dcfce7;padding:5px;border-radius:4px">{LIEU_FORMATION}</code><span>Lieu</span>
            <code style="background:#dcfce7;padding:5px;border-radius:4px">{NB_PARTICIPANTS}</code><span>Nombre de stagiaires</span>
            <code style="background:#dcfce7;padding:5px;border-radius:4px">{HORAIRES}</code><span>Horaires</span>
          </div>
          
          <h4 style="color:#6b7280;margin:20px 0 10px">üè¢ Entreprise & Organisme</h4>
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:5px;font-size:0.9em">
            <code style="background:#f1f5f9;padding:5px;border-radius:4px">{NOM_ENTREPRISE}</code><span>Entreprise cliente</span>
            <code style="background:#f1f5f9;padding:5px;border-radius:4px">{DATE_JOUR}</code><span>Date du jour</span>
            <code style="background:#f1f5f9;padding:5px;border-radius:4px">{NOM_ORGANISME}</code><span>Nom de l'organisme</span>
          </div>
          
          <div style="margin-top:25px;padding:15px;background:#dcfce7;border-radius:8px">
            <strong>‚úÖ Votre mod√®le "Ordre de Mission" :</strong><br>
            Le syst√®me remplace automatiquement les placeholders comme <code>[Nom du formateur]</code> 
            et les <code>‚Ä¶‚Ä¶‚Ä¶‚Ä¶</code> par les valeurs r√©elles de la PEC s√©lectionn√©e.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('modal-aide-balises-formateur').remove()">Fermer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// T√©l√©charger un mod√®le exemple au format HTML (√† convertir en DOCX)
function telechargerModeleExemple(codeDoc) {
  let contenu = '';
  let nomFichier = '';
  
  if (codeDoc === 'questionnaire_satisfaction_stagiaire') {
    nomFichier = 'MODELE_Questionnaire_Satisfaction_Stagiaire.html';
    contenu = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mod√®le Questionnaire Satisfaction</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 30px; }
    h1 { color: #2563eb; text-align: center; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
    .section { margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px; }
    .info { margin: 10px 0; }
    .info strong { display: inline-block; width: 150px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background: #f1f5f9; }
    td:first-child { text-align: left; }
    .signature { margin-top: 50px; border-top: 1px solid #333; width: 200px; text-align: center; padding-top: 10px; }
    .balise { background: #fef3c7; padding: 2px 5px; border-radius: 3px; font-family: monospace; }
  </style>
</head>
<body>
  <h1>‚≠ê QUESTIONNAIRE DE SATISFACTION √Ä CHAUD</h1>
  
  <div class="section">
    <h3>Informations Stagiaire</h3>
    <div class="info"><strong>Nom :</strong> <span class="balise">{NOM_STAGIAIRE}</span></div>
    <div class="info"><strong>Pr√©nom :</strong> <span class="balise">{PRENOM_STAGIAIRE}</span></div>
    <div class="info"><strong>Entreprise :</strong> <span class="balise">{NOM_ENTREPRISE}</span></div>
    <div class="info"><strong>Fonction :</strong> <span class="balise">{FONCTION_STAGIAIRE}</span></div>
  </div>
  
  <div class="section">
    <h3>Informations Formation</h3>
    <div class="info"><strong>Formation :</strong> <span class="balise">{NOM_FORMATION}</span></div>
    <div class="info"><strong>Dates :</strong> Du <span class="balise">{DATE_DEBUT}</span> au <span class="balise">{DATE_FIN}</span></div>
    <div class="info"><strong>Lieu :</strong> <span class="balise">{LIEU}</span></div>
    <div class="info"><strong>Formateur :</strong> <span class="balise">{NOM_COMPLET_FORMATEUR}</span></div>
  </div>
  
  <p><em>Merci d'√©valuer chaque crit√®re de 1 (Tr√®s insatisfait) √† 5 (Tr√®s satisfait)</em></p>
  
  <table>
    <tr>
      <th style="width:50%">Crit√®res</th>
      <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
    </tr>
    <tr><td>1. Information obtenue avant le d√©but de la formation</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
    <tr><td>2. Dur√©e et rythme de la formation</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
    <tr><td>3. Horaires de la formation</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
    <tr><td>4. Lieu et locaux</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
    <tr><td>5. Contenu du programme et m√©thodes p√©dagogiques</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
    <tr><td>6. Supports et mat√©riels p√©dagogiques</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
    <tr><td>7. Appr√©ciation globale de la formation</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
    <tr><td>8. Recommanderiez-vous cette formation ?</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td><td>‚òê</td></tr>
  </table>
  
  <div class="section">
    <h3>üí¨ Commentaires et suggestions</h3>
    <div style="border:1px solid #ddd;min-height:100px;margin-top:10px;border-radius:8px"></div>
  </div>
  
  <div style="margin-top:30px">
    <p><strong>Date :</strong> <span class="balise">{DATE_JOUR}</span></p>
    <div class="signature">Signature du stagiaire</div>
  </div>
  
  <hr style="margin-top:50px">
  <p style="font-size:0.9em;color:#666">
    <strong>Instructions :</strong> Ouvrez ce fichier dans Word, personnalisez-le selon vos besoins, 
    puis enregistrez-le au format .docx. Les balises en jaune seront automatiquement remplac√©es 
    par les informations r√©elles lors de la g√©n√©ration.
  </p>
</body>
</html>`;
  }
  
  if (!contenu) {
    toast('Mod√®le exemple non disponible pour ce type de document', 'warning');
    return;
  }
  
  // T√©l√©charger le fichier
  const blob = new Blob([contenu], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = nomFichier;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('üì• Mod√®le t√©l√©charg√© ! Ouvrez-le dans Word, personnalisez-le et enregistrez en .docx', 'info');
}

async function loadGEDFormations(){
  // Charger les documents de formation g√©n√©raux
  const docs=await dbGetAll('ged_documents');
  const categories=['cgv','programmes','livrets','supports','positionnement','tests-inter','tests-finaux','ecarts'];
  categories.forEach(cat=>{
    const catDocs=docs.filter(d=>d.categorie===cat);
    const el=document.getElementById('ged-'+cat);
    if(el){
      el.innerHTML=catDocs.length===0?'<div style="color:#94a3b8;font-size:0.85em">Aucun document</div>':
        catDocs.map(d=>`
          <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f8fafc;border-radius:6px;margin-bottom:5px">
            <span>üìÑ</span>
            <span style="flex:1;font-size:0.85em">${esc(d.nom)}</span>
            <button class="btn btn-icon btn-sm" onclick="viewGEDDoc(${d.id})" title="Voir">üëÅÔ∏è</button>
            <button class="btn btn-icon btn-sm btn-danger" onclick="deleteGEDDoc(${d.id})" title="Supprimer">üóëÔ∏è</button>
          </div>
        `).join('');
    }
  });
}

async function uploadDocGED(categorie){
  const input=document.createElement('input');
  input.type='file';
  input.accept='.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.jpg,.jpeg,.png';
  input.onchange=async function(){
    if(this.files.length>0){
      const file=this.files[0];
      const reader=new FileReader();
      reader.onload=async function(e){
        const doc={
          categorie:categorie,
          nom:file.name,
          type:file.type,
          taille:file.size,
          data:e.target.result,
          dateUpload:new Date().toISOString()
        };
        await dbAdd('ged_documents',doc);
        toast('Document ajout√©','success');
        loadGEDFormations();
      };
      reader.readAsDataURL(file);
    }
  };
  input.click();
}

async function viewGEDDoc(id){
  const doc=await dbGet('ged_documents',id);
  if(doc&&doc.data){
    const win=window.open();
    win.document.write(`<iframe src="${doc.data}" style="width:100%;height:100%;border:none"></iframe>`);
  }
}

async function deleteGEDDoc(id){
  if(confirm('Supprimer ce document ?')){
    await dbDelete('ged_documents',id);
    toast('Document supprim√©','success');
    loadGEDFormations();
  }
}

// ============ AGENDA SESSIONS ============
let agendaSessionsDate=new Date();

async function showAgendaSessions(){
  // Remplir les filtres
  const [formations,formateurs]=await Promise.all([
    dbGetAll('formations'),
    dbGetAll('formateurs')
  ]);
  
  const filterFormation=document.getElementById('filter-agenda-sessions-formation');
  if(filterFormation){
    filterFormation.innerHTML='<option value="">Toutes les formations</option>'+
      formations.map(f=>`<option value="${f.id}">${esc(f.nom)}</option>`).join('');
  }
  
  const filterFormateur=document.getElementById('filter-agenda-sessions-formateur');
  if(filterFormateur){
    filterFormateur.innerHTML='<option value="">Tous les formateurs</option>'+
      formateurs.map(f=>`<option value="${f.id}">${esc(f.nom)} ${esc(f.prenom||'')}</option>`).join('');
  }
  
  renderAgendaSessions();
}

function agendaSessionsMoisPrec(){
  agendaSessionsDate.setMonth(agendaSessionsDate.getMonth()-1);
  renderAgendaSessions();
}

function agendaSessionsMoisSuiv(){
  agendaSessionsDate.setMonth(agendaSessionsDate.getMonth()+1);
  renderAgendaSessions();
}

async function renderAgendaSessions(){
  const calendar=document.getElementById('agenda-sessions-calendar');
  const moisLabel=document.getElementById('agenda-sessions-mois');
  if(!calendar)return;
  
  const year=agendaSessionsDate.getFullYear();
  const month=agendaSessionsDate.getMonth();
  
  // Afficher le mois
  const moisNoms=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
  moisLabel.textContent=`${moisNoms[month]} ${year}`;
  
  // R√©cup√©rer les sessions et les donn√©es li√©es
  const [sessions,formations,formateurs,entreprises,lieux]=await Promise.all([
    dbGetAll('sessions'),
    dbGetAll('formations'),
    dbGetAll('formateurs'),
    dbGetAll('entreprises'),
    dbGetAll('lieux')
  ]);
  
  const formMap=Object.fromEntries(formations.map(f=>[f.id,f]));
  const entMap=Object.fromEntries(entreprises.map(e=>[e.id,e]));
  const formateurMap=Object.fromEntries(formateurs.map(f=>[f.id,f]));
  const lieuMap=Object.fromEntries(lieux.map(l=>[l.id,l]));
  
  // Filtres
  const filterFormation=document.getElementById('filter-agenda-sessions-formation')?.value;
  const filterFormateur=document.getElementById('filter-agenda-sessions-formateur')?.value;
  const filterStatut=document.getElementById('filter-agenda-sessions-statut')?.value;
  
  // Filtrer les sessions
  let filteredSessions=sessions.filter(s=>{
    if(filterFormation&&s.formation!=filterFormation)return false;
    if(filterFormateur&&s.formateur!=filterFormateur)return false;
    if(filterStatut&&s.statut!==filterStatut)return false;
    const debut=s.dateDebutPrev||s.dateDebutEffective;
    return !!debut;
  });
  
  // Construire la grille du calendrier
  const firstDay=new Date(year,month,1);
  const lastDay=new Date(year,month+1,0);
  const startDayOfWeek=(firstDay.getDay()+6)%7; // Lundi = 0
  const daysInMonth=lastDay.getDate();
  
  const today=new Date();
  const todayStr=today.toISOString().split('T')[0];
  
  // Construire les semaines
  const weeks=[];
  let currentWeek=[];
  
  // Jours du mois pr√©c√©dent
  const prevMonth=new Date(year,month,0);
  const prevDays=prevMonth.getDate();
  for(let i=startDayOfWeek-1;i>=0;i--){
    const d=prevDays-i;
    const date=new Date(year,month-1,d);
    currentWeek.push({day:d,date:date,dateStr:date.toISOString().split('T')[0],otherMonth:true});
  }
  
  // Jours du mois
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(year,month,d);
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    currentWeek.push({day:d,date:date,dateStr:dateStr,otherMonth:false,isToday:dateStr===todayStr});
    if(currentWeek.length===7){
      weeks.push(currentWeek);
      currentWeek=[];
    }
  }
  
  // Jours du mois suivant
  if(currentWeek.length>0){
    let nextDay=1;
    while(currentWeek.length<7){
      const date=new Date(year,month+1,nextDay);
      currentWeek.push({day:nextDay,date:date,dateStr:date.toISOString().split('T')[0],otherMonth:true});
      nextDay++;
    }
    weeks.push(currentWeek);
  }
  
  // Construire le HTML
  let html='';
  
  // Header jours
  html+=`<div class="agenda-header-row">`;
  const jours=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
  jours.forEach(j=>{
    html+=`<div class="agenda-header-day">${j}</div>`;
  });
  html+=`</div>`;
  
  // Semaines
  weeks.forEach((week,weekIndex)=>{
    const weekStart=week[0].date;
    const weekEnd=week[6].date;
    
    // Trouver les sessions qui chevauchent cette semaine
    const weekSessions=filteredSessions.filter(s=>{
      const debut=new Date(s.dateDebutPrev||s.dateDebutEffective);
      const fin=new Date(s.dateFinPrev||s.dateFinEffective||s.dateDebutPrev||s.dateDebutEffective);
      return debut<=weekEnd&&fin>=weekStart;
    });
    
    // Calculer les positions des √©v√©nements pour √©viter les chevauchements
    const eventRows=[];
    weekSessions.forEach(s=>{
      const debut=new Date(s.dateDebutPrev||s.dateDebutEffective);
      const fin=new Date(s.dateFinPrev||s.dateFinEffective||s.dateDebutPrev||s.dateDebutEffective);
      
      // Calculer le jour de d√©but et fin dans la semaine (0-6)
      let startCol=0,endCol=6;
      for(let i=0;i<7;i++){
        if(week[i].date.toDateString()===debut.toDateString()||debut<week[i].date&&i===0){
          startCol=Math.max(0,i);
          if(debut<week[0].date)startCol=0;
        }
        if(week[i].date.toDateString()===fin.toDateString()||fin>week[i].date&&i===6){
          endCol=i;
          if(fin>week[6].date)endCol=6;
        }
      }
      if(debut<week[0].date)startCol=0;
      if(fin>week[6].date)endCol=6;
      
      // Trouver une ligne disponible
      let rowIndex=0;
      while(true){
        if(!eventRows[rowIndex])eventRows[rowIndex]=[];
        const conflict=eventRows[rowIndex].some(e=>
          (startCol<=e.endCol&&endCol>=e.startCol)
        );
        if(!conflict){
          eventRows[rowIndex].push({session:s,startCol,endCol});
          break;
        }
        rowIndex++;
        if(rowIndex>10)break;
      }
    });
    
    html+=`<div class="agenda-week">`;
    
    // Ligne des jours
    html+=`<div class="agenda-week-days">`;
    week.forEach(d=>{
      html+=`<div class="agenda-day${d.otherMonth?' other-month':''}${d.isToday?' today':''}">
        <div class="agenda-day-num">${d.day}</div>
      </div>`;
    });
    html+=`</div>`;
    
    // Lignes d'√©v√©nements
    const maxRows=Math.min(eventRows.length,3);
    for(let r=0;r<maxRows;r++){
      html+=`<div class="agenda-week-events">`;
      if(eventRows[r]){
        eventRows[r].forEach(evt=>{
          const s=evt.session;
          const form=formMap[s.formation];
          const ent=entMap[s.entreprise];
          const formateur=formateurMap[s.formateur];
          const lieu=lieuMap[s.lieu];
          const statut=s.statut||'Planifi√©e';
          const statutClass=statut==='En cours'?' en-cours':statut==='Termin√©e'?' terminee':statut==='Annul√©e'?' annulee':'';
          const isConfirme=s.confirme==='oui'||s.statut==='En cours'||s.statut==='Termin√©e';
          
          // Ville du lieu
          let villeLieu='';
          if(s.modalite==='Intra'&&ent){
            villeLieu=ent.ville||'';
          }else if(lieu){
            villeLieu=lieu.ville||'';
          }
          
          const left=(evt.startCol/7*100).toFixed(2);
          const width=((evt.endCol-evt.startCol+1)/7*100).toFixed(2);
          
          // Classe couleur formateur (cycle de 8 couleurs)
          const formateurColorClass=s.formateur?` formateur-${(s.formateur%8)+1}`:'';
          
          // Tooltip d√©taill√©
          const tooltip=`${esc(form?.nom||'Formation')}
üìç ${esc(villeLieu||'Lieu non d√©fini')}
üè¢ ${esc(ent?.nom||'-')}
üë®‚Äçüè´ ${esc(formateur?.nom||'')} ${esc(formateur?.prenom||'')}
${isConfirme?'‚úÖ Confirm√©e':'‚è≥ Non confirm√©e'}`;
          
          html+=`<div class="agenda-event-bar session${statutClass}${formateurColorClass}${isConfirme?' confirme':' non-confirme'}" 
            style="left:${left}%;width:calc(${width}% - 4px);top:2px" 
            onclick="voirSessionAgendaDetail(${s.id})" 
            title="${tooltip.replace(/\n/g,'&#10;')}">
            <span class="voyant ${isConfirme?'vert':'rouge'}"></span>
            <span class="event-title">${esc(form?.nom||'Formation')}</span>
            <span class="event-meta">${esc(ent?.nom||'').substring(0,10)} | ${esc(villeLieu).substring(0,8)} | ${esc(formateur?.nom||'').substring(0,6)}</span>
          </div>`;
        });
      }
      html+=`</div>`;
    }
    
    // Indicateur s'il y a plus d'√©v√©nements
    if(eventRows.length>maxRows){
      html+=`<div style="text-align:center;padding:2px">
        <span class="agenda-more" onclick="voirToutesSessionsSemaine(${weekIndex},'${weeks[weekIndex][0].dateStr}','${weeks[weekIndex][6].dateStr}')">
          +${eventRows.length-maxRows} autre(s)
        </span>
      </div>`;
    }
    
    html+=`</div>`;
  });
  
  calendar.innerHTML=html;
}

async function voirToutesSessionsSemaine(weekIndex,startStr,endStr){
  const [sessions,formations,entreprises]=await Promise.all([
    dbGetAll('sessions'),
    dbGetAll('formations'),
    dbGetAll('entreprises')
  ]);
  
  const formMap=Object.fromEntries(formations.map(f=>[f.id,f]));
  const entMap=Object.fromEntries(entreprises.map(e=>[e.id,e]));
  
  const weekStart=new Date(startStr);
  const weekEnd=new Date(endStr);
  
  const weekSessions=sessions.filter(s=>{
    const debut=new Date(s.dateDebutPrev||s.dateDebutEffective);
    const fin=new Date(s.dateFinPrev||s.dateFinEffective||s.dateDebutPrev||s.dateDebutEffective);
    return debut<=weekEnd&&fin>=weekStart;
  });
  
  const modal=document.createElement('div');
  modal.className='modal-overlay active';
  modal.id='modal-sessions-semaine';
  modal.innerHTML=`
    <div class="modal" style="max-width:600px">
      <div class="modal-header">
        <h3 class="modal-title">üìÖ Sessions de la semaine</h3>
        <button class="modal-close" onclick="document.getElementById('modal-sessions-semaine').remove()">√ó</button>
      </div>
      <div class="modal-body">
        ${weekSessions.map(s=>{
          const form=formMap[s.formation];
          const ent=entMap[s.entreprise];
          const debut=s.dateDebutPrev||s.dateDebutEffective;
          const fin=s.dateFinPrev||s.dateFinEffective||debut;
          return `
            <div style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:10px;cursor:pointer" onclick="document.getElementById('modal-sessions-semaine').remove();voirSessionAgendaDetail(${s.id})">
              <div style="font-weight:600;color:#1e40af">${esc(form?.nom||'Formation')}</div>
              <div style="font-size:0.85em;color:#64748b">${esc(ent?.nom||'-')}</div>
              <div style="font-size:0.8em;color:#10b981;margin-top:5px">
                ${new Date(debut).toLocaleDateString('fr-FR')} ‚Üí ${new Date(fin).toLocaleDateString('fr-FR')}
              </div>
            </div>
          `;
        }).join('')}
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('modal-sessions-semaine').remove()">Fermer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function voirToutesSessionsJour(dateStr){
  const [sessions,formations,entreprises]=await Promise.all([
    dbGetAll('sessions'),
    dbGetAll('formations'),
    dbGetAll('entreprises')
  ]);
  
  const formMap=Object.fromEntries(formations.map(f=>[f.id,f]));
  const entMap=Object.fromEntries(entreprises.map(e=>[e.id,e]));
  
  const daySessions=sessions.filter(s=>{
    const debut=s.dateDebutPrev||s.dateDebutEffective;
    if(!debut)return false;
    return debut.split('T')[0]===dateStr;
  });
  
  const dateFormatted=new Date(dateStr).toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  
  const modal=document.createElement('div');
  modal.className='modal-overlay active';
  modal.id='modal-sessions-jour';
  modal.innerHTML=`
    <div class="modal" style="max-width:600px">
      <div class="modal-header">
        <h3 class="modal-title">üìÖ Sessions du ${dateFormatted}</h3>
        <button class="modal-close" onclick="document.getElementById('modal-sessions-jour').remove()">√ó</button>
      </div>
      <div class="modal-body">
        ${daySessions.map(s=>{
          const form=formMap[s.formation];
          const ent=entMap[s.entreprise];
          return `
            <div style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:10px;cursor:pointer" onclick="document.getElementById('modal-sessions-jour').remove();voirSessionAgendaDetail(${s.id})">
              <div style="font-weight:600;color:#1e40af">${esc(form?.nom||'Formation')}</div>
              <div style="font-size:0.85em;color:#64748b">${esc(ent?.nom||'-')}</div>
              <div style="font-size:0.8em;color:#94a3b8">Session #${s.id}</div>
            </div>
          `;
        }).join('')}
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('modal-sessions-jour').remove()">Fermer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function voirSessionAgendaDetail(id){
  const session=await dbGet('sessions',id);
  if(!session)return;
  
  const [formations,formateurs,entreprises,lieux]=await Promise.all([
    dbGetAll('formations'),
    dbGetAll('formateurs'),
    dbGetAll('entreprises'),
    dbGetAll('lieux')
  ]);
  
  const form=formations.find(f=>f.id==session.formation);
  const formateur=formateurs.find(f=>f.id==session.formateur);
  const ent=entreprises.find(e=>e.id==session.entreprise);
  const lieu=lieux.find(l=>l.id==session.lieu);
  
  // Adresse du lieu de formation
  let adresseLieu='';
  if(session.modalite==='Intra'){
    adresseLieu=session.lieuIntra||'';
    if(ent&&!adresseLieu){
      adresseLieu=`${ent.adresse||''} ${ent.cp||''} ${ent.ville||''}`.trim();
    }
  }else if(lieu){
    adresseLieu=`${lieu.nom||''} - ${lieu.adresse||''} ${lieu.cp||''} ${lieu.ville||''}`.trim();
  }
  
  const dateDebut=session.dateDebutPrev||session.dateDebutEffective;
  const dateFin=session.dateFinPrev||session.dateFinEffective||dateDebut;
  const fmtDate=(d)=>d?new Date(d).toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:'short',year:'numeric'}):'-';
  
  const modal=document.createElement('div');
  modal.className='modal-overlay active';
  modal.id='modal-session-agenda-detail';
  modal.innerHTML=`
    <div class="modal" style="max-width:550px">
      <div class="modal-header" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white">
        <h3 class="modal-title">üìÖ D√©tails Session</h3>
        <button class="modal-close" onclick="document.getElementById('modal-session-agenda-detail').remove()" style="color:white">√ó</button>
      </div>
      <div class="modal-body" style="padding:0">
        
        <!-- Cartouche Dates -->
        <div style="background:linear-gradient(135deg,#1e40af,#3b82f6);color:white;padding:20px;text-align:center">
          <div style="font-size:0.8em;opacity:0.8;margin-bottom:5px">P√âRIODE DE FORMATION</div>
          <div style="font-size:1.4em;font-weight:700">
            ${fmtDate(dateDebut)} <span style="opacity:0.7">‚Üí</span> ${fmtDate(dateFin)}
          </div>
          <div style="margin-top:10px;display:inline-block;background:rgba(255,255,255,0.2);padding:5px 15px;border-radius:20px;font-size:0.85em">
            ${session.statut||'Planifi√©e'}
          </div>
        </div>
        
        <!-- Informations principales -->
        <div style="padding:20px">
          
          <!-- IDs -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px">
            <div style="background:#f0f9ff;padding:10px;border-radius:8px;text-align:center">
              <div style="font-size:0.7em;color:#64748b">ID SESSION</div>
              <div style="font-size:1.2em;font-weight:700;color:#1e40af">#${session.id}</div>
            </div>
            <div style="background:#faf5ff;padding:10px;border-radius:8px;text-align:center">
              <div style="font-size:0.7em;color:#64748b">ID FORMATION</div>
              <div style="font-size:1.2em;font-weight:700;color:#7c3aed">#${session.formation||'-'}</div>
            </div>
          </div>
          
          <!-- Formation -->
          <div style="background:#f8fafc;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #3b82f6">
            <div style="font-size:0.75em;color:#64748b;margin-bottom:3px">üìö FORMATION</div>
            <div style="font-size:1.1em;font-weight:600;color:#1e293b">${esc(form?.nom||'-')}</div>
            <div style="font-size:0.85em;color:#64748b;margin-top:5px">
              ${form?.duree||session.nbHeures||'-'} heures | ${session.typeFormation||'Pr√©sentiel'} | ${session.modalite||'Inter'}
            </div>
          </div>
          
          <!-- Entreprise -->
          <div style="background:#f0fdf4;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #10b981">
            <div style="font-size:0.75em;color:#64748b;margin-bottom:3px">üè¢ ENTREPRISE</div>
            <div style="font-size:1.1em;font-weight:600;color:#1e293b">${esc(ent?.nom||'-')}</div>
          </div>
          
          <!-- Contact -->
          <div style="background:#fffbeb;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #f59e0b">
            <div style="font-size:0.75em;color:#64748b;margin-bottom:8px">üë§ CONTACT</div>
            <div style="display:grid;gap:8px">
              <div style="display:flex;align-items:center;gap:8px">
                <span style="font-size:1.1em">üë§</span>
                <span style="font-weight:600">${esc(ent?.contact||session.contactNom||'-')}</span>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <span style="font-size:1.1em">üìû</span>
                <a href="tel:${ent?.mobileContact||ent?.telephone||''}" style="color:#1e40af;text-decoration:none;font-weight:500">
                  ${esc(ent?.mobileContact||ent?.telephone||'-')}
                </a>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <span style="font-size:1.1em">üìß</span>
                <a href="mailto:${ent?.emailContact||ent?.email||''}" style="color:#1e40af;text-decoration:none;font-weight:500">
                  ${esc(ent?.emailContact||ent?.email||'-')}
                </a>
              </div>
            </div>
          </div>
          
          <!-- Lieu de formation -->
          <div style="background:#fef2f2;padding:15px;border-radius:8px;border-left:4px solid #ef4444">
            <div style="font-size:0.75em;color:#64748b;margin-bottom:8px">üìç LIEU DE FORMATION</div>
            <div style="font-weight:600;color:#1e293b">${esc(adresseLieu||'Non d√©fini')}</div>
            ${session.horairesMatin||session.horairesAprem?`
              <div style="font-size:0.85em;color:#64748b;margin-top:8px">
                üïê ${session.horairesMatin||'9h00-12h30'} / ${session.horairesAprem||'13h30-17h00'}
              </div>
            `:''}
          </div>
          
        </div>
        
      </div>
      <div class="modal-footer" style="border-top:1px solid #e5e7eb">
        <button class="btn btn-secondary" onclick="document.getElementById('modal-session-agenda-detail').remove()">Fermer</button>
        <button class="btn btn-primary" onclick="document.getElementById('modal-session-agenda-detail').remove();voirSessionAgenda(${id})">üìã Vue compl√®te</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function voirSessionAgenda(id){
  const session=await dbGet('sessions',id);
  if(!session)return;
  
  const [formations,formateurs,entreprises,lieux,gedDocs]=await Promise.all([
    dbGetAll('formations'),
    dbGetAll('formateurs'),
    dbGetAll('entreprises'),
    dbGetAll('lieux'),
    dbGetAll('ged_documents')
  ]);
  
  const form=formations.find(f=>f.id==session.formation);
  const formateur=formateurs.find(f=>f.id==session.formateur);
  const ent=entreprises.find(e=>e.id==session.entreprise);
  const lieu=lieux.find(l=>l.id==session.lieu);
  
  // Adresse du lieu de formation
  let adresseLieu='';
  if(session.modalite==='Intra'){
    adresseLieu=session.lieuIntra||'';
    if(ent){
      adresseLieu=`${ent.adresse||''} ${ent.cp||''} ${ent.ville||''}`.trim()||adresseLieu;
    }
  }else if(lieu){
    adresseLieu=`${lieu.nom||''} - ${lieu.adresse||''} ${lieu.cp||''} ${lieu.ville||''}`.trim();
  }
  
  // Documents li√©s √† cette session/entreprise
  const sessionDocs=gedDocs.filter(d=>d.entrepriseId==session.entreprise||d.sessionId==session.id);
  
  const modal=document.createElement('div');
  modal.className='modal-overlay active';
  modal.id='modal-session-detail';
  modal.innerHTML=`
    <div class="modal" style="max-width:700px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column">
      <div class="modal-header" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white">
        <h3 class="modal-title">üìÖ Session: ${esc(form?.nom||'Formation')}</h3>
        <button class="modal-close" onclick="document.getElementById('modal-session-detail').remove()" style="color:white">√ó</button>
      </div>
      <div class="modal-body" style="overflow-y:auto;flex:1">
        
        <!-- Informations Formation -->
        <div style="background:#f0f9ff;padding:15px;border-radius:8px;margin-bottom:15px">
          <h4 style="margin:0 0 10px 0;color:#0369a1;font-size:0.9em">üìö Formation</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:0.85em">
            <div><strong>Intitul√©:</strong> ${esc(form?.nom||'-')}</div>
            <div><strong>Code:</strong> ${esc(form?.code||'-')}</div>
            <div><strong>Dur√©e:</strong> ${form?.duree||session.nbHeures||'-'} heures</div>
            <div><strong>Type:</strong> ${esc(session.typeFormation||'Pr√©sentiel')}</div>
            <div><strong>Modalit√©:</strong> ${esc(session.modalite||'Inter')}</div>
            <div><strong>Statut:</strong> <span class="status status-${slug(session.statut)}">${session.statut||'Planifi√©e'}</span></div>
          </div>
        </div>
        
        <!-- Contact / Entreprise -->
        <div style="background:#f0fdf4;padding:15px;border-radius:8px;margin-bottom:15px">
          <h4 style="margin:0 0 10px 0;color:#166534;font-size:0.9em">üè¢ Contact & Entreprise</h4>
          <div style="display:grid;gap:8px;font-size:0.85em">
            <div><strong>Entreprise:</strong> ${esc(ent?.nom||'-')}</div>
            <div><strong>Contact:</strong> ${esc(ent?.contact||session.contactNom||'-')}</div>
            <div><strong>üìû T√©l√©phone:</strong> <a href="tel:${ent?.mobileContact||ent?.telephone||''}">${esc(ent?.mobileContact||ent?.telephone||'-')}</a></div>
            <div><strong>üìß Email:</strong> <a href="mailto:${ent?.emailContact||ent?.email||''}">${esc(ent?.emailContact||ent?.email||'-')}</a></div>
          </div>
        </div>
        
        <!-- Lieu de formation -->
        <div style="background:#fefce8;padding:15px;border-radius:8px;margin-bottom:15px">
          <h4 style="margin:0 0 10px 0;color:#854d0e;font-size:0.9em">üìç Lieu de formation</h4>
          <div style="font-size:0.85em">
            <div><strong>Adresse:</strong> ${esc(adresseLieu||'Non d√©fini')}</div>
            ${lieu?`<div><strong>Capacit√©:</strong> ${lieu.capacite||'-'} personnes</div>`:''}
            ${lieu?.pmr?`<div><strong>Accessibilit√© PMR:</strong> ‚úÖ Oui</div>`:''}
          </div>
        </div>
        
        <!-- Formateur -->
        <div style="background:#faf5ff;padding:15px;border-radius:8px;margin-bottom:15px">
          <h4 style="margin:0 0 10px 0;color:#7c3aed;font-size:0.9em">üë®‚Äçüè´ Formateur</h4>
          <div style="display:grid;gap:8px;font-size:0.85em">
            <div><strong>Nom:</strong> ${esc(formateur?.nom||'')} ${esc(formateur?.prenom||'-')}</div>
            <div><strong>üìû T√©l√©phone:</strong> <a href="tel:${formateur?.telephone||''}">${esc(formateur?.telephone||'-')}</a></div>
            <div><strong>üìß Email:</strong> <a href="mailto:${formateur?.email||''}">${esc(formateur?.email||'-')}</a></div>
            <div><strong>Sp√©cialit√©s:</strong> ${esc(formateur?.specialites||'-')}</div>
          </div>
        </div>
        
        <!-- Dates modifiables -->
        <div style="background:#fff;border:2px solid #3b82f6;padding:15px;border-radius:8px;margin-bottom:15px">
          <h4 style="margin:0 0 10px 0;color:#1d4ed8;font-size:0.9em">üìÜ Dates (modifiables)</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
            <div class="form-group" style="margin:0">
              <label class="form-label" style="font-size:0.8em">Date d√©but pr√©vue</label>
              <input class="form-input" type="date" id="session-detail-dateDebutPrev" value="${session.dateDebutPrev||''}" style="font-size:0.85em">
            </div>
            <div class="form-group" style="margin:0">
              <label class="form-label" style="font-size:0.8em">Date fin pr√©vue</label>
              <input class="form-input" type="date" id="session-detail-dateFinPrev" value="${session.dateFinPrev||''}" style="font-size:0.85em">
            </div>
            <div class="form-group" style="margin:0">
              <label class="form-label" style="font-size:0.8em">Date d√©but effective</label>
              <input class="form-input" type="date" id="session-detail-dateDebutEffective" value="${session.dateDebutEffective||''}" style="font-size:0.85em">
            </div>
            <div class="form-group" style="margin:0">
              <label class="form-label" style="font-size:0.8em">Date fin effective</label>
              <input class="form-input" type="date" id="session-detail-dateFinEffective" value="${session.dateFinEffective||''}" style="font-size:0.85em">
            </div>
          </div>
          <div class="form-group" style="margin:10px 0 0 0">
            <label class="form-label" style="font-size:0.8em">Horaires</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <input class="form-input" type="text" id="session-detail-horairesMatin" value="${session.horairesMatin||'9h00-12h30'}" placeholder="Matin" style="font-size:0.85em">
              <input class="form-input" type="text" id="session-detail-horairesAprem" value="${session.horairesAprem||'13h30-17h00'}" placeholder="Apr√®s-midi" style="font-size:0.85em">
            </div>
          </div>
          <div class="form-group" style="margin:10px 0 0 0">
            <label class="form-label" style="font-size:0.8em">Statut</label>
            <select class="form-select" id="session-detail-statut" style="font-size:0.85em">
              <option value="Planifi√©e" ${session.statut==='Planifi√©e'?'selected':''}>Planifi√©e</option>
              <option value="En cours" ${session.statut==='En cours'?'selected':''}>En cours</option>
              <option value="Termin√©e" ${session.statut==='Termin√©e'?'selected':''}>Termin√©e</option>
              <option value="Annul√©e" ${session.statut==='Annul√©e'?'selected':''}>Annul√©e</option>
            </select>
          </div>
          <div class="form-group" style="margin:10px 0 0 0">
            <label class="form-label" style="font-size:0.8em">Notes / Observations</label>
            <textarea class="form-textarea" id="session-detail-notes" rows="2" style="font-size:0.85em">${esc(session.notes||'')}</textarea>
          </div>
        </div>
        
        <!-- Documents t√©l√©chargeables -->
        <div style="background:#fef2f2;padding:15px;border-radius:8px;margin-bottom:15px">
          <h4 style="margin:0 0 10px 0;color:#dc2626;font-size:0.9em">üìÑ Documents √† t√©l√©charger</h4>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
            <button class="btn btn-sm btn-secondary" onclick="telechargerDocSession(${id},'formateur')" style="justify-content:flex-start">
              üìã Documents formateur
            </button>
            <button class="btn btn-sm btn-secondary" onclick="telechargerDocSession(${id},'emargement')" style="justify-content:flex-start">
              ‚úçÔ∏è Feuille d'√©margement
            </button>
            <button class="btn btn-sm btn-secondary" onclick="telechargerDocSession(${id},'positionnement')" style="justify-content:flex-start">
              üìù Test de positionnement
            </button>
            <button class="btn btn-sm btn-secondary" onclick="telechargerDocSession(${id},'quiz')" style="justify-content:flex-start">
              ‚ùì Quiz interm√©diaires
            </button>
            <button class="btn btn-sm btn-secondary" onclick="telechargerDocSession(${id},'test-final')" style="justify-content:flex-start">
              ‚úÖ Test final
            </button>
            <button class="btn btn-sm btn-secondary" onclick="telechargerDocSession(${id},'satisfaction')" style="justify-content:flex-start">
              ‚≠ê Questionnaire satisfaction
            </button>
          </div>
          <div style="margin-top:10px">
            <button class="btn btn-sm btn-info" onclick="uploadDocSession(${id})">üì§ Ajouter un document</button>
          </div>
        </div>
        
      </div>
      <div class="modal-footer" style="border-top:1px solid #e5e7eb;padding:15px">
        <button class="btn btn-secondary" onclick="document.getElementById('modal-session-detail').remove()">Fermer</button>
        <button class="btn btn-success" onclick="sauvegarderSessionAgenda(${id})">üíæ Enregistrer les modifications</button>
        <button class="btn btn-primary" onclick="document.getElementById('modal-session-detail').remove();openModal('session',${id})">‚úèÔ∏è √âdition compl√®te</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function sauvegarderSessionAgenda(id){
  const session=await dbGet('sessions',id);
  if(!session)return;
  
  // R√©cup√©rer les valeurs modifi√©es
  session.dateDebutPrev=document.getElementById('session-detail-dateDebutPrev').value||null;
  session.dateFinPrev=document.getElementById('session-detail-dateFinPrev').value||null;
  session.dateDebutEffective=document.getElementById('session-detail-dateDebutEffective').value||null;
  session.dateFinEffective=document.getElementById('session-detail-dateFinEffective').value||null;
  session.horairesMatin=document.getElementById('session-detail-horairesMatin').value;
  session.horairesAprem=document.getElementById('session-detail-horairesAprem').value;
  session.statut=document.getElementById('session-detail-statut').value;
  session.notes=document.getElementById('session-detail-notes').value;
  
  await dbPut('sessions',session);
  toast('Session mise √† jour','success');
  
  // Rafra√Æchir les agendas
  if(currentPage==='agenda-sessions')renderAgendaSessions();
  if(currentPage==='agenda-general')renderAgendaGeneral();
  
  document.getElementById('modal-session-detail').remove();
}

async function telechargerDocSession(sessionId,typeDoc){
  const session=await dbGet('sessions',sessionId);
  const [formations,entreprises,formateurs,gedDocs]=await Promise.all([
    dbGetAll('formations'),
    dbGetAll('entreprises'),
    dbGetAll('formateurs'),
    dbGetAll('ged_documents')
  ]);
  
  const form=formations.find(f=>f.id==session?.formation);
  const ent=entreprises.find(e=>e.id==session?.entreprise);
  const formateur=formateurs.find(f=>f.id==session?.formateur);
  
  // Chercher le document dans la GED
  const categorieMap={
    'formateur':'formateur',
    'emargement':'emargement',
    'positionnement':'positionnement',
    'quiz':'tests-inter',
    'test-final':'tests-finaux',
    'satisfaction':'satisfaction'
  };
  
  const categorie=categorieMap[typeDoc];
  const doc=gedDocs.find(d=>d.categorie===categorie||(d.sessionId==sessionId&&d.type===typeDoc));
  
  if(doc&&doc.data){
    // T√©l√©charger le document existant
    const link=document.createElement('a');
    link.href=doc.data;
    link.download=doc.nom||`${typeDoc}-${sessionId}.pdf`;
    link.click();
    toast('Document t√©l√©charg√©','success');
  }else{
    // G√©n√©rer un document vierge
    const htmlContent=genererDocumentVierge(typeDoc,{session,form,ent,formateur});
    const printWindow=window.open('','_blank','width=800,height=600');
    if(printWindow){
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      setTimeout(()=>printWindow.print(),300);
      toast('Document g√©n√©r√© - Utilisez "Enregistrer en PDF"','info');
    }else{
      toast('Popup bloqu√©! Autorisez les popups.','error');
    }
  }
}

function genererDocumentVierge(typeDoc,{session,form,ent,formateur}){
  const dateDebut=session?.dateDebutPrev||session?.dateDebutEffective||'';
  const dateFin=session?.dateFinPrev||session?.dateFinEffective||'';
  const formatDate=(d)=>d?new Date(d).toLocaleDateString('fr-FR'):'___/___/______';
  
  const titres={
    'formateur':'Documents Formateur',
    'emargement':"Feuille d'√âmargement",
    'positionnement':'Test de Positionnement',
    'quiz':'Quiz Interm√©diaire',
    'test-final':'Test Final',
    'satisfaction':'Questionnaire de Satisfaction'
  };
  
  let contenuSpecifique='';
  
  if(typeDoc==='emargement'){
    contenuSpecifique=`
      <table style="width:100%;border-collapse:collapse;margin-top:20px">
        <thead>
          <tr style="background:#3b82f6;color:white">
            <th style="border:1px solid #ddd;padding:10px">Nom</th>
            <th style="border:1px solid #ddd;padding:10px">Pr√©nom</th>
            <th style="border:1px solid #ddd;padding:10px">Matin</th>
            <th style="border:1px solid #ddd;padding:10px">Apr√®s-midi</th>
            <th style="border:1px solid #ddd;padding:10px">Signature</th>
          </tr>
        </thead>
        <tbody>
          ${Array(10).fill().map(()=>`
            <tr>
              <td style="border:1px solid #ddd;padding:15px"></td>
              <td style="border:1px solid #ddd;padding:15px"></td>
              <td style="border:1px solid #ddd;padding:15px;text-align:center">‚òê</td>
              <td style="border:1px solid #ddd;padding:15px;text-align:center">‚òê</td>
              <td style="border:1px solid #ddd;padding:15px"></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <div style="margin-top:20px">
        <p><strong>Signature du formateur:</strong> _______________________________</p>
      </div>
    `;
  }else if(typeDoc==='positionnement'||typeDoc==='quiz'||typeDoc==='test-final'){
    contenuSpecifique=`
      <div style="margin-top:20px">
        <p><strong>Nom du stagiaire:</strong> ________________________________</p>
        <p><strong>Date:</strong> ___/___/______</p>
      </div>
      <div style="margin-top:30px">
        <h3>Questions</h3>
        ${Array(10).fill().map((_,i)=>`
          <div style="margin:20px 0;padding:15px;border:1px solid #ddd;border-radius:8px">
            <p><strong>Question ${i+1}:</strong></p>
            <p style="margin:10px 0">_________________________________________________________________</p>
            <p style="margin:10px 0">_________________________________________________________________</p>
          </div>
        `).join('')}
      </div>
      <div style="margin-top:30px">
        <p><strong>Score:</strong> ______ / 20</p>
        <p><strong>Observations:</strong></p>
        <p>_________________________________________________________________</p>
      </div>
    `;
  }else if(typeDoc==='satisfaction'){
    contenuSpecifique=`
      <div style="margin-top:20px">
        <p><strong>Nom du stagiaire:</strong> ________________________________ (facultatif)</p>
        <p><strong>Date:</strong> ___/___/______</p>
      </div>
      <div style="margin-top:30px">
        <h3>√âvaluation de la formation</h3>
        <p style="font-size:0.9em;color:#666">1 = Pas du tout satisfait | 5 = Tr√®s satisfait</p>
        <table style="width:100%;border-collapse:collapse;margin-top:15px">
          <tr style="background:#f8f8f8">
            <th style="border:1px solid #ddd;padding:10px;text-align:left">Crit√®re</th>
            <th style="border:1px solid #ddd;padding:10px;width:30px">1</th>
            <th style="border:1px solid #ddd;padding:10px;width:30px">2</th>
            <th style="border:1px solid #ddd;padding:10px;width:30px">3</th>
            <th style="border:1px solid #ddd;padding:10px;width:30px">4</th>
            <th style="border:1px solid #ddd;padding:10px;width:30px">5</th>
          </tr>
          ${['Contenu de la formation','Qualit√© p√©dagogique','Supports utilis√©s','Rythme de la formation','Atteinte des objectifs','Qualit√© des √©changes','Organisation g√©n√©rale','Accueil et logistique'].map(c=>`
            <tr>
              <td style="border:1px solid #ddd;padding:10px">${c}</td>
              <td style="border:1px solid #ddd;padding:10px;text-align:center">‚òê</td>
              <td style="border:1px solid #ddd;padding:10px;text-align:center">‚òê</td>
              <td style="border:1px solid #ddd;padding:10px;text-align:center">‚òê</td>
              <td style="border:1px solid #ddd;padding:10px;text-align:center">‚òê</td>
              <td style="border:1px solid #ddd;padding:10px;text-align:center">‚òê</td>
            </tr>
          `).join('')}
        </table>
        <div style="margin-top:20px">
          <p><strong>Recommanderiez-vous cette formation ?</strong> ‚òê Oui ‚òê Non</p>
          <p><strong>Commentaires / Suggestions:</strong></p>
          <p>_________________________________________________________________</p>
          <p>_________________________________________________________________</p>
        </div>
      </div>
    `;
  }else if(typeDoc==='formateur'){
    contenuSpecifique=`
      <div style="margin-top:20px">
        <h3>Informations Formateur</h3>
        <table style="width:100%;border-collapse:collapse">
          <tr><td style="padding:8px;border-bottom:1px solid #eee"><strong>Formateur:</strong></td><td style="padding:8px;border-bottom:1px solid #eee">${formateur?.nom||''} ${formateur?.prenom||''}</td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #eee"><strong>Email:</strong></td><td style="padding:8px;border-bottom:1px solid #eee">${formateur?.email||''}</td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #eee"><strong>T√©l√©phone:</strong></td><td style="padding:8px;border-bottom:1px solid #eee">${formateur?.telephone||''}</td></tr>
          <tr><td style="padding:8px;border-bottom:1px solid #eee"><strong>Sp√©cialit√©s:</strong></td><td style="padding:8px;border-bottom:1px solid #eee">${formateur?.specialites||''}</td></tr>
        </table>
      </div>
      <div style="margin-top:30px">
        <h3>Checklist documents</h3>
        <ul style="list-style:none;padding:0">
          <li style="padding:8px 0">‚òê Programme de formation</li>
          <li style="padding:8px 0">‚òê Supports p√©dagogiques</li>
          <li style="padding:8px 0">‚òê Feuilles d'√©margement</li>
          <li style="padding:8px 0">‚òê Tests de positionnement</li>
          <li style="padding:8px 0">‚òê Quiz interm√©diaires</li>
          <li style="padding:8px 0">‚òê Test final</li>
          <li style="padding:8px 0">‚òê Questionnaires satisfaction</li>
          <li style="padding:8px 0">‚òê Attestations de formation</li>
        </ul>
      </div>
    `;
  }
  
  return `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>${titres[typeDoc]||'Document'}</title>
<style>
@page{size:A4;margin:15mm}
body{font-family:Arial,sans-serif;font-size:10pt;padding:20px;color:#333}
h1{color:#3b82f6;font-size:18pt;margin-bottom:5px}
h2{font-size:12pt;color:#666;margin-top:0}
h3{font-size:11pt;color:#374151;margin-top:20px}
.header{border-bottom:2px solid #3b82f6;padding-bottom:15px;margin-bottom:20px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:15px 0}
.info-item{padding:8px;background:#f8f8f8;border-radius:4px}
.footer{margin-top:30px;padding-top:15px;border-top:1px solid #ddd;font-size:8pt;color:#666;text-align:center}
</style>
</head>
<body>
<div class="header">
  <h1>DesClick Formation</h1>
  <h2>${titres[typeDoc]||'Document'}</h2>
</div>

<div class="info-grid">
  <div class="info-item"><strong>Formation:</strong> ${form?.nom||'-'}</div>
  <div class="info-item"><strong>Entreprise:</strong> ${ent?.nom||'-'}</div>
  <div class="info-item"><strong>Date d√©but:</strong> ${formatDate(dateDebut)}</div>
  <div class="info-item"><strong>Date fin:</strong> ${formatDate(dateFin)}</div>
  <div class="info-item"><strong>Formateur:</strong> ${formateur?.nom||''} ${formateur?.prenom||''}</div>
  <div class="info-item"><strong>Lieu:</strong> ${session?.lieuIntra||'-'}</div>
</div>

${contenuSpecifique}

<div class="footer">
  <p>DesClick Formation - 3, rue Lech Walesa, 94270 Le Kremlin-Bic√™tre</p>
  <p>T√©l: 01 80 91 60 00 - Email: support@des-click.com</p>
</div>
</body>
</html>`;
}

async function uploadDocSession(sessionId){
  const input=document.createElement('input');
  input.type='file';
  input.accept='.pdf,.doc,.docx,.jpg,.jpeg,.png';
  input.onchange=async function(){
    if(this.files.length>0){
      const file=this.files[0];
      
      // Demander le type de document
      const typeDoc=prompt('Type de document:\n1. Documents formateur\n2. Feuille √©margement\n3. Test positionnement\n4. Quiz\n5. Test final\n6. Questionnaire satisfaction\n\nEntrez le num√©ro:');
      
      const types=['formateur','emargement','positionnement','quiz','test-final','satisfaction'];
      const categorie=types[parseInt(typeDoc)-1];
      
      if(!categorie){
        toast('Type de document invalide','error');
        return;
      }
      
      const reader=new FileReader();
      reader.onload=async function(e){
        const doc={
          sessionId:sessionId,
          categorie:categorie,
          nom:file.name,
          type:file.type,
          taille:file.size,
          data:e.target.result,
          dateUpload:new Date().toISOString()
        };
        await dbAdd('ged_documents',doc);
        toast('Document ajout√© √† la session','success');
      };
      reader.readAsDataURL(file);
    }
  };
  input.click();
}

// ============ AGENDA GENERAL ============
let agendaGeneralDate=new Date();

async function showAgendaGeneral(){
  // Info selon le r√¥le
  const roleInfo=document.getElementById('agenda-general-role-info');
  if(roleInfo){
    if(currentUser?.role==='Admin'){
      roleInfo.textContent='Vue compl√®te de tous les √©v√©nements (Admin)';
    }else if(currentUser?.role==='Formateur'){
      roleInfo.textContent='Vous voyez uniquement vos formations assign√©es';
    }else{
      roleInfo.textContent='Vue des √©v√©nements';
    }
  }
  
  // Remplir le filtre formateurs (visible seulement pour Admin/Gestionnaire)
  const filterFormateur=document.getElementById('filter-agenda-general-formateur');
  if(filterFormateur){
    if(currentUser?.role==='Formateur'){
      filterFormateur.style.display='none';
    }else{
      filterFormateur.style.display='';
      const formateurs=await dbGetAll('formateurs');
      filterFormateur.innerHTML='<option value="">Tous les formateurs</option>'+
        formateurs.map(f=>`<option value="${f.id}">${esc(f.nom)} ${esc(f.prenom||'')}</option>`).join('');
    }
  }
  
  renderAgendaGeneral();
}

function agendaGeneralMoisPrec(){
  agendaGeneralDate.setMonth(agendaGeneralDate.getMonth()-1);
  renderAgendaGeneral();
}

function agendaGeneralMoisSuiv(){
  agendaGeneralDate.setMonth(agendaGeneralDate.getMonth()+1);
  renderAgendaGeneral();
}

async function renderAgendaGeneral(){
  const calendar=document.getElementById('agenda-general-calendar');
  const moisLabel=document.getElementById('agenda-general-mois');
  if(!calendar)return;
  
  const year=agendaGeneralDate.getFullYear();
  const month=agendaGeneralDate.getMonth();
  
  // Afficher le mois
  const moisNoms=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
  moisLabel.textContent=`${moisNoms[month]} ${year}`;
  
  // R√©cup√©rer les donn√©es
  const [sessions,formations,formateurs,entreprises,lieux,agendaEvents]=await Promise.all([
    dbGetAll('sessions'),
    dbGetAll('formations'),
    dbGetAll('formateurs'),
    dbGetAll('entreprises'),
    dbGetAll('lieux'),
    dbGetAll('agenda_events')
  ]);
  
  const formMap=Object.fromEntries(formations.map(f=>[f.id,f]));
  const entMap=Object.fromEntries(entreprises.map(e=>[e.id,e]));
  const formateurMap=Object.fromEntries(formateurs.map(f=>[f.id,f]));
  const lieuMap=Object.fromEntries(lieux.map(l=>[l.id,l]));
  
  // Filtres
  const filterType=document.getElementById('filter-agenda-general-type')?.value;
  const filterFormateur=document.getElementById('filter-agenda-general-formateur')?.value;
  
  // Filtrer selon le r√¥le
  let filteredSessions=sessions.filter(s=>s.dateDebutPrev||s.dateDebutEffective);
  let filteredEvents=agendaEvents||[];
  
  // Si formateur, ne voir que ses sessions
  if(currentUser?.role==='Formateur'){
    const formateurUser=formateurs.find(f=>
      f.nom?.toLowerCase()===currentUser.nom?.toLowerCase()||
      f.email?.toLowerCase()===currentUser.email?.toLowerCase()
    );
    if(formateurUser){
      filteredSessions=filteredSessions.filter(s=>s.formateur==formateurUser.id);
      filteredEvents=filteredEvents.filter(e=>e.formateurId==formateurUser.id||!e.formateurId);
    }
  }
  
  // Appliquer les filtres
  if(filterType==='session'){
    filteredEvents=[];
  }else if(filterType&&filterType!=='session'){
    filteredSessions=[];
    filteredEvents=filteredEvents.filter(e=>e.type===filterType);
  }
  
  if(filterFormateur){
    filteredSessions=filteredSessions.filter(s=>s.formateur==filterFormateur);
    filteredEvents=filteredEvents.filter(e=>e.formateurId==filterFormateur||!e.formateurId);
  }
  
  // Construire les semaines
  const firstDay=new Date(year,month,1);
  const startDayOfWeek=(firstDay.getDay()+6)%7;
  const daysInMonth=new Date(year,month+1,0).getDate();
  
  const today=new Date();
  const todayStr=today.toISOString().split('T')[0];
  
  const weeks=[];
  let currentWeek=[];
  
  // Jours du mois pr√©c√©dent
  const prevMonth=new Date(year,month,0);
  const prevDays=prevMonth.getDate();
  for(let i=startDayOfWeek-1;i>=0;i--){
    const d=prevDays-i;
    const date=new Date(year,month-1,d);
    currentWeek.push({day:d,date:date,dateStr:date.toISOString().split('T')[0],otherMonth:true});
  }
  
  // Jours du mois
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(year,month,d);
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    currentWeek.push({day:d,date:date,dateStr:dateStr,otherMonth:false,isToday:dateStr===todayStr});
    if(currentWeek.length===7){
      weeks.push(currentWeek);
      currentWeek=[];
    }
  }
  
  // Jours du mois suivant
  if(currentWeek.length>0){
    let nextDay=1;
    while(currentWeek.length<7){
      const date=new Date(year,month+1,nextDay);
      currentWeek.push({day:nextDay,date:date,dateStr:date.toISOString().split('T')[0],otherMonth:true});
      nextDay++;
    }
    weeks.push(currentWeek);
  }
  
  // Construire le HTML
  let html='';
  
  // Header jours
  html+=`<div class="agenda-header-row">`;
  const jours=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
  jours.forEach(j=>{
    html+=`<div class="agenda-header-day">${j}</div>`;
  });
  html+=`</div>`;
  
  // Semaines
  weeks.forEach((week,weekIndex)=>{
    const weekStart=week[0].date;
    const weekEnd=week[6].date;
    
    // Sessions qui chevauchent cette semaine
    const weekSessions=filteredSessions.filter(s=>{
      const debut=new Date(s.dateDebutPrev||s.dateDebutEffective);
      const fin=new Date(s.dateFinPrev||s.dateFinEffective||s.dateDebutPrev||s.dateDebutEffective);
      return debut<=weekEnd&&fin>=weekStart;
    });
    
    // √âv√©nements de cette semaine (inclure les multi-jours)
    const weekEvents=filteredEvents.filter(e=>{
      const eDate=new Date(e.date);
      const eEndDate=e.dateFin?new Date(e.dateFin):eDate;
      return eDate<=weekEnd&&eEndDate>=weekStart;
    });
    
    // Calculer les positions des √©v√©nements
    const eventRows=[];
    
    // D'abord les sessions (multi-jours)
    weekSessions.forEach(s=>{
      const debut=new Date(s.dateDebutPrev||s.dateDebutEffective);
      const fin=new Date(s.dateFinPrev||s.dateFinEffective||s.dateDebutPrev||s.dateDebutEffective);
      
      let startCol=0,endCol=6;
      for(let i=0;i<7;i++){
        if(week[i].date>=debut&&startCol===0){startCol=i;}
        if(week[i].date<=fin){endCol=i;}
      }
      if(debut<week[0].date)startCol=0;
      if(fin>week[6].date)endCol=6;
      
      let rowIndex=0;
      while(true){
        if(!eventRows[rowIndex])eventRows[rowIndex]=[];
        const conflict=eventRows[rowIndex].some(e=>(startCol<=e.endCol&&endCol>=e.startCol));
        if(!conflict){
          eventRows[rowIndex].push({type:'session',session:s,startCol,endCol});
          break;
        }
        rowIndex++;
        if(rowIndex>10)break;
      }
    });
    
    // Ensuite les √©v√©nements (certains peuvent √™tre multi-jours comme les disponibilit√©s)
    weekEvents.forEach(e=>{
      const eDate=new Date(e.date);
      const eEndDate=e.dateFin?new Date(e.dateFin):eDate;
      
      // Calculer colonnes de d√©but et fin
      let startCol=0,endCol=0;
      for(let i=0;i<7;i++){
        if(week[i].date.toDateString()===eDate.toDateString()||eDate<week[i].date&&i===0){
          startCol=i;
          if(eDate<week[0].date)startCol=0;
        }
        if(week[i].date.toDateString()===eEndDate.toDateString()||eEndDate>week[i].date&&i===6){
          endCol=i;
          if(eEndDate>week[6].date)endCol=6;
        }
      }
      if(eDate<week[0].date)startCol=0;
      if(eEndDate>week[6].date)endCol=6;
      if(endCol<startCol)endCol=startCol;
      
      let rowIndex=0;
      while(true){
        if(!eventRows[rowIndex])eventRows[rowIndex]=[];
        const conflict=eventRows[rowIndex].some(ev=>(startCol<=ev.endCol&&endCol>=ev.startCol));
        if(!conflict){
          eventRows[rowIndex].push({type:'event',event:e,startCol,endCol});
          break;
        }
        rowIndex++;
        if(rowIndex>10)break;
      }
    });
    
    html+=`<div class="agenda-week">`;
    
    // Ligne des jours
    html+=`<div class="agenda-week-days">`;
    week.forEach(d=>{
      html+=`<div class="agenda-day${d.otherMonth?' other-month':''}${d.isToday?' today':''}">
        <div class="agenda-day-num">${d.day}</div>
      </div>`;
    });
    html+=`</div>`;
    
    // Lignes d'√©v√©nements
    const maxRows=Math.min(eventRows.length,4);
    for(let r=0;r<maxRows;r++){
      html+=`<div class="agenda-week-events">`;
      if(eventRows[r]){
        eventRows[r].forEach(evt=>{
          const left=(evt.startCol/7*100).toFixed(2);
          const width=((evt.endCol-evt.startCol+1)/7*100).toFixed(2);
          
          if(evt.type==='session'){
            const s=evt.session;
            const form=formMap[s.formation];
            const ent=entMap[s.entreprise];
            const formateur=formateurMap[s.formateur];
            const lieu=lieuMap[s.lieu];
            const statut=s.statut||'Planifi√©e';
            const statutClass=statut==='En cours'?' en-cours':statut==='Termin√©e'?' terminee':statut==='Annul√©e'?' annulee':'';
            const isConfirme=s.confirme==='oui'||s.statut==='En cours'||s.statut==='Termin√©e';
            
            // Ville du lieu
            let villeLieu='';
            if(s.modalite==='Intra'&&ent){
              villeLieu=ent.ville||'';
            }else if(lieu){
              villeLieu=lieu.ville||'';
            }
            
            // Classe couleur formateur (cycle de 8 couleurs)
            const formateurColorClass=s.formateur?` formateur-${(s.formateur%8)+1}`:'';
            
            // Tooltip d√©taill√©
            const tooltip=`${esc(form?.nom||'Formation')}
üìç ${esc(villeLieu||'Lieu non d√©fini')}
üè¢ ${esc(ent?.nom||'-')}
üë®‚Äçüè´ ${esc(formateur?.nom||'')} ${esc(formateur?.prenom||'')}
${isConfirme?'‚úÖ Confirm√©e':'‚è≥ Non confirm√©e'}`;
            
            html+=`<div class="agenda-event-bar session${statutClass}${formateurColorClass}${isConfirme?' confirme':' non-confirme'}" 
              style="left:${left}%;width:calc(${width}% - 4px);top:2px" 
              onclick="voirSessionAgenda(${s.id})" 
              title="${tooltip.replace(/\n/g,'&#10;')}">
              <span class="voyant ${isConfirme?'vert':'rouge'}"></span>
              <span class="event-title">${esc(form?.nom||'Formation')}</span>
              <span class="event-meta">${esc(ent?.nom||'').substring(0,10)} | ${esc(villeLieu).substring(0,8)} | ${esc(formateur?.nom||'').substring(0,6)}</span>
            </div>`;
          }else{
            const e=evt.event;
            const icons={rdv:'üìç',tache:'‚úÖ',rappel:'üîî',disponibilite:'üü¢'};
            const isDisponibilite=e.type==='disponibilite';
            html+=`<div class="agenda-event-bar ${e.type}" 
              style="left:${left}%;width:calc(${width}% - 4px);top:2px" 
              onclick="voirEventAgenda(${e.id})" 
              title="${esc(e.titre)}${isDisponibilite?' (Disponibilit√© formateur)':''}">
              <span class="event-icon">${icons[e.type]||'üìå'}</span>
              <span class="event-title">${esc(e.titre)}</span>
              ${isDisponibilite?`<span class="event-meta">Dispo.</span>`:''}
            </div>`;
          }
        });
      }
      html+=`</div>`;
    }
    
    if(eventRows.length>maxRows){
      html+=`<div style="text-align:center;padding:2px">
        <span class="agenda-more">+${eventRows.length-maxRows} autre(s)</span>
      </div>`;
    }
    
    html+=`</div>`;
  });
  
  calendar.innerHTML=html;
  
  // G√©n√©rer la l√©gende des formateurs
  const formateurColors=['#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f97316','#06b6d4','#84cc16','#f43f5e'];
  const formateursUtilises=new Set();
  filteredSessions.forEach(s=>{
    if(s.formateur)formateursUtilises.add(parseInt(s.formateur));
  });
  
  const legendeContainer=document.getElementById('agenda-general-formateurs-legende');
  const legendeListe=document.getElementById('agenda-general-formateurs-liste');
  
  if(legendeContainer&&legendeListe){
    if(formateursUtilises.size>0){
      const formateursArray=Array.from(formateursUtilises);
      legendeListe.innerHTML=formateursArray.map(fId=>{
        const f=formateurMap[fId];
        if(!f)return '';
        const colorIndex=(fId%8);
        return `<div style="display:flex;align-items:center;gap:5px;font-size:0.75em">
          <span style="width:14px;height:14px;background:${formateurColors[colorIndex]};border-radius:3px"></span>
          <span>${esc(f.nom)} ${esc(f.prenom||'')}</span>
        </div>`;
      }).join('');
      legendeContainer.style.display='block';
    }else{
      legendeContainer.style.display='none';
    }
  }
}

function openModalAgendaEvent(id=null){
  const isFormateur=currentUser?.role==='Formateur';
  const modal=document.createElement('div');
  modal.className='modal-overlay active';
  modal.id='modal-agenda-event';
  modal.innerHTML=`
    <div class="modal" style="max-width:500px">
      <div class="modal-header">
        <h3 class="modal-title">${id?'‚úèÔ∏è Modifier':'‚ûï Nouvel'} √©v√©nement</h3>
        <button class="modal-close" onclick="document.getElementById('modal-agenda-event').remove()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="agenda-event-id" value="${id||''}">
        <div class="form-group">
          <label class="form-label">Type *</label>
          <select class="form-select" id="agenda-event-type" required onchange="onAgendaEventTypeChange()">
            <option value="rdv">üìç RDV</option>
            <option value="tache">‚úÖ T√¢che</option>
            <option value="rappel">üîî Rappel</option>
            <option value="disponibilite">üü¢ Disponibilit√© formateur</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Titre *</label>
          <input class="form-input" id="agenda-event-titre" required placeholder="Titre de l'√©v√©nement">
        </div>
        <div class="form-row" id="agenda-event-dates-row">
          <div class="form-group">
            <label class="form-label">Date d√©but *</label>
            <input class="form-input" id="agenda-event-date" type="date" required>
          </div>
          <div class="form-group" id="agenda-event-datefin-group" style="display:none">
            <label class="form-label">Date fin</label>
            <input class="form-input" id="agenda-event-dateFin" type="date">
          </div>
        </div>
        <div class="form-group" id="agenda-event-heure-group">
          <label class="form-label">Heure</label>
          <input class="form-input" id="agenda-event-heure" type="time">
        </div>
        <div class="form-group" id="agenda-event-formateur-group">
          <label class="form-label">Formateur associ√©</label>
          <select class="form-select" id="agenda-event-formateur">
            <option value="">Aucun</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="agenda-event-description" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('modal-agenda-event').remove()">Annuler</button>
        ${id?`<button class="btn btn-danger" onclick="deleteAgendaEvent(${id})">üóëÔ∏è Supprimer</button>`:''}
        <button class="btn btn-primary" onclick="saveAgendaEvent()">üíæ Enregistrer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Remplir le select formateurs
  dbGetAll('formateurs').then(formateurs=>{
    const select=document.getElementById('agenda-event-formateur');
    select.innerHTML='<option value="">Aucun</option>'+
      formateurs.map(f=>`<option value="${f.id}">${esc(f.nom)} ${esc(f.prenom||'')}</option>`).join('');
    
    // Si formateur, pr√©-s√©lectionner et pr√©-remplir
    if(isFormateur){
      const formateurUser=formateurs.find(f=>
        f.nom?.toLowerCase()===currentUser.nom?.toLowerCase()||
        f.email?.toLowerCase()===currentUser.email?.toLowerCase()
      );
      if(formateurUser){
        select.value=formateurUser.id;
        // Pr√©-remplir le titre avec le nom du formateur pour les disponibilit√©s
        document.getElementById('agenda-event-type').value='disponibilite';
        document.getElementById('agenda-event-titre').value=`${formateurUser.nom} ${formateurUser.prenom||''} - Disponible`;
        onAgendaEventTypeChange();
      }
    }
  });
  
  // Si √©dition, charger les donn√©es
  if(id){
    dbGet('agenda_events',id).then(evt=>{
      if(evt){
        document.getElementById('agenda-event-type').value=evt.type||'rdv';
        document.getElementById('agenda-event-titre').value=evt.titre||'';
        document.getElementById('agenda-event-date').value=evt.date||'';
        document.getElementById('agenda-event-dateFin').value=evt.dateFin||'';
        document.getElementById('agenda-event-heure').value=evt.heure||'';
        document.getElementById('agenda-event-formateur').value=evt.formateurId||'';
        document.getElementById('agenda-event-description').value=evt.description||'';
        onAgendaEventTypeChange();
      }
    });
  }
}

function onAgendaEventTypeChange(){
  const type=document.getElementById('agenda-event-type').value;
  const dateFinGroup=document.getElementById('agenda-event-datefin-group');
  const heureGroup=document.getElementById('agenda-event-heure-group');
  
  if(type==='disponibilite'){
    dateFinGroup.style.display='block';
    heureGroup.style.display='none';
  }else{
    dateFinGroup.style.display='none';
    heureGroup.style.display='block';
  }
}

async function saveAgendaEvent(){
  const id=document.getElementById('agenda-event-id').value;
  const evt={
    type:document.getElementById('agenda-event-type').value,
    titre:document.getElementById('agenda-event-titre').value,
    date:document.getElementById('agenda-event-date').value,
    dateFin:document.getElementById('agenda-event-dateFin')?.value||null,
    heure:document.getElementById('agenda-event-heure').value,
    formateurId:document.getElementById('agenda-event-formateur').value||null,
    description:document.getElementById('agenda-event-description').value,
    createdBy:currentUser?.id,
    createdAt:new Date().toISOString()
  };
  
  if(!evt.titre||!evt.date){
    toast('Veuillez remplir les champs obligatoires','warning');
    return;
  }
  
  // Pour les disponibilit√©s, utiliser date comme dateFin si pas d√©finie
  if(evt.type==='disponibilite'&&!evt.dateFin){
    evt.dateFin=evt.date;
  }
  
  if(id){
    evt.id=parseInt(id);
    await dbPut('agenda_events',evt);
    toast('√âv√©nement modifi√©','success');
  }else{
    await dbAdd('agenda_events',evt);
    toast('√âv√©nement cr√©√©','success');
  }
  
  document.getElementById('modal-agenda-event').remove();
  renderAgendaGeneral();
}

async function deleteAgendaEvent(id){
  if(confirm('Supprimer cet √©v√©nement ?')){
    await dbDelete('agenda_events',id);
    toast('√âv√©nement supprim√©','success');
    document.getElementById('modal-agenda-event').remove();
    renderAgendaGeneral();
  }
}

async function voirEventAgenda(id){
  const evt=await dbGet('agenda_events',id);
  if(!evt)return;
  
  const formateurs=await dbGetAll('formateurs');
  const formateur=formateurs.find(f=>f.id==evt.formateurId);
  
  const typeLabels={rdv:'üìç RDV',tache:'‚úÖ T√¢che',rappel:'üîî Rappel',disponibilite:'üü¢ Disponibilit√© formateur'};
  const isDisponibilite=evt.type==='disponibilite';
  
  const modal=document.createElement('div');
  modal.className='modal-overlay active';
  modal.id='modal-event-detail';
  modal.innerHTML=`
    <div class="modal" style="max-width:450px">
      <div class="modal-header" style="${isDisponibilite?'background:linear-gradient(135deg,#6366f1,#4f46e5);color:white':''}">
        <h3 class="modal-title">${typeLabels[evt.type]||'√âv√©nement'}</h3>
        <button class="modal-close" onclick="document.getElementById('modal-event-detail').remove()"${isDisponibilite?' style="color:white"':''}>√ó</button>
      </div>
      <div class="modal-body">
        <div style="display:grid;gap:12px">
          <div><strong>Titre:</strong> ${esc(evt.titre)}</div>
          <div><strong>Date${isDisponibilite?' d√©but':''}:</strong> ${evt.date?new Date(evt.date).toLocaleDateString('fr-FR'):'-'}</div>
          ${isDisponibilite&&evt.dateFin?`<div><strong>Date fin:</strong> ${new Date(evt.dateFin).toLocaleDateString('fr-FR')}</div>`:''}
          ${!isDisponibilite&&evt.heure?`<div><strong>Heure:</strong> ${evt.heure}</div>`:''}
          ${formateur?`<div><strong>Formateur:</strong> ${esc(formateur.nom)} ${esc(formateur.prenom||'')}</div>`:''}
          ${evt.description?`<div><strong>Description:</strong> ${esc(evt.description)}</div>`:''}
          <div><strong>Date:</strong> ${new Date(evt.date).toLocaleDateString('fr-FR')}</div>
          ${evt.heure?`<div><strong>Heure:</strong> ${evt.heure}</div>`:''}
          ${formateur?`<div><strong>Formateur:</strong> ${esc(formateur.nom)} ${esc(formateur.prenom||'')}</div>`:''}
          ${evt.description?`<div><strong>Description:</strong><br>${esc(evt.description)}</div>`:''}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('modal-event-detail').remove()">Fermer</button>
        <button class="btn btn-primary" onclick="document.getElementById('modal-event-detail').remove();openModalAgendaEvent(${id})">‚úèÔ∏è Modifier</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// ============ MODULE √âCARTS DE COMP√âTENCES ============
// Mesure des √©carts entre positionnement (entr√©e) et test final (sortie)

let currentEcartsTab = 'sessions';

// Afficher onglet
function showEcartsTab(tab) {
  currentEcartsTab = tab;
  
  // Masquer tous les onglets
  document.querySelectorAll('.ecarts-tab').forEach(t => t.style.display = 'none');
  document.getElementById(`tab-ecarts-${tab}`).style.display = 'block';
  
  // Mettre √† jour boutons
  ['sessions', 'questions', 'bilan'].forEach(t => {
    const btn = document.getElementById(`btn-ecarts-${t}`);
    if (t === tab) {
      btn.style.background = '#059669';
      btn.style.color = 'white';
      btn.classList.remove('btn-secondary');
    } else {
      btn.style.background = '';
      btn.style.color = '';
      btn.classList.add('btn-secondary');
    }
  });
  
  // Charger donn√©es
  if (tab === 'sessions') loadEcartsSessions();
  else if (tab === 'questions') loadEcartsQuestions();
  else if (tab === 'bilan') loadBilanEcarts();
}

// Charger KPIs
async function loadEcartsKPIs() {
  try {
    const evaluations = await dbGetAll('ecarts_evaluations');
    const sessions = [...new Set(evaluations.map(e => e.sessionRef))];
    
    let totalEntree = 0, totalSortie = 0, count = 0;
    
    evaluations.forEach(e => {
      if (e.scoreEntree !== undefined && e.scoreSortie !== undefined) {
        totalEntree += e.scoreEntree;
        totalSortie += e.scoreSortie;
        count++;
      }
    });
    
    const moyEntree = count > 0 ? Math.round(totalEntree / count) : 0;
    const moySortie = count > 0 ? Math.round(totalSortie / count) : 0;
    const progression = moySortie - moyEntree;
    
    document.getElementById('kpi-ecarts-sessions').textContent = sessions.length;
    document.getElementById('kpi-ecarts-stagiaires').textContent = evaluations.length;
    document.getElementById('kpi-ecarts-entree').textContent = `${moyEntree}%`;
    document.getElementById('kpi-ecarts-sortie').textContent = `${moySortie}%`;
    document.getElementById('kpi-ecarts-progression').textContent = `+${progression}%`;
    document.getElementById('kpi-ecarts-progression').style.color = progression >= 30 ? '#16a34a' : progression >= 15 ? '#f59e0b' : '#dc2626';
  } catch (e) {
    console.warn('Erreur KPIs √©carts:', e);
  }
}

// Charger sessions
async function loadEcartsSessions() {
  try {
    const evaluations = await dbGetAll('ecarts_evaluations');
    
    // Grouper par session
    const sessionsMap = {};
    evaluations.forEach(e => {
      if (!sessionsMap[e.sessionRef]) {
        sessionsMap[e.sessionRef] = {
          ref: e.sessionRef,
          entreprise: e.entreprise,
          formation: e.formation,
          dateDebut: e.dateDebut,
          dateFin: e.dateFin,
          stagiaires: []
        };
      }
      sessionsMap[e.sessionRef].stagiaires.push(e);
    });
    
    const sessions = Object.values(sessionsMap);
    renderEcartsSessions(sessions);
    loadEcartsKPIs();
    
    // Remplir filtre formations
    const formations = [...new Set(evaluations.map(e => e.formation).filter(f => f))];
    const filterFormation = document.getElementById('filter-ecarts-formation');
    if (filterFormation) {
      filterFormation.innerHTML = '<option value="">Toutes formations</option>' + 
        formations.map(f => `<option value="${esc(f)}">${esc(trunc(f, 50))}</option>`).join('');
    }
  } catch (e) {
    console.warn('Erreur chargement sessions √©carts:', e);
    renderEcartsSessions([]);
  }
}

function renderEcartsSessions(sessions) {
  const tbody = document.getElementById('table-ecarts-sessions');
  if (!tbody) return;
  
  if (!sessions.length) {
    tbody.innerHTML = `<tr><td colspan="10" class="empty-state">
      <div class="empty-state-icon">üìà</div>
      <h3>Aucune √©valuation d'√©carts</h3>
      <p>Cliquez sur "üì• Importer donn√©es d√©mo" pour voir un exemple</p>
    </td></tr>`;
    return;
  }
  
  tbody.innerHTML = sessions.map(s => {
    const nbStagiaires = s.stagiaires.length;
    const scoreEntree = Math.round(s.stagiaires.reduce((sum, st) => sum + (st.scoreEntree || 0), 0) / nbStagiaires);
    const scoreSortie = Math.round(s.stagiaires.reduce((sum, st) => sum + (st.scoreSortie || 0), 0) / nbStagiaires);
    const progression = scoreSortie - scoreEntree;
    const tauxReussite = Math.round(s.stagiaires.filter(st => st.scoreSortie >= 70).length / nbStagiaires * 100);
    
    const progressionColor = progression >= 40 ? '#16a34a' : progression >= 20 ? '#22c55e' : progression >= 10 ? '#f59e0b' : '#dc2626';
    const tauxColor = tauxReussite >= 80 ? '#16a34a' : tauxReussite >= 60 ? '#f59e0b' : '#dc2626';
    
    return `
    <tr>
      <td><code style="background:#d1fae5;color:#059669;padding:3px 8px;border-radius:4px">${esc(s.ref)}</code></td>
      <td><strong>${esc(s.entreprise || '-')}</strong></td>
      <td style="max-width:200px">${esc(trunc(s.formation, 40))}</td>
      <td>${fmtDate(s.dateDebut)}${s.dateFin ? ' ‚Üí ' + fmtDate(s.dateFin) : ''}</td>
      <td style="text-align:center"><span style="background:#dbeafe;padding:4px 10px;border-radius:20px;font-weight:600">${nbStagiaires}</span></td>
      <td style="text-align:center">
        <div style="display:flex;align-items:center;gap:5px;justify-content:center">
          <div style="width:60px;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden">
            <div style="width:${scoreEntree}%;height:100%;background:#f59e0b"></div>
          </div>
          <span style="font-weight:600;color:#f59e0b">${scoreEntree}%</span>
        </div>
      </td>
      <td style="text-align:center">
        <div style="display:flex;align-items:center;gap:5px;justify-content:center">
          <div style="width:60px;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden">
            <div style="width:${scoreSortie}%;height:100%;background:#16a34a"></div>
          </div>
          <span style="font-weight:600;color:#16a34a">${scoreSortie}%</span>
        </div>
      </td>
      <td style="text-align:center">
        <span style="background:${progressionColor};color:white;padding:4px 10px;border-radius:20px;font-weight:700">+${progression}%</span>
      </td>
      <td style="text-align:center">
        <span style="color:${tauxColor};font-weight:600">${tauxReussite}% ‚úì</span>
      </td>
      <td class="action-btns">
        <button class="btn btn-info btn-icon" onclick="voirDetailSession('${esc(s.ref)}')" title="Voir d√©tails">üëÅÔ∏è</button>
        <button class="btn btn-success btn-icon" onclick="exporterSessionEcarts('${esc(s.ref)}')" title="Exporter">üìä</button>
        <button class="btn btn-secondary btn-icon" onclick="modifierSessionEcarts('${esc(s.ref)}')" title="Modifier">‚úèÔ∏è</button>
      </td>
    </tr>
  `}).join('');
}

// Voir d√©tail d'une session
async function voirDetailSession(sessionRef) {
  const evaluations = await dbGetAll('ecarts_evaluations');
  const sessionEvals = evaluations.filter(e => e.sessionRef === sessionRef);
  
  if (!sessionEvals.length) {
    toast('Session non trouv√©e', 'error');
    return;
  }
  
  const session = sessionEvals[0];
  const questions = await dbGetAll('ecarts_questions');
  const sessionQuestions = questions.filter(q => q.formation === session.formation);
  
  const modalHtml = `
    <div id="modal-detail-session" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:900px">
        <div class="modal-header" style="background:linear-gradient(135deg,#059669,#10b981)">
          <h3 class="modal-title">üìà D√©tail Session ${esc(sessionRef)}</h3>
          <button class="modal-close" onclick="document.getElementById('modal-detail-session').remove()">‚úï</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow-y:auto">
          <!-- Info session -->
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:20px;padding:15px;background:#f0fdf4;border-radius:10px">
            <div><strong>Entreprise:</strong><br>${esc(session.entreprise)}</div>
            <div><strong>Formation:</strong><br>${esc(session.formation)}</div>
            <div><strong>Dates:</strong><br>${fmtDate(session.dateDebut)} ‚Üí ${fmtDate(session.dateFin)}</div>
          </div>
          
          <!-- Tableau des stagiaires -->
          <h4 style="margin:0 0 10px 0;color:#059669">üë• √âvaluations par Stagiaire</h4>
          <div class="table-container" style="max-height:400px;overflow-y:auto">
            <table style="font-size:0.85em">
              <thead style="position:sticky;top:0;background:white">
                <tr>
                  <th>N¬∞</th>
                  <th>Stagiaire</th>
                  ${sessionQuestions.slice(0, 8).map((q, i) => `<th title="${esc(q.question)}" style="writing-mode:vertical-rl;text-orientation:mixed;max-width:30px;font-size:0.75em">Q${i+1}</th>`).join('')}
                  <th>Entr√©e</th>
                  <th>Sortie</th>
                  <th>√âcart</th>
                  <th>Succ√®s</th>
                </tr>
              </thead>
              <tbody>
                ${sessionEvals.map((st, idx) => {
                  const progression = (st.scoreSortie || 0) - (st.scoreEntree || 0);
                  const succes = st.scoreSortie >= 70;
                  return `
                  <tr style="${idx % 2 === 0 ? 'background:#f8fafc' : ''}">
                    <td>S${idx + 1}</td>
                    <td><strong>${esc(st.stagiaire)}</strong></td>
                    ${(st.reponsesEntree || []).slice(0, 8).map(r => `
                      <td style="text-align:center;background:${r ? '#dcfce7' : '#fee2e2'}">${r ? '‚úì' : '‚úó'}</td>
                    `).join('')}
                    <td style="text-align:center;background:#fef3c7;font-weight:600">${st.scoreEntree || 0}%</td>
                    <td style="text-align:center;background:#d1fae5;font-weight:600">${st.scoreSortie || 0}%</td>
                    <td style="text-align:center;color:${progression >= 30 ? '#16a34a' : '#f59e0b'};font-weight:700">+${progression}%</td>
                    <td style="text-align:center">${succes ? '‚úÖ' : '‚ö†Ô∏è'}</td>
                  </tr>
                `}).join('')}
              </tbody>
            </table>
          </div>
          
          <!-- R√©sum√© -->
          <div style="margin-top:20px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
            <div style="text-align:center;padding:15px;background:#fef3c7;border-radius:10px">
              <div style="font-size:1.5em;font-weight:700;color:#f59e0b">${Math.round(sessionEvals.reduce((s, e) => s + (e.scoreEntree || 0), 0) / sessionEvals.length)}%</div>
              <div style="font-size:0.8em;color:#64748b">Moyenne Entr√©e</div>
            </div>
            <div style="text-align:center;padding:15px;background:#d1fae5;border-radius:10px">
              <div style="font-size:1.5em;font-weight:700;color:#16a34a">${Math.round(sessionEvals.reduce((s, e) => s + (e.scoreSortie || 0), 0) / sessionEvals.length)}%</div>
              <div style="font-size:0.8em;color:#64748b">Moyenne Sortie</div>
            </div>
            <div style="text-align:center;padding:15px;background:#fae8ff;border-radius:10px">
              <div style="font-size:1.5em;font-weight:700;color:#a855f7">+${Math.round((sessionEvals.reduce((s, e) => s + (e.scoreSortie || 0), 0) - sessionEvals.reduce((s, e) => s + (e.scoreEntree || 0), 0)) / sessionEvals.length)}%</div>
              <div style="font-size:0.8em;color:#64748b">Progression</div>
            </div>
            <div style="text-align:center;padding:15px;background:#dbeafe;border-radius:10px">
              <div style="font-size:1.5em;font-weight:700;color:#2563eb">${Math.round(sessionEvals.filter(e => e.scoreSortie >= 70).length / sessionEvals.length * 100)}%</div>
              <div style="font-size:0.8em;color:#64748b">Taux R√©ussite</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('modal-detail-session').remove()">Fermer</button>
          <button class="btn btn-success" onclick="exporterSessionEcarts('${esc(sessionRef)}')">üìä Exporter</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Charger questions
async function loadEcartsQuestions() {
  try {
    const questions = await dbGetAll('ecarts_questions');
    renderEcartsQuestions(questions);
    
    // Remplir filtre formations
    const formations = [...new Set(questions.map(q => q.formation).filter(f => f))];
    const filterFormation = document.getElementById('filter-questions-formation');
    if (filterFormation) {
      filterFormation.innerHTML = '<option value="">Toutes formations</option>' + 
        formations.map(f => `<option value="${esc(f)}">${esc(trunc(f, 50))}</option>`).join('');
    }
  } catch (e) {
    console.warn('Erreur chargement questions:', e);
    renderEcartsQuestions([]);
  }
}

function renderEcartsQuestions(questions) {
  const tbody = document.getElementById('table-ecarts-questions');
  if (!tbody) return;
  
  if (!questions.length) {
    tbody.innerHTML = `<tr><td colspan="7" class="empty-state">
      <div class="empty-state-icon">‚ùì</div>
      <h3>Aucune question</h3>
      <p>Cliquez sur "üì• Importer questions d√©mo" pour charger des exemples</p>
    </td></tr>`;
    return;
  }
  
  tbody.innerHTML = questions.map(q => `
    <tr>
      <td><code>Q-${String(q.id).padStart(3,'0')}</code></td>
      <td style="max-width:150px;font-size:0.85em">${esc(trunc(q.formation, 30))}</td>
      <td style="max-width:300px">${esc(q.question)}</td>
      <td><span class="status status-${q.type === 'QCM' ? 'actif' : 'en-cours'}">${q.type || 'QCM'}</span></td>
      <td style="font-size:0.8em">${q.options ? q.options.map((o, i) => `<div>${i+1}. ${esc(trunc(o, 25))}</div>`).join('') : '-'}</td>
      <td style="text-align:center;font-weight:600;color:#16a34a">${q.bonneReponse || '-'}</td>
      <td class="action-btns">
        <button class="btn btn-secondary btn-icon" onclick="modifierQuestion(${q.id})" title="Modifier">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-icon" onclick="confirmDelete('ecarts_questions',${q.id})" title="Supprimer">üóëÔ∏è</button>
      </td>
    </tr>
  `).join('');
}

// Filtres
async function filterEcartsSessions() {
  const search = (document.getElementById('search-ecarts-sessions')?.value || '').toLowerCase();
  const formation = document.getElementById('filter-ecarts-formation')?.value || '';
  const annee = document.getElementById('filter-ecarts-annee')?.value || '';
  
  let evaluations = await dbGetAll('ecarts_evaluations');
  
  if (search) {
    evaluations = evaluations.filter(e => 
      (e.sessionRef || '').toLowerCase().includes(search) ||
      (e.entreprise || '').toLowerCase().includes(search) ||
      (e.stagiaire || '').toLowerCase().includes(search)
    );
  }
  
  if (formation) {
    evaluations = evaluations.filter(e => e.formation === formation);
  }
  
  if (annee) {
    evaluations = evaluations.filter(e => {
      const d = new Date(e.dateDebut);
      return d.getFullYear().toString() === annee;
    });
  }
  
  // Regrouper
  const sessionsMap = {};
  evaluations.forEach(e => {
    if (!sessionsMap[e.sessionRef]) {
      sessionsMap[e.sessionRef] = { ref: e.sessionRef, entreprise: e.entreprise, formation: e.formation, dateDebut: e.dateDebut, dateFin: e.dateFin, stagiaires: [] };
    }
    sessionsMap[e.sessionRef].stagiaires.push(e);
  });
  
  renderEcartsSessions(Object.values(sessionsMap));
}

async function filterEcartsQuestions() {
  const search = (document.getElementById('search-ecarts-questions')?.value || '').toLowerCase();
  const formation = document.getElementById('filter-questions-formation')?.value || '';
  
  let questions = await dbGetAll('ecarts_questions');
  
  if (search) {
    questions = questions.filter(q => (q.question || '').toLowerCase().includes(search));
  }
  
  if (formation) {
    questions = questions.filter(q => q.formation === formation);
  }
  
  renderEcartsQuestions(questions);
}

// Modal nouvelle question
async function ouvrirModalNouvelleQuestion() {
  const formations = await dbGetAll('formations');
  
  const modalHtml = `
    <div id="modal-question" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:600px">
        <div class="modal-header" style="background:linear-gradient(135deg,#059669,#10b981)">
          <h3 class="modal-title">‚ùì Nouvelle Question</h3>
          <button class="modal-close" onclick="document.getElementById('modal-question').remove()">‚úï</button>
        </div>
        <div class="modal-body">
          <form id="form-question" onsubmit="saveQuestion();return false">
            <div class="form-group"><label>Formation *</label>
              <select class="form-select" id="q-formation" required>
                <option value="">-- S√©lectionner --</option>
                ${formations.map(f => `<option value="${esc(f.nom)}">${esc(f.nom)}</option>`).join('')}
                <option value="Piloter votre application mobile android ou IOS DCWEBAPS de commande">Piloter votre application mobile DCWEBAPS</option>
                <option value="Piloter votre site internet">Piloter votre site internet</option>
                <option value="Formation Hygi√®ne Alimentaire HACCP">Hygi√®ne Alimentaire HACCP</option>
              </select>
            </div>
            <div class="form-group"><label>Question *</label><textarea class="form-textarea" id="q-question" rows="2" required placeholder="Ex: O√π me rendre pour afficher ma base de donn√©es clients ?"></textarea></div>
            <div class="form-group"><label>Type</label>
              <select class="form-select" id="q-type">
                <option value="QCM">QCM (Choix multiple)</option>
                <option value="Vrai/Faux">Vrai/Faux</option>
                <option value="Texte">R√©ponse texte</option>
              </select>
            </div>
            <div id="q-options-container">
              <label>Options de r√©ponse</label>
              <div id="q-options-list">
                <input type="text" class="form-input" placeholder="Option 1" style="margin-bottom:5px">
                <input type="text" class="form-input" placeholder="Option 2" style="margin-bottom:5px">
                <input type="text" class="form-input" placeholder="Option 3" style="margin-bottom:5px">
                <input type="text" class="form-input" placeholder="Option 4" style="margin-bottom:5px">
              </div>
            </div>
            <div class="form-group"><label>Bonne r√©ponse (n¬∞ option)</label><input type="number" class="form-input" id="q-bonne-reponse" min="1" max="4" value="1"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('modal-question').remove()">Annuler</button>
          <button type="submit" form="form-question" class="btn btn-primary">üíæ Enregistrer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

async function saveQuestion() {
  const options = Array.from(document.querySelectorAll('#q-options-list input')).map(i => i.value).filter(v => v);
  
  const data = {
    formation: document.getElementById('q-formation')?.value || '',
    question: document.getElementById('q-question')?.value || '',
    type: document.getElementById('q-type')?.value || 'QCM',
    options: options,
    bonneReponse: parseInt(document.getElementById('q-bonne-reponse')?.value) || 1
  };
  
  await dbAdd('ecarts_questions', data);
  toast('‚úÖ Question ajout√©e', 'success');
  document.getElementById('modal-question')?.remove();
  loadEcartsQuestions();
}

// Modal nouvelle √©valuation session - Grille style Google Sheets
let evalSessionQuestions = [];
let evalSessionStagiaires = [];

async function ouvrirModalNouvelleEvalSession() {
  const formations = await dbGetAll('formations');
  
  // R√©initialiser
  evalSessionQuestions = [];
  evalSessionStagiaires = [{ nom: '', entree: [], sortie: [] }];
  
  const modalHtml = `
    <div id="modal-eval-session" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:95vw;width:1400px">
        <div class="modal-header" style="background:linear-gradient(135deg,#059669,#10b981)">
          <h3 class="modal-title">üìà Bilan √âvaluations de Positionnement - Nouvelle Session</h3>
          <button class="modal-close" onclick="document.getElementById('modal-eval-session').remove()">‚úï</button>
        </div>
        <div class="modal-body" style="max-height:80vh;overflow-y:auto;padding:15px">
          
          <!-- PAGE DE GARDE -->
          <div style="background:linear-gradient(135deg,#1e40af,#3b82f6);color:white;padding:20px;border-radius:10px;margin-bottom:20px;text-align:center">
            <h2 style="margin:0 0 5px 0">Mesure des √©carts en terme des comp√©tences</h2>
            <p style="margin:0;opacity:0.8">BILAN √âVALUATIONS DE POSITIONNEMENT</p>
          </div>
          
          <!-- Informations Session -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;padding:15px;background:#f0fdf4;border-radius:10px;border:2px solid #22c55e">
            <div class="form-group" style="margin:0">
              <label style="font-weight:600;color:#166534">R√©f√©rence Session *</label>
              <input type="text" class="form-input" id="eval-ref" required placeholder="Ex: 24-001" style="font-weight:bold">
            </div>
            <div class="form-group" style="margin:0">
              <label style="font-weight:600;color:#166534">Entreprise *</label>
              <input type="text" class="form-input" id="eval-entreprise" required placeholder="Ex: ANDIAMO">
            </div>
            <div class="form-group" style="margin:0">
              <label style="font-weight:600;color:#166534">Date Formation - Du</label>
              <input type="date" class="form-input" id="eval-date-debut" required>
            </div>
            <div class="form-group" style="margin:0">
              <label style="font-weight:600;color:#166534">Au</label>
              <input type="date" class="form-input" id="eval-date-fin">
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:15px;margin-bottom:20px">
            <div class="form-group" style="margin:0">
              <label style="font-weight:600;color:#166534">Formation *</label>
              <select class="form-select" id="eval-formation" required onchange="chargerQuestionsFormation()">
                <option value="">-- S√©lectionner une formation --</option>
                ${formations.map(f => `<option value="${esc(f.nom)}">${esc(f.nom)}</option>`).join('')}
                <option value="Piloter votre application mobile android ou IOS DCWEBAPS de commande">Piloter votre application mobile DCWEBAPS</option>
                <option value="Piloter votre site internet">Piloter votre site internet</option>
                <option value="Formation Hygi√®ne Alimentaire HACCP">Formation Hygi√®ne Alimentaire HACCP</option>
              </select>
            </div>
            <div class="form-group" style="margin:0">
              <label style="font-weight:600;color:#166534">Nombre de questions</label>
              <input type="number" class="form-input" id="eval-nb-questions" value="10" min="1" max="20" onchange="ajusterNbQuestions()" style="background:#e2e8f0">
            </div>
            <div class="form-group" style="margin:0">
              <label style="font-weight:600;color:#166534">Type de Test</label>
              <select class="form-select" id="eval-type-test">
                <option value="Choix multiple">Choix multiple</option>
                <option value="Vrai/Faux">Vrai/Faux</option>
                <option value="Mixte">Mixte</option>
              </select>
            </div>
          </div>
          
          <!-- Zone des questions (√† charger dynamiquement) -->
          <div id="eval-questions-zone" style="margin-bottom:15px;padding:10px;background:#fef3c7;border-radius:8px;display:none">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
              <strong style="color:#92400e">‚ùì Questions du questionnaire</strong>
              <button type="button" class="btn btn-sm btn-secondary" onclick="toggleQuestionsEdit()">‚úèÔ∏è Modifier les questions</button>
            </div>
            <div id="eval-questions-list" style="font-size:0.85em;display:grid;grid-template-columns:repeat(2,1fr);gap:5px"></div>
          </div>
          
          <!-- GRILLE D'√âVALUATION -->
          <div style="background:#f8fafc;padding:15px;border-radius:10px;border:2px solid #3b82f6">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px">
              <h4 style="margin:0;color:#1e40af">üìä Grille d'√âvaluation par Stagiaire</h4>
              <button type="button" class="btn btn-primary btn-sm" onclick="ajouterLigneStagiaire()">‚ûï Ajouter un stagiaire</button>
            </div>
            
            <div style="overflow-x:auto">
              <table id="grille-evaluation" style="width:100%;border-collapse:collapse;font-size:0.8em;min-width:1200px">
                <thead id="grille-thead">
                  <!-- G√©n√©r√© dynamiquement -->
                </thead>
                <tbody id="grille-tbody">
                  <!-- G√©n√©r√© dynamiquement -->
                </tbody>
              </table>
            </div>
          </div>
          
        </div>
        <div class="modal-footer" style="display:flex;justify-content:space-between">
          <div>
            <span id="eval-resume" style="color:#64748b;font-size:0.9em">0 stagiaire(s)</span>
          </div>
          <div style="display:flex;gap:10px">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('modal-eval-session').remove()">Annuler</button>
            <button type="button" class="btn btn-success" onclick="saveEvalSessionGrille()">üíæ Enregistrer l'√©valuation</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // Initialiser la grille
  genererGrilleEvaluation();
}

// Charger les questions de la formation s√©lectionn√©e
async function chargerQuestionsFormation() {
  const formation = document.getElementById('eval-formation')?.value;
  if (!formation) {
    evalSessionQuestions = [];
    document.getElementById('eval-questions-zone').style.display = 'none';
    genererGrilleEvaluation();
    return;
  }
  
  // Chercher les questions dans la BD
  const allQuestions = await dbGetAll('ecarts_questions');
  evalSessionQuestions = allQuestions.filter(q => q.formation === formation);
  
  // Si pas de questions, cr√©er des questions g√©n√©riques
  if (evalSessionQuestions.length === 0) {
    const nbQ = parseInt(document.getElementById('eval-nb-questions')?.value) || 10;
    for (let i = 1; i <= nbQ; i++) {
      evalSessionQuestions.push({ id: i, question: `Question ${i}`, formation: formation });
    }
  }
  
  // Afficher les questions
  const zone = document.getElementById('eval-questions-zone');
  const list = document.getElementById('eval-questions-list');
  zone.style.display = 'block';
  
  list.innerHTML = evalSessionQuestions.map((q, i) => `
    <div style="padding:5px 8px;background:white;border-radius:4px;border-left:3px solid #f59e0b">
      <strong>Q${i+1}:</strong> ${esc(trunc(q.question, 50))}
    </div>
  `).join('');
  
  // R√©g√©n√©rer la grille avec les nouvelles questions
  genererGrilleEvaluation();
}

function ajusterNbQuestions() {
  const nb = parseInt(document.getElementById('eval-nb-questions')?.value) || 10;
  const formation = document.getElementById('eval-formation')?.value || '';
  
  // Ajuster le nombre de questions
  while (evalSessionQuestions.length < nb) {
    evalSessionQuestions.push({ id: evalSessionQuestions.length + 1, question: `Question ${evalSessionQuestions.length + 1}`, formation: formation });
  }
  evalSessionQuestions = evalSessionQuestions.slice(0, nb);
  
  // Mettre √† jour l'affichage
  const list = document.getElementById('eval-questions-list');
  if (list) {
    list.innerHTML = evalSessionQuestions.map((q, i) => `
      <div style="padding:5px 8px;background:white;border-radius:4px;border-left:3px solid #f59e0b">
        <strong>Q${i+1}:</strong> ${esc(trunc(q.question, 50))}
      </div>
    `).join('');
  }
  
  genererGrilleEvaluation();
}

// G√©n√©rer la grille d'√©valuation style Google Sheets
function genererGrilleEvaluation() {
  const thead = document.getElementById('grille-thead');
  const tbody = document.getElementById('grille-tbody');
  if (!thead || !tbody) return;
  
  const nbQuestions = evalSessionQuestions.length || parseInt(document.getElementById('eval-nb-questions')?.value) || 10;
  
  // En-t√™te
  let headerHtml = `
    <tr style="background:#1e40af;color:white">
      <th style="padding:8px;border:1px solid #3b82f6;min-width:70px">Nature</th>
      <th style="padding:8px;border:1px solid #3b82f6;min-width:50px">N¬∞</th>
      <th style="padding:8px;border:1px solid #3b82f6;min-width:150px">Stagiaire</th>
      <th style="padding:8px;border:1px solid #3b82f6;min-width:80px">Date</th>
  `;
  
  // Colonnes des questions
  for (let i = 0; i < nbQuestions; i++) {
    const qTitle = evalSessionQuestions[i]?.question || `Q${i+1}`;
    headerHtml += `<th style="padding:4px;border:1px solid #3b82f6;min-width:35px;font-size:0.75em;writing-mode:vertical-rl;text-orientation:mixed;height:100px" title="${esc(qTitle)}">Q${i+1}</th>`;
  }
  
  headerHtml += `
      <th style="padding:8px;border:1px solid #3b82f6;min-width:60px;background:#f59e0b">Score</th>
      <th style="padding:8px;border:1px solid #3b82f6;min-width:60px;background:#22c55e">√âcart</th>
      <th style="padding:8px;border:1px solid #3b82f6;min-width:50px;background:#a855f7">Notes</th>
      <th style="padding:8px;border:1px solid #3b82f6;min-width:50px;background:#06b6d4">Succ√®s</th>
      <th style="padding:8px;border:1px solid #3b82f6;min-width:40px">üóëÔ∏è</th>
    </tr>
  `;
  thead.innerHTML = headerHtml;
  
  // Corps - Lignes des stagiaires
  if (evalSessionStagiaires.length === 0) {
    evalSessionStagiaires = [{ nom: '', entree: new Array(nbQuestions).fill(0), sortie: new Array(nbQuestions).fill(0) }];
  }
  
  // S'assurer que chaque stagiaire a le bon nombre de r√©ponses
  evalSessionStagiaires.forEach(st => {
    while ((st.entree || []).length < nbQuestions) st.entree.push(0);
    while ((st.sortie || []).length < nbQuestions) st.sortie.push(0);
    st.entree = st.entree.slice(0, nbQuestions);
    st.sortie = st.sortie.slice(0, nbQuestions);
  });
  
  let bodyHtml = '';
  evalSessionStagiaires.forEach((st, idx) => {
    const scoreEntree = st.entree.filter(v => v === 1).length;
    const scoreSortie = st.sortie.filter(v => v === 1).length;
    const pctEntree = Math.round(scoreEntree / nbQuestions * 100);
    const pctSortie = Math.round(scoreSortie / nbQuestions * 100);
    const ecart = pctSortie - pctEntree;
    const noteSur20 = Math.round(pctSortie / 5);
    const succes = pctSortie >= 70;
    
    // Ligne ENTR√âE
    bodyHtml += `
      <tr style="background:#fef3c7" data-stagiaire="${idx}" data-type="entree">
        <td style="padding:6px;border:1px solid #e2e8f0;font-weight:bold;background:#f59e0b;color:white;text-align:center">Entr√©e</td>
        <td style="padding:6px;border:1px solid #e2e8f0;text-align:center;font-weight:bold">S${idx+1}</td>
        <td style="padding:4px;border:1px solid #e2e8f0">
          <input type="text" value="${esc(st.nom)}" onchange="updateStagiaireNom(${idx}, this.value)" 
                 style="width:100%;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:0.85em" placeholder="Nom du stagiaire">
        </td>
        <td style="padding:4px;border:1px solid #e2e8f0">
          <input type="date" id="date-entree-${idx}" style="width:100%;padding:2px;border:1px solid #d1d5db;border-radius:4px;font-size:0.8em">
        </td>
    `;
    
    // Cases des questions ENTR√âE
    for (let q = 0; q < nbQuestions; q++) {
      const checked = st.entree[q] === 1;
      bodyHtml += `
        <td style="padding:2px;border:1px solid #e2e8f0;text-align:center;cursor:pointer;background:${checked ? '#dcfce7' : '#fee2e2'}" 
            onclick="toggleReponse(${idx}, 'entree', ${q})">
          <span style="font-weight:bold;color:${checked ? '#16a34a' : '#dc2626'}">${checked ? '1' : '0'}</span>
        </td>
      `;
    }
    
    bodyHtml += `
        <td style="padding:6px;border:1px solid #e2e8f0;text-align:center;font-weight:bold;background:#fef9c3" id="score-entree-${idx}">${pctEntree}%</td>
        <td style="padding:6px;border:1px solid #e2e8f0;text-align:center;font-weight:bold;color:#dc2626" id="ecart-entree-${idx}">${100 - pctEntree}%</td>
        <td style="padding:6px;border:1px solid #e2e8f0;text-align:center" id="note-entree-${idx}">${Math.round(pctEntree / 5)}</td>
        <td style="padding:6px;border:1px solid #e2e8f0;text-align:center" rowspan="2" id="succes-${idx}">
          <span style="font-size:1.2em">${succes ? '‚úÖ' : '‚ö†Ô∏è'}</span>
        </td>
        <td style="padding:6px;border:1px solid #e2e8f0;text-align:center" rowspan="2">
          <button type="button" onclick="supprimerStagiaire(${idx})" style="background:#dc2626;color:white;border:none;border-radius:4px;padding:4px 8px;cursor:pointer">üóëÔ∏è</button>
        </td>
      </tr>
    `;
    
    // Ligne SORTIE
    bodyHtml += `
      <tr style="background:#d1fae5" data-stagiaire="${idx}" data-type="sortie">
        <td style="padding:6px;border:1px solid #e2e8f0;font-weight:bold;background:#16a34a;color:white;text-align:center">Sortie</td>
        <td style="padding:6px;border:1px solid #e2e8f0;text-align:center;color:#64748b">S${idx+1}</td>
        <td style="padding:6px;border:1px solid #e2e8f0;color:#64748b;font-style:italic">${esc(st.nom) || '(m√™me stagiaire)'}</td>
        <td style="padding:4px;border:1px solid #e2e8f0">
          <input type="date" id="date-sortie-${idx}" style="width:100%;padding:2px;border:1px solid #d1d5db;border-radius:4px;font-size:0.8em">
        </td>
    `;
    
    // Cases des questions SORTIE
    for (let q = 0; q < nbQuestions; q++) {
      const checked = st.sortie[q] === 1;
      bodyHtml += `
        <td style="padding:2px;border:1px solid #e2e8f0;text-align:center;cursor:pointer;background:${checked ? '#dcfce7' : '#fee2e2'}" 
            onclick="toggleReponse(${idx}, 'sortie', ${q})">
          <span style="font-weight:bold;color:${checked ? '#16a34a' : '#dc2626'}">${checked ? '1' : '0'}</span>
        </td>
      `;
    }
    
    bodyHtml += `
        <td style="padding:6px;border:1px solid #e2e8f0;text-align:center;font-weight:bold;background:#bbf7d0" id="score-sortie-${idx}">${pctSortie}%</td>
        <td style="padding:6px;border:1px solid #e2e8f0;text-align:center;font-weight:bold;color:#16a34a" id="ecart-sortie-${idx}">+${ecart}%</td>
        <td style="padding:6px;border:1px solid #e2e8f0;text-align:center;font-weight:bold" id="note-sortie-${idx}">${noteSur20}</td>
      </tr>
    `;
    
    // Ligne pourcentages (optionnelle, comme dans le Google Sheets)
    bodyHtml += `
      <tr style="background:#f1f5f9;font-size:0.7em;color:#64748b" data-stagiaire="${idx}" data-type="pct">
        <td colspan="4" style="border:1px solid #e2e8f0;padding:2px;text-align:right">% par question:</td>
    `;
    for (let q = 0; q < nbQuestions; q++) {
      const pctQ = st.sortie[q] === 1 ? '100%' : '0%';
      bodyHtml += `<td style="border:1px solid #e2e8f0;padding:2px;text-align:center">${pctQ}</td>`;
    }
    bodyHtml += `<td colspan="4" style="border:1px solid #e2e8f0"></td></tr>`;
  });
  
  tbody.innerHTML = bodyHtml;
  
  // Mettre √† jour le r√©sum√©
  const resume = document.getElementById('eval-resume');
  if (resume) {
    const validStagiaires = evalSessionStagiaires.filter(s => s.nom).length;
    resume.textContent = `${validStagiaires} stagiaire(s) saisi(s)`;
  }
}

// Toggle une r√©ponse (0 <-> 1)
function toggleReponse(stagiaireIdx, type, questionIdx) {
  const st = evalSessionStagiaires[stagiaireIdx];
  if (!st) return;
  
  if (type === 'entree') {
    st.entree[questionIdx] = st.entree[questionIdx] === 1 ? 0 : 1;
  } else {
    st.sortie[questionIdx] = st.sortie[questionIdx] === 1 ? 0 : 1;
  }
  
  // Recalculer et rafra√Æchir la grille
  genererGrilleEvaluation();
}

// Mettre √† jour le nom du stagiaire
function updateStagiaireNom(idx, nom) {
  if (evalSessionStagiaires[idx]) {
    evalSessionStagiaires[idx].nom = nom;
  }
  
  // Mettre √† jour le r√©sum√©
  const resume = document.getElementById('eval-resume');
  if (resume) {
    const validStagiaires = evalSessionStagiaires.filter(s => s.nom).length;
    resume.textContent = `${validStagiaires} stagiaire(s) saisi(s)`;
  }
}

// Ajouter un stagiaire
function ajouterLigneStagiaire() {
  const nbQuestions = evalSessionQuestions.length || parseInt(document.getElementById('eval-nb-questions')?.value) || 10;
  evalSessionStagiaires.push({
    nom: '',
    entree: new Array(nbQuestions).fill(0),
    sortie: new Array(nbQuestions).fill(0)
  });
  genererGrilleEvaluation();
}

// Supprimer un stagiaire
function supprimerStagiaire(idx) {
  if (evalSessionStagiaires.length <= 1) {
    toast('‚ö†Ô∏è Au moins un stagiaire requis', 'warning');
    return;
  }
  evalSessionStagiaires.splice(idx, 1);
  genererGrilleEvaluation();
}

// Toggle √©dition des questions
function toggleQuestionsEdit() {
  const list = document.getElementById('eval-questions-list');
  const isEditing = list.querySelector('input');
  
  if (isEditing) {
    // Sauvegarder les modifications
    const inputs = list.querySelectorAll('input');
    inputs.forEach((input, i) => {
      if (evalSessionQuestions[i]) {
        evalSessionQuestions[i].question = input.value;
      }
    });
    
    // Revenir √† l'affichage
    list.innerHTML = evalSessionQuestions.map((q, i) => `
      <div style="padding:5px 8px;background:white;border-radius:4px;border-left:3px solid #f59e0b">
        <strong>Q${i+1}:</strong> ${esc(trunc(q.question, 50))}
      </div>
    `).join('');
    
    genererGrilleEvaluation();
  } else {
    // Passer en mode √©dition
    list.innerHTML = evalSessionQuestions.map((q, i) => `
      <div style="display:flex;align-items:center;gap:5px;margin-bottom:5px">
        <strong style="min-width:30px">Q${i+1}:</strong>
        <input type="text" value="${esc(q.question)}" style="flex:1;padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:0.85em">
      </div>
    `).join('');
  }
}

// Sauvegarder l'√©valuation compl√®te
async function saveEvalSessionGrille() {
  const ref = document.getElementById('eval-ref')?.value;
  const entreprise = document.getElementById('eval-entreprise')?.value;
  const formation = document.getElementById('eval-formation')?.value;
  const dateDebut = document.getElementById('eval-date-debut')?.value;
  const dateFin = document.getElementById('eval-date-fin')?.value;
  
  if (!ref || !entreprise || !formation) {
    toast('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires', 'warning');
    return;
  }
  
  const stagiairesValides = evalSessionStagiaires.filter(s => s.nom);
  if (stagiairesValides.length === 0) {
    toast('‚ö†Ô∏è Ajoutez au moins un stagiaire', 'warning');
    return;
  }
  
  const nbQuestions = evalSessionQuestions.length || 10;
  
  // Sauvegarder les questions si nouvelles
  for (const q of evalSessionQuestions) {
    if (!q.id || typeof q.id !== 'number' || q.id < 100) {
      try {
        await dbAdd('ecarts_questions', {
          formation: formation,
          question: q.question,
          type: 'QCM',
          options: [],
          bonneReponse: 1
        });
      } catch(e) {}
    }
  }
  
  // Sauvegarder les √©valuations
  let saved = 0;
  for (let i = 0; i < stagiairesValides.length; i++) {
    const st = stagiairesValides[i];
    const scoreEntree = Math.round(st.entree.filter(v => v === 1).length / nbQuestions * 100);
    const scoreSortie = Math.round(st.sortie.filter(v => v === 1).length / nbQuestions * 100);
    
    const dateEntreeInput = document.getElementById(`date-entree-${evalSessionStagiaires.indexOf(st)}`);
    const dateSortieInput = document.getElementById(`date-sortie-${evalSessionStagiaires.indexOf(st)}`);
    
    try {
      await dbAdd('ecarts_evaluations', {
        sessionRef: ref,
        entreprise: entreprise,
        formation: formation,
        dateDebut: dateEntreeInput?.value || dateDebut,
        dateFin: dateSortieInput?.value || dateFin,
        stagiaire: st.nom,
        scoreEntree: scoreEntree,
        scoreSortie: scoreSortie,
        progression: scoreSortie - scoreEntree,
        succes: scoreSortie >= 70,
        reponsesEntree: [...st.entree],
        reponsesSortie: [...st.sortie],
        nbQuestions: nbQuestions
      });
      saved++;
    } catch(e) {
      console.warn('Erreur sauvegarde:', e);
    }
  }
  
  toast(`‚úÖ √âvaluation enregistr√©e: ${saved} stagiaire(s)`, 'success');
  document.getElementById('modal-eval-session')?.remove();
  loadEcartsSessions();
}

// Bilan global
async function loadBilanEcarts() {
  try {
    const evaluations = await dbGetAll('ecarts_evaluations');
    
    // Grouper par formation
    const formationsMap = {};
    evaluations.forEach(e => {
      if (!formationsMap[e.formation]) {
        formationsMap[e.formation] = { formation: e.formation, sessions: new Set(), stagiaires: [], totalEntree: 0, totalSortie: 0 };
      }
      formationsMap[e.formation].sessions.add(e.sessionRef);
      formationsMap[e.formation].stagiaires.push(e);
      formationsMap[e.formation].totalEntree += e.scoreEntree || 0;
      formationsMap[e.formation].totalSortie += e.scoreSortie || 0;
    });
    
    const tbody = document.getElementById('table-bilan-formations');
    if (tbody) {
      if (Object.keys(formationsMap).length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#64748b">Aucune donn√©e disponible</td></tr>';
      } else {
        tbody.innerHTML = Object.values(formationsMap).map(f => {
          const nbStagiaires = f.stagiaires.length;
          const moyEntree = Math.round(f.totalEntree / nbStagiaires);
          const moySortie = Math.round(f.totalSortie / nbStagiaires);
          const progression = moySortie - moyEntree;
          const tauxReussite = Math.round(f.stagiaires.filter(s => s.scoreSortie >= 70).length / nbStagiaires * 100);
          
          return `
          <tr>
            <td style="max-width:200px">${esc(trunc(f.formation, 40))}</td>
            <td style="text-align:center">${f.sessions.size}</td>
            <td style="text-align:center">${nbStagiaires}</td>
            <td style="text-align:center;color:#f59e0b;font-weight:600">${moyEntree}%</td>
            <td style="text-align:center;color:#16a34a;font-weight:600">${moySortie}%</td>
            <td style="text-align:center"><span style="background:${progression >= 30 ? '#16a34a' : '#f59e0b'};color:white;padding:3px 10px;border-radius:20px;font-weight:600">+${progression}%</span></td>
            <td style="text-align:center;font-weight:600;color:${tauxReussite >= 80 ? '#16a34a' : '#f59e0b'}">${tauxReussite}%</td>
          </tr>
        `}).join('');
      }
    }
    
    // Graphiques simples (barres ASCII-like)
    renderChartProgressionFormation(formationsMap);
  } catch (e) {
    console.warn('Erreur bilan √©carts:', e);
  }
}

function renderChartProgressionFormation(formationsMap) {
  const container = document.getElementById('chart-progression-formation');
  if (!container) return;
  
  const formations = Object.values(formationsMap);
  if (!formations.length) {
    container.innerHTML = '<div style="text-align:center;color:#64748b;padding:40px">Aucune donn√©e</div>';
    return;
  }
  
  container.innerHTML = formations.map(f => {
    const nbStagiaires = f.stagiaires.length;
    const moyEntree = Math.round(f.totalEntree / nbStagiaires);
    const moySortie = Math.round(f.totalSortie / nbStagiaires);
    
    return `
    <div style="margin-bottom:15px">
      <div style="font-size:0.85em;margin-bottom:5px;color:#475569">${esc(trunc(f.formation, 35))}</div>
      <div style="display:flex;align-items:center;gap:10px">
        <div style="flex:1;height:20px;background:#e2e8f0;border-radius:4px;overflow:hidden;position:relative">
          <div style="position:absolute;left:0;top:0;height:100%;width:${moyEntree}%;background:#f59e0b;opacity:0.6"></div>
          <div style="position:absolute;left:0;top:0;height:100%;width:${moySortie}%;background:#16a34a;opacity:0.8"></div>
        </div>
        <div style="font-size:0.8em;min-width:80px">
          <span style="color:#f59e0b">${moyEntree}%</span> ‚Üí <span style="color:#16a34a">${moySortie}%</span>
        </div>
      </div>
    </div>
  `}).join('');
}

// Import donn√©es d√©mo
async function importerDonneesEcartsDemo() {
  if (!confirm('Importer les donn√©es de d√©monstration (session ANDIAMO) ?')) return;
  
  toast('üì• Import en cours...', 'info');
  
  // Questions de d√©monstration
  const questions = [
    { formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', question: 'O√π me rendre pour afficher ma base de donn√©es clients ?', type: 'QCM', options: ['Menu Clients', 'Menu Param√®tres', 'Menu Dashboard', 'Menu Aide'], bonneReponse: 1 },
    { formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', question: 'O√π dois-je modifier les horaires de mon site ?', type: 'QCM', options: ['Param√®tres > Horaires', 'Dashboard', 'Menu Principal', 'Aide'], bonneReponse: 1 },
    { formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', question: 'O√π dois-je me rendre pour modifier mes produits ?', type: 'QCM', options: ['Menu Produits', 'Param√®tres', 'Dashboard', 'Statistiques'], bonneReponse: 1 },
    { formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', question: 'Comment g√©n√©rer mes rapports de vente ?', type: 'QCM', options: ['Statistiques > Rapports', 'Dashboard', 'Menu Ventes', 'Exporter'], bonneReponse: 1 },
    { formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', question: 'Quelle proc√©dure suivre pour rembourser un client ?', type: 'QCM', options: ['Commandes > Remboursement', 'Clients > Cr√©dit', 'Param√®tres', 'Support'], bonneReponse: 1 },
    { formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', question: 'Comment d√©sactiver les produits que je n\'ai plus ?', type: 'QCM', options: ['Produits > D√©sactiver', 'Supprimer', 'Archiver', 'Cacher'], bonneReponse: 1 },
    { formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', question: 'Comment je retire un produit des compositions de menu ?', type: 'QCM', options: ['Menus > Modifier composition', 'Produits > Retirer', 'Supprimer', '√âditer'], bonneReponse: 1 },
    { formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', question: 'Comment effectuer une r√©duction sur un produit ?', type: 'QCM', options: ['Promotions > R√©duction', 'Prix > Modifier', 'Remise directe', 'Code promo'], bonneReponse: 1 },
    { formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', question: 'Comment changer les tarifs selon l\'horaire ?', type: 'QCM', options: ['Tarification horaire', 'Prix dynamique', 'Promotions', 'Planning'], bonneReponse: 1 },
    { formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', question: 'Comment configurer le questionnaire de satisfaction ?', type: 'QCM', options: ['Param√®tres > Satisfaction', 'Clients', 'Dashboard', 'Support'], bonneReponse: 1 }
  ];
  
  // √âvaluations session ANDIAMO
  const evaluations = [
    { sessionRef: '24-001', entreprise: 'ANDIAMO', formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', dateDebut: '2024-03-28', dateFin: '2024-03-29', stagiaire: 'SID Abdeljabar', scoreEntree: 40, scoreSortie: 100, reponsesEntree: [1,0,0,0,1,1,1,0,0,0], reponsesSortie: [1,1,1,1,1,1,1,1,1,1] },
    { sessionRef: '24-001', entreprise: 'ANDIAMO', formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', dateDebut: '2024-03-28', dateFin: '2024-03-29', stagiaire: 'HAMMALI Messaoud', scoreEntree: 50, scoreSortie: 100, reponsesEntree: [1,0,0,1,1,0,0,0,1,1], reponsesSortie: [1,1,1,1,1,1,1,1,1,1] },
    { sessionRef: '24-001', entreprise: 'ANDIAMO', formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', dateDebut: '2024-03-28', dateFin: '2024-03-29', stagiaire: 'HAMMALI Mohamed', scoreEntree: 70, scoreSortie: 100, reponsesEntree: [1,0,0,1,1,1,0,1,1,1], reponsesSortie: [1,1,1,1,1,1,1,1,1,1] },
    { sessionRef: '24-001', entreprise: 'ANDIAMO', formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', dateDebut: '2024-03-28', dateFin: '2024-03-29', stagiaire: 'TARCHOUL Salim', scoreEntree: 80, scoreSortie: 90, reponsesEntree: [1,1,0,0,1,1,1,1,1,1], reponsesSortie: [1,1,0,1,1,1,1,1,1,1] },
    { sessionRef: '24-001', entreprise: 'ANDIAMO', formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', dateDebut: '2024-03-28', dateFin: '2024-03-29', stagiaire: 'DAKHLI Zied', scoreEntree: 30, scoreSortie: 80, reponsesEntree: [0,0,1,1,1,0,0,0,0,0], reponsesSortie: [0,1,1,1,1,0,1,1,1,1] },
    { sessionRef: '24-001', entreprise: 'ANDIAMO', formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', dateDebut: '2024-03-28', dateFin: '2024-03-29', stagiaire: 'BEN AOUN Abderrazag', scoreEntree: 70, scoreSortie: 100, reponsesEntree: [1,0,1,1,0,1,0,1,1,1], reponsesSortie: [1,1,1,1,1,1,1,1,1,1] },
    { sessionRef: '24-001', entreprise: 'ANDIAMO', formation: 'Piloter votre application mobile android ou IOS DCWEBAPS de commande', dateDebut: '2024-03-28', dateFin: '2024-03-29', stagiaire: 'GUIZA AHMED Radhi', scoreEntree: 50, scoreSortie: 80, reponsesEntree: [1,1,0,0,1,1,1,0,0,0], reponsesSortie: [1,1,0,0,1,1,1,1,1,1] }
  ];
  
  // Ajouter progression et succ√®s
  evaluations.forEach(e => {
    e.progression = e.scoreSortie - e.scoreEntree;
    e.succes = e.scoreSortie >= 70;
  });
  
  // Importer
  let qCount = 0, eCount = 0;
  for (const q of questions) {
    try { await dbAdd('ecarts_questions', q); qCount++; } catch(e) {}
  }
  for (const e of evaluations) {
    try { await dbAdd('ecarts_evaluations', e); eCount++; } catch(e) {}
  }
  
  toast(`‚úÖ Import termin√©: ${qCount} questions, ${eCount} √©valuations`, 'success');
  loadEcartsSessions();
}

async function importerQuestionsDemo() {
  await importerDonneesEcartsDemo();
  showEcartsTab('questions');
}

// Export
async function exporterBilanEcarts() {
  const evaluations = await dbGetAll('ecarts_evaluations');
  if (!evaluations.length) {
    toast('‚ùå Aucune donn√©e √† exporter', 'error');
    return;
  }
  
  let csv = 'Ref Session;Entreprise;Formation;Date Debut;Date Fin;Stagiaire;Score Entree;Score Sortie;Progression;Succes\n';
  
  evaluations.forEach(e => {
    csv += `${e.sessionRef};${e.entreprise};${e.formation};${e.dateDebut};${e.dateFin};${e.stagiaire};${e.scoreEntree}%;${e.scoreSortie}%;+${e.progression}%;${e.succes ? 'Oui' : 'Non'}\n`;
  });
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `bilan_ecarts_competences_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('üìä Bilan export√©', 'success');
}

async function exporterSessionEcarts(sessionRef) {
  const evaluations = await dbGetAll('ecarts_evaluations');
  const sessionEvals = evaluations.filter(e => e.sessionRef === sessionRef);
  
  if (!sessionEvals.length) return;
  
  let csv = `Session ${sessionRef} - ${sessionEvals[0].entreprise}\n`;
  csv += `Formation: ${sessionEvals[0].formation}\n`;
  csv += `Dates: ${sessionEvals[0].dateDebut} - ${sessionEvals[0].dateFin}\n\n`;
  csv += 'N;Stagiaire;Score Entree;Score Sortie;Progression;Succes\n';
  
  sessionEvals.forEach((e, i) => {
    csv += `S${i+1};${e.stagiaire};${e.scoreEntree}%;${e.scoreSortie}%;+${e.progression}%;${e.succes ? 'Oui' : 'Non'}\n`;
  });
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ecarts_${sessionRef}_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('üìä Session export√©e', 'success');
}

function genererRapportEcarts() {
  toast('üìÑ Fonctionnalit√© PDF en cours de d√©veloppement', 'info');
}

// ============ MODULE AIDAR ============
// Al√©as, Incidents, Difficult√©s, Accidents, R√©clamations

// Toggle d√©finitions et matrice
function toggleAIdarDefinitions() {
  const el = document.getElementById('aidar-definitions');
  const toggle = document.getElementById('aidar-def-toggle');
  if (el.style.display === 'none') {
    el.style.display = 'grid';
    toggle.textContent = '‚ñº';
  } else {
    el.style.display = 'none';
    toggle.textContent = '‚ñ∂';
  }
}

function toggleAIdarMatrice() {
  const el = document.getElementById('aidar-matrice');
  const toggle = document.getElementById('aidar-matrice-toggle');
  if (el.style.display === 'none') {
    el.style.display = 'block';
    toggle.textContent = '‚ñº';
  } else {
    el.style.display = 'none';
    toggle.textContent = '‚ñ∂';
  }
}

// Charger et afficher les KPIs AIDAR
async function loadAIDARKPIs() {
  try {
    const data = await dbGetAll('aidar');
    const total = data.length;
    const mineur = data.filter(d => d.type && d.type.includes('Mineure')).length;
    const majeur = data.filter(d => d.type && d.type.includes('Majeure')).length;
    const finalise = data.filter(d => d.statut === 'Action finalis√©e').length;
    const encours = total - finalise;
    
    // Calcul d√©lai moyen
    const avecDelai = data.filter(d => d.dateRealisation && d.datePriseDecision);
    let delaiMoyen = 0;
    if (avecDelai.length > 0) {
      const totalDelai = avecDelai.reduce((sum, d) => {
        const debut = new Date(d.datePriseDecision);
        const fin = new Date(d.dateRealisation);
        return sum + Math.max(0, Math.ceil((fin - debut) / (1000 * 60 * 60 * 24)));
      }, 0);
      delaiMoyen = Math.round(totalDelai / avecDelai.length);
    }
    
    document.getElementById('kpi-aidar-total').textContent = total;
    document.getElementById('kpi-aidar-mineur').textContent = mineur;
    document.getElementById('kpi-aidar-majeur').textContent = majeur;
    document.getElementById('kpi-aidar-finalise').textContent = finalise;
    document.getElementById('kpi-aidar-encours').textContent = encours;
    document.getElementById('kpi-aidar-delai').textContent = `${delaiMoyen}j`;
  } catch (e) {
    console.warn('Erreur KPIs AIDAR:', e);
  }
}

// Charger et afficher le tableau AIDAR
async function loadAIDAR() {
  try {
    const data = await dbGetAll('aidar');
    renderAIDARTable(data);
    loadAIDARKPIs();
  } catch (e) {
    console.warn('Erreur chargement AIDAR:', e);
    renderAIDARTable([]);
  }
}

function renderAIDARTable(data) {
  const tbody = document.getElementById('table-aidar');
  if (!tbody) return;
  
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="15" class="empty-state">
      <div class="empty-state-icon">üìã</div>
      <h3>Aucun enregistrement AIDAR</h3>
      <p>Cliquez sur "üì• Importer donn√©es initiales" pour charger les donn√©es du fichier AIDAR existant</p>
    </td></tr>`;
    return;
  }
  
  // Trier par date d√©croissante
  data.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
  
  tbody.innerHTML = data.map(d => {
    const isMineure = d.type && d.type.includes('Mineure');
    const typeClass = isMineure ? 'status-en-attente' : 'status-inactif';
    const ncValue = d.evaluationNC || 0;
    const ncColor = ncValue >= 12 ? '#dc2626' : ncValue >= 8 ? '#f59e0b' : ncValue >= 4 ? '#eab308' : '#22c55e';
    const prioriteColors = { 'Maximale': '#dc2626', 'Moyenne': '#f59e0b', 'Faible': '#22c55e' };
    const statutFinalise = d.statut === 'Action finalis√©e';
    
    return `
    <tr style="${!statutFinalise ? 'background:#fefce8' : ''}">
      <td><code>AIDAR-${String(d.numero || d.id).padStart(3,'0')}</code></td>
      <td>${fmtDate(d.date)}</td>
      <td><strong>${esc(d.nom || '-')}</strong><br><small style="color:#64748b">${esc(d.reference || '')}</small></td>
      <td><span style="font-size:0.8em">${esc(d.qualite || '-')}</span></td>
      <td><span class="status ${typeClass}" style="font-size:0.7em">${isMineure ? 'NC Mineure' : 'NC Majeure'}</span></td>
      <td><span style="font-size:0.75em;padding:2px 6px;background:#f1f5f9;border-radius:4px">${esc(d.categorie || '-')}</span></td>
      <td style="max-width:200px"><span title="${esc(d.description || '')}">${trunc(d.description, 40)}</span></td>
      <td style="text-align:center"><span style="display:inline-block;padding:4px 8px;background:${ncColor};color:white;border-radius:4px;font-weight:bold;font-size:0.85em">${ncValue}</span></td>
      <td style="max-width:150px;font-size:0.8em">${trunc(d.actionsImmediates, 35)}</td>
      <td><span class="status status-${d.evaluationReponse === 'Bonne' ? 'actif' : d.evaluationReponse === 'Moyenne' ? 'en-attente' : 'inactif'}" style="font-size:0.7em">${d.evaluationReponse || '-'}</span></td>
      <td style="max-width:150px;font-size:0.8em">${trunc(d.planActions, 35)}</td>
      <td><span style="color:${prioriteColors[d.prioriteAction] || '#64748b'};font-weight:500">${d.prioriteAction || '-'}</span></td>
      <td>${esc(d.responsable || '-')}</td>
      <td><span class="status ${statutFinalise ? 'status-actif' : 'status-en-cours'}">${statutFinalise ? '‚úÖ Finalis√©e' : 'üîÑ En cours'}</span></td>
      <td class="action-btns">
        <button class="btn btn-info btn-icon" onclick="voirAIDAR(${d.id})" title="Voir d√©tails">üëÅÔ∏è</button>
        <button class="btn btn-secondary btn-icon" onclick="openModalAIDAR(${d.id})" title="Modifier">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-icon" onclick="confirmDelete('aidar',${d.id})" title="Supprimer">üóëÔ∏è</button>
      </td>
    </tr>
  `}).join('');
}

// Filtrage AIDAR
async function filterAIDAR() {
  const searchTerm = (document.getElementById('search-aidar')?.value || '').toLowerCase();
  const typeFilter = document.getElementById('filter-aidar-type')?.value || '';
  const categorieFilter = document.getElementById('filter-aidar-categorie')?.value || '';
  const statutFilter = document.getElementById('filter-aidar-statut')?.value || '';
  const anneeFilter = document.getElementById('filter-aidar-annee')?.value || '';
  
  try {
    let data = await dbGetAll('aidar');
    
    if (searchTerm) {
      data = data.filter(d => 
        (d.nom || '').toLowerCase().includes(searchTerm) ||
        (d.reference || '').toLowerCase().includes(searchTerm) ||
        (d.description || '').toLowerCase().includes(searchTerm) ||
        (d.responsable || '').toLowerCase().includes(searchTerm)
      );
    }
    
    if (typeFilter) {
      data = data.filter(d => d.type && d.type.includes(typeFilter));
    }
    
    if (categorieFilter) {
      data = data.filter(d => d.categorie === categorieFilter);
    }
    
    if (statutFilter) {
      data = data.filter(d => d.statut === statutFilter);
    }
    
    if (anneeFilter) {
      data = data.filter(d => {
        const annee = new Date(d.date).getFullYear().toString();
        return annee === anneeFilter;
      });
    }
    
    renderAIDARTable(data);
  } catch (e) {
    console.warn('Erreur filtrage AIDAR:', e);
  }
}

// Modal AIDAR
async function openModalAIDAR(id = null) {
  let aidar = null;
  if (id) {
    aidar = await dbGet('aidar', id);
  }
  
  const modalHtml = `
    <div id="modal-aidar" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:800px">
        <div class="modal-header" style="background:linear-gradient(135deg,#1e40af,#7c3aed)">
          <h3 class="modal-title">üìã ${id ? 'Modifier' : 'Nouvel'} AIDAR</h3>
          <button class="modal-close" onclick="fermerModalAIDAR()">‚úï</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow-y:auto">
          <form id="form-aidar" onsubmit="saveAIDAR(${id || 'null'});return false">
            <!-- Identification -->
            <div style="background:#f8fafc;padding:15px;border-radius:8px;margin-bottom:15px">
              <h4 style="margin:0 0 10px 0;color:#475569">Identification</h4>
              <div class="form-row">
                <div class="form-group"><label>Date *</label><input type="date" class="form-input" id="aidar-date" value="${aidar?.date?.split('T')[0] || new Date().toISOString().split('T')[0]}" required></div>
                <div class="form-group"><label>N¬∞ d'ordre</label><input type="number" class="form-input" id="aidar-numero" value="${aidar?.numero || ''}" placeholder="Auto"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Nom / Source *</label><input type="text" class="form-input" id="aidar-nom" value="${esc(aidar?.nom || '')}" required placeholder="Ex: D√©calage formation, Auditrice..."></div>
                <div class="form-group"><label>Qualit√©</label><select class="form-select" id="aidar-qualite">
                  <option value="">-- S√©lectionner --</option>
                  <option ${aidar?.qualite === 'Auditrice' ? 'selected' : ''}>Auditrice</option>
                  <option ${aidar?.qualite === 'Donneur d\'ordre' ? 'selected' : ''}>Donneur d'ordre</option>
                  <option ${aidar?.qualite === 'Formateur' ? 'selected' : ''}>Formateur</option>
                  <option ${aidar?.qualite === 'gestion administrative' ? 'selected' : ''}>gestion administrative</option>
                  <option ${aidar?.qualite === 'Stagiaire' ? 'selected' : ''}>Stagiaire</option>
                  <option ${aidar?.qualite === 'Responsable Administratif' ? 'selected' : ''}>Responsable Administratif</option>
                </select></div>
              </div>
              <div class="form-group"><label>R√©f√©rence</label><input type="text" class="form-input" id="aidar-reference" value="${esc(aidar?.reference || '')}" placeholder="Ex: Formation devis N¬∞24, Audit du 28-03-2022..."></div>
            </div>
            
            <!-- Classification -->
            <div style="background:#fef3c7;padding:15px;border-radius:8px;margin-bottom:15px">
              <h4 style="margin:0 0 10px 0;color:#92400e">Classification</h4>
              <div class="form-row">
                <div class="form-group"><label>Type AIDAR *</label><select class="form-select" id="aidar-type" required>
                  <option value="">-- S√©lectionner --</option>
                  <option ${aidar?.type?.includes('Mineure') ? 'selected' : ''} value="Non confirmit√© Mineure (Al√©as, difficult√©s, Incidents,)">NC Mineure (Al√©as, Difficult√©s, Incidents)</option>
                  <option ${aidar?.type?.includes('Majeure') ? 'selected' : ''} value="Non confirmit√© Majeure (R√©clamtion ; Accident)">NC Majeure (R√©clamation, Accident)</option>
                </select></div>
                <div class="form-group"><label>Cat√©gorie *</label><select class="form-select" id="aidar-categorie" required>
                  <option value="">-- S√©lectionner --</option>
                  <option ${aidar?.categorie === '1 -Information' ? 'selected' : ''}>1 -Information</option>
                  <option ${aidar?.categorie === '2 - Conception' ? 'selected' : ''}>2 - Conception</option>
                  <option ${aidar?.categorie === '3 - Prestation' ? 'selected' : ''}>3 - Prestation</option>
                  <option ${aidar?.categorie === '4 - Moyens' ? 'selected' : ''}>4 - Moyens</option>
                  <option ${aidar?.categorie === '5 - Comp√©tences' ? 'selected' : ''}>5 - Comp√©tences</option>
                  <option ${aidar?.categorie === '6 - Environnement' ? 'selected' : ''}>6 - Environnement</option>
                  <option ${aidar?.categorie === '7 - Am√©lioration' ? 'selected' : ''}>7 - Am√©lioration</option>
                </select></div>
              </div>
              <div class="form-group"><label>Description AIDAR *</label><textarea class="form-textarea" id="aidar-description" rows="2" required>${esc(aidar?.description || '')}</textarea></div>
            </div>
            
            <!-- √âvaluation -->
            <div style="background:#dbeafe;padding:15px;border-radius:8px;margin-bottom:15px">
              <h4 style="margin:0 0 10px 0;color:#1e40af">√âvaluation (G x F = NC)</h4>
              <div class="form-row">
                <div class="form-group"><label>Gravit√© (G) 1-4</label><input type="number" class="form-input" id="aidar-g" min="1" max="4" value="${aidar?.g || 2}" onchange="calculerNC()"></div>
                <div class="form-group"><label>Fr√©quence (F) 1-4</label><input type="number" class="form-input" id="aidar-f" min="1" max="4" value="${aidar?.f || 4}" onchange="calculerNC()"></div>
                <div class="form-group"><label>√âval. NC</label><input type="number" class="form-input" id="aidar-nc" value="${aidar?.evaluationNC || 8}" readonly style="background:#f1f5f9;font-weight:bold"></div>
              </div>
            </div>
            
            <!-- Actions -->
            <div style="background:#dcfce7;padding:15px;border-radius:8px;margin-bottom:15px">
              <h4 style="margin:0 0 10px 0;color:#166534">Actions</h4>
              <div class="form-group"><label>Actions imm√©diates</label><textarea class="form-textarea" id="aidar-actions-immediates" rows="2">${esc(aidar?.actionsImmediates || '')}</textarea></div>
              <div class="form-row">
                <div class="form-group"><label>√âval. 1√®re r√©ponse</label><select class="form-select" id="aidar-eval-reponse">
                  <option value="">-- S√©lectionner --</option>
                  <option ${aidar?.evaluationReponse === 'Bonne' ? 'selected' : ''}>Bonne</option>
                  <option ${aidar?.evaluationReponse === 'Moyenne' ? 'selected' : ''}>Moyenne</option>
                  <option ${aidar?.evaluationReponse === 'Insuffisante' ? 'selected' : ''}>Insuffisante</option>
                </select></div>
                <div class="form-group"><label>Priorit√©</label><select class="form-select" id="aidar-priorite">
                  <option ${aidar?.prioriteAction === 'Faible' ? 'selected' : ''}>Faible</option>
                  <option ${aidar?.prioriteAction === 'Moyenne' ? 'selected' : ''}>Moyenne</option>
                  <option ${aidar?.prioriteAction === 'Maximale' ? 'selected' : ''}>Maximale</option>
                </select></div>
              </div>
              <div class="form-group"><label>Plan d'actions √† mettre en place</label><textarea class="form-textarea" id="aidar-plan-actions" rows="2">${esc(aidar?.planActions || '')}</textarea></div>
              <div class="form-row">
                <div class="form-group"><label>Responsable</label><input type="text" class="form-input" id="aidar-responsable" value="${esc(aidar?.responsable || 'Boumelassa')}"></div>
                <div class="form-group"><label>Date prise d√©cision</label><input type="date" class="form-input" id="aidar-date-decision" value="${aidar?.datePriseDecision?.split('T')[0] || ''}"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Date pr√©visionnelle</label><input type="date" class="form-input" id="aidar-date-previsionnelle" value="${aidar?.datePrevisionnelle?.split('T')[0] || ''}"></div>
                <div class="form-group"><label>Date r√©alisation</label><input type="date" class="form-input" id="aidar-date-realisation" value="${aidar?.dateRealisation?.split('T')[0] || ''}"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label>Crit√®re d'efficacit√©</label><input type="text" class="form-input" id="aidar-critere-efficacite" value="${esc(aidar?.critereEfficacite || '')}"></div>
                <div class="form-group"><label>Statut</label><select class="form-select" id="aidar-statut">
                  <option ${aidar?.statut === 'En cours' ? 'selected' : ''}>En cours</option>
                  <option ${aidar?.statut === 'Action finalis√©e' ? 'selected' : ''}>Action finalis√©e</option>
                </select></div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="fermerModalAIDAR()">Annuler</button>
          <button type="submit" form="form-aidar" class="btn btn-primary">üíæ Enregistrer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function fermerModalAIDAR() {
  document.getElementById('modal-aidar')?.remove();
}

function calculerNC() {
  const g = parseInt(document.getElementById('aidar-g')?.value) || 1;
  const f = parseInt(document.getElementById('aidar-f')?.value) || 1;
  document.getElementById('aidar-nc').value = g * f;
}

async function saveAIDAR(id) {
  const data = {
    date: document.getElementById('aidar-date')?.value || new Date().toISOString(),
    numero: parseInt(document.getElementById('aidar-numero')?.value) || null,
    nom: document.getElementById('aidar-nom')?.value || '',
    qualite: document.getElementById('aidar-qualite')?.value || '',
    reference: document.getElementById('aidar-reference')?.value || '',
    type: document.getElementById('aidar-type')?.value || '',
    categorie: document.getElementById('aidar-categorie')?.value || '',
    description: document.getElementById('aidar-description')?.value || '',
    g: parseInt(document.getElementById('aidar-g')?.value) || 2,
    f: parseInt(document.getElementById('aidar-f')?.value) || 4,
    evaluationNC: parseInt(document.getElementById('aidar-nc')?.value) || 8,
    actionsImmediates: document.getElementById('aidar-actions-immediates')?.value || '',
    evaluationReponse: document.getElementById('aidar-eval-reponse')?.value || '',
    prioriteAction: document.getElementById('aidar-priorite')?.value || 'Faible',
    planActions: document.getElementById('aidar-plan-actions')?.value || '',
    responsable: document.getElementById('aidar-responsable')?.value || 'Boumelassa',
    datePriseDecision: document.getElementById('aidar-date-decision')?.value || null,
    datePrevisionnelle: document.getElementById('aidar-date-previsionnelle')?.value || null,
    dateRealisation: document.getElementById('aidar-date-realisation')?.value || null,
    critereEfficacite: document.getElementById('aidar-critere-efficacite')?.value || '',
    statut: document.getElementById('aidar-statut')?.value || 'En cours'
  };
  
  if (id) {
    data.id = id;
    await dbPut('aidar', data);
    toast('‚úÖ AIDAR mis √† jour', 'success');
  } else {
    // Auto-num√©rotation
    const existing = await dbGetAll('aidar');
    data.numero = Math.max(0, ...existing.map(e => e.numero || 0)) + 1;
    await dbAdd('aidar', data);
    toast('‚úÖ AIDAR cr√©√©', 'success');
  }
  
  fermerModalAIDAR();
  loadAIDAR();
}

// Voir d√©tails AIDAR
async function voirAIDAR(id) {
  const d = await dbGet('aidar', id);
  if (!d) return;
  
  const modalHtml = `
    <div id="modal-voir-aidar" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:700px">
        <div class="modal-header" style="background:linear-gradient(135deg,#1e40af,#7c3aed)">
          <h3 class="modal-title">üìã AIDAR-${String(d.numero || d.id).padStart(3,'0')} - D√©tails</h3>
          <button class="modal-close" onclick="document.getElementById('modal-voir-aidar').remove()">‚úï</button>
        </div>
        <div class="modal-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
            <div><strong>Date:</strong> ${fmtDate(d.date)}</div>
            <div><strong>Nom:</strong> ${esc(d.nom || '-')}</div>
            <div><strong>Qualit√©:</strong> ${esc(d.qualite || '-')}</div>
            <div><strong>R√©f√©rence:</strong> ${esc(d.reference || '-')}</div>
            <div><strong>Type:</strong> ${d.type?.includes('Mineure') ? 'üü° NC Mineure' : 'üî¥ NC Majeure'}</div>
            <div><strong>Cat√©gorie:</strong> ${esc(d.categorie || '-')}</div>
            <div style="grid-column:1/3"><strong>Description:</strong><br>${esc(d.description || '-')}</div>
            <div><strong>Gravit√© (G):</strong> ${d.g}</div>
            <div><strong>Fr√©quence (F):</strong> ${d.f}</div>
            <div><strong>√âvaluation NC:</strong> <span style="padding:4px 10px;background:${d.evaluationNC >= 12 ? '#dc2626' : d.evaluationNC >= 8 ? '#f59e0b' : '#22c55e'};color:white;border-radius:4px;font-weight:bold">${d.evaluationNC}</span></div>
            <div><strong>√âval. r√©ponse:</strong> ${d.evaluationReponse || '-'}</div>
            <div style="grid-column:1/3"><strong>Actions imm√©diates:</strong><br>${esc(d.actionsImmediates || '-')}</div>
            <div style="grid-column:1/3"><strong>Plan d'actions:</strong><br>${esc(d.planActions || '-')}</div>
            <div><strong>Priorit√©:</strong> ${d.prioriteAction || '-'}</div>
            <div><strong>Responsable:</strong> ${esc(d.responsable || '-')}</div>
            <div><strong>Date d√©cision:</strong> ${fmtDate(d.datePriseDecision)}</div>
            <div><strong>Date pr√©visionnelle:</strong> ${fmtDate(d.datePrevisionnelle)}</div>
            <div><strong>Crit√®re efficacit√©:</strong> ${esc(d.critereEfficacite || '-')}</div>
            <div><strong>Date r√©alisation:</strong> ${fmtDate(d.dateRealisation)}</div>
            <div><strong>Statut:</strong> <span class="status ${d.statut === 'Action finalis√©e' ? 'status-actif' : 'status-en-cours'}">${d.statut || '-'}</span></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="document.getElementById('modal-voir-aidar').remove()">Fermer</button>
          <button class="btn btn-primary" onclick="document.getElementById('modal-voir-aidar').remove();openModalAIDAR(${d.id})">‚úèÔ∏è Modifier</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Importer les donn√©es initiales AIDAR
async function importerDonneesAIDAR() {
  const confirm1 = confirm('Importer les 85 enregistrements AIDAR depuis le fichier existant ?\n\nCette op√©ration va cr√©er les donn√©es dans votre base locale.');
  if (!confirm1) return;
  
  toast('üì• Import en cours...', 'info');
  
  // Donn√©es extraites du fichier Google Sheets AIDAR
  const donneesAIDAR = [
    {numero:1,date:'2021-04-19',nom:'Cosmos- Aouadi',qualite:'Donneur d\'ordre',reference:'foramtion devis N¬∞24 du 13/04/2022',type:'Non confirmit√© Mineure (Al√©as, difficult√©s, Incidents,)',categorie:'3 - Prestation',description:'Report de la date de la formation',g:1,f:1,evaluationNC:1,actionsImmediates:'Reporter la date selon voeux du donneur d\'ordre',evaluationReponse:'Bonne',prioriteAction:'Faible',planActions:'Report de l\'action de foramtion - informer Mr IBLALAN (formateur interne)',responsable:'Boumelassa',datePriseDecision:'2022-04-15',datePrevisionnelle:'2022-04-27',critereEfficacite:'R√©aliation de la formation',dateRealisation:'2021-04-19',statut:'Action finalis√©e'},
    {numero:2,date:'2022-03-28',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 28-03-2022',type:'Non confirmit√© Majeure (R√©clamtion ; Accident)',categorie:'4 - Moyens',description:'Extincteurs qui ne disposent pas de contrat de maintenance',g:2,f:4,evaluationNC:8,actionsImmediates:'Appel Prestataire pour prendre RV',evaluationReponse:'Moyenne',prioriteAction:'Moyenne',planActions:'',responsable:'Boumelassa - Djaber',datePriseDecision:'2022-03-29',datePrevisionnelle:'2022-04-08',critereEfficacite:'Action finalis√©e',dateRealisation:'2022-04-06',statut:'Action finalis√©e'},
    {numero:3,date:'2022-03-28',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 28-03-2022',type:'Non confirmit√© Majeure (R√©clamtion ; Accident)',categorie:'4 - Moyens',description:'Prise √©lectrique √† nu',g:4,f:4,evaluationNC:16,actionsImmediates:'Commandes de caches prises √©lectriques',evaluationReponse:'Moyenne',prioriteAction:'Maximale',planActions:'Installation des caches prises √©lectriques',responsable:'Boumelassa',datePriseDecision:'2022-03-30',datePrevisionnelle:'2022-04-08',critereEfficacite:'Action finalis√©e',dateRealisation:'2022-04-07',statut:'Action finalis√©e'},
    {numero:4,date:'2022-03-28',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 28-03-2022',type:'Non confirmit√© Mineure (Al√©as, difficult√©s, Incidents,)',categorie:'1 -Information',description:'L\'information est partiellement accessible sur le site internet : l\'acc√®s PSH n\'est pas abord√©.',g:2,f:4,evaluationNC:8,actionsImmediates:'Informer le webdesigner pour rectifier les informations manquantes',evaluationReponse:'Bonne',prioriteAction:'Faible',planActions:'Rectification sur site internet',responsable:'Piault -Djaber',datePriseDecision:'2022-03-31',datePrevisionnelle:'2022-04-16',critereEfficacite:'action finalis√©e',dateRealisation:'2022-04-08',statut:'Action finalis√©e'},
    {numero:5,date:'2022-03-28',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 28-03-2022',type:'Non confirmit√© Majeure (R√©clamtion ; Accident)',categorie:'2 - Conception',description:'L\'analyse des besoins des b√©n√©ficiaires n\'a pas pu √™tre d√©montr√©e pour les formations r√©alis√©es.',g:4,f:4,evaluationNC:16,actionsImmediates:'Refonte du questionnaire d\'√©valuation des besoins',evaluationReponse:'Insuffisante',prioriteAction:'Maximale',planActions:'Refonte du questionnaire - Implantation du questionnaire sur le google form pour traiter les questions et les r√©ponses',responsable:'Boumelassa',datePriseDecision:'2022-04-01',datePrevisionnelle:'2022-04-16',critereEfficacite:'Action finalis√©e',dateRealisation:'2022-04-08',statut:'Action finalis√©e'},
    {numero:6,date:'2022-03-28',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 28-03-2022',type:'Non confirmit√© Majeure (R√©clamtion ; Accident)',categorie:'5 - Comp√©tences',description:'L\'existence d\'une coordination des fonctions n√©cessaires √† la prestation n\'a pas pu √™tre d√©montr√©e. Par ailleurs, ni les fiches de poste, ni les contrats de travail des formateurs n\'abordent la mission de formation.',g:3,f:4,evaluationNC:12,actionsImmediates:'Rectification des Fiches de poste',evaluationReponse:'Moyenne',prioriteAction:'Maximale',planActions:'Modification des fiches de poste et r√©daction des ordres de missions',responsable:'Djaber',datePriseDecision:'2022-04-02',datePrevisionnelle:'2022-04-15',critereEfficacite:'Action finalis√©e',dateRealisation:'2022-04-14',statut:'Action finalis√©e'},
    {numero:7,date:'2022-03-28',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 28-03-2022',type:'Non confirmit√© Majeure (R√©clamtion ; Accident)',categorie:'5 - Comp√©tences',description:'D√©montrer l\'√©valuation des comp√©tences des diff√©rents intervenants. D√©velopper les comp√©tences de ses salari√©s de fa√ßon adapt√©e aux prestations qu\'il d√©livre.',g:4,f:3,evaluationNC:12,actionsImmediates:'les documents sont pr√™ts et utilisables. N√©cessit√© de d√©finir un process',evaluationReponse:'Insuffisante',prioriteAction:'Maximale',planActions:'Mettre en place une grille d\'entretien - Evaluation des comp√©tences par le N+1 - D√©terminations d\'un plan de formation',responsable:'Djerbar',datePriseDecision:'2022-04-03',datePrevisionnelle:'2022-04-16',critereEfficacite:'Action finalis√©e',dateRealisation:'2022-04-15',statut:'Action finalis√©e'},
    {numero:8,date:'2022-03-28',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 28-03-2022',type:'Non confirmit√© Majeure (R√©clamtion ; Accident)',categorie:'7 - Am√©lioration',description:'Les modalit√©s de recueil d\'appr√©ciation des parties prenantes ne sont pas d√©finies et leur mise en ≈ìuvre n\'a pas pu √™tre d√©montr√©e.',g:3,f:1,evaluationNC:3,actionsImmediates:'les documents sont pr√™ts et utilisables. N√©cessit√© de d√©finir un process',evaluationReponse:'Moyenne',prioriteAction:'Moyenne',planActions:'Mis en place des questionnaires sur queoval et utilisation des questionnaires',responsable:'Boumelassa',datePriseDecision:'2022-04-04',datePrevisionnelle:'2022-04-16',critereEfficacite:'Action finalis√©e',dateRealisation:'2022-04-20',statut:'Action finalis√©e'},
    {numero:9,date:'2022-03-28',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 28-03-2022',type:'Non confirmit√© Majeure (R√©clamtion ; Accident)',categorie:'7 - Am√©lioration',description:'Les modalit√©s de traitement des al√©as, difficult√©s et r√©clamations √† partir de l\'analyse des appr√©ciations et des r√©clamations',g:3,f:4,evaluationNC:12,actionsImmediates:'Mise en place d\'un processus de traitement',evaluationReponse:'Bonne',prioriteAction:'Moyenne',planActions:'Document AIDAR, caract√©rise les non conformit√©s (al√©as...), d√©finit et √©value le plan d\'action',responsable:'Boumelassa',datePriseDecision:'2022-04-05',datePrevisionnelle:'2022-04-16',critereEfficacite:'Action finalis√©e',dateRealisation:'2022-04-02',statut:'Action finalis√©e'},
    {numero:57,date:'2024-04-03',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 04/03/2024',type:'Non confirmit√© Mineure (Al√©as, difficult√©s, Incidents,)',categorie:'6 - Environnement',description:'Contrat de sous traitance',g:4,f:4,evaluationNC:16,actionsImmediates:'R√©flexion autour du contrat',evaluationReponse:'Moyenne',prioriteAction:'Maximale',planActions:'Correction du Contrat Mod√®le de sous traitance',responsable:'Boumelassa',datePriseDecision:'2024-03-04',datePrevisionnelle:'2024-03-04',critereEfficacite:'Action finalis√©e',dateRealisation:'2024-03-04',statut:'Action finalis√©e'},
    {numero:58,date:'2024-04-03',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 04/03/2025',type:'Non confirmit√© Mineure (Al√©as, difficult√©s, Incidents,)',categorie:'2 - Conception',description:'Fiche de Formation',g:4,f:4,evaluationNC:16,actionsImmediates:'Edition des fiches',evaluationReponse:'Moyenne',prioriteAction:'Maximale',planActions:'Correction des fiches des programmes de formations',responsable:'Boumelassa',datePriseDecision:'2024-03-04',datePrevisionnelle:'2024-03-04',critereEfficacite:'Action finalis√©e',dateRealisation:'2024-03-04',statut:'Action finalis√©e'},
    {numero:59,date:'2024-04-03',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 04/03/2025',type:'Non confirmit√© Mineure (Al√©as, difficult√©s, Incidents,)',categorie:'7 - Am√©lioration',description:'Pr√©sentation de Mail',g:4,f:4,evaluationNC:16,actionsImmediates:'Mail de rappel pour demander les avis des parties prenantes',evaluationReponse:'Insuffisante',prioriteAction:'Maximale',planActions:'R√©daction des mails de rappel',responsable:'Boumelassa',datePriseDecision:'2024-03-04',datePrevisionnelle:'2024-03-04',critereEfficacite:'Action finalis√©e',dateRealisation:'2024-03-04',statut:'Action finalis√©e'},
    {numero:60,date:'2024-04-03',nom:'Madame Christiane Curutchet',qualite:'Auditrice',reference:'Audit du 04/03/2025',type:'Non confirmit√© Mineure (Al√©as, difficult√©s, Incidents,)',categorie:'7 - Am√©lioration',description:'R√©daction de mail',g:4,f:4,evaluationNC:16,actionsImmediates:'Reprise du mail',evaluationReponse:'Moyenne',prioriteAction:'Maximale',planActions:'R√©daction et envoi de mail',responsable:'Boumelassa',datePriseDecision:'2024-03-04',datePrevisionnelle:'2024-03-04',critereEfficacite:'Action finalis√©e',dateRealisation:'2024-03-04',statut:'Action finalis√©e'},
    {numero:84,date:'2024-10-24',nom:'BEN DAALI',qualite:'Formateur',reference:'G√©n√©ral',type:'Non confirmit√© Mineure (Al√©as, difficult√©s, Incidents,)',categorie:'2 - Conception',description:'Guide de bonnes Pratiques D\'hygi√®ne - Des op√©rateurs ne ma√Ætrisent pas le fran√ßais ont du mal √† lire et comprendre le manuel',g:3,f:4,evaluationNC:12,actionsImmediates:'R√©flexion sur le mode de transmission du document',evaluationReponse:'Moyenne',prioriteAction:'Maximale',planActions:'D√©mat√©rialiser le document et possibilit√© de le traduire en plusieurs langues',responsable:'Boumelassa',datePriseDecision:'2024-10-15',datePrevisionnelle:'2024-10-15',critereEfficacite:'Action finalis√©e',dateRealisation:'2024-10-29',statut:'Action finalis√©e'},
    {numero:85,date:'2024-10-24',nom:'Boumelassa',qualite:'Responsable Administratif',reference:'G√©n√©ral',type:'Non confirmit√© Mineure (Al√©as, difficult√©s, Incidents,)',categorie:'7 - Am√©lioration',description:'R√©duire les risques de chutes et les risques li√©s aux d√©placements internes',g:1,f:2,evaluationNC:2,actionsImmediates:'la signalisation des zones de travaux ou de nettoyage, la suppression, le signalement ou la r√©duction de tout obstacle dans les aires de circulation',evaluationReponse:'Bonne',prioriteAction:'Faible',planActions:'Travaux et nettoyages des locaux',responsable:'Boumelassa',datePriseDecision:'2024-10-24',datePrevisionnelle:'2024-10-24',critereEfficacite:'Action finalis√©e',dateRealisation:'2024-10-24',statut:'Action finalis√©e'}
  ];
  
  // Ajouter aussi les d√©calages de formation (exemples repr√©sentatifs)
  const decalagesFormation = [
    {nom:'D√©calage formation',reference:'F & L',date:'2023-03-01'},
    {nom:'D√©calage formation',reference:'COCO',date:'2023-03-23'},
    {nom:'D√©calage formation',reference:'LE SULTAN',date:'2023-04-04'},
    {nom:'D√©calage formation',reference:'MAESTRO PIZZA',date:'2023-04-06'},
    {nom:'D√©calage formation',reference:'SAS ESS',date:'2023-04-17'},
    {nom:'D√©calage formation',reference:'SPEED MAGIC PIZZA',date:'2023-06-01'},
    {nom:'D√©calage formation',reference:'LE MILANO',date:'2023-06-01'},
    {nom:'D√©calage formation',reference:'DI NAPOLI',date:'2023-06-01'},
    {nom:'D√©calage formation',reference:'PIZZA CLASSY ANDIAMO',date:'2023-06-14'},
    {nom:'D√©calage formation',reference:'GRANVILLE PIZZA',date:'2023-08-01'},
    {nom:'D√©calage formation',reference:'BE BOP CITY',date:'2023-10-25'},
    {nom:'D√©calage formation',reference:'SUSHI KID',date:'2023-11-08'},
    {nom:'D√©calage formation',reference:'TACO NAAN',date:'2023-12-04'},
    {nom:'D√©calage formation',reference:'CHM',date:'2024-01-24'},
    {nom:'D√©calage formation',reference:'Wave Sushi Lieusaint',date:'2024-02-21'},
    {nom:'D√©calage formation',reference:'PARIS ISTANBUL',date:'2024-02-23'},
    {nom:'D√©calage formation',reference:'CF PIZZERIA',date:'2024-03-08'},
    {nom:'D√©calage formation',reference:'ANDIAMO',date:'2024-03-12'},
    {nom:'D√©calage formation',reference:'FOURNIL DE GABRIEL',date:'2024-03-12'},
    {nom:'D√©calage formation',reference:'la rose toulousaine',date:'2024-04-02'},
    {nom:'D√©calage formation',reference:'PIZZA DELICE',date:'2024-05-29'},
    {nom:'D√©calage formation',reference:'BIG BEN',date:'2024-06-28'},
    {nom:'D√©calage formation',reference:'O\'SQUADRA',date:'2024-07-17'},
    {nom:'D√©calage formation',reference:'BOULANGERIE CHARCOT',date:'2024-08-19'},
    {nom:'D√©calage formation',reference:'BOUCHERIE DES AMIS',date:'2024-08-27'},
    {nom:'D√©calage formation',reference:'MAHBOUBA',date:'2024-10-16'},
    {nom:'D√©calage formation',reference:'FERTE PRESSE',date:'2024-10-17'},
    {nom:'D√©calage formation',reference:'ODELICE',date:'2024-10-22'},
    {nom:'D√©calage formation',reference:'LA ROSE DE SAINT DENIS',date:'2024-12-13'},
    {nom:'D√©calage formation',reference:'LA ROSE DE BELLEVILLE',date:'2024-12-13'},
    {nom:'D√©calage formation',reference:'LA ROSE DE KREMLIN',date:'2024-12-13'},
    {nom:'D√©calage formation',reference:'LA ROSE DE TOULOUSE',date:'2024-12-13'},
    {nom:'D√©calage formation',reference:'Poke Bowl Sushi Yvetot',date:'2024-12-20'},
    {nom:'D√©calage formation',reference:'K2H',date:'2024-12-24'},
    {nom:'D√©calage formation',reference:'BELLA PIZZA',date:'2024-04-24'}
  ];
  
  // G√©n√©rer les d√©calages avec donn√©es compl√®tes
  let numDecalage = 10;
  for (const dec of decalagesFormation) {
    donneesAIDAR.push({
      numero: numDecalage++,
      date: dec.date,
      nom: dec.nom,
      qualite: 'gestion administrative',
      reference: dec.reference,
      type: 'Non confirmit√© Mineure (Al√©as, difficult√©s, Incidents,)',
      categorie: '3 - Prestation',
      description: 'D√©calage de la formation et information du client et mise en place du processus de formation',
      g: 2,
      f: 4,
      evaluationNC: 8,
      actionsImmediates: 'Reprogrammation de la formation - Convocation des acteurs',
      evaluationReponse: 'Bonne',
      prioriteAction: 'Faible',
      planActions: 'Report de la formation - Informer le client et le financeur (OPCO)',
      responsable: 'Boumelassa',
      datePriseDecision: dec.date,
      datePrevisionnelle: null,
      critereEfficacite: 'Action finalis√©e',
      dateRealisation: dec.date,
      statut: 'Action finalis√©e'
    });
  }
  
  // Importer dans IndexedDB
  let imported = 0;
  for (const aidar of donneesAIDAR) {
    try {
      await dbAdd('aidar', aidar);
      imported++;
    } catch (e) {
      console.warn('Erreur import AIDAR:', e);
    }
  }
  
  toast(`‚úÖ ${imported} enregistrements AIDAR import√©s !`, 'success');
  loadAIDAR();
}

// Export AIDAR vers Excel/CSV
async function exporterAIDAR() {
  const data = await dbGetAll('aidar');
  if (!data.length) {
    toast('‚ùå Aucune donn√©e √† exporter', 'error');
    return;
  }
  
  // G√©n√©rer CSV
  const headers = ['N¬∞','Date','Nom','Qualit√©','R√©f√©rence','Type','Cat√©gorie','Description','G','F','NC','Actions imm√©diates','√âval. r√©ponse','Priorit√©','Plan d\'actions','Responsable','Date d√©cision','Date pr√©visionnelle','Date r√©alisation','Crit√®re efficacit√©','Statut'];
  
  let csv = headers.join(';') + '\n';
  
  data.forEach(d => {
    csv += [
      d.numero || d.id,
      d.date ? d.date.split('T')[0] : '',
      `"${(d.nom || '').replace(/"/g, '""')}"`,
      d.qualite || '',
      `"${(d.reference || '').replace(/"/g, '""')}"`,
      d.type?.includes('Mineure') ? 'NC Mineure' : 'NC Majeure',
      d.categorie || '',
      `"${(d.description || '').replace(/"/g, '""')}"`,
      d.g || '',
      d.f || '',
      d.evaluationNC || '',
      `"${(d.actionsImmediates || '').replace(/"/g, '""')}"`,
      d.evaluationReponse || '',
      d.prioriteAction || '',
      `"${(d.planActions || '').replace(/"/g, '""')}"`,
      d.responsable || '',
      d.datePriseDecision ? d.datePriseDecision.split('T')[0] : '',
      d.datePrevisionnelle ? d.datePrevisionnelle.split('T')[0] : '',
      d.dateRealisation ? d.dateRealisation.split('T')[0] : '',
      d.critereEfficacite || '',
      d.statut || ''
    ].join(';') + '\n';
  });
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `export_aidar_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('üìä Export AIDAR t√©l√©charg√©', 'success');
}

// ============ MODALIT√âS DE RECUEIL DES APPR√âCIATIONS ============
// Bas√© sur DOC VII.30.01 - V1.02 du 15-01-2025

// === GESTION DES ONGLETS SATISFACTION ===
let currentSatisfactionTab = 'chaud';

function showSatisfactionTab(tab) {
  currentSatisfactionTab = tab;
  
  // Masquer tous les onglets
  document.querySelectorAll('.satisf-tab').forEach(t => t.style.display = 'none');
  
  // Afficher l'onglet s√©lectionn√©
  document.getElementById(`tab-satisf-${tab}`).style.display = 'block';
  
  // Mettre √† jour les boutons
  const buttons = document.querySelectorAll('#quali-satisfactions .toolbar button, #quali-satisfactions > div:nth-child(3) button');
  const tabIndex = ['chaud', 'froid', 'financeur', 'formateur', 'donneur'].indexOf(tab);
  
  document.querySelectorAll('#quali-satisfactions > div:nth-child(3) button').forEach((btn, i) => {
    if (i === tabIndex) {
      btn.style.background = '#3b82f6';
      btn.style.color = 'white';
      btn.classList.remove('btn-secondary');
    } else {
      btn.style.background = '';
      btn.style.color = '';
      btn.classList.add('btn-secondary');
    }
  });
  
  // Charger les donn√©es
  loadSatisfactionData(tab);
}

// === CHARGEMENT DES DONN√âES SATISFACTION ===
async function loadSatisfactionData(type) {
  const storeName = type === 'chaud' ? 'satisfactions_chaud' : `satisfactions_${type}`;
  
  try {
    const data = await dbGetAll(storeName);
    renderSatisfactionTable(type, data);
  } catch (e) {
    console.warn(`Erreur chargement ${storeName}:`, e);
    renderSatisfactionTable(type, []);
  }
}

async function loadAllSatisfactionKPIs() {
  try {
    const [chaud, froid, financeur, formateur, donneur] = await Promise.all([
      dbGetAll('satisfactions_chaud'),
      dbGetAll('satisfactions_froid'),
      dbGetAll('satisfactions_financeur'),
      dbGetAll('satisfactions_formateur'),
      dbGetAll('satisfactions_donneur')
    ]);
    
    document.getElementById('kpi-satisf-chaud').textContent = chaud.length;
    document.getElementById('kpi-satisf-froid').textContent = froid.length;
    document.getElementById('kpi-satisf-financeur').textContent = financeur.length;
    document.getElementById('kpi-satisf-formateur').textContent = formateur.length;
    document.getElementById('kpi-satisf-donneur').textContent = donneur.length;
    
    // Charger aussi les stats globales
    await chargerStatsSatisfaction();
  } catch (e) {
    console.warn('Erreur KPIs satisfaction:', e);
  }
}

// ============ STATISTIQUES SATISFACTION GLOBALES ============

let currentStatsTab = 'session';
let chartEvolutionSatisfaction = null;

// Afficher un onglet de statistiques
function showStatsTab(tab) {
  currentStatsTab = tab;
  
  // Masquer tous les onglets
  document.querySelectorAll('.stats-tab-content').forEach(t => t.style.display = 'none');
  
  // Afficher l'onglet s√©lectionn√©
  const tabEl = document.getElementById(`stats-tab-${tab}`);
  if (tabEl) tabEl.style.display = 'block';
  
  // Mettre √† jour les boutons
  ['session', 'entreprise', 'formation', 'annee', 'evolution'].forEach(t => {
    const btn = document.getElementById(`btn-stats-${t}`);
    if (btn) {
      if (t === tab) {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
      } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      }
    }
  });
  
  // Charger les donn√©es
  chargerStatsSatisfaction();
}

// Charger toutes les statistiques de satisfaction
async function chargerStatsSatisfaction() {
  try {
    // R√©cup√©rer toutes les √©valuations √† chaud
    const allEvals = await dbGetAll('eval_chaud_session');
    const allSatChaud = await dbGetAll('satisfactions_chaud');
    
    // Fusionner les donn√©es (priorit√© √† eval_chaud_session)
    const evalsMap = new Map();
    
    allEvals.forEach(e => {
      const key = `${e.sessionId}-${e.stagiaire}`;
      evalsMap.set(key, {
        ...e,
        moyenne: e.moyenne || ((e.c1+e.c2+e.c3+e.c4+e.c5+e.c6+e.c7+e.c8)/8)
      });
    });
    
    allSatChaud.forEach(s => {
      if (!s.evalChaudId) {
        const key = `${s.sessionId}-${s.stagiaire}`;
        if (!evalsMap.has(key)) {
          evalsMap.set(key, s);
        }
      }
    });
    
    const evals = Array.from(evalsMap.values());
    
    // Filtre par ann√©e si s√©lectionn√©
    const anneeFilter = document.getElementById('stats-satisf-annee')?.value;
    let filteredEvals = evals;
    if (anneeFilter) {
      filteredEvals = evals.filter(e => {
        const year = e.annee || (e.dateEval ? new Date(e.dateEval).getFullYear() : null);
        return year == anneeFilter;
      });
    }
    
    // Calculer et afficher les statistiques globales
    calculerStatsGlobales(filteredEvals);
    
    // Peupler le select des ann√©es
    populerSelectAnnees(evals);
    
    // Charger les stats selon l'onglet actif
    switch (currentStatsTab) {
      case 'session':
        await chargerStatsParSession(filteredEvals);
        break;
      case 'entreprise':
        await chargerStatsParEntreprise(filteredEvals);
        break;
      case 'formation':
        await chargerStatsParFormation(filteredEvals);
        break;
      case 'annee':
        chargerStatsParAnnee(evals); // Toutes les donn√©es pour voir l'historique
        break;
      case 'evolution':
        chargerGraphiqueEvolution(evals);
        break;
    }
  } catch (e) {
    console.error('Erreur chargement stats satisfaction:', e);
  }
}

// Peupler le select des ann√©es
function populerSelectAnnees(evals) {
  const select = document.getElementById('stats-satisf-annee');
  if (!select) return;
  
  const currentValue = select.value;
  const annees = new Set();
  
  evals.forEach(e => {
    const year = e.annee || (e.dateEval ? new Date(e.dateEval).getFullYear() : null);
    if (year) annees.add(year);
  });
  
  const sortedAnnees = [...annees].sort((a, b) => b - a);
  
  select.innerHTML = '<option value="">Toutes ann√©es</option>' + 
    sortedAnnees.map(a => `<option value="${a}" ${a == currentValue ? 'selected' : ''}>${a}</option>`).join('');
}

// Calculer les statistiques globales
function calculerStatsGlobales(evals) {
  if (!evals.length) {
    document.getElementById('stats-moy-globale').textContent = '-';
    document.getElementById('stats-nb-eval').textContent = '0 √©valuations';
    document.getElementById('stats-taux-recomm').textContent = '-';
    document.getElementById('stats-moy-contenu').textContent = '-';
    document.getElementById('stats-moy-orga').textContent = '-';
    return;
  }
  
  // Moyenne globale
  const moyennes = evals.map(e => e.moyenne || ((e.c1+e.c2+e.c3+e.c4+e.c5+e.c6+e.c7+e.c8)/8)).filter(m => !isNaN(m));
  const moyGlobale = moyennes.length > 0 ? moyennes.reduce((a,b) => a+b, 0) / moyennes.length : 0;
  
  // Taux de recommandation (c8 >= 4 = recommande)
  const recommandations = evals.filter(e => e.c8 >= 4).length;
  const tauxRecomm = (recommandations / evals.length * 100);
  
  // Moyenne contenu (c5, c6 = programme et mat√©riels)
  const moyContenu = evals.map(e => ((e.c5||0) + (e.c6||0)) / 2).reduce((a,b) => a+b, 0) / evals.length;
  
  // Moyenne organisation (c1, c2, c3, c4 = info, dur√©e, horaires, lieu)
  const moyOrga = evals.map(e => ((e.c1||0) + (e.c2||0) + (e.c3||0) + (e.c4||0)) / 4).reduce((a,b) => a+b, 0) / evals.length;
  
  // Affichage
  document.getElementById('stats-moy-globale').textContent = (moyGlobale / 5 * 100).toFixed(1) + '%';
  document.getElementById('stats-nb-eval').textContent = evals.length + ' √©valuation' + (evals.length > 1 ? 's' : '');
  document.getElementById('stats-taux-recomm').textContent = tauxRecomm.toFixed(1) + '%';
  document.getElementById('stats-moy-contenu').textContent = (moyContenu / 5 * 100).toFixed(1) + '%';
  document.getElementById('stats-moy-orga').textContent = (moyOrga / 5 * 100).toFixed(1) + '%';
}

// Stats par session
async function chargerStatsParSession(evals) {
  const tbody = document.getElementById('stats-table-session');
  if (!tbody) return;
  
  // Grouper par session
  const parSession = {};
  evals.forEach(e => {
    const key = e.sessionRef || e.sessionId || 'unknown';
    if (!parSession[key]) {
      parSession[key] = {
        sessionRef: e.sessionRef || 'SES-' + e.sessionId,
        sessionId: e.sessionId,
        formation: e.formation || '-',
        entreprise: e.entreprise || '-',
        evals: []
      };
    }
    parSession[key].evals.push(e);
  });
  
  if (Object.keys(parSession).length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="empty-state">Aucune √©valuation</td></tr>';
    return;
  }
  
  // Calculer les moyennes par session
  const rows = Object.values(parSession).map(s => {
    const nbEval = s.evals.length;
    const moyGlobale = s.evals.reduce((a, e) => a + (e.moyenne || 0), 0) / nbEval;
    const moyContenu = s.evals.reduce((a, e) => a + ((e.c5||0)+(e.c6||0))/2, 0) / nbEval;
    const moyOrga = s.evals.reduce((a, e) => a + ((e.c1||0)+(e.c2||0)+(e.c3||0)+(e.c4||0))/4, 0) / nbEval;
    const tauxRecomm = s.evals.filter(e => e.c8 >= 4).length / nbEval * 100;
    
    return {
      ...s,
      nbEval,
      moyGlobale: (moyGlobale/5*100).toFixed(1),
      moyContenu: (moyContenu/5*100).toFixed(1),
      moyOrga: (moyOrga/5*100).toFixed(1),
      tauxRecomm: tauxRecomm.toFixed(0)
    };
  });
  
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td><code>${esc(r.sessionRef)}</code></td>
      <td>${esc(r.formation)}</td>
      <td>${esc(r.entreprise)}</td>
      <td style="text-align:center"><strong>${r.nbEval}</strong></td>
      <td><span style="color:${getColorByScore(parseFloat(r.moyGlobale))};font-weight:bold">${r.moyGlobale}%</span></td>
      <td>${r.moyContenu}%</td>
      <td>${r.moyOrga}%</td>
      <td>${r.tauxRecomm}%</td>
      <td><button class="btn btn-sm btn-info" onclick="voirDetailSession(${r.sessionId})">üëÅÔ∏è D√©tails</button></td>
    </tr>
  `).join('');
}

// Stats par entreprise
async function chargerStatsParEntreprise(evals) {
  const tbody = document.getElementById('stats-table-entreprise');
  if (!tbody) return;
  
  // Grouper par entreprise
  const parEntreprise = {};
  evals.forEach(e => {
    const key = e.entreprise || 'Inconnue';
    if (!parEntreprise[key]) {
      parEntreprise[key] = {
        entreprise: key,
        sessions: new Set(),
        evals: []
      };
    }
    parEntreprise[key].sessions.add(e.sessionRef || e.sessionId);
    parEntreprise[key].evals.push(e);
  });
  
  if (Object.keys(parEntreprise).length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Aucune √©valuation</td></tr>';
    return;
  }
  
  const rows = Object.values(parEntreprise).map(ent => {
    const nbEval = ent.evals.length;
    const nbSessions = ent.sessions.size;
    const moyGlobale = ent.evals.reduce((a, e) => a + (e.moyenne || 0), 0) / nbEval;
    const moyContenu = ent.evals.reduce((a, e) => a + ((e.c5||0)+(e.c6||0))/2, 0) / nbEval;
    const moyOrga = ent.evals.reduce((a, e) => a + ((e.c1||0)+(e.c2||0)+(e.c3||0)+(e.c4||0))/4, 0) / nbEval;
    const tauxRecomm = ent.evals.filter(e => e.c8 >= 4).length / nbEval * 100;
    
    return {
      entreprise: ent.entreprise,
      nbSessions,
      nbEval,
      moyGlobale: (moyGlobale/5*100).toFixed(1),
      moyContenu: (moyContenu/5*100).toFixed(1),
      moyOrga: (moyOrga/5*100).toFixed(1),
      tauxRecomm: tauxRecomm.toFixed(0)
    };
  }).sort((a, b) => parseFloat(b.moyGlobale) - parseFloat(a.moyGlobale));
  
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td><strong>${esc(r.entreprise)}</strong></td>
      <td style="text-align:center">${r.nbSessions}</td>
      <td style="text-align:center">${r.nbEval}</td>
      <td><span style="color:${getColorByScore(parseFloat(r.moyGlobale))};font-weight:bold">${r.moyGlobale}%</span></td>
      <td>${r.moyContenu}%</td>
      <td>${r.moyOrga}%</td>
      <td>${r.tauxRecomm}%</td>
      <td>${getTendanceIcon(parseFloat(r.moyGlobale))}</td>
    </tr>
  `).join('');
}

// Stats par formation
async function chargerStatsParFormation(evals) {
  const tbody = document.getElementById('stats-table-formation');
  if (!tbody) return;
  
  const parFormation = {};
  evals.forEach(e => {
    const key = e.formation || 'Inconnue';
    if (!parFormation[key]) {
      parFormation[key] = {
        formation: key,
        sessions: new Set(),
        evals: []
      };
    }
    parFormation[key].sessions.add(e.sessionRef || e.sessionId);
    parFormation[key].evals.push(e);
  });
  
  if (Object.keys(parFormation).length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Aucune √©valuation</td></tr>';
    return;
  }
  
  const rows = Object.values(parFormation).map(form => {
    const nbEval = form.evals.length;
    const nbSessions = form.sessions.size;
    const moyGlobale = form.evals.reduce((a, e) => a + (e.moyenne || 0), 0) / nbEval;
    const moyContenu = form.evals.reduce((a, e) => a + ((e.c5||0)+(e.c6||0))/2, 0) / nbEval;
    const moyOrga = form.evals.reduce((a, e) => a + ((e.c1||0)+(e.c2||0)+(e.c3||0)+(e.c4||0))/4, 0) / nbEval;
    const tauxRecomm = form.evals.filter(e => e.c8 >= 4).length / nbEval * 100;
    
    return {
      formation: form.formation,
      nbSessions,
      nbEval,
      moyGlobale: (moyGlobale/5*100).toFixed(1),
      moyContenu: (moyContenu/5*100).toFixed(1),
      moyOrga: (moyOrga/5*100).toFixed(1),
      tauxRecomm: tauxRecomm.toFixed(0)
    };
  }).sort((a, b) => parseFloat(b.moyGlobale) - parseFloat(a.moyGlobale));
  
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td><strong>${esc(r.formation)}</strong></td>
      <td style="text-align:center">${r.nbSessions}</td>
      <td style="text-align:center">${r.nbEval}</td>
      <td><span style="color:${getColorByScore(parseFloat(r.moyGlobale))};font-weight:bold">${r.moyGlobale}%</span></td>
      <td>${r.moyContenu}%</td>
      <td>${r.moyOrga}%</td>
      <td>${r.tauxRecomm}%</td>
      <td>${getTendanceIcon(parseFloat(r.moyGlobale))}</td>
    </tr>
  `).join('');
}

// Stats par ann√©e
function chargerStatsParAnnee(evals) {
  const tbody = document.getElementById('stats-table-annee');
  if (!tbody) return;
  
  const parAnnee = {};
  evals.forEach(e => {
    const year = e.annee || (e.dateEval ? new Date(e.dateEval).getFullYear() : 'Inconnue');
    if (!parAnnee[year]) {
      parAnnee[year] = {
        annee: year,
        sessions: new Set(),
        evals: []
      };
    }
    parAnnee[year].sessions.add(e.sessionRef || e.sessionId);
    parAnnee[year].evals.push(e);
  });
  
  if (Object.keys(parAnnee).length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Aucune √©valuation</td></tr>';
    return;
  }
  
  const rows = Object.values(parAnnee).map(an => {
    const nbEval = an.evals.length;
    const nbSessions = an.sessions.size;
    const moyGlobale = an.evals.reduce((a, e) => a + (e.moyenne || 0), 0) / nbEval;
    const moyContenu = an.evals.reduce((a, e) => a + ((e.c5||0)+(e.c6||0))/2, 0) / nbEval;
    const moyOrga = an.evals.reduce((a, e) => a + ((e.c1||0)+(e.c2||0)+(e.c3||0)+(e.c4||0))/4, 0) / nbEval;
    const tauxRecomm = an.evals.filter(e => e.c8 >= 4).length / nbEval * 100;
    
    return {
      annee: an.annee,
      nbSessions,
      nbEval,
      moyGlobale: (moyGlobale/5*100).toFixed(1),
      moyContenu: (moyContenu/5*100).toFixed(1),
      moyOrga: (moyOrga/5*100).toFixed(1),
      tauxRecomm: tauxRecomm.toFixed(0)
    };
  }).sort((a, b) => b.annee - a.annee);
  
  // Calculer l'√©volution par rapport √† l'ann√©e pr√©c√©dente
  tbody.innerHTML = rows.map((r, i) => {
    const prevYear = rows[i + 1];
    let evolution = '-';
    if (prevYear) {
      const diff = parseFloat(r.moyGlobale) - parseFloat(prevYear.moyGlobale);
      if (diff > 0) evolution = `<span style="color:#22c55e">üìà +${diff.toFixed(1)}%</span>`;
      else if (diff < 0) evolution = `<span style="color:#ef4444">üìâ ${diff.toFixed(1)}%</span>`;
      else evolution = '<span style="color:#64748b">‚û°Ô∏è 0%</span>';
    }
    
    return `
      <tr>
        <td><strong style="font-size:1.1em">${r.annee}</strong></td>
        <td style="text-align:center">${r.nbSessions}</td>
        <td style="text-align:center">${r.nbEval}</td>
        <td><span style="color:${getColorByScore(parseFloat(r.moyGlobale))};font-weight:bold;font-size:1.1em">${r.moyGlobale}%</span></td>
        <td>${r.moyContenu}%</td>
        <td>${r.moyOrga}%</td>
        <td>${r.tauxRecomm}%</td>
        <td>${evolution}</td>
      </tr>
    `;
  }).join('');
}

// Graphique d'√©volution
function chargerGraphiqueEvolution(evals) {
  const canvas = document.getElementById('chart-evolution-satisfaction');
  if (!canvas) return;
  
  // Grouper par mois
  const parMois = {};
  evals.forEach(e => {
    const date = e.dateEval ? new Date(e.dateEval) : new Date();
    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    if (!parMois[key]) {
      parMois[key] = { evals: [], label: key };
    }
    parMois[key].evals.push(e);
  });
  
  const mois = Object.keys(parMois).sort();
  const dataGlobale = mois.map(m => {
    const evs = parMois[m].evals;
    const moy = evs.reduce((a, e) => a + (e.moyenne || 0), 0) / evs.length;
    return (moy / 5 * 100).toFixed(1);
  });
  const dataRecomm = mois.map(m => {
    const evs = parMois[m].evals;
    return (evs.filter(e => e.c8 >= 4).length / evs.length * 100).toFixed(1);
  });
  
  // D√©truire l'ancien graphique si existe
  if (chartEvolutionSatisfaction) {
    chartEvolutionSatisfaction.destroy();
  }
  
  chartEvolutionSatisfaction = new Chart(canvas, {
    type: 'line',
    data: {
      labels: mois.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, month - 1).toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
      }),
      datasets: [
        {
          label: 'Satisfaction Globale (%)',
          data: dataGlobale,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Taux de Recommandation (%)',
          data: dataRecomm,
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: { callback: v => v + '%' }
        }
      }
    }
  });
}

// Couleur selon score
function getColorByScore(score) {
  if (score >= 80) return '#22c55e';
  if (score >= 60) return '#f59e0b';
  return '#ef4444';
}

// Ic√¥ne tendance
function getTendanceIcon(score) {
  if (score >= 80) return '<span style="color:#22c55e">üåü Excellent</span>';
  if (score >= 70) return '<span style="color:#3b82f6">üëç Bon</span>';
  if (score >= 60) return '<span style="color:#f59e0b">‚ö†Ô∏è Moyen</span>';
  return '<span style="color:#ef4444">‚ùå √Ä am√©liorer</span>';
}

// Voir les d√©tails d'une session
function voirDetailSession(sessionId) {
  // Naviguer vers Post-Formation avec la session s√©lectionn√©e
  navigateTo('post-formation');
  setTimeout(() => {
    const select = document.getElementById('post-formation-session');
    if (select) {
      select.value = sessionId;
      select.dispatchEvent(new Event('change'));
    }
  }, 300);
}

// Exporter les stats en PDF
async function exporterStatsSatisfactionPDF() {
  toast('üìÑ G√©n√©ration du rapport PDF en cours...', 'info');
  
  const anneeFilter = document.getElementById('stats-satisf-annee')?.value || 'Toutes';
  const allEvals = await dbGetAll('eval_chaud_session');
  
  let evals = allEvals;
  if (anneeFilter && anneeFilter !== 'Toutes') {
    evals = allEvals.filter(e => {
      const year = e.annee || (e.dateEval ? new Date(e.dateEval).getFullYear() : null);
      return year == anneeFilter;
    });
  }
  
  // G√©n√©rer le contenu HTML du rapport
  const nbEval = evals.length;
  const moyGlobale = evals.length > 0 ? evals.reduce((a, e) => a + (e.moyenne || 0), 0) / nbEval : 0;
  const tauxRecomm = evals.length > 0 ? evals.filter(e => e.c8 >= 4).length / nbEval * 100 : 0;
  
  const htmlContent = `
    <!DOCTYPE html>
    <html lang="fr">
    <head>
      <meta charset="UTF-8">
      <title>Rapport Satisfaction - ${anneeFilter}</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 40px; }
        h1 { color: #1e40af; border-bottom: 3px solid #3b82f6; padding-bottom: 10px; }
        h2 { color: #374151; margin-top: 30px; }
        .kpi-box { display: inline-block; width: 23%; padding: 20px; margin: 5px; background: #f1f5f9; border-radius: 8px; text-align: center; }
        .kpi-value { font-size: 2em; font-weight: bold; color: #1e40af; }
        .kpi-label { color: #64748b; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
        th { background: #f1f5f9; }
        .footer { margin-top: 40px; text-align: center; color: #9ca3af; font-size: 0.9em; }
      </style>
    </head>
    <body>
      <h1>üìä Rapport de Satisfaction Formation</h1>
      <p><strong>P√©riode :</strong> ${anneeFilter === 'Toutes' ? 'Toutes les ann√©es' : 'Ann√©e ' + anneeFilter}</p>
      <p><strong>Date de g√©n√©ration :</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
      
      <div style="margin: 30px 0;">
        <div class="kpi-box">
          <div class="kpi-value">${nbEval}</div>
          <div class="kpi-label">√âvaluations</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-value">${(moyGlobale/5*100).toFixed(1)}%</div>
          <div class="kpi-label">Satisfaction Globale</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-value">${tauxRecomm.toFixed(1)}%</div>
          <div class="kpi-label">Recommandation</div>
        </div>
      </div>
      
      <h2>üìù D√©tail des √©valuations</h2>
      <table>
        <tr><th>Date</th><th>Session</th><th>Stagiaire</th><th>Entreprise</th><th>Note</th><th>Recommande</th></tr>
        ${evals.slice(0, 50).map(e => `
          <tr>
            <td>${e.dateEval || '-'}</td>
            <td>${e.sessionRef || '-'}</td>
            <td>${e.stagiaire || '-'}</td>
            <td>${e.entreprise || '-'}</td>
            <td>${((e.moyenne || 0)/5*100).toFixed(0)}%</td>
            <td>${e.c8 >= 4 ? 'Oui' : 'Non'}</td>
          </tr>
        `).join('')}
      </table>
      
      <div class="footer">
        <p>Formation DesClick - Organisme certifi√© Qualiopi</p>
        <p>Rapport g√©n√©r√© automatiquement par le CRM Formation</p>
      </div>
    </body>
    </html>
  `;
  
  // Ouvrir dans une nouvelle fen√™tre pour impression
  const printWindow = window.open('', '_blank');
  printWindow.document.write(htmlContent);
  printWindow.document.close();
  printWindow.print();
  
  toast('‚úÖ Rapport pr√™t pour impression', 'success');
}

// Exporter les stats en CSV
async function exporterStatsSatisfactionCSV() {
  const anneeFilter = document.getElementById('stats-satisf-annee')?.value;
  const allEvals = await dbGetAll('eval_chaud_session');
  
  let evals = allEvals;
  if (anneeFilter) {
    evals = allEvals.filter(e => {
      const year = e.annee || (e.dateEval ? new Date(e.dateEval).getFullYear() : null);
      return year == anneeFilter;
    });
  }
  
  // Cr√©er le CSV
  const headers = ['Date', 'Session', 'Stagiaire', 'Entreprise', 'Formation', 'C1', 'C2', 'C3', 'C4', 'C5', 'C6', 'C7', 'C8', 'Moyenne', 'Commentaire'];
  const rows = evals.map(e => [
    e.dateEval || '',
    e.sessionRef || '',
    e.stagiaire || '',
    e.entreprise || '',
    e.formation || '',
    e.c1 || '',
    e.c2 || '',
    e.c3 || '',
    e.c4 || '',
    e.c5 || '',
    e.c6 || '',
    e.c7 || '',
    e.c8 || '',
    e.moyenne ? e.moyenne.toFixed(2) : '',
    (e.commentaire || '').replace(/"/g, '""')
  ]);
  
  const csv = [headers.join(';'), ...rows.map(r => r.map(c => `"${c}"`).join(';'))].join('\n');
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `satisfaction_${anneeFilter || 'toutes-annees'}_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('‚úÖ Export CSV t√©l√©charg√©', 'success');
}

// === RENDU DES TABLEAUX SATISFACTION ===
function renderSatisfactionTable(type, data) {
  const tbody = document.getElementById(`table-satisf-${type}`);
  if (!tbody) return;
  
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="10" class="empty-state"><div class="empty-state-icon">üìã</div><h3>Aucun questionnaire</h3></td></tr>`;
    return;
  }
  
  switch (type) {
    case 'chaud':
      tbody.innerHTML = data.map(d => {
        const moyenne = d.noteGlobale || d.moyenne || ((d.c1+d.c2+d.c3+d.c4+d.c5+d.c6+d.c7+d.c8)/8);
        const moyennePct = (moyenne / 5 * 100).toFixed(0);
        const contenu = d.contenu || ((d.c5||0)+(d.c6||0))/2;
        const pedagogie = d.pedagogie || ((d.c2||0)+(d.c3||0))/2;
        const conditions = d.conditions || ((d.c1||0)+(d.c4||0))/2;
        const recommande = d.recommande || d.c8;
        const hasDoc = d.hasDocument || d.documentContenu;
        
        return `
        <tr>
          <td><code>SC-${String(d.id).padStart(3,'0')}</code>${hasDoc ? ' üìé' : ''}</td>
          <td>${esc(d.stagiaire || '-')}</td>
          <td>${esc(d.sessionRef || d.session || '-')}</td>
          <td>${fmtDate(d.date || d.dateEval)}</td>
          <td><strong style="color:${getColorByScore(parseFloat(moyennePct))}">${moyennePct}%</strong></td>
          <td>${(contenu/5*100).toFixed(0)}%</td>
          <td>${(pedagogie/5*100).toFixed(0)}%</td>
          <td>${(conditions/5*100).toFixed(0)}%</td>
          <td>${recommande >= 4 ? '<span class="status status-actif">‚úÖ Oui</span>' : '<span class="status status-inactif">‚ùå Non</span>'}</td>
          <td class="action-btns">
            <button class="btn btn-info btn-icon" onclick="voirSatisfaction('chaud',${d.id})" title="Voir">üëÅÔ∏è</button>
            <button class="btn btn-danger btn-icon" onclick="confirmDelete('satisfactions_chaud',${d.id})" title="Supprimer">üóëÔ∏è</button>
          </td>
        </tr>
      `}).join('');
      break;
      
    case 'froid':
      tbody.innerHTML = data.map(d => {
        const statutClass = d.statut === 'R√©pondu' ? 'actif' : d.statut === 'Envoy√©' ? 'en-cours' : 'en-attente';
        return `
        <tr>
          <td><code>SF-${String(d.id).padStart(3,'0')}</code></td>
          <td>${esc(d.stagiaire || '-')}</td>
          <td>${esc(d.session || '-')}</td>
          <td>${fmtDate(d.dateFormation)}</td>
          <td>${fmtDate(d.dateEnvoi)}</td>
          <td><span class="status status-${statutClass}">${d.statut || '√Ä envoyer'}</span></td>
          <td>${d.misePratique ? `${d.misePratique}%` : '-'}</td>
          <td>${d.difficultes ? esc(trunc(d.difficultes, 30)) : '-'}</td>
          <td>${d.note ? `<strong style="color:${getNoteColor(d.note)}">${d.note}/10</strong>` : '-'}</td>
          <td class="action-btns">
            <button class="btn btn-warning btn-icon" onclick="envoyerQuestionnaireEmail('froid',${d.id})" title="Envoyer/Relancer">üìß</button>
            <button class="btn btn-info btn-icon" onclick="voirSatisfaction('froid',${d.id})" title="Voir">üëÅÔ∏è</button>
            <button class="btn btn-danger btn-icon" onclick="confirmDelete('satisfactions_froid',${d.id})" title="Supprimer">üóëÔ∏è</button>
          </td>
        </tr>
      `}).join('');
      break;
      
    case 'financeur':
      tbody.innerHTML = data.map(d => `
        <tr>
          <td><code>FI-${String(d.id).padStart(3,'0')}</code></td>
          <td>${esc(d.financeur || '-')}</td>
          <td>${esc(d.type || '-')}</td>
          <td>${esc(d.session || '-')}</td>
          <td>${fmtDate(d.dateEnvoi)}</td>
          <td><span class="status status-${d.statut === 'R√©pondu' ? 'actif' : 'en-cours'}">${d.statut || '√Ä envoyer'}</span></td>
          <td>${d.noteQualite || '-'}/10</td>
          <td>${d.noteCommunication || '-'}/10</td>
          <td>${d.noteReactivite || '-'}/10</td>
          <td class="action-btns">
            <button class="btn btn-warning btn-icon" onclick="envoyerQuestionnaireEmail('financeur',${d.id})" title="Envoyer">üìß</button>
            <button class="btn btn-info btn-icon" onclick="voirSatisfaction('financeur',${d.id})" title="Voir">üëÅÔ∏è</button>
            <button class="btn btn-danger btn-icon" onclick="confirmDelete('satisfactions_financeur',${d.id})" title="Supprimer">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
      break;
      
    case 'formateur':
      tbody.innerHTML = data.map(d => `
        <tr>
          <td><code>FO-${String(d.id).padStart(3,'0')}</code></td>
          <td>${esc(d.formateur || '-')}</td>
          <td>${esc(d.session || '-')}</td>
          <td>${fmtDate(d.date)}</td>
          <td>${d.noteOrganisation || '-'}/10</td>
          <td>${d.noteSupports || '-'}/10</td>
          <td>${d.noteStagiaires || '-'}/10</td>
          <td><strong style="color:${getNoteColor(d.noteGlobale)}">${d.noteGlobale || '-'}/10</strong></td>
          <td>${d.commentaires ? esc(trunc(d.commentaires, 30)) : '-'}</td>
          <td class="action-btns">
            <button class="btn btn-info btn-icon" onclick="voirSatisfaction('formateur',${d.id})" title="Voir">üëÅÔ∏è</button>
            <button class="btn btn-danger btn-icon" onclick="confirmDelete('satisfactions_formateur',${d.id})" title="Supprimer">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
      break;
      
    case 'donneur':
      tbody.innerHTML = data.map(d => `
        <tr>
          <td><code>DO-${String(d.id).padStart(3,'0')}</code></td>
          <td>${esc(d.entreprise || '-')}</td>
          <td>${esc(d.contact || '-')}</td>
          <td>${esc(d.session || '-')}</td>
          <td>${fmtDate(d.dateEnvoi)}</td>
          <td><span class="status status-${d.statut === 'R√©pondu' ? 'actif' : 'en-cours'}">${d.statut || '√Ä envoyer'}</span></td>
          <td>${d.impactFormation || '-'}</td>
          <td>${d.competencesDeveloppees ? '‚úÖ' : '‚ùå'}</td>
          <td>${d.note ? `<strong style="color:${getNoteColor(d.note)}">${d.note}/10</strong>` : '-'}</td>
          <td class="action-btns">
            <button class="btn btn-warning btn-icon" onclick="envoyerQuestionnaireEmail('donneur',${d.id})" title="Envoyer">üìß</button>
            <button class="btn btn-info btn-icon" onclick="voirSatisfaction('donneur',${d.id})" title="Voir">üëÅÔ∏è</button>
            <button class="btn btn-danger btn-icon" onclick="confirmDelete('satisfactions_donneur',${d.id})" title="Supprimer">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
      break;
  }
}

function getNoteColor(note) {
  if (!note) return '#64748b';
  if (note >= 8) return '#16a34a';
  if (note >= 6) return '#d97706';
  return '#dc2626';
}

// === FILTRAGE SATISFACTION ===
async function filterSatisfactions(type) {
  const searchTerm = (document.getElementById(`search-satisf-${type}`)?.value || '').toLowerCase();
  const storeName = `satisfactions_${type}`;
  
  try {
    let data = await dbGetAll(storeName);
    
    if (searchTerm) {
      data = data.filter(d => {
        return Object.values(d).some(v => 
          v && v.toString().toLowerCase().includes(searchTerm)
        );
      });
    }
    
    // Filtre statut pour questionnaire √† froid
    if (type === 'froid') {
      const statutFilter = document.getElementById('filter-satisf-froid-statut')?.value;
      if (statutFilter) {
        data = data.filter(d => d.statut === statutFilter);
      }
    }
    
    renderSatisfactionTable(type, data);
  } catch (e) {
    console.warn('Erreur filtrage:', e);
  }
}

// === MODALES SATISFACTION ===
async function openModalSatisfaction(type) {
  const sessions = await dbGetAll('sessions');
  const stagiaires = await dbGetAll('stagiaires');
  const formateurs = await dbGetAll('formateurs');
  const entreprises = await dbGetAll('entreprises');
  
  let title, fields;
  
  switch (type) {
    case 'chaud':
      title = 'üî• Nouveau Questionnaire √† Chaud';
      fields = `
        <div class="form-group"><label>Session *</label><select class="form-select" id="satisf-session" required>
          <option value="">-- S√©lectionner --</option>
          ${sessions.map(s => `<option value="${s.id}">${esc(s.intitule)} - ${fmtDate(s.dateDebut)}</option>`).join('')}
        </select></div>
        <div class="form-group"><label>Stagiaire *</label><select class="form-select" id="satisf-stagiaire" required>
          <option value="">-- S√©lectionner --</option>
          ${stagiaires.map(s => `<option value="${s.id}">${esc(s.nom)} ${esc(s.prenom||'')}</option>`).join('')}
        </select></div>
        <div class="form-row">
          <div class="form-group"><label>Note Globale /10 *</label><input type="number" class="form-input" id="satisf-note-globale" min="0" max="10" required></div>
          <div class="form-group"><label>Note Contenu /10</label><input type="number" class="form-input" id="satisf-note-contenu" min="0" max="10"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Note P√©dagogie /10</label><input type="number" class="form-input" id="satisf-note-pedagogie" min="0" max="10"></div>
          <div class="form-group"><label>Note Conditions /10</label><input type="number" class="form-input" id="satisf-note-conditions" min="0" max="10"></div>
        </div>
        <div class="form-group"><label>Recommande ?</label><select class="form-select" id="satisf-recommande">
          <option value="true">‚úÖ Oui</option>
          <option value="false">‚ùå Non</option>
        </select></div>
        <div class="form-group"><label>Points forts</label><textarea class="form-textarea" id="satisf-points-forts" rows="2"></textarea></div>
        <div class="form-group"><label>Points √† am√©liorer</label><textarea class="form-textarea" id="satisf-points-ameliorer" rows="2"></textarea></div>
        <div class="form-group"><label>Commentaires</label><textarea class="form-textarea" id="satisf-commentaires" rows="2"></textarea></div>
      `;
      break;
      
    case 'froid':
      title = '‚ùÑÔ∏è Nouveau Questionnaire √† Froid';
      fields = `
        <div class="form-group"><label>Session *</label><select class="form-select" id="satisf-session" required>
          <option value="">-- S√©lectionner --</option>
          ${sessions.filter(s => s.statut === 'Termin√©e').map(s => `<option value="${s.id}">${esc(s.intitule)} - ${fmtDate(s.dateDebut)}</option>`).join('')}
        </select></div>
        <div class="form-group"><label>Stagiaire *</label><select class="form-select" id="satisf-stagiaire" required>
          <option value="">-- S√©lectionner --</option>
          ${stagiaires.map(s => `<option value="${s.id}">${esc(s.nom)} ${esc(s.prenom||'')}</option>`).join('')}
        </select></div>
        <div class="form-group"><label>Statut</label><select class="form-select" id="satisf-statut">
          <option value="√Ä envoyer">√Ä envoyer</option>
          <option value="Envoy√©">Envoy√©</option>
          <option value="Relance 1">Relance 1</option>
          <option value="Relance 2">Relance 2</option>
          <option value="R√©pondu">R√©pondu</option>
        </select></div>
        <div class="form-row">
          <div class="form-group"><label>Mise en pratique (%)</label><input type="number" class="form-input" id="satisf-mise-pratique" min="0" max="100"></div>
          <div class="form-group"><label>Note /10</label><input type="number" class="form-input" id="satisf-note" min="0" max="10"></div>
        </div>
        <div class="form-group"><label>Difficult√©s rencontr√©es</label><textarea class="form-textarea" id="satisf-difficultes" rows="2"></textarea></div>
        <div class="form-group"><label>Comp√©tences acquises</label><textarea class="form-textarea" id="satisf-competences" rows="2"></textarea></div>
      `;
      break;
      
    case 'financeur':
      title = 'üí∞ Nouveau Questionnaire Financeur/OPCO';
      fields = `
        <div class="form-row">
          <div class="form-group"><label>Financeur *</label><input type="text" class="form-input" id="satisf-financeur" placeholder="Nom du financeur" required></div>
          <div class="form-group"><label>Type</label><select class="form-select" id="satisf-type-financeur">
            <option value="OPCO">OPCO</option>
            <option value="AKTO">AKTO</option>
            <option value="AGEFICE">AGEFICE</option>
            <option value="OPCOEP">OPCOEP</option>
            <option value="FAF">FAF</option>
            <option value="Autre">Autre</option>
          </select></div>
        </div>
        <div class="form-group"><label>Session concern√©e</label><select class="form-select" id="satisf-session">
          <option value="">-- S√©lectionner --</option>
          ${sessions.map(s => `<option value="${s.id}">${esc(s.intitule)} - ${fmtDate(s.dateDebut)}</option>`).join('')}
        </select></div>
        <div class="form-group"><label>Email contact</label><input type="email" class="form-input" id="satisf-email"></div>
        <div class="form-group"><label>Statut</label><select class="form-select" id="satisf-statut">
          <option value="√Ä envoyer">√Ä envoyer</option>
          <option value="Envoy√©">Envoy√©</option>
          <option value="Relance">Relance</option>
          <option value="R√©pondu">R√©pondu</option>
        </select></div>
        <div class="form-row">
          <div class="form-group"><label>Note Qualit√© /10</label><input type="number" class="form-input" id="satisf-note-qualite" min="0" max="10"></div>
          <div class="form-group"><label>Note Communication /10</label><input type="number" class="form-input" id="satisf-note-comm" min="0" max="10"></div>
          <div class="form-group"><label>Note R√©activit√© /10</label><input type="number" class="form-input" id="satisf-note-react" min="0" max="10"></div>
        </div>
        <div class="form-group"><label>Commentaires</label><textarea class="form-textarea" id="satisf-commentaires" rows="2"></textarea></div>
      `;
      break;
      
    case 'formateur':
      title = 'üë®‚Äçüè´ Nouveau Questionnaire Formateur';
      fields = `
        <div class="form-group"><label>Formateur *</label><select class="form-select" id="satisf-formateur" required>
          <option value="">-- S√©lectionner --</option>
          ${formateurs.map(f => `<option value="${f.id}">${esc(f.nom)} ${esc(f.prenom||'')}</option>`).join('')}
        </select></div>
        <div class="form-group"><label>Session *</label><select class="form-select" id="satisf-session" required>
          <option value="">-- S√©lectionner --</option>
          ${sessions.map(s => `<option value="${s.id}">${esc(s.intitule)} - ${fmtDate(s.dateDebut)}</option>`).join('')}
        </select></div>
        <div class="form-row">
          <div class="form-group"><label>Note Organisation /10</label><input type="number" class="form-input" id="satisf-note-orga" min="0" max="10"></div>
          <div class="form-group"><label>Note Supports /10</label><input type="number" class="form-input" id="satisf-note-supports" min="0" max="10"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Note Stagiaires /10</label><input type="number" class="form-input" id="satisf-note-stag" min="0" max="10"></div>
          <div class="form-group"><label>Note Globale /10 *</label><input type="number" class="form-input" id="satisf-note-globale" min="0" max="10" required></div>
        </div>
        <div class="form-group"><label>Points positifs</label><textarea class="form-textarea" id="satisf-points-positifs" rows="2"></textarea></div>
        <div class="form-group"><label>Difficult√©s rencontr√©es</label><textarea class="form-textarea" id="satisf-difficultes" rows="2"></textarea></div>
        <div class="form-group"><label>Suggestions d'am√©lioration</label><textarea class="form-textarea" id="satisf-suggestions" rows="2"></textarea></div>
      `;
      break;
      
    case 'donneur':
      title = 'üè¢ Nouveau Questionnaire Donneur d\'ordre';
      fields = `
        <div class="form-group"><label>Entreprise *</label><select class="form-select" id="satisf-entreprise" required>
          <option value="">-- S√©lectionner --</option>
          ${entreprises.map(e => `<option value="${e.id}">${esc(e.nom)}</option>`).join('')}
        </select></div>
        <div class="form-group"><label>Contact</label><input type="text" class="form-input" id="satisf-contact"></div>
        <div class="form-group"><label>Email</label><input type="email" class="form-input" id="satisf-email"></div>
        <div class="form-group"><label>Session concern√©e *</label><select class="form-select" id="satisf-session" required>
          <option value="">-- S√©lectionner --</option>
          ${sessions.filter(s => s.statut === 'Termin√©e').map(s => `<option value="${s.id}">${esc(s.intitule)} - ${fmtDate(s.dateDebut)}</option>`).join('')}
        </select></div>
        <div class="form-group"><label>Statut</label><select class="form-select" id="satisf-statut">
          <option value="√Ä envoyer">√Ä envoyer</option>
          <option value="Envoy√©">Envoy√©</option>
          <option value="Relance 1">Relance 1</option>
          <option value="Relance 2">Relance 2</option>
          <option value="R√©pondu">R√©pondu</option>
        </select></div>
        <div class="form-group"><label>Impact sur la productivit√©</label><select class="form-select" id="satisf-impact">
          <option value="">-- S√©lectionner --</option>
          <option value="Tr√®s positif">Tr√®s positif</option>
          <option value="Positif">Positif</option>
          <option value="Neutre">Neutre</option>
          <option value="N√©gatif">N√©gatif</option>
        </select></div>
        <div class="form-group"><label>Comp√©tences d√©velopp√©es</label><select class="form-select" id="satisf-competences-dev">
          <option value="true">‚úÖ Oui</option>
          <option value="false">‚ùå Non</option>
        </select></div>
        <div class="form-group"><label>Note satisfaction /10</label><input type="number" class="form-input" id="satisf-note" min="0" max="10"></div>
        <div class="form-group"><label>Commentaires</label><textarea class="form-textarea" id="satisf-commentaires" rows="2"></textarea></div>
      `;
      break;
  }
  
  // Cr√©er et afficher la modale
  const modalHtml = `
    <div id="modal-satisfaction" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:600px">
        <div class="modal-header"><h3 class="modal-title">${title}</h3><button class="modal-close" onclick="fermerModalSatisfaction()">‚úï</button></div>
        <div class="modal-body">
          <form id="form-satisfaction" onsubmit="saveSatisfaction('${type}');return false">
            ${fields}
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="fermerModalSatisfaction()">Annuler</button>
          <button type="submit" form="form-satisfaction" class="btn btn-primary">üíæ Enregistrer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function fermerModalSatisfaction() {
  document.getElementById('modal-satisfaction')?.remove();
}

async function saveSatisfaction(type) {
  const storeName = `satisfactions_${type}`;
  let data = { dateCreation: new Date().toISOString() };
  
  // R√©cup√©rer les donn√©es selon le type
  const sessionId = document.getElementById('satisf-session')?.value;
  if (sessionId) {
    const session = await dbGet('sessions', parseInt(sessionId));
    data.session = session?.intitule || '';
    data.sessionId = parseInt(sessionId);
  }
  
  switch (type) {
    case 'chaud':
      const stagId = document.getElementById('satisf-stagiaire')?.value;
      if (stagId) {
        const stag = await dbGet('stagiaires', parseInt(stagId));
        data.stagiaire = stag ? `${stag.nom} ${stag.prenom||''}` : '';
        data.stagiaireId = parseInt(stagId);
      }
      data.date = new Date().toISOString();
      data.noteGlobale = parseInt(document.getElementById('satisf-note-globale')?.value) || null;
      data.noteContenu = parseInt(document.getElementById('satisf-note-contenu')?.value) || null;
      data.notePedagogie = parseInt(document.getElementById('satisf-note-pedagogie')?.value) || null;
      data.noteConditions = parseInt(document.getElementById('satisf-note-conditions')?.value) || null;
      data.recommande = document.getElementById('satisf-recommande')?.value === 'true';
      data.pointsForts = document.getElementById('satisf-points-forts')?.value || '';
      data.pointsAmeliorer = document.getElementById('satisf-points-ameliorer')?.value || '';
      data.commentaires = document.getElementById('satisf-commentaires')?.value || '';
      break;
      
    case 'froid':
      const stagFroidId = document.getElementById('satisf-stagiaire')?.value;
      if (stagFroidId) {
        const stag = await dbGet('stagiaires', parseInt(stagFroidId));
        data.stagiaire = stag ? `${stag.nom} ${stag.prenom||''}` : '';
        data.stagiaireId = parseInt(stagFroidId);
      }
      data.statut = document.getElementById('satisf-statut')?.value || '√Ä envoyer';
      data.misePratique = parseInt(document.getElementById('satisf-mise-pratique')?.value) || null;
      data.note = parseInt(document.getElementById('satisf-note')?.value) || null;
      data.difficultes = document.getElementById('satisf-difficultes')?.value || '';
      data.competences = document.getElementById('satisf-competences')?.value || '';
      break;
      
    case 'financeur':
      data.financeur = document.getElementById('satisf-financeur')?.value || '';
      data.type = document.getElementById('satisf-type-financeur')?.value || 'OPCO';
      data.email = document.getElementById('satisf-email')?.value || '';
      data.statut = document.getElementById('satisf-statut')?.value || '√Ä envoyer';
      data.noteQualite = parseInt(document.getElementById('satisf-note-qualite')?.value) || null;
      data.noteCommunication = parseInt(document.getElementById('satisf-note-comm')?.value) || null;
      data.noteReactivite = parseInt(document.getElementById('satisf-note-react')?.value) || null;
      data.commentaires = document.getElementById('satisf-commentaires')?.value || '';
      break;
      
    case 'formateur':
      const formId = document.getElementById('satisf-formateur')?.value;
      if (formId) {
        const form = await dbGet('formateurs', parseInt(formId));
        data.formateur = form ? `${form.nom} ${form.prenom||''}` : '';
        data.formateurId = parseInt(formId);
      }
      data.date = new Date().toISOString();
      data.noteOrganisation = parseInt(document.getElementById('satisf-note-orga')?.value) || null;
      data.noteSupports = parseInt(document.getElementById('satisf-note-supports')?.value) || null;
      data.noteStagiaires = parseInt(document.getElementById('satisf-note-stag')?.value) || null;
      data.noteGlobale = parseInt(document.getElementById('satisf-note-globale')?.value) || null;
      data.pointsPositifs = document.getElementById('satisf-points-positifs')?.value || '';
      data.difficultes = document.getElementById('satisf-difficultes')?.value || '';
      data.suggestions = document.getElementById('satisf-suggestions')?.value || '';
      break;
      
    case 'donneur':
      const entId = document.getElementById('satisf-entreprise')?.value;
      if (entId) {
        const ent = await dbGet('entreprises', parseInt(entId));
        data.entreprise = ent?.nom || '';
        data.entrepriseId = parseInt(entId);
      }
      data.contact = document.getElementById('satisf-contact')?.value || '';
      data.email = document.getElementById('satisf-email')?.value || '';
      data.statut = document.getElementById('satisf-statut')?.value || '√Ä envoyer';
      data.impactFormation = document.getElementById('satisf-impact')?.value || '';
      data.competencesDeveloppees = document.getElementById('satisf-competences-dev')?.value === 'true';
      data.note = parseInt(document.getElementById('satisf-note')?.value) || null;
      data.commentaires = document.getElementById('satisf-commentaires')?.value || '';
      break;
  }
  
  await dbAdd(storeName, data);
  toast('‚úÖ Questionnaire enregistr√©', 'success');
  fermerModalSatisfaction();
  loadSatisfactionData(type);
  loadAllSatisfactionKPIs();
}

// === R√âCLAMATIONS ===
async function loadReclamationsKPIs() {
  try {
    const reclam = await dbGetAll('reclamations');
    const total = reclam.length;
    const enCours = reclam.filter(r => r.statut === 'En cours' || r.statut === 'Nouvelle').length;
    const resolues = reclam.filter(r => r.statut === 'R√©solue' || r.statut === 'Cl√¥tur√©e').length;
    
    // Calcul d√©lai moyen
    const resolueesAvecDelai = reclam.filter(r => r.dateResolution && r.dateCreation);
    let delaiMoyen = 0;
    if (resolueesAvecDelai.length > 0) {
      const totalDelai = resolueesAvecDelai.reduce((sum, r) => {
        return sum + Math.ceil((new Date(r.dateResolution) - new Date(r.dateCreation)) / (1000 * 60 * 60 * 24));
      }, 0);
      delaiMoyen = Math.round(totalDelai / resolueesAvecDelai.length);
    }
    
    document.getElementById('kpi-reclam-total').textContent = total;
    document.getElementById('kpi-reclam-encours').textContent = enCours;
    document.getElementById('kpi-reclam-resolues').textContent = resolues;
    document.getElementById('kpi-reclam-delai').textContent = `${delaiMoyen}j`;
  } catch (e) {
    console.warn('Erreur KPIs r√©clamations:', e);
  }
}

async function openModalReclamation() {
  const entreprises = await dbGetAll('entreprises');
  const stagiaires = await dbGetAll('stagiaires');
  
  const modalHtml = `
    <div id="modal-reclamation" class="modal-overlay" style="display:flex">
      <div class="modal" style="max-width:650px">
        <div class="modal-header" style="background:linear-gradient(135deg,#ef4444,#dc2626)">
          <h3 class="modal-title">‚ö†Ô∏è Nouvelle R√©clamation</h3>
          <button class="modal-close" onclick="fermerModalReclamation()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="info-box" style="margin-bottom:15px;background:#fef3c7;border-left:3px solid #f59e0b">
            <strong>‚è∞ Rappel des d√©lais :</strong> Accus√© r√©ception sous 72h, R√©ponse sous 5 jours ouvrables
          </div>
          <form id="form-reclamation" onsubmit="saveReclamation();return false">
            <div class="form-row">
              <div class="form-group"><label>Date de r√©ception *</label><input type="date" class="form-input" id="reclam-date" required></div>
              <div class="form-group"><label>Urgence *</label><select class="form-select" id="reclam-urgence" required>
                <option value="Basse">üü¢ Basse</option>
                <option value="Moyenne" selected>üü° Moyenne</option>
                <option value="Haute">üî¥ Haute</option>
              </select></div>
            </div>
            <div class="form-group"><label>Origine *</label><select class="form-select" id="reclam-origine" required>
              <option value="">-- S√©lectionner --</option>
              <option value="Client/Stagiaire">Client/Stagiaire</option>
              <option value="Donneur d'ordre">Donneur d'ordre</option>
              <option value="Tiers (OPCO)">Tiers (OPCO)</option>
              <option value="Partenaires">Partenaires</option>
              <option value="Institutionnels">Institutionnels</option>
            </select></div>
            <div class="form-row">
              <div class="form-group"><label>Nom du demandeur *</label><input type="text" class="form-input" id="reclam-demandeur" required></div>
              <div class="form-group"><label>Email</label><input type="email" class="form-input" id="reclam-email"></div>
            </div>
            <div class="form-group"><label>T√©l√©phone</label><input type="tel" class="form-input" id="reclam-telephone"></div>
            <div class="form-group"><label>Entreprise li√©e</label><select class="form-select" id="reclam-entreprise">
              <option value="">-- Aucune --</option>
              ${entreprises.map(e => `<option value="${e.id}">${esc(e.nom)}</option>`).join('')}
            </select></div>
            <div class="form-group"><label>Objet de la r√©clamation *</label><input type="text" class="form-input" id="reclam-objet" required placeholder="R√©sum√© court"></div>
            <div class="form-group"><label>Description d√©taill√©e *</label><textarea class="form-textarea" id="reclam-description" rows="4" required placeholder="D√©crivez la r√©clamation en d√©tail..."></textarea></div>
            <div class="form-group"><label>Canal de r√©ception</label><select class="form-select" id="reclam-canal">
              <option value="Email">üìß Email</option>
              <option value="T√©l√©phone">üìû T√©l√©phone</option>
              <option value="Site internet">üåê Site internet</option>
              <option value="Courrier">üì¨ Courrier</option>
              <option value="En personne">üë§ En personne</option>
            </select></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="fermerModalReclamation()">Annuler</button>
          <button type="submit" form="form-reclamation" class="btn btn-danger">‚ö†Ô∏è Enregistrer la r√©clamation</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  document.getElementById('reclam-date').value = new Date().toISOString().split('T')[0];
}

function fermerModalReclamation() {
  document.getElementById('modal-reclamation')?.remove();
}

async function saveReclamation() {
  const data = {
    dateCreation: document.getElementById('reclam-date')?.value || new Date().toISOString(),
    urgence: document.getElementById('reclam-urgence')?.value || 'Moyenne',
    origine: document.getElementById('reclam-origine')?.value || '',
    demandeur: document.getElementById('reclam-demandeur')?.value || '',
    email: document.getElementById('reclam-email')?.value || '',
    telephone: document.getElementById('reclam-telephone')?.value || '',
    entrepriseId: document.getElementById('reclam-entreprise')?.value || null,
    objet: document.getElementById('reclam-objet')?.value || '',
    description: document.getElementById('reclam-description')?.value || '',
    canal: document.getElementById('reclam-canal')?.value || 'Email',
    statut: 'Nouvelle',
    accuseEnvoye: false,
    dateAccuse: null,
    dateResolution: null,
    traitement: '',
    actionsCorrectives: ''
  };
  
  await dbAdd('reclamations', data);
  toast('‚ö†Ô∏è R√©clamation enregistr√©e - Envoyez l\'accus√© de r√©ception sous 72h !', 'warning');
  fermerModalReclamation();
  loadReclamations();
  loadReclamationsKPIs();
}

async function loadReclamations() {
  try {
    const data = await dbGetAll('reclamations');
    renderReclamationsTable(data);
  } catch (e) {
    console.warn('Erreur chargement r√©clamations:', e);
  }
}

function renderReclamationsTable(data) {
  const tbody = document.getElementById('table-reclamations');
  if (!tbody) return;
  
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="10" class="empty-state"><div class="empty-state-icon">‚úÖ</div><h3>Aucune r√©clamation</h3></td></tr>`;
    return;
  }
  
  tbody.innerHTML = data.map(r => {
    // Calcul d√©lai restant (5 jours ouvrables pour r√©pondre)
    const dateCreation = new Date(r.dateCreation);
    const dateLimite = new Date(dateCreation);
    dateLimite.setDate(dateLimite.getDate() + 5);
    const aujourdhui = new Date();
    const joursRestants = Math.ceil((dateLimite - aujourdhui) / (1000 * 60 * 60 * 24));
    
    let delaiClass = 'status-actif';
    let delaiText = `${joursRestants}j`;
    if (r.statut === 'R√©solue' || r.statut === 'Cl√¥tur√©e') {
      delaiClass = 'status-actif';
      delaiText = '‚úÖ';
    } else if (joursRestants <= 0) {
      delaiClass = 'status-inactif';
      delaiText = '‚ö†Ô∏è D√©pass√©';
    } else if (joursRestants <= 2) {
      delaiClass = 'status-en-attente';
    }
    
    const urgenceColors = { 'Haute': '#ef4444', 'Moyenne': '#f59e0b', 'Basse': '#22c55e' };
    const urgenceEmoji = { 'Haute': 'üî¥', 'Moyenne': 'üü°', 'Basse': 'üü¢' };
    
    return `
    <tr style="${r.urgence === 'Haute' && r.statut !== 'R√©solue' && r.statut !== 'Cl√¥tur√©e' ? 'background:#fef2f2' : ''}">
      <td><code>REC-${String(r.id).padStart(3,'0')}</code></td>
      <td>${fmtDate(r.dateCreation)}</td>
      <td>${esc(r.origine || '-')}</td>
      <td><strong>${esc(r.demandeur || '-')}</strong></td>
      <td>${esc(trunc(r.objet, 30))}</td>
      <td><span style="color:${urgenceColors[r.urgence]}">${urgenceEmoji[r.urgence]} ${r.urgence}</span></td>
      <td>${r.accuseEnvoye ? '<span class="status status-actif">‚úÖ Oui</span>' : '<span class="status status-en-attente">‚ùå Non</span>'}</td>
      <td><span class="status ${delaiClass}">${delaiText}</span></td>
      <td><span class="status status-${slug(r.statut)}">${r.statut || 'Nouvelle'}</span></td>
      <td class="action-btns">
        ${!r.accuseEnvoye ? `<button class="btn btn-warning btn-icon" onclick="envoyerAccuseReclamation(${r.id})" title="Envoyer accus√© r√©ception">üìß</button>` : ''}
        <button class="btn btn-info btn-icon" onclick="traiterReclamation(${r.id})" title="Traiter">‚öôÔ∏è</button>
        <button class="btn btn-success btn-icon" onclick="cloturerReclamation(${r.id})" title="Cl√¥turer">‚úÖ</button>
        <button class="btn btn-danger btn-icon" onclick="confirmDelete('reclamations',${r.id})" title="Supprimer">üóëÔ∏è</button>
      </td>
    </tr>
  `}).join('');
}

async function envoyerAccuseReclamation(id) {
  const reclam = await dbGet('reclamations', id);
  if (!reclam) return;
  
  reclam.accuseEnvoye = true;
  reclam.dateAccuse = new Date().toISOString();
  reclam.statut = 'En cours';
  
  await dbPut('reclamations', reclam);
  toast('üìß Accus√© de r√©ception envoy√© (simulation)', 'success');
  loadReclamations();
  loadReclamationsKPIs();
}

async function traiterReclamation(id) {
  const reclam = await dbGet('reclamations', id);
  if (!reclam) return;
  
  const traitement = prompt('D√©crivez le traitement effectu√©:', reclam.traitement || '');
  if (traitement === null) return;
  
  reclam.traitement = traitement;
  reclam.statut = 'En cours';
  
  await dbPut('reclamations', reclam);
  toast('‚úÖ Traitement enregistr√©', 'success');
  loadReclamations();
}

async function cloturerReclamation(id) {
  const reclam = await dbGet('reclamations', id);
  if (!reclam) return;
  
  if (!confirm('Cl√¥turer cette r√©clamation ?')) return;
  
  reclam.statut = 'Cl√¥tur√©e';
  reclam.dateResolution = new Date().toISOString();
  
  await dbPut('reclamations', reclam);
  toast('‚úÖ R√©clamation cl√¥tur√©e', 'success');
  loadReclamations();
  loadReclamationsKPIs();
}

async function filterReclamations() {
  const searchTerm = (document.getElementById('search-reclamations')?.value || '').toLowerCase();
  const statutFilter = document.getElementById('filter-reclam-statut')?.value || '';
  const urgenceFilter = document.getElementById('filter-reclam-urgence')?.value || '';
  
  try {
    let data = await dbGetAll('reclamations');
    
    if (searchTerm) {
      data = data.filter(r => 
        (r.demandeur || '').toLowerCase().includes(searchTerm) ||
        (r.objet || '').toLowerCase().includes(searchTerm) ||
        (r.origine || '').toLowerCase().includes(searchTerm)
      );
    }
    
    if (statutFilter) {
      data = data.filter(r => r.statut === statutFilter);
    }
    
    if (urgenceFilter) {
      data = data.filter(r => r.urgence === urgenceFilter);
    }
    
    renderReclamationsTable(data);
  } catch (e) {
    console.warn('Erreur filtrage r√©clamations:', e);
  }
}

// ============ QUICK WINS MVP ============

// === 1. BADGE NOUVEAU (<24h) ===
function estNouveau(dateCreation, heures = 24) {
  if (!dateCreation) return false;
  const maintenant = new Date();
  const creation = new Date(dateCreation);
  return (maintenant - creation) / (1000 * 60 * 60) <= heures;
}

function getBadgeNouveau(dateCreation) {
  if (!estNouveau(dateCreation)) return '';
  return '<span class="badge-new">NEW</span>';
}

// === 2. EXPIRATION DEVIS ===
function calculerExpirationDevis(devis) {
  const dateExp = new Date(devis.dateCreation);
  dateExp.setDate(dateExp.getDate() + (devis.validiteJours || 30));
  
  const aujourdhui = new Date();
  aujourdhui.setHours(0, 0, 0, 0);
  
  const joursRestants = Math.ceil((dateExp - aujourdhui) / (1000 * 60 * 60 * 24));
  
  let statut, couleur;
  if (joursRestants > 7) {
    statut = 'ok';
    couleur = '#22c55e';
  } else if (joursRestants > 3) {
    statut = 'warning';
    couleur = '#f59e0b';
  } else if (joursRestants > 0) {
    statut = 'urgent';
    couleur = '#ef4444';
  } else {
    statut = 'expire';
    couleur = '#6b7280';
  }
  
  return { dateExpiration: dateExp, joursRestants, statut, couleur };
}

function getBadgeExpiration(devis) {
  if (devis.statut === 'Accept√©' || devis.statut === 'Brouillon') return '';
  
  const exp = calculerExpirationDevis(devis);
  const texte = exp.joursRestants > 0 ? `J-${exp.joursRestants}` : 'Expir√©';
  
  return `<span class="badge-expiration ${exp.statut}" title="Expire le ${exp.dateExpiration.toLocaleDateString('fr-FR')}">${texte}</span>`;
}

// === 3. RECHERCHE GLOBALE ===
const SEARCHABLE_ENTITIES = {
  entreprises: {
    store: 'entreprises',
    icon: 'üè¢',
    label: 'Entreprise',
    fields: ['nom', 'enseigne', 'siret', 'contact', 'email', 'ville'],
    displayField: 'nom',
    route: 'entreprises'
  },
  stagiaires: {
    store: 'stagiaires',
    icon: 'üë§',
    label: 'Stagiaire',
    fields: ['nom', 'prenom', 'email'],
    displayField: item => `${item.nom || ''} ${item.prenom || ''}`.trim(),
    route: 'stagiaires'
  },
  devis: {
    store: 'devis',
    icon: 'üí∞',
    label: 'Devis',
    fields: ['numero', 'entreprise'],
    displayField: 'numero',
    route: 'documents',
    section: 'devis'
  },
  sessions: {
    store: 'sessions',
    icon: 'üìÖ',
    label: 'Session',
    fields: ['intitule', 'lieu'],
    displayField: 'intitule',
    route: 'sessions'
  },
  formations: {
    store: 'formations',
    icon: 'üìö',
    label: 'Formation',
    fields: ['nom', 'code', 'domaine'],
    displayField: 'nom',
    route: 'referentiels'
  },
  demandes: {
    store: 'demandes',
    icon: 'üì©',
    label: 'Demande',
    fields: ['entreprise', 'contact', 'email', 'message'],
    displayField: 'entreprise',
    route: 'demandes'
  },
  opportunites: {
    store: 'opportunites',
    icon: 'üéØ',
    label: 'Opportunit√©',
    fields: ['nom', 'entreprise'],
    displayField: 'nom',
    route: 'opportunites'
  },
  conventions: {
    store: 'conventions',
    icon: 'üìë',
    label: 'Convention',
    fields: ['numero', 'entreprise'],
    displayField: 'numero',
    route: 'documents',
    section: 'conventions'
  }
};

let rechercheResultatsActuels = [];
let rechercheIndexActuel = -1;

function ouvrirRechercheGlobale() {
  document.getElementById('modal-recherche-globale').classList.add('active');
  const input = document.getElementById('recherche-globale-input');
  input.value = '';
  input.focus();
  rechercheResultatsActuels = [];
  rechercheIndexActuel = -1;
  document.getElementById('recherche-globale-resultats').innerHTML = `
    <div class="search-empty">
      <div class="search-empty-icon">üîç</div>
      <div>Tapez pour rechercher...</div>
      <div style="font-size:0.9em;margin-top:5px">Entreprises, stagiaires, devis, sessions, formations</div>
    </div>
  `;
}

function fermerRechercheGlobale() {
  document.getElementById('modal-recherche-globale').classList.remove('active');
}

let rechercheDebounceTimer = null;
function rechercherGlobal(query) {
  clearTimeout(rechercheDebounceTimer);
  rechercheDebounceTimer = setTimeout(() => executerRecherche(query), 200);
}

async function executerRecherche(query) {
  const container = document.getElementById('recherche-globale-resultats');
  
  if (!query || query.length < 2) {
    container.innerHTML = `
      <div class="search-empty">
        <div class="search-empty-icon">üîç</div>
        <div>Tapez au moins 2 caract√®res...</div>
      </div>
    `;
    rechercheResultatsActuels = [];
    return;
  }
  
  const queryLower = query.toLowerCase();
  const resultats = [];
  
  for (const [type, config] of Object.entries(SEARCHABLE_ENTITIES)) {
    try {
      const data = await dbGetAll(config.store);
      
      const matches = data.filter(item => {
        return config.fields.some(field => {
          const value = item[field];
          return value && value.toString().toLowerCase().includes(queryLower);
        });
      }).slice(0, 5);
      
      matches.forEach(item => {
        const displayValue = typeof config.displayField === 'function' 
          ? config.displayField(item) 
          : item[config.displayField] || `ID: ${item.id}`;
        
        resultats.push({
          type,
          icon: config.icon,
          label: config.label,
          id: item.id,
          display: displayValue,
          route: config.route,
          section: config.section,
          subtitle: getSubtitle(type, item)
        });
      });
    } catch (e) {
      console.warn(`Erreur recherche ${type}:`, e);
    }
  }
  
  rechercheResultatsActuels = resultats;
  rechercheIndexActuel = -1;
  
  if (resultats.length === 0) {
    container.innerHTML = `
      <div class="search-empty">
        <div class="search-empty-icon">üòï</div>
        <div>Aucun r√©sultat pour "${esc(query)}"</div>
      </div>
    `;
    return;
  }
  
  // Grouper par type
  const grouped = {};
  resultats.forEach(r => {
    if (!grouped[r.label]) grouped[r.label] = [];
    grouped[r.label].push(r);
  });
  
  let html = '';
  let globalIndex = 0;
  for (const [label, items] of Object.entries(grouped)) {
    html += `<div class="search-category">${items[0].icon} ${label}s (${items.length})</div>`;
    items.forEach(item => {
      html += `
        <div class="search-result-item" data-index="${globalIndex}" onclick="selectionnerResultatRecherche(${globalIndex})">
          <div class="result-icon">${item.icon}</div>
          <div class="result-info">
            <div class="result-title">${esc(item.display)}</div>
            ${item.subtitle ? `<div class="result-subtitle">${esc(item.subtitle)}</div>` : ''}
          </div>
          <div class="result-badge">${item.label}</div>
        </div>
      `;
      globalIndex++;
    });
  }
  
  container.innerHTML = html;
}

function getSubtitle(type, item) {
  switch (type) {
    case 'entreprises': return item.ville || item.email || '';
    case 'stagiaires': return item.email || item.entreprise || '';
    case 'devis': return item.entreprise ? `${item.entreprise}` : '';
    case 'sessions': return item.dateDebut ? new Date(item.dateDebut).toLocaleDateString('fr-FR') : '';
    case 'formations': return item.duree ? `${item.duree}h` : '';
    case 'demandes': return item.contact || '';
    case 'opportunites': return item.entreprise || '';
    case 'conventions': return item.entreprise || '';
    default: return '';
  }
}

function selectionnerResultatRecherche(index) {
  const item = rechercheResultatsActuels[index];
  if (!item) return;
  
  fermerRechercheGlobale();
  
  if (item.section) {
    naviguerVersSection(item.route, item.section);
  } else {
    showPage(item.route);
  }
  
  toast(`üìç ${item.icon} ${item.display}`, 'info');
}

// Navigation clavier dans la recherche
document.addEventListener('keydown', (e) => {
  const modal = document.getElementById('modal-recherche-globale');
  if (!modal.classList.contains('active')) return;
  
  const items = document.querySelectorAll('.search-result-item');
  
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    rechercheIndexActuel = Math.min(rechercheIndexActuel + 1, items.length - 1);
    updateRechercheSelection(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    rechercheIndexActuel = Math.max(rechercheIndexActuel - 1, 0);
    updateRechercheSelection(items);
  } else if (e.key === 'Enter' && rechercheIndexActuel >= 0) {
    e.preventDefault();
    selectionnerResultatRecherche(rechercheIndexActuel);
  }
});

function updateRechercheSelection(items) {
  items.forEach((item, i) => {
    item.classList.toggle('active', i === rechercheIndexActuel);
  });
  if (items[rechercheIndexActuel]) {
    items[rechercheIndexActuel].scrollIntoView({ block: 'nearest' });
  }
}

// === 4. RACCOURCIS CLAVIER ===
document.addEventListener('keydown', (e) => {
  // Ignorer si focus dans un input
  if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
    if (e.key === 'Escape') {
      document.activeElement.blur();
    }
    return;
  }
  
  // Ctrl+K : Recherche globale
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    ouvrirRechercheGlobale();
    return;
  }
  
  // Escape : Fermer les modales
  if (e.key === 'Escape') {
    fermerRechercheGlobale();
    fermerBackupModal();
    fermerRaccourcis();
    // Fermer autres modales
    document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    return;
  }
  
  // ? : Aide raccourcis
  if (e.key === '?') {
    e.preventDefault();
    afficherRaccourcis();
    return;
  }
  
  // Ctrl+N : Nouvel √©l√©ment
  if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
    e.preventDefault();
    creerNouvelElement();
    return;
  }
  
  // Ctrl+B : Backup
  if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
    e.preventDefault();
    ouvrirBackupModal();
    return;
  }
});

function creerNouvelElement() {
  const page = document.querySelector('.page.active')?.id?.replace('page-', '');
  const typeMap = {
    'demandes': 'demande',
    'entreprises': 'entreprise',
    'opportunites': 'opportunite',
    'sessions': 'session',
    'stagiaires': 'stagiaire'
  };
  if (typeMap[page]) {
    openModal(typeMap[page]);
    toast(`‚ûï Nouveau ${typeMap[page]}`, 'info');
  } else {
    toast('Utilisez le bouton + de la page', 'warning');
  }
}

function afficherRaccourcis() {
  document.getElementById('modal-raccourcis').style.display = 'flex';
}

function fermerRaccourcis() {
  document.getElementById('modal-raccourcis').style.display = 'none';
}

// === 5. BACKUP / EXPORT-IMPORT ===
function ouvrirBackupModal() {
  document.getElementById('modal-backup').style.display = 'flex';
  mettreAJourInfoBackup();
}

function fermerBackupModal() {
  document.getElementById('modal-backup').style.display = 'none';
}

async function mettreAJourInfoBackup() {
  // Derni√®re sauvegarde
  const derniere = localStorage.getItem('lastBackup');
  document.getElementById('derniere-sauvegarde').textContent = derniere 
    ? new Date(derniere).toLocaleString('fr-FR') 
    : 'Jamais';
  
  // Total enregistrements
  let total = 0;
  for (const store of STORES) {
    try {
      const data = await dbGetAll(store);
      total += data.length;
    } catch (e) {}
  }
  document.getElementById('backup-total-records').textContent = total;
}

async function telechargerBackup() {
  toast('üì¶ Pr√©paration du backup...', 'info');
  
  const backup = {
    version: '2.0',
    application: 'CRM Formation DesClick',
    date: new Date().toISOString(),
    data: {}
  };
  
  for (const store of STORES) {
    try {
      backup.data[store] = await dbGetAll(store);
    } catch (e) {
      backup.data[store] = [];
    }
  }
  
  backup.metadata = {
    totalRecords: Object.values(backup.data).reduce((sum, arr) => sum + arr.length, 0),
    stores: STORES.length,
    exportedBy: currentUser?.nom || 'Inconnu'
  };
  
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `backup_crm_formation_${new Date().toISOString().slice(0, 10)}.json`;
  a.click();
  
  URL.revokeObjectURL(url);
  
  localStorage.setItem('lastBackup', new Date().toISOString());
  mettreAJourInfoBackup();
  
  toast('‚úÖ Backup t√©l√©charg√© avec succ√®s !', 'success');
}

async function restaurerBackup(file) {
  if (!file) return;
  
  const reader = new FileReader();
  
  reader.onload = async (e) => {
    try {
      const backup = JSON.parse(e.target.result);
      
      // Validation
      if (!backup.version || !backup.data) {
        throw new Error('Format de sauvegarde invalide');
      }
      
      // Confirmation
      const confirme = confirm(
        `‚ö†Ô∏è ATTENTION\n\n` +
        `Vous √™tes sur le point de restaurer une sauvegarde du ${new Date(backup.date).toLocaleString('fr-FR')}.\n\n` +
        `${backup.metadata?.totalRecords || '?'} enregistrements seront import√©s.\n\n` +
        `TOUTES les donn√©es actuelles seront √âCRAS√âES.\n\n` +
        `Continuer ?`
      );
      
      if (!confirme) {
        toast('Restauration annul√©e', 'warning');
        return;
      }
      
      toast('üîÑ Restauration en cours...', 'info');
      
      // Restauration
      for (const [store, data] of Object.entries(backup.data)) {
        if (STORES.includes(store)) {
          // Vider le store
          const existing = await dbGetAll(store);
          for (const item of existing) {
            await dbDelete(store, item.id);
          }
          // R√©ins√©rer
          for (const item of data) {
            await dbAdd(store, item);
          }
        }
      }
      
      toast('‚úÖ Restauration termin√©e ! Rechargement...', 'success');
      
      setTimeout(() => location.reload(), 1500);
      
    } catch (err) {
      console.error('Erreur restauration:', err);
      toast('‚ùå Erreur de restauration: ' + err.message, 'error');
    }
  };
  
  reader.readAsText(file);
}

// V√©rifier la derni√®re sauvegarde au d√©marrage
function verifierDerniereSauvegarde() {
  const derniere = localStorage.getItem('lastBackup');
  if (!derniere) {
    setTimeout(() => toast('üí° Pensez √† sauvegarder vos donn√©es (‚òÅÔ∏è Backup)', 'warning', 8000), 3000);
    return;
  }
  
  const joursDepuis = Math.floor((new Date() - new Date(derniere)) / (1000 * 60 * 60 * 24));
  if (joursDepuis >= 7) {
    setTimeout(() => toast(`‚ö†Ô∏è Derni√®re sauvegarde il y a ${joursDepuis} jours`, 'warning', 8000), 3000);
  }
}

// === 6. DUPLICATION & FAVORIS ===
async function dupliquerEnregistrement(type, id) {
  const original = await dbGet(type, id);
  if (!original) {
    toast('‚ùå √âl√©ment introuvable', 'error');
    return null;
  }
  
  const copie = { ...original };
  delete copie.id;
  
  // Modifier certains champs selon le type
  switch (type) {
    case 'devis':
      copie.numero = null; // Sera reg√©n√©r√©
      copie.statut = 'Brouillon';
      copie.dateCreation = new Date().toISOString();
      copie.notes = (copie.notes || '') + ' [Copie]';
      break;
    case 'opportunites':
      copie.nom = `${copie.nom || 'Opportunit√©'} (copie)`;
      copie.etat = 'En cours';
      copie.etape = 'Prospection';
      copie.dateCreation = new Date().toISOString();
      break;
    case 'formations':
      copie.nom = `${copie.nom || 'Formation'} (copie)`;
      copie.code = `${copie.code || 'FORM'}-COPY`;
      break;
    case 'sessions':
      copie.intitule = `${copie.intitule || 'Session'} (copie)`;
      copie.statut = 'Planifi√©e';
      copie.dateCreation = new Date().toISOString();
      break;
    default:
      if (copie.nom) copie.nom = `${copie.nom} (copie)`;
  }
  
  const newId = await dbAdd(type, copie);
  toast(`‚úÖ √âl√©ment dupliqu√© (ID: ${newId})`, 'success');
  
  // Rafra√Æchir l'affichage
  const pageMap = {
    'devis': () => showDevis(),
    'opportunites': () => showOpportunites(),
    'formations': () => showFormations(),
    'sessions': () => showSessions()
  };
  
  if (pageMap[type]) pageMap[type]();
  
  return newId;
}

// Favoris - Store simplifi√© via localStorage
function getFavorites() {
  return JSON.parse(localStorage.getItem('favorites') || '{}');
}

function setFavorites(favs) {
  localStorage.setItem('favorites', JSON.stringify(favs));
}

function toggleFavori(type, id) {
  const favs = getFavorites();
  const key = `${type}_${id}`;
  
  if (favs[key]) {
    delete favs[key];
    toast('‚òÜ Retir√© des favoris', 'info');
  } else {
    favs[key] = { type, id, date: new Date().toISOString() };
    toast('‚≠ê Ajout√© aux favoris', 'success');
  }
  
  setFavorites(favs);
  
  // Mettre √† jour le bouton
  const btn = document.querySelector(`[data-fav-key="${key}"]`);
  if (btn) {
    btn.classList.toggle('is-favorite');
    btn.innerHTML = favs[key] ? '‚≠ê' : '‚òÜ';
  }
}

function isFavori(type, id) {
  const favs = getFavorites();
  return !!favs[`${type}_${id}`];
}

function getBoutonFavori(type, id) {
  const isFav = isFavori(type, id);
  return `<button class="btn-favorite ${isFav ? 'is-favorite' : ''}" data-fav-key="${type}_${id}" onclick="event.stopPropagation();toggleFavori('${type}',${id})" title="${isFav ? 'Retirer des favoris' : 'Ajouter aux favoris'}">${isFav ? '‚≠ê' : '‚òÜ'}</button>`;
}

function getBoutonDupliquer(type, id) {
  return `<button class="btn btn-sm btn-icon" onclick="event.stopPropagation();dupliquerEnregistrement('${type}',${id})" title="Dupliquer">üìã</button>`;
}

// === INITIALISATION ===
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(verifierDerniereSauvegarde, 2000);
});
</script>

<!-- MODAL RECHERCHE GLOBALE -->
<div id="modal-recherche-globale" class="search-modal-overlay" onclick="if(event.target===this)fermerRechercheGlobale()">
  <div class="search-modal-box">
    <div class="search-modal-header">
      <span style="font-size:1.3em">üîç</span>
      <input type="text" id="recherche-globale-input" placeholder="Rechercher entreprises, stagiaires, devis, sessions..." oninput="rechercherGlobal(this.value)">
      <kbd>ESC</kbd>
    </div>
    <div id="recherche-globale-resultats" class="search-results">
      <div class="search-empty">
        <div class="search-empty-icon">üîç</div>
        <div>Tapez pour rechercher...</div>
        <div style="font-size:0.9em;margin-top:5px">Entreprises, stagiaires, devis, sessions, formations</div>
      </div>
    </div>
    <div class="search-modal-footer">
      <span><kbd>‚Üë‚Üì</kbd> Navigation</span>
      <span><kbd>‚Üµ</kbd> Ouvrir</span>
      <span><kbd>ESC</kbd> Fermer</span>
    </div>
  </div>
</div>

<!-- MODAL BACKUP -->
<div id="modal-backup" class="modal-overlay" style="display:none">
  <div class="modal" style="max-width:500px">
    <div class="modal-header" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">
      <h3 class="modal-title">‚òÅÔ∏è Sauvegarde & Restauration</h3>
      <button class="modal-close" onclick="fermerBackupModal()">‚úï</button>
    </div>
    <div class="modal-body" style="padding:0">
      <div class="backup-section">
        <h4>üíæ Exporter les donn√©es</h4>
        <div class="backup-info">
          <div id="backup-info-text">Derni√®re sauvegarde : <span id="derniere-sauvegarde">Jamais</span></div>
          <div style="margin-top:5px">Total : <strong id="backup-total-records">0</strong> enregistrements</div>
        </div>
        <div class="backup-actions">
          <button class="btn btn-primary" onclick="telechargerBackup()">üì• T√©l√©charger backup JSON</button>
        </div>
      </div>
      <div class="backup-section">
        <h4>üì§ Restaurer les donn√©es</h4>
        <div class="backup-info" style="background:#fef3c7;border-left:3px solid #f59e0b">
          ‚ö†Ô∏è La restauration √©crasera toutes les donn√©es actuelles. Cette action est irr√©versible.
        </div>
        <div class="backup-actions">
          <input type="file" id="backup-file-input" accept=".json" style="display:none" onchange="restaurerBackup(this.files[0])">
          <button class="btn btn-warning" onclick="document.getElementById('backup-file-input').click()">üìÇ Choisir un fichier JSON</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL RACCOURCIS -->
<div id="modal-raccourcis" class="modal-overlay" style="display:none">
  <div class="modal" style="max-width:550px">
    <div class="modal-header" style="background:linear-gradient(135deg,#64748b,#475569)">
      <h3 class="modal-title">‚å®Ô∏è Raccourcis Clavier</h3>
      <button class="modal-close" onclick="fermerRaccourcis()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="shortcuts-grid">
        <div class="shortcuts-section">
          <h4>üîç Navigation</h4>
          <div class="shortcut-item"><kbd>Ctrl+K</kbd> Recherche globale</div>
          <div class="shortcut-item"><kbd>Ctrl+N</kbd> Nouvel √©l√©ment</div>
          <div class="shortcut-item"><kbd>Ctrl+S</kbd> Sauvegarder</div>
          <div class="shortcut-item"><kbd>ESC</kbd> Fermer modal</div>
        </div>
        <div class="shortcuts-section">
          <h4>‚ö° Actions</h4>
          <div class="shortcut-item"><kbd>?</kbd> Afficher cette aide</div>
          <div class="shortcut-item"><kbd>Ctrl+B</kbd> Backup donn√©es</div>
          <div class="shortcut-item"><kbd>Ctrl+D</kbd> Dupliquer</div>
          <div class="shortcut-item"><kbd>Ctrl+F</kbd> Favori</div>
        </div>
      </div>
      <div style="ma
